<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>使用 Cloudflare Tunnels 通过 Web SSH 访问服务器</title>
<meta name=description content="Cloudflre 的 Zero Trust 支持通过 Tunnels 访问 SSH 类型的应用，可以通过 Web SSH 的方式访问服务器；支持多种登陆认证方式，安全性远高于直接暴露公网端口
创建 SSH 应用 创建应用 在 Cloudflare 控制台 > Zero Trust > Access …"><meta name=keywords content='blog,hugo,HomeLab,Cloudflare'><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="og:type" content="website"><meta property="og:title" content="使用 Cloudflare Tunnels 通过 Web SSH 访问服务器"><meta property="og:description" content="Cloudflre 的 Zero Trust 支持通过 Tunnels 访问 SSH 类型的应用，可以通过 Web SSH 的方式访问服务器；支持多种登陆认证方式，安全性远高于直接暴露公网端口
创建 SSH 应用 创建应用 在 Cloudflare 控制台 > Zero Trust > Access …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="使用 Cloudflare Tunnels 通过 Web SSH 访问服务器"><meta name=twitter:description content="Cloudflre 的 Zero Trust 支持通过 Tunnels 访问 SSH 类型的应用，可以通过 Web SSH 的方式访问服务器；支持多种登陆认证方式，安全性远高于直接暴露公网端口
创建 SSH 应用 创建应用 在 Cloudflare 控制台 > Zero Trust > Access …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>使用 Cloudflare Tunnels 通过 Web SSH 访问服务器</h1><small role=doc-subtitle></small><p class=post-date>2023-10-10</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/cloudflare>Cloudflare</a></li></ul></div><div class=post-content><p>Cloudflre 的 Zero Trust 支持通过 Tunnels 访问 SSH 类型的应用，可以通过 Web SSH 的方式访问服务器；支持多种登陆认证方式，安全性远高于直接暴露公网端口</p><h2 id=创建-ssh-应用>创建 SSH 应用</h2><ul><li>创建应用</li></ul><p>在 Cloudflare 控制台 > Zero Trust > Access > Applications 选择 Add an application 创建新的应用；应用类型为 Self-hosted</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-application-create.png alt=homelab-cloudflare-ssh-application-create.png></p><ul><li>配置应用信息</li></ul><p>指定应用名称，并为应用配置域名；session 的过期时间可以按需配置</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-configuration-application.png alt=homelab-cloudflare-ssh-configuration-application.png></p><ul><li>指定访问策略</li></ul><p>需要配置访问策略，只允许特定的邮箱登陆；如果需要使用其他的认证方式，如 GitHub/Google SSO 等，可以在 Cloudflare 控制台 > Zero Trust > Settings > Authentication > Login Methods 中添加</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-configuration-policy.png alt=homelab-cloudflare-ssh-configuration-policy.png></p><ul><li>修改应用类型</li></ul><p>在 Additional settings 中，将 Browser rendering 的类型改为 SSH；然后选择保存，这样就配置好 SSH 应用了</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-set-application-type.png alt=homelab-cloudflare-ssh-set-application-type.png></p><h2 id=配置-tunnels>配置 Tunnels</h2><p>关于 Tunnels 配置安装请参考 <a href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-tunnel-%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1/>使用Cloudflare-Tunnels提供服务公网访问</a></p><ul><li>添加 SSH 服务转发</li></ul><p>将 SSH 的路由配置添加到 <code>/etc/cloudflared/config.yml</code> 文件中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>tunnel</span>: <span style=color:#98c379>xxxxxxxxxx</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>credentials-file</span>: <span style=color:#98c379>/root/.cloudflared/xxxxxxxxxx.json</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ingress</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>terminal.mydomain.com</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>service</span>: <span style=color:#98c379>ssh://localhost:22</span>
</span></span><span style=display:flex><span>  - <span style=color:#e06c75>service</span>: <span style=color:#98c379>http_status:403</span>
</span></span></code></pre></div><ul><li>重启 cloudflared</li></ul><p>重启后即通过该 Tunnel 访问 SSH 服务</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart cloudflared
</span></span></code></pre></div><h2 id=访问>访问</h2><p>访问刚才配置的 SSH 服务的域名；会提示使用邮箱或者配置的方式进行登陆</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-application-login.png alt=homelab-cloudflare-ssh-application-login.png></p><p>登陆后需要输入服务器的用户名和密码（或者私钥）进行登陆</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-login-page.png alt=homelab-cloudflare-ssh-login-page.png></p><h2 id=配置短期证书>配置短期证书</h2><p>在使用时，需要输入用户进行登陆，如果用户不允许密码登陆，还需要使用私钥进行验证；这种方式非常不方便；因此 Cloudflare 提供了短期证书的方式进行认证登陆，用于替代 SSH 密钥</p><h3 id=创建用户>创建用户</h3><p>如果通过 Web SSH 访问服务器，那么用户必须和使用 SSO 登陆的用户名一致，比如 SSO 登陆账户是 abc，那么服务器也只能使用同名的用户进行短期证书登陆，其他用户名是不支持的</p><ul><li>创建同名用户</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo adduser abc
</span></span></code></pre></div><p>如果想让该用户拥有 root 权限，需要将该用户添加到 wheel 用户组(CentOS 等系统) 或者 sudo 用户组（Ubuntu 等系统）</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># CentOS 等 RedHat 系列</span>
</span></span><span style=display:flex><span>usermod -aG wheel abc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># Ubuntu 等</span>
</span></span><span style=display:flex><span>usermod -aG sudo abc
</span></span></code></pre></div><h3 id=生成公钥证书>生成公钥证书</h3><p>在 Cloudflare 控制台 > Zero Trust > Access > Service Auth > SSH 选择刚才创建的 SSH 应用，然后生成证书</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-service-auth-ssh-generate-key.png alt=homelab-cloudflare-service-auth-ssh-generate-key.png></p><h3 id=配置公钥>配置公钥</h3><p>将刚才生成的公钥添加在要登陆的服务器上，路径可以自己配置，最好和 SSH 的配置放在一起</p><ul><li>将公钥添加到 <code>/etc/ssh/cloudflare-ca.pub</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#98c379>&lt;&lt;EOF &gt; /etc/ssh/cloudflare-ca.pub
</span></span></span><span style=display:flex><span><span style=color:#98c379>生成的公钥内容,如 ecdsa-sha2-nistp256 xxxxxxxx open-ssh-ca@cloudflareaccess.org
</span></span></span><span style=display:flex><span><span style=color:#98c379>EOF</span>
</span></span></code></pre></div><ul><li>修改 SSH 配置</li></ul><p>需要开启公钥认证，并且指定刚才添加的公钥为可信任的 CA 公钥；将以下内容添加到 <code>/etc/ssh/sshd_config</code> 文件中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PubkeyAuthentication yes
</span></span><span style=display:flex><span>TrustedUserCAKeys /etc/ssh/cloudflare-ca.pub
</span></span></code></pre></div><ul><li>连接 SSH 用户</li></ul><p>用 <code>cloudflare</code> 生成用户配置，并写入到 <code>~/.ssh/config</code>文件中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cloudflared access ssh-config --hostname terminal.mydomain.com --short-lived-cert &gt;&gt; ~/.ssh/config
</span></span></code></pre></div><p>或者可以手动修改写入配置</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Match host terminal.mydomain.com <span style=color:#ef8383>exec</span> <span style=color:#63c381>&#34;/usr/local/bin/cloudflared access ssh-gen --hostname %h&#34;</span>
</span></span><span style=display:flex><span>    HostName terminal.mydomain.com
</span></span><span style=display:flex><span>    ProxyCommand /usr/local/bin/cloudflared access ssh --hostname %h
</span></span><span style=display:flex><span>    IdentityFile ~/.cloudflared/terminal.mydomain.com-cf_key
</span></span><span style=display:flex><span>    CertificateFile ~/.cloudflared/terminal.mydomain.com-cf_key-cert.pub
</span></span></code></pre></div><h3 id=重启-ssh>重启 SSH</h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart ssh
</span></span></code></pre></div><p>重启完成后，访问配置的 SSH 域名，通过 SSO 登陆后，即可进入到 Web SSH 命令行界面；登陆的用户为 SSO 登陆用户 abc</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-service-auth-ssh-login.png alt=homelab-cloudflare-service-auth-ssh-login.png></p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-ssh-login-page.png alt=homelab-cloudflare-ssh-login-page.png></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2023 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>