<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>SpringMVC 生成验证码</title>
<meta name=description content=" 使用 Google kaptcha 为 SpringMVC Maven 项目生成验证码
##1 添加依赖
<dependency> <groupId>com.github.penggle</groupId> …"><meta name=keywords content='blog,hugo,Java,SrpingMVC'><meta property="og:url" content="https://blog.hellowood.dev/posts/springmvc-%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81/"><meta property="og:type" content="website"><meta property="og:title" content="SpringMVC 生成验证码"><meta property="og:description" content=" 使用 Google kaptcha 为 SpringMVC Maven 项目生成验证码
##1 添加依赖
<dependency> <groupId>com.github.penggle</groupId> …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SpringMVC 生成验证码"><meta name=twitter:description content=" 使用 Google kaptcha 为 SpringMVC Maven 项目生成验证码
##1 添加依赖
<dependency> <groupId>com.github.penggle</groupId> …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/springmvc-%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/springmvc-%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/springmvc-%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>SpringMVC 生成验证码</h1><small role=doc-subtitle></small><p class=post-date>2018-01-01</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/java>Java</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/srpingmvc>SrpingMVC</a></li></ul></div><div class=post-content><blockquote><p>使用 Google kaptcha 为 SpringMVC Maven 项目生成验证码</p></blockquote><p>##1 添加依赖</p><pre tabindex=0><code>        &lt;dependency&gt;
            &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;
            &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;
            &lt;version&gt;2.3.2&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre><h2 id=2-配置文件中添加验证码生成器bean>2 配置文件中添加验证码生成器Bean</h2><pre tabindex=0><code>    &lt;!--图片验证码--&gt;
    &lt;bean id=&#34;captchaProducer&#34; class=&#34;com.google.code.kaptcha.impl.DefaultKaptcha&#34;&gt;
        &lt;property name=&#34;config&#34;&gt;
            &lt;bean class=&#34;com.google.code.kaptcha.util.Config&#34;&gt;
                &lt;constructor-arg&gt;
                    &lt;props&gt;
                        &lt;prop key=&#34;kaptcha.border&#34;&gt;no&lt;/prop&gt;
                        &lt;prop key=&#34;kaptcha.image.width&#34;&gt;120&lt;/prop&gt;
                        &lt;prop key=&#34;kaptcha.session.key&#34;&gt;code&lt;/prop&gt;
                        &lt;prop key=&#34;kaptcha.textproducer.font.color&#34;&gt;blue&lt;/prop&gt;
                        &lt;prop key=&#34;kaptcha.textproducer.font.size&#34;&gt;40&lt;/prop&gt;
                        &lt;prop key=&#34;kaptcha.textproducer.char.length&#34;&gt;4&lt;/prop&gt;
                    &lt;/props&gt;
                &lt;/constructor-arg&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
</code></pre><ul><li>配置项</li></ul><table><thead><tr><th>属性</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td>kaptcha.border</td><td>是否有边框</td><td>默认为true 我们可以自己设置yes，no</td></tr><tr><td>kaptcha.border.color</td><td>边框颜色</td><td>默认为Color.BLACK</td></tr><tr><td>kaptcha.border.thickness</td><td>边框粗细度</td><td>默认为1</td></tr><tr><td>kaptcha.producer.impl</td><td>验证码生成器</td><td>默认为DefaultKaptcha</td></tr><tr><td>kaptcha.textproducer.impl</td><td>验证码文本生成器</td><td>默认为DefaultTextCreator</td></tr><tr><td>kaptcha.textproducer.char.string</td><td>验证码文本字符内容范围</td><td>默认为abcde2345678gfynmnpwx</td></tr><tr><td>kaptcha.textproducer.char.length</td><td>验证码文本字符长度</td><td>默认为5</td></tr><tr><td>kaptcha.textproducer.font.names</td><td>验证码文本字体样式</td><td>默认为new Font(&ldquo;Arial&rdquo;, 1, fontSize), new Font(&ldquo;Courier&rdquo;, 1, fontSize)</td></tr><tr><td>kaptcha.textproducer.font.size</td><td>验证码文本字符大小</td><td>默认为40</td></tr><tr><td>kaptcha.textproducer.font.color</td><td>验证码文本字符颜色</td><td>默认为Color.BLACK</td></tr><tr><td>kaptcha.textproducer.char.space</td><td>验证码文本字符间距</td><td>默认为2</td></tr><tr><td>kaptcha.noise.impl</td><td>验证码噪点生成对象</td><td>默认为DefaultNoise</td></tr><tr><td>kaptcha.noise.color</td><td>验证码噪点颜色</td><td>默认为Color.BLACK</td></tr><tr><td>kaptcha.obscurificator.impl</td><td>验证码样式引擎</td><td>默认为WaterRipple</td></tr><tr><td>kaptcha.word.impl</td><td>验证码文本字符渲染</td><td>默认为DefaultWordRenderer</td></tr><tr><td>kaptcha.background.impl</td><td>验证码背景生成器</td><td>默认为DefaultBackground</td></tr><tr><td>kaptcha.background.clear.from</td><td>验证码背景颜色渐进</td><td>默认为Color.LIGHT_GRAY</td></tr><tr><td>kaptcha.background.clear.to</td><td>验证码背景颜色渐进</td><td>默认为Color.WHITE</td></tr><tr><td>kaptcha.image.width</td><td>验证码图片宽度</td><td>默认为200</td></tr><tr><td>kaptcha.image.height</td><td>验证码图片高度</td><td>默认为50</td></tr></tbody></table><h2 id=3-页面添加验证码图片和输入框>3 页面添加验证码图片和输入框</h2><pre tabindex=0><code>            &lt;div class=&#34;col-md-12&#34;&gt;
                &lt;div class=&#34;col-md-7 form-control&#34;  style=&#34;float:left; width: 60%;&#34;&gt;
                    &lt;input type=&#34;text&#34; id=&#34;validateCode&#34; name=&#34;validateCode&#34; placeholder=&#34;验证码&#34; &gt;
                &lt;/div&gt;
                &lt;div class=&#34;col-md-3&#34; style=&#34;float: right;overflow: visible !important;&#34;&gt;
                    &lt;img src=&#34;./loadValidateCode&#34; id=&#34;validateCodeImage&#34; name=&#34;validateCodeImage&#34;
                         style=&#34;width: 100px;height: 35px;&#34;  onclick=&#34;loadValidateCode()&#34; &gt;
                &lt;/div&gt;
            &lt;/div&gt;
</code></pre><h2 id=4-页面添加刷新验证码>4 页面添加刷新验证码</h2><pre tabindex=0><code>    // 加载验证码
    function loadValidateCode() {
        var time = new Date().getTime();
        $(&#34;#validateCodeImage&#34;).attr(&#39;src&#39;, &#39;./loadValidateCode&#39;)
    }
</code></pre><h2 id=5-后台添加生成验证码>5 后台添加生成验证码</h2><ul><li>导入包</li></ul><pre tabindex=0><code>    import com.google.code.kaptcha.Producer;
</code></pre><ul><li>生成方法</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>    <span style=color:#e5c07b>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>private</span> <span style=color:#c1abea>Producer</span> <span style=color:#c1abea>captchaProducer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>private</span> <span style=color:#c678dd>final</span> <span style=color:#c1abea>String</span> <span style=color:#c1abea>VALIDATE_CODE</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;VALIDATE_CODE&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>private</span> <span style=color:#c678dd>final</span> <span style=color:#c1abea>String</span> <span style=color:#c1abea>EXPIRE_TIME</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;EXPIRE_TIME&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>@RequestMapping</span>(<span style=color:#c1abea>value</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;/loadValidateCode&#34;</span>, <span style=color:#c1abea>method</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>RequestMethod</span>.<span style=color:#b3d23c>GET</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>loadValidateCode</span>(<span style=color:#c1abea>HttpServletRequest</span> <span style=color:#c1abea>request</span>, <span style=color:#c1abea>HttpServletResponse</span> <span style=color:#c1abea>response</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>HttpSession</span> <span style=color:#c1abea>session</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span>.<span style=color:#b3d23c>getSession</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 设置清除浏览器缓存</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>setDateHeader</span>(<span style=color:#98c379>&#34;Expires&#34;</span>, <span style=color:#c1abea>0</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>setHeader</span>(<span style=color:#98c379>&#34;Cache-Control&#34;</span>, <span style=color:#98c379>&#34;no-store, no-cache, must-revalidate&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>addHeader</span>(<span style=color:#98c379>&#34;Cache-Control&#34;</span>, <span style=color:#98c379>&#34;post-check=0, pre-check=0&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>setHeader</span>(<span style=color:#98c379>&#34;Pragma&#34;</span>, <span style=color:#98c379>&#34;no-cache&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>setContentType</span>(<span style=color:#98c379>&#34;image/png&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 验证码一分钟内有效</span>
</span></span><span style=display:flex><span>            <span style=color:#ef8383>long</span> <span style=color:#c1abea>expireTime</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>System</span>.<span style=color:#b3d23c>currentTimeMillis</span>() <span style=color:#c7bf54>+</span> <span style=color:#c1abea>60000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 将验证码放到session中</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>String</span> <span style=color:#c1abea>validateCode</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>captchaProducer</span>.<span style=color:#b3d23c>createText</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>session</span>.<span style=color:#b3d23c>setAttribute</span>(<span style=color:#c1abea>VALIDATE_CODE</span>, <span style=color:#c1abea>Utils</span>.<span style=color:#b3d23c>encodeBase64</span>(<span style=color:#c1abea>validateCode</span>));<span style=color:#8a93a5;font-style:italic>//将加密后的验证码放到session中，确保安全</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>session</span>.<span style=color:#b3d23c>setAttribute</span>(<span style=color:#c1abea>EXPIRE_TIME</span>, <span style=color:#c1abea>expireTime</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 输出验证码图片</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>BufferedImage</span> <span style=color:#c1abea>bufferedImage</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>captchaProducer</span>.<span style=color:#b3d23c>createImage</span>(<span style=color:#c1abea>validateCode</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>ServletOutputStream</span> <span style=color:#c1abea>out</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>getOutputStream</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>ImageIO</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>bufferedImage</span>, <span style=color:#98c379>&#34;png&#34;</span>, <span style=color:#c1abea>out</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>out</span>.<span style=color:#b3d23c>flush</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>out</span>.<span style=color:#b3d23c>close</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>IOException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>e</span>.<span style=color:#b3d23c>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h2 id=6-登录时校验验证码>6 登录时校验验证码</h2><pre tabindex=0><code>    @RequestMapping(value = &#34;/login&#34;, method = RequestMethod.POST)
    public @ResponseBody String login(String username, String password, String validateCode) {

        // 校验验证码是否有效
        String currentValidateCode = String.valueOf(request.getSession().getAttribute(VALIDATE_CODE));
        if (System.currentTimeMillis() &gt; Long.parseLong(String.valueOf(request.getSession().getAttribute(EXPIRE_TIME)))) {
            return JSON.toJSONString(&#34;验证码已过期，请重试&#34;);
        }

        // 校验验证码
        String currentValidateCode = String.valueOf(request.getSession().getAttribute(VALIDATE_CODE));
        if (StringUtils.isEmpty(validateCode) || validateCode.length() != 4 ||
                !Utils.encodeBase64(validateCode).equals(currentValidateCode)) {
            return JSON.toJSONString(&#34;验证码错误&#34;);
        }
 }
</code></pre><h2 id=7-base64加密>7 Base64加密</h2><pre tabindex=0><code>    public static String encodeBase64(String str) {
        sun.misc.BASE64Encoder base64Encode = new BASE64Encoder();
        return base64Encode.encode(str.getBytes());
    }
</code></pre></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2018 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>