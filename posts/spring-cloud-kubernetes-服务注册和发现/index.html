<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Cloud Kubernetes 服务注册和发现</title>
<meta charset=utf-8><meta name=description content='Ladder@Spring Cloud Kubernetes 服务注册和发现
Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-kubernetes，这个 starter 依赖于 org.springframework.cloud:spring-cloud-kubernetes-core 和 org.springframework.cloud:spring-cloud-kubernetes-discovery
初始化 Kubernetes Client
初始化环境配置
环境初始化是通过 org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中
	@Override
	public void postProcessEnvironment(ConfigurableEnvironment environment,
	                                   SpringApplication application) {

		// 判断是否启用 kubernetes，默认为 true
		final boolean kubernetesEnabled = environment.getProperty("spring.cloud.kubernetes.enabled", Boolean.class, true);
		if (!kubernetesEnabled) {
			return;
		}

		// 如果在 Kubernetes 中
		if (isInsideKubernetes()) {
			// 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中
			if (hasKubernetesProfile(environment)) {
				// ...
			} else {
				environment.addActiveProfile(KUBERNETES_PROFILE);
			}
		} else {
			// ...
		}
	}
初始化 Kubernetes 依赖
相关 Kubernetes 核心依赖的初始化是通过 org.springframework.cloud.kubernetes.KubernetesAutoConfiguration实现的'><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="Spring Cloud Kubernetes 服务注册和发现"><meta property="og:description" content='Spring Cloud Kubernetes 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-kubernetes，这个 starter 依赖于 org.springframework.cloud:spring-cloud-kubernetes-core 和 org.springframework.cloud:spring-cloud-kubernetes-discovery
初始化 Kubernetes Client 初始化环境配置 环境初始化是通过 org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中
@Override public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) { // 判断是否启用 kubernetes，默认为 true final boolean kubernetesEnabled = environment.getProperty("spring.cloud.kubernetes.enabled", Boolean.class, true); if (!kubernetesEnabled) { return; } // 如果在 Kubernetes 中 if (isInsideKubernetes()) { // 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中 if (hasKubernetesProfile(environment)) { // ... } else { environment.addActiveProfile(KUBERNETES_PROFILE); } } else { // ... } } 初始化 Kubernetes 依赖 相关 Kubernetes 核心依赖的初始化是通过 org.springframework.cloud.kubernetes.KubernetesAutoConfiguration实现的'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-20T22:26:03+00:00"><meta property="article:modified_time" content="2020-09-20T22:26:03+00:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="SpringCloud"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Cloud Kubernetes 服务注册和发现"><meta name=twitter:description content='Spring Cloud Kubernetes 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-kubernetes，这个 starter 依赖于 org.springframework.cloud:spring-cloud-kubernetes-core 和 org.springframework.cloud:spring-cloud-kubernetes-discovery
初始化 Kubernetes Client 初始化环境配置 环境初始化是通过 org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中
@Override public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) { // 判断是否启用 kubernetes，默认为 true final boolean kubernetesEnabled = environment.getProperty("spring.cloud.kubernetes.enabled", Boolean.class, true); if (!kubernetesEnabled) { return; } // 如果在 Kubernetes 中 if (isInsideKubernetes()) { // 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中 if (hasKubernetesProfile(environment)) { // ... } else { environment.addActiveProfile(KUBERNETES_PROFILE); } } else { // ... } } 初始化 Kubernetes 依赖 相关 Kubernetes 核心依赖的初始化是通过 org.springframework.cloud.kubernetes.KubernetesAutoConfiguration实现的'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Spring Cloud Kubernetes 服务注册和发现","item":"https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Cloud Kubernetes 服务注册和发现","name":"Spring Cloud Kubernetes 服务注册和发现","description":"Spring Cloud Kubernetes 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-kubernetes，这个 starter 依赖于 org.springframework.cloud:spring-cloud-kubernetes-core 和 org.springframework.cloud:spring-cloud-kubernetes-discovery\n初始化 Kubernetes Client 初始化环境配置 环境初始化是通过 org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中\n@Override public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) { // 判断是否启用 kubernetes，默认为 true final boolean kubernetesEnabled = environment.getProperty(\u0026#34;spring.cloud.kubernetes.enabled\u0026#34;, Boolean.class, true); if (!kubernetesEnabled) { return; } // 如果在 Kubernetes 中 if (isInsideKubernetes()) { // 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中 if (hasKubernetesProfile(environment)) { // ... } else { environment.addActiveProfile(KUBERNETES_PROFILE); } } else { // ... } } 初始化 Kubernetes 依赖 相关 Kubernetes 核心依赖的初始化是通过 org.springframework.cloud.kubernetes.KubernetesAutoConfiguration实现的\n","keywords":["Java","SpringCloud"],"articleBody":"Spring Cloud Kubernetes 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-kubernetes，这个 starter 依赖于 org.springframework.cloud:spring-cloud-kubernetes-core 和 org.springframework.cloud:spring-cloud-kubernetes-discovery\n初始化 Kubernetes Client 初始化环境配置 环境初始化是通过 org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中\n@Override public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) { // 判断是否启用 kubernetes，默认为 true final boolean kubernetesEnabled = environment.getProperty(\"spring.cloud.kubernetes.enabled\", Boolean.class, true); if (!kubernetesEnabled) { return; } // 如果在 Kubernetes 中 if (isInsideKubernetes()) { // 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中 if (hasKubernetesProfile(environment)) { // ... } else { environment.addActiveProfile(KUBERNETES_PROFILE); } } else { // ... } } 初始化 Kubernetes 依赖 相关 Kubernetes 核心依赖的初始化是通过 org.springframework.cloud.kubernetes.KubernetesAutoConfiguration实现的\n初始化 Kubernetes Config @Bean @ConditionalOnMissingBean(Config.class) public Config kubernetesClientConfig(KubernetesClientProperties kubernetesClientProperties) { // 先尝试分别加载 ~/.kube 下面的配置，ServiceAccount 和 Namespace 文件 // 当配置文件中的配置缺失时使用基本的配置 Config base = Config.autoConfigure(null); Config properties = new ConfigBuilder(base) //\t... return properties;\t} 加载配置时，会先从本地的 ~/.kube中寻找配置，根据本地的配置，将当前应用中没有的配置补全，并返回相应的 Bean\n初始化 Kubernetes Client @Bean @ConditionalOnMissingBean public KubernetesClient kubernetesClient(Config config) { return new DefaultKubernetesClient(config); } 通过生成的配置初始化 KubernetesClient\n服务注册 服务注册是通过 org.springframework.cloud.kubernetes.registry.KubernetesAutoServiceRegistration 实现的，但是这个类在 2.x 中已经被标记为废弃，因为部署在 Kubernetes 中的服务已经存在于 etcd 中，所以注册并不会真正执行\n初始化 Bean 相关 Bean 的初始化是在 org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClientAutoConfiguration 中完成的\n@Bean public KubernetesServiceRegistry getServiceRegistry() { return new KubernetesServiceRegistry(); } @Bean public KubernetesRegistration getRegistration(KubernetesClient client, KubernetesDiscoveryProperties properties) { return new KubernetesRegistration(client, properties); } @Bean public KubernetesDiscoveryProperties getKubernetesDiscoveryProperties() { return new KubernetesDiscoveryProperties(); } 注册流程 实例化 KubernetesAutoServiceRegistration 类 因为实现了 SmartLifecycle 接口，所以在应用启动完成，收到 ServletWebServerInitializedEvent事件时开始注册 @EventListener(ServletWebServerInitializedEvent.class) public void onApplicationEvent(ServletWebServerInitializedEvent event) { int localPort = event.getWebServer().getPort(); if (this.port.get() == 0) { this.port.compareAndSet(0, localPort); start(); } } @Override public void start() { this.serviceRegistry.register(this.registration); this.context.publishEvent( new InstanceRegisteredEvent\u003c\u003e(this, this.registration.getProperties())); this.running.set(true); } 注册完成后发出实例注册的事件\n在 KubernetesServiceRegistry 实现注册逻辑 但实际上并未执行任何注册动作\n@Override public void register(KubernetesRegistration registration) { log.info(\"Registering : \" + registration); } 取消注册流程 监听容器关闭事件 收到事件后，调用 stop 方法，执行关闭逻辑；在 stop 方法中调用 deregister 方法，取消注册\n@EventListener(ContextClosedEvent.class) public void onApplicationEvent(ContextClosedEvent event) { if (event.getApplicationContext() == this.context) { stop(); } } @Override public void stop() { this.serviceRegistry.deregister(this.registration); this.running.set(false); } KubernetesServiceRegistry 实现取消注册逻辑 @Override public void deregister(KubernetesRegistration registration) { log.info(\"DeRegistering : \" + registration); } 服务发现 初始化 Bean 相关 Bean 的初始化在 org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClient 中完成\n@Bean @ConditionalOnMissingBean public KubernetesDiscoveryClient kubernetesDiscoveryClient( KubernetesClient client, KubernetesDiscoveryProperties properties, KubernetesClientServicesFunction kubernetesClientServicesFunction, DefaultIsServicePortSecureResolver isServicePortSecureResolver) { return new KubernetesDiscoveryClient(client, properties, kubernetesClientServicesFunction, isServicePortSecureResolver); } 获取服务 getService 调用 org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClient#getServices() 方法获取指定条件下的服务名称\n@Override public List\u003cString\u003e getServices() { String spelExpression = this.properties.getFilter(); Predicate\u003cService\u003e filteredServices; // 根据条件过滤 if (spelExpression == null || spelExpression.isEmpty()) { filteredServices = (Service instance) -\u003e true; } else { // 解析表达式 并生成过滤条件 Expression filterExpr = this.parser.parseExpression(spelExpression); filteredServices = (Service instance) -\u003e { Boolean include = filterExpr.getValue(this.evalCtxt, instance, Boolean.class); if (include == null) { return false; } return include; }; } return getServices(filteredServices); } public List\u003cString\u003e getServices(Predicate\u003cService\u003e filter) { return this.kubernetesClientServicesFunction.apply(this.client) .list() .getItems() .stream() .filter(filter) .map(s -\u003e s.getMetadata().getName()) .collect(Collectors.toList()); } 获取实例 getInstance 调用 org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClient#getInstances，根据服务的名称获取相应的实例列表\n@Override public List\u003cServiceInstance\u003e getInstances(String serviceId) { Assert.notNull(serviceId, \"[Assertion failed] - the object argument must not be null\"); // 判断是否查询所有命名空间下的服务，如果是则根据 metadata.name 查询， // 否则根据服务名称查询 List\u003cEndpoints\u003e endpointsList = this.properties.isAllNamespaces() ? this.client.endpoints() .inAnyNamespace() .withField(\"metadata.name\", serviceId) .list() .getItems() : Collections.singletonList(this.client.endpoints().withName(serviceId).get()); List\u003cEndpointSubsetNS\u003e subsetsNS = endpointsList.stream() .map(this::getSubsetsFromEndpoints) .collect(Collectors.toList()); // 获取所有的实例 List\u003cServiceInstance\u003e instances = new ArrayList\u003c\u003e(); if (!subsetsNS.isEmpty()) { for (EndpointSubsetNS es : subsetsNS) { instances.addAll(this.getNamespaceServiceInstances(es, serviceId)); } } return instances; } private List\u003cServiceInstance\u003e getNamespaceServiceInstances(EndpointSubsetNS es, String serviceId) { String namespace = es.getNamespace(); List\u003cEndpointSubset\u003e subsets = es.getEndpointSubset(); List\u003cServiceInstance\u003e instances = new ArrayList\u003c\u003e(); if (!subsets.isEmpty()) { // 查询指定命名空间下的服务 final Service service = this.client.services() .inNamespace(namespace) .withName(serviceId) .get(); // 获取 metadata final Map\u003cString, String\u003e serviceMetadata = this.getServiceMetadata(service); KubernetesDiscoveryProperties.Metadata metadataProps = this.properties.getMetadata(); for (EndpointSubset s : subsets) { // Extend the service metadata map with per-endpoint port information (if // requested) Map\u003cString, String\u003e endpointMetadata = new HashMap\u003c\u003e(serviceMetadata); if (metadataProps.isAddPorts()) { // 获取端口信息 Map\u003cString, String\u003e ports = s.getPorts() .stream() .filter(port -\u003e !StringUtils.isEmpty(port.getName())) .collect(toMap(EndpointPort::getName, port -\u003e Integer.toString(port.getPort()))); // 端口数据转为 map Map\u003cString, String\u003e portMetadata = getMapWithPrefixedKeys(ports, metadataProps.getPortsPrefix()); if (log.isDebugEnabled()) { log.debug(\"Adding port metadata: \" + portMetadata); } // 添加到 metadata 中 endpointMetadata.putAll(portMetadata); } List\u003cEndpointAddress\u003e addresses = s.getAddresses(); for (EndpointAddress endpointAddress : addresses) { String instanceId = null; if (endpointAddress.getTargetRef() != null) { instanceId = endpointAddress.getTargetRef().getUid(); } EndpointPort endpointPort = findEndpointPort(s); instances.add(new KubernetesServiceInstance(instanceId, serviceId, endpointAddress, endpointPort, endpointMetadata, this.isServicePortSecureResolver .resolve(new DefaultIsServicePortSecureResolver.Input( endpointPort.getPort(), service.getMetadata().getName(), service.getMetadata().getLabels(), service.getMetadata().getAnnotations())))); } } } return instances; } 服务列表更新 Kubernetes 的服务列表更新是通过定时任务实现的，核心类是 KubernetesDiscoveryClient\nKubernetes 不支持通过服务实例更新，因为调用时是通过 Service 的名称实现的，Kubernetes会做负载均衡，所以不需要在实例维度监听\n实例初始化 @Bean @ConditionalOnMissingBean @ConditionalOnProperty(name = \"spring.cloud.kubernetes.discovery.catalog-services-watch.enabled\", matchIfMissing = true) public KubernetesCatalogWatch kubernetesCatalogWatch(KubernetesClient client) { return new KubernetesCatalogWatch(client); } 监听实现 KubernetesCatalogWatch 类实现了 ApplicationEventPublisherAware接口，用于发现服务列表更新后发送相应的事件\n默认执行拉取任务的时间是30s，需要特别注意的是，该任务的开启依赖于@EnableScheduling注解开启定时任务，默认不会生效\n@Scheduled(fixedDelayString = \"${spring.cloud.kubernetes.discovery.catalogServicesWatchDelay:30000}\") public void catalogServicesWatch() { try { List\u003cString\u003e previousState = this.catalogEndpointsState.get(); // not all pods participate in the service discovery. only those that have // endpoints. // 仅有 endpoint 的服务参与服务发现 List\u003cEndpoints\u003e endpoints = this.kubernetesClient.endpoints() .list() .getItems(); // 将 endpoint 转为pod名称 List\u003cString\u003e endpointsPodNames = endpoints.stream() .map(Endpoints::getSubsets) .filter(Objects::nonNull) .flatMap(Collection::stream) .map(EndpointSubset::getAddresses) .filter(Objects::nonNull) .flatMap(Collection::stream) .map(EndpointAddress::getTargetRef) .filter(Objects::nonNull) .map(ObjectReference::getName) .sorted(String::compareTo) .collect(Collectors.toList()); this.catalogEndpointsState.set(endpointsPodNames); // 如果 pod 列表发生变化，则发送 HeartbeatEvent 事件 if (!endpointsPodNames.equals(previousState)) { logger.trace(\"Received endpoints update from kubernetesClient: {}\", endpointsPodNames); this.publisher.publishEvent(new HeartbeatEvent(this, endpointsPodNames)); } } catch (Exception e) { logger.error(\"Error watching Kubernetes Services\", e); } } ","wordCount":"750","inLanguage":"en","datePublished":"2020-09-20T22:26:03Z","dateModified":"2020-09-20T22:26:03Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.7f82854fa0e999ec07c4835d3029de9f484030e254b80d470b3ca48eb934720e.css integrity="sha256-f4KFT6DpmewHxINdMCnen0hAMOJUuA1HCzykjrk0cg4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script defer src=https://analytics.us.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Spring Cloud Kubernetes 服务注册和发现</h1></header><p><small>September 20, 2020&nbsp;· 750 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#初始化-kubernetes-client>初始化 Kubernetes Client</a><ul><li><a href=#初始化环境配置>初始化环境配置</a></li><li><a href=#初始化-kubernetes-依赖>初始化 Kubernetes 依赖</a></li></ul></li><li><a href=#服务注册>服务注册</a><ul><li><a href=#初始化-bean>初始化 Bean</a></li><li><a href=#注册流程>注册流程</a></li><li><a href=#取消注册流程>取消注册流程</a></li></ul></li><li><a href=#服务发现>服务发现</a><ul><li><a href=#初始化-bean-1>初始化 Bean</a></li><li><a href=#获取服务>获取服务</a></li><li><a href=#获取实例>获取实例</a></li><li><a href=#服务列表更新>服务列表更新</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=spring-cloud-kubernetes-服务注册和发现>Spring Cloud Kubernetes 服务注册和发现</h1><p>Spring Cloud Kubernetes 使用，可以通过引入 <code>org.springframework.cloud:spring-cloud-starter-kubernetes</code>，这个 starter 依赖于 <code>org.springframework.cloud:spring-cloud-kubernetes-core</code> 和 <code>org.springframework.cloud:spring-cloud-kubernetes-discovery</code></p><h2 id=初始化-kubernetes-client>初始化 Kubernetes Client</h2><h3 id=初始化环境配置>初始化环境配置</h3><p>环境初始化是通过 <code>org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor</code>类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postProcessEnvironment</span>(ConfigurableEnvironment environment,
</span></span><span style=display:flex><span>	                                   SpringApplication application) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 判断是否启用 kubernetes，默认为 true</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> kubernetesEnabled <span style=color:#f92672>=</span> environment.<span style=color:#a6e22e>getProperty</span>(<span style=color:#e6db74>&#34;spring.cloud.kubernetes.enabled&#34;</span>, Boolean.<span style=color:#a6e22e>class</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>kubernetesEnabled) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果在 Kubernetes 中</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (isInsideKubernetes()) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (hasKubernetesProfile(environment)) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				environment.<span style=color:#a6e22e>addActiveProfile</span>(KUBERNETES_PROFILE);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=初始化-kubernetes-依赖>初始化 Kubernetes 依赖</h3><p>相关 Kubernetes 核心依赖的初始化是通过 <code>org.springframework.cloud.kubernetes.KubernetesAutoConfiguration</code>实现的</p><ul><li>初始化 Kubernetes Config</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>(Config.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Config <span style=color:#a6e22e>kubernetesClientConfig</span>(KubernetesClientProperties kubernetesClientProperties) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 先尝试分别加载 ~/.kube 下面的配置，ServiceAccount 和 Namespace 文件</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 当配置文件中的配置缺失时使用基本的配置</span>
</span></span><span style=display:flex><span>		Config base <span style=color:#f92672>=</span> Config.<span style=color:#a6e22e>autoConfigure</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>		Config properties <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConfigBuilder(base)
</span></span><span style=display:flex><span>		<span style=color:#75715e>//	...</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> properties;		
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>加载配置时，会先从本地的 <code>~/.kube</code>中寻找配置，根据本地的配置，将当前应用中没有的配置补全，并返回相应的 Bean</p><ul><li>初始化 Kubernetes Client</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> KubernetesClient <span style=color:#a6e22e>kubernetesClient</span>(Config config) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultKubernetesClient(config);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>通过生成的配置初始化 KubernetesClient</p><h2 id=服务注册>服务注册</h2><p>服务注册是通过 <code>org.springframework.cloud.kubernetes.registry.KubernetesAutoServiceRegistration</code> 实现的，但是这个类在 2.x 中已经被标记为废弃，因为部署在 Kubernetes 中的服务已经存在于 etcd 中，所以注册并不会真正执行</p><h3 id=初始化-bean>初始化 Bean</h3><p>相关 Bean 的初始化是在 <code>org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClientAutoConfiguration</code> 中完成的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> KubernetesServiceRegistry <span style=color:#a6e22e>getServiceRegistry</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> KubernetesServiceRegistry();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> KubernetesRegistration <span style=color:#a6e22e>getRegistration</span>(KubernetesClient client,
</span></span><span style=display:flex><span>	                                              KubernetesDiscoveryProperties properties) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> KubernetesRegistration(client, properties);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> KubernetesDiscoveryProperties <span style=color:#a6e22e>getKubernetesDiscoveryProperties</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> KubernetesDiscoveryProperties();
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=注册流程>注册流程</h3><ul><li>实例化 KubernetesAutoServiceRegistration 类</li><li>因为实现了 <code>SmartLifecycle</code> 接口，所以在应用启动完成，收到 <code>ServletWebServerInitializedEvent</code>事件时开始注册</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@EventListener</span>(ServletWebServerInitializedEvent.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onApplicationEvent</span>(ServletWebServerInitializedEvent event) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> localPort <span style=color:#f92672>=</span> event.<span style=color:#a6e22e>getWebServer</span>().<span style=color:#a6e22e>getPort</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>port</span>.<span style=color:#a6e22e>get</span>() <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>port</span>.<span style=color:#a6e22e>compareAndSet</span>(0, localPort);
</span></span><span style=display:flex><span>			start();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>serviceRegistry</span>.<span style=color:#a6e22e>register</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>registration</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>publishEvent</span>(
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>new</span> InstanceRegisteredEvent<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>registration</span>.<span style=color:#a6e22e>getProperties</span>()));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>running</span>.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>注册完成后发出实例注册的事件</p><ul><li>在 <code>KubernetesServiceRegistry</code> 实现注册逻辑</li></ul><p>但实际上并未执行任何注册动作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>(KubernetesRegistration registration) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Registering : &#34;</span> <span style=color:#f92672>+</span> registration);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=取消注册流程>取消注册流程</h3><ul><li>监听容器关闭事件</li></ul><p>收到事件后，调用 stop 方法，执行关闭逻辑；在 stop 方法中调用 deregister 方法，取消注册</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@EventListener</span>(ContextClosedEvent.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onApplicationEvent</span>(ContextClosedEvent event) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (event.<span style=color:#a6e22e>getApplicationContext</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>) {
</span></span><span style=display:flex><span>			stop();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stop</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>serviceRegistry</span>.<span style=color:#a6e22e>deregister</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>registration</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>running</span>.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><ul><li><code>KubernetesServiceRegistry</code> 实现取消注册逻辑</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deregister</span>(KubernetesRegistration registration) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;DeRegistering : &#34;</span> <span style=color:#f92672>+</span> registration);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h2 id=服务发现>服务发现</h2><h3 id=初始化-bean-1>初始化 Bean</h3><p>相关 Bean 的初始化在 <code>org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClient</code> 中完成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> KubernetesDiscoveryClient <span style=color:#a6e22e>kubernetesDiscoveryClient</span>(
</span></span><span style=display:flex><span>			KubernetesClient client,
</span></span><span style=display:flex><span>			KubernetesDiscoveryProperties properties,
</span></span><span style=display:flex><span>			KubernetesClientServicesFunction kubernetesClientServicesFunction,
</span></span><span style=display:flex><span>			DefaultIsServicePortSecureResolver isServicePortSecureResolver) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> KubernetesDiscoveryClient(client, properties,
</span></span><span style=display:flex><span>				kubernetesClientServicesFunction, isServicePortSecureResolver);
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><h3 id=获取服务>获取服务</h3><ul><li>getService</li></ul><p>调用 <code>org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClient#getServices()</code> 方法获取指定条件下的服务名称</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getServices</span>() {
</span></span><span style=display:flex><span>		String spelExpression <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getFilter</span>();
</span></span><span style=display:flex><span>		Predicate<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> filteredServices;
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 根据条件过滤</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (spelExpression <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> spelExpression.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>			filteredServices <span style=color:#f92672>=</span> (Service instance) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 解析表达式 并生成过滤条件</span>
</span></span><span style=display:flex><span>			Expression filterExpr <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>parseExpression</span>(spelExpression);
</span></span><span style=display:flex><span>			filteredServices <span style=color:#f92672>=</span> (Service instance) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>				Boolean include <span style=color:#f92672>=</span> filterExpr.<span style=color:#a6e22e>getValue</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evalCtxt</span>, instance, Boolean.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (include <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> include;
</span></span><span style=display:flex><span>			};
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> getServices(filteredServices);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getServices</span>(Predicate<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> filter) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kubernetesClientServicesFunction</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>)
</span></span><span style=display:flex><span>		                                            .<span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span>		                                            .<span style=color:#a6e22e>getItems</span>()
</span></span><span style=display:flex><span>		                                            .<span style=color:#a6e22e>stream</span>()
</span></span><span style=display:flex><span>		                                            .<span style=color:#a6e22e>filter</span>(filter)
</span></span><span style=display:flex><span>		                                            .<span style=color:#a6e22e>map</span>(s <span style=color:#f92672>-&gt;</span> s.<span style=color:#a6e22e>getMetadata</span>().<span style=color:#a6e22e>getName</span>())
</span></span><span style=display:flex><span>		                                            .<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>toList</span>());
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=获取实例>获取实例</h3><ul><li>getInstance</li></ul><p>调用 <code>org.springframework.cloud.kubernetes.discovery.KubernetesDiscoveryClient#getInstances</code>，根据服务的名称获取相应的实例列表</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getInstances</span>(String serviceId) {
</span></span><span style=display:flex><span>		Assert.<span style=color:#a6e22e>notNull</span>(serviceId, <span style=color:#e6db74>&#34;[Assertion failed] - the object argument must not be null&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 判断是否查询所有命名空间下的服务，如果是则根据 metadata.name 查询，</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 否则根据服务名称查询</span>
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>Endpoints<span style=color:#f92672>&gt;</span> endpointsList <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isAllNamespaces</span>()
</span></span><span style=display:flex><span>			<span style=color:#f92672>?</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>endpoints</span>()
</span></span><span style=display:flex><span>			             .<span style=color:#a6e22e>inAnyNamespace</span>()
</span></span><span style=display:flex><span>			             .<span style=color:#a6e22e>withField</span>(<span style=color:#e6db74>&#34;metadata.name&#34;</span>, serviceId)
</span></span><span style=display:flex><span>			             .<span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span>			             .<span style=color:#a6e22e>getItems</span>()
</span></span><span style=display:flex><span>			: Collections.<span style=color:#a6e22e>singletonList</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>endpoints</span>().<span style=color:#a6e22e>withName</span>(serviceId).<span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>EndpointSubsetNS<span style=color:#f92672>&gt;</span> subsetsNS <span style=color:#f92672>=</span> endpointsList.<span style=color:#a6e22e>stream</span>()
</span></span><span style=display:flex><span>		                                                .<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>this</span>::getSubsetsFromEndpoints)
</span></span><span style=display:flex><span>		                                                .<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>toList</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 获取所有的实例</span>
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> instances <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>subsetsNS.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> (EndpointSubsetNS es : subsetsNS) {
</span></span><span style=display:flex><span>				instances.<span style=color:#a6e22e>addAll</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getNamespaceServiceInstances</span>(es, serviceId));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> instances;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getNamespaceServiceInstances</span>(EndpointSubsetNS es,
</span></span><span style=display:flex><span>	                                                           String serviceId) {
</span></span><span style=display:flex><span>		String namespace <span style=color:#f92672>=</span> es.<span style=color:#a6e22e>getNamespace</span>();
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>EndpointSubset<span style=color:#f92672>&gt;</span> subsets <span style=color:#f92672>=</span> es.<span style=color:#a6e22e>getEndpointSubset</span>();
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> instances <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>subsets.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 查询指定命名空间下的服务</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>final</span> Service service <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>services</span>()
</span></span><span style=display:flex><span>			                                   .<span style=color:#a6e22e>inNamespace</span>(namespace)
</span></span><span style=display:flex><span>			                                   .<span style=color:#a6e22e>withName</span>(serviceId)
</span></span><span style=display:flex><span>			                                   .<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 获取 metadata</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> serviceMetadata <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getServiceMetadata</span>(service);
</span></span><span style=display:flex><span>			KubernetesDiscoveryProperties.<span style=color:#a6e22e>Metadata</span> metadataProps <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getMetadata</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> (EndpointSubset s : subsets) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Extend the service metadata map with per-endpoint port information (if</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// requested)</span>
</span></span><span style=display:flex><span>				Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> endpointMetadata <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>(serviceMetadata);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (metadataProps.<span style=color:#a6e22e>isAddPorts</span>()) {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// 获取端口信息</span>
</span></span><span style=display:flex><span>					Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> ports <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>getPorts</span>()
</span></span><span style=display:flex><span>					                             .<span style=color:#a6e22e>stream</span>()
</span></span><span style=display:flex><span>					                             .<span style=color:#a6e22e>filter</span>(port <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>!</span>StringUtils.<span style=color:#a6e22e>isEmpty</span>(port.<span style=color:#a6e22e>getName</span>()))
</span></span><span style=display:flex><span>					                             .<span style=color:#a6e22e>collect</span>(toMap(EndpointPort::getName, port <span style=color:#f92672>-&gt;</span> Integer.<span style=color:#a6e22e>toString</span>(port.<span style=color:#a6e22e>getPort</span>())));
</span></span><span style=display:flex><span>					<span style=color:#75715e>// 端口数据转为 map</span>
</span></span><span style=display:flex><span>					Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> portMetadata <span style=color:#f92672>=</span> getMapWithPrefixedKeys(ports, metadataProps.<span style=color:#a6e22e>getPortsPrefix</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (log.<span style=color:#a6e22e>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>						log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Adding port metadata: &#34;</span> <span style=color:#f92672>+</span> portMetadata);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>// 添加到 metadata 中</span>
</span></span><span style=display:flex><span>					endpointMetadata.<span style=color:#a6e22e>putAll</span>(portMetadata);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				List<span style=color:#f92672>&lt;</span>EndpointAddress<span style=color:#f92672>&gt;</span> addresses <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>getAddresses</span>();
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> (EndpointAddress endpointAddress : addresses) {
</span></span><span style=display:flex><span>					String instanceId <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (endpointAddress.<span style=color:#a6e22e>getTargetRef</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>						instanceId <span style=color:#f92672>=</span> endpointAddress.<span style=color:#a6e22e>getTargetRef</span>().<span style=color:#a6e22e>getUid</span>();
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					EndpointPort endpointPort <span style=color:#f92672>=</span> findEndpointPort(s);
</span></span><span style=display:flex><span>					instances.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> KubernetesServiceInstance(instanceId, serviceId,
</span></span><span style=display:flex><span>						endpointAddress, endpointPort, endpointMetadata,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isServicePortSecureResolver</span>
</span></span><span style=display:flex><span>							.<span style=color:#a6e22e>resolve</span>(<span style=color:#66d9ef>new</span> DefaultIsServicePortSecureResolver.<span style=color:#a6e22e>Input</span>(
</span></span><span style=display:flex><span>								endpointPort.<span style=color:#a6e22e>getPort</span>(),
</span></span><span style=display:flex><span>								service.<span style=color:#a6e22e>getMetadata</span>().<span style=color:#a6e22e>getName</span>(),
</span></span><span style=display:flex><span>								service.<span style=color:#a6e22e>getMetadata</span>().<span style=color:#a6e22e>getLabels</span>(),
</span></span><span style=display:flex><span>								service.<span style=color:#a6e22e>getMetadata</span>().<span style=color:#a6e22e>getAnnotations</span>()))));
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> instances;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=服务列表更新>服务列表更新</h3><p>Kubernetes 的服务列表更新是通过定时任务实现的，核心类是 <code>KubernetesDiscoveryClient</code></p><p>Kubernetes 不支持通过服务实例更新，因为调用时是通过 Service 的名称实现的，Kubernetes会做负载均衡，所以不需要在实例维度监听</p><h4 id=实例初始化>实例初始化</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnProperty</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.cloud.kubernetes.discovery.catalog-services-watch.enabled&#34;</span>, matchIfMissing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> KubernetesCatalogWatch <span style=color:#a6e22e>kubernetesCatalogWatch</span>(KubernetesClient client) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> KubernetesCatalogWatch(client);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h4 id=监听实现>监听实现</h4><p><code>KubernetesCatalogWatch</code> 类实现了 <code>ApplicationEventPublisherAware</code>接口，用于发现服务列表更新后发送相应的事件</p><p>默认执行拉取任务的时间是30s，需要特别注意的是，该任务的开启依赖于<code>@EnableScheduling</code>注解开启定时任务，默认不会生效</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Scheduled</span>(fixedDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${spring.cloud.kubernetes.discovery.catalogServicesWatchDelay:30000}&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>catalogServicesWatch</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> previousState <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>catalogEndpointsState</span>.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// not all pods participate in the service discovery. only those that have</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// endpoints.</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 仅有 endpoint 的服务参与服务发现</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>Endpoints<span style=color:#f92672>&gt;</span> endpoints <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>endpoints</span>()
</span></span><span style=display:flex><span>			                                                 .<span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span>			                                                 .<span style=color:#a6e22e>getItems</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将 endpoint 转为pod名称</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> endpointsPodNames <span style=color:#f92672>=</span> endpoints.<span style=color:#a6e22e>stream</span>()
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>map</span>(Endpoints::getSubsets)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>filter</span>(Objects::nonNull)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>flatMap</span>(Collection::stream)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>map</span>(EndpointSubset::getAddresses)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>filter</span>(Objects::nonNull)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>flatMap</span>(Collection::stream)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>map</span>(EndpointAddress::getTargetRef)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>filter</span>(Objects::nonNull)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>map</span>(ObjectReference::getName) 
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>sorted</span>(String::compareTo)
</span></span><span style=display:flex><span>			                                          .<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>toList</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>catalogEndpointsState</span>.<span style=color:#a6e22e>set</span>(endpointsPodNames);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 如果 pod 列表发生变化，则发送 HeartbeatEvent 事件</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>endpointsPodNames.<span style=color:#a6e22e>equals</span>(previousState)) {
</span></span><span style=display:flex><span>				logger.<span style=color:#a6e22e>trace</span>(<span style=color:#e6db74>&#34;Received endpoints update from kubernetesClient: {}&#34;</span>, endpointsPodNames);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>publisher</span>.<span style=color:#a6e22e>publishEvent</span>(<span style=color:#66d9ef>new</span> HeartbeatEvent(<span style=color:#66d9ef>this</span>, endpointsPodNames));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			logger.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error watching Kubernetes Services&#34;</span>, e);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>Spring Cloud Consul 服务注册和发现</span></a>
<a class=next href=https://blog.hellowood.dev/posts/spring-cloud-gateway-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/><span>Spring Cloud Gateway 使用 Kubernetes 作为服务发现</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>