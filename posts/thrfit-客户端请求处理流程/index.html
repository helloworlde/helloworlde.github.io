<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>Thrfit 客户端请求处理流程</title><meta name=description content="使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta name=keywords content='blog,hugo,Thrift'><meta property="og:url" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="og:type" content="website"><meta property="og:title" content="Thrfit 客户端请求处理流程"><meta property="og:description" content="使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Thrfit 客户端请求处理流程"><meta name=twitter:description content="使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.70293498aa96b2dbb767ec11a622eb2266d8fc37a0fff88233a82952e3c72b15.js integrity="sha256-cCk0mKqWstu3Z+wRpiLrImbY/Deg//iCM6gpUuPHKxU="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-5709431067036925"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5709431067036925" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Thrfit 客户端请求处理流程</h1><small role=doc-subtitle></small><p class=post-date>2021-02-20</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/thrift>Thrift</a></li></ul></div><div class=post-content><p>使用同步的非阻塞的服务端和客户端的请求处理流程</p><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#f92672>namespace</span> java io.github.helloworlde.thrift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>service</span> <span style=color:#a6e22e>HelloService</span> {
</span></span><span style=display:flex><span>    HelloResponse <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span>: HelloMessage request);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=客户端实现>客户端实现</h3><p>使用 <code>TSocket</code> 作为底层连接，协议使用 <code>TBinaryProtocol</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    TTransport transport  <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TSocket(<span style=color:#e6db74>&#34;localhost&#34;</span>, 9090);
</span></span><span style=display:flex><span>    transport.<span style=color:#a6e22e>open</span>();
</span></span><span style=display:flex><span>    TProtocol protocol <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TBinaryProtocol(transport);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HelloService.<span style=color:#a6e22e>Client</span> client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloService.<span style=color:#a6e22e>Client</span>(protocol);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HelloMessage request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloMessage();
</span></span><span style=display:flex><span>    request.<span style=color:#a6e22e>setMessage</span>(<span style=color:#e6db74>&#34;Thrift&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HelloResponse response <span style=color:#f92672>=</span> client.<span style=color:#a6e22e>sayHello</span>(request);
</span></span><span style=display:flex><span>    log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;返回响应: {}&#34;</span>, response.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (TException e) {
</span></span><span style=display:flex><span>    e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><h3 id=1-建立连接>1. 建立连接</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>transport.<span style=color:#a6e22e>open</span>();
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TSocket#open</li></ul><p>初始化 Socket，建立连接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>open</span>() <span style=color:#66d9ef>throws</span> TTransportException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (socket_ <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 初始化 Socket</span>
</span></span><span style=display:flex><span>        initSocket();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 建立连接</span>
</span></span><span style=display:flex><span>        socket_.<span style=color:#a6e22e>connect</span>(<span style=color:#66d9ef>new</span> InetSocketAddress(host_, port_), connectTimeout_);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 初始化流</span>
</span></span><span style=display:flex><span>        inputStream_ <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedInputStream(socket_.<span style=color:#a6e22e>getInputStream</span>());
</span></span><span style=display:flex><span>        outputStream_ <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedOutputStream(socket_.<span style=color:#a6e22e>getOutputStream</span>());
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (IOException iox) {
</span></span><span style=display:flex><span>        close();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TTransportException(TTransportException.<span style=color:#a6e22e>NOT_OPEN</span>, iox);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-执行请求>2. 执行请求</h3><p>使用 <code>TProtocol</code> 构建 <code>TServiceClient</code>，用于发送同步请求</p><ul><li>io.github.helloworlde.thrift.HelloService.Client#sayHello</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>sayHello</span>(HelloMessage request) <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>    send_sayHello(request);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> recv_sayHello();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=发送请求>发送请求</h4><ul><li>io.github.helloworlde.thrift.HelloService.Client#send_sayHello</li></ul><p>其中的 <code>sayHello_args</code> 用于读写结构体，将消息内容转换为相应格式的字节</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>send_sayHello</span>(HelloMessage request) <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>    sayHello_args args <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_args();
</span></span><span style=display:flex><span>    args.<span style=color:#a6e22e>setRequest</span>(request);
</span></span><span style=display:flex><span>    sendBase(<span style=color:#e6db74>&#34;sayHello&#34;</span>, args);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase)</li></ul><p>这里设置了消息类型是调用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendBase</span>(String methodName, TBase<span style=color:#f92672>&lt;?</span>, <span style=color:#f92672>?&gt;</span> args) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    sendBase(methodName, args, TMessageType.<span style=color:#a6e22e>CALL</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase, byte)</li></ul><p>在写入请求，写入请求头，写入消息体，然后写入结尾符，将请求发送出去</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendBase</span>(String methodName, TBase<span style=color:#f92672>&lt;?</span>, <span style=color:#f92672>?&gt;</span> args, <span style=color:#66d9ef>byte</span> type) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构建请求，写入头信息</span>
</span></span><span style=display:flex><span>    oprot_.<span style=color:#a6e22e>writeMessageBegin</span>(<span style=color:#66d9ef>new</span> TMessage(methodName, type, <span style=color:#f92672>++</span>seqid_));
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 写入协议对象</span>
</span></span><span style=display:flex><span>    args.<span style=color:#a6e22e>write</span>(oprot_);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 写入结尾信息</span>
</span></span><span style=display:flex><span>    oprot_.<span style=color:#a6e22e>writeMessageEnd</span>();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空缓冲，写入</span>
</span></span><span style=display:flex><span>    oprot_.<span style=color:#a6e22e>getTransport</span>().<span style=color:#a6e22e>flush</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#writeMessageBegin</li></ul><p>会将版本、调用类型、方法名、请求 ID 写入到请求头</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeMessageBegin</span>(TMessage message) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (strictWrite_) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 写入版本</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> version <span style=color:#f92672>=</span> VERSION_1 <span style=color:#f92672>|</span> message.<span style=color:#a6e22e>type</span>;
</span></span><span style=display:flex><span>        writeI32(version);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 被调用方法</span>
</span></span><span style=display:flex><span>        writeString(message.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 请求序号</span>
</span></span><span style=display:flex><span>        writeI32(message.<span style=color:#a6e22e>seqid</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        writeString(message.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>        writeByte(message.<span style=color:#a6e22e>type</span>);
</span></span><span style=display:flex><span>        writeI32(message.<span style=color:#a6e22e>seqid</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.sayHello_args.sayHello_argsStandardScheme#write</li></ul><p>写入请求内容，会将结构体的相关描述信息写入到请求中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write</span>(org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TProtocol</span> oprot, sayHello_args struct) <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>  struct.<span style=color:#a6e22e>validate</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeStructBegin</span>(STRUCT_DESC);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (struct.<span style=color:#a6e22e>request</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeFieldBegin</span>(REQUEST_FIELD_DESC);
</span></span><span style=display:flex><span>    struct.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>write</span>(oprot);
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeFieldEnd</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeFieldStop</span>();
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeStructEnd</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=接收响应>接收响应</h4><ul><li>io.github.helloworlde.thrift.HelloService.Client#recv_sayHello</li></ul><p>在处理请求时先构建了 <code>sayHello_result</code>对象，用于解析响应的描述</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>recv_sayHello</span>() <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>  sayHello_result result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_result();
</span></span><span style=display:flex><span>  receiveBase(result, <span style=color:#e6db74>&#34;sayHello&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (result.<span style=color:#a6e22e>isSetSuccess</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result.<span style=color:#a6e22e>success</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TApplicationException</span>(org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TApplicationException</span>.<span style=color:#a6e22e>MISSING_RESULT</span>, <span style=color:#e6db74>&#34;sayHello failed: unknown result&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#receiveBase</li></ul><p>读取响应内容，解析为对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receiveBase</span>(TBase<span style=color:#f92672>&lt;?</span>, <span style=color:#f92672>?&gt;</span> result, String methodName) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取消息</span>
</span></span><span style=display:flex><span>    TMessage msg <span style=color:#f92672>=</span> iprot_.<span style=color:#a6e22e>readMessageBegin</span>();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是异常，则读取异常并抛出</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (msg.<span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> TMessageType.<span style=color:#a6e22e>EXCEPTION</span>) {
</span></span><span style=display:flex><span>        TApplicationException x <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TApplicationException();
</span></span><span style=display:flex><span>        x.<span style=color:#a6e22e>read</span>(iprot_);
</span></span><span style=display:flex><span>        iprot_.<span style=color:#a6e22e>readMessageEnd</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> x;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果请求序号不匹配，则抛出异常</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (msg.<span style=color:#a6e22e>seqid</span> <span style=color:#f92672>!=</span> seqid_) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TApplicationException(TApplicationException.<span style=color:#a6e22e>BAD_SEQUENCE_ID</span>,
</span></span><span style=display:flex><span>                String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%s failed: out of sequence response: expected %d but got %d&#34;</span>, methodName, seqid_, msg.<span style=color:#a6e22e>seqid</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取响应内容</span>
</span></span><span style=display:flex><span>    result.<span style=color:#a6e22e>read</span>(iprot_);
</span></span><span style=display:flex><span>    iprot_.<span style=color:#a6e22e>readMessageEnd</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#readMessageBegin</li></ul><p>读取并校验版本，获取方法名称、消息类型、请求 ID</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> TMessage <span style=color:#a6e22e>readMessageBegin</span>() <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> readI32();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (size <span style=color:#f92672>&lt;</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> version <span style=color:#f92672>=</span> size <span style=color:#f92672>&amp;</span> VERSION_MASK;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (version <span style=color:#f92672>!=</span> VERSION_1) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TProtocolException(TProtocolException.<span style=color:#a6e22e>BAD_VERSION</span>, <span style=color:#e6db74>&#34;Bad version in readMessageBegin&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TMessage(readString(), (<span style=color:#66d9ef>byte</span>) (size <span style=color:#f92672>&amp;</span> 0x000000ff), readI32());
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (strictRead_) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TProtocolException(TProtocolException.<span style=color:#a6e22e>BAD_VERSION</span>, <span style=color:#e6db74>&#34;Missing version in readMessageBegin, old client?&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TMessage(readStringBody(size), readByte(), readI32());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.sayHello_result.sayHello_resultStandardScheme#read</li></ul><p>读取响应内容，解析为相应的对象，然后赋值给 result 对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>read</span>(org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TProtocol</span> iprot, sayHello_result struct) <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>  org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TField</span> schemeField;
</span></span><span style=display:flex><span>  iprot.<span style=color:#a6e22e>readStructBegin</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>    schemeField <span style=color:#f92672>=</span> iprot.<span style=color:#a6e22e>readFieldBegin</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (schemeField.<span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TType</span>.<span style=color:#a6e22e>STOP</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (schemeField.<span style=color:#a6e22e>id</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> 0: <span style=color:#75715e>// SUCCESS</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (schemeField.<span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TType</span>.<span style=color:#a6e22e>STRUCT</span>) {
</span></span><span style=display:flex><span>          struct.<span style=color:#a6e22e>success</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloResponse();
</span></span><span style=display:flex><span>          struct.<span style=color:#a6e22e>success</span>.<span style=color:#a6e22e>read</span>(iprot);
</span></span><span style=display:flex><span>          struct.<span style=color:#a6e22e>setSuccessIsSet</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TProtocolUtil</span>.<span style=color:#a6e22e>skip</span>(iprot, schemeField.<span style=color:#a6e22e>type</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TProtocolUtil</span>.<span style=color:#a6e22e>skip</span>(iprot, schemeField.<span style=color:#a6e22e>type</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    iprot.<span style=color:#a6e22e>readFieldEnd</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  iprot.<span style=color:#a6e22e>readStructEnd</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// check for required fields of primitive type, which can&#39;t be checked in the validate method</span>
</span></span><span style=display:flex><span>  struct.<span style=color:#a6e22e>validate</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2021 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>