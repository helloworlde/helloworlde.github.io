<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Thrfit 客户端请求处理流程</title><meta charset=utf-8><meta name=description content="Ladder@Thrfit 客户端请求处理流程 使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端实现 使用 TSocket 作为底层连接，协议使用 TBinaryProtocol
try { TTransport transport = new TSocket(&#34;localhost&#34;, 9090); transport.open(); TProtocol protocol = new TBinaryProtocol(transport); HelloService.Client client = new HelloService.Client(protocol); HelloMessage request = new HelloMessage(); request.setMessage(&#34;Thrift&#34;); HelloResponse response = client.sayHello(request); log.info(&#34;返回响应: {}&#34;, response.getMessage()); } catch (TException e) { e."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/umami.js></script><meta property="og:title" content="Thrfit 客户端请求处理流程"><meta property="og:description" content="Thrfit 客户端请求处理流程 使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端实现 使用 TSocket 作为底层连接，协议使用 TBinaryProtocol
try { TTransport transport = new TSocket(&#34;localhost&#34;, 9090); transport.open(); TProtocol protocol = new TBinaryProtocol(transport); HelloService.Client client = new HelloService.Client(protocol); HelloMessage request = new HelloMessage(); request.setMessage(&#34;Thrift&#34;); HelloResponse response = client.sayHello(request); log.info(&#34;返回响应: {}&#34;, response.getMessage()); } catch (TException e) { e."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-20T22:34:46+00:00"><meta property="article:modified_time" content="2021-02-20T22:34:46+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Thrfit 客户端请求处理流程"><meta name=twitter:description content="Thrfit 客户端请求处理流程 使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端实现 使用 TSocket 作为底层连接，协议使用 TBinaryProtocol
try { TTransport transport = new TSocket(&#34;localhost&#34;, 9090); transport.open(); TProtocol protocol = new TBinaryProtocol(transport); HelloService.Client client = new HelloService.Client(protocol); HelloMessage request = new HelloMessage(); request.setMessage(&#34;Thrift&#34;); HelloResponse response = client.sayHello(request); log.info(&#34;返回响应: {}&#34;, response.getMessage()); } catch (TException e) { e."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Thrfit 客户端请求处理流程","item":"https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Thrfit 客户端请求处理流程","name":"Thrfit 客户端请求处理流程","description":"Thrfit 客户端请求处理流程 使用同步的非阻塞的服务端和客户端的请求处理流程\n实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端实现 使用 TSocket 作为底层连接，协议使用 TBinaryProtocol\ntry { TTransport transport = new TSocket(\u0026#34;localhost\u0026#34;, 9090); transport.open(); TProtocol protocol = new TBinaryProtocol(transport); HelloService.Client client = new HelloService.Client(protocol); HelloMessage request = new HelloMessage(); request.setMessage(\u0026#34;Thrift\u0026#34;); HelloResponse response = client.sayHello(request); log.info(\u0026#34;返回响应: {}\u0026#34;, response.getMessage()); } catch (TException e) { e.","keywords":["Thrift"],"articleBody":"Thrfit 客户端请求处理流程 使用同步的非阻塞的服务端和客户端的请求处理流程\n实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端实现 使用 TSocket 作为底层连接，协议使用 TBinaryProtocol\ntry { TTransport transport = new TSocket(\"localhost\", 9090); transport.open(); TProtocol protocol = new TBinaryProtocol(transport); HelloService.Client client = new HelloService.Client(protocol); HelloMessage request = new HelloMessage(); request.setMessage(\"Thrift\"); HelloResponse response = client.sayHello(request); log.info(\"返回响应: {}\", response.getMessage()); } catch (TException e) { e.printStackTrace(); } 请求处理流程 1. 建立连接 transport.open(); org.apache.thrift.transport.TSocket#open 初始化 Socket，建立连接\npublic void open() throws TTransportException { if (socket_ == null) { // 初始化 Socket initSocket(); } try { // 建立连接 socket_.connect(new InetSocketAddress(host_, port_), connectTimeout_); // 初始化流 inputStream_ = new BufferedInputStream(socket_.getInputStream()); outputStream_ = new BufferedOutputStream(socket_.getOutputStream()); } catch (IOException iox) { close(); throw new TTransportException(TTransportException.NOT_OPEN, iox); } } 2. 执行请求 使用 TProtocol 构建 TServiceClient，用于发送同步请求\nio.github.helloworlde.thrift.HelloService.Client#sayHello public HelloResponse sayHello(HelloMessage request) throws org.apache.thrift.TException { send_sayHello(request); return recv_sayHello(); } 发送请求 io.github.helloworlde.thrift.HelloService.Client#send_sayHello 其中的 sayHello_args 用于读写结构体，将消息内容转换为相应格式的字节\npublic void send_sayHello(HelloMessage request) throws org.apache.thrift.TException { sayHello_args args = new sayHello_args(); args.setRequest(request); sendBase(\"sayHello\", args); } org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase) 这里设置了消息类型是调用\nprotected void sendBase(String methodName, TBase\u003c?, ?\u003e args) throws TException { sendBase(methodName, args, TMessageType.CALL); } org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase, byte) 在写入请求，写入请求头，写入消息体，然后写入结尾符，将请求发送出去\nprivate void sendBase(String methodName, TBase\u003c?, ?\u003e args, byte type) throws TException { // 构建请求，写入头信息 oprot_.writeMessageBegin(new TMessage(methodName, type, ++seqid_)); // 写入协议对象 args.write(oprot_); // 写入结尾信息 oprot_.writeMessageEnd(); // 清空缓冲，写入 oprot_.getTransport().flush(); } org.apache.thrift.protocol.TBinaryProtocol#writeMessageBegin 会将版本、调用类型、方法名、请求 ID 写入到请求头\npublic void writeMessageBegin(TMessage message) throws TException { if (strictWrite_) { // 写入版本 int version = VERSION_1 | message.type; writeI32(version); // 被调用方法 writeString(message.name); // 请求序号 writeI32(message.seqid); } else { writeString(message.name); writeByte(message.type); writeI32(message.seqid); } } io.github.helloworlde.thrift.HelloService.sayHello_args.sayHello_argsStandardScheme#write 写入请求内容，会将结构体的相关描述信息写入到请求中\npublic void write(org.apache.thrift.protocol.TProtocol oprot, sayHello_args struct) throws org.apache.thrift.TException { struct.validate(); oprot.writeStructBegin(STRUCT_DESC); if (struct.request != null) { oprot.writeFieldBegin(REQUEST_FIELD_DESC); struct.request.write(oprot); oprot.writeFieldEnd(); } oprot.writeFieldStop(); oprot.writeStructEnd(); } 接收响应 io.github.helloworlde.thrift.HelloService.Client#recv_sayHello 在处理请求时先构建了 sayHello_result对象，用于解析响应的描述\npublic HelloResponse recv_sayHello() throws org.apache.thrift.TException { sayHello_result result = new sayHello_result(); receiveBase(result, \"sayHello\"); if (result.isSetSuccess()) { return result.success; } throw new org.apache.thrift.TApplicationException(org.apache.thrift.TApplicationException.MISSING_RESULT, \"sayHello failed: unknown result\"); } org.apache.thrift.TServiceClient#receiveBase 读取响应内容，解析为对象\nprotected void receiveBase(TBase\u003c?, ?\u003e result, String methodName) throws TException { // 读取消息 TMessage msg = iprot_.readMessageBegin(); // 如果是异常，则读取异常并抛出 if (msg.type == TMessageType.EXCEPTION) { TApplicationException x = new TApplicationException(); x.read(iprot_); iprot_.readMessageEnd(); throw x; } // 如果请求序号不匹配，则抛出异常 if (msg.seqid != seqid_) { throw new TApplicationException(TApplicationException.BAD_SEQUENCE_ID, String.format(\"%s failed: out of sequence response: expected %d but got %d\", methodName, seqid_, msg.seqid)); } // 读取响应内容 result.read(iprot_); iprot_.readMessageEnd(); } org.apache.thrift.protocol.TBinaryProtocol#readMessageBegin 读取并校验版本，获取方法名称、消息类型、请求 ID\npublic TMessage readMessageBegin() throws TException { int size = readI32(); if (size \u003c 0) { int version = size \u0026 VERSION_MASK; if (version != VERSION_1) { throw new TProtocolException(TProtocolException.BAD_VERSION, \"Bad version in readMessageBegin\"); } return new TMessage(readString(), (byte) (size \u0026 0x000000ff), readI32()); } else { if (strictRead_) { throw new TProtocolException(TProtocolException.BAD_VERSION, \"Missing version in readMessageBegin, old client?\"); } return new TMessage(readStringBody(size), readByte(), readI32()); } } io.github.helloworlde.thrift.HelloService.sayHello_result.sayHello_resultStandardScheme#read 读取响应内容，解析为相应的对象，然后赋值给 result 对象\npublic void read(org.apache.thrift.protocol.TProtocol iprot, sayHello_result struct) throws org.apache.thrift.TException { org.apache.thrift.protocol.TField schemeField; iprot.readStructBegin(); while (true) { schemeField = iprot.readFieldBegin(); if (schemeField.type == org.apache.thrift.protocol.TType.STOP) { break; } switch (schemeField.id) { case 0: // SUCCESS if (schemeField.type == org.apache.thrift.protocol.TType.STRUCT) { struct.success = new HelloResponse(); struct.success.read(iprot); struct.setSuccessIsSet(true); } else { org.apache.thrift.protocol.TProtocolUtil.skip(iprot, schemeField.type); } break; default: org.apache.thrift.protocol.TProtocolUtil.skip(iprot, schemeField.type); } iprot.readFieldEnd(); } iprot.readStructEnd(); // check for required fields of primitive type, which can't be checked in the validate method struct.validate(); } 参考文档 helloworlde/thrift-java-sample ","wordCount":"525","inLanguage":"en","datePublished":"2021-02-20T22:34:46Z","dateModified":"2021-02-20T22:34:46Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c098d85b5396dec4707ea2cead1445b4dc2ff0fc56b8dbbd9049d0d1c50ad237.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/r2Llssnu/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Thrfit 客户端请求处理流程</h1></header><p><small>February 20, 2021&nbsp;· 525 words&nbsp;· 3 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#实现>实现</a><ul><li><a href=#idl>IDL</a></li><li><a href=#客户端实现>客户端实现</a></li></ul></li><li><a href=#请求处理流程>请求处理流程</a><ul><li><a href=#1-建立连接>1. 建立连接</a></li><li><a href=#2-执行请求>2. 执行请求</a></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div><section class=blog-content><h1 id=thrfit-客户端请求处理流程>Thrfit 客户端请求处理流程</h1><p>使用同步的非阻塞的服务端和客户端的请求处理流程</p><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#f92672>namespace</span> java io.github.helloworlde.thrift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>service</span> <span style=color:#a6e22e>HelloService</span> {
</span></span><span style=display:flex><span>    HelloResponse <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span>: HelloMessage request);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=客户端实现>客户端实现</h3><p>使用 <code>TSocket</code> 作为底层连接，协议使用 <code>TBinaryProtocol</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TTransport transport  <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TSocket<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>9090</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    transport<span style=color:#f92672>.</span><span style=color:#a6e22e>open</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    TProtocol protocol <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TBinaryProtocol<span style=color:#f92672>(</span>transport<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>Client</span> client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>Client</span><span style=color:#f92672>(</span>protocol<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HelloMessage request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloMessage<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Thrift&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HelloResponse response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;返回响应: {}&#34;</span><span style=color:#f92672>,</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>TException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><h3 id=1-建立连接>1. 建立连接</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>transport<span style=color:#f92672>.</span><span style=color:#a6e22e>open</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TSocket#open</li></ul><p>初始化 Socket，建立连接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>open</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> TTransportException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>socket_ <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 初始化 Socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        initSocket<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 建立连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        socket_<span style=color:#f92672>.</span><span style=color:#a6e22e>connect</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InetSocketAddress<span style=color:#f92672>(</span>host_<span style=color:#f92672>,</span> port_<span style=color:#f92672>),</span> connectTimeout_<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 初始化流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        inputStream_ <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedInputStream<span style=color:#f92672>(</span>socket_<span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        outputStream_ <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedOutputStream<span style=color:#f92672>(</span>socket_<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException iox<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        close<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TTransportException<span style=color:#f92672>(</span>TTransportException<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_OPEN</span><span style=color:#f92672>,</span> iox<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=2-执行请求>2. 执行请求</h3><p>使用 <code>TProtocol</code> 构建 <code>TServiceClient</code>，用于发送同步请求</p><ul><li>io.github.helloworlde.thrift.HelloService.Client#sayHello</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span>HelloMessage request<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    send_sayHello<span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> recv_sayHello<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=发送请求>发送请求</h4><ul><li>io.github.helloworlde.thrift.HelloService.Client#send_sayHello</li></ul><p>其中的 <code>sayHello_args</code> 用于读写结构体，将消息内容转换为相应格式的字节</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>send_sayHello</span><span style=color:#f92672>(</span>HelloMessage request<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sayHello_args args <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_args<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    args<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequest</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    sendBase<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sayHello&#34;</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase)</li></ul><p>这里设置了消息类型是调用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendBase</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> TBase<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sendBase<span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> args<span style=color:#f92672>,</span> TMessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>CALL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase, byte)</li></ul><p>在写入请求，写入请求头，写入消息体，然后写入结尾符，将请求发送出去</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendBase</span><span style=color:#f92672>(</span>String methodName<span style=color:#f92672>,</span> TBase<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> args<span style=color:#f92672>,</span> <span style=color:#66d9ef>byte</span> type<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构建请求，写入头信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    oprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>writeMessageBegin</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TMessage<span style=color:#f92672>(</span>methodName<span style=color:#f92672>,</span> type<span style=color:#f92672>,</span> <span style=color:#f92672>++</span>seqid_<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 写入协议对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    args<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>oprot_<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 写入结尾信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    oprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>writeMessageEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空缓冲，写入
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    oprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>getTransport</span><span style=color:#f92672>().</span><span style=color:#a6e22e>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#writeMessageBegin</li></ul><p>会将版本、调用类型、方法名、请求 ID 写入到请求头</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeMessageBegin</span><span style=color:#f92672>(</span>TMessage message<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>strictWrite_<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 写入版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> version <span style=color:#f92672>=</span> VERSION_1 <span style=color:#f92672>|</span> message<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        writeI32<span style=color:#f92672>(</span>version<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 被调用方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        writeString<span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 请求序号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        writeI32<span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>seqid</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        writeString<span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        writeByte<span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        writeI32<span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>seqid</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.sayHello_args.sayHello_argsStandardScheme#write</li></ul><p>写入请求内容，会将结构体的相关描述信息写入到请求中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TProtocol</span> oprot<span style=color:#f92672>,</span> sayHello_args struct<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  struct<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  oprot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeStructBegin</span><span style=color:#f92672>(</span>STRUCT_DESC<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>struct<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    oprot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeFieldBegin</span><span style=color:#f92672>(</span>REQUEST_FIELD_DESC<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    struct<span style=color:#f92672>.</span><span style=color:#a6e22e>request</span><span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>oprot<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    oprot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeFieldEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  oprot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeFieldStop</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  oprot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeStructEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=接收响应>接收响应</h4><ul><li>io.github.helloworlde.thrift.HelloService.Client#recv_sayHello</li></ul><p>在处理请求时先构建了 <code>sayHello_result</code>对象，用于解析响应的描述</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>recv_sayHello</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  sayHello_result result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_result<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  receiveBase<span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;sayHello&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result<span style=color:#f92672>.</span><span style=color:#a6e22e>isSetSuccess</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TApplicationException</span><span style=color:#f92672>(</span>org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TApplicationException</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MISSING_RESULT</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;sayHello failed: unknown result&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#receiveBase</li></ul><p>读取响应内容，解析为对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receiveBase</span><span style=color:#f92672>(</span>TBase<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> result<span style=color:#f92672>,</span> String methodName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TMessage msg <span style=color:#f92672>=</span> iprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>readMessageBegin</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是异常，则读取异常并抛出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> TMessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>EXCEPTION</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        TApplicationException x <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TApplicationException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        x<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>iprot_<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        iprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>readMessageEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> x<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果请求序号不匹配，则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>seqid</span> <span style=color:#f92672>!=</span> seqid_<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TApplicationException<span style=color:#f92672>(</span>TApplicationException<span style=color:#f92672>.</span><span style=color:#a6e22e>BAD_SEQUENCE_ID</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s failed: out of sequence response: expected %d but got %d&#34;</span><span style=color:#f92672>,</span> methodName<span style=color:#f92672>,</span> seqid_<span style=color:#f92672>,</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>seqid</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取响应内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>iprot_<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    iprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>readMessageEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#readMessageBegin</li></ul><p>读取并校验版本，获取方法名称、消息类型、请求 ID</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> TMessage <span style=color:#a6e22e>readMessageBegin</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> size <span style=color:#f92672>=</span> readI32<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> version <span style=color:#f92672>=</span> size <span style=color:#f92672>&amp;</span> VERSION_MASK<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>version <span style=color:#f92672>!=</span> VERSION_1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TProtocolException<span style=color:#f92672>(</span>TProtocolException<span style=color:#f92672>.</span><span style=color:#a6e22e>BAD_VERSION</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Bad version in readMessageBegin&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TMessage<span style=color:#f92672>(</span>readString<span style=color:#f92672>(),</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x000000ff</span><span style=color:#f92672>),</span> readI32<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>strictRead_<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TProtocolException<span style=color:#f92672>(</span>TProtocolException<span style=color:#f92672>.</span><span style=color:#a6e22e>BAD_VERSION</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Missing version in readMessageBegin, old client?&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TMessage<span style=color:#f92672>(</span>readStringBody<span style=color:#f92672>(</span>size<span style=color:#f92672>),</span> readByte<span style=color:#f92672>(),</span> readI32<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.sayHello_result.sayHello_resultStandardScheme#read</li></ul><p>读取响应内容，解析为相应的对象，然后赋值给 result 对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TProtocol</span> iprot<span style=color:#f92672>,</span> sayHello_result struct<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TField</span> schemeField<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  iprot<span style=color:#f92672>.</span><span style=color:#a6e22e>readStructBegin</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    schemeField <span style=color:#f92672>=</span> iprot<span style=color:#f92672>.</span><span style=color:#a6e22e>readFieldBegin</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>schemeField<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TType</span><span style=color:#f92672>.</span><span style=color:#a6e22e>STOP</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>schemeField<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> <span style=color:#75715e>// SUCCESS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>schemeField<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TType</span><span style=color:#f92672>.</span><span style=color:#a6e22e>STRUCT</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          struct<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloResponse<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          struct<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>iprot<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>          struct<span style=color:#f92672>.</span><span style=color:#a6e22e>setSuccessIsSet</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TProtocolUtil</span><span style=color:#f92672>.</span><span style=color:#a6e22e>skip</span><span style=color:#f92672>(</span>iprot<span style=color:#f92672>,</span> schemeField<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TProtocolUtil</span><span style=color:#f92672>.</span><span style=color:#a6e22e>skip</span><span style=color:#f92672>(</span>iprot<span style=color:#f92672>,</span> schemeField<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    iprot<span style=color:#f92672>.</span><span style=color:#a6e22e>readFieldEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  iprot<span style=color:#f92672>.</span><span style=color:#a6e22e>readStructEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// check for required fields of primitive type, which can&#39;t be checked in the validate method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  struct<span style=color:#f92672>.</span><span style=color:#a6e22e>validate</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/grpc-%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%B5%81%E7%A8%8B/><span>&larr;&nbsp;&nbsp;</span><span>gRPC 服务间调用事件流程</span></a>
<a class=next href=https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><span>Thrfit 服务端请求处理流程</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>