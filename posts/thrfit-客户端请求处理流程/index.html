<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Thrfit 客户端请求处理流程</title>
<meta name=description content="使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta name=keywords content='blog,hugo,Thrift'><meta property="og:url" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="og:type" content="website"><meta property="og:title" content="Thrfit 客户端请求处理流程"><meta property="og:description" content="使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Thrfit 客户端请求处理流程"><meta name=twitter:description content="使用同步的非阻塞的服务端和客户端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Thrfit 客户端请求处理流程</h1><small role=doc-subtitle></small><p class=post-date>2021-02-02</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/thrift>Thrift</a></li></ul></div><div class=post-content><p>使用同步的非阻塞的服务端和客户端的请求处理流程</p><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#c678dd>namespace</span> <span style=color:#76a9f9>java</span> <span style=color:#c1abea>io.github.helloworlde.thrift</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>struct</span> <span style=color:#76a9f9>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#d19a66>1</span>: <span style=color:#c678dd>required</span> <span style=color:#ef8383>string</span> <span style=color:#c1abea>message</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>struct</span> <span style=color:#76a9f9>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#d19a66>1</span>: <span style=color:#c678dd>required</span> <span style=color:#ef8383>string</span> <span style=color:#c1abea>message</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>service</span> <span style=color:#76a9f9>HelloService</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HelloResponse</span> <span style=color:#00b1f7>sayHello</span><span style=color:#c7bf54>(</span><span style=color:#d19a66>1</span>: <span style=color:#c1abea>HelloMessage</span> <span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=客户端实现>客户端实现</h3><p>使用 <code>TSocket</code> 作为底层连接，协议使用 <code>TBinaryProtocol</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>TTransport</span> <span style=color:#c1abea>transport</span>  <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TSocket</span>(<span style=color:#98c379>&#34;localhost&#34;</span>, <span style=color:#c1abea>9090</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>transport</span>.<span style=color:#b3d23c>open</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>TProtocol</span> <span style=color:#c1abea>protocol</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TBinaryProtocol</span>(<span style=color:#c1abea>transport</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HelloService</span>.<span style=color:#b3d23c>Client</span> <span style=color:#c1abea>client</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloService</span>.<span style=color:#b3d23c>Client</span>(<span style=color:#c1abea>protocol</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HelloMessage</span> <span style=color:#c1abea>request</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloMessage</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>request</span>.<span style=color:#b3d23c>setMessage</span>(<span style=color:#98c379>&#34;Thrift&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HelloResponse</span> <span style=color:#c1abea>response</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>client</span>.<span style=color:#b3d23c>sayHello</span>(<span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>log</span>.<span style=color:#b3d23c>info</span>(<span style=color:#98c379>&#34;返回响应: {}&#34;</span>, <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>getMessage</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>TException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>e</span>.<span style=color:#b3d23c>printStackTrace</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><h3 id=1-建立连接>1. 建立连接</h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>transport</span>.<span style=color:#b3d23c>open</span>();
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TSocket#open</li></ul><p>初始化 Socket，建立连接</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>open</span>() <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TTransportException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>socket_</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 初始化 Socket</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>initSocket</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 建立连接</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>socket_</span>.<span style=color:#b3d23c>connect</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>InetSocketAddress</span>(<span style=color:#c1abea>host_</span>, <span style=color:#c1abea>port_</span>), <span style=color:#c1abea>connectTimeout_</span>);
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 初始化流</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>inputStream_</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>BufferedInputStream</span>(<span style=color:#c1abea>socket_</span>.<span style=color:#b3d23c>getInputStream</span>());
</span></span><span style=display:flex><span>        <span style=color:#c1abea>outputStream_</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>BufferedOutputStream</span>(<span style=color:#c1abea>socket_</span>.<span style=color:#b3d23c>getOutputStream</span>());
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>IOException</span> <span style=color:#c1abea>iox</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>close</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TTransportException</span>(<span style=color:#c1abea>TTransportException</span>.<span style=color:#b3d23c>NOT_OPEN</span>, <span style=color:#c1abea>iox</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-执行请求>2. 执行请求</h3><p>使用 <code>TProtocol</code> 构建 <code>TServiceClient</code>，用于发送同步请求</p><ul><li>io.github.helloworlde.thrift.HelloService.Client#sayHello</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c1abea>HelloResponse</span> <span style=color:#00b1f7>sayHello</span>(<span style=color:#c1abea>HelloMessage</span> <span style=color:#c1abea>request</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>send_sayHello</span>(<span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>recv_sayHello</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=发送请求>发送请求</h4><ul><li>io.github.helloworlde.thrift.HelloService.Client#send_sayHello</li></ul><p>其中的 <code>sayHello_args</code> 用于读写结构体，将消息内容转换为相应格式的字节</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>send_sayHello</span>(<span style=color:#c1abea>HelloMessage</span> <span style=color:#c1abea>request</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>sayHello_args</span> <span style=color:#c1abea>args</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>sayHello_args</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>args</span>.<span style=color:#b3d23c>setRequest</span>(<span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>sendBase</span>(<span style=color:#98c379>&#34;sayHello&#34;</span>, <span style=color:#c1abea>args</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase)</li></ul><p>这里设置了消息类型是调用</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>sendBase</span>(<span style=color:#c1abea>String</span> <span style=color:#c1abea>methodName</span>, <span style=color:#c1abea>TBase</span><span style=color:#c7bf54>&lt;?</span>, <span style=color:#c7bf54>?&gt;</span> <span style=color:#c1abea>args</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>sendBase</span>(<span style=color:#c1abea>methodName</span>, <span style=color:#c1abea>args</span>, <span style=color:#c1abea>TMessageType</span>.<span style=color:#b3d23c>CALL</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#sendBase(java.lang.String, org.apache.thrift.TBase, byte)</li></ul><p>在写入请求，写入请求头，写入消息体，然后写入结尾符，将请求发送出去</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>sendBase</span>(<span style=color:#c1abea>String</span> <span style=color:#c1abea>methodName</span>, <span style=color:#c1abea>TBase</span><span style=color:#c7bf54>&lt;?</span>, <span style=color:#c7bf54>?&gt;</span> <span style=color:#c1abea>args</span>, <span style=color:#ef8383>byte</span> <span style=color:#c1abea>type</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 构建请求，写入头信息</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot_</span>.<span style=color:#b3d23c>writeMessageBegin</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>TMessage</span>(<span style=color:#c1abea>methodName</span>, <span style=color:#c1abea>type</span>, <span style=color:#c7bf54>++</span><span style=color:#c1abea>seqid_</span>));
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 写入协议对象</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>args</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>oprot_</span>);
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 写入结尾信息</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot_</span>.<span style=color:#b3d23c>writeMessageEnd</span>();
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 清空缓冲，写入</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot_</span>.<span style=color:#b3d23c>getTransport</span>().<span style=color:#b3d23c>flush</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#writeMessageBegin</li></ul><p>会将版本、调用类型、方法名、请求 ID 写入到请求头</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>writeMessageBegin</span>(<span style=color:#c1abea>TMessage</span> <span style=color:#c1abea>message</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>strictWrite_</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 写入版本</span>
</span></span><span style=display:flex><span>        <span style=color:#ef8383>int</span> <span style=color:#c1abea>version</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>VERSION_1</span> <span style=color:#c7bf54>|</span> <span style=color:#c1abea>message</span>.<span style=color:#b3d23c>type</span>;
</span></span><span style=display:flex><span>        <span style=color:#c1abea>writeI32</span>(<span style=color:#c1abea>version</span>);
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 被调用方法</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>writeString</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>name</span>);
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 请求序号</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>writeI32</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>seqid</span>);
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>writeString</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>name</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>writeByte</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>type</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>writeI32</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>seqid</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.sayHello_args.sayHello_argsStandardScheme#write</li></ul><p>写入请求内容，会将结构体的相关描述信息写入到请求中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>write</span>(<span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TProtocol</span> <span style=color:#c1abea>oprot</span>, <span style=color:#c1abea>sayHello_args</span> <span style=color:#c1abea>struct</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>validate</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeStructBegin</span>(<span style=color:#c1abea>STRUCT_DESC</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>request</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeFieldBegin</span>(<span style=color:#c1abea>REQUEST_FIELD_DESC</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>request</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>oprot</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeFieldEnd</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeFieldStop</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeStructEnd</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=接收响应>接收响应</h4><ul><li>io.github.helloworlde.thrift.HelloService.Client#recv_sayHello</li></ul><p>在处理请求时先构建了 <code>sayHello_result</code>对象，用于解析响应的描述</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c1abea>HelloResponse</span> <span style=color:#00b1f7>recv_sayHello</span>() <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>sayHello_result</span> <span style=color:#c1abea>result</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>sayHello_result</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>receiveBase</span>(<span style=color:#c1abea>result</span>, <span style=color:#98c379>&#34;sayHello&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>result</span>.<span style=color:#b3d23c>isSetSuccess</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>result</span>.<span style=color:#b3d23c>success</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TApplicationException</span>(<span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TApplicationException</span>.<span style=color:#b3d23c>MISSING_RESULT</span>, <span style=color:#98c379>&#34;sayHello failed: unknown result&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#receiveBase</li></ul><p>读取响应内容，解析为对象</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>receiveBase</span>(<span style=color:#c1abea>TBase</span><span style=color:#c7bf54>&lt;?</span>, <span style=color:#c7bf54>?&gt;</span> <span style=color:#c1abea>result</span>, <span style=color:#c1abea>String</span> <span style=color:#c1abea>methodName</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 读取消息</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>TMessage</span> <span style=color:#c1abea>msg</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>iprot_</span>.<span style=color:#b3d23c>readMessageBegin</span>();
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果是异常，则读取异常并抛出</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>type</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>TMessageType</span>.<span style=color:#b3d23c>EXCEPTION</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TApplicationException</span> <span style=color:#c1abea>x</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TApplicationException</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>x</span>.<span style=color:#b3d23c>read</span>(<span style=color:#c1abea>iprot_</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>iprot_</span>.<span style=color:#b3d23c>readMessageEnd</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>throw</span> <span style=color:#c1abea>x</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果请求序号不匹配，则抛出异常</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>seqid</span> <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>seqid_</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TApplicationException</span>(<span style=color:#c1abea>TApplicationException</span>.<span style=color:#b3d23c>BAD_SEQUENCE_ID</span>,
</span></span><span style=display:flex><span>                <span style=color:#c1abea>String</span>.<span style=color:#b3d23c>format</span>(<span style=color:#98c379>&#34;%s failed: out of sequence response: expected %d but got %d&#34;</span>, <span style=color:#c1abea>methodName</span>, <span style=color:#c1abea>seqid_</span>, <span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>seqid</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 读取响应内容</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>result</span>.<span style=color:#b3d23c>read</span>(<span style=color:#c1abea>iprot_</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>iprot_</span>.<span style=color:#b3d23c>readMessageEnd</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#readMessageBegin</li></ul><p>读取并校验版本，获取方法名称、消息类型、请求 ID</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c1abea>TMessage</span> <span style=color:#00b1f7>readMessageBegin</span>() <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#ef8383>int</span> <span style=color:#c1abea>size</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>readI32</span>();
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>size</span> <span style=color:#c7bf54>&lt;</span> <span style=color:#c1abea>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ef8383>int</span> <span style=color:#c1abea>version</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>size</span> <span style=color:#c7bf54>&amp;</span> <span style=color:#c1abea>VERSION_MASK</span>;
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>version</span> <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>VERSION_1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TProtocolException</span>(<span style=color:#c1abea>TProtocolException</span>.<span style=color:#b3d23c>BAD_VERSION</span>, <span style=color:#98c379>&#34;Bad version in readMessageBegin&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TMessage</span>(<span style=color:#c1abea>readString</span>(), (<span style=color:#ef8383>byte</span>) (<span style=color:#c1abea>size</span> <span style=color:#c7bf54>&amp;</span> <span style=color:#c1abea>0x000000ff</span>), <span style=color:#c1abea>readI32</span>());
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>strictRead_</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TProtocolException</span>(<span style=color:#c1abea>TProtocolException</span>.<span style=color:#b3d23c>BAD_VERSION</span>, <span style=color:#98c379>&#34;Missing version in readMessageBegin, old client?&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TMessage</span>(<span style=color:#c1abea>readStringBody</span>(<span style=color:#c1abea>size</span>), <span style=color:#c1abea>readByte</span>(), <span style=color:#c1abea>readI32</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.sayHello_result.sayHello_resultStandardScheme#read</li></ul><p>读取响应内容，解析为相应的对象，然后赋值给 result 对象</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>read</span>(<span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TProtocol</span> <span style=color:#c1abea>iprot</span>, <span style=color:#c1abea>sayHello_result</span> <span style=color:#c1abea>struct</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TField</span> <span style=color:#c1abea>schemeField</span>;
</span></span><span style=display:flex><span>  <span style=color:#c1abea>iprot</span>.<span style=color:#b3d23c>readStructBegin</span>();
</span></span><span style=display:flex><span>  <span style=color:#c678dd>while</span> (<span style=color:#b756ff;font-weight:700>true</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>schemeField</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>iprot</span>.<span style=color:#b3d23c>readFieldBegin</span>();
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>schemeField</span>.<span style=color:#b3d23c>type</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TType</span>.<span style=color:#b3d23c>STOP</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c678dd>switch</span> (<span style=color:#c1abea>schemeField</span>.<span style=color:#b3d23c>id</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>case</span> <span style=color:#c1abea>0</span>: <span style=color:#8a93a5;font-style:italic>// SUCCESS</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>schemeField</span>.<span style=color:#b3d23c>type</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TType</span>.<span style=color:#b3d23c>STRUCT</span>) {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>success</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloResponse</span>();
</span></span><span style=display:flex><span>          <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>success</span>.<span style=color:#b3d23c>read</span>(<span style=color:#c1abea>iprot</span>);
</span></span><span style=display:flex><span>          <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>setSuccessIsSet</span>(<span style=color:#b756ff;font-weight:700>true</span>);
</span></span><span style=display:flex><span>        } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TProtocolUtil</span>.<span style=color:#b3d23c>skip</span>(<span style=color:#c1abea>iprot</span>, <span style=color:#c1abea>schemeField</span>.<span style=color:#b3d23c>type</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#c678dd>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#c678dd>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TProtocolUtil</span>.<span style=color:#b3d23c>skip</span>(<span style=color:#c1abea>iprot</span>, <span style=color:#c1abea>schemeField</span>.<span style=color:#b3d23c>type</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c1abea>iprot</span>.<span style=color:#b3d23c>readFieldEnd</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c1abea>iprot</span>.<span style=color:#b3d23c>readStructEnd</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// check for required fields of primitive type, which can&#39;t be checked in the validate method</span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>validate</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>