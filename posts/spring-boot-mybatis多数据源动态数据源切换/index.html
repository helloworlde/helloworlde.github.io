<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Boot MyBatis Druid 多数据源、动态数据源切换</title>
<meta charset=utf-8><meta name=description content="Ladder@Spring Boot 和 MyBatis 实现多数据源、动态数据源切换 项目地址：https://github.com/helloworlde/SpringBoot-DynamicDataSource 本项目使用 Spring Boot 和 MyBatis 实现多数据源，动态数据源的切换；有多种不同的实现方式，在学习的过程中发现没有文章将这些方式和常见的问题集中处理，所以将常用的方式和常见的问题都写在了在本项目的不同分支上：
master: 使用了多数据源的 RESTful API 接口，使用 Druid 实现了 DAO 层数据源动态切换和只读数据源负载均衡 dev: 最简单的切面和注解方式实现的动态数据源切换 druid: 通过切面和注解方式实现的使用 Druid 连接池的动态数据源切换 aspect_dao: 通过切面实现的 DAO 层的动态数据源切换 roundrobin: 通过切面使用轮询方式实现的只读数据源负载均衡 以上分支都是基于 dev 分支修改或扩充而来，基本涵盖了常用的多数据源动态切换的方式，基本的原理都一样，都是通过切面根据不同的条件在执行数据库操作前切换数据源
在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 Issues 里面 该项目使用了一个可写数据源和多个只读数据源，为了减少数据库压力，使用轮循的方式选择只读数据源；考虑到在一个 Service 中同时会有读和写的操作，所以本应用使用 AOP 切面通过 DAO 层的方法名切换只读数据源；但这种方式要求数据源主从一致，并且应当避免在同一个 Service 方法中写入后立即查询，如果必须在执行写入操作后立即读取，应当在 Service 方法上添加 @Transactional 注解以保证使用主数据源
需要注意的是，使用 DAO 层切面后不应该在 Service 类层面上加 @Transactional 注解，而应该添加在方法上，这也是 Spring 推荐的做法
动态切换数据源依赖 configuration 包下的4个类来实现，分别是：
DataSourceRoutingDataSource.java DataSourceConfigurer.java DynamicDataSourceContextHolder.java DynamicDataSourceAspect.java 添加依赖 dependencies { compile('org."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-boot-mybatis%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="Spring Boot MyBatis Druid 多数据源、动态数据源切换"><meta property="og:description" content="Spring Boot 和 MyBatis 实现多数据源、动态数据源切换 项目地址：https://github.com/helloworlde/SpringBoot-DynamicDataSource 本项目使用 Spring Boot 和 MyBatis 实现多数据源，动态数据源的切换；有多种不同的实现方式，在学习的过程中发现没有文章将这些方式和常见的问题集中处理，所以将常用的方式和常见的问题都写在了在本项目的不同分支上：
master: 使用了多数据源的 RESTful API 接口，使用 Druid 实现了 DAO 层数据源动态切换和只读数据源负载均衡 dev: 最简单的切面和注解方式实现的动态数据源切换 druid: 通过切面和注解方式实现的使用 Druid 连接池的动态数据源切换 aspect_dao: 通过切面实现的 DAO 层的动态数据源切换 roundrobin: 通过切面使用轮询方式实现的只读数据源负载均衡 以上分支都是基于 dev 分支修改或扩充而来，基本涵盖了常用的多数据源动态切换的方式，基本的原理都一样，都是通过切面根据不同的条件在执行数据库操作前切换数据源
在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 Issues 里面 该项目使用了一个可写数据源和多个只读数据源，为了减少数据库压力，使用轮循的方式选择只读数据源；考虑到在一个 Service 中同时会有读和写的操作，所以本应用使用 AOP 切面通过 DAO 层的方法名切换只读数据源；但这种方式要求数据源主从一致，并且应当避免在同一个 Service 方法中写入后立即查询，如果必须在执行写入操作后立即读取，应当在 Service 方法上添加 @Transactional 注解以保证使用主数据源
需要注意的是，使用 DAO 层切面后不应该在 Service 类层面上加 @Transactional 注解，而应该添加在方法上，这也是 Spring 推荐的做法
动态切换数据源依赖 configuration 包下的4个类来实现，分别是：
DataSourceRoutingDataSource.java DataSourceConfigurer.java DynamicDataSourceContextHolder.java DynamicDataSourceAspect.java 添加依赖 dependencies { compile('org."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-boot-mybatis%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-12-31T23:39:24+00:00"><meta property="article:modified_time" content="2017-12-31T23:39:24+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Boot MyBatis Druid 多数据源、动态数据源切换"><meta name=twitter:description content="Spring Boot 和 MyBatis 实现多数据源、动态数据源切换 项目地址：https://github.com/helloworlde/SpringBoot-DynamicDataSource 本项目使用 Spring Boot 和 MyBatis 实现多数据源，动态数据源的切换；有多种不同的实现方式，在学习的过程中发现没有文章将这些方式和常见的问题集中处理，所以将常用的方式和常见的问题都写在了在本项目的不同分支上：
master: 使用了多数据源的 RESTful API 接口，使用 Druid 实现了 DAO 层数据源动态切换和只读数据源负载均衡 dev: 最简单的切面和注解方式实现的动态数据源切换 druid: 通过切面和注解方式实现的使用 Druid 连接池的动态数据源切换 aspect_dao: 通过切面实现的 DAO 层的动态数据源切换 roundrobin: 通过切面使用轮询方式实现的只读数据源负载均衡 以上分支都是基于 dev 分支修改或扩充而来，基本涵盖了常用的多数据源动态切换的方式，基本的原理都一样，都是通过切面根据不同的条件在执行数据库操作前切换数据源
在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 Issues 里面 该项目使用了一个可写数据源和多个只读数据源，为了减少数据库压力，使用轮循的方式选择只读数据源；考虑到在一个 Service 中同时会有读和写的操作，所以本应用使用 AOP 切面通过 DAO 层的方法名切换只读数据源；但这种方式要求数据源主从一致，并且应当避免在同一个 Service 方法中写入后立即查询，如果必须在执行写入操作后立即读取，应当在 Service 方法上添加 @Transactional 注解以保证使用主数据源
需要注意的是，使用 DAO 层切面后不应该在 Service 类层面上加 @Transactional 注解，而应该添加在方法上，这也是 Spring 推荐的做法
动态切换数据源依赖 configuration 包下的4个类来实现，分别是：
DataSourceRoutingDataSource.java DataSourceConfigurer.java DynamicDataSourceContextHolder.java DynamicDataSourceAspect.java 添加依赖 dependencies { compile('org."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Spring Boot MyBatis Druid 多数据源、动态数据源切换","item":"https://blog.hellowood.dev/posts/spring-boot-mybatis%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Boot MyBatis Druid 多数据源、动态数据源切换","name":"Spring Boot MyBatis Druid 多数据源、动态数据源切换","description":"Spring Boot 和 MyBatis 实现多数据源、动态数据源切换 项目地址：https://github.com/helloworlde/SpringBoot-DynamicDataSource 本项目使用 Spring Boot 和 MyBatis 实现多数据源，动态数据源的切换；有多种不同的实现方式，在学习的过程中发现没有文章将这些方式和常见的问题集中处理，所以将常用的方式和常见的问题都写在了在本项目的不同分支上：\nmaster: 使用了多数据源的 RESTful API 接口，使用 Druid 实现了 DAO 层数据源动态切换和只读数据源负载均衡 dev: 最简单的切面和注解方式实现的动态数据源切换 druid: 通过切面和注解方式实现的使用 Druid 连接池的动态数据源切换 aspect_dao: 通过切面实现的 DAO 层的动态数据源切换 roundrobin: 通过切面使用轮询方式实现的只读数据源负载均衡 以上分支都是基于 dev 分支修改或扩充而来，基本涵盖了常用的多数据源动态切换的方式，基本的原理都一样，都是通过切面根据不同的条件在执行数据库操作前切换数据源\n在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 Issues 里面 该项目使用了一个可写数据源和多个只读数据源，为了减少数据库压力，使用轮循的方式选择只读数据源；考虑到在一个 Service 中同时会有读和写的操作，所以本应用使用 AOP 切面通过 DAO 层的方法名切换只读数据源；但这种方式要求数据源主从一致，并且应当避免在同一个 Service 方法中写入后立即查询，如果必须在执行写入操作后立即读取，应当在 Service 方法上添加 @Transactional 注解以保证使用主数据源\n需要注意的是，使用 DAO 层切面后不应该在 Service 类层面上加 @Transactional 注解，而应该添加在方法上，这也是 Spring 推荐的做法\n动态切换数据源依赖 configuration 包下的4个类来实现，分别是：\nDataSourceRoutingDataSource.java DataSourceConfigurer.java DynamicDataSourceContextHolder.java DynamicDataSourceAspect.java 添加依赖 dependencies { compile(\u0026#39;org.","keywords":["Java","SpringBoot","MyBatis","DynamicDataSource","MultipleDataSource","Druid"],"articleBody":"Spring Boot 和 MyBatis 实现多数据源、动态数据源切换 项目地址：https://github.com/helloworlde/SpringBoot-DynamicDataSource 本项目使用 Spring Boot 和 MyBatis 实现多数据源，动态数据源的切换；有多种不同的实现方式，在学习的过程中发现没有文章将这些方式和常见的问题集中处理，所以将常用的方式和常见的问题都写在了在本项目的不同分支上：\nmaster: 使用了多数据源的 RESTful API 接口，使用 Druid 实现了 DAO 层数据源动态切换和只读数据源负载均衡 dev: 最简单的切面和注解方式实现的动态数据源切换 druid: 通过切面和注解方式实现的使用 Druid 连接池的动态数据源切换 aspect_dao: 通过切面实现的 DAO 层的动态数据源切换 roundrobin: 通过切面使用轮询方式实现的只读数据源负载均衡 以上分支都是基于 dev 分支修改或扩充而来，基本涵盖了常用的多数据源动态切换的方式，基本的原理都一样，都是通过切面根据不同的条件在执行数据库操作前切换数据源\n在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 Issues 里面 该项目使用了一个可写数据源和多个只读数据源，为了减少数据库压力，使用轮循的方式选择只读数据源；考虑到在一个 Service 中同时会有读和写的操作，所以本应用使用 AOP 切面通过 DAO 层的方法名切换只读数据源；但这种方式要求数据源主从一致，并且应当避免在同一个 Service 方法中写入后立即查询，如果必须在执行写入操作后立即读取，应当在 Service 方法上添加 @Transactional 注解以保证使用主数据源\n需要注意的是，使用 DAO 层切面后不应该在 Service 类层面上加 @Transactional 注解，而应该添加在方法上，这也是 Spring 推荐的做法\n动态切换数据源依赖 configuration 包下的4个类来实现，分别是：\nDataSourceRoutingDataSource.java DataSourceConfigurer.java DynamicDataSourceContextHolder.java DynamicDataSourceAspect.java 添加依赖 dependencies { compile('org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.1') compile('org.springframework.boot:spring-boot-starter-web') compile('org.springframework.boot:spring-boot-starter-aop') compile('com.alibaba:druid-spring-boot-starter:1.1.6') runtime('mysql:mysql-connector-java') testCompile('org.springframework.boot:spring-boot-starter-test') } 创建数据库及表 分别创建数据库product_master, product_slave_alpha, product_slave_beta, product_slave_gamma 在以上数据库中分别创建表 product，并插入不同数据 DROP DATABASE IF EXISTS product_master; CREATE DATABASE product_master; CREATE TABLE product_master.product( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(50) NOT NULL, price DOUBLE(10,2) NOT NULL DEFAULT 0); INSERT INTO product_master.product (name, price) VALUES('master', '1'); DROP DATABASE IF EXISTS product_slave_alpha; CREATE DATABASE product_slave_alpha; CREATE TABLE product_slave_alpha.product( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(50) NOT NULL, price DOUBLE(10,2) NOT NULL DEFAULT 0); INSERT INTO product_slave_alpha.product (name, price) VALUES('slaveAlpha', '1'); DROP DATABASE IF EXISTS product_slave_beta; CREATE DATABASE product_slave_beta; CREATE TABLE product_slave_beta.product( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(50) NOT NULL, price DOUBLE(10,2) NOT NULL DEFAULT 0); INSERT INTO product_slave_beta.product (name, price) VALUES('slaveBeta', '1'); DROP DATABASE IF EXISTS product_slave_gamma; CREATE DATABASE product_slave_gamma; CREATE TABLE product_slave_gamma.product( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(50) NOT NULL, price DOUBLE(10,2) NOT NULL DEFAULT 0); INSERT INTO product_slave_gamma.product (name, price) VALUES('slaveGamma', '1'); 配置数据源 application.properties # Master datasource config spring.datasource.druid.master.name=master spring.datasource.druid.master.driver-class-name=com.mysql.jdbc.Driver spring.datasource.druid.master.url=jdbc:mysql://localhost/product_master?useSSL=false spring.datasource.druid.master.port=3306 spring.datasource.druid.master.username=root spring.datasource.druid.master.password=123456 # SlaveAlpha datasource config spring.datasource.druid.slave-alpha.name=SlaveAlpha spring.datasource.druid.slave-alpha.driver-class-name=com.mysql.jdbc.Driver spring.datasource.druid.slave-alpha.url=jdbc:mysql://localhost/product_slave_alpha?useSSL=false spring.datasource.druid.slave-alpha.port=3306 spring.datasource.druid.slave-alpha.username=root spring.datasource.druid.slave-alpha.password=123456 # SlaveBeta datasource config spring.datasource.druid.slave-beta.name=SlaveBeta spring.datasource.druid.slave-beta.driver-class-name=com.mysql.jdbc.Driver spring.datasource.druid.slave-beta.url=jdbc:mysql://localhost/product_slave_beta?useSSL=false spring.datasource.druid.slave-beta.port=3306 spring.datasource.druid.slave-beta.username=root spring.datasource.druid.slave-beta.password=123456 # SlaveGamma datasource config spring.datasource.druid.slave-gamma.name=SlaveGamma spring.datasource.druid.slave-gamma.driver-class-name=com.mysql.jdbc.Driver spring.datasource.druid.slave-gamma.url=jdbc:mysql://localhost/product_slave_gamma?useSSL=false spring.datasource.druid.slave-gamma.port=3306 spring.datasource.druid.slave-gamma.username=root spring.datasource.druid.slave-gamma.password=123456 # Druid dataSource config spring.datasource.type=com.alibaba.druid.pool.DruidDataSource spring.datasource.druid.initial-size=5 spring.datasource.druid.max-active=20 spring.datasource.druid.min-idle=5 spring.datasource.druid.max-wait=60000 spring.datasource.druid.pool-prepared-statements=false spring.datasource.druid.validation-query=SELECT 1 spring.datasource.druid.validation-query-timeout=30000 spring.datasource.druid.test-on-borrow=false spring.datasource.druid.test-on-return=false spring.datasource.druid.test-while-idle=true #spring.datasource.druid.time-between-eviction-runs-millis= #spring.datasource.druid.min-evictable-idle-time-millis= #spring.datasource.druid.max-evictable-idle-time-millis=10000 # Druid stat filter config spring.datasource.druid.filters=stat,wall,log4j spring.datasource.druid.web-stat-filter.enabled=true spring.datasource.druid.web-stat-filter.url-pattern=/* spring.datasource.druid.web-stat-filter.exclusions=*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/* spring.datasource.druid.web-stat-filter.session-stat-enable=true spring.datasource.druid.web-stat-filter.session-stat-max-count=10 spring.datasource.druid.web-stat-filter.principal-session-name=user #spring.datasource.druid.web-stat-filter.principal-cookie-name= spring.datasource.druid.web-stat-filter.profile-enable=true spring.datasource.druid.filter.stat.db-type=mysql spring.datasource.druid.filter.stat.log-slow-sql=true spring.datasource.druid.filter.stat.slow-sql-millis=1000 spring.datasource.druid.filter.stat.merge-sql=true spring.datasource.druid.filter.wall.enabled=true spring.datasource.druid.filter.wall.config.delete-allow=true spring.datasource.druid.filter.wall.config.drop-table-allow=false spring.datasource.druid.filter.slf4j.enabled=true # Druid manage page config spring.datasource.druid.stat-view-servlet.enabled=true spring.datasource.druid.stat-view-servlet.url-pattern=/druid/* spring.datasource.druid.stat-view-servlet.reset-enable=true spring.datasource.druid.stat-view-servlet.login-username=admin spring.datasource.druid.stat-view-servlet.login-password=admin #spring.datasource.druid.stat-view-servlet.allow= #spring.datasource.druid.stat-view-servlet.deny= spring.datasource.druid.use-global-data-source-stat=true # Druid AOP config spring.datasource.druid.aop-patterns=cn.com.hellowood.dynamicdatasource.service.* spring.aop.proxy-target-class=true # MyBatis config mybatis.type-aliases-package=cn.com.hellowood.dynamicdatasource.mapper mybatis.mapper-locations=mappers/**Mapper.xml server.port=9999 配置数据源 DataSourceKey.java package cn.com.hellowood.dynamicdatasource.common; public enum DataSourceKey { master, slaveAlpha, slaveBeta, slaveGamma } DataSourceRoutingDataSource.java 该类继承自 AbstractRoutingDataSource 类，在访问数据库时会调用该类的 determineCurrentLookupKey() 方法获取数据库实例的 key\npackage cn.com.hellowood.dynamicdatasource.configuration; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource; public class DynamicRoutingDataSource extends AbstractRoutingDataSource { private final Logger logger = LoggerFactory.getLogger(getClass()); @Override protected Object determineCurrentLookupKey() { logger.info(\"Current DataSource is [{}]\", DynamicDataSourceContextHolder.getDataSourceKey()); return DynamicDataSourceContextHolder.getDataSourceKey(); } } DataSourceConfigurer.java 数据源配置类，在该类中生成多个数据源实例并将其注入到 ApplicationContext 中\npackage cn.com.hellowood.dynamicdatasource.configuration; import org.mybatis.spring.SqlSessionFactoryBean; import org.springframework.boot.autoconfigure.jdbc.DataSourceBuilder; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.Primary; import javax.sql.DataSource; import java.util.HashMap; import java.util.Map; @Configuration public class DataSourceConfigurer { /** * master DataSource * @Primary 注解用于标识默认使用的 DataSource Bean，因为有5个 DataSource Bean，该注解可用于 master * 或 slave DataSource Bean, 但不能用于 dynamicDataSource Bean, 否则会产生循环调用 * * @ConfigurationProperties 注解用于从 application.properties 文件中读取配置，为 Bean 设置属性 * @return data source */ @Bean(\"master\") @Primary @ConfigurationProperties(prefix = \"spring.datasource.druid.master\") public DataSource master() { return DruidDataSourceBuilder.create().build(); } /** * Slave alpha data source. * * @return the data source */ @Bean(\"slaveAlpha\") @ConfigurationProperties(prefix = \"spring.datasource.druid.slave-alpha\") public DataSource slaveAlpha() { return DruidDataSourceBuilder.create().build(); } /** * Slave beta data source. * * @return the data source */ @Bean(\"slaveBeta\") @ConfigurationProperties(prefix = \"spring.datasource.druid.slave-beta\") public DataSource slaveBeta() { return DruidDataSourceBuilder.create().build(); } /** * Slave gamma data source. * * @return the data source */ @Bean(\"slaveGamma\") @ConfigurationProperties(prefix = \"spring.datasource.druid.slave-gamma\") public DataSource slaveGamma() { return DruidDataSourceBuilder.create().build(); } /** * Dynamic data source. * * @return the data source */ @Bean(\"dynamicDataSource\") public DataSource dynamicDataSource() { DynamicRoutingDataSource dynamicRoutingDataSource = new DynamicRoutingDataSource(); Map\u003cObject, Object\u003e dataSourceMap = new HashMap\u003c\u003e(4); dataSourceMap.put(DataSourceKey.master.name(), master()); dataSourceMap.put(DataSourceKey.slaveAlpha.name(), slaveAlpha()); dataSourceMap.put(DataSourceKey.slaveBeta.name(), slaveBeta()); dataSourceMap.put(DataSourceKey.slaveGamma.name(), slaveGamma()); // 将 master 数据源作为默认指定的数据源 dynamicRoutingDataSource.setDefaultTargetDataSource(master()); // 将 master 和 slave 数据源作为指定的数据源 dynamicRoutingDataSource.setTargetDataSources(dataSourceMap); // 将数据源的 key 放到数据源上下文的 key 集合中，用于切换时判断数据源是否有效 DynamicDataSourceContextHolder.dataSourceKeys.addAll(dataSourceMap.keySet()); // 将 Slave 数据源的 key 放在集合中，用于轮循 DynamicDataSourceContextHolder.slaveDataSourceKeys.addAll(dataSourceMap.keySet()); DynamicDataSourceContextHolder.slaveDataSourceKeys.remove(DataSourceKey.master.name()); return dynamicRoutingDataSource; } /** * 配置 SqlSessionFactoryBean * @ConfigurationProperties 在这里是为了将 MyBatis 的 mapper 位置和持久层接口的别名设置到 * Bean 的属性中，如果没有使用 *.xml 则可以不用该配置，否则将会产生 invalid bond statement 异常 * * @return the sql session factory bean */ @Bean @ConfigurationProperties(prefix = \"mybatis\") public SqlSessionFactoryBean sqlSessionFactoryBean() { SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); // 配置数据源，此处配置为关键配置，如果没有将 dynamicDataSource 作为数据源则不能实现切换 sqlSessionFactoryBean.setDataSource(dynamicDataSource()); return sqlSessionFactoryBean; } /** * 注入 DataSourceTransactionManager 用于事务管理 */ @Bean public PlatformTransactionManager transactionManager() { return new DataSourceTransactionManager(dynamicDataSource()); } } DynamicDataSourceContextHolder.java 该类为数据源上下文配置，用于切换数据源\npackage cn.com.hellowood.dynamicdatasource.configuration; import cn.com.hellowood.dynamicdatasource.common.DataSourceKey; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.util.ArrayList; import java.util.List; import java.util.concurrent.locks.Lock; import java.util.concurrent.locks.ReentrantLock; public class DynamicDataSourceContextHolder { private static final Logger logger = LoggerFactory.getLogger(DynamicDataSourceContextHolder.class); /** * 用于在切换数据源时保证不会被其他线程修改 */ private static Lock lock = new ReentrantLock(); /** * 用于轮循的计数器 */ private static int counter = 0; /** * Maintain variable for every thread, to avoid effect other thread */ private static final ThreadLocal\u003cObject\u003e CONTEXT_HOLDER = ThreadLocal.withInitial(DataSourceKey.master); /** * All DataSource List */ public static List\u003cObject\u003e dataSourceKeys = new ArrayList\u003c\u003e(); /** * The constant slaveDataSourceKeys. */ public static List\u003cObject\u003e slaveDataSourceKeys = new ArrayList\u003c\u003e(); /** * To switch DataSource * * @param key the key */ public static void setDataSourceKey(String key) { CONTEXT_HOLDER.set(key); } /** * Use master data source. */ public static void useMasterDataSource() { CONTEXT_HOLDER.set(DataSourceKey.master); } /** * 当使用只读数据源时通过轮循方式选择要使用的数据源 */ public static void useSlaveDataSource() { lock.lock(); try { int datasourceKeyIndex = counter % slaveDataSourceKeys.size(); CONTEXT_HOLDER.set(String.valueOf(slaveDataSourceKeys.get(datasourceKeyIndex))); counter++; } catch (Exception e) { logger.error(\"Switch slave datasource failed, error message is {}\", e.getMessage()); useMasterDataSource(); e.printStackTrace(); } finally { lock.unlock(); } } /** * Get current DataSource * * @return data source key */ public static String getDataSourceKey() { return CONTEXT_HOLDER.get(); } /** * To set DataSource as default */ public static void clearDataSourceKey() { CONTEXT_HOLDER.remove(); } /** * Check if give DataSource is in current DataSource list * * @param key the key * @return boolean boolean */ public static boolean containDataSourceKey(String key) { return dataSourceKeys.contains(key); } } DynamicDataSourceAspect.java 动态数据源切换的切面，切 DAO 层，通过 DAO 层方法名判断使用哪个数据源，实现数据源切换 关于切面的 Order 可以可以不设，因为 @Transactional 是最低的，取决于其他切面的设置，并且在 org.springframework.core.annotation.AnnotationAwareOrderComparator 会重新排序\npackage cn.com.hellowood.dynamicdatasource.configuration; import org.aspectj.lang.JoinPoint; import org.aspectj.lang.annotation.After; import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Before; import org.aspectj.lang.annotation.Pointcut; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.stereotype.Component; @Aspect @Component public class DynamicDataSourceAspect { private static final Logger logger = LoggerFactory.getLogger(DynamicDataSourceAspect.class); private final String[] QUERY_PREFIX = {\"select\"}; @Pointcut(\"execution( * cn.com.hellowood.dynamicdatasource.mapper.*.*(..))\") public void daoAspect() { } @Before(\"daoAspect()\") public void switchDataSource(JoinPoint point) { Boolean isQueryMethod = isQueryMethod(point.getSignature().getName()); if (isQueryMethod) { DynamicDataSourceContextHolder.useSlaveDataSource(); logger.info(\"Switch DataSource to [{}] in Method [{}]\", DynamicDataSourceContextHolder.getDataSourceKey(), point.getSignature()); } } @After(\"daoAspect())\") public void restoreDataSource(JoinPoint point) { DynamicDataSourceContextHolder.clearDataSourceKey(); logger.info(\"Restore DataSource to [{}] in Method [{}]\", DynamicDataSourceContextHolder.getDataSourceKey(), point.getSignature()); } private Boolean isQueryMethod(String methodName) { for (String prefix : QUERY_PREFIX) { if (methodName.startsWith(prefix)) { return true; } } return false; } } 配置 Product REST API 接口 ProductController.java package cn.com.hellowood.dynamicdatasource.controller; import cn.com.hellowood.dynamicdatasource.common.CommonResponse; import cn.com.hellowood.dynamicdatasource.common.ResponseUtil; import cn.com.hellowood.dynamicdatasource.modal.Product; import cn.com.hellowood.dynamicdatasource.service.ProductService; import cn.com.hellowood.dynamicdatasource.utils.ServiceException; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; @RestController @RequestMapping(\"/product\") public class ProductController { @Autowired private ProductService productService; @GetMapping(\"/{id}\") public CommonResponse getProduct(@PathVariable(\"id\") Long productId) throws ServiceException { return ResponseUtil.generateResponse(productService.select(productId)); } @GetMapping public CommonResponse getAllProduct() { return ResponseUtil.generateResponse(productService.getAllProduct()); } @PutMapping(\"/{id}\") public CommonResponse updateProduct(@PathVariable(\"id\") Long productId, @RequestBody Product newProduct) throws ServiceException { return ResponseUtil.generateResponse(productService.update(productId, newProduct)); } @DeleteMapping(\"/{id}\") public CommonResponse deleteProduct(@PathVariable(\"id\") long productId) throws ServiceException { return ResponseUtil.generateResponse(productService.delete(productId)); } @PostMapping public CommonResponse addProduct(@RequestBody Product newProduct) throws ServiceException { return ResponseUtil.generateResponse(productService.add(newProduct)); } } ProductService.java package cn.com.hellowood.dynamicdatasource.service; import cn.com.hellowood.dynamicdatasource.mapper.ProductDao; import cn.com.hellowood.dynamicdatasource.modal.Product; import cn.com.hellowood.dynamicdatasource.utils.ServiceException; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.dao.DataAccessException; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional; import java.util.List; @Service public class ProductService { @Autowired private ProductDao productDao; public Product select(long productId) throws ServiceException { Product product = productDao.select(productId); if (product == null) { throw new ServiceException(\"Product:\" + productId + \" not found\"); } return product; } @Transactional(rollbackFor = DataAccessException.class) public Product update(long productId, Product newProduct) throws ServiceException { if (productDao.update(newProduct) \u003c= 0) { throw new ServiceException(\"Update product:\" + productId + \"failed\"); } return newProduct; } @Transactional(rollbackFor = DataAccessException.class) public boolean add(Product newProduct) throws ServiceException { Integer num = productDao.insert(newProduct); if (num \u003c= 0) { throw new ServiceException(\"Add product failed\"); } return true; } @Transactional(rollbackFor = DataAccessException.class) public boolean delete(long productId) throws ServiceException { Integer num = productDao.delete(productId); if (num \u003c= 0) { throw new ServiceException(\"Delete product:\" + productId + \"failed\"); } return true; } public List\u003cProduct\u003e getAllProduct() { return productDao.getAllProduct(); } } ProductDao.java package cn.com.hellowood.dynamicdatasource.mapper; import cn.com.hellowood.dynamicdatasource.modal.Product; import org.apache.ibatis.annotations.Mapper; import org.apache.ibatis.annotations.Param; import java.util.List; @Mapper public interface ProductDao { Product select(@Param(\"id\") long id); Integer update(Product product); Integer insert(Product product); Integer delete(long productId); List\u003cProduct\u003e getAllProduct(); } ProductMapper.xml 启动项目，此时访问 /product/1 会返回 product_master 数据库中 product 表中的所有数据，多次访问 /product 会分别返回 product_slave_alpha、product_slave_beta、product_slave_gamma 数据库中 product 表中的数据，同时也可以在看到切换数据源的 log，说明动态切换数据源是有效的\n注意 在该应用中因为使用了 DAO 层的切面切换数据源，所以 @Transactional 注解不能加在类上，只能用于方法；有 @Trasactional注解的方法无法切换数据源\n","wordCount":"1319","inLanguage":"en","datePublished":"2017-12-31T23:39:24Z","dateModified":"2017-12-31T23:39:24Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/spring-boot-mybatis%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Spring Boot MyBatis Druid 多数据源、动态数据源切换</h1></header><p><small>December 31, 2017&nbsp;· 1319 words&nbsp;· 7 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><ul><li><a href=#在使用的过程中基本踩遍了所有动态数据源切换的坑将常见的一些坑和解决方法写在了-issueshttpsgithubcomhelloworldespringboot-dynamicdatasourceblobmasterissuesmd-里面>在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 <a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource/blob/master/Issues.md>Issues</a> 里面</a></li></ul></li><li><a href=#添加依赖>添加依赖</a></li><li><a href=#创建数据库及表>创建数据库及表</a></li><li><a href=#配置数据源>配置数据源</a></li><li><a href=#配置数据源-1>配置数据源</a></li><li><a href=#配置-product-rest-api-接口>配置 Product REST API 接口</a></li><li><a href=#注意>注意</a></li></ul></nav></div><section class=blog-content><h1 id=spring-boot-和-mybatis-实现多数据源动态数据源切换>Spring Boot 和 MyBatis 实现多数据源、动态数据源切换</h1><ul><li>项目地址：<a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource>https://github.com/helloworlde/SpringBoot-DynamicDataSource</a></li></ul><blockquote><p>本项目使用 Spring Boot 和 MyBatis 实现多数据源，动态数据源的切换；有多种不同的实现方式，在学习的过程中发现没有文章将这些方式和常见的问题集中处理，所以将常用的方式和常见的问题都写在了在本项目的不同分支上：</p></blockquote><ul><li><a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource>master</a>: 使用了多数据源的 RESTful API 接口，使用 Druid 实现了 DAO 层数据源动态切换和只读数据源负载均衡</li><li><a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource/tree/dev>dev</a>: 最简单的切面和注解方式实现的动态数据源切换</li><li><a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource/tree/druid>druid</a>: 通过切面和注解方式实现的使用 Druid 连接池的动态数据源切换</li><li><a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource/tree/aspect_dao>aspect_dao</a>: 通过切面实现的 DAO 层的动态数据源切换</li><li><a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource/tree/roundrobin>roundrobin</a>: 通过切面使用轮询方式实现的只读数据源负载均衡</li></ul><blockquote><p>以上分支都是基于 dev 分支修改或扩充而来，基本涵盖了常用的多数据源动态切换的方式，基本的原理都一样，都是通过切面根据不同的条件在执行数据库操作前切换数据源</p></blockquote><h3 id=在使用的过程中基本踩遍了所有动态数据源切换的坑将常见的一些坑和解决方法写在了-issueshttpsgithubcomhelloworldespringboot-dynamicdatasourceblobmasterissuesmd-里面>在使用的过程中基本踩遍了所有动态数据源切换的坑，将常见的一些坑和解决方法写在了 <a href=https://github.com/helloworlde/SpringBoot-DynamicDataSource/blob/master/Issues.md>Issues</a> 里面</h3><blockquote><p>该项目使用了一个可写数据源和多个只读数据源，为了减少数据库压力，使用轮循的方式选择只读数据源；考虑到在一个 Service 中同时会有读和写的操作，所以本应用使用 AOP 切面通过 DAO 层的方法名切换只读数据源；但这种方式要求数据源主从一致，并且应当避免在同一个 Service 方法中写入后立即查询，如果必须在执行写入操作后立即读取，应当在 Service 方法上添加 <code>@Transactional</code> 注解以保证使用主数据源</p></blockquote><blockquote><p>需要注意的是，使用 DAO 层切面后不应该在 Service 类层面上加 <code>@Transactional</code> 注解，而应该添加在方法上，这也是 Spring 推荐的做法</p></blockquote><blockquote><p>动态切换数据源依赖 <code>configuration</code> 包下的4个类来实现，分别是：</p><ul><li>DataSourceRoutingDataSource.java</li><li>DataSourceConfigurer.java</li><li>DynamicDataSourceContextHolder.java</li><li>DynamicDataSourceAspect.java</li></ul></blockquote><hr><h2 id=添加依赖>添加依赖</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.1&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-aop&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;com.alibaba:druid-spring-boot-starter:1.1.6&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    runtime<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;mysql:mysql-connector-java&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    testCompile<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=创建数据库及表>创建数据库及表</h2><ul><li>分别创建数据库<code>product_master</code>, <code>product_slave_alpha</code>, <code>product_slave_beta</code>, <code>product_slave_gamma</code></li><li>在以上数据库中分别创建表 <code>product</code>，并插入不同数据</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> product_master;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> product_master;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> product_master.product(
</span></span><span style=display:flex><span>  id INT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  name VARCHAR(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  price DOUBLE(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> product_master.product (name, price) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;master&#39;</span>, <span style=color:#e6db74>&#39;1&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> product_slave_alpha;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> product_slave_alpha;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> product_slave_alpha.product(
</span></span><span style=display:flex><span>  id INT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  name VARCHAR(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  price DOUBLE(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> product_slave_alpha.product (name, price) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;slaveAlpha&#39;</span>, <span style=color:#e6db74>&#39;1&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> product_slave_beta;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> product_slave_beta;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> product_slave_beta.product(
</span></span><span style=display:flex><span>  id INT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  name VARCHAR(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  price DOUBLE(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> product_slave_beta.product (name, price) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;slaveBeta&#39;</span>, <span style=color:#e6db74>&#39;1&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> product_slave_gamma;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> product_slave_gamma;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> product_slave_gamma.product(
</span></span><span style=display:flex><span>  id INT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  name VARCHAR(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  price DOUBLE(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> product_slave_gamma.product (name, price) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;slaveGamma&#39;</span>, <span style=color:#e6db74>&#39;1&#39;</span>);
</span></span></code></pre></div><h2 id=配置数据源>配置数据源</h2><ul><li>application.properties</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># Master datasource config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.master.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>master</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.master.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.master.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://localhost/product_master?useSSL=false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.master.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>3306</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.master.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.master.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SlaveAlpha datasource config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-alpha.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>SlaveAlpha</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-alpha.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-alpha.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://localhost/product_slave_alpha?useSSL=false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-alpha.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>3306</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-alpha.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-alpha.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SlaveBeta datasource config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-beta.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>SlaveBeta</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-beta.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-beta.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://localhost/product_slave_beta?useSSL=false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-beta.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>3306</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-beta.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-beta.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SlaveGamma datasource config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-gamma.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>SlaveGamma</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-gamma.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-gamma.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://localhost/product_slave_gamma?useSSL=false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-gamma.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>3306</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-gamma.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.slave-gamma.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Druid dataSource config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.alibaba.druid.pool.DruidDataSource</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.initial-size</span><span style=color:#f92672>=</span><span style=color:#e6db74>5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.max-active</span><span style=color:#f92672>=</span><span style=color:#e6db74>20</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.min-idle</span><span style=color:#f92672>=</span><span style=color:#e6db74>5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.max-wait</span><span style=color:#f92672>=</span><span style=color:#e6db74>60000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.pool-prepared-statements</span><span style=color:#f92672>=</span><span style=color:#e6db74>false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.validation-query</span><span style=color:#f92672>=</span><span style=color:#e6db74>SELECT 1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.validation-query-timeout</span><span style=color:#f92672>=</span><span style=color:#e6db74>30000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.test-on-borrow</span><span style=color:#f92672>=</span><span style=color:#e6db74>false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.test-on-return</span><span style=color:#f92672>=</span><span style=color:#e6db74>false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.test-while-idle</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#spring.datasource.druid.time-between-eviction-runs-millis=</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#spring.datasource.druid.min-evictable-idle-time-millis=</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#spring.datasource.druid.max-evictable-idle-time-millis=10000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Druid stat filter config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filters</span><span style=color:#f92672>=</span><span style=color:#e6db74>stat,wall,log4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.enabled</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.url-pattern</span><span style=color:#f92672>=</span><span style=color:#e6db74>/*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.exclusions</span><span style=color:#f92672>=</span><span style=color:#e6db74>*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.session-stat-enable</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.session-stat-max-count</span><span style=color:#f92672>=</span><span style=color:#e6db74>10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.principal-session-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>user</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#spring.datasource.druid.web-stat-filter.principal-cookie-name=</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.web-stat-filter.profile-enable</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.stat.db-type</span><span style=color:#f92672>=</span><span style=color:#e6db74>mysql</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.stat.log-slow-sql</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.stat.slow-sql-millis</span><span style=color:#f92672>=</span><span style=color:#e6db74>1000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.stat.merge-sql</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.wall.enabled</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.wall.config.delete-allow</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.wall.config.drop-table-allow</span><span style=color:#f92672>=</span><span style=color:#e6db74>false</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.filter.slf4j.enabled</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Druid manage page config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.stat-view-servlet.enabled</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.stat-view-servlet.url-pattern</span><span style=color:#f92672>=</span><span style=color:#e6db74>/druid/*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.stat-view-servlet.reset-enable</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.stat-view-servlet.login-username</span><span style=color:#f92672>=</span><span style=color:#e6db74>admin</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.stat-view-servlet.login-password</span><span style=color:#f92672>=</span><span style=color:#e6db74>admin</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#spring.datasource.druid.stat-view-servlet.allow=</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#spring.datasource.druid.stat-view-servlet.deny=</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.use-global-data-source-stat</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Druid AOP config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.druid.aop-patterns</span><span style=color:#f92672>=</span><span style=color:#e6db74>cn.com.hellowood.dynamicdatasource.service.*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.aop.proxy-target-class</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MyBatis config</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.type-aliases-package</span><span style=color:#f92672>=</span><span style=color:#e6db74>cn.com.hellowood.dynamicdatasource.mapper</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.mapper-locations</span><span style=color:#f92672>=</span><span style=color:#e6db74>mappers/**Mapper.xml</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>9999</span>
</span></span></code></pre></div><h2 id=配置数据源-1>配置数据源</h2><ul><li>DataSourceKey.java</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.common;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> DataSourceKey {
</span></span><span style=display:flex><span>    master,
</span></span><span style=display:flex><span>    slaveAlpha,
</span></span><span style=display:flex><span>    slaveBeta,
</span></span><span style=display:flex><span>    slaveGamma
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>DataSourceRoutingDataSource.java</li></ul><blockquote><p>该类继承自 <code>AbstractRoutingDataSource</code> 类，在访问数据库时会调用该类的 <code>determineCurrentLookupKey()</code> 方法获取数据库实例的 key</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicRoutingDataSource</span> <span style=color:#66d9ef>extends</span> AbstractRoutingDataSource {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(getClass());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>determineCurrentLookupKey</span>() {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Current DataSource is [{}]&#34;</span>, DynamicDataSourceContextHolder.<span style=color:#a6e22e>getDataSourceKey</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DynamicDataSourceContextHolder.<span style=color:#a6e22e>getDataSourceKey</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>DataSourceConfigurer.java</li></ul><blockquote><p>数据源配置类，在该类中生成多个数据源实例并将其注入到 <code>ApplicationContext</code> 中</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mybatis.spring.SqlSessionFactoryBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceBuilder;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.ConfigurationProperties;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Primary;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.sql.DataSource;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.HashMap;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataSourceConfigurer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * master DataSource
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @Primary 注解用于标识默认使用的 DataSource Bean，因为有5个 DataSource Bean，该注解可用于 master
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 或 slave DataSource Bean, 但不能用于 dynamicDataSource Bean, 否则会产生循环调用 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @ConfigurationProperties 注解用于从 application.properties 文件中读取配置，为 Bean 设置属性 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return data source
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;master&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Primary</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.druid.master&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>master</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DruidDataSourceBuilder.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Slave alpha data source.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return the data source
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;slaveAlpha&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.druid.slave-alpha&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>slaveAlpha</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DruidDataSourceBuilder.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Slave beta data source.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return the data source
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;slaveBeta&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.druid.slave-beta&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>slaveBeta</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DruidDataSourceBuilder.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Slave gamma data source.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return the data source
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;slaveGamma&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.druid.slave-gamma&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>slaveGamma</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DruidDataSourceBuilder.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Dynamic data source.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return the data source
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dynamicDataSource&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>dynamicDataSource</span>() {
</span></span><span style=display:flex><span>        DynamicRoutingDataSource dynamicRoutingDataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DynamicRoutingDataSource();
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>Object, Object<span style=color:#f92672>&gt;</span> dataSourceMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>(4);
</span></span><span style=display:flex><span>        dataSourceMap.<span style=color:#a6e22e>put</span>(DataSourceKey.<span style=color:#a6e22e>master</span>.<span style=color:#a6e22e>name</span>(), master());
</span></span><span style=display:flex><span>        dataSourceMap.<span style=color:#a6e22e>put</span>(DataSourceKey.<span style=color:#a6e22e>slaveAlpha</span>.<span style=color:#a6e22e>name</span>(), slaveAlpha());
</span></span><span style=display:flex><span>        dataSourceMap.<span style=color:#a6e22e>put</span>(DataSourceKey.<span style=color:#a6e22e>slaveBeta</span>.<span style=color:#a6e22e>name</span>(), slaveBeta());
</span></span><span style=display:flex><span>        dataSourceMap.<span style=color:#a6e22e>put</span>(DataSourceKey.<span style=color:#a6e22e>slaveGamma</span>.<span style=color:#a6e22e>name</span>(), slaveGamma());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 master 数据源作为默认指定的数据源</span>
</span></span><span style=display:flex><span>        dynamicRoutingDataSource.<span style=color:#a6e22e>setDefaultTargetDataSource</span>(master());
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 master 和 slave 数据源作为指定的数据源</span>
</span></span><span style=display:flex><span>        dynamicRoutingDataSource.<span style=color:#a6e22e>setTargetDataSources</span>(dataSourceMap);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将数据源的 key 放到数据源上下文的 key 集合中，用于切换时判断数据源是否有效</span>
</span></span><span style=display:flex><span>        DynamicDataSourceContextHolder.<span style=color:#a6e22e>dataSourceKeys</span>.<span style=color:#a6e22e>addAll</span>(dataSourceMap.<span style=color:#a6e22e>keySet</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 Slave 数据源的 key 放在集合中，用于轮循</span>
</span></span><span style=display:flex><span>        DynamicDataSourceContextHolder.<span style=color:#a6e22e>slaveDataSourceKeys</span>.<span style=color:#a6e22e>addAll</span>(dataSourceMap.<span style=color:#a6e22e>keySet</span>());
</span></span><span style=display:flex><span>        DynamicDataSourceContextHolder.<span style=color:#a6e22e>slaveDataSourceKeys</span>.<span style=color:#a6e22e>remove</span>(DataSourceKey.<span style=color:#a6e22e>master</span>.<span style=color:#a6e22e>name</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dynamicRoutingDataSource;
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 配置 SqlSessionFactoryBean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @ConfigurationProperties 在这里是为了将 MyBatis 的 mapper 位置和持久层接口的别名设置到 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Bean 的属性中，如果没有使用 *.xml 则可以不用该配置，否则将会产生 invalid bond statement 异常
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return the sql session factory bean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mybatis&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SqlSessionFactoryBean <span style=color:#a6e22e>sqlSessionFactoryBean</span>() {
</span></span><span style=display:flex><span>        SqlSessionFactoryBean sqlSessionFactoryBean <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SqlSessionFactoryBean();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配置数据源，此处配置为关键配置，如果没有将 dynamicDataSource 作为数据源则不能实现切换</span>
</span></span><span style=display:flex><span>        sqlSessionFactoryBean.<span style=color:#a6e22e>setDataSource</span>(dynamicDataSource());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sqlSessionFactoryBean;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 注入 DataSourceTransactionManager 用于事务管理
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> PlatformTransactionManager <span style=color:#a6e22e>transactionManager</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceTransactionManager(dynamicDataSource());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>DynamicDataSourceContextHolder.java</li></ul><blockquote><p>该类为数据源上下文配置，用于切换数据源</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.common.DataSourceKey;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.ArrayList;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.locks.Lock;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.locks.ReentrantLock;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceContextHolder</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(DynamicDataSourceContextHolder.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 用于在切换数据源时保证不会被其他线程修改
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Lock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReentrantLock();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 用于轮循的计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> counter <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Maintain variable for every thread, to avoid effect other thread
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ThreadLocal<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> CONTEXT_HOLDER <span style=color:#f92672>=</span> ThreadLocal.<span style=color:#a6e22e>withInitial</span>(DataSourceKey.<span style=color:#a6e22e>master</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * All DataSource List
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> dataSourceKeys <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * The constant slaveDataSourceKeys.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> slaveDataSourceKeys <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * To switch DataSource
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param key the key
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDataSourceKey</span>(String key) {
</span></span><span style=display:flex><span>        CONTEXT_HOLDER.<span style=color:#a6e22e>set</span>(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Use master data source.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>useMasterDataSource</span>() {
</span></span><span style=display:flex><span>        CONTEXT_HOLDER.<span style=color:#a6e22e>set</span>(DataSourceKey.<span style=color:#a6e22e>master</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 当使用只读数据源时通过轮循方式选择要使用的数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>useSlaveDataSource</span>() {
</span></span><span style=display:flex><span>        lock.<span style=color:#a6e22e>lock</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> datasourceKeyIndex <span style=color:#f92672>=</span> counter <span style=color:#f92672>%</span> slaveDataSourceKeys.<span style=color:#a6e22e>size</span>();
</span></span><span style=display:flex><span>            CONTEXT_HOLDER.<span style=color:#a6e22e>set</span>(String.<span style=color:#a6e22e>valueOf</span>(slaveDataSourceKeys.<span style=color:#a6e22e>get</span>(datasourceKeyIndex)));
</span></span><span style=display:flex><span>            counter<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Switch slave datasource failed, error message is {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>            useMasterDataSource();
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            lock.<span style=color:#a6e22e>unlock</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Get current DataSource
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return data source key
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getDataSourceKey</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> CONTEXT_HOLDER.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * To set DataSource as default
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clearDataSourceKey</span>() {
</span></span><span style=display:flex><span>        CONTEXT_HOLDER.<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Check if give DataSource is in current DataSource list
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param key the key
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return boolean boolean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>containDataSourceKey</span>(String key) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSourceKeys.<span style=color:#a6e22e>contains</span>(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>DynamicDataSourceAspect.java</li></ul><blockquote><p>动态数据源切换的切面，切 DAO 层，通过 DAO 层方法名判断使用哪个数据源，实现数据源切换
关于切面的 Order 可以可以不设，因为 <code>@Transactional</code> 是最低的，取决于其他切面的设置，并且在 <code>org.springframework.core.annotation.AnnotationAwareOrderComparator</code> 会重新排序</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.JoinPoint;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.After;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Aspect;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Before;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.aspectj.lang.annotation.Pointcut;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicDataSourceAspect</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(DynamicDataSourceAspect.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> QUERY_PREFIX <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;select&#34;</span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span>(<span style=color:#e6db74>&#34;execution( * cn.com.hellowood.dynamicdatasource.mapper.*.*(..))&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>daoAspect</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Before</span>(<span style=color:#e6db74>&#34;daoAspect()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>switchDataSource</span>(JoinPoint point) {
</span></span><span style=display:flex><span>        Boolean isQueryMethod <span style=color:#f92672>=</span> isQueryMethod(point.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (isQueryMethod) {
</span></span><span style=display:flex><span>            DynamicDataSourceContextHolder.<span style=color:#a6e22e>useSlaveDataSource</span>();
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Switch DataSource to [{}] in Method [{}]&#34;</span>,
</span></span><span style=display:flex><span>                    DynamicDataSourceContextHolder.<span style=color:#a6e22e>getDataSourceKey</span>(), point.<span style=color:#a6e22e>getSignature</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@After</span>(<span style=color:#e6db74>&#34;daoAspect())&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>restoreDataSource</span>(JoinPoint point) {
</span></span><span style=display:flex><span>        DynamicDataSourceContextHolder.<span style=color:#a6e22e>clearDataSourceKey</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Restore DataSource to [{}] in Method [{}]&#34;</span>,
</span></span><span style=display:flex><span>                DynamicDataSourceContextHolder.<span style=color:#a6e22e>getDataSourceKey</span>(), point.<span style=color:#a6e22e>getSignature</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Boolean <span style=color:#a6e22e>isQueryMethod</span>(String methodName) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (String prefix : QUERY_PREFIX) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (methodName.<span style=color:#a6e22e>startsWith</span>(prefix)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=配置-product-rest-api-接口>配置 Product REST API 接口</h2><ul><li>ProductController.java</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.common.CommonResponse;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.common.ResponseUtil;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.modal.Product;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.service.ProductService;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.utils.ServiceException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/product&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductService productService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/{id}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CommonResponse <span style=color:#a6e22e>getProduct</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;id&#34;</span>) Long productId) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseUtil.<span style=color:#a6e22e>generateResponse</span>(productService.<span style=color:#a6e22e>select</span>(productId));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CommonResponse <span style=color:#a6e22e>getAllProduct</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseUtil.<span style=color:#a6e22e>generateResponse</span>(productService.<span style=color:#a6e22e>getAllProduct</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PutMapping</span>(<span style=color:#e6db74>&#34;/{id}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CommonResponse <span style=color:#a6e22e>updateProduct</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;id&#34;</span>) Long productId, <span style=color:#a6e22e>@RequestBody</span> Product newProduct) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseUtil.<span style=color:#a6e22e>generateResponse</span>(productService.<span style=color:#a6e22e>update</span>(productId, newProduct));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DeleteMapping</span>(<span style=color:#e6db74>&#34;/{id}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CommonResponse <span style=color:#a6e22e>deleteProduct</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;id&#34;</span>) <span style=color:#66d9ef>long</span> productId) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseUtil.<span style=color:#a6e22e>generateResponse</span>(productService.<span style=color:#a6e22e>delete</span>(productId));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CommonResponse <span style=color:#a6e22e>addProduct</span>(<span style=color:#a6e22e>@RequestBody</span> Product newProduct) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseUtil.<span style=color:#a6e22e>generateResponse</span>(productService.<span style=color:#a6e22e>add</span>(newProduct));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>ProductService.java</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.service;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.mapper.ProductDao;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.modal.Product;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.utils.ServiceException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.dao.DataAccessException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Service;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.transaction.annotation.Transactional;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductDao productDao;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>select</span>(<span style=color:#66d9ef>long</span> productId) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        Product product <span style=color:#f92672>=</span> productDao.<span style=color:#a6e22e>select</span>(productId);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (product <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;Product:&#34;</span> <span style=color:#f92672>+</span> productId <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; not found&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> product;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> DataAccessException.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>update</span>(<span style=color:#66d9ef>long</span> productId, Product newProduct) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (productDao.<span style=color:#a6e22e>update</span>(newProduct) <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;Update product:&#34;</span> <span style=color:#f92672>+</span> productId <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;failed&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> newProduct;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> DataAccessException.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>add</span>(Product newProduct) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        Integer num <span style=color:#f92672>=</span> productDao.<span style=color:#a6e22e>insert</span>(newProduct);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (num <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;Add product failed&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> DataAccessException.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>delete</span>(<span style=color:#66d9ef>long</span> productId) <span style=color:#66d9ef>throws</span> ServiceException {
</span></span><span style=display:flex><span>        Integer num <span style=color:#f92672>=</span> productDao.<span style=color:#a6e22e>delete</span>(productId);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (num <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;Delete product:&#34;</span> <span style=color:#f92672>+</span> productId <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;failed&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Product<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAllProduct</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> productDao.<span style=color:#a6e22e>getAllProduct</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>ProductDao.java</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> cn.com.hellowood.dynamicdatasource.mapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cn.com.hellowood.dynamicdatasource.modal.Product;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.ibatis.annotations.Mapper;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.ibatis.annotations.Param;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Mapper</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductDao</span> {
</span></span><span style=display:flex><span>    Product <span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>@Param</span>(<span style=color:#e6db74>&#34;id&#34;</span>) <span style=color:#66d9ef>long</span> id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Integer <span style=color:#a6e22e>update</span>(Product product);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Integer <span style=color:#a6e22e>insert</span>(Product product);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Integer <span style=color:#a6e22e>delete</span>(<span style=color:#66d9ef>long</span> productId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Product<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAllProduct</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>ProductMapper.xml</li></ul><blockquote><p>启动项目，此时访问 <code>/product/1</code> 会返回 <code>product_master</code> 数据库中 <code>product</code> 表中的所有数据，多次访问 <code>/product</code> 会分别返回 <code>product_slave_alpha</code>、<code>product_slave_beta</code>、<code>product_slave_gamma</code> 数据库中 <code>product</code> 表中的数据，同时也可以在看到切换数据源的 log，说明动态切换数据源是有效的</p></blockquote><hr><h2 id=注意>注意</h2><blockquote><p>在该应用中因为使用了 DAO 层的切面切换数据源，所以 <code>@Transactional</code> 注解不能加在类上，只能用于方法；有 <code>@Trasactional</code>注解的方法无法切换数据源</p></blockquote></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/spring-boot-mybatis-%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>Spring Boot MyBatis 动态数据源常见问题和解决方法</span></a>
<a class=next href=https://blog.hellowood.dev/posts/helloworld/><span>helloworld</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>