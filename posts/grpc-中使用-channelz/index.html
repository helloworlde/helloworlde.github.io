<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>gRPC 中使用 Channelz</title>
<meta name=description content="Copy Paste Worker"><meta name=keywords content='blog,hugo,gRPC'><meta property="og:url" content="https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E4%BD%BF%E7%94%A8-channelz/"><meta property="og:type" content="website"><meta property="og:title" content="gRPC 中使用 Channelz"><meta property="og:description" content="Copy Paste Worker"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="gRPC 中使用 Channelz"><meta name=twitter:description content="Copy Paste Worker"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E4%BD%BF%E7%94%A8-channelz/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E4%BD%BF%E7%94%A8-channelz/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E4%BD%BF%E7%94%A8-channelz/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>gRPC 中使用 Channelz</h1><small role=doc-subtitle></small><p class=post-date>2021-01-01</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/grpc>gRPC</a></li></ul></div><div class=post-content><p>gRPC 提供了 Channelz 用于对外提供服务的数据，用于调试、监控等；根据服务的角色不同，可以提供的数据有：</p><ul><li>服务端: Servers, Server, ServerSockets, Socket</li><li>客户端: TopChannels, Channel, Subchannel</li></ul><h2 id=channelz-服务定义>Channelz 服务定义</h2><p>参考 Channelz 的设计 <a href=https://github.com/grpc/proposal/blob/master/A14-channelz.md>gRPC Channelz</a> 以及服务定义 <a href=https://github.com/grpc/grpc/blob/master/src/proto/grpc/channelz/channelz.proto>channelz.proto</a>，提供了以下方法：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#c678dd>service</span> <span style=color:#c1abea>Channelz</span> {
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 返回所有的根 Channel(即应用直接创建的 Channel)
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetTopChannels</span>(<span style=color:#c1abea>GetTopChannelsRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetTopChannelsResponse</span>);
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 根据 Channel ID 返回单个的 Channel 详情，包括 Subchannel，如果没有则返回 NOT_FOUND
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetChannel</span>(<span style=color:#c1abea>GetChannelRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetChannelResponse</span>);
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 根据 Subchannel ID 返回 Subchannel 详情
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetSubchannel</span>(<span style=color:#c1abea>GetSubchannelRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetSubchannelResponse</span>);
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 返回所有存在的 Server
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetServers</span>(<span style=color:#c1abea>GetServersRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetServersResponse</span>);
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 根据 Server ID 返回 Server 详情
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetServer</span>(<span style=color:#c1abea>GetServerRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetServerResponse</span>);
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 根据 Server ID 返回 Server 所有的 Socket
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetServerSockets</span>(<span style=color:#c1abea>GetServerSocketsRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetServerSocketsResponse</span>);
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 根据 Socket ID 返回 Socket 详情
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>GetSocket</span>(<span style=color:#c1abea>GetSocketRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>GetSocketResponse</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用>使用</h2><p>相关项目参考 <a href=https://github.com/helloworlde/grpc-java-sample>github.com/helloworlde/grpc-java-sample</a></p><h3 id=添加依赖>添加依赖</h3><ul><li>build.gradle.kts</li></ul><p>Channelz 服务在 grpc-services 包中，需要添加该依赖</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#c1abea>dependencies</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>implementation</span>(<span style=color:#63c381>&#34;io.grpc:grpc-netty:</span><span style=color:#98c379>${grpcVersion}</span><span style=color:#63c381>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>implementation</span>(<span style=color:#63c381>&#34;io.grpc:grpc-protobuf:</span><span style=color:#98c379>${grpcVersion}</span><span style=color:#63c381>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>implementation</span>(<span style=color:#63c381>&#34;io.grpc:grpc-stub:</span><span style=color:#98c379>${grpcVersion}</span><span style=color:#63c381>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#c1abea>implementation</span>(<span style=color:#63c381>&#34;io.grpc:grpc-services:</span><span style=color:#98c379>${grpcVersion}</span><span style=color:#63c381>&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=server-端>Server 端</h3><p>Server 端添加 Channelz 服务非常简单，只需要将 Channelz 的服务添加到 Server 中即可</p><ul><li>Server</li></ul><p>可以通过 <code>ChannelzService.newInstance(100)</code> 直接构建 Channelz 服务实例，参数是获取数据时分页的大小</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a2cbff>@Slf4j
</span></span></span><span style=display:flex><span><span style=color:#a2cbff></span>public class ChannelzServer {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @SneakyThrows
</span></span><span style=display:flex><span>    public static void main(String[] args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 构建 Server
</span></span><span style=display:flex><span>        Server server = NettyServerBuilder.forAddress(new InetSocketAddress(9090))
</span></span><span style=display:flex><span>                                          // 添加服务
</span></span><span style=display:flex><span>                                          .addService(new HelloServiceImpl())
</span></span><span style=display:flex><span>                                          // 添加 Channelz 服务
</span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         .addService(ChannelzService.newInstance(100))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>                                          // 添加反射服务，用于 grpcurl 等工具调试
</span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         .addService(ProtoReflectionService.newInstance())
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>                                          .build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 启动 Server
</span></span><span style=display:flex><span>        server.start();
</span></span><span style=display:flex><span>        log.info(&#34;服务端启动成功&#34;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {
</span></span><span style=display:flex><span>            try {
</span></span><span style=display:flex><span>                server.awaitTermination(10, TimeUnit.SECONDS);
</span></span><span style=display:flex><span>            } catch (InterruptedException e) {
</span></span><span style=display:flex><span>                e.printStackTrace();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 保持运行
</span></span><span style=display:flex><span>        server.awaitTermination();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=client-端>Client 端</h3><p>Client 端不能直接开启，需要单独启动一个 Server，用于提供数据，与 Server 端一样，不过只提供 Channelz 的服务</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a2cbff>@Slf4j
</span></span></span><span style=display:flex><span><span style=color:#a2cbff></span>public class ChannelzClient {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @SneakyThrows
</span></span><span style=display:flex><span>    public static void main(String[] args) throws InterruptedException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 构建并启动 Channelz 服务
</span></span><span style=display:flex><span><span style=color:#a6e22e>+       Server server = NettyServerBuilder.forPort(9091)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         // 添加 Channelz 服务
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         .addService(ChannelzService.newInstance(100))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         // 添加反射服务，用于 grpcurl 等工具调试
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         .addService(ProtoReflectionService.newInstance())
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         .build()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+                                         .start();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>        // 构建 Channel
</span></span><span style=display:flex><span>        ManagedChannel channel = ManagedChannelBuilder.forAddress(&#34;127.0.0.1&#34;, 9090)
</span></span><span style=display:flex><span>                                                      .usePlaintext()
</span></span><span style=display:flex><span>                                                      .build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 使用 Channel 构建 BlockingStub
</span></span><span style=display:flex><span>        HelloServiceGrpc.HelloServiceBlockingStub blockingStub = HelloServiceGrpc.newBlockingStub(channel);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 发送多个请求，用于观察数据变化
</span></span><span style=display:flex><span>        for (int i = 0; i &lt; 10000; i++) {
</span></span><span style=display:flex><span>            // 构建消息
</span></span><span style=display:flex><span>            HelloMessage message = HelloMessage.newBuilder()
</span></span><span style=display:flex><span>                                               .setMessage(&#34;Channelz &#34; + i)
</span></span><span style=display:flex><span>                                               .build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            // 发送消息，并返回响应
</span></span><span style=display:flex><span>            HelloResponse helloResponse = blockingStub.sayHello(message);
</span></span><span style=display:flex><span>            log.info(helloResponse.getMessage());
</span></span><span style=display:flex><span>            Thread.sleep(1000);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        // 等待终止
</span></span><span style=display:flex><span><span style=color:#a6e22e>+       server.awaitTermination();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=测试>测试</h2><p>分别启动 Server 端和 Client 端，发送请求；使用其他工具观察</p><h3 id=grpc-zpages>grpc-zpages</h3><p>gRPC 官方提供了 <a href=https://github.com/grpc/grpc-experiments/tree/master/gdebug>grpc-zpages</a> 工具，可用通过 Web 查看指定服务的信息，不过该工具已经很久没有维护，使用较为复杂，具体可以参考 <a href=https://grpc.io/blog/a-short-introduction-to-channelz/>A short introduction to Channelz</a></p><h3 id=channelzcli>channelzcli</h3><p>是一个 CLI 工具，可以通过命令行实现获取 Channelz 的信息，对 Channelz 的数据做了一定的处理，较为友好，具体使用参考 <a href=https://github.com/kazegusuri/channelzcli>channelzcli</a></p><h4 id=安装>安装</h4><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go get -u github.com/kazegusuri/channelzcli
</span></span></code></pre></div><h4 id=使用-1>使用</h4><ul><li>获取 Channel 信息</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>channelzcli list channel -k --addr localhost:9091
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ID	Name                                                                            	State	Channel	SubChannel	Calls	Success	Fail	LastCall
</span></span><span style=display:flex><span>4	ManagedChannelImpl<span style=color:#c7bf54>{</span><span style=color:#dcaeea>logId</span><span style=color:#c7bf54>=</span>4, <span style=color:#dcaeea>target</span><span style=color:#c7bf54>=</span>127.0.0.1:9090<span style=color:#c7bf54>}</span>                              	READY	<span style=color:#d19a66>0</span>      	<span style=color:#d19a66>1</span>         	<span style=color:#d19a66>4355</span>  	<span style=color:#d19a66>4355</span>  	<span style=color:#d19a66>0</span>     	716ms
</span></span></code></pre></div><ul><li>描述 Server 信息</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>channelzcli describe server <span style=color:#d19a66>2</span> -k --addr localhost:9090
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ID: 	<span style=color:#d19a66>2</span>
</span></span><span style=display:flex><span>Name:	ServerImpl<span style=color:#c7bf54>{</span><span style=color:#dcaeea>logId</span><span style=color:#c7bf54>=</span>2, <span style=color:#dcaeea>transportServers</span><span style=color:#c7bf54>=[</span>NettyServer<span style=color:#c7bf54>{</span><span style=color:#dcaeea>logId</span><span style=color:#c7bf54>=</span>1, <span style=color:#dcaeea>address</span><span style=color:#c7bf54>=</span>0.0.0.0/0.0.0.0:9090<span style=color:#c7bf54>}]}</span>
</span></span><span style=display:flex><span>Calls:
</span></span><span style=display:flex><span>  Started:        	<span style=color:#d19a66>14486</span>
</span></span><span style=display:flex><span>  Succeeded:      	<span style=color:#d19a66>14476</span>
</span></span><span style=display:flex><span>  Failed:         	<span style=color:#d19a66>9</span>
</span></span><span style=display:flex><span>  LastCallStarted:	2021-01-06 08:51:35.608 +0000 UTC
</span></span></code></pre></div><ul><li>列出 Channel 信息</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>channelzcli tree channel -k --addr localhost:9091
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>127.0.0.1:9090 <span style=color:#c7bf54>(</span>ID:4<span style=color:#c7bf54>)</span> <span style=color:#c7bf54>[</span>READY<span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span>  <span style=color:#c7bf54>[</span>Calls<span style=color:#c7bf54>]</span> Started:4627, Succeeded:4627, Failed:0, Last:638ms
</span></span><span style=display:flex><span>  <span style=color:#c7bf54>[</span>Subchannels<span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span>    |-- <span style=color:#c7bf54>[[[</span>/127.0.0.1:9090<span style=color:#c7bf54>]</span>/<span style=color:#c7bf54>{}]]</span> <span style=color:#c7bf54>(</span>ID:6<span style=color:#c7bf54>)</span> <span style=color:#c7bf54>[</span>READY<span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span>          <span style=color:#c7bf54>[</span>Calls<span style=color:#c7bf54>]</span>: Started:4627, Succeeded:4627, Failed:0, Last:638ms
</span></span><span style=display:flex><span>          <span style=color:#c7bf54>[</span>Socket<span style=color:#c7bf54>]</span> ID:7, Name:CallTracingTransport<span style=color:#c7bf54>{</span><span style=color:#dcaeea>delegate</span><span style=color:#c7bf54>=</span>CallCredentialsApplyingTransport<span style=color:#c7bf54>{</span><span style=color:#dcaeea>delegate</span><span style=color:#c7bf54>=</span>NettyClientTransport<span style=color:#c7bf54>{</span><span style=color:#dcaeea>logId</span><span style=color:#c7bf54>=</span>7, <span style=color:#dcaeea>remoteAddress</span><span style=color:#c7bf54>=</span>/127.0.0.1:9090, <span style=color:#dcaeea>channel</span><span style=color:#c7bf54>=[</span>id: 0x83c4d921, L:/127.0.0.1:52321 - R:/127.0.0.1:9090<span style=color:#c7bf54>]}}}</span>, RemoteName:, Local:<span style=color:#c7bf54>[</span>127.0.0.1<span style=color:#c7bf54>]</span>:52321 Remote:<span style=color:#c7bf54>[</span>127.0.0.1<span style=color:#c7bf54>]</span>:9090<span style=color:#98c379>```</span>
</span></span></code></pre></div><h3 id=grpcurl>grpcurl</h3><p>是一个 CLI 工具，可以像 CURL 一样对 gRPC 服务发起请求，但是需要服务添加<a href=https://github.com/grpc/proposal/blob/master/A15-promote-reflection.md>反射服务</a>，详情参考 <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a></p><h4 id=安装-1>安装</h4><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install grpcurl
</span></span></code></pre></div><h4 id=使用-2>使用</h4><ul><li>获取 Server 列表</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grpcurl -plaintext localhost:9090 grpc.channelz.v1.Channelz/GetServers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>  <span style=color:#63c381>&#34;server&#34;</span>: <span style=color:#c7bf54>[</span>
</span></span><span style=display:flex><span>    <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>      <span style=color:#63c381>&#34;ref&#34;</span>: <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;server_id&#34;</span>: <span style=color:#63c381>&#34;2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;name&#34;</span>: <span style=color:#63c381>&#34;ServerImpl{logId=2, transportServers=[NettyServer{logId=1, address=0.0.0.0/0.0.0.0:9090}]}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c7bf54>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#63c381>&#34;data&#34;</span>: <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;calls_started&#34;</span>: <span style=color:#63c381>&#34;13438&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;calls_succeeded&#34;</span>: <span style=color:#63c381>&#34;13432&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;calls_failed&#34;</span>: <span style=color:#63c381>&#34;4&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;last_call_started_timestamp&#34;</span>: <span style=color:#63c381>&#34;2021-01-06T08:34:17.763Z&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c7bf54>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#63c381>&#34;listen_socket&#34;</span>: <span style=color:#c7bf54>[</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>          <span style=color:#63c381>&#34;socket_id&#34;</span>: <span style=color:#63c381>&#34;3&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#63c381>&#34;name&#34;</span>: <span style=color:#63c381>&#34;ListenSocket{logId=3, channel=[id: 0xc703c330, L:/0:0:0:0:0:0:0:0:9090]}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>      <span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span>    <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>  <span style=color:#c7bf54>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#63c381>&#34;end&#34;</span>: <span style=color:#ef8383>true</span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>}</span>
</span></span></code></pre></div><ul><li>获取 Channel 列表</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grpcurl -plaintext localhost:9091 grpc.channelz.v1.Channelz/GetTopChannels
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>  <span style=color:#63c381>&#34;channel&#34;</span>: <span style=color:#c7bf54>[</span>
</span></span><span style=display:flex><span>    <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>      <span style=color:#63c381>&#34;ref&#34;</span>: <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;channel_id&#34;</span>: <span style=color:#63c381>&#34;4&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;name&#34;</span>: <span style=color:#63c381>&#34;ManagedChannelImpl{logId=4, target=127.0.0.1:9090}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c7bf54>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#63c381>&#34;data&#34;</span>: <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;state&#34;</span>: <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>          <span style=color:#63c381>&#34;state&#34;</span>: <span style=color:#63c381>&#34;READY&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;target&#34;</span>: <span style=color:#63c381>&#34;127.0.0.1:9090&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;calls_started&#34;</span>: <span style=color:#63c381>&#34;45&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;calls_succeeded&#34;</span>: <span style=color:#63c381>&#34;45&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#63c381>&#34;last_call_started_timestamp&#34;</span>: <span style=color:#63c381>&#34;2021-01-06T07:38:45.217Z&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c7bf54>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#63c381>&#34;subchannel_ref&#34;</span>: <span style=color:#c7bf54>[</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>          <span style=color:#63c381>&#34;subchannel_id&#34;</span>: <span style=color:#63c381>&#34;6&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#63c381>&#34;name&#34;</span>: <span style=color:#63c381>&#34;InternalSubchannel{logId=6, addressGroups=[[[/127.0.0.1:9090]/{}]]}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>      <span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span>    <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>  <span style=color:#c7bf54>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#63c381>&#34;end&#34;</span>: <span style=color:#ef8383>true</span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>}</span>
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>