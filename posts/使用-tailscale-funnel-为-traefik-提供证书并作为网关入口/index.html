<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>使用 Tailscale Funnel 为 Traefik 提供证书并作为网关入口</title>
<meta name=description content="Tailscale Funnel 是 Tailscale 提供的网关工具，和 Cloudflare Tunnel 类似，支持将流量从公网路由到 Tailscale 节点设备的服务上，如 Web 服务、静态文件、SSH 等
不过 Tailscale Funnel 当前的功能并不完善，只支持路由到一个目标地址，也不支持自定 …"><meta name=keywords content='blog,hugo,HomeLab,Network,Tailscale,Traefik'><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-tailscale-funnel-%E4%B8%BA-traefik-%E6%8F%90%E4%BE%9B%E8%AF%81%E4%B9%A6%E5%B9%B6%E4%BD%9C%E4%B8%BA%E7%BD%91%E5%85%B3%E5%85%A5%E5%8F%A3/"><meta property="og:type" content="website"><meta property="og:title" content="使用 Tailscale Funnel 为 Traefik 提供证书并作为网关入口"><meta property="og:description" content="Tailscale Funnel 是 Tailscale 提供的网关工具，和 Cloudflare Tunnel 类似，支持将流量从公网路由到 Tailscale 节点设备的服务上，如 Web 服务、静态文件、SSH 等
不过 Tailscale Funnel 当前的功能并不完善，只支持路由到一个目标地址，也不支持自定 …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="使用 Tailscale Funnel 为 Traefik 提供证书并作为网关入口"><meta name=twitter:description content="Tailscale Funnel 是 Tailscale 提供的网关工具，和 Cloudflare Tunnel 类似，支持将流量从公网路由到 Tailscale 节点设备的服务上，如 Web 服务、静态文件、SSH 等
不过 Tailscale Funnel 当前的功能并不完善，只支持路由到一个目标地址，也不支持自定 …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-tailscale-funnel-%E4%B8%BA-traefik-%E6%8F%90%E4%BE%9B%E8%AF%81%E4%B9%A6%E5%B9%B6%E4%BD%9C%E4%B8%BA%E7%BD%91%E5%85%B3%E5%85%A5%E5%8F%A3/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-tailscale-funnel-%E4%B8%BA-traefik-%E6%8F%90%E4%BE%9B%E8%AF%81%E4%B9%A6%E5%B9%B6%E4%BD%9C%E4%B8%BA%E7%BD%91%E5%85%B3%E5%85%A5%E5%8F%A3/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-tailscale-funnel-%E4%B8%BA-traefik-%E6%8F%90%E4%BE%9B%E8%AF%81%E4%B9%A6%E5%B9%B6%E4%BD%9C%E4%B8%BA%E7%BD%91%E5%85%B3%E5%85%A5%E5%8F%A3/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>使用 Tailscale Funnel 为 Traefik 提供证书并作为网关入口</h1><small role=doc-subtitle></small><p class=post-date>2024-09-09</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/network>Network</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/tailscale>Tailscale</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/traefik>Traefik</a></li></ul></div><div class=post-content><p><a href=https://tailscale.com/kb/1223/funnel>Tailscale Funnel</a> 是 Tailscale 提供的网关工具，和 Cloudflare Tunnel 类似，支持将流量从公网路由到 Tailscale 节点设备的服务上，如 Web 服务、静态文件、SSH 等</p><p><img src="https://tailscale.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ffunnel-diagram.2f3f0e10.png&amp;w=3840&amp;q=75" alt></p><p>不过 Tailscale Funnel 当前的功能并不完善，只支持路由到一个目标地址，也不支持自定义路由；如果想路由到其他服务，需要在 Funnel 后面部署一个网关服务；在 Traefik 3.1 的版本中已经支持使用 Tailscale 作为 TLS 证书的提供方，用于将 Tailscale 域名作为 Traefik 的入口</p><h2 id=配置-traefik>配置 Traefik</h2><p>在 Tailscale 的节点上使用 docker-compose 部署 traefik</p><ul><li>创建网络</li></ul><p>为了方便能通过 Docker 自动发现服务路由，创建一个容器共用的网络，用于 Traefik 路由到对应服务</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create traefik
</span></span></code></pre></div><ul><li>docker-compose.yaml</li></ul><p>需要在 docker-compose 指定网络，并挂载 <code>/var/run/docker.sock</code>，用于自动获取路由规则</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>external</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>always</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>healthcheck</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>test</span>: [<span style=color:#63c381>&#34;CMD&#34;</span>, <span style=color:#63c381>&#34;wget&#34;</span>, <span style=color:#63c381>&#34;-q&#34;</span>, <span style=color:#63c381>&#34;--spider&#34;</span>, <span style=color:#63c381>&#34;http://localhost:8080/ping&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#e06c75>interval</span>: <span style=color:#98c379>15s</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>timeout</span>: <span style=color:#98c379>10s</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>retries</span>: <span style=color:#d19a66>3</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>start_period</span>: <span style=color:#98c379>30s</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>command</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;--configFile=/etc/traefik/traefik.yml&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;81:80&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8443:443&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8080:8080&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;./traefik.yml:/etc/traefik/traefik.yml&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>TZ=Asia/Shanghai</span>
</span></span></code></pre></div><ul><li>traefik.yml</li></ul><p>配置中定义了一个 certificatesResolvers，名称是 <code>default</code>，由 tailscale 提供；同时指定了 tls 的 certResolver 名称是 <code>default</code>，这样就会由 tailscale 提供 TLS 证书；完整的配置如下：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>api</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>dashboard</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>insecure</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>entryPoints</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>address</span>: <span style=color:#63c381>&#34;:80&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>websecure</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>address</span>: <span style=color:#63c381>&#34;:443&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>tls</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>certResolver</span>: <span style=color:#98c379>default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>certificatesResolvers</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>default</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>tailscale</span>: {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ping</span>: {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>log</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>level</span>: <span style=color:#98c379>DEBUG</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>providers</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>docker</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>exposedByDefault</span>: <span style=color:#b756ff;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>network</span>: <span style=color:#98c379>traefik</span>
</span></span></code></pre></div><ul><li>启动 traefik</li></ul><p>通过 docker compose 启动容器</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose up -d
</span></span></code></pre></div><p>启动后通过 IP:PORT 访问 traefik，如 <a href=http://localhost:8080>http://localhost:8080</a>可以正常访问，说明 traefik 已经正确配置</p><p><img src=https://img.hellowood.dev/picture/homelab-traefik-tailscale-default-configuration-homepage.png alt=homelab-traefik-tailscale-default-configuration-homepage.png></p><h2 id=启动-tailscale-funnel>启动 Tailscale Funnel</h2><p>Funnel 相关介绍参考 <a href=https://tailscale.com/kb/1223/funnel>Tailscale Funnel</a>；因为 traefik 的 443 端口映射到了宿主机的 8443 端口，所以需要将请求转发到 localhost:8443，忽略证书验证，所以配置的转发地址是 <a href=https+insecure://localhost:8443>https+insecure://localhost:8443</a></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tailscale funnel --bg https+insecure://localhost:8443
</span></span></code></pre></div><p>启动后会提示 funnel 监听的域名以及转发的地址</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Available on the internet:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>https://homelab.xxx.ts.net/
</span></span><span style=display:flex><span>|-- proxy https+insecure://localhost:8443
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Funnel started and running in the background.
</span></span><span style=display:flex><span>To disable the proxy, run: tailscale funnel --https<span style=color:#c7bf54>=</span><span style=color:#d19a66>443</span> off
</span></span></code></pre></div><ul><li>查看状态</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tailscale serve status
</span></span></code></pre></div><p>funnel 开启，并转发到 https://localhost:8443</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># Funnel on:</span>
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#     - https://homelab.xxx.ts.net</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>https://homelab.xxx.ts.net <span style=color:#c7bf54>(</span>Funnel on<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>|-- / proxy https+insecure://localhost:8443
</span></span></code></pre></div><p>因为还没有配置路由规则，所以此时访问 <a href=https://homelab.xxx.ts.net>https://homelab.xxx.ts.net</a> 会返回 404；如果 8443 端口没有监听，则会返回 502</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i https://homelab.xxx.ts.net
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#d19a66>404</span>
</span></span><span style=display:flex><span>content-length: <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>date: Sun, <span style=color:#d19a66>13</span> Oct <span style=color:#d19a66>2024</span> 12:34:45 GMT
</span></span></code></pre></div><h2 id=添加路由规则>添加路由规则</h2><p>配置证书后需要添加路由规则，将 Tailscale 的 tailnet 域名添加到路由规则中</p><h3 id=路由到-traefik>路由到 traefik</h3><p>通过给 Docker 容器添加 label 的方式配置路由规则，将根路径路由到 Traefik 的 Dashboard</p><ul><li>docker-compose.yaml</li></ul><p>添加 label 配置，Host 是 Tailscale 的节点路由，格式是 <code>节点名称+Tailnet名称</code>；如节点是 homelab，Tailnet名称是 <code>xxx.ts.net</code>；同时还需要将 <code>/var/run/tailscale/tailscaled.sock</code> 挂载到容器中，用于 Tailscale 节点通信</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>external</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>always</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>healthcheck</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>test</span>: [<span style=color:#63c381>&#34;CMD&#34;</span>, <span style=color:#63c381>&#34;wget&#34;</span>, <span style=color:#63c381>&#34;-q&#34;</span>, <span style=color:#63c381>&#34;--spider&#34;</span>, <span style=color:#63c381>&#34;http://localhost:8080/ping&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#e06c75>interval</span>: <span style=color:#98c379>15s</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>timeout</span>: <span style=color:#98c379>10s</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>retries</span>: <span style=color:#d19a66>3</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>start_period</span>: <span style=color:#98c379>30s</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>command</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;--configFile=/etc/traefik/traefik.yml&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;81:80&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8443:443&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8080:8080&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;traefik.http.routers.traefik.rule=Host(`homelab.xxx.ts.net`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;traefik.http.routers.traefik.entrypoints=web,websecure&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;traefik.http.routers.traefik.tls=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;traefik.http.routers.traefik.tls.certresolver=default&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;traefik.http.services.traefik.loadbalancer.server.port=8080&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;./traefik.yml:/etc/traefik/traefik.yml&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>/var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>TZ=Asia/Shanghai</span>
</span></span></code></pre></div><p>启动后就可以在日志中看到使用了 tailscale 作为证书提供，并添加了对应的路由</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c7bf54>...</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>provider</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>tailscale</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>provider</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>254</span> &gt; <span style=color:#c1abea>Fetched</span> <span style=color:#c1abea>certificate</span> <span style=color:#c678dd>for</span> <span style=color:#c1abea>domain</span> <span style=color:#98c379>&#34;homelab.xxx.ts.net&#34;</span> <span style=color:#c1abea>providerName</span>=<span style=color:#c678dd>default</span>.<span style=color:#c1abea>tailscale</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>server</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>configurationwatcher</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>227</span> &gt; <span style=color:#c1abea>Configuration</span> <span style=color:#c1abea>received</span> <span style=color:#c1abea>config</span>={<span style=color:#98c379>&#34;http&#34;</span>:{},<span style=color:#98c379>&#34;tcp&#34;</span>:{},<span style=color:#98c379>&#34;tls&#34;</span>:{},<span style=color:#98c379>&#34;udp&#34;</span>:{}} <span style=color:#c1abea>providerName</span>=<span style=color:#c678dd>default</span>.<span style=color:#c1abea>tailscale</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>tls</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>certificate</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>131</span> &gt; <span style=color:#c1abea>Adding</span> <span style=color:#c1abea>certificate</span> <span style=color:#c678dd>for</span> <span style=color:#00b1f7>domain</span>(<span style=color:#c1abea>s</span>) <span style=color:#c1abea>homelab</span>.<span style=color:#c1abea>xxx</span>.<span style=color:#c1abea>ts</span>.<span style=color:#c1abea>net</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>tls</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>tlsmanager</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>321</span> &gt; <span style=color:#c1abea>No</span> <span style=color:#c678dd>default</span> <span style=color:#c1abea>certificate</span>, <span style=color:#c1abea>fallback</span> <span style=color:#c1abea>to</span> <span style=color:#c1abea>the</span> <span style=color:#c1abea>internal</span> <span style=color:#c1abea>generated</span> <span style=color:#c1abea>certificate</span> <span style=color:#c1abea>tlsStoreName</span>=<span style=color:#c678dd>default</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>stripprefix</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>strip_prefix</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>32</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>traefik</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>dashboard_stripprefix</span>@<span style=color:#c1abea>internal</span> <span style=color:#c1abea>middlewareType</span>=<span style=color:#c1abea>StripPrefix</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>dashboard</span>@<span style=color:#c1abea>internal</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>observability</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middleware</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>33</span> &gt; <span style=color:#c1abea>Adding</span> <span style=color:#c1abea>tracing</span> <span style=color:#c1abea>to</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>traefik</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>dashboard_stripprefix</span>@<span style=color:#c1abea>internal</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>dashboard</span>@<span style=color:#c1abea>internal</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>redirect</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>redirect_regex</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>17</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>traefik</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>dashboard_redirect</span>@<span style=color:#c1abea>internal</span> <span style=color:#c1abea>middlewareType</span>=<span style=color:#c1abea>RedirectRegex</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>dashboard</span>@<span style=color:#c1abea>internal</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>redirect</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>redirect_regex</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>18</span> &gt; <span style=color:#c1abea>Setting</span> <span style=color:#c1abea>up</span> <span style=color:#c1abea>redirection</span> <span style=color:#c1abea>from</span> ^(<span style=color:#c1abea>http</span>:\<span style=color:#c7bf54>/</span>\<span style=color:#c7bf54>/</span>(\[[\<span style=color:#c1abea>w</span>:.]<span style=color:#c7bf54>+</span>\]|[\<span style=color:#c1abea>w</span>\.<span style=color:#c1abea>_</span><span style=color:#c7bf54>-</span>]<span style=color:#c7bf54>+</span>)(:\<span style=color:#c1abea>d</span><span style=color:#c7bf54>+</span>)?)\<span style=color:#c7bf54>/</span>$ <span style=color:#c1abea>to</span> ${<span style=color:#d19a66>1</span>}<span style=color:#c7bf54>/</span><span style=color:#c1abea>dashboard</span><span style=color:#c7bf54>/</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>traefik</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>dashboard_redirect</span>@<span style=color:#c1abea>internal</span> <span style=color:#c1abea>middlewareType</span>=<span style=color:#c1abea>RedirectRegex</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>dashboard</span>@<span style=color:#c1abea>internal</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>observability</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middleware</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>33</span> &gt; <span style=color:#c1abea>Adding</span> <span style=color:#c1abea>tracing</span> <span style=color:#c1abea>to</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>traefik</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>dashboard_redirect</span>@<span style=color:#c1abea>internal</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>dashboard</span>@<span style=color:#c1abea>internal</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>recovery</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>recovery</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>22</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>traefik</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>traefik</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>internal</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>recovery</span> <span style=color:#c1abea>middlewareType</span>=<span style=color:#c1abea>Recovery</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>server</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>service</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>service</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>267</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>load</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>balancer</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>websecure</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>websecure</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>traefik</span>@<span style=color:#c1abea>docker</span> <span style=color:#c1abea>serviceName</span>=<span style=color:#c1abea>traefik</span>@<span style=color:#c1abea>docker</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>server</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>service</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>service</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>309</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>server</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>websecure</span> <span style=color:#c1abea>routerName</span>=<span style=color:#c1abea>websecure</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>traefik</span>@<span style=color:#c1abea>docker</span> <span style=color:#c1abea>serverName</span>=<span style=color:#c1abea>da81a48dc1e3586e</span> <span style=color:#c1abea>serviceName</span>=<span style=color:#c1abea>traefik</span>@<span style=color:#c1abea>docker</span> <span style=color:#c1abea>target</span>=<span style=color:#c1abea>http</span>:<span style=color:#8a93a5;font-style:italic>//172.18.0.2:8080
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>recovery</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>recovery</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>22</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>websecure</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>traefik</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>internal</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>recovery</span> <span style=color:#c1abea>middlewareType</span>=<span style=color:#c1abea>Recovery</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>middlewares</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>recovery</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>recovery</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>22</span> &gt; <span style=color:#c1abea>Creating</span> <span style=color:#c1abea>middleware</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>web</span> <span style=color:#c1abea>middlewareName</span>=<span style=color:#c1abea>traefik</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>internal</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>recovery</span> <span style=color:#c1abea>middlewareType</span>=<span style=color:#c1abea>Recovery</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>server</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>router</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>tcp</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>manager</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>237</span> &gt; <span style=color:#c1abea>Adding</span> <span style=color:#c1abea>route</span> <span style=color:#c678dd>for</span> <span style=color:#c1abea>homelab</span>.<span style=color:#c1abea>xxx</span>.<span style=color:#c1abea>ts</span>.<span style=color:#c1abea>net</span> <span style=color:#c1abea>with</span> <span style=color:#c1abea>TLS</span> <span style=color:#c1abea>options</span> <span style=color:#c678dd>default</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>web</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>traefik</span>  | <span style=color:#d19a66>2024</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>10</span><span style=color:#c7bf54>-</span><span style=color:#d19a66>13</span><span style=color:#c1abea>T18</span>:<span style=color:#d19a66>41</span>:<span style=color:#d19a66>34</span><span style=color:#c7bf54>+</span><span style=color:#d19a66>08</span>:<span style=color:#d19a66>00</span> <span style=color:#c1abea>DBG</span> <span style=color:#c1abea>github</span>.<span style=color:#c1abea>com</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>traefik</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>v3</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>pkg</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>server</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>router</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>tcp</span><span style=color:#c7bf54>/</span><span style=color:#c1abea>manager</span>.<span style=color:#c678dd>go</span>:<span style=color:#d19a66>237</span> &gt; <span style=color:#c1abea>Adding</span> <span style=color:#c1abea>route</span> <span style=color:#c678dd>for</span> <span style=color:#c1abea>homelab</span>.<span style=color:#c1abea>xxx</span>.<span style=color:#c1abea>ts</span>.<span style=color:#c1abea>net</span> <span style=color:#c1abea>with</span> <span style=color:#c1abea>TLS</span> <span style=color:#c1abea>options</span> <span style=color:#c678dd>default</span> <span style=color:#c1abea>entryPointName</span>=<span style=color:#c1abea>websecure</span>
</span></span></code></pre></div><ul><li>访问</li></ul><p>此时访问 <a href=https://homelab.xxx.ts.net>https://homelab.xxx.ts.net</a> 域名，可以正常访问 traefik 的 dashboard，说明配置正确 (因为 Tailscale Funnel 的公网入口部署在美国，所以访问很慢，使用同一个 Tailscale 子网下的其他设备访问会更快)</p><p><img src=https://img.hellowood.dev/picture/homelab-traefik-tailscale-dashboard-route-rule-list.png alt=homelab-traefik-tailscale-dashboard-route-rule-list.png></p><h3 id=路由到其他服务>路由到其他服务</h3><p>如果服务在同一个 docker network 下的容器，可以直接通过 label 的方式配置路由规则；如果不在同一个网络下，可以通过文件的方式配置</p><h4 id=启动-whoami-服务>启动 whoami 服务</h4><p>以 whoami 服务为例，通过 docker 容器启动该服务</p><ul><li>docker-compose</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>whoami</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#63c381>&#34;traefik/whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#63c381>&#34;whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>whoami</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8081:80&#34;</span>
</span></span></code></pre></div><p>启动后访问 8081 端口，能正常返回信息</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i 192.168.31.2:8081
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>HTTP/1.1 <span style=color:#d19a66>200</span> OK
</span></span><span style=display:flex><span>Date: Sun, <span style=color:#d19a66>13</span> Oct <span style=color:#d19a66>2024</span> 12:49:33 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#d19a66>167</span>
</span></span><span style=display:flex><span>Content-Type: text/plain; <span style=color:#dcaeea>charset</span><span style=color:#c7bf54>=</span>utf-8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hostname: whoami
</span></span><span style=display:flex><span>IP: 127.0.0.1
</span></span><span style=display:flex><span>IP: ::1
</span></span><span style=display:flex><span>IP: 172.18.0.3
</span></span><span style=display:flex><span>RemoteAddr: 192.168.31.2:42734
</span></span><span style=display:flex><span>GET / HTTP/1.1
</span></span><span style=display:flex><span>Host: 192.168.31.2:8081
</span></span><span style=display:flex><span>User-Agent: curl/8.5.0
</span></span><span style=display:flex><span>Accept: */*
</span></span></code></pre></div><h4 id=创建路由规则>创建路由规则</h4><ul><li>router/whoami.yml</li></ul><p>创建 router 文件夹，用于存放路由规则，并在 router 路径下配置 whoami 服务的路由</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>http</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>routers</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>whoami</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>entryPoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#63c381>&#34;websecure&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#63c381>&#34;web&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>rule</span>: <span style=color:#63c381>&#34;Host(`homelab.xxx.ts.net`) &amp;&amp; Path(`/whoami`)&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>service</span>: <span style=color:#63c381>&#34;whoami&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>tls</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>certResolver</span>: <span style=color:#98c379>default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>whoami</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>loadBalancer</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>servers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e06c75>url</span>: <span style=color:#63c381>&#34;http://192.168.31.2:8081&#34;</span>
</span></span></code></pre></div><h4 id=挂载路由规则>挂载路由规则</h4><p>修改 traefik 的配置文件，将 router 路径挂载到容器中</p><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic># ...</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>volumes</span>:
</span></span><span style=display:flex><span>      <span style=color:#8a93a5;font-style:italic># ...</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;./router:/etc/traefik/router&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8a93a5;font-style:italic># ...</span>
</span></span></code></pre></div><ul><li>traefik.yml</li></ul><p>添加文件路由规则的配置</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8a93a5;font-style:italic># ...</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>providers</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>docker</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>exposedByDefault</span>: <span style=color:#b756ff;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>network</span>: <span style=color:#98c379>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic># 添加文件配置</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>file</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>directory</span>: <span style=color:#98c379>/etc/traefik/router</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>watch</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>debugLogGeneratedTemplate</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span></code></pre></div><p>此时的路由规则如下：</p><p><img src=https://img.hellowood.dev/picture/homelab-traefik-tailscale-custom-route-rule-list.png alt=homelab-traefik-tailscale-custom-route-rule-list.png></p><h4 id=访问>访问</h4><p>重新启动 traefik 容器，访问 <a href=https://homelab.xxx.ts.net/whoami>https://homelab.xxx.ts.net/whoami</a></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i https://homelab.xxx.ts.net/whoami
</span></span></code></pre></div><p>可以正确转发并返回访问信息，说明路由规则配置正确</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>HTTP/2 <span style=color:#d19a66>200</span>
</span></span><span style=display:flex><span>content-type: text/plain; <span style=color:#dcaeea>charset</span><span style=color:#c7bf54>=</span>utf-8
</span></span><span style=display:flex><span>date: Sun, <span style=color:#d19a66>13</span> Oct <span style=color:#d19a66>2024</span> 13:03:11 GMT
</span></span><span style=display:flex><span>content-length: <span style=color:#d19a66>364</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hostname: whoami
</span></span><span style=display:flex><span>IP: 127.0.0.1
</span></span><span style=display:flex><span>IP: 172.20.0.5
</span></span><span style=display:flex><span>RemoteAddr: 192.168.31.2:43242
</span></span><span style=display:flex><span>GET /whoami HTTP/1.1
</span></span><span style=display:flex><span>Host: homelab.xxx.ts.net
</span></span><span style=display:flex><span>User-Agent: curl/8.5.0
</span></span><span style=display:flex><span>Accept: */*
</span></span><span style=display:flex><span>Accept-Encoding: gzip
</span></span><span style=display:flex><span>X-Forwarded-For: 172.18.0.1
</span></span><span style=display:flex><span>X-Forwarded-Host: homelab.xxx.ts.net
</span></span><span style=display:flex><span>X-Forwarded-Port: <span style=color:#d19a66>443</span>
</span></span><span style=display:flex><span>X-Forwarded-Proto: https
</span></span><span style=display:flex><span>X-Forwarded-Server: traefik
</span></span><span style=display:flex><span>X-Real-Ip: 172.18.0.1
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>