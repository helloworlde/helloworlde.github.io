<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>OpenWrt 桥接充当交换机</title>
<meta charset=utf-8><meta name=description content="Ladder@OpenWrt 桥接充当交换机 需求背景 使用的路由器只有 3 个 LAN 口，在购入 NAS 后网口捉襟见肘，并且 NAS 不支持 Wi-Fi，因此需要更多的网口支持设备连接
路由器是小米的 Redmi AX6000， 支持WiFi 6E，协商速度能达到2400Mbps，但却只有千兆的网口；因为家里的两台电脑和 NAS 都是 2.5G 的网口和 WiFi6E 的无线网卡，想要 NAS 高速读写就需要 2.5G 以上的交换机；但是 2.5G 的交换机价格都在 400+，性价比不高
日常将四网口的 N5105 作为 HomeLab 的服务器使用，只有一个网口连接到路由器，其他三个网口空闲；因此想将 N5105 作为交换机，用于连接 NAS 和电脑；有三种方案：
路由器和 N5105 做链路聚合，NAS连接到 N5105，电脑通过 WiFi 访问；速度能达到 2000Mbps，不过这样额外占用了两个网口，但是好处是所有的支持 WiFi6 的设备都能高速访问 NAS 不做链路聚合，这样能够多三个 2.5G 的网口；NAS 和电脑都通过网线连接到 N5105，通过网线连接的设备均能以 2.5G 的速度访问 NAS 为 N5105 添加 WiFi6E 无线网卡，并启用混杂模式，NAS 通过网线连接到 N5105，电脑通过 WiFi 访问 NAS；所有支持 WiFi6 的设备可以 2400Mbps 的速度访问 NAS；但是需要额外购买一张 WiFi6 的无线网卡，并且设备需要连接到 N5150 的 WiFi网络上 基于以上考虑，不做链路聚合成本最低且能扩展网口，添加 WiFi6 网卡效果最好；因为手头没有 WiFi6 的网卡，因此先通过不做链路聚合的方式实现"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/openwrt-%E6%A1%A5%E6%8E%A5%E5%85%85%E5%BD%93%E4%BA%A4%E6%8D%A2%E6%9C%BA/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/openwrt-%E6%A1%A5%E6%8E%A5%E5%85%85%E5%BD%93%E4%BA%A4%E6%8D%A2%E6%9C%BA/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="OpenWrt 桥接充当交换机"><meta property="og:description" content="OpenWrt 桥接充当交换机 需求背景 使用的路由器只有 3 个 LAN 口，在购入 NAS 后网口捉襟见肘，并且 NAS 不支持 Wi-Fi，因此需要更多的网口支持设备连接
路由器是小米的 Redmi AX6000， 支持WiFi 6E，协商速度能达到2400Mbps，但却只有千兆的网口；因为家里的两台电脑和 NAS 都是 2.5G 的网口和 WiFi6E 的无线网卡，想要 NAS 高速读写就需要 2.5G 以上的交换机；但是 2.5G 的交换机价格都在 400+，性价比不高
日常将四网口的 N5105 作为 HomeLab 的服务器使用，只有一个网口连接到路由器，其他三个网口空闲；因此想将 N5105 作为交换机，用于连接 NAS 和电脑；有三种方案：
路由器和 N5105 做链路聚合，NAS连接到 N5105，电脑通过 WiFi 访问；速度能达到 2000Mbps，不过这样额外占用了两个网口，但是好处是所有的支持 WiFi6 的设备都能高速访问 NAS 不做链路聚合，这样能够多三个 2.5G 的网口；NAS 和电脑都通过网线连接到 N5105，通过网线连接的设备均能以 2.5G 的速度访问 NAS 为 N5105 添加 WiFi6E 无线网卡，并启用混杂模式，NAS 通过网线连接到 N5105，电脑通过 WiFi 访问 NAS；所有支持 WiFi6 的设备可以 2400Mbps 的速度访问 NAS；但是需要额外购买一张 WiFi6 的无线网卡，并且设备需要连接到 N5150 的 WiFi网络上 基于以上考虑，不做链路聚合成本最低且能扩展网口，添加 WiFi6 网卡效果最好；因为手头没有 WiFi6 的网卡，因此先通过不做链路聚合的方式实现"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-21T21:33:24+08:00"><meta property="article:modified_time" content="2023-03-21T21:33:24+08:00"><meta property="article:tag" content="OpenWrt"><meta property="article:tag" content="HomeLab"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/openwrt-%E5%9C%A8-pve-%E4%B8%AD%E4%BB%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/openwrt-%E4%BD%BF%E7%94%A8-lets-encrypt-%E8%AF%81%E4%B9%A6%E5%BC%80%E5%90%AF-https-%E8%AE%BF%E9%97%AE/"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenWrt 桥接充当交换机"><meta name=twitter:description content="OpenWrt 桥接充当交换机 需求背景 使用的路由器只有 3 个 LAN 口，在购入 NAS 后网口捉襟见肘，并且 NAS 不支持 Wi-Fi，因此需要更多的网口支持设备连接
路由器是小米的 Redmi AX6000， 支持WiFi 6E，协商速度能达到2400Mbps，但却只有千兆的网口；因为家里的两台电脑和 NAS 都是 2.5G 的网口和 WiFi6E 的无线网卡，想要 NAS 高速读写就需要 2.5G 以上的交换机；但是 2.5G 的交换机价格都在 400+，性价比不高
日常将四网口的 N5105 作为 HomeLab 的服务器使用，只有一个网口连接到路由器，其他三个网口空闲；因此想将 N5105 作为交换机，用于连接 NAS 和电脑；有三种方案：
路由器和 N5105 做链路聚合，NAS连接到 N5105，电脑通过 WiFi 访问；速度能达到 2000Mbps，不过这样额外占用了两个网口，但是好处是所有的支持 WiFi6 的设备都能高速访问 NAS 不做链路聚合，这样能够多三个 2.5G 的网口；NAS 和电脑都通过网线连接到 N5105，通过网线连接的设备均能以 2.5G 的速度访问 NAS 为 N5105 添加 WiFi6E 无线网卡，并启用混杂模式，NAS 通过网线连接到 N5105，电脑通过 WiFi 访问 NAS；所有支持 WiFi6 的设备可以 2400Mbps 的速度访问 NAS；但是需要额外购买一张 WiFi6 的无线网卡，并且设备需要连接到 N5150 的 WiFi网络上 基于以上考虑，不做链路聚合成本最低且能扩展网口，添加 WiFi6 网卡效果最好；因为手头没有 WiFi6 的网卡，因此先通过不做链路聚合的方式实现"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"OpenWrt 桥接充当交换机","item":"https://blog.hellowood.dev/posts/openwrt-%E6%A1%A5%E6%8E%A5%E5%85%85%E5%BD%93%E4%BA%A4%E6%8D%A2%E6%9C%BA/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OpenWrt 桥接充当交换机","name":"OpenWrt 桥接充当交换机","description":"OpenWrt 桥接充当交换机 需求背景 使用的路由器只有 3 个 LAN 口，在购入 NAS 后网口捉襟见肘，并且 NAS 不支持 Wi-Fi，因此需要更多的网口支持设备连接\n路由器是小米的 Redmi AX6000， 支持WiFi 6E，协商速度能达到2400Mbps，但却只有千兆的网口；因为家里的两台电脑和 NAS 都是 2.5G 的网口和 WiFi6E 的无线网卡，想要 NAS 高速读写就需要 2.5G 以上的交换机；但是 2.5G 的交换机价格都在 400+，性价比不高\n日常将四网口的 N5105 作为 HomeLab 的服务器使用，只有一个网口连接到路由器，其他三个网口空闲；因此想将 N5105 作为交换机，用于连接 NAS 和电脑；有三种方案：\n路由器和 N5105 做链路聚合，NAS连接到 N5105，电脑通过 WiFi 访问；速度能达到 2000Mbps，不过这样额外占用了两个网口，但是好处是所有的支持 WiFi6 的设备都能高速访问 NAS 不做链路聚合，这样能够多三个 2.5G 的网口；NAS 和电脑都通过网线连接到 N5105，通过网线连接的设备均能以 2.5G 的速度访问 NAS 为 N5105 添加 WiFi6E 无线网卡，并启用混杂模式，NAS 通过网线连接到 N5105，电脑通过 WiFi 访问 NAS；所有支持 WiFi6 的设备可以 2400Mbps 的速度访问 NAS；但是需要额外购买一张 WiFi6 的无线网卡，并且设备需要连接到 N5150 的 WiFi网络上 基于以上考虑，不做链路聚合成本最低且能扩展网口，添加 WiFi6 网卡效果最好；因为手头没有 WiFi6 的网卡，因此先通过不做链路聚合的方式实现","keywords":["OpenWrt","HomeLab"],"articleBody":"OpenWrt 桥接充当交换机 需求背景 使用的路由器只有 3 个 LAN 口，在购入 NAS 后网口捉襟见肘，并且 NAS 不支持 Wi-Fi，因此需要更多的网口支持设备连接\n路由器是小米的 Redmi AX6000， 支持WiFi 6E，协商速度能达到2400Mbps，但却只有千兆的网口；因为家里的两台电脑和 NAS 都是 2.5G 的网口和 WiFi6E 的无线网卡，想要 NAS 高速读写就需要 2.5G 以上的交换机；但是 2.5G 的交换机价格都在 400+，性价比不高\n日常将四网口的 N5105 作为 HomeLab 的服务器使用，只有一个网口连接到路由器，其他三个网口空闲；因此想将 N5105 作为交换机，用于连接 NAS 和电脑；有三种方案：\n路由器和 N5105 做链路聚合，NAS连接到 N5105，电脑通过 WiFi 访问；速度能达到 2000Mbps，不过这样额外占用了两个网口，但是好处是所有的支持 WiFi6 的设备都能高速访问 NAS 不做链路聚合，这样能够多三个 2.5G 的网口；NAS 和电脑都通过网线连接到 N5105，通过网线连接的设备均能以 2.5G 的速度访问 NAS 为 N5105 添加 WiFi6E 无线网卡，并启用混杂模式，NAS 通过网线连接到 N5105，电脑通过 WiFi 访问 NAS；所有支持 WiFi6 的设备可以 2400Mbps 的速度访问 NAS；但是需要额外购买一张 WiFi6 的无线网卡，并且设备需要连接到 N5150 的 WiFi网络上 基于以上考虑，不做链路聚合成本最低且能扩展网口，添加 WiFi6 网卡效果最好；因为手头没有 WiFi6 的网卡，因此先通过不做链路聚合的方式实现\n配置 交换机方案 有很多专业的开源或者收费的交换机方案，如 VyOS，Cumulus Linux，Open vSwitch（OVS）等，也可以基于 iKuai 或者 OpenWrt 等路由； 基于学习成本，维护成本，以及便捷性，最终选择 OpenWrt 作为交换机的方案（实际是路由器的 AP 模式）\n安装 OpenWrt 在 Esxi/PVE 上安装 OpenWrt 的文档有很多，不再赘述；\n建议使用最新的 OpenWrt 版本，当前最新的版本是 22.03.3，该版本已经支持了 Intel I225V 网卡，因此无需额外安装驱动；如果选择的是之前的版本，需要单独安装对应的驱动\n直通网卡 在硬件中添加 PCI设备，将 PCI 网卡添加到 OpenWrt 中，作为 OpenWrt 的 LAN 口；WAN口是 PVE 虚拟机提供的虚拟网卡\n安装驱动 检查 PCI 设备是否连接 需要安装 pciutils 后才能查看 PCI 设备\nopkg update opkg install pciutils 通过 lspci 命令查看，发现连接没有问题\nlspci | grep Eth 00:10.0 Ethernet controller: Intel Corporation Ethernet Controller I225-V (rev 03) 00:11.0 Ethernet controller: Intel Corporation Ethernet Controller I225-V (rev 03) 00:12.0 Ethernet controller: Red Hat, Inc. Virtio network device 00:1b.0 Ethernet controller: Intel Corporation Ethernet Controller I225-V (rev 03) 检查网口是否识别 查看网口是否成功识别，发现只有 br-lan, eth0, lo 三个网口；说明网卡的驱动没有安装\nls -l /sys/class/net/ lrwxrwxrwx 1 root root 0 Mar 20 08:00 br-lan -\u003e ../../devices/virtual/net/br-lan lrwxrwxrwx 1 root root 0 Mar 20 08:00 eth0 -\u003e ../../devices/pci0000:00/0000:00:12.0/virtio1/net/eth0 lrwxrwxrwx 1 root root 0 Mar 20 08:00 lo -\u003e ../../devices/virtual/net/lo 安装驱动 opkg update opkg install kmod-igc 安装完成后再次查看网口，发现多了 eth1, eth2,eth3，说明网口识别正确\nls -l /sys/class/net/ lrwxrwxrwx 1 root root 0 Mar 20 08:00 br-lan -\u003e ../../devices/virtual/net/br-lan lrwxrwxrwx 1 root root 0 Mar 20 08:00 eth0 -\u003e ../../devices/pci0000:00/0000:00:12.0/virtio1/net/eth0 lrwxrwxrwx 1 root root 0 Mar 20 08:00 eth1 -\u003e ../../devices/pci0000:00/0000:00:10.0/net/eth1 lrwxrwxrwx 1 root root 0 Mar 20 08:00 eth2 -\u003e ../../devices/pci0000:00/0000:00:11.0/net/eth2 lrwxrwxrwx 1 root root 0 Mar 20 08:07 eth3 -\u003e ../../devices/pci0000:00/0000:00:1b.0/net/eth3 lrwxrwxrwx 1 root root 0 Mar 20 08:00 lo -\u003e ../../devices/virtual/net/lo 配置 OpenWrt 进入 OpenWrt 配置界面，在网络-接口-设备，选择配置 br-lan\n在网桥端口中，将 eth0, eth1,eth2,eth3全部选中，作为网桥的桥接端口；然后点击保存并应用，这样就可以将 OpenWrt 作为交换机使用了\n测试 使用网线将 NAS 和电脑都连接到 N5105 的网口中，然后在 NAS 上通过 Docker 启动 adolfintel/speedtest，在电脑上通过浏览器测试；测试结果能达到 2.5G 的速度\n","wordCount":"329","inLanguage":"en","datePublished":"2023-03-21T21:33:24+08:00","dateModified":"2023-03-21T21:33:24+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/openwrt-%E6%A1%A5%E6%8E%A5%E5%85%85%E5%BD%93%E4%BA%A4%E6%8D%A2%E6%9C%BA/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.7f82854fa0e999ec07c4835d3029de9f484030e254b80d470b3ca48eb934720e.css integrity="sha256-f4KFT6DpmewHxINdMCnen0hAMOJUuA1HCzykjrk0cg4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script defer src=https://analytics.us.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>OpenWrt 桥接充当交换机</h1></header><p><small>March 21, 2023&nbsp;· 329 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#需求背景>需求背景</a></li><li><a href=#配置>配置</a><ul><li><a href=#交换机方案>交换机方案</a></li><li><a href=#安装-openwrt>安装 OpenWrt</a></li><li><a href=#直通网卡>直通网卡</a></li><li><a href=#安装驱动>安装驱动</a></li><li><a href=#配置-openwrt>配置 OpenWrt</a></li></ul></li><li><a href=#测试>测试</a></li></ul></nav></div><section class=blog-content><h1 id=openwrt-桥接充当交换机>OpenWrt 桥接充当交换机</h1><h2 id=需求背景>需求背景</h2><p>使用的路由器只有 3 个 LAN 口，在购入 NAS 后网口捉襟见肘，并且 NAS 不支持 Wi-Fi，因此需要更多的网口支持设备连接</p><p>路由器是小米的 Redmi AX6000， 支持WiFi 6E，协商速度能达到2400Mbps，但却只有千兆的网口；因为家里的两台电脑和 NAS 都是 2.5G 的网口和 WiFi6E 的无线网卡，想要 NAS 高速读写就需要 2.5G 以上的交换机；但是 2.5G 的交换机价格都在 400+，性价比不高</p><p>日常将四网口的 N5105 作为 HomeLab 的服务器使用，只有一个网口连接到路由器，其他三个网口空闲；因此想将 N5105 作为交换机，用于连接 NAS 和电脑；有三种方案：</p><ol><li>路由器和 N5105 做链路聚合，NAS连接到 N5105，电脑通过 WiFi 访问；速度能达到 2000Mbps，不过这样额外占用了两个网口，但是好处是所有的支持 WiFi6 的设备都能高速访问 NAS</li><li>不做链路聚合，这样能够多三个 2.5G 的网口；NAS 和电脑都通过网线连接到 N5105，通过网线连接的设备均能以 2.5G 的速度访问 NAS</li><li>为 N5105 添加 WiFi6E 无线网卡，并启用混杂模式，NAS 通过网线连接到 N5105，电脑通过 WiFi 访问 NAS；所有支持 WiFi6 的设备可以 2400Mbps 的速度访问 NAS；但是需要额外购买一张 WiFi6 的无线网卡，并且设备需要连接到 N5150 的 WiFi网络上</li></ol><p>基于以上考虑，不做链路聚合成本最低且能扩展网口，添加 WiFi6 网卡效果最好；因为手头没有 WiFi6 的网卡，因此先通过不做链路聚合的方式实现</p><h2 id=配置>配置</h2><h3 id=交换机方案>交换机方案</h3><p>有很多专业的开源或者收费的交换机方案，如 VyOS，Cumulus Linux，Open vSwitch（OVS）等，也可以基于 iKuai 或者 OpenWrt 等路由；
基于学习成本，维护成本，以及便捷性，最终选择 OpenWrt 作为交换机的方案（实际是路由器的 AP 模式）</p><h3 id=安装-openwrt>安装 OpenWrt</h3><p>在 Esxi/PVE 上安装 OpenWrt 的文档有很多，不再赘述；</p><p>建议使用最新的 OpenWrt 版本，当前最新的版本是 22.03.3，该版本已经支持了 Intel I225V 网卡，因此无需额外安装驱动；如果选择的是之前的版本，需要单独安装对应的驱动</p><h3 id=直通网卡>直通网卡</h3><p>在硬件中添加 PCI设备，将 PCI 网卡添加到 OpenWrt 中，作为 OpenWrt 的 LAN 口；WAN口是 PVE 虚拟机提供的虚拟网卡</p><p><img alt=homelab-openwrt-pve-switch-add-pci-devices.png src=https://img.hellowood.dev/picture/homelab-openwrt-pve-switch-add-pci-devices.png></p><h3 id=安装驱动>安装驱动</h3><h4 id=检查-pci-设备是否连接>检查 PCI 设备是否连接</h4><p>需要安装 <code>pciutils</code> 后才能查看 PCI 设备</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>opkg update 
</span></span><span style=display:flex><span>opkg install pciutils
</span></span></code></pre></div><p>通过 <code>lspci</code> 命令查看，发现连接没有问题</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lspci | grep Eth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>00:10.0 Ethernet controller: Intel Corporation Ethernet Controller I225-V <span style=color:#f92672>(</span>rev 03<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>00:11.0 Ethernet controller: Intel Corporation Ethernet Controller I225-V <span style=color:#f92672>(</span>rev 03<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>00:12.0 Ethernet controller: Red Hat, Inc. Virtio network device
</span></span><span style=display:flex><span>00:1b.0 Ethernet controller: Intel Corporation Ethernet Controller I225-V <span style=color:#f92672>(</span>rev 03<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=检查网口是否识别>检查网口是否识别</h4><p>查看网口是否成功识别，发现只有 <code>br-lan</code>, <code>eth0</code>, <code>lo</code> 三个网口；说明网卡的驱动没有安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l /sys/class/net/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lrwxrwxrwx    <span style=color:#ae81ff>1</span> root     root             <span style=color:#ae81ff>0</span> Mar <span style=color:#ae81ff>20</span> 08:00 br-lan -&gt; ../../devices/virtual/net/br-lan
</span></span><span style=display:flex><span>lrwxrwxrwx    <span style=color:#ae81ff>1</span> root     root             <span style=color:#ae81ff>0</span> Mar <span style=color:#ae81ff>20</span> 08:00 eth0 -&gt; ../../devices/pci0000:00/0000:00:12.0/virtio1/net/eth0
</span></span><span style=display:flex><span>lrwxrwxrwx    <span style=color:#ae81ff>1</span> root     root             <span style=color:#ae81ff>0</span> Mar <span style=color:#ae81ff>20</span> 08:00 lo -&gt; ../../devices/virtual/net/lo
</span></span></code></pre></div><h4 id=安装驱动-1>安装驱动</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>opkg update
</span></span><span style=display:flex><span>opkg install kmod-igc
</span></span></code></pre></div><p>安装完成后再次查看网口，发现多了 <code>eth1</code>, <code>eth2</code>,<code>eth3</code>，说明网口识别正确</p><pre tabindex=0><code>ls -l /sys/class/net/

lrwxrwxrwx    1 root     root             0 Mar 20 08:00 br-lan -&gt; ../../devices/virtual/net/br-lan
lrwxrwxrwx    1 root     root             0 Mar 20 08:00 eth0 -&gt; ../../devices/pci0000:00/0000:00:12.0/virtio1/net/eth0
lrwxrwxrwx    1 root     root             0 Mar 20 08:00 eth1 -&gt; ../../devices/pci0000:00/0000:00:10.0/net/eth1
lrwxrwxrwx    1 root     root             0 Mar 20 08:00 eth2 -&gt; ../../devices/pci0000:00/0000:00:11.0/net/eth2
lrwxrwxrwx    1 root     root             0 Mar 20 08:07 eth3 -&gt; ../../devices/pci0000:00/0000:00:1b.0/net/eth3
lrwxrwxrwx    1 root     root             0 Mar 20 08:00 lo -&gt; ../../devices/virtual/net/lo
</code></pre><h3 id=配置-openwrt>配置 OpenWrt</h3><p>进入 OpenWrt 配置界面，在网络-接口-设备，选择配置 <code>br-lan</code></p><p><img alt=homelab-openwrt-pve-switch-config-network-0.png src=https://img.hellowood.dev/picture/homelab-openwrt-pve-switch-config-network-0.png></p><p>在网桥端口中，将 <code>eth0</code>, <code>eth1</code>,<code>eth2</code>,<code>eth3</code>全部选中，作为网桥的桥接端口；然后点击保存并应用，这样就可以将 OpenWrt 作为交换机使用了</p><p><img alt=homelab-openwrt-pve-switch-config-network-1.png src=https://img.hellowood.dev/picture/homelab-openwrt-pve-switch-config-network-1.png></p><h2 id=测试>测试</h2><p>使用网线将 NAS 和电脑都连接到 N5105 的网口中，然后在 NAS 上通过 Docker 启动 <a href=https://github.com/librespeed/speedtest>adolfintel/speedtest</a>，在电脑上通过浏览器测试；测试结果能达到 2.5G 的速度</p><p><img alt=homelab-openwrt-pve-switch-speed-test.png src=https://img.hellowood.dev/picture/homelab-openwrt-pve-switch-speed-test.png></p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/n5105-promox-ve-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%A2%91%E7%B9%81%E6%AD%BB%E6%9C%BA%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>N5105 Promox VE 虚拟机频繁死机问题处理</span></a>
<a class=next href=https://blog.hellowood.dev/posts/openwrt-%E5%9C%A8-pve-%E4%B8%AD%E4%BB%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/><span>OpenWrt 在 PVE 中以虚拟机方式安装</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=related-resources><h3>Related Resources</h3><nav><ul><li><a href=/posts/openwrt-%E5%9C%A8-pve-%E4%B8%AD%E4%BB%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/>OpenWrt 在 PVE 中以虚拟机方式安装</a></li><li><a href=/posts/openwrt-%E4%BD%BF%E7%94%A8-lets-encrypt-%E8%AF%81%E4%B9%A6%E5%BC%80%E5%90%AF-https-%E8%AE%BF%E9%97%AE/>OpenWrt 使用 Lets Encrypt 证书开启 HTTPS 访问</a></li></ul></nav></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>