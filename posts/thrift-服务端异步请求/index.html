<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Thrift 服务端异步请求</title>
<meta charset=utf-8><meta name=description content="Ladder@Thrift 服务端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 服务端 Server @Slf4j public class AsyncServer { @SneakyThrows public static void main(String[] args) { HelloServiceAsyncImpl helloService = new HelloServiceAsyncImpl(); HelloService.AsyncProcessor<HelloService.AsyncIface> helloServiceProcessor = new HelloService.AsyncProcessor<>(helloService); TNonblockingServerTransport transport = new TNonblockingServerSocket(9090); // 配置参数以及处理器 TThreadedSelectorServer.Args serverArgs = new TThreadedSelectorServer.Args(transport) .selectorThreads(4) .workerThreads(10) ."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/thrift-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="Thrift 服务端异步请求"><meta property="og:description" content="Thrift 服务端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 服务端 Server @Slf4j public class AsyncServer { @SneakyThrows public static void main(String[] args) { HelloServiceAsyncImpl helloService = new HelloServiceAsyncImpl(); HelloService.AsyncProcessor<HelloService.AsyncIface> helloServiceProcessor = new HelloService.AsyncProcessor<>(helloService); TNonblockingServerTransport transport = new TNonblockingServerSocket(9090); // 配置参数以及处理器 TThreadedSelectorServer.Args serverArgs = new TThreadedSelectorServer.Args(transport) .selectorThreads(4) .workerThreads(10) ."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/thrift-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-01T22:34:46+00:00"><meta property="article:modified_time" content="2021-02-01T22:34:46+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Thrift 服务端异步请求"><meta name=twitter:description content="Thrift 服务端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 服务端 Server @Slf4j public class AsyncServer { @SneakyThrows public static void main(String[] args) { HelloServiceAsyncImpl helloService = new HelloServiceAsyncImpl(); HelloService.AsyncProcessor<HelloService.AsyncIface> helloServiceProcessor = new HelloService.AsyncProcessor<>(helloService); TNonblockingServerTransport transport = new TNonblockingServerSocket(9090); // 配置参数以及处理器 TThreadedSelectorServer.Args serverArgs = new TThreadedSelectorServer.Args(transport) .selectorThreads(4) .workerThreads(10) ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Thrift 服务端异步请求","item":"https://blog.hellowood.dev/posts/thrift-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Thrift 服务端异步请求","name":"Thrift 服务端异步请求","description":"Thrift 服务端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 服务端 Server @Slf4j public class AsyncServer { @SneakyThrows public static void main(String[] args) { HelloServiceAsyncImpl helloService = new HelloServiceAsyncImpl(); HelloService.AsyncProcessor\u0026lt;HelloService.AsyncIface\u0026gt; helloServiceProcessor = new HelloService.AsyncProcessor\u0026lt;\u0026gt;(helloService); TNonblockingServerTransport transport = new TNonblockingServerSocket(9090); // 配置参数以及处理器 TThreadedSelectorServer.Args serverArgs = new TThreadedSelectorServer.Args(transport) .selectorThreads(4) .workerThreads(10) .","keywords":["Thrift"],"articleBody":"Thrift 服务端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 服务端 Server @Slf4j public class AsyncServer { @SneakyThrows public static void main(String[] args) { HelloServiceAsyncImpl helloService = new HelloServiceAsyncImpl(); HelloService.AsyncProcessor\u003cHelloService.AsyncIface\u003e helloServiceProcessor = new HelloService.AsyncProcessor\u003c\u003e(helloService); TNonblockingServerTransport transport = new TNonblockingServerSocket(9090); // 配置参数以及处理器 TThreadedSelectorServer.Args serverArgs = new TThreadedSelectorServer.Args(transport) .selectorThreads(4) .workerThreads(10) .acceptQueueSizePerThread(20) .processor(helloServiceProcessor); TServer server = new TThreadedSelectorServer(serverArgs); server.serve(); } } 实现 实现类需要实现 AsyncIface 接口，方法定义中会有一个 AsyncMethodCallback，用于处理响应回调\n@Slf4j public class HelloServiceAsyncImpl implements HelloService.AsyncIface { @Override public void sayHello(HelloMessage request, AsyncMethodCallback\u003cHelloResponse\u003e resultHandler) throws TException { String message = request.getMessage(); log.info(\"接收到请求: {}\", message); HelloResponse response = new HelloResponse(); response.setMessage(\"Hello \" + message); resultHandler.onComplete(response); } } 请求处理流程 Server 端同步与异步处理的流程区别在于使用的 TProcessor 不同；同步使用 TProcessor，异步使用 TAsyncProcessor；除此之外，其他的流程与使用 NIO 的同步处理没有区别\n执行请求 org.apache.thrift.server.AbstractNonblockingServer.AsyncFrameBuffer#invoke 在处理读取事件时，会将 AsyncFrameBuffer 包装为 Runnable，提交给线程池执行；最终由 AsyncFrameBuffer 处理 会获取 Processor，然后调用 process 方法进行处理\npublic void invoke() { // 重置 Transport frameTrans_.reset(buffer_.array()); response_.reset(); try { // 触发事件 if (eventHandler_ != null) { eventHandler_.processContext(context_, inTrans_, outTrans_); } // 调用处理器处理 ((TAsyncProcessor) processorFactory_.getProcessor(inTrans_)).process(this); return; } catch (TException te) { LOGGER.warn(\"Exception while invoking!\", te); } catch (Throwable t) { LOGGER.error(\"Unexpected throwable while invoking!\", t); } // This will only be reached when there is a throwable. // 修改状态 state_ = FrameBufferState.AWAITING_CLOSE; requestSelectInterestChange(); } org.apache.thrift.TBaseAsyncProcessor#process(org.apache.thrift.server.AbstractNonblockingServer.AsyncFrameBuffer) 会读取消息，然后根据方法名称获取处理的类，然后获取调用回调，将请求信息和回调作为参数，调用处理函数处理请求\npublic void process(final AsyncFrameBuffer fb) throws TException { final TProtocol in = fb.getInputProtocol(); final TProtocol out = fb.getOutputProtocol(); // 读取消息 final TMessage msg = in.readMessageBegin(); // 获取处理函数 AsyncProcessFunction fn = processMap.get(msg.name); // 获取空参数 TBase args = fn.getEmptyArgsInstance(); // 读取参数 args.read(in); in.readMessageEnd(); // 如果是 oneway 调用，则完成 if (fn.isOneway()) { fb.responseReady(); } //start off processing function // 获取处理方法 AsyncMethodCallback resultHandler = fn.getResultHandler(fb, msg.seqid); try { // 处理调用 fn.start(iface, args, resultHandler); } catch (Exception e) { LOGGER.debug(\"Exception handling function\", e); resultHandler.onError(e); } return; } io.github.helloworlde.thrift.HelloService.AsyncProcessor.sayHello#start public void start(I iface, sayHello_args args, org.apache.thrift.async.AsyncMethodCallback\u003cHelloResponse\u003e resultHandler) throws org.apache.thrift.TException { iface.sayHello(args.request, resultHandler); } io.github.helloworlde.thrift.HelloServiceAsyncImpl#sayHello 然后会调用实现类，执行具体的处理逻辑；在处理完成后需要调用回调的相应方法\n@Slf4j public class HelloServiceAsyncImpl implements HelloService.AsyncIface { @Override public void sayHello(HelloMessage request, AsyncMethodCallback\u003cHelloResponse\u003e resultHandler) throws TException { String message = request.getMessage(); log.info(\"接收到请求: {}\", message); HelloResponse response = new HelloResponse(); response.setMessage(\"Hello \" + message); resultHandler.onComplete(response); } } 返回响应 org.apache.thrift.async.AsyncMethodCallback#onComplete 请求处理成功的回调，会将响应结果发送出去\npublic void onComplete(HelloResponse o) { sayHello_result result = new sayHello_result(); result.success = o; try { fcall.sendResponse(fb, result, org.apache.thrift.protocol.TMessageType.REPLY, seqid); } catch (org.apache.thrift.transport.TTransportException e) { _LOGGER.error(\"TTransportException writing to internal frame buffer\", e); fb.close(); } catch (java.lang.Exception e) { _LOGGER.error(\"Exception writing to internal frame buffer\", e); onError(e); } } org.apache.thrift.AsyncProcessFunction#sendResponse 将方法、消息类型，请求的 ID，响应内容按序写入，然后全部发送给传输层，由传输层发送给客户端；请求处理完成\npublic void sendResponse(final AbstractNonblockingServer.AsyncFrameBuffer fb, final TSerializable result, final byte type, final int seqid) throws TException { TProtocol oprot = fb.getOutputProtocol(); oprot.writeMessageBegin(new TMessage(getMethodName(), type, seqid)); result.write(oprot); oprot.writeMessageEnd(); oprot.getTransport().flush(); fb.responseReady(); } 参考文档 helloworlde/thrift-java-sample ","wordCount":"428","inLanguage":"en","datePublished":"2021-02-01T22:34:46Z","dateModified":"2021-02-01T22:34:46Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/thrift-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Thrift 服务端异步请求</h1></header><p><small>February 1, 2021&nbsp;· 428 words&nbsp;· 3 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#实现>实现</a><ul><li><a href=#idl>IDL</a></li><li><a href=#服务端>服务端</a></li></ul></li><li><a href=#请求处理流程>请求处理流程</a><ul><li><a href=#执行请求>执行请求</a></li><li><a href=#返回响应>返回响应</a></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div><section class=blog-content><h1 id=thrift-服务端异步请求>Thrift 服务端异步请求</h1><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#f92672>namespace</span> java io.github.helloworlde.thrift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>service</span> <span style=color:#a6e22e>HelloService</span> {
</span></span><span style=display:flex><span>    HelloResponse <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span>: HelloMessage request);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=服务端>服务端</h3><ul><li>Server</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AsyncServer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HelloServiceAsyncImpl helloService <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloServiceAsyncImpl();
</span></span><span style=display:flex><span>        HelloService.<span style=color:#a6e22e>AsyncProcessor</span><span style=color:#f92672>&lt;</span>HelloService.<span style=color:#a6e22e>AsyncIface</span><span style=color:#f92672>&gt;</span> helloServiceProcessor <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloService.<span style=color:#a6e22e>AsyncProcessor</span><span style=color:#f92672>&lt;&gt;</span>(helloService);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TNonblockingServerTransport transport <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TNonblockingServerSocket(9090);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配置参数以及处理器</span>
</span></span><span style=display:flex><span>        TThreadedSelectorServer.<span style=color:#a6e22e>Args</span> serverArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TThreadedSelectorServer.<span style=color:#a6e22e>Args</span>(transport)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>selectorThreads</span>(4)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>workerThreads</span>(10)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>acceptQueueSizePerThread</span>(20)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>processor</span>(helloServiceProcessor);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TServer server <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TThreadedSelectorServer(serverArgs);
</span></span><span style=display:flex><span>        server.<span style=color:#a6e22e>serve</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>实现</li></ul><p>实现类需要实现 <code>AsyncIface</code> 接口，方法定义中会有一个 <code>AsyncMethodCallback</code>，用于处理响应回调</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloServiceAsyncImpl</span> <span style=color:#66d9ef>implements</span> HelloService.<span style=color:#a6e22e>AsyncIface</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sayHello</span>(HelloMessage request, AsyncMethodCallback<span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;</span> resultHandler) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>        String message <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getMessage</span>();
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;接收到请求: {}&#34;</span>, message);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HelloResponse response <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloResponse();
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setMessage</span>(<span style=color:#e6db74>&#34;Hello &#34;</span> <span style=color:#f92672>+</span> message);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        resultHandler.<span style=color:#a6e22e>onComplete</span>(response);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><p>Server 端同步与异步处理的流程区别在于使用的 <code>TProcessor</code> 不同；同步使用 <code>TProcessor</code>，异步使用 <code>TAsyncProcessor</code>；除此之外，其他的流程与使用 NIO 的同步处理没有区别</p><h3 id=执行请求>执行请求</h3><ul><li>org.apache.thrift.server.AbstractNonblockingServer.AsyncFrameBuffer#invoke</li></ul><p>在处理读取事件时，会将 AsyncFrameBuffer 包装为 Runnable，提交给线程池执行；最终由 AsyncFrameBuffer 处理
会获取 Processor，然后调用 process 方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invoke</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重置 Transport</span>
</span></span><span style=display:flex><span>    frameTrans_.<span style=color:#a6e22e>reset</span>(buffer_.<span style=color:#a6e22e>array</span>());
</span></span><span style=display:flex><span>    response_.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 触发事件</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (eventHandler_ <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            eventHandler_.<span style=color:#a6e22e>processContext</span>(context_, inTrans_, outTrans_);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用处理器处理</span>
</span></span><span style=display:flex><span>        ((TAsyncProcessor) processorFactory_.<span style=color:#a6e22e>getProcessor</span>(inTrans_)).<span style=color:#a6e22e>process</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (TException te) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Exception while invoking!&#34;</span>, te);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Unexpected throwable while invoking!&#34;</span>, t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This will only be reached when there is a throwable.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改状态</span>
</span></span><span style=display:flex><span>    state_ <span style=color:#f92672>=</span> FrameBufferState.<span style=color:#a6e22e>AWAITING_CLOSE</span>;
</span></span><span style=display:flex><span>    requestSelectInterestChange();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TBaseAsyncProcessor#process(org.apache.thrift.server.AbstractNonblockingServer.AsyncFrameBuffer)</li></ul><p>会读取消息，然后根据方法名称获取处理的类，然后获取调用回调，将请求信息和回调作为参数，调用处理函数处理请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process</span>(<span style=color:#66d9ef>final</span> AsyncFrameBuffer fb) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> TProtocol in <span style=color:#f92672>=</span> fb.<span style=color:#a6e22e>getInputProtocol</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> TProtocol out <span style=color:#f92672>=</span> fb.<span style=color:#a6e22e>getOutputProtocol</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取消息</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> TMessage msg <span style=color:#f92672>=</span> in.<span style=color:#a6e22e>readMessageBegin</span>();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取处理函数</span>
</span></span><span style=display:flex><span>    AsyncProcessFunction fn <span style=color:#f92672>=</span> processMap.<span style=color:#a6e22e>get</span>(msg.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取空参数</span>
</span></span><span style=display:flex><span>    TBase args <span style=color:#f92672>=</span> fn.<span style=color:#a6e22e>getEmptyArgsInstance</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取参数</span>
</span></span><span style=display:flex><span>    args.<span style=color:#a6e22e>read</span>(in);
</span></span><span style=display:flex><span>    in.<span style=color:#a6e22e>readMessageEnd</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是 oneway 调用，则完成</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (fn.<span style=color:#a6e22e>isOneway</span>()) {
</span></span><span style=display:flex><span>        fb.<span style=color:#a6e22e>responseReady</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//start off processing function</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取处理方法</span>
</span></span><span style=display:flex><span>    AsyncMethodCallback resultHandler <span style=color:#f92672>=</span> fn.<span style=color:#a6e22e>getResultHandler</span>(fb, msg.<span style=color:#a6e22e>seqid</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理调用</span>
</span></span><span style=display:flex><span>        fn.<span style=color:#a6e22e>start</span>(iface, args, resultHandler);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Exception handling function&#34;</span>, e);
</span></span><span style=display:flex><span>        resultHandler.<span style=color:#a6e22e>onError</span>(e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.AsyncProcessor.sayHello#start</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>(I iface, sayHello_args args, org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>async</span>.<span style=color:#a6e22e>AsyncMethodCallback</span><span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;</span> resultHandler) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>    iface.<span style=color:#a6e22e>sayHello</span>(args.<span style=color:#a6e22e>request</span>, resultHandler);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloServiceAsyncImpl#sayHello</li></ul><p>然后会调用实现类，执行具体的处理逻辑；在处理完成后需要调用回调的相应方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloServiceAsyncImpl</span> <span style=color:#66d9ef>implements</span> HelloService.<span style=color:#a6e22e>AsyncIface</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sayHello</span>(HelloMessage request, AsyncMethodCallback<span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;</span> resultHandler) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>        String message <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getMessage</span>();
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;接收到请求: {}&#34;</span>, message);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HelloResponse response <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloResponse();
</span></span><span style=display:flex><span>        response.<span style=color:#a6e22e>setMessage</span>(<span style=color:#e6db74>&#34;Hello &#34;</span> <span style=color:#f92672>+</span> message);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        resultHandler.<span style=color:#a6e22e>onComplete</span>(response);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=返回响应>返回响应</h3><ul><li>org.apache.thrift.async.AsyncMethodCallback#onComplete</li></ul><p>请求处理成功的回调，会将响应结果发送出去</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onComplete</span>(HelloResponse o) {
</span></span><span style=display:flex><span>    sayHello_result result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_result();
</span></span><span style=display:flex><span>    result.<span style=color:#a6e22e>success</span> <span style=color:#f92672>=</span> o;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        fcall.<span style=color:#a6e22e>sendResponse</span>(fb, result, org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TMessageType</span>.<span style=color:#a6e22e>REPLY</span>, seqid);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>transport</span>.<span style=color:#a6e22e>TTransportException</span> e) {
</span></span><span style=display:flex><span>        _LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;TTransportException writing to internal frame buffer&#34;</span>, e);
</span></span><span style=display:flex><span>        fb.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>Exception</span> e) {
</span></span><span style=display:flex><span>        _LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Exception writing to internal frame buffer&#34;</span>, e);
</span></span><span style=display:flex><span>        onError(e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.AsyncProcessFunction#sendResponse</li></ul><p>将方法、消息类型，请求的 ID，响应内容按序写入，然后全部发送给传输层，由传输层发送给客户端；请求处理完成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendResponse</span>(<span style=color:#66d9ef>final</span> AbstractNonblockingServer.<span style=color:#a6e22e>AsyncFrameBuffer</span> fb, <span style=color:#66d9ef>final</span> TSerializable result, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span> type, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> seqid) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    TProtocol oprot <span style=color:#f92672>=</span> fb.<span style=color:#a6e22e>getOutputProtocol</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeMessageBegin</span>(<span style=color:#66d9ef>new</span> TMessage(getMethodName(), type, seqid));
</span></span><span style=display:flex><span>    result.<span style=color:#a6e22e>write</span>(oprot);
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeMessageEnd</span>();
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>getTransport</span>().<span style=color:#a6e22e>flush</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fb.<span style=color:#a6e22e>responseReady</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-transport/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>Thrift 中的 Transport</span></a>
<a class=next href=https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-protocol/><span>Thrift 中的 Protocol</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>