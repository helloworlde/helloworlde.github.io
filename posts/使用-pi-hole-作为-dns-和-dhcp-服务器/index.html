<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>使用 Pi-hole 作为 DNS 和 DHCP 服务器</title>
<meta name=description content="在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多
另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以 …"><meta name=keywords content='blog,hugo,Pi-hole,Docker,DNS,DHCP,HomeLab'><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="og:type" content="website"><meta property="og:title" content="使用 Pi-hole 作为 DNS 和 DHCP 服务器"><meta property="og:description" content="在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多
另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以 …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="使用 Pi-hole 作为 DNS 和 DHCP 服务器"><meta name=twitter:description content="在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多
另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以 …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>使用 Pi-hole 作为 DNS 和 DHCP 服务器</h1><small role=doc-subtitle></small><p class=post-date>2022-09-05</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/pi-hole>Pi-hole</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/docker>Docker</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/dns>DNS</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/dhcp>DHCP</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li></ul></div><div class=post-content><p>在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多</p><p>另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供</p><h2 id=配置-docker-macvlan-网络>配置 Docker macvlan 网络</h2><p>因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 <code>macvlan</code> 作为 Docker 网络的驱动</p><p><code>macvlan</code> 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP</p><p>通过 <code>macvlan</code>，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问</p><ul><li>开启网卡混杂模式</li></ul><p>默认情况下网卡只会将发送给本机的包传递到上层服务，其他的包一律丢弃；开启混杂模式后机器的网卡能够接收所有流经过它的数据流，而无论其目的地址是否是它，因此，为了能让 Docker 容器能正常收到其他设备的请求，需要开启网卡混杂模式；需要注意 <code>eth0</code> 要和实际的网卡名称一致</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ip link <span style=color:#ef8383>set</span> eth0 promisc on
</span></span></code></pre></div><ul><li>创建 macvlan 网络</li></ul><p>创建 macvlan 网络时，指定其 IP 范围和网关，与局域网一致，方便直接访问</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create -d macvlan --subnet<span style=color:#c7bf54>=</span>192.168.2.0/24 --gateway<span style=color:#c7bf54>=</span>192.168.2.1 -o <span style=color:#dcaeea>parent</span><span style=color:#c7bf54>=</span>eth0 macnet
</span></span></code></pre></div><h2 id=安装配置-smartdns>安装配置 Smartdns</h2><p>以容器的方式运行 Smartdns，在配置中指定其上游 DNS</p><ul><li>smartdns.conf</li></ul><p>在配置中添加了常用的 DNS 服务商作为上游 DNS ，可以通过 ping 的方式检查响应延时，删除超时的 DNS 上游</p><p>建议不要开启 IPV6，也不要使用 IPV6 地址作为 DNS 解析，开启后会导致网络非常明显的变慢</p><pre tabindex=0><code>#https://github.com/pymumu/smartdns/blob/master/etc/smartdns/smartdns.conf
# 服务器名称
sever-name smartdns
# 监听端口号
bind-tcp [::]:53
bind [::]:53

# TCP 链接空闲超时时间
tcp-idle-time 3
# 域名结果缓存个数
cache-size 0
# 域名预先获取功能
prefetch-domain yes
# 过期缓存服务功能
serve-expired yes
# 过期缓存服务最长超时时间
serve-expired-ttl 0

# 测速模式选择
speed-check-mode tcp:80,tcp:443,ping
# 首次查询响应模式 fisrt-ping|fastest-ip|fastest-response
response-mode first-ping

# TTL 值
rr-ttl-min 60
rr-ttl-max 86400

# 禁止使用 IPV6 解析
force-AAAA-SOA yes
# 双栈选优
# dualstack-ip-selection yes

# 上游 UDP DNS
server 223.5.5.5
server 119.29.29.29
server 172.20.64.240
server 192.168.4.251
server 8.8.8.8 -blacklist-ip -check-edns

# 上游 TCP DNS
server-tcp 223.5.5.5
server-tcp 223.6.6.6
server-tcp 119.29.29.29
server-tcp 64.6.64.6
server-tcp 114.114.114.119
# 上游 TLS DNS
server-tls 1.1.1.1
server-tls 8.8.4.4
server-tls 9.9.9.9
# 上游 HTTPS DNS
server-https https://cloudflare-dns.com/dns-query
</code></pre><ul><li>启动 Smardns 容器</li></ul><p>在启动容器时指定 IP 地址为局域网内不冲突的固定 IP 地址；同时挂载配置文件到容器中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --restart always <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>--name smartdns <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>-d --network macnet <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>--ip 192.168.2.21 <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>-v /workspace/smartdns/:/smartdns <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>ghostry/smartdns
</span></span></code></pre></div><p>在启动完成后，使用 <code>telnet</code> 检查是否可以正常访问 53 端口</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>telnet 192.168.2.21 <span style=color:#d19a66>53</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Trying ::1...
</span></span><span style=display:flex><span>Connected to 192.168.2.20.
</span></span><span style=display:flex><span>Escape character is <span style=color:#98c379>&#39;^]&#39;</span>.
</span></span></code></pre></div><h2 id=安装配置-pi-hole>安装配置 Pi-hole</h2><ul><li>启动 Pi-hole 容器</li></ul><p>启动 Pi-hole 时同样需要指定 IP 地址</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --restart always <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>--name pihole <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>-d --network macnet <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>--ip 192.168.2.20 <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>pihole/pihole
</span></span></code></pre></div><p>启动后访问 Pi-hole 的管理界面 <a href=http://192.168.2.20/admin>http://192.168.2.20/admin</a>，这时需要提供访问密码，可以进入到容器中进行修改</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker <span style=color:#ef8383>exec</span> -it pihole bash
</span></span></code></pre></div><p>修改密码</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo pihole -a -p
</span></span></code></pre></div><p><img src=https://img.hellowood.dev/picture/homelab-dns-pihole-dashboard.png alt=homelab-dns-pihole-dashboard.png></p><ul><li>配置 Smartdns 作为上游服务器</li></ul><p>在 Settings - DNS 中，配置上游的 DNS 服务，将 Smartdns 作为第一个上游服务服务；同时可以添加其他 DNS 服务，避免在 Smartdns 出现问题时使用其他 DNS 服务器
修改接口配置，允许所有的查询来源</p><p><img src=https://img.hellowood.dev/picture/homelab-pihole-dns-upstream-config.png alt=homelab-pihole-dns-upstream-config.png></p><ul><li>配置 DHCP</li></ul><p>在 Settings - DNS 中，启用 DHCP，指定分配的 IP 范围、路由器地址、本地域名以及 DHCP 过期时间</p><p><img src=https://img.hellowood.dev/picture/homelab-pihole-dhcp-config.png alt=homelab-pihole-dhcp-config.png></p><h2 id=路由器配置-dhcp-和-dns-服务>路由器配置 DHCP 和 DNS 服务</h2><p>在路由器配置中， 选择关闭 DHCP，并指定 DNS 为 Pi-hole 的地址，重启路由器后，即可生效</p><ul><li>关闭 DHCP</li></ul><p>在网络-接口-LAN 中选择忽略此接口</p><p><img src=https://img.hellowood.dev/picture/homelab-pihole-openwrt-close-dhcp-config.png alt=homelab-pihole-openwrt-close-dhcp-config.png></p><ul><li>配置 DNS</li></ul><p>在网络-接口-LAN 配置中，将自定义的 DNS 服务器指向 Pi-hole 的地址</p><p><img src=https://img.hellowood.dev/picture/homelab-pihole-openwrt-dns-config.png alt=homelab-pihole-openwrt-dns-config.png></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2022 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>