<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 Pi-hole 作为 DNS 和 DHCP 服务器</title><meta charset=utf-8><meta name=description content="Ladder@@(HomeLab)[Pi-hole]
使用 Pi-hole 作为 DNS 和 DHCP 服务器 在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多
另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供
配置 Docker macvlan 网络 因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 macvlan 作为 Docker 网络的驱动
macvlan 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP
通过 macvlan，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/umami.js></script><meta property="og:title" content="使用 Pi-hole 作为 DNS 和 DHCP 服务器"><meta property="og:description" content="@(HomeLab)[Pi-hole]
使用 Pi-hole 作为 DNS 和 DHCP 服务器 在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多
另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供
配置 Docker macvlan 网络 因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 macvlan 作为 Docker 网络的驱动
macvlan 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP
通过 macvlan，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-05T11:32:08+00:00"><meta property="article:modified_time" content="2022-09-05T11:32:08+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Pi-hole 作为 DNS 和 DHCP 服务器"><meta name=twitter:description content="@(HomeLab)[Pi-hole]
使用 Pi-hole 作为 DNS 和 DHCP 服务器 在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多
另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供
配置 Docker macvlan 网络 因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 macvlan 作为 Docker 网络的驱动
macvlan 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP
通过 macvlan，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"使用 Pi-hole 作为 DNS 和 DHCP 服务器","item":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 Pi-hole 作为 DNS 和 DHCP 服务器","name":"使用 Pi-hole 作为 DNS 和 DHCP 服务器","description":"@(HomeLab)[Pi-hole]\n使用 Pi-hole 作为 DNS 和 DHCP 服务器 在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多\n另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供\n配置 Docker macvlan 网络 因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 macvlan 作为 Docker 网络的驱动\nmacvlan 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP\n通过 macvlan，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问","keywords":["Pi-hole","Docker","DNS","DHCP","HomeLab"],"articleBody":"@(HomeLab)[Pi-hole]\n使用 Pi-hole 作为 DNS 和 DHCP 服务器 在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多\n另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供\n配置 Docker macvlan 网络 因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 macvlan 作为 Docker 网络的驱动\nmacvlan 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP\n通过 macvlan，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问\n开启网卡混杂模式 默认情况下网卡只会将发送给本机的包传递到上层服务，其他的包一律丢弃；开启混杂模式后机器的网卡能够接收所有流经过它的数据流，而无论其目的地址是否是它，因此，为了能让 Docker 容器能正常收到其他设备的请求，需要开启网卡混杂模式；需要注意 eth0 要和实际的网卡名称一致\nsudo ip link set eth0 promisc on 创建 macvlan 网络 创建 macvlan 网络时，指定其 IP 范围和网关，与局域网一致，方便直接访问\ndocker network create -d macvlan --subnet=192.168.2.0/24 --gateway=192.168.2.1 -o parent=eth0 macnet 安装配置 Smartdns 以容器的方式运行 Smartdns，在配置中指定其上游 DNS\nsmartdns.conf 在配置中添加了常用的 DNS 服务商作为上游 DNS ，可以通过 ping 的方式检查响应延时，删除超时的 DNS 上游\n建议不要开启 IPV6，也不要使用 IPV6 地址作为 DNS 解析，开启后会导致网络非常明显的变慢\n#https://github.com/pymumu/smartdns/blob/master/etc/smartdns/smartdns.conf # 服务器名称 sever-name smartdns # 监听端口号 bind-tcp [::]:53 bind [::]:53 # TCP 链接空闲超时时间 tcp-idle-time 3 # 域名结果缓存个数 cache-size 0 # 域名预先获取功能 prefetch-domain yes # 过期缓存服务功能 serve-expired yes # 过期缓存服务最长超时时间 serve-expired-ttl 0 # 测速模式选择 speed-check-mode tcp:80,tcp:443,ping # 首次查询响应模式 fisrt-ping|fastest-ip|fastest-response response-mode first-ping # TTL 值 rr-ttl-min 60 rr-ttl-max 86400 # 禁止使用 IPV6 解析 force-AAAA-SOA yes # 双栈选优 # dualstack-ip-selection yes # 上游 UDP DNS server 223.5.5.5 server 119.29.29.29 server 172.20.64.240 server 192.168.4.251 server 8.8.8.8 -blacklist-ip -check-edns # 上游 TCP DNS server-tcp 223.5.5.5 server-tcp 223.6.6.6 server-tcp 119.29.29.29 server-tcp 64.6.64.6 server-tcp 114.114.114.119 # 上游 TLS DNS server-tls 1.1.1.1 server-tls 8.8.4.4 server-tls 9.9.9.9 # 上游 HTTPS DNS server-https https://cloudflare-dns.com/dns-query 启动 Smardns 容器 在启动容器时指定 IP 地址为局域网内不冲突的固定 IP 地址；同时挂载配置文件到容器中\ndocker run --restart always \\ --name smartdns \\ -d --network macnet \\ --ip 192.168.2.21 \\ -v /workspace/smartdns/:/smartdns \\ ghostry/smartdns 在启动完成后，使用 telnet 检查是否可以正常访问 53 端口\ntelnet 192.168.2.21 53 Trying ::1... Connected to 192.168.2.20. Escape character is '^]'. 安装配置 Pi-hole 启动 Pi-hole 容器 启动 Pi-hole 时同样需要指定 IP 地址\ndocker run --restart always \\ --name pihole \\ -d --network macnet \\ --ip 192.168.2.20 \\ pihole/pihole 启动后访问 Pi-hole 的管理界面 http://192.168.2.20/admin，这时需要提供访问密码，可以进入到容器中进行修改\ndocker exec -it pihole bash 修改密码\nsudo pihole -a -p 配置 Smartdns 作为上游服务器 在 Settings - DNS 中，配置上游的 DNS 服务，将 Smartdns 作为第一个上游服务服务；同时可以添加其他 DNS 服务，避免在 Smartdns 出现问题时使用其他 DNS 服务器 修改接口配置，允许所有的查询来源\n配置 DHCP 在 Settings - DNS 中，启用 DHCP，指定分配的 IP 范围、路由器地址、本地域名以及 DHCP 过期时间\n路由器配置 DHCP 和 DNS 服务 在路由器配置中， 选择关闭 DHCP，并指定 DNS 为 Pi-hole 的地址，重启路由器后，即可生效\n关闭 DHCP 在网络-接口-LAN 中选择忽略此接口\n配置 DNS 在网络-接口-LAN 配置中，将自定义的 DNS 服务器指向 Pi-hole 的地址\n","wordCount":"371","inLanguage":"en","datePublished":"2022-09-05T11:32:08Z","dateModified":"2022-09-05T11:32:08Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-pi-hole-%E4%BD%9C%E4%B8%BA-dns-%E5%92%8C-dhcp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c098d85b5396dec4707ea2cead1445b4dc2ff0fc56b8dbbd9049d0d1c50ad237.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/r2Llssnu/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>使用 Pi-hole 作为 DNS 和 DHCP 服务器</h1></header><p><small>September 5, 2022&nbsp;· 371 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#配置-docker-macvlan-网络>配置 Docker macvlan 网络</a></li><li><a href=#安装配置-smartdns>安装配置 Smartdns</a></li><li><a href=#安装配置-pi-hole>安装配置 Pi-hole</a></li><li><a href=#路由器配置-dhcp-和-dns-服务>路由器配置 DHCP 和 DNS 服务</a></li></ul></nav></div><section class=blog-content><p>@(HomeLab)[Pi-hole]</p><h1 id=使用-pi-hole-作为-dns-和-dhcp-服务器>使用 Pi-hole 作为 DNS 和 DHCP 服务器</h1><p>在使用 OpenWrt 的过程中，因为会经常修改 OpenWrt 的配置，导致 OpenWrt 出问题重新安装后没有来得及备份的配置丢失；其中以 IP 地址静态分配最多</p><p>另外，因为需要通过 DNS 做广告拦截，所以需要使用 Pi-hole 作为 DNS 服务器，但是 Pi-hole 提供的 DNS 服务都是国外的，所以为了快速解析国内的 DNS，需要使用 Smartdns 作为 Pi-hole DNS 的上游；DNS 的解析在 Smartdns 中提供</p><h2 id=配置-docker-macvlan-网络>配置 Docker macvlan 网络</h2><p>因为在同一个服务器上提供了多个服务，因此存在端口冲突问题，Pi-hole 和 Smartdns 都需要 53 端口用于提供 DNS，而且 53 端口默认被 Ubuntu Server 使用；而且局域网中的设备需要访问 DHCP 服务，因此为了避免冲突，需要使用 <code>macvlan</code> 作为 Docker 网络的驱动</p><p><code>macvlan</code> 是一种网卡虚拟化技术，允许在同一个物理网卡上配置多个 MAC 地址，即多个 interface，每个 interface 可以配置自己的 IP</p><p>通过 <code>macvlan</code>，可以为每个 Docker 容器提供特定的 IP 地址，用于局域网内的设置直接通过容器的 IP 地址访问</p><ul><li>开启网卡混杂模式</li></ul><p>默认情况下网卡只会将发送给本机的包传递到上层服务，其他的包一律丢弃；开启混杂模式后机器的网卡能够接收所有流经过它的数据流，而无论其目的地址是否是它，因此，为了能让 Docker 容器能正常收到其他设备的请求，需要开启网卡混杂模式；需要注意 <code>eth0</code> 要和实际的网卡名称一致</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ip link set eth0 promisc on
</span></span></code></pre></div><ul><li>创建 macvlan 网络</li></ul><p>创建 macvlan 网络时，指定其 IP 范围和网关，与局域网一致，方便直接访问</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create -d macvlan --subnet<span style=color:#f92672>=</span>192.168.2.0/24 --gateway<span style=color:#f92672>=</span>192.168.2.1 -o parent<span style=color:#f92672>=</span>eth0 macnet
</span></span></code></pre></div><h2 id=安装配置-smartdns>安装配置 Smartdns</h2><p>以容器的方式运行 Smartdns，在配置中指定其上游 DNS</p><ul><li>smartdns.conf</li></ul><p>在配置中添加了常用的 DNS 服务商作为上游 DNS ，可以通过 ping 的方式检查响应延时，删除超时的 DNS 上游</p><p>建议不要开启 IPV6，也不要使用 IPV6 地址作为 DNS 解析，开启后会导致网络非常明显的变慢</p><pre tabindex=0><code>#https://github.com/pymumu/smartdns/blob/master/etc/smartdns/smartdns.conf
# 服务器名称
sever-name smartdns
# 监听端口号
bind-tcp [::]:53
bind [::]:53

# TCP 链接空闲超时时间
tcp-idle-time 3
# 域名结果缓存个数
cache-size 0
# 域名预先获取功能
prefetch-domain yes
# 过期缓存服务功能
serve-expired yes
# 过期缓存服务最长超时时间
serve-expired-ttl 0

# 测速模式选择
speed-check-mode tcp:80,tcp:443,ping
# 首次查询响应模式 fisrt-ping|fastest-ip|fastest-response
response-mode first-ping

# TTL 值
rr-ttl-min 60
rr-ttl-max 86400

# 禁止使用 IPV6 解析
force-AAAA-SOA yes
# 双栈选优
# dualstack-ip-selection yes

# 上游 UDP DNS
server 223.5.5.5
server 119.29.29.29
server 172.20.64.240
server 192.168.4.251
server 8.8.8.8 -blacklist-ip -check-edns

# 上游 TCP DNS
server-tcp 223.5.5.5
server-tcp 223.6.6.6
server-tcp 119.29.29.29
server-tcp 64.6.64.6
server-tcp 114.114.114.119
# 上游 TLS DNS
server-tls 1.1.1.1
server-tls 8.8.4.4
server-tls 9.9.9.9
# 上游 HTTPS DNS
server-https https://cloudflare-dns.com/dns-query
</code></pre><ul><li>启动 Smardns 容器</li></ul><p>在启动容器时指定 IP 地址为局域网内不冲突的固定 IP 地址；同时挂载配置文件到容器中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--name smartdns <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-d --network macnet <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--ip 192.168.2.21 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-v /workspace/smartdns/:/smartdns <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>ghostry/smartdns
</span></span></code></pre></div><p>在启动完成后，使用 <code>telnet</code> 检查是否可以正常访问 53 端口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>telnet 192.168.2.21 <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Trying ::1...
</span></span><span style=display:flex><span>Connected to 192.168.2.20.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span></code></pre></div><h2 id=安装配置-pi-hole>安装配置 Pi-hole</h2><ul><li>启动 Pi-hole 容器</li></ul><p>启动 Pi-hole 时同样需要指定 IP 地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--name pihole <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-d --network macnet <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--ip 192.168.2.20 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>pihole/pihole
</span></span></code></pre></div><p>启动后访问 Pi-hole 的管理界面 <a href=http://192.168.2.20/admin>http://192.168.2.20/admin</a>，这时需要提供访问密码，可以进入到容器中进行修改</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it pihole bash
</span></span></code></pre></div><p>修改密码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo pihole -a -p
</span></span></code></pre></div><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-dns-pihole-dashboard.png alt=homelab-dns-pihole-dashboard.png></p><ul><li>配置 Smartdns 作为上游服务器</li></ul><p>在 Settings - DNS 中，配置上游的 DNS 服务，将 Smartdns 作为第一个上游服务服务；同时可以添加其他 DNS 服务，避免在 Smartdns 出现问题时使用其他 DNS 服务器
修改接口配置，允许所有的查询来源</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-pihole-dns-upstream-config.png alt=homelab-pihole-dns-upstream-config.png></p><ul><li>配置 DHCP</li></ul><p>在 Settings - DNS 中，启用 DHCP，指定分配的 IP 范围、路由器地址、本地域名以及 DHCP 过期时间</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-pihole-dhcp-config.png alt=homelab-pihole-dhcp-config.png></p><h2 id=路由器配置-dhcp-和-dns-服务>路由器配置 DHCP 和 DNS 服务</h2><p>在路由器配置中， 选择关闭 DHCP，并指定 DNS 为 Pi-hole 的地址，重启路由器后，即可生效</p><ul><li>关闭 DHCP</li></ul><p>在网络-接口-LAN 中选择忽略此接口</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-pihole-openwrt-close-dhcp-config.png alt=homelab-pihole-openwrt-close-dhcp-config.png></p><ul><li>配置 DNS</li></ul><p>在网络-接口-LAN 配置中，将自定义的 DNS 服务器指向 Pi-hole 的地址</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-pihole-openwrt-dns-config.png alt=homelab-pihole-openwrt-dns-config.png></p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/esxi-%E6%8C%82%E8%BD%BD%E7%89%A9%E7%90%86%E7%A3%81%E7%9B%98%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA/><span>&larr;&nbsp;&nbsp;</span><span>Esxi 挂载物理磁盘到虚拟机</span></a>
<a class=next href=https://blog.hellowood.dev/posts/openwrt-ddns-%E9%85%8D%E7%BD%AE/><span>Openwrt-DDNS 配置</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>