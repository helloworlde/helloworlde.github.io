<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>HPA 使用自定义的指标自动扩缩容</title><meta charset=utf-8><meta name=description content="Ladder@HPA 使用自定义的指标自动扩缩容 Kubernetes 支持使用自定义的指标作为 HPA 的依据；
KEDA 是基于事件驱动的自动扩缩容组件；主要有两部分：
Agent: 用于触发和停用扩缩容，通过 keda-operator 实现 Metrics: 用于收集指标，提供给 Agent，通过 keda-operator-metrics-apiserver 实现 KEDA 适配了多个组件，支持从 Prometheus、MySQL、MQ、Redis、自定义的组件等获取指标
前提 环境中安装了 metrics-server
安装 KEDA 组件 helm repo add kedacore https://kedacore.github.io/charts helm repo update​ kubectl create namespace keda helm install keda kedacore/keda --namespace keda 安装完成后会看到相关的组件
kubectl get all -n keda ​ NAME READY STATUS RESTARTS AGE pod/keda-operator-6b7f8d7b46-tb69x 1/1 Running 0 160m pod/keda-operator-metrics-apiserver-58657d68db-bs94r 1/1 Running 0 160m ​ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/keda-operator-metrics ClusterIP 192."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/hpa-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%8C%87%E6%A0%87%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script>
<script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="HPA 使用自定义的指标自动扩缩容"><meta property="og:description" content="HPA 使用自定义的指标自动扩缩容 Kubernetes 支持使用自定义的指标作为 HPA 的依据；
KEDA 是基于事件驱动的自动扩缩容组件；主要有两部分：
Agent: 用于触发和停用扩缩容，通过 keda-operator 实现 Metrics: 用于收集指标，提供给 Agent，通过 keda-operator-metrics-apiserver 实现 KEDA 适配了多个组件，支持从 Prometheus、MySQL、MQ、Redis、自定义的组件等获取指标
前提 环境中安装了 metrics-server
安装 KEDA 组件 helm repo add kedacore https://kedacore.github.io/charts helm repo update​ kubectl create namespace keda helm install keda kedacore/keda --namespace keda 安装完成后会看到相关的组件
kubectl get all -n keda ​ NAME READY STATUS RESTARTS AGE pod/keda-operator-6b7f8d7b46-tb69x 1/1 Running 0 160m pod/keda-operator-metrics-apiserver-58657d68db-bs94r 1/1 Running 0 160m ​ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/keda-operator-metrics ClusterIP 192."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/hpa-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%8C%87%E6%A0%87%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-20T22:36:15+00:00"><meta property="article:modified_time" content="2020-09-20T22:36:15+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="HPA 使用自定义的指标自动扩缩容"><meta name=twitter:description content="HPA 使用自定义的指标自动扩缩容 Kubernetes 支持使用自定义的指标作为 HPA 的依据；
KEDA 是基于事件驱动的自动扩缩容组件；主要有两部分：
Agent: 用于触发和停用扩缩容，通过 keda-operator 实现 Metrics: 用于收集指标，提供给 Agent，通过 keda-operator-metrics-apiserver 实现 KEDA 适配了多个组件，支持从 Prometheus、MySQL、MQ、Redis、自定义的组件等获取指标
前提 环境中安装了 metrics-server
安装 KEDA 组件 helm repo add kedacore https://kedacore.github.io/charts helm repo update​ kubectl create namespace keda helm install keda kedacore/keda --namespace keda 安装完成后会看到相关的组件
kubectl get all -n keda ​ NAME READY STATUS RESTARTS AGE pod/keda-operator-6b7f8d7b46-tb69x 1/1 Running 0 160m pod/keda-operator-metrics-apiserver-58657d68db-bs94r 1/1 Running 0 160m ​ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/keda-operator-metrics ClusterIP 192."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"HPA 使用自定义的指标自动扩缩容","item":"https://blog.hellowood.dev/posts/hpa-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%8C%87%E6%A0%87%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HPA 使用自定义的指标自动扩缩容","name":"HPA 使用自定义的指标自动扩缩容","description":"HPA 使用自定义的指标自动扩缩容 Kubernetes 支持使用自定义的指标作为 HPA 的依据；\nKEDA 是基于事件驱动的自动扩缩容组件；主要有两部分：\nAgent: 用于触发和停用扩缩容，通过 keda-operator 实现 Metrics: 用于收集指标，提供给 Agent，通过 keda-operator-metrics-apiserver 实现 KEDA 适配了多个组件，支持从 Prometheus、MySQL、MQ、Redis、自定义的组件等获取指标\n前提 环境中安装了 metrics-server\n安装 KEDA 组件 helm repo add kedacore https://kedacore.github.io/charts helm repo update​ kubectl create namespace keda helm install keda kedacore/keda --namespace keda 安装完成后会看到相关的组件\nkubectl get all -n keda ​ NAME READY STATUS RESTARTS AGE pod/keda-operator-6b7f8d7b46-tb69x 1/1 Running 0 160m pod/keda-operator-metrics-apiserver-58657d68db-bs94r 1/1 Running 0 160m ​ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/keda-operator-metrics ClusterIP 192.","keywords":["Kubernetes"],"articleBody":"HPA 使用自定义的指标自动扩缩容 Kubernetes 支持使用自定义的指标作为 HPA 的依据；\nKEDA 是基于事件驱动的自动扩缩容组件；主要有两部分：\nAgent: 用于触发和停用扩缩容，通过 keda-operator 实现 Metrics: 用于收集指标，提供给 Agent，通过 keda-operator-metrics-apiserver 实现 KEDA 适配了多个组件，支持从 Prometheus、MySQL、MQ、Redis、自定义的组件等获取指标\n前提 环境中安装了 metrics-server\n安装 KEDA 组件 helm repo add kedacore https://kedacore.github.io/charts helm repo update​ kubectl create namespace keda helm install keda kedacore/keda --namespace keda 安装完成后会看到相关的组件\nkubectl get all -n keda ​ NAME READY STATUS RESTARTS AGE pod/keda-operator-6b7f8d7b46-tb69x 1/1 Running 0 160m pod/keda-operator-metrics-apiserver-58657d68db-bs94r 1/1 Running 0 160m ​ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/keda-operator-metrics ClusterIP 192.168.68.139 8383/TCP,8686/TCP 159m service/keda-operator-metrics-apiserver ClusterIP 192.168.106.114 443/TCP,80/TCP 160m ​ NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/keda-operator 1/1 1 1 160m deployment.apps/keda-operator-metrics-apiserver 1/1 1 1 160m ​ NAME DESIRED CURRENT READY AGE replicaset.apps/keda-operator-6b7f8d7b46 1 1 1 160m replicaset.apps/keda-operator-metrics-apiserver-58657d68db 1 1 1 160m 测试 创建 HPA kubectl apply -f demo-api-hpa.yaml 为 demo 配置 Service，用于访问请求 apiVersion: v1 kind: Service metadata: labels: app: demo name: demo namespace: develop spec: ports: - nodePort: 30088 port: 8080 protocol: TCP targetPort: 8080 selector: app: demo type: NodePort 配置 KEDA 对象 apiVersion: keda.k8s.io/v1alpha1 kind: ScaledObject metadata: name: demo namespace: develop spec: scaleTargetRef: deploymentName: demo namespace: develop pollingInterval: 15 cooldownPeriod: 60 minReplicaCount: 1 maxReplicaCount: 10 triggers: - type: prometheus metadata: serverAddress: http://prometheus.local metricName: http_requests_per_min threshold: '10' query: sum(rate(http_server_requests_seconds_count{application=\"demo\"}[1m])) poolingInterval: 从 triggers 拉取的周期 colldownPeriod: 缩容的等待时间，从最后一次超过阈值的 tirgger minReplicaCount: 扩缩容最小的 Pod 数量 maxReplicaCount: 扩缩容最大的 Pod 数量 triggers: 触发器，定义指标 type: 数据来源，支持 Prometheus、MySQL、MQ、Redis、自定义扩展等 metricName: 定义当前指标的名称 threshold: 扩缩容的阈值 query: 从 Prometheus 查询指标的语句\n详细参考 Scaling Deployments, StatefulSets \u0026 Custom Resources\n查看 HPA 当前状态 kubectl get hpa -n develop ​ NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE keda-hpa-demo Deployment/demo 2/10 (avg) 1 10 1 77m 发起高于 10 qps 的请求 ab -c 100 -n 100000 '10.48.37.36:30088/test' 查看扩容状态 当请求 QPS 大于 10 之后，HPA 开始扩容\nkubectl get hpa -n develop ​ NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE keda-hpa-demo Deployment/demo 59/10 (avg) 1 10 1 79m ​ kubectl get hpa -n develop ​ NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE keda-hpa-demo Deployment/demo 33750m/10 (avg) 1 10 4 79m 缩容 当请求 QPS 持续低于 10，时间大于 cooldownPeriod 后，HPA 开始缩容\nkubectl get hpa -n develop ​ NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE keda-hpa-demo Deployment/demo 800m/10 (avg) 1 10 10 87m ​ kubectl get hpa -n develop ​ NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE keda-hpa-demo Deployment/demo 7/10 (avg) 1 10 1 88m 配置多个指标 使用 QPS 和统计的 CPU 使用率作为指标进行扩缩容\nKEDA 2.0 支持直接从 Pod 获取 CPU 和内存作为指标，当前 2.0 版本未发布，可以参考：Support adding HPA Standard Metrics to Scaled Object Spec\napiVersion: keda.k8s.io/v1alpha1 kind: ScaledObject metadata: name: demo namespace: develop spec: scaleTargetRef: deploymentName: demo namespace: develop pollingInterval: 15 cooldownPeriod: 60 minReplicaCount: 1 maxReplicaCount: 10 triggers: - type: prometheus metadata: serverAddress: http://prometheus.local metricName: http_requests_per_min threshold: '1000' query: sum(rate(http_server_requests_seconds_count{application=\"demo\"}[1m])) - type: prometheus metadata: serverAddress: http://prometheus.local metricName: cpu threshold: '50' query: (sum(process_cpu_usage{application=\"demo\"} * 32) by (application) / sum(system_cpu_count{application=\"demo\"}) by (application) * 100) 参考文档 https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis https://keda.sh/ https://keda.sh/docs/1.5/scalers/prometheus/ https://github.com/kedacore/keda ","wordCount":"452","inLanguage":"en","datePublished":"2020-09-20T22:36:15Z","dateModified":"2020-09-20T22:36:15Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/hpa-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%8C%87%E6%A0%87%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>HPA 使用自定义的指标自动扩缩容</h1></header><p><small>September 20, 2020&nbsp;· 452 words&nbsp;· 3 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#前提>前提</a></li><li><a href=#安装-keda-组件>安装 KEDA 组件</a></li><li><a href=#测试>测试</a></li><li><a href=#配置多个指标>配置多个指标</a></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div><section class=blog-content><h1 id=hpa-使用自定义的指标自动扩缩容>HPA 使用自定义的指标自动扩缩容</h1><p>Kubernetes 支持使用自定义的指标作为 HPA 的依据；</p><p>KEDA 是基于事件驱动的自动扩缩容组件；主要有两部分：</p><ol><li>Agent: 用于触发和停用扩缩容，通过 keda-operator 实现</li><li>Metrics: 用于收集指标，提供给 Agent，通过 keda-operator-metrics-apiserver 实现</li></ol><p>KEDA 适配了多个组件，支持从 Prometheus、MySQL、MQ、Redis、自定义的组件等获取指标</p><h2 id=前提>前提</h2><p>环境中安装了 metrics-server</p><h2 id=安装-keda-组件>安装 KEDA 组件</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add kedacore https://kedacore.github.io/charts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm repo update​
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create namespace keda
</span></span><span style=display:flex><span>helm install keda kedacore/keda --namespace keda
</span></span></code></pre></div><p>安装完成后会看到相关的组件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get all -n keda
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                                                   READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/keda-operator-6b7f8d7b46-tb69x                     1/1     Running   <span style=color:#ae81ff>0</span>          160m
</span></span><span style=display:flex><span>pod/keda-operator-metrics-apiserver-58657d68db-bs94r   1/1     Running   <span style=color:#ae81ff>0</span>          160m
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                                      TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>             AGE
</span></span><span style=display:flex><span>service/keda-operator-metrics             ClusterIP   192.168.68.139    &lt;none&gt;        8383/TCP,8686/TCP   159m
</span></span><span style=display:flex><span>service/keda-operator-metrics-apiserver   ClusterIP   192.168.106.114   &lt;none&gt;        443/TCP,80/TCP      160m
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/keda-operator                     1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           160m
</span></span><span style=display:flex><span>deployment.apps/keda-operator-metrics-apiserver   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           160m
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                                                         DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>replicaset.apps/keda-operator-6b7f8d7b46                     <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       160m
</span></span><span style=display:flex><span>replicaset.apps/keda-operator-metrics-apiserver-58657d68db   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       160m
</span></span></code></pre></div><h2 id=测试>测试</h2><ol><li>创建 HPA</li></ol><pre tabindex=0><code>kubectl apply -f demo-api-hpa.yaml
</code></pre><ol start=2><li>为 demo 配置 Service，用于访问请求</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>develop</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30088</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><ol start=3><li>配置 KEDA 对象</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>keda.k8s.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ScaledObject</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>develop</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scaleTargetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>deploymentName</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>develop</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pollingInterval</span>: <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cooldownPeriod</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>minReplicaCount</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>maxReplicaCount</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>triggers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>serverAddress</span>: <span style=color:#ae81ff>http://prometheus.local</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>metricName</span>: <span style=color:#ae81ff>http_requests_per_min</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>threshold</span>: <span style=color:#e6db74>&#39;10&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>query</span>: <span style=color:#ae81ff>sum(rate(http_server_requests_seconds_count{application=&#34;demo&#34;}[1m]))</span>
</span></span></code></pre></div><p><code>poolingInterval</code>: 从 triggers 拉取的周期
<code>colldownPeriod</code>: 缩容的等待时间，从最后一次超过阈值的 tirgger
<code>minReplicaCount</code>: 扩缩容最小的 Pod 数量
<code>maxReplicaCount</code>: 扩缩容最大的 Pod 数量
<code>triggers</code>: 触发器，定义指标
<code>type</code>: 数据来源，支持 Prometheus、MySQL、MQ、Redis、自定义扩展等
<code>metricName</code>: 定义当前指标的名称
<code>threshold</code>: 扩缩容的阈值
<code>query</code>: 从 Prometheus 查询指标的语句</p><p>详细参考 <a href=https://keda.sh/docs/2.0/concepts/scaling-deployments/>Scaling Deployments, StatefulSets & Custom Resources</a></p><ol start=4><li>查看 HPA 当前状态</li></ol><pre tabindex=0><code>kubectl get hpa -n develop
​
NAME                REFERENCE             TARGETS      MINPODS   MAXPODS   REPLICAS   AGE
keda-hpa-demo       Deployment/demo       2/10 (avg)   1         10        1          77m
</code></pre><ol start=5><li>发起高于 10 qps 的请求</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ab -c <span style=color:#ae81ff>100</span> -n <span style=color:#ae81ff>100000</span> <span style=color:#e6db74>&#39;10.48.37.36:30088/test&#39;</span>
</span></span></code></pre></div><ol start=6><li>查看扩容状态</li></ol><p>当请求 QPS 大于 10 之后，HPA 开始扩容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get hpa -n develop
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                REFERENCE             TARGETS       MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>keda-hpa-demo       Deployment/demo       59/10 <span style=color:#f92672>(</span>avg<span style=color:#f92672>)</span>   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>10</span>        <span style=color:#ae81ff>1</span>          79m
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>kubectl get hpa -n develop
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                REFERENCE             TARGETS           MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>keda-hpa-demo       Deployment/demo       33750m/10 <span style=color:#f92672>(</span>avg<span style=color:#f92672>)</span>   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>10</span>        <span style=color:#ae81ff>4</span>          79m
</span></span></code></pre></div><ol start=7><li>缩容</li></ol><p>当请求 QPS 持续低于 10，时间大于 cooldownPeriod 后，HPA 开始缩容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get hpa -n develop
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                REFERENCE             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>keda-hpa-demo       Deployment/demo       800m/10 <span style=color:#f92672>(</span>avg<span style=color:#f92672>)</span>   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>10</span>        <span style=color:#ae81ff>10</span>         87m
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>kubectl get hpa -n develop
</span></span><span style=display:flex><span>​
</span></span><span style=display:flex><span>NAME                REFERENCE             TARGETS      MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>keda-hpa-demo       Deployment/demo       7/10 <span style=color:#f92672>(</span>avg<span style=color:#f92672>)</span>   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>10</span>        <span style=color:#ae81ff>1</span>          88m
</span></span></code></pre></div><h2 id=配置多个指标>配置多个指标</h2><p>使用 QPS 和统计的 CPU 使用率作为指标进行扩缩容</p><p>KEDA 2.0 支持直接从 Pod 获取 CPU 和内存作为指标，当前 2.0 版本未发布，可以参考：<a href=https://github.com/kedacore/keda/issues/852>Support adding HPA Standard Metrics to Scaled Object Spec</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>keda.k8s.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ScaledObject</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>develop</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scaleTargetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>deploymentName</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>develop</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pollingInterval</span>: <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cooldownPeriod</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>minReplicaCount</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>maxReplicaCount</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>triggers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>serverAddress</span>: <span style=color:#ae81ff>http://prometheus.local</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>metricName</span>: <span style=color:#ae81ff>http_requests_per_min</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>threshold</span>: <span style=color:#e6db74>&#39;1000&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>query</span>: <span style=color:#ae81ff>sum(rate(http_server_requests_seconds_count{application=&#34;demo&#34;}[1m]))</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>serverAddress</span>: <span style=color:#ae81ff>http://prometheus.local</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>metricName</span>: <span style=color:#ae81ff>cpu</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>threshold</span>: <span style=color:#e6db74>&#39;50&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>query</span>: <span style=color:#ae81ff>(sum(process_cpu_usage{application=&#34;demo&#34;} * 32) by (application) / sum(system_cpu_count{application=&#34;demo&#34;}) by (application)  * 100)</span>
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics>https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics</a></li><li><a href=https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis>https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis</a></li><li><a href=https://keda.sh/>https://keda.sh/</a></li><li><a href=https://keda.sh/docs/1.5/scalers/prometheus/>https://keda.sh/docs/1.5/scalers/prometheus/</a></li><li><a href=https://github.com/kedacore/keda>https://github.com/kedacore/keda</a></li></ul></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/grpc-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>gRPC 负载均衡</span></a>
<a class=next href=https://blog.hellowood.dev/posts/grpc-%E5%91%BD%E5%90%8D%E8%A7%A3%E6%9E%90/><span>gRPC 命名解析</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>