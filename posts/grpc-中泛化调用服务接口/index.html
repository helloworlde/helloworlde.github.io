<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>gRPC 中泛化调用服务接口</title>
<meta name=description content="gRPC 没有直接支持泛化调用，protobuf 可以不依赖于生成的代码实现调用，所以可以通过反射接口间接实现泛化调用
要求 Server 端提供 grpc.reflection.v1alpha.ServerReflection 服务，用于获取服务的描述文件
大致的流程是：

根据方法名称，调用服务端反射服务的方法，获 …"><meta name=keywords content='blog,hugo,gRPC'><meta property="og:url" content="https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E6%B3%9B%E5%8C%96%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3/"><meta property="og:type" content="website"><meta property="og:title" content="gRPC 中泛化调用服务接口"><meta property="og:description" content="gRPC 没有直接支持泛化调用，protobuf 可以不依赖于生成的代码实现调用，所以可以通过反射接口间接实现泛化调用
要求 Server 端提供 grpc.reflection.v1alpha.ServerReflection 服务，用于获取服务的描述文件
大致的流程是：

根据方法名称，调用服务端反射服务的方法，获 …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E6%B3%9B%E5%8C%96%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>gRPC 中泛化调用服务接口</h1><small role=doc-subtitle></small><p class=post-date>2021-01-01</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/grpc>gRPC</a></li></ul></div><div class=post-content><p>gRPC 没有直接支持泛化调用，protobuf 可以不依赖于生成的代码实现调用，所以可以通过反射接口间接实现泛化调用</p><p>要求 Server 端提供 <code>grpc.reflection.v1alpha.ServerReflection</code> 服务，用于获取服务的描述文件</p><p>大致的流程是：</p><ol><li>根据方法名称，调用服务端反射服务的方法，获取方法所在 proto 文件的描述</li><li>根据 proto 描述文件，获取文件描述、服务描述，用于重新构建要被调用方法的方法描述 <code>MethodDescriptor</code></li><li>根据方法描述，将请求内容序列化为对应的类型</li><li>使用重新构建的<code>MethodDescriptor</code>和其他参数对 Server 端相应的方法发起调用</li><li>解析响应并返回</li></ol><h2 id=实现>实现</h2><p>使用 JSON 格式请求被调用的服务方法，并返回 JSON 格式的响应</p><h3 id=proto-定义>proto 定义</h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#c1abea>syntax</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;proto3&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#76a9f9>io</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>github.helloworlde.grpc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>go_package</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;api;grpc_gateway&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>java_package</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;io.github.helloworlde.grpc&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>java_multiple_files</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>java_outer_classname</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;HelloWorldGrpc&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>service</span> <span style=color:#c1abea>HelloService</span>{
</span></span><span style=display:flex><span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>SayHello</span>(<span style=color:#c1abea>HelloMessage</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>HelloResponse</span>){
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>message</span> <span style=color:#76a9f9>HelloMessage</span> {
</span></span><span style=display:flex><span>  <span style=color:#ef8383>string</span> <span style=color:#c678dd>message</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>2</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>message</span> <span style=color:#76a9f9>HelloResponse</span> {
</span></span><span style=display:flex><span>  <span style=color:#ef8383>string</span> <span style=color:#c678dd>message</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=调用>调用</h3><h4 id=1-构建反射服务-stub>1. 构建反射服务 Stub</h4><p>需要调用反射服务的方法，该方法是双向流</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 构建 Channel</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>ManagedChannel</span> <span style=color:#c1abea>channel</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>ManagedChannelBuilder</span>.<span style=color:#b3d23c>forAddress</span>(<span style=color:#98c379>&#34;127.0.0.1&#34;</span>,<span style=color:#c1abea>9090</span>)
</span></span><span style=display:flex><span>                                            .<span style=color:#b3d23c>usePlaintext</span>()
</span></span><span style=display:flex><span>                                            .<span style=color:#b3d23c>build</span>();
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 使用 Channel 构建 BlockingStub</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>ServerReflectionGrpc</span>.<span style=color:#b3d23c>ServerReflectionStub</span> <span style=color:#c1abea>reflectionStub</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>ServerReflectionGrpc</span>.<span style=color:#b3d23c>newStub</span>(<span style=color:#c1abea>channel</span>);
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 响应观察器</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>ServerReflectionResponse</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>streamObserver</span><span style=color:#c7bf54>=</span><span style=color:#c678dd>new</span> <span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>ServerReflectionResponse</span><span style=color:#c7bf54>&gt;</span>(){
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>onNext</span>(<span style=color:#c1abea>ServerReflectionResponse</span> <span style=color:#c1abea>response</span>){
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 处理响应</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>onError</span>(<span style=color:#c1abea>Throwable</span> <span style=color:#c1abea>t</span>){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>onCompleted</span>(){
</span></span><span style=display:flex><span>        <span style=color:#c1abea>log</span>.<span style=color:#b3d23c>info</span>(<span style=color:#98c379>&#34;Complete&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 请求观察器</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>ServerReflectionRequest</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>requestStreamObserver</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>reflectionStub</span>.<span style=color:#b3d23c>serverReflectionInfo</span>(<span style=color:#c1abea>streamObserver</span>);
</span></span></code></pre></div><h4 id=2-根据方法名称获取文件描述>2. 根据方法名称获取文件描述</h4><p>这里的 <code>methodSymbol</code> 即服务或方法的限定名，可以是 <code>package.service</code> 或者 <code>package.service.method</code>
，如 <code>io.github.helloworlde.grpc.HelloService.SayHello</code>，需要注意方法前是 <code>.</code>不是<code>/</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 构建并发送获取方法文件描述请求</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>ServerReflectionRequest</span> <span style=color:#c1abea>getFileContainingSymbolRequest</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>ServerReflectionRequest</span>.<span style=color:#b3d23c>newBuilder</span>()
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>setFileContainingSymbol</span>(<span style=color:#c1abea>methodSymbol</span>)
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>requestStreamObserver</span>.<span style=color:#b3d23c>onNext</span>(<span style=color:#c1abea>getFileContainingSymbolRequest</span>);
</span></span></code></pre></div><h4 id=3-处理响应解析-filedescriptor>3. 处理响应，解析 FileDescriptor</h4><p>返回的响应后会触发 <code>onNext</code> 方法，如果响应类型是文件描述类型，即 <code>FILE_DESCRIPTOR_RESPONSE</code>，则进行处理</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>onNext</span>(<span style=color:#c1abea>ServerReflectionResponse</span> <span style=color:#c1abea>response</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 只需要关注文件描述类型的响应</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>response</span>.<span style=color:#b3d23c>getMessageResponseCase</span>() <span style=color:#c7bf54>==</span> <span style=color:#c1abea>ServerReflectionResponse</span>.<span style=color:#b3d23c>MessageResponseCase</span>.<span style=color:#b3d23c>FILE_DESCRIPTOR_RESPONSE</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>List</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>ByteString</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>fileDescriptorProtoList</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>getFileDescriptorResponse</span>().<span style=color:#b3d23c>getFileDescriptorProtoList</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>handleResponse</span>(<span style=color:#c1abea>fileDescriptorProtoList</span>, <span style=color:#c1abea>channel</span>, <span style=color:#c1abea>methodSymbol</span>, <span style=color:#c1abea>requestContent</span>);
</span></span><span style=display:flex><span>        } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>log</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;未知响应类型: &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>getMessageResponseCase</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>Exception</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>log</span>.<span style=color:#b3d23c>error</span>(<span style=color:#98c379>&#34;处理响应失败: {}&#34;</span>, <span style=color:#c1abea>e</span>.<span style=color:#b3d23c>getMessage</span>(), <span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>handleResponse</li></ul><p>在处理请求时，先解析了包名、服务名和方法名，然后根据包名和服务名，从返回的文件描述中获取到了响应方法所在文件的描述；然后从文件描述中获取服务描述，最终获取到方法描述，根据方法描述执行调用</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#c678dd>static</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>handleResponse</span>(<span style=color:#c1abea>List</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>ByteString</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>fileDescriptorProtoList</span>,
</span></span><span style=display:flex><span>                                   <span style=color:#c1abea>ManagedChannel</span> <span style=color:#c1abea>channel</span>,
</span></span><span style=display:flex><span>                                   <span style=color:#c1abea>String</span> <span style=color:#c1abea>methodFullName</span>,
</span></span><span style=display:flex><span>                                   <span style=color:#c1abea>String</span> <span style=color:#c1abea>requestContent</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 解析方法和服务名称</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>String</span> <span style=color:#c1abea>fullServiceName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>extraPrefix</span>(<span style=color:#c1abea>methodFullName</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>String</span> <span style=color:#c1abea>methodName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>extraSuffix</span>(<span style=color:#c1abea>methodFullName</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>String</span> <span style=color:#c1abea>packageName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>extraPrefix</span>(<span style=color:#c1abea>fullServiceName</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>String</span> <span style=color:#c1abea>serviceName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>extraSuffix</span>(<span style=color:#c1abea>fullServiceName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 根据响应解析 FileDescriptor</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>FileDescriptor</span> <span style=color:#c1abea>fileDescriptor</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>getFileDescriptor</span>(<span style=color:#c1abea>fileDescriptorProtoList</span>, <span style=color:#c1abea>packageName</span>, <span style=color:#c1abea>serviceName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 查找服务描述</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>ServiceDescriptor</span> <span style=color:#c1abea>serviceDescriptor</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>fileDescriptor</span>.<span style=color:#b3d23c>getFile</span>().<span style=color:#b3d23c>findServiceByName</span>(<span style=color:#c1abea>serviceName</span>);
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 查找方法描述</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>MethodDescriptor</span> <span style=color:#c1abea>methodDescriptor</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>serviceDescriptor</span>.<span style=color:#b3d23c>findMethodByName</span>(<span style=color:#c1abea>methodName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 发起请求</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>executeCall</span>(<span style=color:#c1abea>channel</span>, <span style=color:#c1abea>fileDescriptor</span>, <span style=color:#c1abea>methodDescriptor</span>, <span style=color:#c1abea>requestContent</span>);
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>Exception</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>log</span>.<span style=color:#b3d23c>error</span>(<span style=color:#c1abea>e</span>.<span style=color:#b3d23c>getMessage</span>(), <span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>getFileDescriptor</li></ul><p>根据响应找到方法对应的文件的 <code>FileDescriptorProto</code>，然后构建出对应的 <code>FileDescriptor</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#c678dd>static</span> <span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>FileDescriptor</span> <span style=color:#00b1f7>getFileDescriptor</span>(<span style=color:#c1abea>List</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>ByteString</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>fileDescriptorProtoList</span>,
</span></span><span style=display:flex><span>                                                            <span style=color:#c1abea>String</span> <span style=color:#c1abea>packageName</span>,
</span></span><span style=display:flex><span>                                                            <span style=color:#c1abea>String</span> <span style=color:#c1abea>serviceName</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>Exception</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>Map</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>String</span>, <span style=color:#c1abea>DescriptorProtos</span>.<span style=color:#b3d23c>FileDescriptorProto</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>fileDescriptorProtoMap</span> <span style=color:#c7bf54>=</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>fileDescriptorProtoList</span>.<span style=color:#b3d23c>stream</span>()
</span></span><span style=display:flex><span>                                   .<span style=color:#b3d23c>map</span>(<span style=color:#c1abea>bs</span> <span style=color:#c7bf54>-&gt;</span> {
</span></span><span style=display:flex><span>                                       <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>                                           <span style=color:#c678dd>return</span> <span style=color:#c1abea>DescriptorProtos</span>.<span style=color:#b3d23c>FileDescriptorProto</span>.<span style=color:#b3d23c>parseFrom</span>(<span style=color:#c1abea>bs</span>);
</span></span><span style=display:flex><span>                                       } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>InvalidProtocolBufferException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>                                           <span style=color:#c1abea>e</span>.<span style=color:#b3d23c>printStackTrace</span>();
</span></span><span style=display:flex><span>                                       }
</span></span><span style=display:flex><span>                                       <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>                                   })
</span></span><span style=display:flex><span>                                   .<span style=color:#b3d23c>filter</span>(<span style=color:#c1abea>Objects</span>::<span style=color:#c1abea>nonNull</span>)
</span></span><span style=display:flex><span>                                   .<span style=color:#b3d23c>collect</span>(<span style=color:#c1abea>Collectors</span>.<span style=color:#b3d23c>toMap</span>(<span style=color:#c1abea>DescriptorProtos</span>.<span style=color:#b3d23c>FileDescriptorProto</span>::<span style=color:#c1abea>getName</span>, <span style=color:#c1abea>f</span> <span style=color:#c7bf54>-&gt;</span> <span style=color:#c1abea>f</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>fileDescriptorProtoMap</span>.<span style=color:#b3d23c>isEmpty</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>log</span>.<span style=color:#b3d23c>error</span>(<span style=color:#98c379>&#34;服务不存在&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>IllegalArgumentException</span>(<span style=color:#98c379>&#34;方法的文件描述不存在&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 查找服务对应的 Proto 描述</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>DescriptorProtos</span>.<span style=color:#b3d23c>FileDescriptorProto</span> <span style=color:#c1abea>fileDescriptorProto</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>findServiceFileDescriptorProto</span>(<span style=color:#c1abea>packageName</span>, <span style=color:#c1abea>serviceName</span>, <span style=color:#c1abea>fileDescriptorProtoMap</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 获取这个 Proto 的依赖</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>FileDescriptor</span><span style=color:#c7bf54>[]</span> <span style=color:#c1abea>dependencies</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>getDependencies</span>(<span style=color:#c1abea>fileDescriptorProto</span>, <span style=color:#c1abea>fileDescriptorProtoMap</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 生成 Proto 的 FileDescriptor</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>FileDescriptor</span>.<span style=color:#b3d23c>buildFrom</span>(<span style=color:#c1abea>fileDescriptorProto</span>, <span style=color:#c1abea>dependencies</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=4-执行调用>4. 执行调用</h4><ul><li>生成方法描述</li></ul><p>在执行调用时，需要重新生成 <code>MethodDescriptor</code>；因为获取到的 <code>MethodDescriptor</code> 中的方法全名是<code>package.service.method</code>
格式，而需要的是<code>package.service/method</code>格式，同时请求和响应类型也需要重新设置为 <code>DynamicMessage</code>,所以需要重新生成 <code>MethodDescriptor</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#c678dd>static</span> <span style=color:#c1abea>MethodDescriptor</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>DynamicMessage</span>, <span style=color:#c1abea>DynamicMessage</span><span style=color:#c7bf54>&gt;</span> <span style=color:#00b1f7>generateMethodDescriptor</span>(<span style=color:#c1abea>Descriptors</span>.<span style=color:#b3d23c>MethodDescriptor</span> <span style=color:#c1abea>originMethodDescriptor</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 生成方法全名</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>String</span> <span style=color:#c1abea>fullMethodName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>MethodDescriptor</span>.<span style=color:#b3d23c>generateFullMethodName</span>(<span style=color:#c1abea>originMethodDescriptor</span>.<span style=color:#b3d23c>getService</span>().<span style=color:#b3d23c>getFullName</span>(), <span style=color:#c1abea>originMethodDescriptor</span>.<span style=color:#b3d23c>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 请求和响应类型</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>MethodDescriptor</span>.<span style=color:#b3d23c>Marshaller</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>DynamicMessage</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>inputTypeMarshaller</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ProtoUtils</span>.<span style=color:#b3d23c>marshaller</span>(<span style=color:#c1abea>DynamicMessage</span>.<span style=color:#b3d23c>newBuilder</span>(<span style=color:#c1abea>originMethodDescriptor</span>.<span style=color:#b3d23c>getInputType</span>())
</span></span><span style=display:flex><span>                                                                                                          .<span style=color:#b3d23c>buildPartial</span>());
</span></span><span style=display:flex><span>    <span style=color:#c1abea>MethodDescriptor</span>.<span style=color:#b3d23c>Marshaller</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>DynamicMessage</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>outputTypeMarshaller</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ProtoUtils</span>.<span style=color:#b3d23c>marshaller</span>(<span style=color:#c1abea>DynamicMessage</span>.<span style=color:#b3d23c>newBuilder</span>(<span style=color:#c1abea>originMethodDescriptor</span>.<span style=color:#b3d23c>getOutputType</span>())
</span></span><span style=display:flex><span>                                                                                                           .<span style=color:#b3d23c>buildPartial</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 生成方法描述, originMethodDescriptor 的 fullMethodName 不正确</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>MethodDescriptor</span>.<span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>DynamicMessage</span>, <span style=color:#c1abea>DynamicMessage</span><span style=color:#c7bf54>&gt;</span><span style=color:#c1abea>newBuilder</span>()
</span></span><span style=display:flex><span>            .<span style=color:#b3d23c>setFullMethodName</span>(<span style=color:#c1abea>fullMethodName</span>)
</span></span><span style=display:flex><span>            .<span style=color:#b3d23c>setRequestMarshaller</span>(<span style=color:#c1abea>inputTypeMarshaller</span>)
</span></span><span style=display:flex><span>            .<span style=color:#b3d23c>setResponseMarshaller</span>(<span style=color:#c1abea>outputTypeMarshaller</span>)
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 使用 UNKNOWN，自动修改</span>
</span></span><span style=display:flex><span>            .<span style=color:#b3d23c>setType</span>(<span style=color:#c1abea>MethodDescriptor</span>.<span style=color:#b3d23c>MethodType</span>.<span style=color:#b3d23c>UNKNOWN</span>)
</span></span><span style=display:flex><span>            .<span style=color:#b3d23c>build</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>执行调用</li></ul><p>同时需要根据文件描述，将请求的类型转为对应的请求类型，生成 <code>DynamicMessage</code> 对象；然后根据方法类型，使用<code>MethodDescriptor</code> 和 <code>CallOptions</code>
发起请求；当接收到响应后将 <code>DynamicMessage</code> 解析为对应的格式的字符串；完成调用</p><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/grpc-java-sample/blob/main/reflection/src/main/java/io/github/helloworlde/grpc/ReflectionCall.java>相关实现代码参考 ReflectionCall.java</a></li><li><a href=https://github.com/os72/protobuf-dynamic>protobuf-dynamic</a></li><li><a href=https://github.com/fullstorydev/grpcurl>grpcurl</a></li><li><a href=https://github.com/grpc-swagger/grpc-swagger>grpc-swagger</a></li><li><a href=https://grpc.io/blog/grpc-with-json/>gRPC + JSON</a></li><li><a href=https://github.com/grpc/grpc-java/blob/master/documentation/server-reflection-tutorial.md#enable-server-reflection>gRPC Server Reflection Tutorial</a></li><li><a href=https://github.com/grpc/grpc-go/tree/master/reflection>Reflection</a></li><li><a href=https://chromium.googlesource.com/external/github.com/grpc/grpc-go/+/HEAD/Documentation/server-reflection-tutorial.md>gRPC Server Reflection Tutorial</a></li><li><a href=https://stackoverflow.com/questions/18836727/protocol-buffer-objects-generated-at-runtime>Protocol buffer objects generated at runtime</a></li><li><a href=https://stackoverflow.com/questions/52368593/how-can-i-send-a-grpc-message-whose-format-is-determined-at-runtime>How can I send a gRPC message whose format is determined at runtime</a></li><li><a href=https://stackoverflow.com/questions/61133529/how-to-create-grpc-client-directly-from-protobuf-without-compiling-it-into-java/61144510#61144510>How to create GRPC client directly from protobuf without compiling it into java code</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>