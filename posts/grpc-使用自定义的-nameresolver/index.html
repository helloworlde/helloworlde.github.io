<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>gRPC 使用自定义的 NameResolver</title>
<meta charset=utf-8><meta name=description content="Ladder@gRPC 使用自定义的 NameResolver 在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 NameResolverProvider 和 NameResolver
NameResolver NameResolver 里面重写了 start 和 refresh 方法，这两个方法都调用一个 resolve 方法做服务发现； resovle 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 Listener 的 onResult方法，将实例列表传递给 LoadBalancer，完成服务解析 在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发
public class CustomNameResolver extends NameResolver { private final ScheduledExecutorService executorService = new ScheduledThreadPoolExecutor(10); private final String authority; private Listener2 listener; public CustomNameResolver(String authority) { this.authority = authority; } @Override public String getServiceAuthority() { return this.authority; } @Override public void shutdown() { this.executorService.shutdown(); } @Override public void start(Listener2 listener) { this."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-nameresolver/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-nameresolver/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="gRPC 使用自定义的 NameResolver"><meta property="og:description" content="gRPC 使用自定义的 NameResolver 在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 NameResolverProvider 和 NameResolver
NameResolver NameResolver 里面重写了 start 和 refresh 方法，这两个方法都调用一个 resolve 方法做服务发现； resovle 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 Listener 的 onResult方法，将实例列表传递给 LoadBalancer，完成服务解析 在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发
public class CustomNameResolver extends NameResolver { private final ScheduledExecutorService executorService = new ScheduledThreadPoolExecutor(10); private final String authority; private Listener2 listener; public CustomNameResolver(String authority) { this.authority = authority; } @Override public String getServiceAuthority() { return this.authority; } @Override public void shutdown() { this.executorService.shutdown(); } @Override public void start(Listener2 listener) { this."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-20T22:34:46+00:00"><meta property="article:modified_time" content="2020-09-20T22:34:46+00:00"><meta property="article:tag" content="GRPC"><meta name=twitter:card content="summary"><meta name=twitter:title content="gRPC 使用自定义的 NameResolver"><meta name=twitter:description content="gRPC 使用自定义的 NameResolver 在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 NameResolverProvider 和 NameResolver
NameResolver NameResolver 里面重写了 start 和 refresh 方法，这两个方法都调用一个 resolve 方法做服务发现； resovle 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 Listener 的 onResult方法，将实例列表传递给 LoadBalancer，完成服务解析 在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发
public class CustomNameResolver extends NameResolver { private final ScheduledExecutorService executorService = new ScheduledThreadPoolExecutor(10); private final String authority; private Listener2 listener; public CustomNameResolver(String authority) { this.authority = authority; } @Override public String getServiceAuthority() { return this.authority; } @Override public void shutdown() { this.executorService.shutdown(); } @Override public void start(Listener2 listener) { this."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"gRPC 使用自定义的 NameResolver","item":"https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-nameresolver/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"gRPC 使用自定义的 NameResolver","name":"gRPC 使用自定义的 NameResolver","description":"gRPC 使用自定义的 NameResolver 在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 NameResolverProvider 和 NameResolver\nNameResolver NameResolver 里面重写了 start 和 refresh 方法，这两个方法都调用一个 resolve 方法做服务发现； resovle 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 Listener 的 onResult方法，将实例列表传递给 LoadBalancer，完成服务解析 在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发\npublic class CustomNameResolver extends NameResolver { private final ScheduledExecutorService executorService = new ScheduledThreadPoolExecutor(10); private final String authority; private Listener2 listener; public CustomNameResolver(String authority) { this.authority = authority; } @Override public String getServiceAuthority() { return this.authority; } @Override public void shutdown() { this.executorService.shutdown(); } @Override public void start(Listener2 listener) { this.","keywords":["gRPC"],"articleBody":"gRPC 使用自定义的 NameResolver 在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 NameResolverProvider 和 NameResolver\nNameResolver NameResolver 里面重写了 start 和 refresh 方法，这两个方法都调用一个 resolve 方法做服务发现； resovle 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 Listener 的 onResult方法，将实例列表传递给 LoadBalancer，完成服务解析 在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发\npublic class CustomNameResolver extends NameResolver { private final ScheduledExecutorService executorService = new ScheduledThreadPoolExecutor(10); private final String authority; private Listener2 listener; public CustomNameResolver(String authority) { this.authority = authority; } @Override public String getServiceAuthority() { return this.authority; } @Override public void shutdown() { this.executorService.shutdown(); } @Override public void start(Listener2 listener) { this.listener = listener; this.resolve(); } @Override public void refresh() { this.resolve(); } private void resolve() { executorService.scheduleAtFixedRate(() -\u003e { // 从注册中心获取地址 List\u003cInetSocketAddress\u003e addressList = getAddressList(this.authority); if (addressList == null || addressList.size() == 0) { return; } List\u003cSocketAddress\u003e socketAddressList = addressList.stream() .map(this::toSocketAddress) .collect(Collectors.toList()); EquivalentAddressGroup equivalentAddressGroup = new EquivalentAddressGroup(socketAddressList); Attributes.Key\u003cString\u003e key = Attributes.Key.create(\"CustomKey\"); String value = \"CustomValue\"; Attributes attributes = Attributes.newBuilder().set(key, value).build(); ConfigOrError configOrError = ConfigOrError.fromError(Status.NOT_FOUND); ResolutionResult resolutionResult = ResolutionResult.newBuilder() .setAddresses(Arrays.asList(equivalentAddressGroup)) .setAttributes(attributes) .setServiceConfig(configOrError) .build(); this.listener.onResult(resolutionResult); }, 0, 5, TimeUnit.SECONDS); } private SocketAddress toSocketAddress(InetSocketAddress address) { return new InetSocketAddress(address.getHostName(), address.getPort()); } private List\u003cInetSocketAddress\u003e getAddressList(String authority) { InetSocketAddress inetSocketAddress = new InetSocketAddress(\"localhost\", 1234); InetSocketAddress inetSocketAddress2 = new InetSocketAddress(\"127.0.0.1\", 1234); return Arrays.asList(inetSocketAddress, inetSocketAddress2); } } NameResolverProvider NameResolverProvider 主要用于注册 NameResolver，可以设置默认的协议，是否可用，优先级等 优先级有效值是 0-10，gRPC 默认的 DnsNameResolver 优先级是5，所以自定义的优先级要大于5\npublic class CustomNameResolverProvider extends NameResolverProvider { @Override public NameResolver newNameResolver(URI targetUri, NameResolver.Args args) { return new CustomNameResolver(targetUri.toString()); } @Override protected boolean isAvailable() { return true; } @Override protected int priority() { return 10; } @Override public String getDefaultScheme() { return \"http\"; } } 注册 NameResolver 在新版本(1.21+)之后，NameResolver 推荐使用 NameResolverRegistry 进行注册； 注册要在创建 Channel 之前执行\nNameResolverRegistry.getDefaultRegistry().register(new CustomNameResolverProvider()); this.channel = ManagedChannelBuilder .forTarget(\"server\") .usePlaintext() .build(); 在 Channel 调用 build 方式时，会在 io.grpc.internal.ManagedChannelImpl#ManagedChannelImpl的构造方法中获取 NameResolver.Factory，这个属性的值是由调用 io.grpc.internal.AbstractManagedChannelImplBuilder#getNameResolverFactory 方法获取的，这个方法里面的属性值来自于 io.grpc.NameResolverRegistry#asFactory；NameResolverRegistry 自己通过内部类 NameResolverFactory创建了NameResovler.Factory 的实例，调用 Factory 的 newNameResolver时，从 provider 属性中获取根据优先级排序后的 NameResolver，创建实例并返回第一个创建的有效实例\n","wordCount":"271","inLanguage":"en","datePublished":"2020-09-20T22:34:46Z","dateModified":"2020-09-20T22:34:46Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-nameresolver/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>gRPC 使用自定义的 NameResolver</h1></header><p><small>September 20, 2020&nbsp;· 271 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents></nav></div><section class=blog-content><h1 id=grpc-使用自定义的-nameresolver>gRPC 使用自定义的 NameResolver</h1><p>在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 <code>NameResolverProvider</code> 和 <code>NameResolver</code></p><ul><li>NameResolver</li></ul><p><code>NameResolver</code> 里面重写了 <code>start</code> 和 <code>refresh</code> 方法，这两个方法都调用一个 <code>resolve</code> 方法做服务发现；
<code>resovle</code> 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 <code>Listener</code> 的 <code>onResult</code>方法，将实例列表传递给 <code>LoadBalancer</code>，完成服务解析
在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomNameResolver</span> <span style=color:#66d9ef>extends</span> NameResolver {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ScheduledExecutorService executorService <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ScheduledThreadPoolExecutor(10);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String authority;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Listener2 listener;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CustomNameResolver</span>(String authority) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authority</span> <span style=color:#f92672>=</span> authority;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getServiceAuthority</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authority</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executorService</span>.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>(Listener2 listener) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> listener;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>refresh</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resolve</span>() {
</span></span><span style=display:flex><span>        executorService.<span style=color:#a6e22e>scheduleAtFixedRate</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//    从注册中心获取地址</span>
</span></span><span style=display:flex><span>            List<span style=color:#f92672>&lt;</span>InetSocketAddress<span style=color:#f92672>&gt;</span> addressList <span style=color:#f92672>=</span> getAddressList(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authority</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (addressList <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> addressList.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            List<span style=color:#f92672>&lt;</span>SocketAddress<span style=color:#f92672>&gt;</span> socketAddressList <span style=color:#f92672>=</span> addressList.<span style=color:#a6e22e>stream</span>()
</span></span><span style=display:flex><span>                                                               .<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>this</span>::toSocketAddress)
</span></span><span style=display:flex><span>                                                               .<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>toList</span>());
</span></span><span style=display:flex><span>            EquivalentAddressGroup equivalentAddressGroup <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EquivalentAddressGroup(socketAddressList);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Attributes.<span style=color:#a6e22e>Key</span><span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> key <span style=color:#f92672>=</span> Attributes.<span style=color:#a6e22e>Key</span>.<span style=color:#a6e22e>create</span>(<span style=color:#e6db74>&#34;CustomKey&#34;</span>);
</span></span><span style=display:flex><span>            String value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CustomValue&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Attributes attributes <span style=color:#f92672>=</span> Attributes.<span style=color:#a6e22e>newBuilder</span>().<span style=color:#a6e22e>set</span>(key, value).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>            ConfigOrError configOrError <span style=color:#f92672>=</span> ConfigOrError.<span style=color:#a6e22e>fromError</span>(Status.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ResolutionResult resolutionResult <span style=color:#f92672>=</span> ResolutionResult.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>                                                                .<span style=color:#a6e22e>setAddresses</span>(Arrays.<span style=color:#a6e22e>asList</span>(equivalentAddressGroup))
</span></span><span style=display:flex><span>                                                                .<span style=color:#a6e22e>setAttributes</span>(attributes)
</span></span><span style=display:flex><span>                                                                .<span style=color:#a6e22e>setServiceConfig</span>(configOrError)
</span></span><span style=display:flex><span>                                                                .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listener</span>.<span style=color:#a6e22e>onResult</span>(resolutionResult);
</span></span><span style=display:flex><span>        }, 0, 5, TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SocketAddress <span style=color:#a6e22e>toSocketAddress</span>(InetSocketAddress address) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> InetSocketAddress(address.<span style=color:#a6e22e>getHostName</span>(), address.<span style=color:#a6e22e>getPort</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>InetSocketAddress<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAddressList</span>(String authority) {
</span></span><span style=display:flex><span>        InetSocketAddress inetSocketAddress <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InetSocketAddress(<span style=color:#e6db74>&#34;localhost&#34;</span>, 1234);
</span></span><span style=display:flex><span>        InetSocketAddress inetSocketAddress2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InetSocketAddress(<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, 1234);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Arrays.<span style=color:#a6e22e>asList</span>(inetSocketAddress, inetSocketAddress2);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>NameResolverProvider</li></ul><p><code>NameResolverProvider</code> 主要用于注册 <code>NameResolver</code>，可以设置默认的协议，是否可用，优先级等
优先级有效值是 0-10，gRPC 默认的 <code>DnsNameResolver</code> 优先级是5，所以自定义的优先级要大于5</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomNameResolverProvider</span> <span style=color:#66d9ef>extends</span> NameResolverProvider {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> NameResolver <span style=color:#a6e22e>newNameResolver</span>(URI targetUri, NameResolver.<span style=color:#a6e22e>Args</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CustomNameResolver(targetUri.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isAvailable</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>priority</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 10;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getDefaultScheme</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;http&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>注册 NameResolver</li></ul><p>在新版本(1.21+)之后，<code>NameResolver</code> 推荐使用 <code>NameResolverRegistry</code> 进行注册；
注册要在创建 Channel 之前执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>NameResolverRegistry.<span style=color:#a6e22e>getDefaultRegistry</span>().<span style=color:#a6e22e>register</span>(<span style=color:#66d9ef>new</span> CustomNameResolverProvider());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>channel</span> <span style=color:#f92672>=</span> ManagedChannelBuilder
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>forTarget</span>(<span style=color:#e6db74>&#34;server&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>usePlaintext</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><p>在 Channel 调用 <code>build</code> 方式时，会在 <code>io.grpc.internal.ManagedChannelImpl#ManagedChannelImpl</code>的构造方法中获取 <code>NameResolver.Factory</code>，这个属性的值是由调用 <code>io.grpc.internal.AbstractManagedChannelImplBuilder#getNameResolverFactory</code> 方法获取的，这个方法里面的属性值来自于 <code>io.grpc.NameResolverRegistry#asFactory</code>；<code>NameResolverRegistry</code> 自己通过内部类 <code>NameResolverFactory</code>创建了<code>NameResovler.Factory</code> 的实例，调用 Factory 的 <code>newNameResolver</code>时，从 <code>provider</code> 属性中获取根据优先级排序后的 <code>NameResolver</code>，创建实例并返回第一个创建的有效实例</p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/grpc-%E5%91%BD%E5%90%8D%E8%A7%A3%E6%9E%90/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>gRPC 命名解析</span></a>
<a class=next href=https://blog.hellowood.dev/posts/grpc-%E4%B8%AD-binlog-%E6%89%93%E5%8D%B0%E5%8E%9F%E7%90%86/><span>gRPC 中 Binlog 打印原理</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>