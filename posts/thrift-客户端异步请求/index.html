<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Thrift 客户端异步请求</title><meta charset=utf-8><meta name=description content="Ladder@Thrift 客户端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端 异步客户端调用使用 AsyncClient，传输层使用 TNonblockingSocket；需要实现 AsyncMethodCallback作为回调，用于处理请求结果
public class AsyncClient { public static void main(String[] args) throws InterruptedException { try { // 构建异步客户端 TAsyncClientManager clientManager = new TAsyncClientManager(); TProtocolFactory protocolFactory = new TBinaryProtocol.Factory(); HelloService.AsyncClient.Factory factory = new HelloService.AsyncClient.Factory(clientManager, protocolFactory); TNonblockingTransport nonblockingTransport = new TNonblockingSocket(&#34;localhost&#34;, 9090); HelloService."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/thrift-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script>
<script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="Thrift 客户端异步请求"><meta property="og:description" content="Thrift 客户端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端 异步客户端调用使用 AsyncClient，传输层使用 TNonblockingSocket；需要实现 AsyncMethodCallback作为回调，用于处理请求结果
public class AsyncClient { public static void main(String[] args) throws InterruptedException { try { // 构建异步客户端 TAsyncClientManager clientManager = new TAsyncClientManager(); TProtocolFactory protocolFactory = new TBinaryProtocol.Factory(); HelloService.AsyncClient.Factory factory = new HelloService.AsyncClient.Factory(clientManager, protocolFactory); TNonblockingTransport nonblockingTransport = new TNonblockingSocket(&#34;localhost&#34;, 9090); HelloService."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/thrift-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-20T22:34:46+00:00"><meta property="article:modified_time" content="2021-02-20T22:34:46+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Thrift 客户端异步请求"><meta name=twitter:description content="Thrift 客户端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端 异步客户端调用使用 AsyncClient，传输层使用 TNonblockingSocket；需要实现 AsyncMethodCallback作为回调，用于处理请求结果
public class AsyncClient { public static void main(String[] args) throws InterruptedException { try { // 构建异步客户端 TAsyncClientManager clientManager = new TAsyncClientManager(); TProtocolFactory protocolFactory = new TBinaryProtocol.Factory(); HelloService.AsyncClient.Factory factory = new HelloService.AsyncClient.Factory(clientManager, protocolFactory); TNonblockingTransport nonblockingTransport = new TNonblockingSocket(&#34;localhost&#34;, 9090); HelloService."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Thrift 客户端异步请求","item":"https://blog.hellowood.dev/posts/thrift-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Thrift 客户端异步请求","name":"Thrift 客户端异步请求","description":"Thrift 客户端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端 异步客户端调用使用 AsyncClient，传输层使用 TNonblockingSocket；需要实现 AsyncMethodCallback作为回调，用于处理请求结果\npublic class AsyncClient { public static void main(String[] args) throws InterruptedException { try { // 构建异步客户端 TAsyncClientManager clientManager = new TAsyncClientManager(); TProtocolFactory protocolFactory = new TBinaryProtocol.Factory(); HelloService.AsyncClient.Factory factory = new HelloService.AsyncClient.Factory(clientManager, protocolFactory); TNonblockingTransport nonblockingTransport = new TNonblockingSocket(\u0026#34;localhost\u0026#34;, 9090); HelloService.","keywords":["Thrift"],"articleBody":"Thrift 客户端异步请求 实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct HelloResponse { 1: required string message, } service HelloService { HelloResponse sayHello(1: HelloMessage request); } 客户端 异步客户端调用使用 AsyncClient，传输层使用 TNonblockingSocket；需要实现 AsyncMethodCallback作为回调，用于处理请求结果\npublic class AsyncClient { public static void main(String[] args) throws InterruptedException { try { // 构建异步客户端 TAsyncClientManager clientManager = new TAsyncClientManager(); TProtocolFactory protocolFactory = new TBinaryProtocol.Factory(); HelloService.AsyncClient.Factory factory = new HelloService.AsyncClient.Factory(clientManager, protocolFactory); TNonblockingTransport nonblockingTransport = new TNonblockingSocket(\"localhost\", 9090); HelloService.AsyncClient asyncClient = factory.getAsyncClient(nonblockingTransport); // 异步回调 AsyncMethodCallback\u003cHelloResponse\u003e callback = new AsyncMethodCallback\u003cHelloResponse\u003e() { @Override public void onComplete(HelloResponse response) { log.info(\"响应结果: {}\", response.getMessage()); } @Override public void onError(Exception exception) { log.error(\"请求失败: {}\", exception.getMessage(), exception); } }; // 构建请求 HelloMessage request = new HelloMessage(); request.setMessage(\"Async Thrift\"); // 调用 asyncClient.sayHello(request, callback); } catch (TException | IOException e) { e.printStackTrace(); } Thread.sleep(3_000); } } 请求处理流程 构建 Client 和回调 1. 构建 Client 异步的客户端由抽象类 TAsyncClient 定义，实现类继承了 TAsyncClient，同时实现了 AsyncIface； 在构建其 Factory 时需要三个参数，分别是 TAsyncClientManager，用于管理调用请求的所有流程；和 TProtocolFactory，用于获取协议；还有 TNonblockingTransport，用于底层的传输，必须是非阻塞的\n// 构建异步客户端 TAsyncClientManager clientManager = new TAsyncClientManager(); TProtocolFactory protocolFactory = new TBinaryProtocol.Factory(); HelloService.AsyncClient.Factory factory = new HelloService.AsyncClient.Factory(clientManager, protocolFactory); TNonblockingTransport nonblockingTransport = new TNonblockingSocket(\"localhost\", 9090); HelloService.AsyncClient asyncClient = factory.getAsyncClient(nonblockingTransport); 2. 构建回调 回调由 AsyncMethodCallback 接口定义，有两个方法，分别是用于处理正常返回的 onComplete 和处理异常结果的 onError\nAsyncMethodCallback\u003cHelloResponse\u003e callback = new AsyncMethodCallback\u003cHelloResponse\u003e() { @Override public void onComplete(HelloResponse response) { log.info(\"响应结果: {}\", response.getMessage()); } @Override public void onError(Exception exception) { log.error(\"请求失败: {}\", exception.getMessage(), exception); } }; 执行请求 发起请求 调用接口时需要两个参数，请求内容和响应回调\nHelloMessage request = new HelloMessage(); request.setMessage(\"Async Thrift\"); // 调用 asyncClient.sayHello(request, callback); io.github.helloworlde.thrift.HelloService.AsyncClient#sayHello 会构建 sayHello_call，该类是 TAsyncMethodCall 的实现类，支持写入消息和获取结果，然后将该实例作为参数调用 org.apache.thrift.async.TAsyncClientManager#call 方法\npublic void sayHello(HelloMessage request, org.apache.thrift.async.AsyncMethodCallback\u003cHelloResponse\u003e resultHandler) throws org.apache.thrift.TException { checkReady(); sayHello_call method_call = new sayHello_call(request, resultHandler, this, ___protocolFactory, ___transport); this.___currentMethod = method_call; ___manager.call(method_call); } org.apache.thrift.async.TAsyncClientManager#call 初始化请求，将请求加入到队列中，然后唤醒 Selector 执行\npublic void call(TAsyncMethodCall method) throws TException { if (!isRunning()) { throw new TException(\"SelectThread is not running\"); } // 初始化缓冲区 method.prepareMethodCall(); // 添加到待执行方法中，由 SelectThread 处理 pendingCalls.add(method); selectThread.getSelector().wakeup(); } org.apache.thrift.async.TAsyncMethodCall#prepareMethodCall 执行初始化请求，，将请求消息写入到 Protocol 中，然后封装为 ByteBuffer\nprotected void prepareMethodCall() throws TException { TMemoryBuffer memoryBuffer = new TMemoryBuffer(INITIAL_MEMORY_BUFFER_SIZE); TProtocol protocol = protocolFactory.getProtocol(memoryBuffer); write_args(protocol); int length = memoryBuffer.length(); frameBuffer = ByteBuffer.wrap(memoryBuffer.getArray(), 0, length); TFramedTransport.encodeFrameSize(length, sizeBufferArray); sizeBuffer = ByteBuffer.wrap(sizeBufferArray); } io.github.helloworlde.thrift.HelloService.AsyncClient.sayHello_call#write_args 将消息写入到流中\npublic void write_args(org.apache.thrift.protocol.TProtocol prot) throws org.apache.thrift.TException { prot.writeMessageBegin(new org.apache.thrift.protocol.TMessage(\"sayHello\", org.apache.thrift.protocol.TMessageType.CALL, 0)); sayHello_args args = new sayHello_args(); args.setRequest(request); args.write(prot); prot.writeMessageEnd(); } org.apache.thrift.async.TAsyncClientManager.SelectThread#run 由 SelectThread 处理请求，在执行时，会先修改 TAsyncMethodCall 的状态，如果需要连接，则执行建立连接；如果需要写入或者读取则执行写入或者读取；然后会检查请求是否超时，如果没有超时，则开始执行待调用的方法\npublic void run() { while (running) { try { try { if (timeoutWatchSet.size() == 0) { selector.select(); } else { long nextTimeout = timeoutWatchSet.first().getTimeoutTimestamp(); long selectTime = nextTimeout - System.currentTimeMillis(); if (selectTime \u003e 0) { selector.select(selectTime); } else { // Next timeout is now or in past, select immediately so we can time out selector.selectNow(); } } } catch (IOException e) { LOGGER.error(\"Caught IOException in TAsyncClientManager!\", e); } // 过渡状态 transitionMethods(); // 检查是否超时 timeoutMethods(); // 开始待执行的方法 startPendingMethods(); } catch (Exception exception) { LOGGER.error(\"Ignoring uncaught exception in SelectThread\", exception); } } try { selector.close(); } catch (IOException ex) { LOGGER.warn(\"Could not close selector. This may result in leaked resources!\", ex); } } org.apache.thrift.async.TAsyncClientManager.SelectThread#startPendingMethods 从队列中获取待执行的请求，然后注册选择器，根据状态进行相应的操作\nprivate void startPendingMethods() { TAsyncMethodCall methodCall; while ((methodCall = pendingCalls.poll()) != null) { try { // 注册 Selector，开始第一个状态，既可以用于连接，也可以用于写入 methodCall.start(selector); // 如果有超时则添加超时 TAsyncClient client = methodCall.getClient(); if (client.hasTimeout() \u0026\u0026 !client.hasError()) { timeoutWatchSet.add(methodCall); } } catch (Exception exception) { LOGGER.warn(\"Caught exception in TAsyncClientManager!\", exception); methodCall.onError(exception); } } } org.apache.thrift.async.TAsyncMethodCall#start 根据状态向 Transport 注册相应的操作\nvoid start(Selector sel) throws IOException { SelectionKey key; // 如果 Transport 是开启的，则修改状态为 WRITING_REQUEST_SIZE，注册写操作 if (transport.isOpen()) { state = State.WRITING_REQUEST_SIZE; key = transport.registerSelector(sel, SelectionKey.OP_WRITE); } else { // Transport 状态不是开启的，修改状态为 CONNECTING，注册连接操作 state = State.CONNECTING; key = transport.registerSelector(sel, SelectionKey.OP_CONNECT); // non-blocking connect can complete immediately, // in which case we should not expect the OP_CONNECT // 开启连接后注册写入 if (transport.startConnect()) { registerForFirstWrite(key); } } key.attach(this); } org.apache.thrift.async.TAsyncMethodCall#doWritingRequestBody 在 org.apache.thrift.async.TAsyncMethodCall#transition 执行建立连接，写入请求头后开始写入请求体；当写入完成后，，会根据请求类型做相应操作；如果是 oneway，则执行请求回调流程并完成请求；如果不是，则修改状态，等待读取\nprivate void doWritingRequestBody(SelectionKey key) throws IOException { if (transport.write(frameBuffer) \u003c 0) { throw new IOException(\"Write call frame failed\"); } if (frameBuffer.remaining() == 0) { if (isOneway) { cleanUpAndFireCallback(key); } else { state = State.READING_RESPONSE_SIZE; sizeBuffer.rewind(); // Prepare to read incoming frame size key.interestOps(SelectionKey.OP_READ); } } } 处理响应 在请求发送完成后，SelectionKey的状态被修改为 READING_RESPONSE_SIZE，当接收到服务端的响应后，会先读取响应大小，然后将状态修改为 READING_RESPONSE_BODY，然后读取响应内容\norg.apache.thrift.async.TAsyncMethodCall#doReadingResponseBody 会读取所有的响应内容到缓冲区，然后执行请求完成流程\nprivate void doReadingResponseBody(SelectionKey key) throws IOException { if (transport.read(frameBuffer) \u003c 0) { throw new IOException(\"Read call frame failed\"); } if (frameBuffer.remaining() == 0) { cleanUpAndFireCallback(key); } } org.apache.thrift.async.TAsyncMethodCall#cleanUpAndFireCallback 修改请求状态，释放 SelectionKey，然后获取响应结果，执行回调\nprivate void cleanUpAndFireCallback(SelectionKey key) { state = State.RESPONSE_READ; key.interestOps(0); // this ensures that the TAsyncMethod instance doesn't hang around key.attach(null); try { T result = this.getResult(); client.onComplete(); callback.onComplete(result); } catch (Exception e) { key.cancel(); onError(e); } } io.github.helloworlde.thrift.HelloService.AsyncClient.sayHello_call#getResult public HelloResponse getResult() throws org.apache.thrift.TException { if (getState() != org.apache.thrift.async.TAsyncMethodCall.State.RESPONSE_READ) { throw new java.lang.IllegalStateException(\"Method call not finished!\"); } org.apache.thrift.transport.TMemoryInputTransport memoryTransport = new org.apache.thrift.transport.TMemoryInputTransport(getFrameBuffer().array()); org.apache.thrift.protocol.TProtocol prot = client.getProtocolFactory().getProtocol(memoryTransport); return (new Client(prot)).recv_sayHello(); } io.github.helloworlde.thrift.HelloService.Client#recv_sayHello 会先构建响应对象，然后获取结果内容，作为结果返回\npublic HelloResponse recv_sayHello() throws org.apache.thrift.TException { sayHello_result result = new sayHello_result(); receiveBase(result, \"sayHello\"); if (result.isSetSuccess()) { return result.success; } throw new org.apache.thrift.TApplicationException(org.apache.thrift.TApplicationException.MISSING_RESULT, \"sayHello failed: unknown result\"); } org.apache.thrift.TServiceClient#receiveBase 从 TProtocol 中读取响应内容，根据响应的结果，如果是正常则由相应类读取并解析为其实例，如果异常则抛出\nprotected void receiveBase(TBase\u003c?, ?\u003e result, String methodName) throws TException { // 读取消息 TMessage msg = iprot_.readMessageBegin(); // 如果是异常，则读取异常并抛出 if (msg.type == TMessageType.EXCEPTION) { TApplicationException x = new TApplicationException(); x.read(iprot_); iprot_.readMessageEnd(); throw x; } // 如果请求序号不匹配，则抛出异常 if (msg.seqid != seqid_) { throw new TApplicationException(TApplicationException.BAD_SEQUENCE_ID, String.format(\"%s failed: out of sequence response: expected %d but got %d\", methodName, seqid_, msg.seqid)); } // 读取响应内容 result.read(iprot_); iprot_.readMessageEnd(); } org.apache.thrift.async.AsyncMethodCallback#onComplete 最终执行回调\npublic void onComplete(HelloResponse response) { log.info(\"响应结果: {}\", response.getMessage()); } 参考文档 helloworlde/thrift-java-sample ","wordCount":"847","inLanguage":"en","datePublished":"2021-02-20T22:34:46Z","dateModified":"2021-02-20T22:34:46Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/thrift-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Thrift 客户端异步请求</h1></header><p><small>February 20, 2021&nbsp;· 847 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#实现>实现</a><ul><li><a href=#idl>IDL</a></li><li><a href=#客户端>客户端</a></li></ul></li><li><a href=#请求处理流程>请求处理流程</a><ul><li><a href=#构建-client-和回调>构建 Client 和回调</a></li><li><a href=#执行请求>执行请求</a></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div><section class=blog-content><h1 id=thrift-客户端异步请求>Thrift 客户端异步请求</h1><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#f92672>namespace</span> java io.github.helloworlde.thrift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>service</span> <span style=color:#a6e22e>HelloService</span> {
</span></span><span style=display:flex><span>    HelloResponse <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span>: HelloMessage request);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=客户端>客户端</h3><p>异步客户端调用使用 <code>AsyncClient</code>，传输层使用 <code>TNonblockingSocket</code>；需要实现 <code>AsyncMethodCallback</code>作为回调，用于处理请求结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AsyncClient</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 构建异步客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            TAsyncClientManager clientManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TAsyncClientManager<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            TProtocolFactory protocolFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TBinaryProtocol<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>(</span>clientManager<span style=color:#f92672>,</span> protocolFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            TNonblockingTransport nonblockingTransport <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TNonblockingSocket<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>9090</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncClient</span> asyncClient <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span><span style=color:#a6e22e>getAsyncClient</span><span style=color:#f92672>(</span>nonblockingTransport<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 异步回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            AsyncMethodCallback<span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;</span> callback <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AsyncMethodCallback<span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onComplete</span><span style=color:#f92672>(</span>HelloResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;响应结果: {}&#34;</span><span style=color:#f92672>,</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span>Exception exception<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;请求失败: {}&#34;</span><span style=color:#f92672>,</span> exception<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 构建请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            HelloMessage request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloMessage<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            request<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Async Thrift&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            asyncClient<span style=color:#f92672>.</span><span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> callback<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>TException <span style=color:#f92672>|</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span><span style=color:#ae81ff>3</span>_000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><h3 id=构建-client-和回调>构建 Client 和回调</h3><h4 id=1-构建-client>1. 构建 Client</h4><p>异步的客户端由抽象类 <code>TAsyncClient</code> 定义，实现类继承了 <code>TAsyncClient</code>，同时实现了 <code>AsyncIface</code>；
在构建其 Factory 时需要三个参数，分别是 <code>TAsyncClientManager</code>，用于管理调用请求的所有流程；和 <code>TProtocolFactory</code>，用于获取协议；还有 <code>TNonblockingTransport</code>，用于底层的传输，必须是非阻塞的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 构建异步客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>TAsyncClientManager clientManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TAsyncClientManager<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>TProtocolFactory protocolFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TBinaryProtocol<span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span> factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Factory</span><span style=color:#f92672>(</span>clientManager<span style=color:#f92672>,</span> protocolFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TNonblockingTransport nonblockingTransport <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TNonblockingSocket<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>9090</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>HelloService<span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncClient</span> asyncClient <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span><span style=color:#a6e22e>getAsyncClient</span><span style=color:#f92672>(</span>nonblockingTransport<span style=color:#f92672>);</span>
</span></span></code></pre></div><h4 id=2-构建回调>2. 构建回调</h4><p>回调由 <code>AsyncMethodCallback</code> 接口定义，有两个方法，分别是用于处理正常返回的 <code>onComplete</code> 和处理异常结果的 <code>onError</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>AsyncMethodCallback<span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;</span> callback <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AsyncMethodCallback<span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onComplete</span><span style=color:#f92672>(</span>HelloResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;响应结果: {}&#34;</span><span style=color:#f92672>,</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span>Exception exception<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;请求失败: {}&#34;</span><span style=color:#f92672>,</span> exception<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span></code></pre></div><h3 id=执行请求>执行请求</h3><h4 id=发起请求>发起请求</h4><p>调用接口时需要两个参数，请求内容和响应回调</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>HelloMessage request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloMessage<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Async Thrift&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>asyncClient<span style=color:#f92672>.</span><span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> callback<span style=color:#f92672>);</span>
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.AsyncClient#sayHello</li></ul><p>会构建 <code>sayHello_call</code>，该类是 <code>TAsyncMethodCall</code> 的实现类，支持写入消息和获取结果，然后将该实例作为参数调用 <code>org.apache.thrift.async.TAsyncClientManager#call</code> 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span>HelloMessage request<span style=color:#f92672>,</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>async</span><span style=color:#f92672>.</span><span style=color:#a6e22e>AsyncMethodCallback</span><span style=color:#f92672>&lt;</span>HelloResponse<span style=color:#f92672>&gt;</span> resultHandler<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    checkReady<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    sayHello_call method_call <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_call<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> resultHandler<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> ___protocolFactory<span style=color:#f92672>,</span> ___transport<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>___currentMethod</span> <span style=color:#f92672>=</span> method_call<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    ___manager<span style=color:#f92672>.</span><span style=color:#a6e22e>call</span><span style=color:#f92672>(</span>method_call<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncClientManager#call</li></ul><p>初始化请求，将请求加入到队列中，然后唤醒 Selector 执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>call</span><span style=color:#f92672>(</span>TAsyncMethodCall method<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isRunning<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SelectThread is not running&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化缓冲区
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    method<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareMethodCall</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加到待执行方法中，由 SelectThread 处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    pendingCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>method<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    selectThread<span style=color:#f92672>.</span><span style=color:#a6e22e>getSelector</span><span style=color:#f92672>().</span><span style=color:#a6e22e>wakeup</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncMethodCall#prepareMethodCall</li></ul><p>执行初始化请求，，将请求消息写入到 Protocol 中，然后封装为 ByteBuffer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>prepareMethodCall</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TMemoryBuffer memoryBuffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TMemoryBuffer<span style=color:#f92672>(</span>INITIAL_MEMORY_BUFFER_SIZE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    TProtocol protocol <span style=color:#f92672>=</span> protocolFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getProtocol</span><span style=color:#f92672>(</span>memoryBuffer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    write_args<span style=color:#f92672>(</span>protocol<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> length <span style=color:#f92672>=</span> memoryBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    frameBuffer <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>memoryBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>getArray</span><span style=color:#f92672>(),</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> length<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    TFramedTransport<span style=color:#f92672>.</span><span style=color:#a6e22e>encodeFrameSize</span><span style=color:#f92672>(</span>length<span style=color:#f92672>,</span> sizeBufferArray<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    sizeBuffer <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>sizeBufferArray<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.AsyncClient.sayHello_call#write_args</li></ul><p>将消息写入到流中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write_args</span><span style=color:#f92672>(</span>org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TProtocol</span> prot<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    prot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeMessageBegin</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TMessage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sayHello&#34;</span><span style=color:#f92672>,</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TMessageType</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CALL</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    sayHello_args args <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_args<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    args<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequest</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    args<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>prot<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    prot<span style=color:#f92672>.</span><span style=color:#a6e22e>writeMessageEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncClientManager.SelectThread#run</li></ul><p>由 <code>SelectThread</code> 处理请求，在执行时，会先修改 <code>TAsyncMethodCall</code> 的状态，如果需要连接，则执行建立连接；如果需要写入或者读取则执行写入或者读取；然后会检查请求是否超时，如果没有超时，则开始执行待调用的方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>running<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeoutWatchSet<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    selector<span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>long</span> nextTimeout <span style=color:#f92672>=</span> timeoutWatchSet<span style=color:#f92672>.</span><span style=color:#a6e22e>first</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getTimeoutTimestamp</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>long</span> selectTime <span style=color:#f92672>=</span> nextTimeout <span style=color:#f92672>-</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>selectTime <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        selector<span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>selectTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// Next timeout is now or in past, select immediately so we can time out
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        selector<span style=color:#f92672>.</span><span style=color:#a6e22e>selectNow</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Caught IOException in TAsyncClientManager!&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 过渡状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            transitionMethods<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 检查是否超时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            timeoutMethods<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 开始待执行的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            startPendingMethods<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception exception<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Ignoring uncaught exception in SelectThread&#34;</span><span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        selector<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Could not close selector. This may result in leaked resources!&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncClientManager.SelectThread#startPendingMethods</li></ul><p>从队列中获取待执行的请求，然后注册选择器，根据状态进行相应的操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startPendingMethods</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TAsyncMethodCall methodCall<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>methodCall <span style=color:#f92672>=</span> pendingCalls<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 注册 Selector，开始第一个状态，既可以用于连接，也可以用于写入
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            methodCall<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span>selector<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果有超时则添加超时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            TAsyncClient client <span style=color:#f92672>=</span> methodCall<span style=color:#f92672>.</span><span style=color:#a6e22e>getClient</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>hasTimeout</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>client<span style=color:#f92672>.</span><span style=color:#a6e22e>hasError</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                timeoutWatchSet<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>methodCall<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception exception<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Caught exception in TAsyncClientManager!&#34;</span><span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            methodCall<span style=color:#f92672>.</span><span style=color:#a6e22e>onError</span><span style=color:#f92672>(</span>exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncMethodCall#start</li></ul><p>根据状态向 Transport 注册相应的操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>(</span>Selector sel<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    SelectionKey key<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 Transport 是开启的，则修改状态为 WRITING_REQUEST_SIZE，注册写操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>transport<span style=color:#f92672>.</span><span style=color:#a6e22e>isOpen</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        state <span style=color:#f92672>=</span> State<span style=color:#f92672>.</span><span style=color:#a6e22e>WRITING_REQUEST_SIZE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        key <span style=color:#f92672>=</span> transport<span style=color:#f92672>.</span><span style=color:#a6e22e>registerSelector</span><span style=color:#f92672>(</span>sel<span style=color:#f92672>,</span> SelectionKey<span style=color:#f92672>.</span><span style=color:#a6e22e>OP_WRITE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Transport 状态不是开启的，修改状态为 CONNECTING，注册连接操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        state <span style=color:#f92672>=</span> State<span style=color:#f92672>.</span><span style=color:#a6e22e>CONNECTING</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        key <span style=color:#f92672>=</span> transport<span style=color:#f92672>.</span><span style=color:#a6e22e>registerSelector</span><span style=color:#f92672>(</span>sel<span style=color:#f92672>,</span> SelectionKey<span style=color:#f92672>.</span><span style=color:#a6e22e>OP_CONNECT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// non-blocking connect can complete immediately,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// in which case we should not expect the OP_CONNECT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 开启连接后注册写入
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>transport<span style=color:#f92672>.</span><span style=color:#a6e22e>startConnect</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            registerForFirstWrite<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    key<span style=color:#f92672>.</span><span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncMethodCall#doWritingRequestBody</li></ul><p>在 <code>org.apache.thrift.async.TAsyncMethodCall#transition</code> 执行建立连接，写入请求头后开始写入请求体；当写入完成后，，会根据请求类型做相应操作；如果是 oneway，则执行请求回调流程并完成请求；如果不是，则修改状态，等待读取</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doWritingRequestBody</span><span style=color:#f92672>(</span>SelectionKey key<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>transport<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>frameBuffer<span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Write call frame failed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>frameBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>remaining</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isOneway<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            cleanUpAndFireCallback<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>=</span> State<span style=color:#f92672>.</span><span style=color:#a6e22e>READING_RESPONSE_SIZE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            sizeBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>rewind</span><span style=color:#f92672>();</span>  <span style=color:#75715e>// Prepare to read incoming frame size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            key<span style=color:#f92672>.</span><span style=color:#a6e22e>interestOps</span><span style=color:#f92672>(</span>SelectionKey<span style=color:#f92672>.</span><span style=color:#a6e22e>OP_READ</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=处理响应>处理响应</h4><p>在请求发送完成后，<code>SelectionKey</code>的状态被修改为 <code>READING_RESPONSE_SIZE</code>，当接收到服务端的响应后，会先读取响应大小，然后将状态修改为 <code>READING_RESPONSE_BODY</code>，然后读取响应内容</p><ul><li>org.apache.thrift.async.TAsyncMethodCall#doReadingResponseBody</li></ul><p>会读取所有的响应内容到缓冲区，然后执行请求完成流程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doReadingResponseBody</span><span style=color:#f92672>(</span>SelectionKey key<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>transport<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>frameBuffer<span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IOException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Read call frame failed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>frameBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>remaining</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        cleanUpAndFireCallback<span style=color:#f92672>(</span>key<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.TAsyncMethodCall#cleanUpAndFireCallback</li></ul><p>修改请求状态，释放 <code>SelectionKey</code>，然后获取响应结果，执行回调</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanUpAndFireCallback</span><span style=color:#f92672>(</span>SelectionKey key<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state <span style=color:#f92672>=</span> State<span style=color:#f92672>.</span><span style=color:#a6e22e>RESPONSE_READ</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    key<span style=color:#f92672>.</span><span style=color:#a6e22e>interestOps</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// this ensures that the TAsyncMethod instance doesn&#39;t hang around
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    key<span style=color:#f92672>.</span><span style=color:#a6e22e>attach</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        T result <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getResult</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span><span style=color:#a6e22e>onComplete</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onComplete</span><span style=color:#f92672>(</span>result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        key<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        onError<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.AsyncClient.sayHello_call#getResult</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>getResult</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getState<span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>async</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TAsyncMethodCall</span><span style=color:#f92672>.</span><span style=color:#a6e22e>State</span><span style=color:#f92672>.</span><span style=color:#a6e22e>RESPONSE_READ</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> java<span style=color:#f92672>.</span><span style=color:#a6e22e>lang</span><span style=color:#f92672>.</span><span style=color:#a6e22e>IllegalStateException</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Method call not finished!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>transport</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TMemoryInputTransport</span> memoryTransport <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>transport</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TMemoryInputTransport</span><span style=color:#f92672>(</span>getFrameBuffer<span style=color:#f92672>().</span><span style=color:#a6e22e>array</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TProtocol</span> prot <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>getProtocolFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getProtocol</span><span style=color:#f92672>(</span>memoryTransport<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Client<span style=color:#f92672>(</span>prot<span style=color:#f92672>)).</span><span style=color:#a6e22e>recv_sayHello</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.Client#recv_sayHello</li></ul><p>会先构建响应对象，然后获取结果内容，作为结果返回</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>recv_sayHello</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sayHello_result result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_result<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    receiveBase<span style=color:#f92672>(</span>result<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;sayHello&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>result<span style=color:#f92672>.</span><span style=color:#a6e22e>isSetSuccess</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TApplicationException</span><span style=color:#f92672>(</span>org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>thrift</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TApplicationException</span><span style=color:#f92672>.</span><span style=color:#a6e22e>MISSING_RESULT</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;sayHello failed: unknown result&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.TServiceClient#receiveBase</li></ul><p>从 <code>TProtocol</code> 中读取响应内容，根据响应的结果，如果是正常则由相应类读取并解析为其实例，如果异常则抛出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receiveBase</span><span style=color:#f92672>(</span>TBase<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> result<span style=color:#f92672>,</span> String methodName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> TException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TMessage msg <span style=color:#f92672>=</span> iprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>readMessageBegin</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是异常，则读取异常并抛出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>type</span> <span style=color:#f92672>==</span> TMessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>EXCEPTION</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        TApplicationException x <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TApplicationException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        x<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>iprot_<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        iprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>readMessageEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> x<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果请求序号不匹配，则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>seqid</span> <span style=color:#f92672>!=</span> seqid_<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TApplicationException<span style=color:#f92672>(</span>TApplicationException<span style=color:#f92672>.</span><span style=color:#a6e22e>BAD_SEQUENCE_ID</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s failed: out of sequence response: expected %d but got %d&#34;</span><span style=color:#f92672>,</span> methodName<span style=color:#f92672>,</span> seqid_<span style=color:#f92672>,</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>seqid</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取响应内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>iprot_<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    iprot_<span style=color:#f92672>.</span><span style=color:#a6e22e>readMessageEnd</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>org.apache.thrift.async.AsyncMethodCallback#onComplete</li></ul><p>最终执行回调</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onComplete</span><span style=color:#f92672>(</span>HelloResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;响应结果: {}&#34;</span><span style=color:#f92672>,</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>Thrfit 服务端请求处理流程</span></a>
<a class=next href=https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-transport/><span>Thrift 中的 Transport</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>