<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>MySQL 中关于gap lock / next-key lock 的一个问题</title>
<meta charset=utf-8><meta name=description content="Ladder@MySQL 中关于gap lock / next-key lock 的一个问题 在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾
问题描述 表初始化 CREATE TABLE z ( id INT PRIMARY KEY AUTO_INCREMENT, b INT, KEY b(b) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; INSERT INTO z (id, b) VALUES (1, 2), (3, 4), (5, 6), (7, 8), (9, 10); session A BEGIN; SELECT * FROM z WHERE b = 6 FOR UPDATE; session B INSERT INTO z VALUES (2, 4);/*success*/ INSERT INTO z VALUES (2, 8);/*blocked*/ INSERT INTO z VALUES (4, 4);/*blocked*/ INSERT INTO z VALUES (4, 8);/*blocked*/ INSERT INTO z VALUES (8, 4);/*blocked*/ INSERT INTO z VALUES (8, 8);/*success*/ INSERT INTO z VALUES (0, 4);/*blocked*/ INSERT INTO z VALUES (-1, 4);/*success*/ 分别执行 session B中的insert 会出现上述情况，为什么？"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="MySQL 中关于gap lock / next-key lock 的一个问题"><meta property="og:description" content="MySQL 中关于gap lock / next-key lock 的一个问题 在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾
问题描述 表初始化 CREATE TABLE z ( id INT PRIMARY KEY AUTO_INCREMENT, b INT, KEY b(b) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; INSERT INTO z (id, b) VALUES (1, 2), (3, 4), (5, 6), (7, 8), (9, 10); session A BEGIN; SELECT * FROM z WHERE b = 6 FOR UPDATE; session B INSERT INTO z VALUES (2, 4);/*success*/ INSERT INTO z VALUES (2, 8);/*blocked*/ INSERT INTO z VALUES (4, 4);/*blocked*/ INSERT INTO z VALUES (4, 8);/*blocked*/ INSERT INTO z VALUES (8, 4);/*blocked*/ INSERT INTO z VALUES (8, 8);/*success*/ INSERT INTO z VALUES (0, 4);/*blocked*/ INSERT INTO z VALUES (-1, 4);/*success*/ 分别执行 session B中的insert 会出现上述情况，为什么？"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-01-07T21:40:58+00:00"><meta property="article:modified_time" content="2019-01-07T21:40:58+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="MySQL 中关于gap lock / next-key lock 的一个问题"><meta name=twitter:description content="MySQL 中关于gap lock / next-key lock 的一个问题 在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾
问题描述 表初始化 CREATE TABLE z ( id INT PRIMARY KEY AUTO_INCREMENT, b INT, KEY b(b) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; INSERT INTO z (id, b) VALUES (1, 2), (3, 4), (5, 6), (7, 8), (9, 10); session A BEGIN; SELECT * FROM z WHERE b = 6 FOR UPDATE; session B INSERT INTO z VALUES (2, 4);/*success*/ INSERT INTO z VALUES (2, 8);/*blocked*/ INSERT INTO z VALUES (4, 4);/*blocked*/ INSERT INTO z VALUES (4, 8);/*blocked*/ INSERT INTO z VALUES (8, 4);/*blocked*/ INSERT INTO z VALUES (8, 8);/*success*/ INSERT INTO z VALUES (0, 4);/*blocked*/ INSERT INTO z VALUES (-1, 4);/*success*/ 分别执行 session B中的insert 会出现上述情况，为什么？"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"MySQL 中关于gap lock / next-key lock 的一个问题","item":"https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MySQL 中关于gap lock / next-key lock 的一个问题","name":"MySQL 中关于gap lock \/ next-key lock 的一个问题","description":"MySQL 中关于gap lock / next-key lock 的一个问题 在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾\n问题描述 表初始化 CREATE TABLE z ( id INT PRIMARY KEY AUTO_INCREMENT, b INT, KEY b(b) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; INSERT INTO z (id, b) VALUES (1, 2), (3, 4), (5, 6), (7, 8), (9, 10); session A BEGIN; SELECT * FROM z WHERE b = 6 FOR UPDATE; session B INSERT INTO z VALUES (2, 4);/*success*/ INSERT INTO z VALUES (2, 8);/*blocked*/ INSERT INTO z VALUES (4, 4);/*blocked*/ INSERT INTO z VALUES (4, 8);/*blocked*/ INSERT INTO z VALUES (8, 4);/*blocked*/ INSERT INTO z VALUES (8, 8);/*success*/ INSERT INTO z VALUES (0, 4);/*blocked*/ INSERT INTO z VALUES (-1, 4);/*success*/ 分别执行 session B中的insert 会出现上述情况，为什么？","keywords":["MySQL"],"articleBody":"MySQL 中关于gap lock / next-key lock 的一个问题 在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾\n问题描述 表初始化 CREATE TABLE z ( id INT PRIMARY KEY AUTO_INCREMENT, b INT, KEY b(b) ) ENGINE = InnoDB DEFAULT CHARSET = utf8; INSERT INTO z (id, b) VALUES (1, 2), (3, 4), (5, 6), (7, 8), (9, 10); session A BEGIN; SELECT * FROM z WHERE b = 6 FOR UPDATE; session B INSERT INTO z VALUES (2, 4);/*success*/ INSERT INTO z VALUES (2, 8);/*blocked*/ INSERT INTO z VALUES (4, 4);/*blocked*/ INSERT INTO z VALUES (4, 8);/*blocked*/ INSERT INTO z VALUES (8, 4);/*blocked*/ INSERT INTO z VALUES (8, 8);/*success*/ INSERT INTO z VALUES (0, 4);/*blocked*/ INSERT INTO z VALUES (-1, 4);/*success*/ 分别执行 session B中的insert 会出现上述情况，为什么？\n加锁过程 在索引 b 上的等值查询，给索引 b 加上了 next-key lock (4, 6]；索引向右遍历，且最后一个值不满足条件时退化为间隙锁；所以会再加上间隙锁 (6,8)；所以索引 b 上的 next-key lock 的范围是(b=4,id=3)到(b=6,id=5)这个左开右闭区间和(b=6,id=5)到(b=8,id=7)这个开区间 for update 会给 b = 6 这一行加上行锁；因此 (b=6,id=5) 这一行上有行锁 这么看来上述语句都不在锁的范围内，为什么会被锁 这个问题其实是因为没有理解索引的结构，所以认为所有值都不应该被锁\n如图所示，此时索引 b 上的锁： 图中绿色部分即为被锁范围；索引会根据 b 和 id 的值进行排序，插入不同的值，锁的范围是不一样的；分别插入 (b=4,id=2) 和(b=4,id=4)，插入的位置如图所示： 因为索引是有序的，此时，由于记录(b=4,id=3)的存在，(b=4,id=2)不在锁的范围内，可以插入，但(b=4,id=4)在锁的范围内，所以插入时需要等待锁释放，被 blocked 对于其他(id,b)的值(2,8),(4,8),(8,4),(8,8)也是同样的道理；因此，得出以下结论： id \u003c= 2 时，b 索引锁范围为 (4,8] 2 \u003c id \u003c 8 时，b 索引锁范围为 [4,8] a \u003e= 8 时，b 索引锁范围为 [4,8) 但是，实践发现，当 id=0 时，被锁的范围为 [4,8)，这和我们得到的第一个结论(4,8]不一样；此时分析得到的示意图为： 在 session A 中尝试插入 (b=4, id=0)并查询结果： INSERT INTO z VALUES (0, 4); SELECT * FROM z; 此时，发现表中并没有发现 (b=4, id=0)这条记录，但是多了 (b=4,id=10)这条；所以插入 (b=4, id=0)的时候真正插入的是 (b=4,id=10)这个值；这是因为我们在创建表的时候指定主键 id 的值 AUTO INCREMENT，当插入的主键值为0的时候，会被替换为 AUTO_INCREMENT的值，即10 对此，MySQL 官方文档中的解释是：在非 NO_AUTO_VALUE_ON_ZERO模式下，给自增的列赋值为 0，都会被替换为自增序列的下一个值；当该自增列值指定 NOT NULL 时赋值 NULL，也会被替换；当插入其他值时，自增序列的值会被替换为当前列中最大值的下一个值；参考 MySQL 8.0 Reference Manual 文档，Tutorial 的 Examples of Common Queries , 3.6.9 Using AUTO_INCREMENT No value was specified for the AUTO_INCREMENT column, so MySQL assigned sequence numbers automatically. You can also explicitly assign 0 to the column to generate sequence numbers, unless the NO_AUTO_VALUE_ON_ZERO SQL mode is enabled.\nIf the column is declared NOT NULL, it is also possible to assign NULL to the column to generate sequence numbers.\nWhen you insert any other value into an AUTO_INCREMENT column, the column is set to that value and the sequence is reset so that the next automatically generated value follows sequentially from the largest column value.\n如果将主键修改为不自增，插入 (b=4, id=0) 会得到这条记录 特别感谢 @__丁奇 老师的耐心解答，老师的专栏 MySQL 实战 45讲 是一个非常好的专栏，内容和评论的质量都很高，想学习 MySQL 的同学可以订阅 文章相关的极客专栏为 21 | 为什么我只改一行的语句，锁这么多？ ","wordCount":"340","inLanguage":"en","datePublished":"2019-01-07T21:40:58Z","dateModified":"2019-01-07T21:40:58Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.af9899d47b21c333d192dccc82e0aa6650046e1a76ff4eaf89be703b64d94684.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>MySQL 中关于gap lock / next-key lock 的一个问题</h1></header><p><small>January 7, 2019&nbsp;· 340 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><ul><li><a href=#问题描述>问题描述</a></li><li><a href=#加锁过程>加锁过程</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=mysql-中关于gap-lock--next-key-lock-的一个问题>MySQL 中关于gap lock / next-key lock 的一个问题</h1><blockquote><p>在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾</p></blockquote><h3 id=问题描述>问题描述</h3><ul><li>表初始化</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> z (
</span></span><span style=display:flex><span>  id INT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  b  INT,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>KEY</span> b(b)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>  ENGINE <span style=color:#f92672>=</span> InnoDB
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>DEFAULT</span> CHARSET <span style=color:#f92672>=</span> utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z (id, b)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>  (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>),
</span></span><span style=display:flex><span>  (<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>),
</span></span><span style=display:flex><span>  (<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>  (<span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>);
</span></span></code></pre></div><ul><li>session A</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> z
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> b <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span> <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>UPDATE</span>;
</span></span></code></pre></div><ul><li>session B</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>);<span style=color:#75715e>/*success*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>8</span>);<span style=color:#75715e>/*blocked*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>);<span style=color:#75715e>/*blocked*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>8</span>);<span style=color:#75715e>/*blocked*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>4</span>);<span style=color:#75715e>/*blocked*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>);<span style=color:#75715e>/*success*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>4</span>);<span style=color:#75715e>/*blocked*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z <span style=color:#66d9ef>VALUES</span> (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>);<span style=color:#75715e>/*success*/</span>
</span></span></code></pre></div><p>分别执行 session B中的insert 会出现上述情况，为什么？</p><h3 id=加锁过程>加锁过程</h3><ol><li>在索引 b 上的等值查询，给索引 b 加上了 next-key lock (4, 6]；索引向右遍历，且最后一个值不满足条件时退化为间隙锁；所以会再加上间隙锁 (6,8)；所以索引 b 上的 next-key lock 的范围是(b=4,id=3)到(b=6,id=5)这个左开右闭区间和(b=6,id=5)到(b=8,id=7)这个开区间</li><li>for update 会给 b = 6 这一行加上行锁；因此 (b=6,id=5) 这一行上有行锁</li></ol><hr><ul><li>这么看来上述语句都不在锁的范围内，为什么会被锁</li></ul><p>这个问题其实是因为没有理解索引的结构，所以认为所有值都不应该被锁</p><ul><li>如图所示，此时索引 b 上的锁：</li></ul><p><img src=https://img.hellowood.dev/blog/mysql/lock/%E7%B4%A2%E5%BC%95%20b%20%E9%94%81%E8%8C%83%E5%9B%B4.png alt="索引 b 锁范围.png"></p><ul><li>图中绿色部分即为被锁范围；索引会根据 b 和 id 的值进行排序，插入不同的值，锁的范围是不一样的；分别插入 (b=4,id=2) 和(b=4,id=4)，插入的位置如图所示：</li></ul><p><img src=https://img.hellowood.dev/blog/mysql/lock/%282%2C4%29%26%284%2C4%29%E7%B4%A2%E5%BC%95%20b%20%E9%94%81%E8%8C%83%E5%9B%B4.png alt="(2,4)&(4,4)索引 b 锁范围.png"></p><ul><li>因为索引是有序的，此时，由于记录(b=4,id=3)的存在，(b=4,id=2)不在锁的范围内，可以插入，但(b=4,id=4)在锁的范围内，所以插入时需要等待锁释放，被 blocked</li><li>对于其他(id,b)的值(2,8),(4,8),(8,4),(8,8)也是同样的道理；因此，得出以下结论：<ul><li>id &lt;= 2 时，b 索引锁范围为 (4,8]</li><li>2 &lt; id &lt; 8 时，b 索引锁范围为 [4,8]</li><li>a >= 8 时，b 索引锁范围为 [4,8)</li></ul></li></ul><p><img src=https://img.hellowood.dev/blog/mysql/lock/%282%2C8%29%2C%284%2C8%29%2C%288%2C4%29%2C%288%2C8%29%E7%B4%A2%E5%BC%95%20b%20%E9%94%81%E8%8C%83%E5%9B%B4.png alt="(2,8),(4,8),(8,4),(8,8)索引 b 锁范围.png"></p><ul><li>但是，实践发现，当 id=0 时，被锁的范围为 [4,8)，这和我们得到的第一个结论(4,8]不一样；此时分析得到的示意图为：</li></ul><p><img src=https://img.hellowood.dev/blog/mysql/lock/%280%2C4%29%2C%280%2C8%29%E7%B4%A2%E5%BC%95%20b%20%E9%94%81%E8%8C%83%E5%9B%B4.png alt="(0,4),(0,8)索引 b 锁范围.png"></p><ul><li>在 session A 中尝试插入 (b=4, id=0)并查询结果：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> z
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> z;
</span></span></code></pre></div><ul><li>此时，发现表中并没有发现 (b=4, id=0)这条记录，但是多了 (b=4,id=10)这条；所以插入 (b=4, id=0)的时候真正插入的是 (b=4,id=10)这个值；这是因为我们在创建表的时候指定主键 id 的值 <code>AUTO INCREMENT</code>，当插入的主键值为0的时候，会被替换为 <code>AUTO_INCREMENT</code>的值，即10</li></ul><p><img src=https://img.hellowood.dev/blog/mysql/lock/%280%2C4%29%E6%8F%92%E5%85%A5%E5%90%8E%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C.png alt=(0,4)插入后查询结果.png></p><ul><li>对此，MySQL 官方文档中的解释是：在非 <code>NO_AUTO_VALUE_ON_ZERO</code>模式下，给自增的列赋值为 0，都会被替换为自增序列的下一个值；当该自增列值指定 NOT NULL 时赋值 NULL，也会被替换；当插入其他值时，自增序列的值会被替换为当前列中最大值的下一个值；参考 <a href=https://dev.mysql.com/doc/refman/8.0/en/example-auto-increment.html>MySQL 8.0 Reference Manual 文档，Tutorial 的 Examples of Common Queries , 3.6.9 Using AUTO_INCREMENT</a></li></ul><blockquote><p>No value was specified for the AUTO_INCREMENT column, so MySQL assigned sequence numbers automatically. You can also explicitly assign 0 to the column to generate sequence numbers, unless the NO_AUTO_VALUE_ON_ZERO SQL mode is enabled.</p><p>If the column is declared NOT NULL, it is also possible to assign NULL to the column to generate sequence numbers.</p><p>When you insert any other value into an AUTO_INCREMENT column, the column is set to that value and the sequence is reset so that the next automatically generated value follows sequentially from the largest column value.</p></blockquote><ul><li>如果将主键修改为不自增，插入 (b=4, id=0) 会得到这条记录</li></ul><hr><ul><li>特别感谢 <a href="https://weibo.com/tdingqi?is_all=1">@__丁奇</a> 老师的耐心解答，老师的专栏 <a href=http://gk.link/a/101Si>MySQL 实战 45讲</a> 是一个非常好的专栏，内容和评论的质量都很高，想学习 MySQL 的同学可以订阅</li><li>文章相关的极客专栏为 <a href=https://time.geekbang.org/column/article/75659>21 | 为什么我只改一行的语句，锁这么多？</a></li></ul><p><img src=https://img.hellowood.dev/blog/mysql/lock/MySQL%20%E4%B8%93%E6%A0%8F%E6%B5%B7%E6%8A%A5.jpeg alt=专栏海报></p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/graphql-spring-boot-%E4%BD%BF%E7%94%A8/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>GraphQL Spring Boot 使用</span></a>
<a class=next href=https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-mysql%E4%BF%9D%E5%AD%98emoji-%E8%A1%A8%E6%83%85/><span>SpringBoot 使用 MySQL保存emoji 表情</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>