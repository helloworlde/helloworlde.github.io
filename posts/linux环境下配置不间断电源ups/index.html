<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Linux 环境下配置不间断电源 UPS</title>
<meta charset=utf-8><meta name=description content="Ladder@Linux 环境下配置不间断电源 UPS UPS (Uninterruptible Power Supply)，是一种含有储能装置的不间断电源。主要用于给部分对电源稳定性要求较高的设备，提供不间断的电源
一般的 UPS 都支持通过 USB 连接到电脑或者 NAS 等设备上，Linux/Mac/Windows 均支持使用 UPS；
因为电路不稳定，存在偶尔断电的情况，因此希望通过 UPS 保护树莓派、路由器、光猫、硬盘录像机等设备；将 UPS 通过 USB 接口连接到树莓派，由树莓派控制其他设备在断电时关机
安装 NUT NUT(Network UPS Tools) 是一种开源软件工具，其主要功能特点是实时监控与管理不间断电源（UPS）设备，支持多种通信协议，自动执行操作以应对电力故障，适用于多平台，并允许集中管理多个UPS设备，以确保与这些设备连接的计算机和设备在电力问题发生时能够继续正常运行或安全关闭
NUT中的主要软件组件和功能：
Driver（驱动程序）：NUT包括各种不同制造商的UPS设备的驱动程序，使NUT能够与多种型号的UPS设备通信。这些驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息。
upsd（UPS守护进程）：upsd是NUT的核心守护进程，负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端。它可以通过网络协议（如SNMP、HTTP、XML-RPC等）向其他计算机提供UPS状态信息。
upsmon（UPS监控守护进程）：upsmon监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作。它可以配置为执行自定义脚本、关闭计算机或发送警报通知，以确保系统的连续性和数据完整性。
upslog（UPS事件记录器）：upslog用于记录UPS事件和状态信息，以便后续分析和故障排除。它可以生成日志文件，其中包含UPS的运行历史和电力事件。
nutclient（NUT客户端工具）：NUT提供了一些用于监控和管理UPS的命令行工具，例如upsc用于查询UPS状态，upscmd用于发送命令到UPS，以及upsrw用于修改UPS配置。
安装
apt update && apt install -y nut 通过 USB 连接 UPS 在将 UPS 通过 USB 连接到树莓派后，可以通过查看 USB 设备进行检查
检查 USB 连接 sudo lsusb 其中的 Device 003 就是 UPS，说明 USB 连接正常
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%85%8D%E7%BD%AE%E4%B8%8D%E9%97%B4%E6%96%AD%E7%94%B5%E6%BA%90ups/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="Linux 环境下配置不间断电源 UPS"><meta property="og:description" content="Linux 环境下配置不间断电源 UPS UPS (Uninterruptible Power Supply)，是一种含有储能装置的不间断电源。主要用于给部分对电源稳定性要求较高的设备，提供不间断的电源
一般的 UPS 都支持通过 USB 连接到电脑或者 NAS 等设备上，Linux/Mac/Windows 均支持使用 UPS；
因为电路不稳定，存在偶尔断电的情况，因此希望通过 UPS 保护树莓派、路由器、光猫、硬盘录像机等设备；将 UPS 通过 USB 接口连接到树莓派，由树莓派控制其他设备在断电时关机
安装 NUT NUT(Network UPS Tools) 是一种开源软件工具，其主要功能特点是实时监控与管理不间断电源（UPS）设备，支持多种通信协议，自动执行操作以应对电力故障，适用于多平台，并允许集中管理多个UPS设备，以确保与这些设备连接的计算机和设备在电力问题发生时能够继续正常运行或安全关闭
NUT中的主要软件组件和功能：
Driver（驱动程序）：NUT包括各种不同制造商的UPS设备的驱动程序，使NUT能够与多种型号的UPS设备通信。这些驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息。
upsd（UPS守护进程）：upsd是NUT的核心守护进程，负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端。它可以通过网络协议（如SNMP、HTTP、XML-RPC等）向其他计算机提供UPS状态信息。
upsmon（UPS监控守护进程）：upsmon监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作。它可以配置为执行自定义脚本、关闭计算机或发送警报通知，以确保系统的连续性和数据完整性。
upslog（UPS事件记录器）：upslog用于记录UPS事件和状态信息，以便后续分析和故障排除。它可以生成日志文件，其中包含UPS的运行历史和电力事件。
nutclient（NUT客户端工具）：NUT提供了一些用于监控和管理UPS的命令行工具，例如upsc用于查询UPS状态，upscmd用于发送命令到UPS，以及upsrw用于修改UPS配置。
安装
apt update && apt install -y nut 通过 USB 连接 UPS 在将 UPS 通过 USB 连接到树莓派后，可以通过查看 USB 设备进行检查
检查 USB 连接 sudo lsusb 其中的 Device 003 就是 UPS，说明 USB 连接正常
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%85%8D%E7%BD%AE%E4%B8%8D%E9%97%B4%E6%96%AD%E7%94%B5%E6%BA%90ups/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-04T15:22:56+08:00"><meta property="article:modified_time" content="2023-10-04T15:22:56+08:00"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/proxmox-ve-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-lxc-%E5%AE%B9%E5%99%A8-ct-%E6%A8%A1%E6%9D%BF/"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/%E5%9C%A8%E9%BB%91%E7%BE%A4%E6%99%96%E4%BD%BF%E7%94%A8-docker-%E9%83%A8%E7%BD%B2-proxmox-backup-server/"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E9%98%BF%E5%B0%94%E5%8D%A1%E7%89%B9%E7%8C%AB%E6%A3%92%E6%9B%BF%E6%8D%A2%E5%8C%97%E4%BA%AC%E7%A7%BB%E5%8A%A8-gpon-%E5%85%89%E7%8C%AB/"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux 环境下配置不间断电源 UPS"><meta name=twitter:description content="Linux 环境下配置不间断电源 UPS UPS (Uninterruptible Power Supply)，是一种含有储能装置的不间断电源。主要用于给部分对电源稳定性要求较高的设备，提供不间断的电源
一般的 UPS 都支持通过 USB 连接到电脑或者 NAS 等设备上，Linux/Mac/Windows 均支持使用 UPS；
因为电路不稳定，存在偶尔断电的情况，因此希望通过 UPS 保护树莓派、路由器、光猫、硬盘录像机等设备；将 UPS 通过 USB 接口连接到树莓派，由树莓派控制其他设备在断电时关机
安装 NUT NUT(Network UPS Tools) 是一种开源软件工具，其主要功能特点是实时监控与管理不间断电源（UPS）设备，支持多种通信协议，自动执行操作以应对电力故障，适用于多平台，并允许集中管理多个UPS设备，以确保与这些设备连接的计算机和设备在电力问题发生时能够继续正常运行或安全关闭
NUT中的主要软件组件和功能：
Driver（驱动程序）：NUT包括各种不同制造商的UPS设备的驱动程序，使NUT能够与多种型号的UPS设备通信。这些驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息。
upsd（UPS守护进程）：upsd是NUT的核心守护进程，负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端。它可以通过网络协议（如SNMP、HTTP、XML-RPC等）向其他计算机提供UPS状态信息。
upsmon（UPS监控守护进程）：upsmon监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作。它可以配置为执行自定义脚本、关闭计算机或发送警报通知，以确保系统的连续性和数据完整性。
upslog（UPS事件记录器）：upslog用于记录UPS事件和状态信息，以便后续分析和故障排除。它可以生成日志文件，其中包含UPS的运行历史和电力事件。
nutclient（NUT客户端工具）：NUT提供了一些用于监控和管理UPS的命令行工具，例如upsc用于查询UPS状态，upscmd用于发送命令到UPS，以及upsrw用于修改UPS配置。
安装
apt update && apt install -y nut 通过 USB 连接 UPS 在将 UPS 通过 USB 连接到树莓派后，可以通过查看 USB 设备进行检查
检查 USB 连接 sudo lsusb 其中的 Device 003 就是 UPS，说明 USB 连接正常
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Linux 环境下配置不间断电源 UPS","item":"https://blog.hellowood.dev/posts/linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%85%8D%E7%BD%AE%E4%B8%8D%E9%97%B4%E6%96%AD%E7%94%B5%E6%BA%90ups/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux 环境下配置不间断电源 UPS","name":"Linux 环境下配置不间断电源 UPS","description":"Linux 环境下配置不间断电源 UPS UPS (Uninterruptible Power Supply)，是一种含有储能装置的不间断电源。主要用于给部分对电源稳定性要求较高的设备，提供不间断的电源\n一般的 UPS 都支持通过 USB 连接到电脑或者 NAS 等设备上，Linux/Mac/Windows 均支持使用 UPS；\n因为电路不稳定，存在偶尔断电的情况，因此希望通过 UPS 保护树莓派、路由器、光猫、硬盘录像机等设备；将 UPS 通过 USB 接口连接到树莓派，由树莓派控制其他设备在断电时关机\n安装 NUT NUT(Network UPS Tools) 是一种开源软件工具，其主要功能特点是实时监控与管理不间断电源（UPS）设备，支持多种通信协议，自动执行操作以应对电力故障，适用于多平台，并允许集中管理多个UPS设备，以确保与这些设备连接的计算机和设备在电力问题发生时能够继续正常运行或安全关闭\nNUT中的主要软件组件和功能：\nDriver（驱动程序）：NUT包括各种不同制造商的UPS设备的驱动程序，使NUT能够与多种型号的UPS设备通信。这些驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息。\nupsd（UPS守护进程）：upsd是NUT的核心守护进程，负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端。它可以通过网络协议（如SNMP、HTTP、XML-RPC等）向其他计算机提供UPS状态信息。\nupsmon（UPS监控守护进程）：upsmon监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作。它可以配置为执行自定义脚本、关闭计算机或发送警报通知，以确保系统的连续性和数据完整性。\nupslog（UPS事件记录器）：upslog用于记录UPS事件和状态信息，以便后续分析和故障排除。它可以生成日志文件，其中包含UPS的运行历史和电力事件。\nnutclient（NUT客户端工具）：NUT提供了一些用于监控和管理UPS的命令行工具，例如upsc用于查询UPS状态，upscmd用于发送命令到UPS，以及upsrw用于修改UPS配置。\n安装\napt update \u0026amp;\u0026amp; apt install -y nut 通过 USB 连接 UPS 在将 UPS 通过 USB 连接到树莓派后，可以通过查看 USB 设备进行检查\n检查 USB 连接 sudo lsusb 其中的 Device 003 就是 UPS，说明 USB 连接正常\nBus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.","keywords":["HomeLab","UPS"],"articleBody":"Linux 环境下配置不间断电源 UPS UPS (Uninterruptible Power Supply)，是一种含有储能装置的不间断电源。主要用于给部分对电源稳定性要求较高的设备，提供不间断的电源\n一般的 UPS 都支持通过 USB 连接到电脑或者 NAS 等设备上，Linux/Mac/Windows 均支持使用 UPS；\n因为电路不稳定，存在偶尔断电的情况，因此希望通过 UPS 保护树莓派、路由器、光猫、硬盘录像机等设备；将 UPS 通过 USB 接口连接到树莓派，由树莓派控制其他设备在断电时关机\n安装 NUT NUT(Network UPS Tools) 是一种开源软件工具，其主要功能特点是实时监控与管理不间断电源（UPS）设备，支持多种通信协议，自动执行操作以应对电力故障，适用于多平台，并允许集中管理多个UPS设备，以确保与这些设备连接的计算机和设备在电力问题发生时能够继续正常运行或安全关闭\nNUT中的主要软件组件和功能：\nDriver（驱动程序）：NUT包括各种不同制造商的UPS设备的驱动程序，使NUT能够与多种型号的UPS设备通信。这些驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息。\nupsd（UPS守护进程）：upsd是NUT的核心守护进程，负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端。它可以通过网络协议（如SNMP、HTTP、XML-RPC等）向其他计算机提供UPS状态信息。\nupsmon（UPS监控守护进程）：upsmon监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作。它可以配置为执行自定义脚本、关闭计算机或发送警报通知，以确保系统的连续性和数据完整性。\nupslog（UPS事件记录器）：upslog用于记录UPS事件和状态信息，以便后续分析和故障排除。它可以生成日志文件，其中包含UPS的运行历史和电力事件。\nnutclient（NUT客户端工具）：NUT提供了一些用于监控和管理UPS的命令行工具，例如upsc用于查询UPS状态，upscmd用于发送命令到UPS，以及upsrw用于修改UPS配置。\n安装\napt update \u0026\u0026 apt install -y nut 通过 USB 连接 UPS 在将 UPS 通过 USB 连接到树莓派后，可以通过查看 USB 设备进行检查\n检查 USB 连接 sudo lsusb 其中的 Device 003 就是 UPS，说明 USB 连接正常\nBus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 002 Device 002: ID 174c:55aa ASMedia Technology Inc. ASM1051E SATA 6Gb/s bridge, ASM1053E SATA 6Gb/s bridge, ASM1153 SATA 3Gb/s bridge, ASM1153E SATA 6Gb/s bridge Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub Bus 001 Device 003: ID 0463:ffff MGE UPS Systems UPS Bus 001 Device 002: ID 2109:3431 VIA Labs, Inc. Hub Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub 通过 nut-scanner 检查 UPS 设备 nut-scanner -q 正确识别到连接的 UPS 设备，驱动为 usbhid-ups，产品为 SANTAK TG-BOX\nNeon library not found. XML search disabled. IPMI library not found. IPMI search disabled. [nutdev1] driver = \"usbhid-ups\" port = \"auto\" vendorid = \"0463\" productid = \"FFFF\" product = \"SANTAK TG-BOX\" serial = \"Blank\" vendor = \"EATON\" bus = \"001\" 配置 UPS ###配置 UPS 驱动\n驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息\n将 UPS 设备添加到 NUT 使用 nut-scanner 将连接的 UPS 信息追加到 /etc/nut/ups.conf 配置中，其中的 nutdev1 是设备的名称，可以自定义\nsudo nut-scanner -q \u003e\u003e /etc/nut/ups.conf 启动 NUT 使用 upsdrvctl 命令启动 NUT\nsudo upsdrvctl start 配置 UPS 守护进程 upsd 负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端\n启动 upsd sudo upsd 查看 UPS 状态 使用 upsc 命令查看 UPS 设备的状态；其中的 ups 是 /etc/nut/ups.conf 中配置的名称\nsudo upsc ups@localhost 该命令会返回 UPS 设备的所有信息\nInit SSL without certificate database battery.charge: 98 battery.charge.low: 20 battery.runtime: 2744 battery.type: PbAc device.mfr: EATON device.model: SANTAK TG-BOX 600 device.serial: Blank ... 也可以指定名称查看 UPS 状态\nsudo upsc ups@localhost ups.status Init SSL without certificate database OL 配置关机策略 配置 upsd 用户 upsd 用户对应的配置文件是 /etc/nut/upsd.users，配置用户用于读取 UPS的信息；在以下配置中，用户名是 upsmon，密码是 123456，运行模式是 master，即该设备为主节点（如果有同时使用其他 UPS则可以是 slave）\n[upsmon] password = \"123456\" upsmon master 重启 upsd sudo upsd -c reload 配置关机策略 关机策略使用的是 upsmon，upsmon 监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作，它可以配置为执行自定义脚本、关闭计算机或发送警报通知\n配置关机策略 修改 /etc/nut/upsmon.conf，添加如下配置，使用的是刚才创建的用户信息，这样，当设备监听到 UPS 发出的 LOWBATT 命令后，就会执行关闭系统\nMONITOR ups@localhost 1 monuser 123456 master 这个命令告诉NUT要监控名为 “ups” 的UPS设备，该设备位于本地主机上。监控用户 “monuser”，可以使用密码 “123456” 连接到NUT，并具有 “master” 角色的权限。这允许用户通过NUT连接来监视和管理UPS设备\n启动 upsmon sudo upsmon 执行自定义动作 NUT 通过 upssched 支持监听 UPS 事件并执行指定脚本，因此可以用于执行一些自定义的动作，如发送通知等\n配置 upsmon 修改 /etc/nut/upsmon.conf 文件，添加如下配置\n指定运行命令 该配置用于在发生事件时运行 /sbin/upssched 服务\nNOTIFYCMD /sbin/upssched 配置触发条件 NOTIFYFLAG ONLINE SYSLOG+WALL+EXEC NOTIFYFLAG ONBATT SYSLOG+WALL+EXEC NOTIFYFLAG LOWBATT SYSLOG+WALL+EXEC 这里监听了 ONLINE, ONBATT, 和 LOWBATT三个事件，分别是电源供电、电池供电和低电量事件；SYSLOG声明记录事件日志到系统中，WALL声明通知所有在线用户，EXEC 声明需要执行命令\n配置 upssched 配置好 upsmon 后，还需要配置 upssched 执行相关的命令，需要将以下内容添加到 /etc/nut/upssched.conf 中\n配置 upsmon CMDSCRIPT /usr/local/bin/upssched-script.sh PIPEFN /run/nut/upssched/upssched.pipe LOCKFN /run/nut/upssched/upssched.lock AT ONBATT * EXECUTE battery_on # 发送断电的消息 AT ONLINE * EXECUTE power_online # 发送来电的消息 AT ONBATT * START-TIMER watch_battery 60 # 60 秒后执行监控电池状态 AT ONLINE * CANCEL-TIMER watch_battery # 取消 监控电池状态 AT LOWBATT * EXECUTE low_battery\t# 低电量 CMDSCRIPT 指定了监听到事件后需要执行的脚本 PIPEFN和LOCKFN指定了监听事件的管道并加锁，避免被修改 AT 和 EXECUTE 指定了监听的事件并执行相关的脚本；当监听到 ONBATT, ONLINE 和 LOWBATT 时执行 CMDSCRIPT指定的脚本，并将 battery_on, power_online 和 low_battery作为参数 AT 和 START-TIMER 启动了一个计时器，在 60s 后执行 AT 和 CANCEL-TIMER 指定如果在启动计时器60s 内发生了 ONLINE事件，则取消计时器\n配置 upssched-script.sh #!/bin/bash BARK_URL=${BARK_URL:-\"https://api.day.app/xxxxxx\"} function send_message() { message=\"$1\" echo \"发送通知:${message}\" curl -X \"POST\" \"$BARK_URL\" \\ -H 'Content-Type: application/json; charset=utf-8' \\ -d \"{ \\\"title\\\": \\\"UPS 状态发生变化\\\", \\\"body\\\": \\\"${message}\\\", \\\"group\\\": \\\"UPS\\\" }\" } case $1 in battery_on) battery_charge=$(upsc ups@localhost battery.charge) send_message \"UPS 电池已启用，目前电量: ${battery_charge}\" ;; power_online) battery_charge=$(upsc ups@localhost battery.charge) send_message \"UPS 已恢复供电，目前电量: ${battery_charge}\" ;; watch_battery) battery_charge=$(upsc ups@localhost battery.charge) send_message \"UPS 目前电量: ${battery_charge}\" ;; low_battery) battery_charge=$(upsc ups@localhost battery.charge) send_message \"UPS 低电量: ${battery_charge}，开始关机\" ;; *) logger -t upssched-cmd \"其他未知指令: $1\" ;; esac 这段脚本用于接收事件，并执行动作；这里通过 Bark 发送了通知\n记录 UPS 日志 ups 支持通过 upslog 记录 UPS 日志\nsudo upslog -l /var/log/ups.log -i 1 -s ups@localhost -f \"%TIME @Y-@m-@d @H:@M:@S%, battery.charge:%VAR battery.charge%, input.voltage:%VAR input.voltage%, ups.load:%VAR ups.load%, ups.status:[%VAR ups.status%], ups.temperature:%VAR ups.temperature%, input.frequency:%VAR input.frequency%\" 这段命令中，通过 -l指定了输出文件为 /var/log/ups.log，-i 1 表示1s输出一次，-s ups@localhost指定了 UPS 位置，-f 指定了日志输出格式\n输出日志参考：\n2023-10-06 19:58:38, battery.charge:78, input.voltage:NA, ups.load:8, ups.status:[OL], ups.temperature:NA, input.frequency:NA 配置 UPS 监控 NUT 支持通过 HTTP 接口对外提供 UPS 的信息，因此可以用于监控 UPS; https://github.com/helloworlde/nut_exporter 提供了 Prometheus Exporter，可以使用 Prometheus 和 Grafana 对 UPS 进行监控\n修改 NUT 运行模式 配置文件是 /etc/nut/nut.conf；将模式修改为 netserver的目的是允许通过局域网访问 UPS 的设备信息，用于其他设备监控、监听 UPS 的状态；如果不需要监听则不需要配置\nMODE=netserver 配置 upsd 修改 upsd 对应的配置文件 /etc/nut/upsd.conf，添加监听的地址和端口；添加局域网 IP 是用于局域网内其他设备进行监控，否则可能会拒绝连接\nLISTEN 127.0.0.1 3493 LISTEN ::1 3493 LISTEN 192.168.31.11 3493 重启 upsd sudo upsd -c reload 配置 NUT Exporter 配置 docker-compose.yaml version: '3' services: nut-exporter: image: hellowoodes/nut-exporter container_name: nut-exporter hostname: nut-exporter restart: unless-stopped command: --log.level=debug ports: - \"9199:9199\" environment: - NUT_EXPORTER_SERVER=${NUT_EXPORTER_SERVER} - NUT_EXPORTER_USERNAME=${NUT_EXPORTER_USERNAME} - NUT_EXPORTER_PASSWORD=${NUT_EXPORTER_PASSWORD} - NUT_EXPORTER_VARIABLES=${NUT_EXPORTER_VARIABLES} volumes: - \"/etc/localtime:/etc/localtime:ro\" 配置 .env Server 的地址即为树莓派局域网的IP地址，用户名和密码是 upsd 的用户和密码；NUT_EXPORTER_VARIABLES是需要抓取的监控指标类型，不同的设备可能指标不一样；可以通过 upsc ups@localhost 获取所有的指标名称进行替换\nNUT_EXPORTER_SERVER=192.168.31.11 NUT_EXPORTER_USERNAME=monuser NUT_EXPORTER_PASSWORD=123456 NUT_EXPORTER_VARIABLES=battery.charge,battery.charge.low,battery.runtime,battery.type,device.mfr,device.model,device.serial,device.type,driver.name,driver.parameter.pollfreq,driver.parameter.pollinterval,driver.parameter.port,driver.parameter.product,driver.parameter.productid,driver.parameter.serial,driver.parameter.synchronous,driver.parameter.vendor,driver.parameter.vendorid,driver.version,driver.version.data,driver.version.internal,input.transfer.high,input.transfer.low,outlet.1.desc,outlet.1.id,outlet.1.status,outlet.1.switchable,outlet.desc,outlet.id,outlet.switchable,output.frequency.nominal,output.voltage,output.voltage.nominal,ups.beeper.status,ups.delay.shutdown,ups.delay.start,ups.firmware,ups.load,ups.mfr,ups.model,ups.power.nominal,ups.productid,ups.serial,ups.status,ups.timer.shutdown,ups.timer.start,ups.type,ups.vendorid 配置 Prometheus - job_name: ups-exporter honor_timestamps: true scrape_interval: 15s scrape_timeout: 10s metrics_path: /ups_metrics scheme: http static_configs: - targets: - 192.168.31.11:9199 配置 Grafana 面板 导入 https://github.com/helloworlde/nut_exporter/blob/master/dashboard/dashboard.json 即可\n","wordCount":"723","inLanguage":"en","datePublished":"2023-10-04T15:22:56+08:00","dateModified":"2023-10-04T15:22:56+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%85%8D%E7%BD%AE%E4%B8%8D%E9%97%B4%E6%96%AD%E7%94%B5%E6%BA%90ups/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Linux 环境下配置不间断电源 UPS</h1></header><p><small>October 4, 2023&nbsp;· 723 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#安装-nut>安装 NUT</a></li><li><a href=#通过-usb-连接-ups>通过 USB 连接 UPS</a></li><li><a href=#配置-ups>配置 UPS</a><ul><li><a href=#配置-ups-守护进程>配置 UPS 守护进程</a></li><li><a href=#查看-ups-状态>查看 UPS 状态</a></li></ul></li><li><a href=#配置关机策略>配置关机策略</a><ul><li><a href=#配置-upsd-用户>配置 upsd 用户</a></li><li><a href=#配置关机策略-1>配置关机策略</a></li></ul></li><li><a href=#执行自定义动作>执行自定义动作</a><ul><li><a href=#配置-upsmon>配置 upsmon</a></li><li><a href=#配置-upssched>配置 upssched</a></li></ul></li><li><a href=#记录-ups-日志>记录 UPS 日志</a></li><li><a href=#配置-ups-监控>配置 UPS 监控</a><ul><li><a href=#修改-nut-运行模式>修改 NUT 运行模式</a></li><li><a href=#配置-upsd>配置 upsd</a></li><li><a href=#配置-nut-exporter>配置 NUT Exporter</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=linux-环境下配置不间断电源-ups>Linux 环境下配置不间断电源 UPS</h1><p>UPS (Uninterruptible Power Supply)，是一种含有储能装置的不间断电源。主要用于给部分对电源稳定性要求较高的设备，提供不间断的电源</p><p>一般的 UPS 都支持通过 USB 连接到电脑或者 NAS 等设备上，Linux/Mac/Windows 均支持使用 UPS；</p><p>因为电路不稳定，存在偶尔断电的情况，因此希望通过 UPS 保护树莓派、路由器、光猫、硬盘录像机等设备；将 UPS 通过 USB 接口连接到树莓派，由树莓派控制其他设备在断电时关机</p><h2 id=安装-nut>安装 NUT</h2><p><a href=https://networkupstools.org/>NUT</a>(Network UPS Tools) 是一种开源软件工具，其主要功能特点是实时监控与管理不间断电源（UPS）设备，支持多种通信协议，自动执行操作以应对电力故障，适用于多平台，并允许集中管理多个UPS设备，以确保与这些设备连接的计算机和设备在电力问题发生时能够继续正常运行或安全关闭</p><p>NUT中的主要软件组件和功能：</p><ul><li><p>Driver（驱动程序）：NUT包括各种不同制造商的UPS设备的驱动程序，使NUT能够与多种型号的UPS设备通信。这些驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息。</p></li><li><p>upsd（UPS守护进程）：upsd是NUT的核心守护进程，负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端。它可以通过网络协议（如SNMP、HTTP、XML-RPC等）向其他计算机提供UPS状态信息。</p></li><li><p>upsmon（UPS监控守护进程）：upsmon监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作。它可以配置为执行自定义脚本、关闭计算机或发送警报通知，以确保系统的连续性和数据完整性。</p></li><li><p>upslog（UPS事件记录器）：upslog用于记录UPS事件和状态信息，以便后续分析和故障排除。它可以生成日志文件，其中包含UPS的运行历史和电力事件。</p></li><li><p>nutclient（NUT客户端工具）：NUT提供了一些用于监控和管理UPS的命令行工具，例如upsc用于查询UPS状态，upscmd用于发送命令到UPS，以及upsrw用于修改UPS配置。</p></li><li><p>安装</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt update <span style=color:#f92672>&amp;&amp;</span> apt install -y nut
</span></span></code></pre></div><h2 id=通过-usb-连接-ups>通过 USB 连接 UPS</h2><p>在将 UPS 通过 USB 连接到树莓派后，可以通过查看 USB 设备进行检查</p><ul><li>检查 USB 连接</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo lsusb
</span></span></code></pre></div><p>其中的 Device 003 就是 UPS，说明 USB 连接正常</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Bus <span style=color:#ae81ff>003</span> Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</span></span><span style=display:flex><span>Bus <span style=color:#ae81ff>002</span> Device 002: ID 174c:55aa ASMedia Technology Inc. ASM1051E SATA 6Gb/s bridge, ASM1053E SATA 6Gb/s bridge, ASM1153 SATA 3Gb/s bridge, ASM1153E SATA 6Gb/s bridge
</span></span><span style=display:flex><span>Bus <span style=color:#ae81ff>002</span> Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
</span></span><span style=display:flex><span>Bus <span style=color:#ae81ff>001</span> Device 003: ID 0463:ffff MGE UPS Systems UPS
</span></span><span style=display:flex><span>Bus <span style=color:#ae81ff>001</span> Device 002: ID 2109:3431 VIA Labs, Inc. Hub
</span></span><span style=display:flex><span>Bus <span style=color:#ae81ff>001</span> Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</span></span></code></pre></div><ul><li>通过 <code>nut-scanner</code> 检查 UPS 设备</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nut-scanner -q
</span></span></code></pre></div><p>正确识别到连接的 UPS 设备，驱动为 <code>usbhid-ups</code>，产品为 <code>SANTAK TG-BOX</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Neon library not found. XML search disabled.
</span></span><span style=display:flex><span>IPMI library not found. IPMI search disabled.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>nutdev1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>	driver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;usbhid-ups&#34;</span>
</span></span><span style=display:flex><span>	port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;auto&#34;</span>
</span></span><span style=display:flex><span>	vendorid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0463&#34;</span>
</span></span><span style=display:flex><span>	productid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;FFFF&#34;</span>
</span></span><span style=display:flex><span>	product <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SANTAK TG-BOX&#34;</span>
</span></span><span style=display:flex><span>	serial <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Blank&#34;</span>
</span></span><span style=display:flex><span>	vendor <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;EATON&#34;</span>
</span></span><span style=display:flex><span>	bus <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;001&#34;</span>
</span></span></code></pre></div><h2 id=配置-ups>配置 UPS</h2><p>###配置 UPS 驱动</p><p>驱动程序负责与UPS设备建立连接，并获取有关电源状态、电池状态和其他参数的信息</p><ul><li>将 UPS 设备添加到 NUT</li></ul><p>使用 <code>nut-scanner</code> 将连接的 UPS 信息追加到 <code>/etc/nut/ups.conf</code> 配置中，其中的 <code>nutdev1</code> 是设备的名称，可以自定义</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nut-scanner -q &gt;&gt; /etc/nut/ups.conf
</span></span></code></pre></div><ul><li>启动 NUT</li></ul><p>使用 <code>upsdrvctl</code> 命令启动 NUT</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsdrvctl start
</span></span></code></pre></div><h3 id=配置-ups-守护进程>配置 UPS 守护进程</h3><p>upsd 负责与UPS设备通信，并将UPS状态信息提供给其他NUT组件和客户端</p><ul><li>启动 upsd</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsd
</span></span></code></pre></div><h3 id=查看-ups-状态>查看 UPS 状态</h3><p>使用 <code>upsc</code> 命令查看 UPS 设备的状态；其中的 <code>ups</code> 是 <code>/etc/nut/ups.conf</code> 中配置的名称</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsc ups@localhost
</span></span></code></pre></div><p>该命令会返回 UPS 设备的所有信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Init SSL without certificate database
</span></span><span style=display:flex><span>battery.charge: <span style=color:#ae81ff>98</span>
</span></span><span style=display:flex><span>battery.charge.low: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>battery.runtime: <span style=color:#ae81ff>2744</span>
</span></span><span style=display:flex><span>battery.type: PbAc
</span></span><span style=display:flex><span>device.mfr: EATON
</span></span><span style=display:flex><span>device.model: SANTAK TG-BOX <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>device.serial: Blank
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>也可以指定名称查看 UPS 状态</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsc ups@localhost ups.status
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Init SSL without certificate database
</span></span><span style=display:flex><span>OL
</span></span></code></pre></div><h2 id=配置关机策略>配置关机策略</h2><h3 id=配置-upsd-用户>配置 upsd 用户</h3><p>upsd 用户对应的配置文件是 <code>/etc/nut/upsd.users</code>，配置用户用于读取 UPS的信息；在以下配置中，用户名是 <code>upsmon</code>，密码是 <code>123456</code>，运行模式是 <code>master</code>，即该设备为主节点（如果有同时使用其他 UPS则可以是 <code>slave</code>）</p><pre tabindex=0><code>[upsmon]
        password = &#34;123456&#34;
        upsmon master
</code></pre><ul><li>重启 upsd</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsd -c reload
</span></span></code></pre></div><h3 id=配置关机策略-1>配置关机策略</h3><p>关机策略使用的是 upsmon，upsmon 监控守护进程用于监视UPS状态，并在检测到电力问题时执行操作，它可以配置为执行自定义脚本、关闭计算机或发送警报通知</p><ul><li>配置关机策略</li></ul><p>修改 <code>/etc/nut/upsmon.conf</code>，添加如下配置，使用的是刚才创建的用户信息，这样，当设备监听到 UPS 发出的 <code>LOWBATT</code> 命令后，就会执行关闭系统</p><pre tabindex=0><code>MONITOR ups@localhost 1 monuser 123456 master
</code></pre><p>这个命令告诉NUT要监控名为 &ldquo;ups&rdquo; 的UPS设备，该设备位于本地主机上。监控用户 &ldquo;monuser&rdquo;，可以使用密码 &ldquo;123456&rdquo; 连接到NUT，并具有 &ldquo;master&rdquo; 角色的权限。这允许用户通过NUT连接来监视和管理UPS设备</p><ul><li>启动 upsmon</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsmon
</span></span></code></pre></div><h2 id=执行自定义动作>执行自定义动作</h2><p>NUT 通过 <code>upssched</code> 支持监听 UPS 事件并执行指定脚本，因此可以用于执行一些自定义的动作，如发送通知等</p><h3 id=配置-upsmon>配置 upsmon</h3><p>修改 <code>/etc/nut/upsmon.conf</code> 文件，添加如下配置</p><ul><li>指定运行命令</li></ul><p>该配置用于在发生事件时运行 <code>/sbin/upssched</code> 服务</p><pre tabindex=0><code>NOTIFYCMD /sbin/upssched
</code></pre><ul><li>配置触发条件</li></ul><pre tabindex=0><code>NOTIFYFLAG ONLINE SYSLOG+WALL+EXEC
NOTIFYFLAG ONBATT SYSLOG+WALL+EXEC
NOTIFYFLAG LOWBATT SYSLOG+WALL+EXEC
</code></pre><p>这里监听了 <code>ONLINE</code>, <code>ONBATT</code>, 和 <code>LOWBATT</code>三个事件，分别是电源供电、电池供电和低电量事件；<code>SYSLOG</code>声明记录事件日志到系统中，<code>WALL</code>声明通知所有在线用户，<code>EXEC</code> 声明需要执行命令</p><h3 id=配置-upssched>配置 upssched</h3><p>配置好 upsmon 后，还需要配置 upssched 执行相关的命令，需要将以下内容添加到 <code>/etc/nut/upssched.conf</code> 中</p><ul><li>配置 upsmon</li></ul><pre tabindex=0><code>CMDSCRIPT /usr/local/bin/upssched-script.sh

PIPEFN    /run/nut/upssched/upssched.pipe
LOCKFN    /run/nut/upssched/upssched.lock

AT ONBATT  * EXECUTE      battery_on         # 发送断电的消息
AT ONLINE  * EXECUTE      power_online       # 发送来电的消息
AT ONBATT  * START-TIMER  watch_battery 60   # 60 秒后执行监控电池状态
AT ONLINE  * CANCEL-TIMER watch_battery      # 取消 监控电池状态
AT LOWBATT * EXECUTE      low_battery		 # 低电量
</code></pre><p><code>CMDSCRIPT</code> 指定了监听到事件后需要执行的脚本
<code>PIPEFN</code>和<code>LOCKFN</code>指定了监听事件的管道并加锁，避免被修改
<code>AT</code> 和 <code>EXECUTE</code> 指定了监听的事件并执行相关的脚本；当监听到 <code>ONBATT</code>, <code>ONLINE</code> 和 <code>LOWBATT</code> 时执行 <code>CMDSCRIPT</code>指定的脚本，并将 <code>battery_on</code>, <code>power_online</code> 和 <code>low_battery</code>作为参数
<code>AT</code> 和 <code>START-TIMER</code> 启动了一个计时器，在 60s 后执行
<code>AT</code> 和 <code>CANCEL-TIMER</code> 指定如果在启动计时器60s 内发生了 <code>ONLINE</code>事件，则取消计时器</p><ul><li>配置 upssched-script.sh</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>BARK_URL<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>BARK_URL<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;https://api.day.app/xxxxxx&#34;</span><span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> send_message<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;发送通知:</span><span style=color:#e6db74>${</span>message<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    curl -X <span style=color:#e6db74>&#34;POST&#34;</span> <span style=color:#e6db74>&#34;</span>$BARK_URL<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>         -H <span style=color:#e6db74>&#39;Content-Type: application/json; charset=utf-8&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>         -d <span style=color:#e6db74>&#34;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              \&#34;title\&#34;: \&#34;UPS 状态发生变化\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              \&#34;body\&#34;: \&#34;</span><span style=color:#e6db74>${</span>message<span style=color:#e6db74>}</span><span style=color:#e6db74>\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              \&#34;group\&#34;: \&#34;UPS\&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> $1 in
</span></span><span style=display:flex><span>    battery_on<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        battery_charge<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>upsc ups@localhost battery.charge<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        send_message <span style=color:#e6db74>&#34;UPS 电池已启用，目前电量: </span><span style=color:#e6db74>${</span>battery_charge<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    power_online<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        battery_charge<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>upsc ups@localhost battery.charge<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        send_message <span style=color:#e6db74>&#34;UPS 已恢复供电，目前电量: </span><span style=color:#e6db74>${</span>battery_charge<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    watch_battery<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        battery_charge<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>upsc ups@localhost battery.charge<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        send_message <span style=color:#e6db74>&#34;UPS 目前电量: </span><span style=color:#e6db74>${</span>battery_charge<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    low_battery<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        battery_charge<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>upsc ups@localhost battery.charge<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        send_message <span style=color:#e6db74>&#34;UPS 低电量: </span><span style=color:#e6db74>${</span>battery_charge<span style=color:#e6db74>}</span><span style=color:#e6db74>，开始关机&#34;</span>
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    *<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        logger -t upssched-cmd <span style=color:#e6db74>&#34;其他未知指令: </span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span></code></pre></div><p>这段脚本用于接收事件，并执行动作；这里通过 Bark 发送了通知</p><h2 id=记录-ups-日志>记录 UPS 日志</h2><p>ups 支持通过 <code>upslog</code> 记录 UPS 日志</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upslog -l /var/log/ups.log -i <span style=color:#ae81ff>1</span> -s ups@localhost -f <span style=color:#e6db74>&#34;%TIME @Y-@m-@d @H:@M:@S%, battery.charge:%VAR battery.charge%, input.voltage:%VAR input.voltage%, ups.load:%VAR ups.load%, ups.status:[%VAR ups.status%], ups.temperature:%VAR ups.temperature%, input.frequency:%VAR input.frequency%&#34;</span>
</span></span></code></pre></div><p>这段命令中，通过 <code>-l</code>指定了输出文件为 <code>/var/log/ups.log</code>，<code>-i 1</code> 表示1s输出一次，<code>-s ups@localhost</code>指定了 UPS 位置，<code>-f</code> 指定了日志输出格式</p><p>输出日志参考：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2023-10-06 19:58:38, battery.charge:78, input.voltage:NA, ups.load:8, ups.status:<span style=color:#f92672>[</span>OL<span style=color:#f92672>]</span>, ups.temperature:NA, input.frequency:NA
</span></span></code></pre></div><h2 id=配置-ups-监控>配置 UPS 监控</h2><p>NUT 支持通过 HTTP 接口对外提供 UPS 的信息，因此可以用于监控 UPS; <a href=https://github.com/helloworlde/nut_exporter>https://github.com/helloworlde/nut_exporter</a> 提供了 Prometheus Exporter，可以使用 Prometheus 和 Grafana 对 UPS 进行监控</p><p><img src=https://img.hellowood.dev/picture/homelab-ups-grafana-dashboard-3.png alt=homelab-ups-grafana-dashboard-3.png></p><p><img src=https://img.hellowood.dev/picture/homelab-ups-grafana-dashboard-2.png alt=homelab-ups-grafana-dashboard-2.png></p><h3 id=修改-nut-运行模式>修改 NUT 运行模式</h3><p>配置文件是 <code>/etc/nut/nut.conf</code>；将模式修改为 <code>netserver</code>的目的是允许通过局域网访问 UPS 的设备信息，用于其他设备监控、监听 UPS 的状态；如果不需要监听则不需要配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>MODE<span style=color:#f92672>=</span>netserver
</span></span></code></pre></div><h3 id=配置-upsd>配置 upsd</h3><p>修改 upsd 对应的配置文件 <code>/etc/nut/upsd.conf</code>，添加监听的地址和端口；添加局域网 IP 是用于局域网内其他设备进行监控，否则可能会拒绝连接</p><pre tabindex=0><code>LISTEN 127.0.0.1 3493
LISTEN ::1 3493
LISTEN 192.168.31.11 3493
</code></pre><ul><li>重启 upsd</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo upsd -c reload
</span></span></code></pre></div><h3 id=配置-nut-exporter>配置 NUT Exporter</h3><ul><li>配置 <code>docker-compose.yaml</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nut-exporter</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hellowoodes/nut-exporter</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>nut-exporter</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>nut-exporter</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: --<span style=color:#ae81ff>log.level=debug</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;9199:9199&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NUT_EXPORTER_SERVER=${NUT_EXPORTER_SERVER}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NUT_EXPORTER_USERNAME=${NUT_EXPORTER_USERNAME}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NUT_EXPORTER_PASSWORD=${NUT_EXPORTER_PASSWORD}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NUT_EXPORTER_VARIABLES=${NUT_EXPORTER_VARIABLES}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;/etc/localtime:/etc/localtime:ro&#34;</span>
</span></span></code></pre></div><ul><li>配置 <code>.env</code></li></ul><p>Server 的地址即为树莓派局域网的IP地址，用户名和密码是 upsd 的用户和密码；<code>NUT_EXPORTER_VARIABLES</code>是需要抓取的监控指标类型，不同的设备可能指标不一样；可以通过 <code>upsc ups@localhost</code> 获取所有的指标名称进行替换</p><pre tabindex=0><code>NUT_EXPORTER_SERVER=192.168.31.11
NUT_EXPORTER_USERNAME=monuser
NUT_EXPORTER_PASSWORD=123456
NUT_EXPORTER_VARIABLES=battery.charge,battery.charge.low,battery.runtime,battery.type,device.mfr,device.model,device.serial,device.type,driver.name,driver.parameter.pollfreq,driver.parameter.pollinterval,driver.parameter.port,driver.parameter.product,driver.parameter.productid,driver.parameter.serial,driver.parameter.synchronous,driver.parameter.vendor,driver.parameter.vendorid,driver.version,driver.version.data,driver.version.internal,input.transfer.high,input.transfer.low,outlet.1.desc,outlet.1.id,outlet.1.status,outlet.1.switchable,outlet.desc,outlet.id,outlet.switchable,output.frequency.nominal,output.voltage,output.voltage.nominal,ups.beeper.status,ups.delay.shutdown,ups.delay.start,ups.firmware,ups.load,ups.mfr,ups.model,ups.power.nominal,ups.productid,ups.serial,ups.status,ups.timer.shutdown,ups.timer.start,ups.type,ups.vendorid
</code></pre><ul><li>配置 Prometheus</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>ups-exporter</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>honor_timestamps</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>15s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_timeout</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/ups_metrics</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>192.168.31.11</span>:<span style=color:#ae81ff>9199</span>
</span></span></code></pre></div><ul><li>配置 Grafana 面板</li></ul><p>导入 <a href=https://github.com/helloworlde/nut_exporter/blob/master/dashboard/dashboard.json>https://github.com/helloworlde/nut_exporter/blob/master/dashboard/dashboard.json</a> 即可</p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>使用 Cloudflare Tunnels 通过 Web SSH 访问服务器</span></a>
<a class=next href=https://blog.hellowood.dev/posts/wireguard%E5%AF%B9%E7%AB%AF%E5%8A%A8%E6%80%81ip%E6%97%B6%E4%B8%BB%E5%8A%A8%E6%9B%B4%E6%96%B0%E5%9C%B0%E5%9D%80/><span>WireGuard对端动态IP时主动更新地址</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=related-resources><h3>Related Resources</h3><nav><ul><li><a href=/posts/proxmox-ve-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-lxc-%E5%AE%B9%E5%99%A8-ct-%E6%A8%A1%E6%9D%BF/>Proxmox VE 创建自定义的 LXC 容器 CT 模板</a></li><li><a href=/posts/%E5%9C%A8%E9%BB%91%E7%BE%A4%E6%99%96%E4%BD%BF%E7%94%A8-docker-%E9%83%A8%E7%BD%B2-proxmox-backup-server/>在黑群晖使用 Docker 部署 Proxmox Backup Server</a></li><li><a href=/posts/%E4%BD%BF%E7%94%A8%E9%98%BF%E5%B0%94%E5%8D%A1%E7%89%B9%E7%8C%AB%E6%A3%92%E6%9B%BF%E6%8D%A2%E5%8C%97%E4%BA%AC%E7%A7%BB%E5%8A%A8-gpon-%E5%85%89%E7%8C%AB/>使用阿尔卡特猫棒替换北京移动 GPON 光猫</a></li><li><a href=/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/>使用 Cloudflare Tunnels 通过 Web SSH 访问服务器</a></li></ul></nav></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>