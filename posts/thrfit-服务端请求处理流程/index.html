<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>Thrfit 服务端请求处理流程</title>
<meta name=description content="使用同步的非阻塞的服务端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta name=keywords content='blog,hugo,Thrift'><meta property="og:url" content="https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="og:type" content="website"><meta property="og:title" content="Thrfit 服务端请求处理流程"><meta property="og:description" content="使用同步的非阻塞的服务端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Thrfit 服务端请求处理流程"><meta name=twitter:description content="使用同步的非阻塞的服务端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.a036ebe92c17ea3f0c07761c2135b82bec6f37c8efb7f49ddad1f28c22fc4769.js integrity="sha256-oDbr6SwX6j8MB3YcITW4K+xvN8jvt/Sd2tHyjCL8R2k="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Thrfit 服务端请求处理流程</h1><small role=doc-subtitle></small><p class=post-date>2021-02-20</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/thrift>Thrift</a></li></ul></div><div class=post-content><p>使用同步的非阻塞的服务端的请求处理流程</p><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#c678dd>namespace</span> <span style=color:#76a9f9>java</span> <span style=color:#c1abea>io.github.helloworlde.thrift</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>struct</span> <span style=color:#76a9f9>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#d19a66>1</span>: <span style=color:#c678dd>required</span> <span style=color:#ef8383>string</span> <span style=color:#c1abea>message</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>struct</span> <span style=color:#76a9f9>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#d19a66>1</span>: <span style=color:#c678dd>required</span> <span style=color:#ef8383>string</span> <span style=color:#c1abea>message</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>service</span> <span style=color:#76a9f9>HelloService</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HelloResponse</span> <span style=color:#00b1f7>sayHello</span><span style=color:#c7bf54>(</span><span style=color:#d19a66>1</span>: <span style=color:#c1abea>HelloMessage</span> <span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=服务端实现>服务端实现</h3><p>使用 <code>TThreadedSelectorServer</code> 作为服务端，支持接收连接，处理 IO 事件，执行请求由不同的线程实现；底层连接使用 <code>ServerSocket</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c678dd>class</span> <span style=color:#76a9f9>NonblockingServer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>@SneakyThrows</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>public</span> <span style=color:#c678dd>static</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>main</span>(<span style=color:#c1abea>String</span><span style=color:#c7bf54>[]</span> <span style=color:#c1abea>args</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>HelloServiceImpl</span> <span style=color:#c1abea>helloService</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloServiceImpl</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>HelloService</span>.<span style=color:#b3d23c>Processor</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HelloService</span>.<span style=color:#b3d23c>Iface</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>helloServiceProcessor</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloService</span>.<span style=color:#b3d23c>Processor</span><span style=color:#c7bf54>&lt;&gt;</span>(<span style=color:#c1abea>helloService</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TNonblockingServerTransport</span> <span style=color:#c1abea>transport</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TNonblockingServerSocket</span>(<span style=color:#c1abea>9090</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 配置参数以及处理器</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TThreadedSelectorServer</span>.<span style=color:#b3d23c>Args</span> <span style=color:#c1abea>serverArgs</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TThreadedSelectorServer</span>.<span style=color:#b3d23c>Args</span>(<span style=color:#c1abea>transport</span>)
</span></span><span style=display:flex><span>                .<span style=color:#b3d23c>selectorThreads</span>(<span style=color:#c1abea>4</span>)
</span></span><span style=display:flex><span>                .<span style=color:#b3d23c>workerThreads</span>(<span style=color:#c1abea>10</span>)
</span></span><span style=display:flex><span>                .<span style=color:#b3d23c>acceptQueueSizePerThread</span>(<span style=color:#c1abea>20</span>)
</span></span><span style=display:flex><span>                .<span style=color:#b3d23c>processor</span>(<span style=color:#c1abea>helloServiceProcessor</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TServer</span> <span style=color:#c1abea>server</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TThreadedSelectorServer</span>(<span style=color:#c1abea>serverArgs</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>server</span>.<span style=color:#b3d23c>serve</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><h3 id=1-启动-server>1. 启动 Server</h3><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>TServer</span> <span style=color:#c1abea>server</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TThreadedSelectorServer</span>(<span style=color:#c1abea>serverArgs</span>);
</span></span><span style=display:flex><span><span style=color:#c1abea>server</span>.<span style=color:#b3d23c>serve</span>();
</span></span></code></pre></div><ul><li>org.apache.thrift.server.AbstractNonblockingServer#serve</li></ul><p>启动 Server，启动用于连接的线程 <code>AcceptThread</code> 和用于处理 IO 事件的多个线程 <code>SelectorThread</code>；然后开始监听 IO 事件，由线程池处理请求</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>serve</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 启动</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>startThreads</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 开始监听</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>startListening</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 修改状态</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>setServing</span>(<span style=color:#b756ff;font-weight:700>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 阻塞直到关闭</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>waitForShutdown</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>setServing</span>(<span style=color:#b756ff;font-weight:700>false</span>);
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 停止监听器</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>stopListening</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer#startThreads</li></ul><p>启动用于连接的线程 <code>AcceptThread</code> 和用于处理 IO 事件的多个线程 <code>SelectorThread</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#ef8383>boolean</span> <span style=color:#00b1f7>startThreads</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 创建选择线程，并添加到集合中</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> (<span style=color:#ef8383>int</span> <span style=color:#c1abea>i</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>0</span>; <span style=color:#c1abea>i</span> <span style=color:#c7bf54>&lt;</span> <span style=color:#c1abea>args</span>.<span style=color:#b3d23c>selectorThreads</span>; <span style=color:#c7bf54>++</span><span style=color:#c1abea>i</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>selectorThreads</span>.<span style=color:#b3d23c>add</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>SelectorThread</span>(<span style=color:#c1abea>args</span>.<span style=color:#b3d23c>acceptQueueSizePerThread</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 创建处理连接的负载均衡， 创建处理连接的线程</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>acceptThread</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>AcceptThread</span>((<span style=color:#c1abea>TNonblockingServerTransport</span>) <span style=color:#c1abea>serverTransport_</span>, <span style=color:#c1abea>createSelectorThreadLoadBalancer</span>(<span style=color:#c1abea>selectorThreads</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 启动选择线程</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> (<span style=color:#c1abea>SelectorThread</span> <span style=color:#c1abea>thread</span> : <span style=color:#c1abea>selectorThreads</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>thread</span>.<span style=color:#b3d23c>start</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 启动连接的线程</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>acceptThread</span>.<span style=color:#b3d23c>start</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>IOException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>error</span>(<span style=color:#98c379>&#34;Failed to start threads!&#34;</span>, <span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TNonblockingServerSocket#listen</li></ul><p>开始监听</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>listen</span>() <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TTransportException</span> {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// Make sure not to block on accept</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>serverSocket_</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>serverSocket_</span>.<span style=color:#b3d23c>setSoTimeout</span>(<span style=color:#c1abea>0</span>);
</span></span><span style=display:flex><span>        } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>SocketException</span> <span style=color:#c1abea>sx</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>error</span>(<span style=color:#98c379>&#34;Socket exception while setting socket timeout&#34;</span>, <span style=color:#c1abea>sx</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-处理连接事件>2. 处理连接事件</h3><ul><li>org.apache.thrift.server.TThreadedSelectorServer.AcceptThread#run</li></ul><p>连接事件由 <code>AcceptThread</code> 线程独立处理；会循环监听 <code>Selector</code>事件，当有新的连接事件时，会建立连接</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>run</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>eventHandler_</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 通知 Server 开始启动</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>eventHandler_</span>.<span style=color:#b3d23c>preServe</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>while</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>stopped_</span>) {
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 选择处理连接</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>select</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>acceptSelector</span>.<span style=color:#b3d23c>close</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TThreadedSelectorServer</span>.<span style=color:#b3d23c>this</span>.<span style=color:#b3d23c>stop</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.AcceptThread#select</li></ul><p>会不断从 <code>Selector</code>获取事件，判断如果是 accept 事件，则处理，并建立连接</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>select</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 等待连接事件</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>acceptSelector</span>.<span style=color:#b3d23c>select</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 处理接收到的事件</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>Iterator</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>SelectionKey</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>selectedKeys</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>acceptSelector</span>.<span style=color:#b3d23c>selectedKeys</span>().<span style=color:#b3d23c>iterator</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>while</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>stopped_</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c1abea>selectedKeys</span>.<span style=color:#b3d23c>hasNext</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>SelectionKey</span> <span style=color:#c1abea>key</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>selectedKeys</span>.<span style=color:#b3d23c>next</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>selectedKeys</span>.<span style=color:#b3d23c>remove</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>key</span>.<span style=color:#b3d23c>isValid</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#c678dd>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> (<span style=color:#c1abea>key</span>.<span style=color:#b3d23c>isAcceptable</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// 建立连接</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>handleAccept</span>();
</span></span><span style=display:flex><span>            } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;Unexpected state in select! &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>key</span>.<span style=color:#b3d23c>interestOps</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>IOException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;Got an IOException while selecting!&#34;</span>, <span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.AcceptThread#handleAccept</li></ul><p>会通过底层的 <code>ServerSocketChannel</code> 建立连接，然后将这个连接添加到 <code>SelectorThread</code> 的队列中，由 <code>SelectorThread</code>处理 IO 事件</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>handleAccept</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 建立连接</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>final</span> <span style=color:#c1abea>TNonblockingTransport</span> <span style=color:#c1abea>client</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>doAccept</span>();
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>client</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 将连接传递给选择线程</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>final</span> <span style=color:#c1abea>SelectorThread</span> <span style=color:#c1abea>targetThread</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>threadChooser</span>.<span style=color:#b3d23c>nextThread</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果策略是尽快建立连接，则添加到处理的队列中</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>args</span>.<span style=color:#b3d23c>acceptPolicy</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>Args</span>.<span style=color:#b3d23c>AcceptPolicy</span>.<span style=color:#b3d23c>FAST_ACCEPT</span> <span style=color:#c7bf54>||</span> <span style=color:#c1abea>invoker</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>doAddAccept</span>(<span style=color:#c1abea>targetThread</span>, <span style=color:#c1abea>client</span>);
</span></span><span style=display:flex><span>        } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// 如果是 FAIR_ACCEPT，则提交异步任务进行添加</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>invoker</span>.<span style=color:#b3d23c>submit</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>Runnable</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>run</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#c1abea>doAddAccept</span>(<span style=color:#c1abea>targetThread</span>, <span style=color:#c1abea>client</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>            } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>RejectedExecutionException</span> <span style=color:#c1abea>rx</span>) {
</span></span><span style=display:flex><span>                <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;ExecutorService rejected accept registration!&#34;</span>, <span style=color:#c1abea>rx</span>);
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// close immediately</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>client</span>.<span style=color:#b3d23c>close</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TNonblockingServerSocket#acceptImpl</li></ul><p>建立连接，返回新的 <code>TNonblockingSocket</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#c1abea>TNonblockingSocket</span> <span style=color:#00b1f7>acceptImpl</span>() <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TTransportException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>serverSocket_</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TTransportException</span>(<span style=color:#c1abea>TTransportException</span>.<span style=color:#b3d23c>NOT_OPEN</span>, <span style=color:#98c379>&#34;No underlying server socket.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 接受连接</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>SocketChannel</span> <span style=color:#c1abea>socketChannel</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>serverSocketChannel</span>.<span style=color:#b3d23c>accept</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>socketChannel</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 使用 Channel 构建 Socket</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TNonblockingSocket</span> <span style=color:#c1abea>tsocket</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TNonblockingSocket</span>(<span style=color:#c1abea>socketChannel</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>tsocket</span>.<span style=color:#b3d23c>setTimeout</span>(<span style=color:#c1abea>clientTimeout_</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#c1abea>tsocket</span>;
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>IOException</span> <span style=color:#c1abea>iox</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>throw</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TTransportException</span>(<span style=color:#c1abea>iox</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.SelectorThread#addAcceptedConnection</li></ul><p>将连接添加到 <code>SelectorThread</code>的队列中，由 <code>SelectorThread</code>处理 IO 事件</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>boolean</span> <span style=color:#00b1f7>addAcceptedConnection</span>(<span style=color:#c1abea>TNonblockingTransport</span> <span style=color:#c1abea>accepted</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 放入队列中</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>acceptedQueue</span>.<span style=color:#b3d23c>put</span>(<span style=color:#c1abea>accepted</span>);
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>InterruptedException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;Interrupted while adding accepted connection!&#34;</span>, <span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c1abea>selector</span>.<span style=color:#b3d23c>wakeup</span>();
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-处理-io-事件>3. 处理 IO 事件</h3><p>IO 事件由 <code>SelectorThread</code> 处理</p><ul><li>org.apache.thrift.server.TThreadedSelectorServer.SelectorThread#run</li></ul><p>轮询读取事件，如果是 IO 事件，则分别处理；如果是新的连接，则注册 <code>Selector</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>run</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>while</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>stopped_</span>) {
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 选择读取或写入事件</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>select</span>();
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 处理新的连接</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>processAcceptedConnections</span>();
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 改变需要改变的状态</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>processInterestChanges</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果停止了，则清理选择</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> (<span style=color:#c1abea>SelectionKey</span> <span style=color:#c1abea>selectionKey</span> : <span style=color:#c1abea>selector</span>.<span style=color:#b3d23c>keys</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>cleanupSelectionKey</span>(<span style=color:#c1abea>selectionKey</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>Throwable</span> <span style=color:#c1abea>t</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>error</span>(<span style=color:#98c379>&#34;run() on SelectorThread exiting due to uncaught error&#34;</span>, <span style=color:#c1abea>t</span>);
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 关闭</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>selector</span>.<span style=color:#b3d23c>close</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>TThreadedSelectorServer</span>.<span style=color:#b3d23c>this</span>.<span style=color:#b3d23c>stop</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.SelectorThread#select</li></ul><p>处理 IO 事件，根据事件类型分别处理读取或者写入</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>select</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 获取事件</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>doSelect</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>Iterator</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>SelectionKey</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>selectedKeys</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>selector</span>.<span style=color:#b3d23c>selectedKeys</span>().<span style=color:#b3d23c>iterator</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>while</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>stopped_</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c1abea>selectedKeys</span>.<span style=color:#b3d23c>hasNext</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>SelectionKey</span> <span style=color:#c1abea>key</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>selectedKeys</span>.<span style=color:#b3d23c>next</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>selectedKeys</span>.<span style=color:#b3d23c>remove</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 如果无效则跳过</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>key</span>.<span style=color:#b3d23c>isValid</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#c1abea>cleanupSelectionKey</span>(<span style=color:#c1abea>key</span>);
</span></span><span style=display:flex><span>                <span style=color:#c678dd>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> (<span style=color:#c1abea>key</span>.<span style=color:#b3d23c>isReadable</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// 如果是读取则处理读取事件</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>handleRead</span>(<span style=color:#c1abea>key</span>);
</span></span><span style=display:flex><span>            } <span style=color:#c678dd>else</span> <span style=color:#c678dd>if</span> (<span style=color:#c1abea>key</span>.<span style=color:#b3d23c>isWritable</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// 如果是写入则处理写入</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>handleWrite</span>(<span style=color:#c1abea>key</span>);
</span></span><span style=display:flex><span>            } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;Unexpected state in select! &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>key</span>.<span style=color:#b3d23c>interestOps</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>IOException</span> <span style=color:#c1abea>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;Got an IOException while selecting!&#34;</span>, <span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=处理读取事件>处理读取事件</h4><ul><li>org.apache.thrift.server.AbstractNonblockingServer.AbstractSelectThread#handleRead</li></ul><p>在处理读取事件时，会读取整个帧，当完全读取时，会调用 <code>requestInvoke</code> 方法，通过线程池处理请求</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>handleRead</span>(<span style=color:#c1abea>SelectionKey</span> <span style=color:#c1abea>key</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 获取帧</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>FrameBuffer</span> <span style=color:#c1abea>buffer</span> <span style=color:#c7bf54>=</span> (<span style=color:#c1abea>FrameBuffer</span>) <span style=color:#c1abea>key</span>.<span style=color:#b3d23c>attachment</span>();
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果没有可读取的，则清理</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>buffer</span>.<span style=color:#b3d23c>read</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>cleanupSelectionKey</span>(<span style=color:#c1abea>key</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// if the buffer&#39;s frame read is complete, invoke the method.</span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果 buffer 完全读取，则执行处理，如果失败则清理</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>buffer</span>.<span style=color:#b3d23c>isFrameFullyRead</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>requestInvoke</span>(<span style=color:#c1abea>buffer</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>cleanupSelectionKey</span>(<span style=color:#c1abea>key</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer#requestInvoke</li></ul><p>处理调用，会将帧封装为 Runnable 任务，提交给线程池执行</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#ef8383>boolean</span> <span style=color:#00b1f7>requestInvoke</span>(<span style=color:#c1abea>FrameBuffer</span> <span style=color:#c1abea>frameBuffer</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 封装为 Runnable</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>Runnable</span> <span style=color:#c1abea>invocation</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>getRunnable</span>(<span style=color:#c1abea>frameBuffer</span>);
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>invoker</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 执行处理</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>invoker</span>.<span style=color:#b3d23c>execute</span>(<span style=color:#c1abea>invocation</span>);
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>        } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>RejectedExecutionException</span> <span style=color:#c1abea>rx</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>LOGGER</span>.<span style=color:#b3d23c>warn</span>(<span style=color:#98c379>&#34;ExecutorService rejected execution!&#34;</span>, <span style=color:#c1abea>rx</span>);
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// Invoke on the caller&#39;s thread</span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果没有线程池，由当前线程直接处理</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>invocation</span>.<span style=color:#b3d23c>run</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=处理写入事件>处理写入事件</h4><ul><li>org.apache.thrift.server.AbstractNonblockingServer.AbstractSelectThread#handleWrite</li></ul><p>处理写入事件，调用 <code>FrameBuffer</code> 的写入方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>protected</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>handleWrite</span>(<span style=color:#c1abea>SelectionKey</span> <span style=color:#c1abea>key</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>FrameBuffer</span> <span style=color:#c1abea>buffer</span> <span style=color:#c7bf54>=</span> (<span style=color:#c1abea>FrameBuffer</span>) <span style=color:#c1abea>key</span>.<span style=color:#b3d23c>attachment</span>();
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>buffer</span>.<span style=color:#b3d23c>write</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>cleanupSelectionKey</span>(<span style=color:#c1abea>key</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.AbstractNonblockingServer.FrameBuffer#write</li></ul><p>由 Transport 执行写入，最终由 <code>SocketChannel</code> 执行，将响应内容发送给客户端</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>boolean</span> <span style=color:#00b1f7>write</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>state_</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>FrameBufferState</span>.<span style=color:#b3d23c>WRITING</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 写入</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>trans_</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>buffer_</span>) <span style=color:#c7bf54>&lt;</span> <span style=color:#c1abea>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果没有待写入的，则切换到读取</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>buffer_</span>.<span style=color:#b3d23c>remaining</span>() <span style=color:#c7bf54>==</span> <span style=color:#c1abea>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>prepareRead</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-执行请求>4. 执行请求</h3><ul><li>org.apache.thrift.server.AbstractNonblockingServer.FrameBuffer#invoke</li></ul><p>在处理读取事件时，会将 <code>FrameBuffer</code> 包装为 <code>Runnable</code>，提交给线程池执行；最终由 <code>FrameBuffer</code>处理
会获取 Processor，然后调用 process 方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>invoke</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>frameTrans_</span>.<span style=color:#b3d23c>reset</span>(<span style=color:#c1abea>buffer_</span>.<span style=color:#b3d23c>array</span>());
</span></span><span style=display:flex><span>    <span style=color:#c1abea>response_</span>.<span style=color:#b3d23c>reset</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果有事件处理器，则触发</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>eventHandler_</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>eventHandler_</span>.<span style=color:#b3d23c>processContext</span>(<span style=color:#c1abea>context_</span>, <span style=color:#c1abea>inTrans_</span>, <span style=color:#c1abea>outTrans_</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 获取处理器，调用处理方法</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>processorFactory_</span>.<span style=color:#b3d23c>getProcessor</span>(<span style=color:#c1abea>inTrans_</span>).<span style=color:#b3d23c>process</span>(<span style=color:#c1abea>inProt_</span>, <span style=color:#c1abea>outProt_</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>responseReady</span>();
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span>;
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>TException</span> <span style=color:#c1abea>te</span>) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// This will only be reached when there is a throwable.</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>state_</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>FrameBufferState</span>.<span style=color:#b3d23c>AWAITING_CLOSE</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>requestSelectInterestChange</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TBaseProcessor#process</li></ul><p>在处理时，根据方法名获取具体的处理函数，然后调用响应的处理方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>process</span>(<span style=color:#c1abea>TProtocol</span> <span style=color:#c1abea>in</span>, <span style=color:#c1abea>TProtocol</span> <span style=color:#c1abea>out</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>TMessage</span> <span style=color:#c1abea>msg</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>in</span>.<span style=color:#b3d23c>readMessageBegin</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>ProcessFunction</span> <span style=color:#c1abea>fn</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>processMap</span>.<span style=color:#b3d23c>get</span>(<span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>name</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>fn</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>TProtocolUtil</span>.<span style=color:#b3d23c>skip</span>(<span style=color:#c1abea>in</span>, <span style=color:#c1abea>TType</span>.<span style=color:#b3d23c>STRUCT</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>in</span>.<span style=color:#b3d23c>readMessageEnd</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>TApplicationException</span> <span style=color:#c1abea>x</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>TApplicationException</span>(<span style=color:#c1abea>TApplicationException</span>.<span style=color:#b3d23c>UNKNOWN_METHOD</span>, <span style=color:#98c379>&#34;Invalid method name: &#39;&#34;</span><span style=color:#c7bf54>+</span><span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>name</span><span style=color:#c7bf54>+</span><span style=color:#98c379>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>out</span>.<span style=color:#b3d23c>writeMessageBegin</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>TMessage</span>(<span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>name</span>, <span style=color:#c1abea>TMessageType</span>.<span style=color:#b3d23c>EXCEPTION</span>, <span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>seqid</span>));
</span></span><span style=display:flex><span>    <span style=color:#c1abea>x</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>out</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>out</span>.<span style=color:#b3d23c>writeMessageEnd</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>out</span>.<span style=color:#b3d23c>getTransport</span>().<span style=color:#b3d23c>flush</span>();
</span></span><span style=display:flex><span>  } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>fn</span>.<span style=color:#b3d23c>process</span>(<span style=color:#c1abea>msg</span>.<span style=color:#b3d23c>seqid</span>, <span style=color:#c1abea>in</span>, <span style=color:#c1abea>out</span>, <span style=color:#c1abea>iface</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.ProcessFunction#process</li></ul><p>读取请求信息，反序列化为对象，然后调用 <code>getResult</code> 方法执行实现逻辑，获取响应；如果不是 oneway 的请求，则将相应结果写入流中，发送给客户端</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c678dd>final</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>process</span>(<span style=color:#ef8383>int</span> <span style=color:#c1abea>seqid</span>,
</span></span><span style=display:flex><span>                          <span style=color:#c1abea>TProtocol</span> <span style=color:#c1abea>iprot</span>,
</span></span><span style=display:flex><span>                          <span style=color:#c1abea>TProtocol</span> <span style=color:#c1abea>oprot</span>,
</span></span><span style=display:flex><span>                          <span style=color:#c1abea>I</span> <span style=color:#c1abea>iface</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 获取空参数实例</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>T</span> <span style=color:#c1abea>args</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>getEmptyArgsInstance</span>();
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 读取</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>args</span>.<span style=color:#b3d23c>read</span>(<span style=color:#c1abea>iprot</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>iprot</span>.<span style=color:#b3d23c>readMessageEnd</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>TSerializable</span> <span style=color:#c1abea>result</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#ef8383>byte</span> <span style=color:#c1abea>msgType</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>TMessageType</span>.<span style=color:#b3d23c>REPLY</span>;
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 获取结果</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>result</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>getResult</span>(<span style=color:#c1abea>iface</span>, <span style=color:#c1abea>args</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果不是 oneway 的，则写入响应结果</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>isOneway</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeMessageBegin</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>TMessage</span>(<span style=color:#c1abea>getMethodName</span>(), <span style=color:#c1abea>msgType</span>, <span style=color:#c1abea>seqid</span>));
</span></span><span style=display:flex><span>        <span style=color:#c1abea>result</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>oprot</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeMessageEnd</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>getTransport</span>().<span style=color:#b3d23c>flush</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.Processor.sayHello#getResult</li></ul><p>由生成的代码处理，会先构建一个响应结构体，然后调用相应的方法进行处理，返回结果</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c1abea>sayHello_result</span> <span style=color:#00b1f7>getResult</span>(<span style=color:#c1abea>I</span> <span style=color:#c1abea>iface</span>, <span style=color:#c1abea>sayHello_args</span> <span style=color:#c1abea>args</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>sayHello_result</span> <span style=color:#c1abea>result</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>sayHello_result</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>result</span>.<span style=color:#b3d23c>success</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>iface</span>.<span style=color:#b3d23c>sayHello</span>(<span style=color:#c1abea>args</span>.<span style=color:#b3d23c>request</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>return</span> <span style=color:#c1abea>result</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloServiceImpl#sayHello</li></ul><p>具体的逻辑处理，返回响应</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c1abea>HelloResponse</span> <span style=color:#00b1f7>sayHello</span>(<span style=color:#c1abea>HelloMessage</span> <span style=color:#c1abea>request</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>String</span> <span style=color:#c1abea>message</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span>.<span style=color:#b3d23c>getMessage</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HelloResponse</span> <span style=color:#c1abea>response</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloResponse</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>setMessage</span>(<span style=color:#98c379>&#34;Hello &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>message</span>);
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c1abea>response</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-写入响应>4. 写入响应</h3><ul><li>org.apache.thrift.ProcessFunction#process</li></ul><p>在处理完请求之后，会判断是否是 oneway 请求，如果不是，则会执行写入响应</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>if</span>(<span style=color:#c7bf54>!</span><span style=color:#c1abea>isOneway</span>()) {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeMessageBegin</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>TMessage</span>(<span style=color:#c1abea>getMethodName</span>(), <span style=color:#c1abea>msgType</span>, <span style=color:#c1abea>seqid</span>));
</span></span><span style=display:flex><span>  <span style=color:#c1abea>result</span>.<span style=color:#b3d23c>write</span>(<span style=color:#c1abea>oprot</span>);
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeMessageEnd</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>getTransport</span>().<span style=color:#b3d23c>flush</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#writeMessageBegin</li></ul><p>写入响应时，会先写入响应头；会将版本信息，消息类型，方法的名称和请求 ID 一起写入</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>writeMessageBegin</span>(<span style=color:#c1abea>TMessage</span> <span style=color:#c1abea>message</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>strictWrite_</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ef8383>int</span> <span style=color:#c1abea>version</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>VERSION_1</span> <span style=color:#c7bf54>|</span> <span style=color:#c1abea>message</span>.<span style=color:#b3d23c>type</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>writeI32</span>(<span style=color:#c1abea>version</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>writeString</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>name</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>writeI32</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>seqid</span>);
</span></span><span style=display:flex><span>  } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>writeString</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>name</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>writeByte</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>type</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>writeI32</span>(<span style=color:#c1abea>message</span>.<span style=color:#b3d23c>seqid</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloResponse.HelloResponseStandardScheme#write</li></ul><p>随后写入响应内容，将对象序列化为字节</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>write</span>(<span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>protocol</span>.<span style=color:#b3d23c>TProtocol</span> <span style=color:#c1abea>oprot</span>, <span style=color:#c1abea>HelloResponse</span> <span style=color:#c1abea>struct</span>) <span style=color:#c678dd>throws</span> <span style=color:#c1abea>org</span>.<span style=color:#b3d23c>apache</span>.<span style=color:#b3d23c>thrift</span>.<span style=color:#b3d23c>TException</span> {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>validate</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeStructBegin</span>(<span style=color:#c1abea>STRUCT_DESC</span>);
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>message</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeFieldBegin</span>(<span style=color:#c1abea>MESSAGE_FIELD_DESC</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeString</span>(<span style=color:#c1abea>struct</span>.<span style=color:#b3d23c>message</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeFieldEnd</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeFieldStop</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>oprot</span>.<span style=color:#b3d23c>writeStructEnd</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后会写入响应结尾符，由 <code>SelectorThread</code> 处理写入事件，最终将请求发送给客户端</p><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2021 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>