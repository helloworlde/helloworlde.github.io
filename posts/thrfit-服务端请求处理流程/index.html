<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>Thrfit 服务端请求处理流程</title><meta name=description content="使用同步的非阻塞的服务端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta name=keywords content='blog,hugo,Thrift'><meta property="og:url" content="https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="og:type" content="website"><meta property="og:title" content="Thrfit 服务端请求处理流程"><meta property="og:description" content="使用同步的非阻塞的服务端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Thrfit 服务端请求处理流程"><meta name=twitter:description content="使用同步的非阻塞的服务端的请求处理流程
实现 IDL helloworld.thrift namespace java io.github.helloworlde.thrift struct HelloMessage { 1: required string message, } struct …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.70293498aa96b2dbb767ec11a622eb2266d8fc37a0fff88233a82952e3c72b15.js integrity="sha256-cCk0mKqWstu3Z+wRpiLrImbY/Deg//iCM6gpUuPHKxU="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-5709431067036925"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5709431067036925" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Thrfit 服务端请求处理流程</h1><small role=doc-subtitle></small><p class=post-date>2021-02-20
| Updated 2024-12-04</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/thrift>Thrift</a></li></ul></div><div class=post-content><p>使用同步的非阻塞的服务端的请求处理流程</p><h2 id=实现>实现</h2><h3 id=idl>IDL</h3><ul><li>helloworld.thrift</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=display:flex><span><span style=color:#f92672>namespace</span> java io.github.helloworlde.thrift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>HelloResponse</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> message,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>service</span> <span style=color:#a6e22e>HelloService</span> {
</span></span><span style=display:flex><span>    HelloResponse <span style=color:#a6e22e>sayHello</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span>: HelloMessage request);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=服务端实现>服务端实现</h3><p>使用 <code>TThreadedSelectorServer</code> 作为服务端，支持接收连接，处理 IO 事件，执行请求由不同的线程实现；底层连接使用 <code>ServerSocket</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NonblockingServer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HelloServiceImpl helloService <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloServiceImpl();
</span></span><span style=display:flex><span>        HelloService.<span style=color:#a6e22e>Processor</span><span style=color:#f92672>&lt;</span>HelloService.<span style=color:#a6e22e>Iface</span><span style=color:#f92672>&gt;</span> helloServiceProcessor <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloService.<span style=color:#a6e22e>Processor</span><span style=color:#f92672>&lt;&gt;</span>(helloService);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TNonblockingServerTransport transport <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TNonblockingServerSocket(9090);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配置参数以及处理器</span>
</span></span><span style=display:flex><span>        TThreadedSelectorServer.<span style=color:#a6e22e>Args</span> serverArgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TThreadedSelectorServer.<span style=color:#a6e22e>Args</span>(transport)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>selectorThreads</span>(4)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>workerThreads</span>(10)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>acceptQueueSizePerThread</span>(20)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>processor</span>(helloServiceProcessor);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TServer server <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TThreadedSelectorServer(serverArgs);
</span></span><span style=display:flex><span>        server.<span style=color:#a6e22e>serve</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=请求处理流程>请求处理流程</h2><h3 id=1-启动-server>1. 启动 Server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>TServer server <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TThreadedSelectorServer(serverArgs);
</span></span><span style=display:flex><span>server.<span style=color:#a6e22e>serve</span>();
</span></span></code></pre></div><ul><li>org.apache.thrift.server.AbstractNonblockingServer#serve</li></ul><p>启动 Server，启动用于连接的线程 <code>AcceptThread</code> 和用于处理 IO 事件的多个线程 <code>SelectorThread</code>；然后开始监听 IO 事件，由线程池处理请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>serve</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>startThreads()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开始监听</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>startListening()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改状态</span>
</span></span><span style=display:flex><span>    setServing(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 阻塞直到关闭</span>
</span></span><span style=display:flex><span>    waitForShutdown();
</span></span><span style=display:flex><span>    setServing(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 停止监听器</span>
</span></span><span style=display:flex><span>    stopListening();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer#startThreads</li></ul><p>启动用于连接的线程 <code>AcceptThread</code> 和用于处理 IO 事件的多个线程 <code>SelectorThread</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startThreads</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建选择线程，并添加到集合中</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> args.<span style=color:#a6e22e>selectorThreads</span>; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>            selectorThreads.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> SelectorThread(args.<span style=color:#a6e22e>acceptQueueSizePerThread</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建处理连接的负载均衡， 创建处理连接的线程</span>
</span></span><span style=display:flex><span>        acceptThread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AcceptThread((TNonblockingServerTransport) serverTransport_, createSelectorThreadLoadBalancer(selectorThreads));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动选择线程</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (SelectorThread thread : selectorThreads) {
</span></span><span style=display:flex><span>            thread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动连接的线程</span>
</span></span><span style=display:flex><span>        acceptThread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Failed to start threads!&#34;</span>, e);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TNonblockingServerSocket#listen</li></ul><p>开始监听</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>listen</span>() <span style=color:#66d9ef>throws</span> TTransportException {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make sure not to block on accept</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (serverSocket_ <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            serverSocket_.<span style=color:#a6e22e>setSoTimeout</span>(0);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (SocketException sx) {
</span></span><span style=display:flex><span>            LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Socket exception while setting socket timeout&#34;</span>, sx);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-处理连接事件>2. 处理连接事件</h3><ul><li>org.apache.thrift.server.TThreadedSelectorServer.AcceptThread#run</li></ul><p>连接事件由 <code>AcceptThread</code> 线程独立处理；会循环监听 <code>Selector</code>事件，当有新的连接事件时，会建立连接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (eventHandler_ <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 通知 Server 开始启动</span>
</span></span><span style=display:flex><span>            eventHandler_.<span style=color:#a6e22e>preServe</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>stopped_) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 选择处理连接</span>
</span></span><span style=display:flex><span>            select();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        acceptSelector.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>        TThreadedSelectorServer.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>stop</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.AcceptThread#select</li></ul><p>会不断从 <code>Selector</code>获取事件，判断如果是 accept 事件，则处理，并建立连接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>select</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 等待连接事件</span>
</span></span><span style=display:flex><span>        acceptSelector.<span style=color:#a6e22e>select</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理接收到的事件</span>
</span></span><span style=display:flex><span>        Iterator<span style=color:#f92672>&lt;</span>SelectionKey<span style=color:#f92672>&gt;</span> selectedKeys <span style=color:#f92672>=</span> acceptSelector.<span style=color:#a6e22e>selectedKeys</span>().<span style=color:#a6e22e>iterator</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>stopped_ <span style=color:#f92672>&amp;&amp;</span> selectedKeys.<span style=color:#a6e22e>hasNext</span>()) {
</span></span><span style=display:flex><span>            SelectionKey key <span style=color:#f92672>=</span> selectedKeys.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>            selectedKeys.<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>key.<span style=color:#a6e22e>isValid</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (key.<span style=color:#a6e22e>isAcceptable</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 建立连接</span>
</span></span><span style=display:flex><span>                handleAccept();
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Unexpected state in select! &#34;</span> <span style=color:#f92672>+</span> key.<span style=color:#a6e22e>interestOps</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Got an IOException while selecting!&#34;</span>, e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.AcceptThread#handleAccept</li></ul><p>会通过底层的 <code>ServerSocketChannel</code> 建立连接，然后将这个连接添加到 <code>SelectorThread</code> 的队列中，由 <code>SelectorThread</code>处理 IO 事件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleAccept</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 建立连接</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> TNonblockingTransport client <span style=color:#f92672>=</span> doAccept();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (client <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将连接传递给选择线程</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SelectorThread targetThread <span style=color:#f92672>=</span> threadChooser.<span style=color:#a6e22e>nextThread</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果策略是尽快建立连接，则添加到处理的队列中</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (args.<span style=color:#a6e22e>acceptPolicy</span> <span style=color:#f92672>==</span> Args.<span style=color:#a6e22e>AcceptPolicy</span>.<span style=color:#a6e22e>FAST_ACCEPT</span> <span style=color:#f92672>||</span> invoker <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            doAddAccept(targetThread, client);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 如果是 FAIR_ACCEPT，则提交异步任务进行添加</span>
</span></span><span style=display:flex><span>                invoker.<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>new</span> Runnable() {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>                        doAddAccept(targetThread, client);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (RejectedExecutionException rx) {
</span></span><span style=display:flex><span>                LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;ExecutorService rejected accept registration!&#34;</span>, rx);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// close immediately</span>
</span></span><span style=display:flex><span>                client.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.transport.TNonblockingServerSocket#acceptImpl</li></ul><p>建立连接，返回新的 <code>TNonblockingSocket</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> TNonblockingSocket <span style=color:#a6e22e>acceptImpl</span>() <span style=color:#66d9ef>throws</span> TTransportException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (serverSocket_ <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TTransportException(TTransportException.<span style=color:#a6e22e>NOT_OPEN</span>, <span style=color:#e6db74>&#34;No underlying server socket.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 接受连接</span>
</span></span><span style=display:flex><span>        SocketChannel socketChannel <span style=color:#f92672>=</span> serverSocketChannel.<span style=color:#a6e22e>accept</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (socketChannel <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 使用 Channel 构建 Socket</span>
</span></span><span style=display:flex><span>        TNonblockingSocket tsocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TNonblockingSocket(socketChannel);
</span></span><span style=display:flex><span>        tsocket.<span style=color:#a6e22e>setTimeout</span>(clientTimeout_);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> tsocket;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (IOException iox) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TTransportException(iox);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.SelectorThread#addAcceptedConnection</li></ul><p>将连接添加到 <code>SelectorThread</code>的队列中，由 <code>SelectorThread</code>处理 IO 事件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>addAcceptedConnection</span>(TNonblockingTransport accepted) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 放入队列中</span>
</span></span><span style=display:flex><span>        acceptedQueue.<span style=color:#a6e22e>put</span>(accepted);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Interrupted while adding accepted connection!&#34;</span>, e);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    selector.<span style=color:#a6e22e>wakeup</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-处理-io-事件>3. 处理 IO 事件</h3><p>IO 事件由 <code>SelectorThread</code> 处理</p><ul><li>org.apache.thrift.server.TThreadedSelectorServer.SelectorThread#run</li></ul><p>轮询读取事件，如果是 IO 事件，则分别处理；如果是新的连接，则注册 <code>Selector</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>stopped_) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 选择读取或写入事件</span>
</span></span><span style=display:flex><span>            select();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理新的连接</span>
</span></span><span style=display:flex><span>            processAcceptedConnections();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 改变需要改变的状态</span>
</span></span><span style=display:flex><span>            processInterestChanges();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果停止了，则清理选择</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (SelectionKey selectionKey : selector.<span style=color:#a6e22e>keys</span>()) {
</span></span><span style=display:flex><span>            cleanupSelectionKey(selectionKey);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;run() on SelectorThread exiting due to uncaught error&#34;</span>, t);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关闭</span>
</span></span><span style=display:flex><span>        selector.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>        TThreadedSelectorServer.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>stop</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer.SelectorThread#select</li></ul><p>处理 IO 事件，根据事件类型分别处理读取或者写入</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>select</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取事件</span>
</span></span><span style=display:flex><span>        doSelect();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Iterator<span style=color:#f92672>&lt;</span>SelectionKey<span style=color:#f92672>&gt;</span> selectedKeys <span style=color:#f92672>=</span> selector.<span style=color:#a6e22e>selectedKeys</span>().<span style=color:#a6e22e>iterator</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>stopped_ <span style=color:#f92672>&amp;&amp;</span> selectedKeys.<span style=color:#a6e22e>hasNext</span>()) {
</span></span><span style=display:flex><span>            SelectionKey key <span style=color:#f92672>=</span> selectedKeys.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>            selectedKeys.<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果无效则跳过</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>key.<span style=color:#a6e22e>isValid</span>()) {
</span></span><span style=display:flex><span>                cleanupSelectionKey(key);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (key.<span style=color:#a6e22e>isReadable</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 如果是读取则处理读取事件</span>
</span></span><span style=display:flex><span>                handleRead(key);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (key.<span style=color:#a6e22e>isWritable</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 如果是写入则处理写入</span>
</span></span><span style=display:flex><span>                handleWrite(key);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Unexpected state in select! &#34;</span> <span style=color:#f92672>+</span> key.<span style=color:#a6e22e>interestOps</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Got an IOException while selecting!&#34;</span>, e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=处理读取事件>处理读取事件</h4><ul><li>org.apache.thrift.server.AbstractNonblockingServer.AbstractSelectThread#handleRead</li></ul><p>在处理读取事件时，会读取整个帧，当完全读取时，会调用 <code>requestInvoke</code> 方法，通过线程池处理请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleRead</span>(SelectionKey key) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取帧</span>
</span></span><span style=display:flex><span>    FrameBuffer buffer <span style=color:#f92672>=</span> (FrameBuffer) key.<span style=color:#a6e22e>attachment</span>();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果没有可读取的，则清理</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>buffer.<span style=color:#a6e22e>read</span>()) {
</span></span><span style=display:flex><span>        cleanupSelectionKey(key);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// if the buffer&#39;s frame read is complete, invoke the method.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果 buffer 完全读取，则执行处理，如果失败则清理</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (buffer.<span style=color:#a6e22e>isFrameFullyRead</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>requestInvoke(buffer)) {
</span></span><span style=display:flex><span>            cleanupSelectionKey(key);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.TThreadedSelectorServer#requestInvoke</li></ul><p>处理调用，会将帧封装为 Runnable 任务，提交给线程池执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>requestInvoke</span>(FrameBuffer frameBuffer) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 封装为 Runnable</span>
</span></span><span style=display:flex><span>    Runnable invocation <span style=color:#f92672>=</span> getRunnable(frameBuffer);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (invoker <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 执行处理</span>
</span></span><span style=display:flex><span>            invoker.<span style=color:#a6e22e>execute</span>(invocation);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (RejectedExecutionException rx) {
</span></span><span style=display:flex><span>            LOGGER.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;ExecutorService rejected execution!&#34;</span>, rx);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Invoke on the caller&#39;s thread</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果没有线程池，由当前线程直接处理</span>
</span></span><span style=display:flex><span>        invocation.<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=处理写入事件>处理写入事件</h4><ul><li>org.apache.thrift.server.AbstractNonblockingServer.AbstractSelectThread#handleWrite</li></ul><p>处理写入事件，调用 <code>FrameBuffer</code> 的写入方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleWrite</span>(SelectionKey key) {
</span></span><span style=display:flex><span>    FrameBuffer buffer <span style=color:#f92672>=</span> (FrameBuffer) key.<span style=color:#a6e22e>attachment</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>buffer.<span style=color:#a6e22e>write</span>()) {
</span></span><span style=display:flex><span>        cleanupSelectionKey(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.server.AbstractNonblockingServer.FrameBuffer#write</li></ul><p>由 Transport 执行写入，最终由 <code>SocketChannel</code> 执行，将响应内容发送给客户端</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>write</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (state_ <span style=color:#f92672>==</span> FrameBufferState.<span style=color:#a6e22e>WRITING</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 写入</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (trans_.<span style=color:#a6e22e>write</span>(buffer_) <span style=color:#f92672>&lt;</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果没有待写入的，则切换到读取</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (buffer_.<span style=color:#a6e22e>remaining</span>() <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>            prepareRead();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-执行请求>4. 执行请求</h3><ul><li>org.apache.thrift.server.AbstractNonblockingServer.FrameBuffer#invoke</li></ul><p>在处理读取事件时，会将 <code>FrameBuffer</code> 包装为 <code>Runnable</code>，提交给线程池执行；最终由 <code>FrameBuffer</code>处理
会获取 Processor，然后调用 process 方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invoke</span>() {
</span></span><span style=display:flex><span>    frameTrans_.<span style=color:#a6e22e>reset</span>(buffer_.<span style=color:#a6e22e>array</span>());
</span></span><span style=display:flex><span>    response_.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果有事件处理器，则触发</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (eventHandler_ <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            eventHandler_.<span style=color:#a6e22e>processContext</span>(context_, inTrans_, outTrans_);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取处理器，调用处理方法</span>
</span></span><span style=display:flex><span>        processorFactory_.<span style=color:#a6e22e>getProcessor</span>(inTrans_).<span style=color:#a6e22e>process</span>(inProt_, outProt_);
</span></span><span style=display:flex><span>        responseReady();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (TException te) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This will only be reached when there is a throwable.</span>
</span></span><span style=display:flex><span>    state_ <span style=color:#f92672>=</span> FrameBufferState.<span style=color:#a6e22e>AWAITING_CLOSE</span>;
</span></span><span style=display:flex><span>    requestSelectInterestChange();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.TBaseProcessor#process</li></ul><p>在处理时，根据方法名获取具体的处理函数，然后调用响应的处理方法进行处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process</span>(TProtocol in, TProtocol out) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>  TMessage msg <span style=color:#f92672>=</span> in.<span style=color:#a6e22e>readMessageBegin</span>();
</span></span><span style=display:flex><span>  ProcessFunction fn <span style=color:#f92672>=</span> processMap.<span style=color:#a6e22e>get</span>(msg.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (fn <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    TProtocolUtil.<span style=color:#a6e22e>skip</span>(in, TType.<span style=color:#a6e22e>STRUCT</span>);
</span></span><span style=display:flex><span>    in.<span style=color:#a6e22e>readMessageEnd</span>();
</span></span><span style=display:flex><span>    TApplicationException x <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TApplicationException(TApplicationException.<span style=color:#a6e22e>UNKNOWN_METHOD</span>, <span style=color:#e6db74>&#34;Invalid method name: &#39;&#34;</span><span style=color:#f92672>+</span>msg.<span style=color:#a6e22e>name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>    out.<span style=color:#a6e22e>writeMessageBegin</span>(<span style=color:#66d9ef>new</span> TMessage(msg.<span style=color:#a6e22e>name</span>, TMessageType.<span style=color:#a6e22e>EXCEPTION</span>, msg.<span style=color:#a6e22e>seqid</span>));
</span></span><span style=display:flex><span>    x.<span style=color:#a6e22e>write</span>(out);
</span></span><span style=display:flex><span>    out.<span style=color:#a6e22e>writeMessageEnd</span>();
</span></span><span style=display:flex><span>    out.<span style=color:#a6e22e>getTransport</span>().<span style=color:#a6e22e>flush</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    fn.<span style=color:#a6e22e>process</span>(msg.<span style=color:#a6e22e>seqid</span>, in, out, iface);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.ProcessFunction#process</li></ul><p>读取请求信息，反序列化为对象，然后调用 <code>getResult</code> 方法执行实现逻辑，获取响应；如果不是 oneway 的请求，则将相应结果写入流中，发送给客户端</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process</span>(<span style=color:#66d9ef>int</span> seqid,
</span></span><span style=display:flex><span>                          TProtocol iprot,
</span></span><span style=display:flex><span>                          TProtocol oprot,
</span></span><span style=display:flex><span>                          I iface) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取空参数实例</span>
</span></span><span style=display:flex><span>    T args <span style=color:#f92672>=</span> getEmptyArgsInstance();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取</span>
</span></span><span style=display:flex><span>    args.<span style=color:#a6e22e>read</span>(iprot);
</span></span><span style=display:flex><span>    iprot.<span style=color:#a6e22e>readMessageEnd</span>();
</span></span><span style=display:flex><span>    TSerializable result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span> msgType <span style=color:#f92672>=</span> TMessageType.<span style=color:#a6e22e>REPLY</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取结果</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> getResult(iface, args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果不是 oneway 的，则写入响应结果</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isOneway()) {
</span></span><span style=display:flex><span>        oprot.<span style=color:#a6e22e>writeMessageBegin</span>(<span style=color:#66d9ef>new</span> TMessage(getMethodName(), msgType, seqid));
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>write</span>(oprot);
</span></span><span style=display:flex><span>        oprot.<span style=color:#a6e22e>writeMessageEnd</span>();
</span></span><span style=display:flex><span>        oprot.<span style=color:#a6e22e>getTransport</span>().<span style=color:#a6e22e>flush</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloService.Processor.sayHello#getResult</li></ul><p>由生成的代码处理，会先构建一个响应结构体，然后调用相应的方法进行处理，返回结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> sayHello_result <span style=color:#a6e22e>getResult</span>(I iface, sayHello_args args) <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>  sayHello_result result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sayHello_result();
</span></span><span style=display:flex><span>  result.<span style=color:#a6e22e>success</span> <span style=color:#f92672>=</span> iface.<span style=color:#a6e22e>sayHello</span>(args.<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloServiceImpl#sayHello</li></ul><p>具体的逻辑处理，返回响应</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> HelloResponse <span style=color:#a6e22e>sayHello</span>(HelloMessage request) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>    String message <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getMessage</span>();
</span></span><span style=display:flex><span>    HelloResponse response <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloResponse();
</span></span><span style=display:flex><span>    response.<span style=color:#a6e22e>setMessage</span>(<span style=color:#e6db74>&#34;Hello &#34;</span> <span style=color:#f92672>+</span> message);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-写入响应>4. 写入响应</h3><ul><li>org.apache.thrift.ProcessFunction#process</li></ul><p>在处理完请求之后，会判断是否是 oneway 请求，如果不是，则会执行写入响应</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>isOneway()) {
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeMessageBegin</span>(<span style=color:#66d9ef>new</span> TMessage(getMethodName(), msgType, seqid));
</span></span><span style=display:flex><span>  result.<span style=color:#a6e22e>write</span>(oprot);
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeMessageEnd</span>();
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>getTransport</span>().<span style=color:#a6e22e>flush</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>org.apache.thrift.protocol.TBinaryProtocol#writeMessageBegin</li></ul><p>写入响应时，会先写入响应头；会将版本信息，消息类型，方法的名称和请求 ID 一起写入</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeMessageBegin</span>(TMessage message) <span style=color:#66d9ef>throws</span> TException {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (strictWrite_) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> version <span style=color:#f92672>=</span> VERSION_1 <span style=color:#f92672>|</span> message.<span style=color:#a6e22e>type</span>;
</span></span><span style=display:flex><span>    writeI32(version);
</span></span><span style=display:flex><span>    writeString(message.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>    writeI32(message.<span style=color:#a6e22e>seqid</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    writeString(message.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>    writeByte(message.<span style=color:#a6e22e>type</span>);
</span></span><span style=display:flex><span>    writeI32(message.<span style=color:#a6e22e>seqid</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>io.github.helloworlde.thrift.HelloResponse.HelloResponseStandardScheme#write</li></ul><p>随后写入响应内容，将对象序列化为字节</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write</span>(org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>TProtocol</span> oprot, HelloResponse struct) <span style=color:#66d9ef>throws</span> org.<span style=color:#a6e22e>apache</span>.<span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TException</span> {
</span></span><span style=display:flex><span>  struct.<span style=color:#a6e22e>validate</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeStructBegin</span>(STRUCT_DESC);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (struct.<span style=color:#a6e22e>message</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeFieldBegin</span>(MESSAGE_FIELD_DESC);
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeString</span>(struct.<span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>    oprot.<span style=color:#a6e22e>writeFieldEnd</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeFieldStop</span>();
</span></span><span style=display:flex><span>  oprot.<span style=color:#a6e22e>writeStructEnd</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后会写入响应结尾符，由 <code>SelectorThread</code> 处理写入事件，最终将请求发送给客户端</p><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/helloworlde/thrift-java-sample>helloworlde/thrift-java-sample</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2021-2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>