<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Cloud Consul 服务注册和发现</title>
<meta charset=utf-8><meta name=description content='Ladder@Spring Cloud Consul 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-consul-discovery，这个 starter 依赖于 org.springframework.cloud:spring-cloud-consul-core 和 org.springframework.cloud:spring-cloud-consul-discovery
Consul 的核心概念 server 集群的核心节点，用于和 agent 通讯，保存服务的信息
agent 集群节点的守护进程，用于服务注册等行为，但不保存数据
catalog 集群服务通信的接口
初始化 Kubernetes Client 初始化 Consul 依赖 相关 Consul 核心依赖的初始化是通过 org.springframework.cloud.consul.ConsulAutoConfiguration实现的
初始化 ConsulClient @Bean @ConditionalOnMissingBean public ConsulClient consulClient(ConsulProperties consulProperties) { final int agentPort = consulProperties.getPort(); final String agentHost = !StringUtils.isEmpty(consulProperties.getScheme()) ? consulProperties.getScheme() + "://" + consulProperties.getHost() : consulProperties.getHost(); if (consulProperties.getTls() != null) { ConsulProperties.TLSConfig tls = consulProperties.getTls(); TLSConfig tlsConfig = new TLSConfig(tls.'><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="Spring Cloud Consul 服务注册和发现"><meta property="og:description" content='Spring Cloud Consul 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-consul-discovery，这个 starter 依赖于 org.springframework.cloud:spring-cloud-consul-core 和 org.springframework.cloud:spring-cloud-consul-discovery
Consul 的核心概念 server 集群的核心节点，用于和 agent 通讯，保存服务的信息
agent 集群节点的守护进程，用于服务注册等行为，但不保存数据
catalog 集群服务通信的接口
初始化 Kubernetes Client 初始化 Consul 依赖 相关 Consul 核心依赖的初始化是通过 org.springframework.cloud.consul.ConsulAutoConfiguration实现的
初始化 ConsulClient @Bean @ConditionalOnMissingBean public ConsulClient consulClient(ConsulProperties consulProperties) { final int agentPort = consulProperties.getPort(); final String agentHost = !StringUtils.isEmpty(consulProperties.getScheme()) ? consulProperties.getScheme() + "://" + consulProperties.getHost() : consulProperties.getHost(); if (consulProperties.getTls() != null) { ConsulProperties.TLSConfig tls = consulProperties.getTls(); TLSConfig tlsConfig = new TLSConfig(tls.'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-20T22:27:16+00:00"><meta property="article:modified_time" content="2020-09-20T22:27:16+00:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="SpringCloud"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Cloud Consul 服务注册和发现"><meta name=twitter:description content='Spring Cloud Consul 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-consul-discovery，这个 starter 依赖于 org.springframework.cloud:spring-cloud-consul-core 和 org.springframework.cloud:spring-cloud-consul-discovery
Consul 的核心概念 server 集群的核心节点，用于和 agent 通讯，保存服务的信息
agent 集群节点的守护进程，用于服务注册等行为，但不保存数据
catalog 集群服务通信的接口
初始化 Kubernetes Client 初始化 Consul 依赖 相关 Consul 核心依赖的初始化是通过 org.springframework.cloud.consul.ConsulAutoConfiguration实现的
初始化 ConsulClient @Bean @ConditionalOnMissingBean public ConsulClient consulClient(ConsulProperties consulProperties) { final int agentPort = consulProperties.getPort(); final String agentHost = !StringUtils.isEmpty(consulProperties.getScheme()) ? consulProperties.getScheme() + "://" + consulProperties.getHost() : consulProperties.getHost(); if (consulProperties.getTls() != null) { ConsulProperties.TLSConfig tls = consulProperties.getTls(); TLSConfig tlsConfig = new TLSConfig(tls.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Spring Cloud Consul 服务注册和发现","item":"https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Cloud Consul 服务注册和发现","name":"Spring Cloud Consul 服务注册和发现","description":"Spring Cloud Consul 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-consul-discovery，这个 starter 依赖于 org.springframework.cloud:spring-cloud-consul-core 和 org.springframework.cloud:spring-cloud-consul-discovery\nConsul 的核心概念 server 集群的核心节点，用于和 agent 通讯，保存服务的信息\nagent 集群节点的守护进程，用于服务注册等行为，但不保存数据\ncatalog 集群服务通信的接口\n初始化 Kubernetes Client 初始化 Consul 依赖 相关 Consul 核心依赖的初始化是通过 org.springframework.cloud.consul.ConsulAutoConfiguration实现的\n初始化 ConsulClient @Bean @ConditionalOnMissingBean public ConsulClient consulClient(ConsulProperties consulProperties) { final int agentPort = consulProperties.getPort(); final String agentHost = !StringUtils.isEmpty(consulProperties.getScheme()) ? consulProperties.getScheme() + \u0026#34;://\u0026#34; + consulProperties.getHost() : consulProperties.getHost(); if (consulProperties.getTls() != null) { ConsulProperties.TLSConfig tls = consulProperties.getTls(); TLSConfig tlsConfig = new TLSConfig(tls.","keywords":["Java","SpringCloud"],"articleBody":"Spring Cloud Consul 服务注册和发现 Spring Cloud Kubernetes 使用，可以通过引入 org.springframework.cloud:spring-cloud-starter-consul-discovery，这个 starter 依赖于 org.springframework.cloud:spring-cloud-consul-core 和 org.springframework.cloud:spring-cloud-consul-discovery\nConsul 的核心概念 server 集群的核心节点，用于和 agent 通讯，保存服务的信息\nagent 集群节点的守护进程，用于服务注册等行为，但不保存数据\ncatalog 集群服务通信的接口\n初始化 Kubernetes Client 初始化 Consul 依赖 相关 Consul 核心依赖的初始化是通过 org.springframework.cloud.consul.ConsulAutoConfiguration实现的\n初始化 ConsulClient @Bean @ConditionalOnMissingBean public ConsulClient consulClient(ConsulProperties consulProperties) { final int agentPort = consulProperties.getPort(); final String agentHost = !StringUtils.isEmpty(consulProperties.getScheme()) ? consulProperties.getScheme() + \"://\" + consulProperties.getHost() : consulProperties.getHost(); if (consulProperties.getTls() != null) { ConsulProperties.TLSConfig tls = consulProperties.getTls(); TLSConfig tlsConfig = new TLSConfig(tls.getKeyStoreInstanceType(), tls.getCertificatePath(), tls.getCertificatePassword(), tls.getKeyStorePath(), tls.getKeyStorePassword()); return new ConsulClient(agentHost, agentPort, tlsConfig); } return new ConsulClient(agentHost, agentPort); } 服务注册 初始化 Bean 相关 Bean 的初始化是在 org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistrationAutoConfiguration 中完成的\n// 自动注册 @Bean @ConditionalOnMissingBean public ConsulAutoServiceRegistration consulAutoServiceRegistration( ConsulServiceRegistry registry, AutoServiceRegistrationProperties autoServiceRegistrationProperties, ConsulDiscoveryProperties properties, ConsulAutoRegistration consulRegistration) { return new ConsulAutoServiceRegistration(registry, autoServiceRegistrationProperties, properties, consulRegistration); } // 启动事件监听器 @Bean public ConsulAutoServiceRegistrationListener consulAutoServiceRegistrationListener( ConsulAutoServiceRegistration registration) { return new ConsulAutoServiceRegistrationListener(registration); } @Bean @ConditionalOnMissingBean public ConsulAutoRegistration consulRegistration( AutoServiceRegistrationProperties autoServiceRegistrationProperties, ConsulDiscoveryProperties properties, ApplicationContext applicationContext, ObjectProvider\u003cList\u003cConsulRegistrationCustomizer\u003e\u003e registrationCustomizers, ObjectProvider\u003cList\u003cConsulManagementRegistrationCustomizer\u003e\u003e managementRegistrationCustomizers, HeartbeatProperties heartbeatProperties) { return ConsulAutoRegistration.registration(autoServiceRegistrationProperties, properties, applicationContext, registrationCustomizers.getIfAvailable(), managementRegistrationCustomizers.getIfAvailable(), heartbeatProperties); } 注册流程 当监听到 WebServerInitializedEvent 事件时触发注册 ConsulAutoServiceRegistrationListener 类实现了 SmartApplicationListener接口\n@Override public void onApplicationEvent(ApplicationEvent applicationEvent) { // 判断是否是 web server 初始化事件 if (applicationEvent instanceof WebServerInitializedEvent) { WebServerInitializedEvent event = (WebServerInitializedEvent) applicationEvent; ApplicationContext context = event.getApplicationContext(); if (context instanceof ConfigurableWebServerApplicationContext) { if (\"management\".equals(((ConfigurableWebServerApplicationContext) context).getServerNamespace())) { return; } } this.autoServiceRegistration.setPortIfNeeded(event.getWebServer().getPort()); // 真正触发服务注册 this.autoServiceRegistration.start(); } } 调用 org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistration#register 注册\n@Override protected void register() { if (!this.properties.isRegister()) { log.debug(\"Registration disabled.\"); return; } super.register(); } 然后调用 org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration#start\npublic void start() { if (!this.isEnabled()) { if (logger.isDebugEnabled()) { logger.debug(\"Discovery Lifecycle disabled. Not starting\"); } } else { if (!this.running.get()) { this.context.publishEvent(new InstancePreRegisteredEvent(this, this.getRegistration())); this.register(); if (this.shouldRegisterManagement()) { this.registerManagement(); } this.context.publishEvent(new InstanceRegisteredEvent(this, this.getConfiguration())); this.running.compareAndSet(false, true); } } } protected void register() { this.serviceRegistry.register(this.getRegistration()); } 最终在 ConsulServiceRegistry 实现注册逻辑 @Override public void register(ConsulRegistration reg) { log.info(\"Registering service with consul: \" + reg.getService()); try { // 将服务注册到 Consul this.client.agentServiceRegister(reg.getService(), this.properties.getAclToken()); NewService service = reg.getService(); // 添加到心跳检查中 if (this.heartbeatProperties.isEnabled() \u0026\u0026 this.ttlScheduler != null \u0026\u0026 service.getCheck() != null \u0026\u0026 service.getCheck().getTtl() != null) { this.ttlScheduler.add(reg.getInstanceId()); } } catch (ConsulException e) { if (this.properties.isFailFast()) { log.error(\"Error registering service with consul: \" + reg.getService(), e); ReflectionUtils.rethrowRuntimeException(e); } log.warn(\"Failfast is false. Error registering service with consul: \" + reg.getService(), e); } } 最后发出服务注册事件\n取消注册流程 在 Bean org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistration 销毁的时候调用 stop 方法，执行关闭逻辑；在 stop 方法中调用 deregister 方法，取消注册 public void stop() { if (this.getRunning().compareAndSet(true, false) \u0026\u0026 this.isEnabled()) { this.deregister(); if (this.shouldRegisterManagement()) { this.deregisterManagement(); } this.serviceRegistry.close(); } } ConsulServiceRegistry 实现取消注册逻辑 @Override public void deregister(ConsulRegistration reg) { if (this.ttlScheduler != null) { this.ttlScheduler.remove(reg.getInstanceId()); } if (log.isInfoEnabled()) { log.info(\"Deregistering service with consul: \" + reg.getInstanceId()); } // 将实例从 Consul 中移除 this.client.agentServiceDeregister(reg.getInstanceId(), this.properties.getAclToken()); } 服务发现 初始化 Bean 相关 Bean 的初始化在 org.springframework.cloud.consul.discovery.ConsulDiscoveryClientConfiguration 中完成\n@Bean @ConditionalOnMissingBean public ConsulDiscoveryClient consulDiscoveryClient(ConsulClient consulClient, ConsulDiscoveryProperties discoveryProperties) { return new ConsulDiscoveryClient(consulClient, discoveryProperties); } 获取服务 getService 调用 org.springframework.cloud.consul.discovery.ConsulDiscoveryClient#getServices 方法获取指定条件下的服务名称\n@Override public List\u003cString\u003e getServices() { String aclToken = this.properties.getAclToken(); CatalogServicesRequest request = CatalogServicesRequest.newBuilder() .setQueryParams(QueryParams.DEFAULT) .setToken(this.properties.getAclToken()).build(); return new ArrayList\u003c\u003e(this.client.getCatalogServices(request).getValue().keySet()); } 最终是调用了 Consul 的 /v1/catalog/services接口\n获取实例 getInstance 调用 org.springframework.cloud.consul.discovery.ConsulDiscoveryClient#getInstances(java.lang.String, com.ecwid.consul.v1.QueryParams)，根据服务的名称获取相应的实例列表\npublic List\u003cServiceInstance\u003e getInstances(final String serviceId, final QueryParams queryParams) { List\u003cServiceInstance\u003e instances = new ArrayList\u003c\u003e(); addInstancesToList(instances, serviceId, queryParams); return instances; } private void addInstancesToList(List\u003cServiceInstance\u003e instances, String serviceId, QueryParams queryParams) { // 请求参数 HealthServicesRequest request = HealthServicesRequest.newBuilder() .setTag(this.properties.getDefaultQueryTag()) .setPassing(this.properties.isQueryPassing()) .setQueryParams(queryParams) .setToken(this.properties.getAclToken()).build(); Response\u003cList\u003cHealthService\u003e\u003e services = this.client.getHealthServices(serviceId, request); for (HealthService service : services.getValue()) { String host = findHost(service); Map\u003cString, String\u003e metadata = getMetadata(service, this.properties.isTagsAsMetadata()); boolean secure = false; if (metadata.containsKey(\"secure\")) { secure = Boolean.parseBoolean(metadata.get(\"secure\")); } instances.add( new DefaultServiceInstance( service.getService().getId(), serviceId, host, service.getService().getPort(), secure, metadata) ); } } 服务列表更新 Consul 的实例监听是通过定时任务，默认每秒都会拉取服务列表，如果发现返回的 Index 发生变化，则说明服务发生变化，发出 HeartbeatEvent 事件\n实例初始化 @Bean @ConditionalOnMissingBean public ConsulCatalogWatch consulCatalogWatch( ConsulDiscoveryProperties discoveryProperties, ConsulClient consulClient, @Qualifier(CATALOG_WATCH_TASK_SCHEDULER_NAME) TaskScheduler taskScheduler) { return new ConsulCatalogWatch(discoveryProperties, consulClient, taskScheduler); } 监听实现 是在 org.springframework.cloud.consul.discovery.ConsulCatalogWatch#catalogServicesWatch\n@Timed(\"consul.watch-catalog-services\") public void catalogServicesWatch() { try { long index = -1; if (this.catalogServicesIndex.get() != null) { index = this.catalogServicesIndex.get().longValue(); } // 获取服务信息 CatalogServicesRequest request = CatalogServicesRequest.newBuilder() .setQueryParams(new QueryParams(this.properties.getCatalogServicesWatchTimeout(), index)) .setToken(this.properties.getAclToken()).build(); Response\u003cMap\u003cString, List\u003cString\u003e\u003e\u003e response = this.consul.getCatalogServices(request); // 获取位点并发送事件 Long consulIndex = response.getConsulIndex(); if (consulIndex != null) { this.catalogServicesIndex.set(BigInteger.valueOf(consulIndex)); } if (log.isTraceEnabled()) { log.trace(\"Received services update from consul: \" + response.getValue() + \", index: \" + consulIndex); } this.publisher.publishEvent(new HeartbeatEvent(this, consulIndex)); } catch (Exception e) { log.error(\"Error watching Consul CatalogServices\", e); } } ","wordCount":"666","inLanguage":"en","datePublished":"2020-09-20T22:27:16Z","dateModified":"2020-09-20T22:27:16Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script defer src=https://analytics.us.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Spring Cloud Consul 服务注册和发现</h1></header><p><small>September 20, 2020&nbsp;· 666 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#consul-的核心概念>Consul 的核心概念</a></li><li><a href=#初始化-kubernetes-client>初始化 Kubernetes Client</a><ul><li><a href=#初始化-consul-依赖>初始化 Consul 依赖</a></li></ul></li><li><a href=#服务注册>服务注册</a><ul><li><a href=#初始化-bean>初始化 Bean</a></li><li><a href=#注册流程>注册流程</a></li><li><a href=#取消注册流程>取消注册流程</a></li></ul></li><li><a href=#服务发现>服务发现</a><ul><li><a href=#初始化-bean-1>初始化 Bean</a></li><li><a href=#获取服务>获取服务</a></li><li><a href=#获取实例>获取实例</a></li></ul></li><li><a href=#服务列表更新>服务列表更新</a><ul><li><a href=#实例初始化>实例初始化</a></li><li><a href=#监听实现>监听实现</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=spring-cloud-consul-服务注册和发现>Spring Cloud Consul 服务注册和发现</h1><p>Spring Cloud Kubernetes 使用，可以通过引入 <code>org.springframework.cloud:spring-cloud-starter-consul-discovery</code>，这个 starter 依赖于 <code>org.springframework.cloud:spring-cloud-consul-core</code> 和 <code>org.springframework.cloud:spring-cloud-consul-discovery</code></p><h2 id=consul-的核心概念>Consul 的核心概念</h2><ul><li><p>server
集群的核心节点，用于和 agent 通讯，保存服务的信息</p></li><li><p>agent
集群节点的守护进程，用于服务注册等行为，但不保存数据</p></li><li><p>catalog
集群服务通信的接口</p></li></ul><h2 id=初始化-kubernetes-client>初始化 Kubernetes Client</h2><h3 id=初始化-consul-依赖>初始化 Consul 依赖</h3><p>相关 Consul 核心依赖的初始化是通过 <code>org.springframework.cloud.consul.ConsulAutoConfiguration</code>实现的</p><ul><li>初始化 ConsulClient</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ConsulClient <span style=color:#a6e22e>consulClient</span>(ConsulProperties consulProperties) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> agentPort <span style=color:#f92672>=</span> consulProperties.<span style=color:#a6e22e>getPort</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>final</span> String agentHost <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>StringUtils.<span style=color:#a6e22e>isEmpty</span>(consulProperties.<span style=color:#a6e22e>getScheme</span>())
</span></span><span style=display:flex><span>			<span style=color:#f92672>?</span> consulProperties.<span style=color:#a6e22e>getScheme</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;://&#34;</span> <span style=color:#f92672>+</span> consulProperties.<span style=color:#a6e22e>getHost</span>()
</span></span><span style=display:flex><span>			: consulProperties.<span style=color:#a6e22e>getHost</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (consulProperties.<span style=color:#a6e22e>getTls</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>			ConsulProperties.<span style=color:#a6e22e>TLSConfig</span> tls <span style=color:#f92672>=</span> consulProperties.<span style=color:#a6e22e>getTls</span>();
</span></span><span style=display:flex><span>			TLSConfig tlsConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TLSConfig(tls.<span style=color:#a6e22e>getKeyStoreInstanceType</span>(),
</span></span><span style=display:flex><span>				tls.<span style=color:#a6e22e>getCertificatePath</span>(), tls.<span style=color:#a6e22e>getCertificatePassword</span>(),
</span></span><span style=display:flex><span>				tls.<span style=color:#a6e22e>getKeyStorePath</span>(), tls.<span style=color:#a6e22e>getKeyStorePassword</span>());
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConsulClient(agentHost, agentPort, tlsConfig);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConsulClient(agentHost, agentPort);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h2 id=服务注册>服务注册</h2><h3 id=初始化-bean>初始化 Bean</h3><p>相关 Bean 的初始化是在 <code>org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistrationAutoConfiguration</code> 中完成的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>// 自动注册</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ConsulAutoServiceRegistration <span style=color:#a6e22e>consulAutoServiceRegistration</span>(
</span></span><span style=display:flex><span>		ConsulServiceRegistry registry,
</span></span><span style=display:flex><span>		AutoServiceRegistrationProperties autoServiceRegistrationProperties,
</span></span><span style=display:flex><span>		ConsulDiscoveryProperties properties,
</span></span><span style=display:flex><span>		ConsulAutoRegistration consulRegistration) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConsulAutoServiceRegistration(registry, autoServiceRegistrationProperties, properties, consulRegistration);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 启动事件监听器</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ConsulAutoServiceRegistrationListener <span style=color:#a6e22e>consulAutoServiceRegistrationListener</span>(
</span></span><span style=display:flex><span>		ConsulAutoServiceRegistration registration) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConsulAutoServiceRegistrationListener(registration);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ConsulAutoRegistration <span style=color:#a6e22e>consulRegistration</span>(
</span></span><span style=display:flex><span>		AutoServiceRegistrationProperties autoServiceRegistrationProperties,
</span></span><span style=display:flex><span>		ConsulDiscoveryProperties properties, ApplicationContext applicationContext,
</span></span><span style=display:flex><span>		ObjectProvider<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>ConsulRegistrationCustomizer<span style=color:#f92672>&gt;&gt;</span> registrationCustomizers,
</span></span><span style=display:flex><span>		ObjectProvider<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>ConsulManagementRegistrationCustomizer<span style=color:#f92672>&gt;&gt;</span> managementRegistrationCustomizers,
</span></span><span style=display:flex><span>		HeartbeatProperties heartbeatProperties) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> ConsulAutoRegistration.<span style=color:#a6e22e>registration</span>(autoServiceRegistrationProperties,
</span></span><span style=display:flex><span>			properties, applicationContext, registrationCustomizers.<span style=color:#a6e22e>getIfAvailable</span>(),
</span></span><span style=display:flex><span>			managementRegistrationCustomizers.<span style=color:#a6e22e>getIfAvailable</span>(), heartbeatProperties);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=注册流程>注册流程</h3><ul><li>当监听到 <code>WebServerInitializedEvent</code> 事件时触发注册</li></ul><p><code>ConsulAutoServiceRegistrationListener</code> 类实现了 <code>SmartApplicationListener</code>接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onApplicationEvent</span>(ApplicationEvent applicationEvent) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 判断是否是 web server 初始化事件</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (applicationEvent <span style=color:#66d9ef>instanceof</span> WebServerInitializedEvent) {
</span></span><span style=display:flex><span>			WebServerInitializedEvent event <span style=color:#f92672>=</span> (WebServerInitializedEvent) applicationEvent;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			ApplicationContext context <span style=color:#f92672>=</span> event.<span style=color:#a6e22e>getApplicationContext</span>();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (context <span style=color:#66d9ef>instanceof</span> ConfigurableWebServerApplicationContext) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#34;management&#34;</span>.<span style=color:#a6e22e>equals</span>(((ConfigurableWebServerApplicationContext) context).<span style=color:#a6e22e>getServerNamespace</span>())) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>autoServiceRegistration</span>.<span style=color:#a6e22e>setPortIfNeeded</span>(event.<span style=color:#a6e22e>getWebServer</span>().<span style=color:#a6e22e>getPort</span>());
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 真正触发服务注册</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>autoServiceRegistration</span>.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>调用 <code>org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistration#register</code> 注册</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isRegister</span>()) {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Registration disabled.&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>register</span>();
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>然后调用 <code>org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration#start</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEnabled</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (logger.<span style=color:#a6e22e>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>                logger.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Discovery Lifecycle disabled. Not starting&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>running</span>.<span style=color:#a6e22e>get</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>publishEvent</span>(<span style=color:#66d9ef>new</span> InstancePreRegisteredEvent(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRegistration</span>()));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>register</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>shouldRegisterManagement</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>registerManagement</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>publishEvent</span>(<span style=color:#66d9ef>new</span> InstanceRegisteredEvent(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getConfiguration</span>()));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>running</span>.<span style=color:#a6e22e>compareAndSet</span>(<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>serviceRegistry</span>.<span style=color:#a6e22e>register</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRegistration</span>());
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><ul><li>最终在 <code>ConsulServiceRegistry</code> 实现注册逻辑</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>(ConsulRegistration reg) {
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Registering service with consul: &#34;</span> <span style=color:#f92672>+</span> reg.<span style=color:#a6e22e>getService</span>());
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将服务注册到 Consul</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>agentServiceRegister</span>(reg.<span style=color:#a6e22e>getService</span>(), <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getAclToken</span>());
</span></span><span style=display:flex><span>			NewService service <span style=color:#f92672>=</span> reg.<span style=color:#a6e22e>getService</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 添加到心跳检查中</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>heartbeatProperties</span>.<span style=color:#a6e22e>isEnabled</span>() <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ttlScheduler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>				service.<span style=color:#a6e22e>getCheck</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>				service.<span style=color:#a6e22e>getCheck</span>().<span style=color:#a6e22e>getTtl</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ttlScheduler</span>.<span style=color:#a6e22e>add</span>(reg.<span style=color:#a6e22e>getInstanceId</span>());
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (ConsulException e) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isFailFast</span>()) {
</span></span><span style=display:flex><span>				log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error registering service with consul: &#34;</span> <span style=color:#f92672>+</span> reg.<span style=color:#a6e22e>getService</span>(), e);
</span></span><span style=display:flex><span>				ReflectionUtils.<span style=color:#a6e22e>rethrowRuntimeException</span>(e);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Failfast is false. Error registering service with consul: &#34;</span> <span style=color:#f92672>+</span> reg.<span style=color:#a6e22e>getService</span>(), e);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>最后发出服务注册事件</p><h3 id=取消注册流程>取消注册流程</h3><ul><li>在 Bean <code>org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistration</code> 销毁的时候调用 stop 方法，执行关闭逻辑；在 stop 方法中调用 deregister 方法，取消注册</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stop</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getRunning</span>().<span style=color:#a6e22e>compareAndSet</span>(<span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isEnabled</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deregister</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>shouldRegisterManagement</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deregisterManagement</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>serviceRegistry</span>.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><ul><li><code>ConsulServiceRegistry</code> 实现取消注册逻辑</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deregister</span>(ConsulRegistration reg) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ttlScheduler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ttlScheduler</span>.<span style=color:#a6e22e>remove</span>(reg.<span style=color:#a6e22e>getInstanceId</span>());
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (log.<span style=color:#a6e22e>isInfoEnabled</span>()) {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Deregistering service with consul: &#34;</span> <span style=color:#f92672>+</span> reg.<span style=color:#a6e22e>getInstanceId</span>());
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将实例从 Consul 中移除</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>agentServiceDeregister</span>(reg.<span style=color:#a6e22e>getInstanceId</span>(), <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getAclToken</span>());
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h2 id=服务发现>服务发现</h2><h3 id=初始化-bean-1>初始化 Bean</h3><p>相关 Bean 的初始化在 <code>org.springframework.cloud.consul.discovery.ConsulDiscoveryClientConfiguration</code> 中完成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ConsulDiscoveryClient <span style=color:#a6e22e>consulDiscoveryClient</span>(ConsulClient consulClient,
</span></span><span style=display:flex><span>	                                                   ConsulDiscoveryProperties discoveryProperties) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConsulDiscoveryClient(consulClient, discoveryProperties);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=获取服务>获取服务</h3><ul><li>getService</li></ul><p>调用 <code>org.springframework.cloud.consul.discovery.ConsulDiscoveryClient#getServices</code> 方法获取指定条件下的服务名称</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getServices</span>() {
</span></span><span style=display:flex><span>		String aclToken <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getAclToken</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		CatalogServicesRequest request <span style=color:#f92672>=</span> CatalogServicesRequest.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>		                                                       .<span style=color:#a6e22e>setQueryParams</span>(QueryParams.<span style=color:#a6e22e>DEFAULT</span>)
</span></span><span style=display:flex><span>		                                                       .<span style=color:#a6e22e>setToken</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getAclToken</span>()).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>getCatalogServices</span>(request).<span style=color:#a6e22e>getValue</span>().<span style=color:#a6e22e>keySet</span>());
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>最终是调用了 Consul 的 <code>/v1/catalog/services</code>接口</p><h3 id=获取实例>获取实例</h3><ul><li>getInstance</li></ul><p>调用 <code>org.springframework.cloud.consul.discovery.ConsulDiscoveryClient#getInstances(java.lang.String, com.ecwid.consul.v1.QueryParams)</code>，根据服务的名称获取相应的实例列表</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getInstances</span>(<span style=color:#66d9ef>final</span> String serviceId,
</span></span><span style=display:flex><span>	                                          <span style=color:#66d9ef>final</span> QueryParams queryParams) {
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> instances <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		addInstancesToList(instances, serviceId, queryParams);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> instances;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addInstancesToList</span>(List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> instances, String serviceId,
</span></span><span style=display:flex><span>	                                QueryParams queryParams) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 请求参数</span>
</span></span><span style=display:flex><span>		HealthServicesRequest request <span style=color:#f92672>=</span> HealthServicesRequest.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>		                                                     .<span style=color:#a6e22e>setTag</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getDefaultQueryTag</span>())
</span></span><span style=display:flex><span>		                                                     .<span style=color:#a6e22e>setPassing</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isQueryPassing</span>())
</span></span><span style=display:flex><span>		                                                     .<span style=color:#a6e22e>setQueryParams</span>(queryParams)
</span></span><span style=display:flex><span>		                                                     .<span style=color:#a6e22e>setToken</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getAclToken</span>()).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>		Response<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>HealthService<span style=color:#f92672>&gt;&gt;</span> services <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>getHealthServices</span>(serviceId,
</span></span><span style=display:flex><span>			request);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (HealthService service : services.<span style=color:#a6e22e>getValue</span>()) {
</span></span><span style=display:flex><span>			String host <span style=color:#f92672>=</span> findHost(service);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> metadata <span style=color:#f92672>=</span> getMetadata(service, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isTagsAsMetadata</span>());
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>boolean</span> secure <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (metadata.<span style=color:#a6e22e>containsKey</span>(<span style=color:#e6db74>&#34;secure&#34;</span>)) {
</span></span><span style=display:flex><span>				secure <span style=color:#f92672>=</span> Boolean.<span style=color:#a6e22e>parseBoolean</span>(metadata.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;secure&#34;</span>));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			instances.<span style=color:#a6e22e>add</span>(
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>new</span> DefaultServiceInstance(
</span></span><span style=display:flex><span>					service.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>getId</span>(),
</span></span><span style=display:flex><span>					serviceId,
</span></span><span style=display:flex><span>					host,
</span></span><span style=display:flex><span>					service.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>getPort</span>(),
</span></span><span style=display:flex><span>					secure,
</span></span><span style=display:flex><span>					metadata)
</span></span><span style=display:flex><span>			);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h2 id=服务列表更新>服务列表更新</h2><p>Consul 的实例监听是通过定时任务，默认每秒都会拉取服务列表，如果发现返回的 Index 发生变化，则说明服务发生变化，发出 <code>HeartbeatEvent</code> 事件</p><h3 id=实例初始化>实例初始化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ConsulCatalogWatch <span style=color:#a6e22e>consulCatalogWatch</span>(
</span></span><span style=display:flex><span>			ConsulDiscoveryProperties discoveryProperties, 
</span></span><span style=display:flex><span>			ConsulClient consulClient,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>@Qualifier</span>(CATALOG_WATCH_TASK_SCHEDULER_NAME) TaskScheduler taskScheduler) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConsulCatalogWatch(discoveryProperties, consulClient, taskScheduler);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h3 id=监听实现>监听实现</h3><p>是在 <code>org.springframework.cloud.consul.discovery.ConsulCatalogWatch#catalogServicesWatch</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Timed</span>(<span style=color:#e6db74>&#34;consul.watch-catalog-services&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>catalogServicesWatch</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>long</span> index <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>catalogServicesIndex</span>.<span style=color:#a6e22e>get</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>				index <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>catalogServicesIndex</span>.<span style=color:#a6e22e>get</span>().<span style=color:#a6e22e>longValue</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 获取服务信息</span>
</span></span><span style=display:flex><span>			CatalogServicesRequest request <span style=color:#f92672>=</span> CatalogServicesRequest.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>			                                                       .<span style=color:#a6e22e>setQueryParams</span>(<span style=color:#66d9ef>new</span> QueryParams(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getCatalogServicesWatchTimeout</span>(), index))
</span></span><span style=display:flex><span>			                                                       .<span style=color:#a6e22e>setToken</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getAclToken</span>()).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>			Response<span style=color:#f92672>&lt;</span>Map<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;&gt;&gt;</span> response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>consul</span>.<span style=color:#a6e22e>getCatalogServices</span>(request);
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 获取位点并发送事件</span>
</span></span><span style=display:flex><span>			Long consulIndex <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getConsulIndex</span>();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (consulIndex <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>catalogServicesIndex</span>.<span style=color:#a6e22e>set</span>(BigInteger.<span style=color:#a6e22e>valueOf</span>(consulIndex));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (log.<span style=color:#a6e22e>isTraceEnabled</span>()) {
</span></span><span style=display:flex><span>				log.<span style=color:#a6e22e>trace</span>(<span style=color:#e6db74>&#34;Received services update from consul: &#34;</span> <span style=color:#f92672>+</span> response.<span style=color:#a6e22e>getValue</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, index: &#34;</span> <span style=color:#f92672>+</span> consulIndex);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>publisher</span>.<span style=color:#a6e22e>publishEvent</span>(<span style=color:#66d9ef>new</span> HeartbeatEvent(<span style=color:#66d9ef>this</span>, consulIndex));
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error watching Consul CatalogServices&#34;</span>, e);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>Spring Cloud 使用 Kubernetes 作为配置中心</span></a>
<a class=next href=https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/><span>Spring Cloud Kubernetes 服务注册和发现</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>