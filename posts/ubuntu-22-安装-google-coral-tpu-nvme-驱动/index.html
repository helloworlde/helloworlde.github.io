<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Ubuntu 22 安装 Google Coral TPU NVME 驱动</title>
<meta name=description content="Copy Paste Worker"><meta name=keywords content='blog,hugo,Ubuntu,Coral'><meta property="og:url" content="https://blog.hellowood.dev/posts/ubuntu-22-%E5%AE%89%E8%A3%85-google-coral-tpu-nvme-%E9%A9%B1%E5%8A%A8/"><meta property="og:type" content="website"><meta property="og:title" content="Ubuntu 22 安装 Google Coral TPU NVME 驱动"><meta property="og:description" content="Copy Paste Worker"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.png"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Ubuntu 22 安装 Google Coral TPU NVME 驱动"><meta name=twitter:description content="Copy Paste Worker"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/ubuntu-22-%E5%AE%89%E8%A3%85-google-coral-tpu-nvme-%E9%A9%B1%E5%8A%A8/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/ubuntu-22-%E5%AE%89%E8%A3%85-google-coral-tpu-nvme-%E9%A9%B1%E5%8A%A8/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.png"><link rel=canonical href=https://blog.hellowood.dev/posts/ubuntu-22-%E5%AE%89%E8%A3%85-google-coral-tpu-nvme-%E9%A9%B1%E5%8A%A8/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script defer src=https://analytics.us.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Ubuntu 22 安装 Google Coral TPU NVME 驱动</h1><small role=doc-subtitle></small><p class=post-date>2024-07-07</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/ubuntu>Ubuntu</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/coral>Coral</a></li></ul></div><div class=post-content><p>最近折腾图像识别和视频对象检测，因为需要长期低功耗运行，所以购入了 Google Coral TPU</p><p>Google Coral TPU 是一款专为边缘应用设计的机器学习加速器，由 Google 设计和开发，它基于 TensorFlow Lite 模型，能够在低功耗的情况下提供快速的神经网络性能，适用于边缘设备，用于目标检测和图像分类(如开源 NVR Frigate)；可以使用 Yolo、MobikeNet 等模型</p><p>单个 Coral TPU 芯片有 4T OPS 的算力，每秒可以识别大概 100 帧的视频内容，非常适合低功耗、本地场景，可以有效保护隐私；虽然 Coral 从 2021年开始不再更新，但是在边缘场景下依然是非常合适的选择</p><p>Coral TPU 有多种型号，如开发板、USB 配件、M2、Mini PCIE等，这里使用的是 M.2 Accelerator B+M key 的版本。关于 Coral 不同类型的设备更多信息参考 <a href=https://coral.ai/products/>Products</a></p><p><img src="https://lh3.googleusercontent.com/-R0H37d9aKorHo_VYWf8hCfukvbZolBaW2SHW1uDDn1G411r3MqemjxPZa9f44q8OwlfYIkGxSoj-GQbZGd2j7lxtyzSklIQVUWvo9r88mn8CzB-rcw=w2000-rw" alt></p><h2 id=要求>要求</h2><ul><li>系统：Linux、Windows</li><li>环境：python3.6-3.9</li></ul><h2 id=安装>安装</h2><h3 id=安装-coral-tpu>安装 Coral TPU</h3><ul><li>安装 Coral TPU</li></ul><p>将 Coral TPU 安装到 M.2 插槽</p><ul><li>检查连接</li></ul><p>等待启动后，检查 NVME 连接</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lspci -nn | grep 089a
</span></span></code></pre></div><p>已经正确识别到了 Coral TPU</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>03:00.0 System peripheral <span style=color:#c7bf54>[</span>0880<span style=color:#c7bf54>]</span>: Global Unichip Corp. Coral Edge TPU <span style=color:#c7bf54>[</span>1ac1:089a<span style=color:#c7bf54>]</span>
</span></span></code></pre></div><h3 id=安装驱动>安装驱动</h3><p>需要安装 <code>gasket-dkms</code> 和 <code>libedgetpu1-std</code>；</p><p><code>gasket-dkms</code> 是一个动态内核模块支持 (DKMS) 包，它包含了用于与 EdgeTPU 进行通信的驱动程序；<code>libedgetpu1-std</code> 是一个 C++ 库，提供了一个更高级别的接口，让应用能够使用 EdgeTPU 进行模型推理</p><h4 id=添加-coral-软件源>添加 Coral 软件源</h4><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ef8383>echo</span> <span style=color:#63c381>&#34;deb https://packages.cloud.google.com/apt coral-edgetpu-stable main&#34;</span> | sudo tee /etc/apt/sources.list.d/coral-edgetpu.list
</span></span><span style=display:flex><span>curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
</span></span><span style=display:flex><span>sudo apt-get update
</span></span></code></pre></div><p>如果提示 &ldquo;不支持 &lsquo;i386&rsquo; 体系结构，跳过配置文件 &lsquo;main/binary-i386/Packages&rsquo; 的获取&rdquo;, 则将 <code>deb https://packages.cloud.google.com/apt coral-edgetpu-stable main</code> 改为 <code>deb [arch=amd64] https://packages.cloud.google.com/apt coral-edgetpu-stable main</code></p><h4 id=安装-libedgetpu1-std>安装 libedgetpu1-std</h4><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt install libedgetpu1-std
</span></span></code></pre></div><h4 id=安装-gasket-dkms>安装 gasket-dkms</h4><p><code>gasket-dkms</code> 在 Ubuntu 22 中无法直接安装，因此需要手动编译安装</p><ul><li>安装依赖</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt upgrade
</span></span><span style=display:flex><span>sudo apt install dkms devscripts debhelper dh-dkms -y
</span></span></code></pre></div><ul><li>下载源码</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/google/gasket-driver.git
</span></span></code></pre></div><ul><li>编译</li></ul><p>使用 root 用户进行编译</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -i
</span></span><span style=display:flex><span><span style=color:#ef8383>cd</span> gasket-driver; debuild -us -uc -tc -b; <span style=color:#ef8383>cd</span> ..
</span></span></code></pre></div><p>会进入项目目录编译并在当前目录生成编译后的软件</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dpkg-buildpackage -us -uc -ui -tc -b
</span></span><span style=display:flex><span>dpkg-buildpackage: info: 源码包 gasket-dkms
</span></span><span style=display:flex><span>dpkg-buildpackage: info: 源码版本 1.0-18
</span></span><span style=display:flex><span>dpkg-buildpackage: info: <span style=color:#ef8383>source</span> distribution unstable
</span></span><span style=display:flex><span>dpkg-buildpackage: info: 源码修改者 Coral &lt;coral-support@google.com&gt;
</span></span><span style=display:flex><span> dpkg-source --before-build .
</span></span><span style=display:flex><span>dpkg-buildpackage: info: 主机架构 amd64
</span></span><span style=display:flex><span>... 
</span></span></code></pre></div><ul><li>检查软件信息</li></ul><p>编译完成后，会在当前目录下生成 <code>gasket-dkms_版本_all.deb</code> 软件包及相关信息文件</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l gasket-dkms*
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>-rw-r--r-- <span style=color:#d19a66>1</span> root root <span style=color:#d19a66>49162</span>  7月 <span style=color:#d19a66>14</span> 19:07 gasket-dkms_1.0-18_all.deb
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#d19a66>1</span> root root  <span style=color:#d19a66>1882</span>  7月 <span style=color:#d19a66>14</span> 19:07 gasket-dkms_1.0-18_amd64.build
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#d19a66>1</span> root root  <span style=color:#d19a66>6700</span>  7月 <span style=color:#d19a66>14</span> 19:07 gasket-dkms_1.0-18_amd64.buildinfo
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#d19a66>1</span> root root  <span style=color:#d19a66>1017</span>  7月 <span style=color:#d19a66>14</span> 19:07 gasket-dkms_1.0-18_amd64.changes
</span></span></code></pre></div><ul><li>安装软件</li></ul><p>安装刚才编译的 gasket-dkms</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dpkg -i gasket-dkms_1.0-18_all.deb
</span></span></code></pre></div><ul><li>加载 apex 模块</li></ul><p>加载 Coral 的驱动程序</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo modprobe apex
</span></span></code></pre></div><h3 id=添加用户权限>添加用户权限</h3><p>如果用户没有 root 权限，需要将该用户手动添加到 apex 用户组</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sh -c <span style=color:#63c381>&#34;echo &#39;SUBSYSTEM==\&#34;apex\&#34;, MODE=\&#34;0660\&#34;, GROUP=\&#34;apex\&#34;&#39; &gt;&gt; /etc/udev/rules.d/65-apex.rules&#34;</span>
</span></span><span style=display:flex><span>sudo groupadd apex
</span></span><span style=display:flex><span>sudo adduser <span style=color:#dcaeea>$USER</span> apex
</span></span></code></pre></div><h2 id=检查>检查</h2><ul><li>检查内核模块</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lsmod | grep apex
</span></span></code></pre></div><p>会输出 apex 模块的信息，apex 模块依赖 gasket 模块</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apex                   <span style=color:#d19a66>28672</span>  <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>gasket                <span style=color:#d19a66>135168</span>  <span style=color:#d19a66>1</span> apex
</span></span></code></pre></div><ul><li>检查 PCIE 驱动</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls /dev/apex_0
</span></span></code></pre></div><p>设备存在说明 apex 模块成功加载了 Coral 设备</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/dev/apex_0
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://coral.ai/docs/m2/get-started/#2a-on-linux>Install the PCIe driver and Edge TPU runtime</a></li><li><a href=https://github.com/google-coral/edgetpu/issues/808>Building gasket-dkms broken on linux kernel 6.5.0 (Ubuntu 23.10)</a></li></ul><h2 id=安装遇到的问题>安装遇到的问题</h2><ul><li>安装 gasket-dkms 提示错误，需要手动编译源码安装</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt install gasket-dkms
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>正在读取软件包列表... 完成
</span></span><span style=display:flex><span>正在分析软件包的依赖关系树... 完成
</span></span><span style=display:flex><span>正在读取状态信息... 完成
</span></span><span style=display:flex><span>下列【新】软件包将被安装：
</span></span><span style=display:flex><span>  gasket-dkms
</span></span><span style=display:flex><span>升级了 <span style=color:#d19a66>0</span> 个软件包，新安装了 <span style=color:#d19a66>1</span> 个软件包，要卸载 <span style=color:#d19a66>0</span> 个软件包，有 <span style=color:#d19a66>0</span> 个软件包未被升级。
</span></span><span style=display:flex><span>需要下载 <span style=color:#d19a66>0</span> B/48.0 kB 的归档。
</span></span><span style=display:flex><span>解压缩后会消耗 <span style=color:#d19a66>256</span> kB 的额外空间。
</span></span><span style=display:flex><span>正在选中未选择的软件包 gasket-dkms。
</span></span><span style=display:flex><span><span style=color:#c7bf54>(</span>正在读取数据库 ... 系统当前共安装有 <span style=color:#d19a66>349763</span> 个文件和目录。<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>准备解压 .../gasket-dkms_1.0-18_all.deb  ...
</span></span><span style=display:flex><span>正在解压 gasket-dkms <span style=color:#c7bf54>(</span>1.0-18<span style=color:#c7bf54>)</span> ...
</span></span><span style=display:flex><span>正在设置 gasket-dkms <span style=color:#c7bf54>(</span>1.0-18<span style=color:#c7bf54>)</span> ...
</span></span><span style=display:flex><span>Loading new gasket-1.0 DKMS files...
</span></span><span style=display:flex><span>Building <span style=color:#c678dd>for</span> 6.5.0-41-generic
</span></span><span style=display:flex><span>Building initial module <span style=color:#c678dd>for</span> 6.5.0-41-generic
</span></span><span style=display:flex><span>ERROR: Cannot create report: <span style=color:#c7bf54>[</span>Errno 17<span style=color:#c7bf54>]</span> File exists: <span style=color:#98c379>&#39;/var/crash/gasket-dkms.0.crash&#39;</span>
</span></span><span style=display:flex><span>Error! Bad <span style=color:#c678dd>return</span> status <span style=color:#c678dd>for</span> module build on kernel: 6.5.0-41-generic <span style=color:#c7bf54>(</span>x86_64<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>Consult /var/lib/dkms/gasket/1.0/build/make.log <span style=color:#c678dd>for</span> more information.
</span></span><span style=display:flex><span>dpkg: 处理软件包 gasket-dkms <span style=color:#c7bf54>(</span>--configure<span style=color:#c7bf54>)</span>时出错：
</span></span><span style=display:flex><span> 已安装 gasket-dkms 软件包 post-installation 脚本 子进程返回错误状态 <span style=color:#d19a66>10</span>
</span></span><span style=display:flex><span>在处理时有错误发生：
</span></span><span style=display:flex><span> gasket-dkms
</span></span></code></pre></div><ul><li>编译 gasket-dkms 提示 unstable</li></ul><p>表示 gasket-dkms 软件包的 Changes 文件中使用了 &ldquo;unstable&rdquo; 作为发行版，而 Lintian 认为 &ldquo;unstable&rdquo; 不是一个有效的发行版名称，这是因为在 ubuntu 上编译 debian 的软件导致的；这个错误提示并不影响使用，忽略即可</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>....
</span></span><span style=display:flex><span> dpkg-source --after-build .
</span></span><span style=display:flex><span>dpkg-buildpackage: info: binary-only upload <span style=color:#c7bf54>(</span>no <span style=color:#ef8383>source</span> included<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>Now running lintian gasket-dkms_1.0-18_amd64.changes ...
</span></span><span style=display:flex><span>running with root privileges is not recommended!
</span></span><span style=display:flex><span>E: gasket-dkms changes: bad-distribution-in-changes-file unstable
</span></span><span style=display:flex><span>Finished running lintian.
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>