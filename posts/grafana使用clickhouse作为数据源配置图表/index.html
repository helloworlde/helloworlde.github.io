<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Grafana 使用 ClickHouse 作为数据源配置图表</title>
<meta charset=utf-8><meta name=description content="Ladder@Grafana 使用 ClickHouse 作为数据源配置图表 ClickHouse 是一种开源的列式数据库管理系统，专注于处理大规模数据分析工作负载。它在处理海量数据时具有高性能、可扩展、灵活的数据模型、支持 SQL 等特性；适用于需要及时分析最新数据的应用场景，如日志分析、事件跟踪等
在应用过程中，使用 ClickHouse 作为数据源，保存服务上报的秒级指标信息，用于 Grafana 查询秒级监控指标
这里使用的 Grafana 版本 v10.1.1, ClickHouse 版本为 23.9.3.12
启动服务并添加数据 启动 ClickHouse 和 Grafana 使用 Docker Compose 启动
version: '3.7' services: grafana: image: grafana/grafana ports: - '3000:3000' volumes: - ./data/grafana:/var/lib/grafana - ./data/plugins/:/var/lib/grafana/plugins - ./data/provisioning:/etc/grafana/provisioning networks: - grafana clickhouse: image: 'clickhouse/clickhouse-server' container_name: 'grafana-clickhouse-server' ports: - '8123:8123' - '9000:9000' volumes: - ./data/data:/var/lib/clickhouse - ./data/temp:/temp - ./data/log:/var/log/clickhouse-server environment: CLICKHOUSE_SERVER_USER: default CLICKHOUSE_SERVER_PASSWORD: 123456 networks: - grafana networks: grafana: 添加数据 登陆数据库 进入到 docker 容器中，然后使用 clickhouse-client 访问数据库"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/grafana%E4%BD%BF%E7%94%A8clickhouse%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E5%9B%BE%E8%A1%A8/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/grafana%E4%BD%BF%E7%94%A8clickhouse%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E5%9B%BE%E8%A1%A8/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="Grafana 使用 ClickHouse 作为数据源配置图表"><meta property="og:description" content="Grafana 使用 ClickHouse 作为数据源配置图表 ClickHouse 是一种开源的列式数据库管理系统，专注于处理大规模数据分析工作负载。它在处理海量数据时具有高性能、可扩展、灵活的数据模型、支持 SQL 等特性；适用于需要及时分析最新数据的应用场景，如日志分析、事件跟踪等
在应用过程中，使用 ClickHouse 作为数据源，保存服务上报的秒级指标信息，用于 Grafana 查询秒级监控指标
这里使用的 Grafana 版本 v10.1.1, ClickHouse 版本为 23.9.3.12
启动服务并添加数据 启动 ClickHouse 和 Grafana 使用 Docker Compose 启动
version: '3.7' services: grafana: image: grafana/grafana ports: - '3000:3000' volumes: - ./data/grafana:/var/lib/grafana - ./data/plugins/:/var/lib/grafana/plugins - ./data/provisioning:/etc/grafana/provisioning networks: - grafana clickhouse: image: 'clickhouse/clickhouse-server' container_name: 'grafana-clickhouse-server' ports: - '8123:8123' - '9000:9000' volumes: - ./data/data:/var/lib/clickhouse - ./data/temp:/temp - ./data/log:/var/log/clickhouse-server environment: CLICKHOUSE_SERVER_USER: default CLICKHOUSE_SERVER_PASSWORD: 123456 networks: - grafana networks: grafana: 添加数据 登陆数据库 进入到 docker 容器中，然后使用 clickhouse-client 访问数据库"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-27T15:20:30+08:00"><meta property="article:modified_time" content="2023-11-27T15:20:30+08:00"><meta property="article:tag" content="Grafana"><meta property="article:tag" content="ClickHouse"><meta name=twitter:card content="summary"><meta name=twitter:title content="Grafana 使用 ClickHouse 作为数据源配置图表"><meta name=twitter:description content="Grafana 使用 ClickHouse 作为数据源配置图表 ClickHouse 是一种开源的列式数据库管理系统，专注于处理大规模数据分析工作负载。它在处理海量数据时具有高性能、可扩展、灵活的数据模型、支持 SQL 等特性；适用于需要及时分析最新数据的应用场景，如日志分析、事件跟踪等
在应用过程中，使用 ClickHouse 作为数据源，保存服务上报的秒级指标信息，用于 Grafana 查询秒级监控指标
这里使用的 Grafana 版本 v10.1.1, ClickHouse 版本为 23.9.3.12
启动服务并添加数据 启动 ClickHouse 和 Grafana 使用 Docker Compose 启动
version: '3.7' services: grafana: image: grafana/grafana ports: - '3000:3000' volumes: - ./data/grafana:/var/lib/grafana - ./data/plugins/:/var/lib/grafana/plugins - ./data/provisioning:/etc/grafana/provisioning networks: - grafana clickhouse: image: 'clickhouse/clickhouse-server' container_name: 'grafana-clickhouse-server' ports: - '8123:8123' - '9000:9000' volumes: - ./data/data:/var/lib/clickhouse - ./data/temp:/temp - ./data/log:/var/log/clickhouse-server environment: CLICKHOUSE_SERVER_USER: default CLICKHOUSE_SERVER_PASSWORD: 123456 networks: - grafana networks: grafana: 添加数据 登陆数据库 进入到 docker 容器中，然后使用 clickhouse-client 访问数据库"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Grafana 使用 ClickHouse 作为数据源配置图表","item":"https://blog.hellowood.dev/posts/grafana%E4%BD%BF%E7%94%A8clickhouse%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E5%9B%BE%E8%A1%A8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Grafana 使用 ClickHouse 作为数据源配置图表","name":"Grafana 使用 ClickHouse 作为数据源配置图表","description":"Grafana 使用 ClickHouse 作为数据源配置图表 ClickHouse 是一种开源的列式数据库管理系统，专注于处理大规模数据分析工作负载。它在处理海量数据时具有高性能、可扩展、灵活的数据模型、支持 SQL 等特性；适用于需要及时分析最新数据的应用场景，如日志分析、事件跟踪等\n在应用过程中，使用 ClickHouse 作为数据源，保存服务上报的秒级指标信息，用于 Grafana 查询秒级监控指标\n这里使用的 Grafana 版本 v10.1.1, ClickHouse 版本为 23.9.3.12\n启动服务并添加数据 启动 ClickHouse 和 Grafana 使用 Docker Compose 启动\nversion: \u0026#39;3.7\u0026#39; services: grafana: image: grafana/grafana ports: - \u0026#39;3000:3000\u0026#39; volumes: - ./data/grafana:/var/lib/grafana - ./data/plugins/:/var/lib/grafana/plugins - ./data/provisioning:/etc/grafana/provisioning networks: - grafana clickhouse: image: \u0026#39;clickhouse/clickhouse-server\u0026#39; container_name: \u0026#39;grafana-clickhouse-server\u0026#39; ports: - \u0026#39;8123:8123\u0026#39; - \u0026#39;9000:9000\u0026#39; volumes: - ./data/data:/var/lib/clickhouse - ./data/temp:/temp - ./data/log:/var/log/clickhouse-server environment: CLICKHOUSE_SERVER_USER: default CLICKHOUSE_SERVER_PASSWORD: 123456 networks: - grafana networks: grafana: 添加数据 登陆数据库 进入到 docker 容器中，然后使用 clickhouse-client 访问数据库","keywords":["Grafana","ClickHouse"],"articleBody":"Grafana 使用 ClickHouse 作为数据源配置图表 ClickHouse 是一种开源的列式数据库管理系统，专注于处理大规模数据分析工作负载。它在处理海量数据时具有高性能、可扩展、灵活的数据模型、支持 SQL 等特性；适用于需要及时分析最新数据的应用场景，如日志分析、事件跟踪等\n在应用过程中，使用 ClickHouse 作为数据源，保存服务上报的秒级指标信息，用于 Grafana 查询秒级监控指标\n这里使用的 Grafana 版本 v10.1.1, ClickHouse 版本为 23.9.3.12\n启动服务并添加数据 启动 ClickHouse 和 Grafana 使用 Docker Compose 启动\nversion: '3.7' services: grafana: image: grafana/grafana ports: - '3000:3000' volumes: - ./data/grafana:/var/lib/grafana - ./data/plugins/:/var/lib/grafana/plugins - ./data/provisioning:/etc/grafana/provisioning networks: - grafana clickhouse: image: 'clickhouse/clickhouse-server' container_name: 'grafana-clickhouse-server' ports: - '8123:8123' - '9000:9000' volumes: - ./data/data:/var/lib/clickhouse - ./data/temp:/temp - ./data/log:/var/log/clickhouse-server environment: CLICKHOUSE_SERVER_USER: default CLICKHOUSE_SERVER_PASSWORD: 123456 networks: - grafana networks: grafana: 添加数据 登陆数据库 进入到 docker 容器中，然后使用 clickhouse-client 访问数据库\ndocker exec -it clickhouse bash clickhouse-client ClickHouse client version 23.10.5.20 (official build). Connecting to localhost:9000 as user default. Connected to ClickHouse server version 23.10.5 revision 54466. Warnings: * Linux transparent hugepages are set to \"always\". Check /sys/kernel/mm/transparent_hugepage/enabled clickhouse :) 创建测试数据库 CREATE DATABASE IF NOT EXISTS metrics 创建测试表 CREATE TABLE IF NOT EXISTS metrics.request_history ( `id` UUID DEFAULT generateUUIDv4(), `application` LowCardinality(String), `env` LowCardinality(String), `hostname` LowCardinality(String), `uri` String, `add_time` DateTime64(3) CODEC(DoubleDelta, LZ4) ) ENGINE = MergeTree PARTITION BY toDate(add_time) ORDER BY (application, env, hostname, uri) TTL toDate(add_time) + 30; 插入随机数据 INSERT INTO metrics.request_history(application, env, hostname, uri) VALUES('app1', 'prod', 'hostname1', '/api/user'); //... 配置 Grafana 安装 ClickHouse 插件 在 Grafana 面板 Connections -\u003e Add new connection 中添加 ClickHouse 插件\nClickHouse 有两个插件，分别是 Grafana 官方提供的 ClickHouse 和社区提供的 Altinity plugin for ClickHouse；\n官方的 ClickHouse 仅支持 Grafana \u003e=9.0.0 的版本使用，Altinity plugin for ClickHouse 支持 Grafana 4.6 之后的版本\n这两个插件在用法和交互上有所差异，这里使用官方的 ClickHouse 进行查询\n配置数据源 在 Grafana 面板 Connections -\u003e Data sources 中添加 ClickHouse 数据源\n配置图表 选择新增图表，并选择 ClickHouse 作为数据源\n配置 table 图表 创建 Table 图表直接使用 SQL 查询需要的列即可\nSELECT env, hostname, uri, value FROM metrics.request_history ORDER BY add_time LIMIT 10 配置时间序列的图表 时间序列的图表需要至少有三列，分别是时间、名称、值；此时列需要聚合\nSELECT toDateTime64(add_time, 0) as time , uri as label, sum(value) as value FROM metrics.request_history GROUP BY label, time ORDER BY time 配置查询条件 ClickHouse 插件支持多个宏(Macro)，在向 ClickHouse 发送查询前会将 Macro 替换为对应的值\n时间范围查询条件 使用 $__timeFilter() 作为时间范围的查询条件，使用的字段是指定的 DateTime 或 Timestamp 对应的列，如 where $__timeFilter(add_time) 会被替换为 where add_time \u003e= xxx and add_time \u003c= xxx\nSELECT toDateTime64(add_time, 0) as time , uri as label, sum(value) as value FROM metrics.request_history WHERE $__timeFilter(add_time) GROUP BY label, time ORDER BY time 最终查询的 SQL 为:\nSELECT toDateTime64(add_time, 0) as time , uri as label, sum(value) as value FROM metrics.request_history WHERE add_time \u003e= '1699940462' AND add_time \u003c= '1699962062' GROUP BY label, time ORDER BY time 使用变量作为查询条件 添加变量 变量的定义和 Prometheus 数据源类似，不过是使用 SQL 查询，如配置 env，使用选中的时间范围进行查询； 因为 add_time 类型是 DateTime，所以需要将当前的时间范围转为秒级的时间戳，然后使用 toDateTime 转为 DateTime 进行比较\nSELECT distinct(toString(env)) FROM metrics.request_history WHERE add_time BETWEEN toDateTime(${__from:date:seconds}) AND toDateTime(${__to:date:seconds}) 依赖其他变量进行查询，添加到查询条件即可，使用 singlequote添加引号，避免查询语法错误\nSELECT distinct(toString(application)) FROM `logs`.`red_sentinel_metrics` WHERE env in (${env:singlequote}) AND ActionDate BETWEEN toDateTime(${__from:date:seconds}) AND toDateTime(${__to:date:seconds}) 添加动态查询条件 动态查询条件使用 $__conditionalAll 进行查询；\n$__conditionalAll 接收两个参数，第一个参数是 SQL predicate，第二个参数是 $variable，当 $variable 不为空的时候会将 SQL predicate 作为查询条件添加到 SQL 中，如果是空或者是 ALL 则会添加 1=1，\n如 AND $__conditionalAll(uri in ('${uri:singlequote}'), '${uri:singlequote}')，如果 uri 不为空，则会将 AND uri in (xxx) 作为查询条件；如果 uri 为空则是 AND 1=1\nSELECT toDateTime64(add_time, 0) as time, uri as label, sum(value) as value FROM metrics.request_history WHERE $__timeFilter(add_time) AND $__conditionalAll(uri in ('${uri:singlequote}'), '${uri:singlequote}') GROUP BY label,time ORDER BY time 最终 SQL 为：\nSELECT add_time as time, uri as label, sum(value) as value FROM metrics.request_history WHERE add_time \u003e= '1699861790' AND add_time \u003c= '1699883390' AND uri in ('/api/user') GROUP BY label,time ORDER BY time 聚合 可以用 $__conditionalAll 进行聚合，或者将要聚合的字段拼接为一个字段\n官方的 ClickHouse 对聚合支持不够完善，$__conditionalAll 如果是空会被替换为 1=1，会导致语法错误，如果不为空，则字段是固定存在的，事实上并不动态；而 Altinity plugin for ClickHouse 插件的 $conditionalTest 为空时不做任何拼接更能满足动态聚合的场景\n用 conditionalAll 注意，这种场景下 uri 变量必须要有值，否则会出现 GROUP BY 1=1 这样的错误语法\nSELECT $__timeInterval(add_time) as time, uri as label, sum(value) as value FROM metrics.request_history WHERE $__timeFilter(add_time) AND $__conditionalAll(uri in (${uri:singlequote}), ${uri:singlequote}) GROUP BY $__conditionalAll(uri, ${uri:singlequote}), $__conditionalAll(hostname, ${hostname:singlequote}), time ORDER BY time 最终查询为:\nSELECT toDateTime64(add_time, 0) as time, uri as label, sum(value) as value FROM metrics.request_history WHERE add_time \u003e= '1699944714' AND add_time \u003c= '1699966314' AND uri in ('/status','/actuator/health') GROUP BY uri, hostname, time ORDER BY time 用字段拼接 拼接后的字段用于做聚合，适用于固定的聚合字段\nSELECT toDateTime64(add_time, 0) as time, concat(application, ': ', uri) as label, sum(value) as value FROM metrics.request_history WHERE $__timeFilter(add_time) AND $__conditionalAll(uri in (${uri:singlequote}), ${uri:singlequote}) GROUP BY label, time ORDER BY time 最终查询为：\nSELECT toDateTime64(add_time, 0) as time, concat(application, ': ', uri) as label, sum(value) as value FROM metrics.request_history WHERE add_time \u003e= '1699944327' AND add_time \u003c= '1699965927' AND uri in ('/status','/actuator/health') GROUP BY label, time ORDER BY time ","wordCount":"655","inLanguage":"en","datePublished":"2023-11-27T15:20:30+08:00","dateModified":"2023-11-27T15:20:30+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/grafana%E4%BD%BF%E7%94%A8clickhouse%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E5%9B%BE%E8%A1%A8/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script defer src=https://analytics.us.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Grafana 使用 ClickHouse 作为数据源配置图表</h1></header><p><small>November 27, 2023&nbsp;· 655 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#启动服务并添加数据>启动服务并添加数据</a><ul><li><a href=#启动-clickhouse-和-grafana>启动 ClickHouse 和 Grafana</a></li><li><a href=#添加数据>添加数据</a></li></ul></li><li><a href=#配置-grafana>配置 Grafana</a><ul><li><a href=#安装-clickhouse-插件>安装 ClickHouse 插件</a></li><li><a href=#配置数据源>配置数据源</a></li></ul></li><li><a href=#配置图表>配置图表</a><ul><li><a href=#配置-table-图表>配置 table 图表</a></li><li><a href=#配置时间序列的图表>配置时间序列的图表</a></li></ul></li><li><a href=#配置查询条件>配置查询条件</a><ul><li><a href=#时间范围查询条件>时间范围查询条件</a></li><li><a href=#使用变量作为查询条件>使用变量作为查询条件</a></li><li><a href=#聚合>聚合</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=grafana-使用-clickhouse-作为数据源配置图表>Grafana 使用 ClickHouse 作为数据源配置图表</h1><p>ClickHouse 是一种开源的列式数据库管理系统，专注于处理大规模数据分析工作负载。它在处理海量数据时具有高性能、可扩展、灵活的数据模型、支持 SQL 等特性；适用于需要及时分析最新数据的应用场景，如日志分析、事件跟踪等</p><p>在应用过程中，使用 ClickHouse 作为数据源，保存服务上报的秒级指标信息，用于 Grafana 查询秒级监控指标</p><blockquote><p>这里使用的 Grafana 版本 v10.1.1, ClickHouse 版本为 23.9.3.12</p></blockquote><h2 id=启动服务并添加数据>启动服务并添加数据</h2><h3 id=启动-clickhouse-和-grafana>启动 ClickHouse 和 Grafana</h3><p>使用 Docker Compose 启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.7&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>grafana</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/grafana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;3000:3000&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/grafana:/var/lib/grafana</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/plugins/:/var/lib/grafana/plugins</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/provisioning:/etc/grafana/provisioning</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>grafana</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clickhouse</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;clickhouse/clickhouse-server&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#39;grafana-clickhouse-server&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;8123:8123&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;9000:9000&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/data:/var/lib/clickhouse</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/temp:/temp</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/log:/var/log/clickhouse-server</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>CLICKHOUSE_SERVER_USER</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>CLICKHOUSE_SERVER_PASSWORD</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>grafana</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>grafana</span>: 
</span></span></code></pre></div><h3 id=添加数据>添加数据</h3><ul><li>登陆数据库</li></ul><p>进入到 docker 容器中，然后使用 <code>clickhouse-client</code> 访问数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it clickhouse bash
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>clickhouse-client
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ClickHouse client version 23.10.5.20 <span style=color:#f92672>(</span>official build<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Connecting to localhost:9000 as user default.
</span></span><span style=display:flex><span>Connected to ClickHouse server version 23.10.5 revision 54466.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Warnings:
</span></span><span style=display:flex><span> * Linux transparent hugepages are set to <span style=color:#e6db74>&#34;always&#34;</span>. Check /sys/kernel/mm/transparent_hugepage/enabled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>clickhouse :<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>创建测试数据库</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> metrics
</span></span></code></pre></div><ul><li>创建测试表</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> metrics.request_history
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> UUID <span style=color:#66d9ef>DEFAULT</span> generateUUIDv4(),
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>application<span style=color:#f92672>`</span> LowCardinality(String),
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>env<span style=color:#f92672>`</span> LowCardinality(String),
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>hostname<span style=color:#f92672>`</span> LowCardinality(String),
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>uri<span style=color:#f92672>`</span> String,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>add_time<span style=color:#f92672>`</span> DateTime64(<span style=color:#ae81ff>3</span>) CODEC(DoubleDelta, LZ4)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>ENGINE <span style=color:#f92672>=</span> MergeTree
</span></span><span style=display:flex><span>PARTITION <span style=color:#66d9ef>BY</span> toDate(add_time)
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> (application, env, hostname, uri)
</span></span><span style=display:flex><span>TTL toDate(add_time) <span style=color:#f92672>+</span> <span style=color:#ae81ff>30</span>;
</span></span></code></pre></div><ul><li>插入随机数据</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> metrics.request_history(application, env, hostname, uri) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;app1&#39;</span>, <span style=color:#e6db74>&#39;prod&#39;</span>, <span style=color:#e6db74>&#39;hostname1&#39;</span>, <span style=color:#e6db74>&#39;/api/user&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#f92672>//</span>...
</span></span></code></pre></div><h2 id=配置-grafana>配置 Grafana</h2><h3 id=安装-clickhouse-插件>安装 ClickHouse 插件</h3><p>在 Grafana 面板 Connections -> Add new connection 中添加 ClickHouse 插件</p><p>ClickHouse 有两个插件，分别是 Grafana 官方提供的 <a href=https://github.com/grafana/clickhouse-datasource>ClickHouse</a>
和社区提供的 <a href=https://github.com/Altinity/clickhouse-grafana>Altinity plugin for ClickHouse</a>；</p><p>官方的 ClickHouse 仅支持 Grafana >=9.0.0 的版本使用，Altinity plugin for ClickHouse 支持 Grafana 4.6 之后的版本</p><p>这两个插件在用法和交互上有所差异，这里使用官方的 ClickHouse 进行查询</p><p><img alt=grafana-clickhouse-add-datasource.png src=https://img.hellowood.dev/picture/grafana-clickhouse-add-datasource.png></p><h3 id=配置数据源>配置数据源</h3><p>在 Grafana 面板 Connections -> Data sources 中添加 ClickHouse 数据源</p><h2 id=配置图表>配置图表</h2><p>选择新增图表，并选择 ClickHouse 作为数据源</p><h3 id=配置-table-图表>配置 table 图表</h3><p>创建 Table 图表直接使用 SQL 查询需要的列即可</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>  env, 
</span></span><span style=display:flex><span>        hostname,
</span></span><span style=display:flex><span>        uri,
</span></span><span style=display:flex><span>        value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> add_time 
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><h3 id=配置时间序列的图表>配置时间序列的图表</h3><p>时间序列的图表需要至少有三列，分别是时间、名称、值；此时列需要聚合</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>  toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time , 
</span></span><span style=display:flex><span>        uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> label, time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><h2 id=配置查询条件>配置查询条件</h2><p>ClickHouse 插件支持多个宏(Macro)，在向 ClickHouse 发送查询前会将 Macro 替换为对应的值</p><h3 id=时间范围查询条件>时间范围查询条件</h3><p>使用 <code>$__timeFilter()</code> 作为时间范围的查询条件，使用的字段是指定的 DateTime 或 Timestamp
对应的列，如 <code>where $__timeFilter(add_time)</code> 会被替换为 <code>where add_time >= xxx and add_time &lt;= xxx</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>  toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time , 
</span></span><span style=display:flex><span>        uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>$</span>__timeFilter(add_time)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> label, time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><p>最终查询的 SQL 为:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>  toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time , 
</span></span><span style=display:flex><span>        uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> add_time <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;1699940462&#39;</span> <span style=color:#66d9ef>AND</span> add_time <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;1699962062&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> label, time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><h3 id=使用变量作为查询条件>使用变量作为查询条件</h3><ul><li>添加变量</li></ul><p>变量的定义和 Prometheus 数据源类似，不过是使用 SQL 查询，如配置 env，使用选中的时间范围进行查询；
因为 <code>add_time</code> 类型是 <code>DateTime</code>，所以需要将当前的时间范围转为秒级的时间戳，然后使用 <code>toDateTime</code> 转为 <code>DateTime</code> 进行比较</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>  <span style=color:#66d9ef>distinct</span>(toString(env))
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> add_time <span style=color:#66d9ef>BETWEEN</span> toDateTime(<span style=color:#960050;background-color:#1e0010>${</span>__from:date:seconds<span style=color:#960050;background-color:#1e0010>}</span>) <span style=color:#66d9ef>AND</span> toDateTime(<span style=color:#960050;background-color:#1e0010>${</span>__to:date:seconds<span style=color:#960050;background-color:#1e0010>}</span>) 
</span></span></code></pre></div><p>依赖其他变量进行查询，添加到查询条件即可，使用 <code>singlequote</code>添加引号，避免查询语法错误</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>  <span style=color:#66d9ef>distinct</span>(toString(application))
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>logs<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>red_sentinel_metrics<span style=color:#f92672>`</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> env <span style=color:#66d9ef>in</span> (<span style=color:#960050;background-color:#1e0010>${</span>env:singlequote<span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> ActionDate <span style=color:#66d9ef>BETWEEN</span> toDateTime(<span style=color:#960050;background-color:#1e0010>${</span>__from:date:seconds<span style=color:#960050;background-color:#1e0010>}</span>) <span style=color:#66d9ef>AND</span> toDateTime(<span style=color:#960050;background-color:#1e0010>${</span>__to:date:seconds<span style=color:#960050;background-color:#1e0010>}</span>) 
</span></span></code></pre></div><ul><li>添加动态查询条件</li></ul><p>动态查询条件使用 <code>$__conditionalAll</code> 进行查询；</p><p><code>$__conditionalAll</code> 接收两个参数，第一个参数是 <code>SQL predicate</code>，第二个参数是 <code>$variable</code>，当 <code>$variable</code> 不为空的时候会将 <code>SQL predicate</code> 作为查询条件添加到 SQL 中，如果是空或者是 ALL 则会添加 <code>1=1</code>，</p><p>如 <code>AND $__conditionalAll(uri in ('${uri:singlequote}'), '${uri:singlequote}')</code>，如果 uri 不为空，则会将 <code>AND uri in (xxx)</code> 作为查询条件；如果 uri 为空则是 <code>AND 1=1</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time,
</span></span><span style=display:flex><span>       uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>$</span>__timeFilter(add_time)
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>$</span>__conditionalAll(uri <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;${uri:singlequote}&#39;</span>), <span style=color:#e6db74>&#39;${uri:singlequote}&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>  label,time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><p>最终 SQL 为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> add_time <span style=color:#66d9ef>as</span> time,
</span></span><span style=display:flex><span>       uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> add_time <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;1699861790&#39;</span> <span style=color:#66d9ef>AND</span> add_time <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;1699883390&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span>  uri <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;/api/user&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>  label,time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><h3 id=聚合>聚合</h3><p>可以用 <code>$__conditionalAll</code> 进行聚合，或者将要聚合的字段拼接为一个字段</p><p>官方的 ClickHouse 对聚合支持不够完善，<code>$__conditionalAll</code> 如果是空会被替换为 <code>1=1</code>，会导致语法错误，如果不为空，则字段是固定存在的，事实上并不动态；而 Altinity plugin for ClickHouse 插件的 <code>$conditionalTest</code> 为空时不做任何拼接更能满足动态聚合的场景</p><ul><li>用 conditionalAll</li></ul><p>注意，这种场景下 uri 变量必须要有值，否则会出现 <code>GROUP BY 1=1</code> 这样的错误语法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>$</span>__timeInterval(add_time) <span style=color:#66d9ef>as</span> time,
</span></span><span style=display:flex><span>       uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>$</span>__timeFilter(add_time)
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>$</span>__conditionalAll(uri <span style=color:#66d9ef>in</span> (<span style=color:#960050;background-color:#1e0010>${</span>uri:singlequote<span style=color:#960050;background-color:#1e0010>}</span>), <span style=color:#960050;background-color:#1e0010>${</span>uri:singlequote<span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>  <span style=color:#960050;background-color:#1e0010>$</span>__conditionalAll(uri, <span style=color:#960050;background-color:#1e0010>${</span>uri:singlequote<span style=color:#960050;background-color:#1e0010>}</span>), <span style=color:#960050;background-color:#1e0010>$</span>__conditionalAll(hostname, <span style=color:#960050;background-color:#1e0010>${</span>hostname:singlequote<span style=color:#960050;background-color:#1e0010>}</span>), time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><p>最终查询为:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time,
</span></span><span style=display:flex><span>       uri <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> add_time <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;1699944714&#39;</span> <span style=color:#66d9ef>AND</span> add_time <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;1699966314&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> uri <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;/status&#39;</span>,<span style=color:#e6db74>&#39;/actuator/health&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>  uri, hostname, time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><ul><li>用字段拼接</li></ul><p>拼接后的字段用于做聚合，适用于固定的聚合字段</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time,
</span></span><span style=display:flex><span>       concat(application, <span style=color:#e6db74>&#39;: &#39;</span>, uri) <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>$</span>__timeFilter(add_time)
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>$</span>__conditionalAll(uri <span style=color:#66d9ef>in</span> (<span style=color:#960050;background-color:#1e0010>${</span>uri:singlequote<span style=color:#960050;background-color:#1e0010>}</span>), <span style=color:#960050;background-color:#1e0010>${</span>uri:singlequote<span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> label, time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div><p>最终查询为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> toDateTime64(add_time, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> time,
</span></span><span style=display:flex><span>       concat(application, <span style=color:#e6db74>&#39;: &#39;</span>, uri) <span style=color:#66d9ef>as</span> label, 
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>sum</span>(value) <span style=color:#66d9ef>as</span> value
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> metrics.request_history
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> add_time <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;1699944327&#39;</span> <span style=color:#66d9ef>AND</span> add_time <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;1699965927&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> uri <span style=color:#66d9ef>in</span> (<span style=color:#e6db74>&#39;/status&#39;</span>,<span style=color:#e6db74>&#39;/actuator/health&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> label, time
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> time
</span></span></code></pre></div></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E9%98%BF%E5%B0%94%E5%8D%A1%E7%89%B9%E7%8C%AB%E6%A3%92%E6%9B%BF%E6%8D%A2%E5%8C%97%E4%BA%AC%E7%A7%BB%E5%8A%A8-gpon-%E5%85%89%E7%8C%AB/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>使用阿尔卡特猫棒替换北京移动 GPON 光猫</span></a>
<a class=next href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8golinks%E7%9F%AD%E9%93%BE%E6%8E%A5%E6%9C%8D%E5%8A%A1%E7%AE%80%E5%8C%96%E7%BD%91%E5%9D%80%E8%AE%BF%E9%97%AE/><span>使用 GoLinks 短链接服务简化网址访问</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=related-resources></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>