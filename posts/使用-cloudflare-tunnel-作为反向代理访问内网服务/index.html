<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>使用 Cloudflare Tunnel 作为反向代理访问内网服务</title>
<meta name=description content="Cloudflare Tunnel 是一款隧道软件，可以理解为反向代理；可以快速安全地加密应用程序到任何类型基础设施的流量，如 TCP/HTTP/SSH 等，同时能够隐藏 web 服务器 IP 地址，阻止直接攻击，适用于没有公网 IP，但是又需要从公网访问内网部署的服务；详细可以参考官方文档：Cloudflare …"><meta name=keywords content='blog,hugo,HomeLab,Cloudflare'><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-tunnel-%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1/"><meta property="og:type" content="website"><meta property="og:title" content="使用 Cloudflare Tunnel 作为反向代理访问内网服务"><meta property="og:description" content="Cloudflare Tunnel 是一款隧道软件，可以理解为反向代理；可以快速安全地加密应用程序到任何类型基础设施的流量，如 TCP/HTTP/SSH 等，同时能够隐藏 web 服务器 IP 地址，阻止直接攻击，适用于没有公网 IP，但是又需要从公网访问内网部署的服务；详细可以参考官方文档：Cloudflare …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="使用 Cloudflare Tunnel 作为反向代理访问内网服务"><meta name=twitter:description content="Cloudflare Tunnel 是一款隧道软件，可以理解为反向代理；可以快速安全地加密应用程序到任何类型基础设施的流量，如 TCP/HTTP/SSH 等，同时能够隐藏 web 服务器 IP 地址，阻止直接攻击，适用于没有公网 IP，但是又需要从公网访问内网部署的服务；详细可以参考官方文档：Cloudflare …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-tunnel-%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-tunnel-%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-tunnel-%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>使用 Cloudflare Tunnel 作为反向代理访问内网服务</h1><small role=doc-subtitle></small><p class=post-date>2024-12-12</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/cloudflare>Cloudflare</a></li></ul></div><div class=post-content><p>Cloudflare Tunnel 是一款隧道软件，可以理解为反向代理；可以快速安全地加密应用程序到任何类型基础设施的流量，如 TCP/HTTP/SSH 等，同时能够隐藏 web 服务器 IP 地址，阻止直接攻击，适用于没有公网 IP，但是又需要从公网访问内网部署的服务；详细可以参考官方文档：<a href=https://www.cloudflare.com/zh-cn/products/tunnel/>Cloudflare Tunnel</a></p><p>在 Linux 服务器上安装为例，对外提供 whoami 的 web 程序</p><h2 id=创建-tunnel>创建 Tunnel</h2><p>Tunnel 支持在线和本地两种配置方式；在线维护方式添加、修改比较方便，推荐使用在线的方式进行配置；</p><p>在 Zero Trust => Network => Tunnels 中选择创建 Tunnel</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-tunnel-init-create-tunnel.png alt=homelab-cloudflare-tunnel-init-create-tunnel.png></p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-tunnel-init-name-tunnel.png alt=homelab-cloudflare-tunnel-init-name-tunnel.png></p><h2 id=安装配置-cloudflare-tunnel>安装配置 Cloudflare Tunnel</h2><p>Tunnel 支持二进制包或者 Docker 容器的方式进行安装；选择相应的平台，会生成安装命令，在命令后执行该命令即可</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-tunnel-init-install.png alt=homelab-cloudflare-tunnel-init-install.png></p><p>如果没有对应的平台，可以在 <a href=https://github.com/cloudflare/cloudflared/releases>GitHub 仓库</a>下载对应的版本，然后进行安装；以 Ubuntu 22 为例：</p><ul><li>下载最新的 Cloudflared</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
</span></span></code></pre></div><ul><li>安装</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dpkg -i cloudflared-linux-amd64.deb
</span></span></code></pre></div><ul><li>创建 Cloudflared 服务</li></ul><p>这样会创建并自动启动 Cloudflared 服务</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cloudflared service install <span style=color:#98c379>${</span><span style=color:#dcaeea>TOKEN</span><span style=color:#98c379>}</span>
</span></span></code></pre></div><h2 id=配置路由规则>配置路由规则</h2><p>路由规则支持在本地或者 Cloudflare 平台配置两种方式，建议在 Cloudflare 平台配置，更加灵活</p><ul><li>启动服务</li></ul><p>在本地启动一个 whoami 服务，对外暴露 8080 端口提供 web 服务；使用 docker-compose 方式启动</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>whoami</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#63c381>&#34;traefik/whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>whoami</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>whoami</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8080:80&#34;</span>
</span></span></code></pre></div><ul><li>配置路由规则</li></ul><p>点击对应的 Tunnel，选择 edit => Public Hostname => Add a public hostname 添加新的路由规则，将域名 whoami.homelab.dev 的请求转发到 <a href=192.168.31.254:8080>192.168.31.254:8080</a> 这个地址，服务类型为 HTTP</p><p>这样配置之后服务是向公网开放的，如果想要通过权限控制，仅允许特定用户或者 IP 访问，可以参考 <a href=https://blog.hellowood.dev/posts/Cloudflare-Tunnel-%E9%85%8D%E7%BD%AE%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E4%BF%9D%E6%8A%A4%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE/>Cloudflare-Tunnel-配置权限控制保护服务安全访问</a></p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-tunnel-init-router-config.png alt=homelab-cloudflare-tunnel-init-router-config.png></p><ul><li>访问路由</li></ul><p>配置完成之后访问对应的路由即可返回相关的信息</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://whoami.homelab.dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hostname: whoami
</span></span><span style=display:flex><span>IP: 127.0.0.1
</span></span><span style=display:flex><span>RemoteAddr: 172.24.0.1:38002
</span></span><span style=display:flex><span>GET / HTTP/1.1
</span></span><span style=display:flex><span>Host: whoami.homelab.dev
</span></span><span style=display:flex><span>User-Agent: curl/8.5.0
</span></span><span style=display:flex><span>Accept: */*
</span></span><span style=display:flex><span>Accept-Encoding: gzip, br
</span></span><span style=display:flex><span>Cdn-Loop: cloudflare; <span style=color:#dcaeea>loops</span><span style=color:#c7bf54>=</span><span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span>Cf-Connecting-Ip: 1.1.1.1
</span></span><span style=display:flex><span>Cf-Visitor: <span style=color:#c7bf54>{</span><span style=color:#63c381>&#34;scheme&#34;</span>:<span style=color:#63c381>&#34;https&#34;</span><span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>Cf-Warp-Tag-Id: 653af42c-aaaa-bbbb-cccc-dddddeee1234
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>X-Forwarded-For: 1.1.1.1
</span></span><span style=display:flex><span>X-Forwarded-Host: whoami.homelab.dev
</span></span><span style=display:flex><span>X-Forwarded-Proto: https
</span></span></code></pre></div><h2 id=修改配置>修改配置</h2><p>Cloudflared 默认的配置在国内不一定适用，可以通过修改 Cloudflared 服务配置进行指定</p><p>自动生成的 Service 配置文件是 <code>/etc/systemd/system/cloudflared.service</code>，编辑该文件添加配置即可；按需添加以下配置：</p><ul><li><code>--loglevel info</code>：指定日志级别</li><li><code>--logfile /var/log/cloudflared-tunnel.log</code>：日志输出文件</li><li><code>--metrics 0.0.0.0:19991</code>：允许暴露指标，用于监控运行信息</li><li><code>--edge-ip-version 4</code>：使用 IPv4 连接边缘节点(如果有 IPv6建议使用 IPv6)</li><li><code>--protocol http2</code>：连接协议使用 http2，默认的 quic 协议在国内丢包严重</li></ul><pre tabindex=0><code class=language-conf data-lang=conf>[Unit]
Description=cloudflared
After=network.target

[Service]
TimeoutStartSec=0
Type=notify
ExecStart=/usr/bin/cloudflared --no-autoupdate tunnel --loglevel info --logfile /var/log/cloudflared-tunnel.log --metrics 0.0.0.0:19991 --edge-ip-version 6 --protocol http2 run --token ${TOKEN}
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
</code></pre><ul><li>重载配置并重启服务</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart cloudflared
</span></span></code></pre></div><ul><li>查看服务状态</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status cloudflared
</span></span></code></pre></div><p>服务正确运行</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>● cloudflared.service - cloudflared
</span></span><span style=display:flex><span>     Loaded: loaded <span style=color:#c7bf54>(</span>/etc/systemd/system/cloudflared.service; enabled; vendor preset: enabled<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>     Active: active <span style=color:#c7bf54>(</span>running<span style=color:#c7bf54>)</span> since Tue 2024-02-27 22:44:53 CST; 43min ago
</span></span><span style=display:flex><span>   Main PID: <span style=color:#d19a66>111</span> <span style=color:#c7bf54>(</span>cloudflared<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>      Tasks: <span style=color:#d19a66>9</span> <span style=color:#c7bf54>(</span>limit: 38155<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>     Memory: 43.7M
</span></span><span style=display:flex><span>        CPU: 8.539s
</span></span><span style=display:flex><span>     CGroup: /system.slice/cloudflared.service
</span></span><span style=display:flex><span>             └─111 /usr/bin/cloudflared --no-autoupdate tunnel --loglevel info --metrics 0.0.0.0:19991 --edge-ip-version <span style=color:#d19a66>6</span> --protocol auto run --token <span style=color:#98c379>${</span><span style=color:#dcaeea>TOKEN</span><span style=color:#98c379>}</span>
</span></span></code></pre></div><p>Cloudflare 默认和边缘节点的数据中心建立 4 个连接，但是边缘节点都在美国，使用 IPv4 连接边缘节点在国内高峰期基本是无法使用的；如下是使用 IPv4 和 IPv6 连接时有效连接的边缘节点数量，因此强烈建议使用 IPv6</p><p><img src=https://img.hellowood.dev/picture/homelab-cloudflare-tunnel-metrics-ipv4-and-ipv6-compare.png alt=homelab-cloudflare-tunnel-metrics-ipv4-and-ipv6-compare.png></p><h2 id=参考文档>参考文档</h2><ul><li><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/>Cloudflare Tunnel</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>