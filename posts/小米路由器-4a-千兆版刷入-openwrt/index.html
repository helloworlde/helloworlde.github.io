<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>小米路由器 4A 千兆版刷入 OpenWrt</title>
<meta name=description content="因为买了新的路由器，之前的小米 4A 千兆版被淘汰下来了，因此想刷个 OpenWrt 测试一下
依赖 电脑 Win/Mac/Linux，需要支持网线连接，如果是 Mac，需要一个网线转接器 小米路由器 4A 千兆版 Python3 环境 网线 开启路由器 SSH 需要先开启路由器的 SSH， …"><meta name=keywords content='blog,hugo,MiWiFi,Router,HomeLab,OpenWrt'><meta property="og:url" content="https://blog.hellowood.dev/posts/%E5%B0%8F%E7%B1%B3%E8%B7%AF%E7%94%B1%E5%99%A8-4a-%E5%8D%83%E5%85%86%E7%89%88%E5%88%B7%E5%85%A5-openwrt/"><meta property="og:type" content="website"><meta property="og:title" content="小米路由器 4A 千兆版刷入 OpenWrt"><meta property="og:description" content="因为买了新的路由器，之前的小米 4A 千兆版被淘汰下来了，因此想刷个 OpenWrt 测试一下
依赖 电脑 Win/Mac/Linux，需要支持网线连接，如果是 Mac，需要一个网线转接器 小米路由器 4A 千兆版 Python3 环境 网线 开启路由器 SSH 需要先开启路由器的 SSH， …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/%E5%B0%8F%E7%B1%B3%E8%B7%AF%E7%94%B1%E5%99%A8-4a-%E5%8D%83%E5%85%86%E7%89%88%E5%88%B7%E5%85%A5-openwrt/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>小米路由器 4A 千兆版刷入 OpenWrt</h1><small role=doc-subtitle></small><p class=post-date>2023-08-08
| Updated 2024-09-09</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/miwifi>MiWiFi</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/router>Router</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/openwrt>OpenWrt</a></li></ul></div><div class=post-content><p>因为买了新的路由器，之前的小米 4A 千兆版被淘汰下来了，因此想刷个 OpenWrt 测试一下</p><h2 id=依赖>依赖</h2><ul><li>电脑 Win/Mac/Linux，需要支持网线连接，如果是 Mac，需要一个网线转接器</li><li>小米路由器 4A 千兆版</li><li>Python3 环境</li><li>网线</li></ul><h2 id=开启路由器-ssh>开启路由器 SSH</h2><p>需要先开启路由器的 SSH，小米的固件只有开发版支持 SSH，但是现在所有的版本基本都不会放出开发版；所以只能通过破解的方式开启(开启后不支持保修)；</p><p>因为小米路由器系统存在 <a href=https://nvd.nist.gov/vuln/detail/CVE-2019-18370>CVE-2019-18370</a> 漏洞，所以可以通过该漏洞开启 SSH；需要使用项目 <a href=https://github.com/acecilia/OpenWRTInvasion>acecilia/OpenWRTInvasion</a> 提供的脚本</p><ul><li>下载 <a href=https://github.com/acecilia/OpenWRTInvasion>acecilia/OpenWRTInvasion</a> ，并安装依赖</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/acecilia/OpenWRTInvasion.git
</span></span><span style=display:flex><span><span style=color:#ef8383>cd</span> OpenWRTInvasion
</span></span><span style=display:flex><span>pip3 install -r requirements.txt
</span></span></code></pre></div><ul><li>执行脚本</li></ul><p>通过 WiFi 或有线的方式连接到路由器，然后进入命令行，执行以下命令，运行 <code>remote_command_execution_vulnerability.py</code> 脚本；执行脚本时需要输入路由器的地址和后台访问密码；地址如果没有改动默认就是 <code>192.168.31.1</code>，或者访问 <code>miwifi.com</code>也可以直接访问到；如果选择了离线模式，会在本地启动一个 ftp server</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 remote_command_execution_vulnerability.py
</span></span></code></pre></div><p>在执行结束后，会输出提示信息，用于通过 SSH 访问路由器</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>here two options to provide the files needed <span style=color:#c678dd>for</span> invasion:
</span></span><span style=display:flex><span>1. Use a <span style=color:#ef8383>local</span> TCP file server runing on random port to provide files in <span style=color:#ef8383>local</span> directory <span style=color:#98c379>`</span>script_tools<span style=color:#98c379>`</span>.
</span></span><span style=display:flex><span>2. Download needed files from remote github repository. <span style=color:#c7bf54>(</span>choose this option only <span style=color:#c678dd>if</span> github is accessable inside router device.<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>Which option <span style=color:#c678dd>do</span> you prefer? <span style=color:#c7bf54>(</span>default: 1<span style=color:#c7bf54>)</span><span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span>****************
</span></span><span style=display:flex><span>router_ip_address: miwifi.com
</span></span><span style=display:flex><span>stok: f19c778f7bc6fbe92cc70a6c6bd2bd4f
</span></span><span style=display:flex><span>file provider: <span style=color:#ef8383>local</span> file server
</span></span><span style=display:flex><span>****************
</span></span><span style=display:flex><span>start uploading config file...
</span></span><span style=display:flex><span>start <span style=color:#ef8383>exec</span> command...
</span></span><span style=display:flex><span><span style=color:#ef8383>local</span> file server is runing on 0.0.0.0:57165. <span style=color:#dcaeea>root</span><span style=color:#c7bf54>=</span><span style=color:#98c379>&#39;script_tools&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ef8383>local</span> file server is getting <span style=color:#98c379>&#39;busybox-mipsel&#39;</span> <span style=color:#c678dd>for</span> 192.168.31.1.
</span></span><span style=display:flex><span><span style=color:#ef8383>local</span> file server is getting <span style=color:#98c379>&#39;dropbearStaticMipsel.tar.bz2&#39;</span> <span style=color:#c678dd>for</span> 192.168.31.1.
</span></span><span style=display:flex><span><span style=color:#c678dd>done</span>! Now you can connect to the router using several options: <span style=color:#c7bf54>(</span>user: root, password: root<span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>* telnet miwifi.com
</span></span><span style=display:flex><span>* ssh -oKexAlgorithms<span style=color:#c7bf54>=</span>+diffie-hellman-group1-sha1 -c 3des-cbc -o <span style=color:#dcaeea>UserKnownHostsFile</span><span style=color:#c7bf54>=</span>/dev/null root@miwifi.com
</span></span><span style=display:flex><span>* ftp: using a program like cyberduck
</span></span></code></pre></div><ul><li>SSH 访问路由器</li></ul><p>通过指定参数的方式，使用 SSH 访问路由器，用户名密码都是 <code>root</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -oKexAlgorithms<span style=color:#c7bf54>=</span>+diffie-hellman-group1-sha1 -c 3des-cbc -o <span style=color:#dcaeea>UserKnownHostsFile</span><span style=color:#c7bf54>=</span>/dev/null root@miwifi.com
</span></span></code></pre></div><h2 id=刷入-breed>刷入 Breed</h2><p>启用 SSH 之后，就可以刷入 Breed 了；Breed 是由 <a href=https://github.com/hackpascal>HackPascal</a> 开发的 Bootloader（引导装载程序），最大的特点是支持通过访问网页刷机，刷机失败后可以直接重置而不会导致机器变砖</p><ul><li>下载</li></ul><p>小米路由器 4A 使用的 CPU 是 mt7621，可以在 <a href=https://breed.hackpascal.net/breed-mt7621-pbr-m1.bin>https://breed.hackpascal.net/</a> 下载，名称为 <code>breed-mt7621-pbr-m1.bin</code></p><ul><li>上传</li></ul><p>下载 Breed 后，需要通过 FTP 的方式上传到路由器，可以使用 <a href=https://cyberduck.io/download/>Cyberduck</a></p><p>连接地址为路由器的地址，默认是 <code>192.168.31.1</code>，选择上传到 <code>/tmp</code> 目录下（其他目录可能会因为权限导致上传失败）</p><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-upload-brade.png alt=homelab-miwifi-upload-brade.png></p><ul><li>刷入</li></ul><p>通过 SSH 登录路由器，执行以下命令，刷入 Breed 固件，需要注意的是，输入 Breed 后路由器不会开启 WiFi，只能通过网线的方式访问；另外刷入 Breed 后，路由器的指示灯会变得很暗或完全不亮，可以通过网线连接电脑，查看连接属性，如果分配了 IP 则说明路由器正常进入 Breed</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ef8383>cd</span> /tmp
</span></span><span style=display:flex><span>mtd write breed-mt7621-pbr-m1.bin Bootloader
</span></span></code></pre></div><p>刷入完成后，路由器会重启；通过网线连接后访问 <a href=http://192.168.1.1>http://192.168.1.1</a> 即可进入 Breed 界面</p><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-breed-info.png alt=homelab-miwifi-breed-info.png></p><h2 id=刷入-openwrt>刷入 OpenWrt</h2><p>注意，下面的镜像都有 initramfs-kernel 和 squashfs-sysupgrade 两种；需要使用的是 squashfs-sysupgrade；如果刷入 initramfs-kernel，在重启后配置会丢失，这是因为 initramfs-kernel 将配置保存在内存中，而不是磁盘</p><h3 id=下载官方镜像>下载官方镜像</h3><p>官方镜像可以从以下两个镜像下载；测试发现官方的 initramfs-kernel 可以正常刷入，但是 squashfs-sysupgrade 刷入后会导致路由器不断的重启，无法工作</p><ul><li><a href=https://openwrt.org/inbox/toh/xiaomi/xiaomi_mi_router_4a_gigabit_edition>Xiaomi Mi Router 4A Gigabit Edition 说明文档</a></li></ul><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-openwrt-firmware-official2.png alt=homelab-miwifi-openwrt-firmware-official2.png></p><ul><li><a href="https://firmware-selector.openwrt.org/?version=21.02.3&amp;target=ramips/mt7621&amp;id=xiaomi_mi-router-4a-gigabit">https://firmware-selector.openwrt.org/</a>
<img src=https://img.hellowood.dev/picture/homelab-miwifi-openwrt-firmware-official.png alt=homelab-miwifi-openwrt-firmware-official.png></li></ul><h3 id=构建-openwrt-镜像>构建 OpenWrt 镜像</h3><p>可以使用 <a href=https://github.com/unkaer/Actions-OpenWrt-Xiaomi-R4A>unkaer/Actions-OpenWrt-Xiaomi-R4A</a> 自行构建（需要一个多小时），会预先安装中文和部分常用软件，实测可以正常工作</p><p>参考项目 <a href=https://github.com/unkaer/Actions-OpenWrt-Xiaomi-R4A#%E4%BD%BF%E7%94%A8>README</a>，fork 项目后选择Action，执行 <code>编译小米R4A千兆版_默认</code>，如果没有需要修改的配置，将<code>SSH 连接至 Actions</code> 设置为 false 然后执行，一个半小时左右能构建完成</p><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-openwrt-build-image.png alt=homelab-miwifi-openwrt-build-image.png></p><p>构建完成后，可以在 Action 的 Summary 界面进行下载名称为 <code>OpenWrt_firmware_xiaomi_mi-router-4a-gigabit</code> 的文件</p><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-openwrt-build-image-result.png alt=homelab-miwifi-openwrt-build-image-result.png></p><h3 id=刷入-openwrt-1>刷入 OpenWrt</h3><p>进入 Breed，选择固件更新，选择固件，在文件夹中选择 Kernel 版本的镜像，上传并更新；
<img src=https://img.hellowood.dev/picture/homelab-miwifi-breed-firmware-upload.png alt=homelab-miwifi-breed-firmware-upload.png></p><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-breed-firmware-upgrade.png alt=homelab-miwifi-breed-firmware-upgrade.png></p><p>等待刷入完成后，访问 <a href=http://192.168.31.1>http://192.168.31.1</a> 即可进入 OpenWrt， 默认的用户名密码是 <code>root</code> 和 <code>password</code></p><p><img src=https://img.hellowood.dev/picture/homelab-miwifi-openwrt-homepage.png alt=homelab-miwifi-openwrt-homepage.png></p><p>如果刷入失败，或者想重新刷入其他固件，可以将路由器断电，按住 Reset 后通电，直到路由器指示灯闪烁后松开 Reset，即可进入 Breed 重新进行刷机</p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>