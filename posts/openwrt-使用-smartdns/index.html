<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>OpenWrt 使用 SmartDNS</title><meta charset=utf-8><meta name=description content="Ladder@OpenWrt 使用 SmartDNS SmartDNS 是由国内用户开发的本地 DNS 服务器，从多个上游获取 DNS 结果，并将访问速度最快的地址返回给客户端；SmartDNS 可以运行在多个平台，如 Linux, OpenWrt 等
在 OpenWrt 中运行 SmartDNS，将其作为 dnsmasq 的上游或作为唯一的 DNS 服务器，用于提升 DNS 解析速度
安装 SmartDNS 的安装非常简单，使用 opkg 命令即可安装
opkg update opkg install smartdns opkg install luci-app-smartdns opkg install luci-i18n-smartdns-zh-cn 配置 SmartDNS 安装完成后，在服务-SmartDNS 常规配置中，选择启用 SmartDNS，然后添加上游 DNS 服务器（也可以直接在命令行修改 /etc/config/smartdns 配置文件）
这样，SmartDNS 会运行在路由器的 6053 端口上
配置 Dnsmasq OpenWrt 默认的 DHCP 和 DNS 服务由 Dnsmasq 提供，所以需要配置 SmartDNS 作为 Dnsmasq 的上游 DNS 服务器
在网络-DHCP/DNS -常规设置中，添加 DNS 转发，将 SmartDNS 作为 Dnsmasq 的上游 检查配置结果 通过 nslookup 命令查找 smartdns，如果返回 smartdns 的解析结果，则说明配置成功"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/openwrt-%E4%BD%BF%E7%94%A8-smartdns/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/umami.js></script><meta property="og:title" content="OpenWrt 使用 SmartDNS"><meta property="og:description" content="OpenWrt 使用 SmartDNS SmartDNS 是由国内用户开发的本地 DNS 服务器，从多个上游获取 DNS 结果，并将访问速度最快的地址返回给客户端；SmartDNS 可以运行在多个平台，如 Linux, OpenWrt 等
在 OpenWrt 中运行 SmartDNS，将其作为 dnsmasq 的上游或作为唯一的 DNS 服务器，用于提升 DNS 解析速度
安装 SmartDNS 的安装非常简单，使用 opkg 命令即可安装
opkg update opkg install smartdns opkg install luci-app-smartdns opkg install luci-i18n-smartdns-zh-cn 配置 SmartDNS 安装完成后，在服务-SmartDNS 常规配置中，选择启用 SmartDNS，然后添加上游 DNS 服务器（也可以直接在命令行修改 /etc/config/smartdns 配置文件）
这样，SmartDNS 会运行在路由器的 6053 端口上
配置 Dnsmasq OpenWrt 默认的 DHCP 和 DNS 服务由 Dnsmasq 提供，所以需要配置 SmartDNS 作为 Dnsmasq 的上游 DNS 服务器
在网络-DHCP/DNS -常规设置中，添加 DNS 转发，将 SmartDNS 作为 Dnsmasq 的上游 检查配置结果 通过 nslookup 命令查找 smartdns，如果返回 smartdns 的解析结果，则说明配置成功"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/openwrt-%E4%BD%BF%E7%94%A8-smartdns/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-27T11:32:08+00:00"><meta property="article:modified_time" content="2022-09-27T11:32:08+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenWrt 使用 SmartDNS"><meta name=twitter:description content="OpenWrt 使用 SmartDNS SmartDNS 是由国内用户开发的本地 DNS 服务器，从多个上游获取 DNS 结果，并将访问速度最快的地址返回给客户端；SmartDNS 可以运行在多个平台，如 Linux, OpenWrt 等
在 OpenWrt 中运行 SmartDNS，将其作为 dnsmasq 的上游或作为唯一的 DNS 服务器，用于提升 DNS 解析速度
安装 SmartDNS 的安装非常简单，使用 opkg 命令即可安装
opkg update opkg install smartdns opkg install luci-app-smartdns opkg install luci-i18n-smartdns-zh-cn 配置 SmartDNS 安装完成后，在服务-SmartDNS 常规配置中，选择启用 SmartDNS，然后添加上游 DNS 服务器（也可以直接在命令行修改 /etc/config/smartdns 配置文件）
这样，SmartDNS 会运行在路由器的 6053 端口上
配置 Dnsmasq OpenWrt 默认的 DHCP 和 DNS 服务由 Dnsmasq 提供，所以需要配置 SmartDNS 作为 Dnsmasq 的上游 DNS 服务器
在网络-DHCP/DNS -常规设置中，添加 DNS 转发，将 SmartDNS 作为 Dnsmasq 的上游 检查配置结果 通过 nslookup 命令查找 smartdns，如果返回 smartdns 的解析结果，则说明配置成功"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"OpenWrt 使用 SmartDNS","item":"https://blog.hellowood.dev/posts/openwrt-%E4%BD%BF%E7%94%A8-smartdns/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OpenWrt 使用 SmartDNS","name":"OpenWrt 使用 SmartDNS","description":"OpenWrt 使用 SmartDNS SmartDNS 是由国内用户开发的本地 DNS 服务器，从多个上游获取 DNS 结果，并将访问速度最快的地址返回给客户端；SmartDNS 可以运行在多个平台，如 Linux, OpenWrt 等\n在 OpenWrt 中运行 SmartDNS，将其作为 dnsmasq 的上游或作为唯一的 DNS 服务器，用于提升 DNS 解析速度\n安装 SmartDNS 的安装非常简单，使用 opkg 命令即可安装\nopkg update opkg install smartdns opkg install luci-app-smartdns opkg install luci-i18n-smartdns-zh-cn 配置 SmartDNS 安装完成后，在服务-SmartDNS 常规配置中，选择启用 SmartDNS，然后添加上游 DNS 服务器（也可以直接在命令行修改 /etc/config/smartdns 配置文件）\n这样，SmartDNS 会运行在路由器的 6053 端口上\n配置 Dnsmasq OpenWrt 默认的 DHCP 和 DNS 服务由 Dnsmasq 提供，所以需要配置 SmartDNS 作为 Dnsmasq 的上游 DNS 服务器\n在网络-DHCP/DNS -常规设置中，添加 DNS 转发，将 SmartDNS 作为 Dnsmasq 的上游 检查配置结果 通过 nslookup 命令查找 smartdns，如果返回 smartdns 的解析结果，则说明配置成功","keywords":["SmartDNS","DNS","OpenWrt","HomeLab"],"articleBody":"OpenWrt 使用 SmartDNS SmartDNS 是由国内用户开发的本地 DNS 服务器，从多个上游获取 DNS 结果，并将访问速度最快的地址返回给客户端；SmartDNS 可以运行在多个平台，如 Linux, OpenWrt 等\n在 OpenWrt 中运行 SmartDNS，将其作为 dnsmasq 的上游或作为唯一的 DNS 服务器，用于提升 DNS 解析速度\n安装 SmartDNS 的安装非常简单，使用 opkg 命令即可安装\nopkg update opkg install smartdns opkg install luci-app-smartdns opkg install luci-i18n-smartdns-zh-cn 配置 SmartDNS 安装完成后，在服务-SmartDNS 常规配置中，选择启用 SmartDNS，然后添加上游 DNS 服务器（也可以直接在命令行修改 /etc/config/smartdns 配置文件）\n这样，SmartDNS 会运行在路由器的 6053 端口上\n配置 Dnsmasq OpenWrt 默认的 DHCP 和 DNS 服务由 Dnsmasq 提供，所以需要配置 SmartDNS 作为 Dnsmasq 的上游 DNS 服务器\n在网络-DHCP/DNS -常规设置中，添加 DNS 转发，将 SmartDNS 作为 Dnsmasq 的上游 检查配置结果 通过 nslookup 命令查找 smartdns，如果返回 smartdns 的解析结果，则说明配置成功\nnslookup -querytype=ptr smartdns Server: 192.168.2.1 Address: 192.168.2.1#53 Non-authoritative answer: smartdns name = smartdns. 将 SmartDNS 作为主 DNS 服务器 上述配置完成后，DNS的查询流程为 客户端 -\u003e Dnsmasq -\u003e SmartDNS -\u003e 上游 DNS 服务器；Dnsmasq 变成了赚差价的中间商，会影响查询速度；因此，可以将 SmartDNS 作为主 DNS 服务器，不再经过 Dnsmasq\n需要注意的是，如果使用了 OpenClash 等需要劫持 DNS 的服务，不能用这种方式，否则可能会导致服务无法正常使用\n修改 Dnsmasq 的端口为非 53 端口 在网络 - DHCP/DNS 配置- 高级设置中，修改 DNS 服务器端口，改为 53 之外的其他端口，如 6653\n修改 SmartDNS 的端口为 53 端口 在服务-SmartDNS-常规设置中，将 SmartDNS 的端口修改为 53，这样客户端的 DNS 查询请求都会由 SmartDNS 提供\n此时 DNS 的查询流程为 客户端 -\u003e SmartDNS -\u003e 上游 DNS 服务器\n","wordCount":"160","inLanguage":"en","datePublished":"2022-09-27T11:32:08Z","dateModified":"2022-09-27T11:32:08Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/openwrt-%E4%BD%BF%E7%94%A8-smartdns/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/r2Llssnu/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>OpenWrt 使用 SmartDNS</h1></header><p><small>September 27, 2022&nbsp;· 160 words&nbsp;· One minute</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#安装>安装</a></li><li><a href=#配置-smartdns>配置 SmartDNS</a></li><li><a href=#配置-dnsmasq>配置 Dnsmasq</a></li><li><a href=#检查配置结果>检查配置结果</a></li><li><a href=#将-smartdns-作为主-dns-服务器>将 SmartDNS 作为主 DNS 服务器</a></li></ul></nav></div><section class=blog-content><h1 id=openwrt-使用-smartdns>OpenWrt 使用 SmartDNS</h1><p><a href=https://pymumu.github.io/smartdns/>SmartDNS</a> 是由国内用户开发的本地 DNS 服务器，从多个上游获取 DNS 结果，并将访问速度最快的地址返回给客户端；SmartDNS 可以运行在多个平台，如 Linux, OpenWrt 等</p><p>在 OpenWrt 中运行 SmartDNS，将其作为 dnsmasq 的上游或作为唯一的 DNS 服务器，用于提升 DNS 解析速度</p><h2 id=安装>安装</h2><p>SmartDNS 的安装非常简单，使用 opkg 命令即可安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>opkg update
</span></span><span style=display:flex><span>opkg install smartdns
</span></span><span style=display:flex><span>opkg install luci-app-smartdns
</span></span><span style=display:flex><span>opkg install luci-i18n-smartdns-zh-cn
</span></span></code></pre></div><h2 id=配置-smartdns>配置 SmartDNS</h2><p>安装完成后，在服务-SmartDNS 常规配置中，选择启用 SmartDNS，然后添加上游 DNS 服务器（也可以直接在命令行修改 <code>/etc/config/smartdns</code> 配置文件）</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-openwrt-dns-smartdns-upstream.png alt=homelab-openwrt-dns-smartdns-upstream.png></p><p>这样，SmartDNS 会运行在路由器的 6053 端口上</p><h2 id=配置-dnsmasq>配置 Dnsmasq</h2><p>OpenWrt 默认的 DHCP 和 DNS 服务由 Dnsmasq 提供，所以需要配置 SmartDNS 作为 Dnsmasq 的上游 DNS 服务器</p><p>在网络-DHCP/DNS -常规设置中，添加 DNS 转发，将 SmartDNS 作为 Dnsmasq 的上游
<img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-oepnwrt-smart-dns-as-dnsmasq-upstream.png alt=homelab-oepnwrt-smart-dns-as-dnsmasq-upstream.png></p><h2 id=检查配置结果>检查配置结果</h2><p>通过 <code>nslookup</code> 命令查找 <code>smartdns</code>，如果返回 <code>smartdns</code> 的解析结果，则说明配置成功</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nslookup -querytype<span style=color:#f92672>=</span>ptr smartdns
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Server:         192.168.2.1
</span></span><span style=display:flex><span>Address:        192.168.2.1#53
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Non-authoritative answer:
</span></span><span style=display:flex><span>smartdns        name <span style=color:#f92672>=</span> smartdns.
</span></span></code></pre></div><h2 id=将-smartdns-作为主-dns-服务器>将 SmartDNS 作为主 DNS 服务器</h2><p>上述配置完成后，DNS的查询流程为 客户端 -> Dnsmasq -> SmartDNS -> 上游 DNS 服务器；Dnsmasq 变成了赚差价的中间商，会影响查询速度；因此，可以将 SmartDNS 作为主 DNS 服务器，不再经过 Dnsmasq</p><p>需要注意的是，如果使用了 OpenClash 等需要劫持 DNS 的服务，不能用这种方式，否则可能会导致服务无法正常使用</p><ul><li>修改 Dnsmasq 的端口为非 53 端口</li></ul><p>在网络 - DHCP/DNS 配置- 高级设置中，修改 DNS 服务器端口，改为 53 之外的其他端口，如 6653</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-oepnwrt-smart-dns-masqdns-non-53-port.png alt=homelab-oepnwrt-smart-dns-masqdns-non-53-port.png></p><ul><li>修改 SmartDNS 的端口为 53 端口</li></ul><p>在服务-SmartDNS-常规设置中，将 SmartDNS 的端口修改为 53，这样客户端的 DNS 查询请求都会由 SmartDNS 提供</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-oepnwrt-smart-dns-use-the-53-port.png alt=homelab-oepnwrt-smart-dns-use-the-53-port.png></p><p>此时 DNS 的查询流程为 客户端 -> SmartDNS -> 上游 DNS 服务器</p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E5%B0%8F%E7%B1%B3-redmi-ax6s-ax3200-%E5%88%B7%E5%85%A5-openwrt-%E5%8F%8A%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/><span>&larr;&nbsp;&nbsp;</span><span>小米 Redmi AX6S(AX3200) 刷入 OpenWrt 及使用体验</span></a>
<a class=next href=https://blog.hellowood.dev/posts/openwrt-%E7%9B%91%E6%8E%A7/><span>OpenWrt-监控</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>