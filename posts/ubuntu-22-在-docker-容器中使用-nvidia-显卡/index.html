<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Ubuntu 22 在 Docker 容器中使用 NVIDIA 显卡</title>
<meta name=description content="在容器中运行需要使用 NVIDIA 显卡进行加速的服务，如图像识别、LLM 等，需要将显卡挂载到容器中
安装 NVIDIA 容器工具包 添加软件源 需要添加 NVIDIA 容器工具包的软件源和 gpg 签名
curl -fsSL …"><meta name=keywords content='blog,hugo,Ubuntu,NVIDIA,CUDA'><meta property="og:url" content="https://blog.hellowood.dev/posts/ubuntu-22-%E5%9C%A8-docker-%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8-nvidia-%E6%98%BE%E5%8D%A1/"><meta property="og:type" content="website"><meta property="og:title" content="Ubuntu 22 在 Docker 容器中使用 NVIDIA 显卡"><meta property="og:description" content="在容器中运行需要使用 NVIDIA 显卡进行加速的服务，如图像识别、LLM 等，需要将显卡挂载到容器中
安装 NVIDIA 容器工具包 添加软件源 需要添加 NVIDIA 容器工具包的软件源和 gpg 签名
curl -fsSL …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Ubuntu 22 在 Docker 容器中使用 NVIDIA 显卡"><meta name=twitter:description content="在容器中运行需要使用 NVIDIA 显卡进行加速的服务，如图像识别、LLM 等，需要将显卡挂载到容器中
安装 NVIDIA 容器工具包 添加软件源 需要添加 NVIDIA 容器工具包的软件源和 gpg 签名
curl -fsSL …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/ubuntu-22-%E5%9C%A8-docker-%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8-nvidia-%E6%98%BE%E5%8D%A1/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/ubuntu-22-%E5%9C%A8-docker-%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8-nvidia-%E6%98%BE%E5%8D%A1/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/ubuntu-22-%E5%9C%A8-docker-%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8-nvidia-%E6%98%BE%E5%8D%A1/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Ubuntu 22 在 Docker 容器中使用 NVIDIA 显卡</h1><small role=doc-subtitle></small><p class=post-date>2024-08-08</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/ubuntu>Ubuntu</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/nvidia>NVIDIA</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/cuda>CUDA</a></li></ul></div><div class=post-content><p>在容器中运行需要使用 NVIDIA 显卡进行加速的服务，如图像识别、LLM 等，需要将显卡挂载到容器中</p><h2 id=安装-nvidia-容器工具包>安装 NVIDIA 容器工具包</h2><ul><li>添加软件源</li></ul><p>需要添加 NVIDIA 容器工具包的软件源和 gpg 签名</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>  <span style=color:#c7bf54>&amp;&amp;</span> curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>    sed <span style=color:#98c379>&#39;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#39;</span> | <span style=color:#d26464;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#d26464;font-weight:700></span>    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
</span></span></code></pre></div><ul><li>更新软件并安装 NVIDIA 容器工具包</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update <span style=color:#c7bf54>&amp;&amp;</span> sudo apt-get install -y nvidia-container-toolkit
</span></span></code></pre></div><h2 id=配置-docker>配置 Docker</h2><ul><li>使用 nvidia-ctk 修改 Docker 配置</li></ul><p>修改 Docker 配置，允许将显卡挂载到容器中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nvidia-ctk runtime configure --runtime<span style=color:#c7bf54>=</span>docker
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>WARN<span style=color:#c7bf54>[</span>0000<span style=color:#c7bf54>]</span> Ignoring runtime-config-override flag <span style=color:#c678dd>for</span> docker
</span></span><span style=display:flex><span>INFO<span style=color:#c7bf54>[</span>0000<span style=color:#c7bf54>]</span> Loading config from /etc/docker/daemon.json
</span></span><span style=display:flex><span>INFO<span style=color:#c7bf54>[</span>0000<span style=color:#c7bf54>]</span> Wrote updated config to /etc/docker/daemon.json
</span></span><span style=display:flex><span>INFO<span style=color:#c7bf54>[</span>0000<span style=color:#c7bf54>]</span> It is recommended that docker daemon be restarted.
</span></span></code></pre></div><p>这样会自动修改 <code>/etc/docker/daemon.json</code> 文件，添加显卡 <code>runtimes</code> 相关的内容：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e06c75>&#34;runtimes&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#e06c75>&#34;nvidia&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#e06c75>&#34;args&#34;</span>: [],
</span></span><span style=display:flex><span>      <span style=color:#e06c75>&#34;path&#34;</span>: <span style=color:#63c381>&#34;nvidia-container-runtime&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>重启 Docker</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div><h2 id=使用>使用</h2><p>以 NIVDIA 官方提供的测试镜像为例</p><ul><li>docker 命令行使用</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker run --rm --runtime<span style=color:#c7bf54>=</span>nvidia --gpus all ubuntu nvidia-smi
</span></span></code></pre></div><p>将会使用 <code>nvidia-smi</code> 输出显卡相关的信息:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Wed Aug  <span style=color:#d19a66>7</span> 01:12:17 <span style=color:#d19a66>2024</span>
</span></span><span style=display:flex><span>+---------------------------------------------------------------------------------------+
</span></span><span style=display:flex><span>| NVIDIA-SMI 535.183.01             Driver Version: 535.183.01   CUDA Version: 12.2     |
</span></span><span style=display:flex><span>|-----------------------------------------+----------------------+----------------------+
</span></span><span style=display:flex><span>| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span></span><span style=display:flex><span>| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
</span></span><span style=display:flex><span>|                                         |                      |               MIG M. |
</span></span><span style=display:flex><span>|<span style=color:#c7bf54>=========================================</span>+<span style=color:#c7bf54>======================</span>+<span style=color:#c7bf54>======================</span>|
</span></span><span style=display:flex><span>|   <span style=color:#d19a66>0</span>  NVIDIA GeForce RTX <span style=color:#d19a66>3070</span> Ti     Off | 00000000:01:00.0 Off |                  N/A |
</span></span><span style=display:flex><span>| 30%   33C    P8               7W / 310W |   6758MiB /  8192MiB |      0%      Default |
</span></span><span style=display:flex><span>|                                         |                      |                  N/A |
</span></span><span style=display:flex><span>+-----------------------------------------+----------------------+----------------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+---------------------------------------------------------------------------------------+
</span></span><span style=display:flex><span>| Processes:                                                                            |
</span></span><span style=display:flex><span>|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
</span></span><span style=display:flex><span>|        ID   ID                                                             Usage      |
</span></span><span style=display:flex><span>|<span style=color:#c7bf54>=======================================================================================</span>|
</span></span><span style=display:flex><span>+---------------------------------------------------------------------------------------+
</span></span></code></pre></div><ul><li>docker-compose 使用</li></ul><p>在 deploy 中指定要挂载的显卡数量，可以是数字或者 <code>all</code>；</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>test</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>nvidia/cuda:12.3.1-base-ubuntu20.04</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>command</span>: <span style=color:#98c379>nvidia-smi</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>deploy</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>resources</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>reservations</span>:
</span></span><span style=display:flex><span>          <span style=color:#e06c75>devices</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e06c75>driver</span>: <span style=color:#98c379>nvidia</span>
</span></span><span style=display:flex><span>              <span style=color:#e06c75>count</span>: <span style=color:#98c379>all</span>
</span></span><span style=display:flex><span>              <span style=color:#e06c75>capabilities</span>: [<span style=color:#98c379>gpu]</span>
</span></span></code></pre></div><p>也可以只挂载特定的显卡，通过 <code>device_ids</code> 指定：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>test</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>tensorflow/tensorflow:latest-gpu</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>command</span>: <span style=color:#98c379>python -c &#34;import tensorflow as tf;tf.test.gpu_device_name()&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>deploy</span>:
</span></span><span style=display:flex><span>      <span style=color:#e06c75>resources</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>reservations</span>:
</span></span><span style=display:flex><span>          <span style=color:#e06c75>devices</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e06c75>driver</span>: <span style=color:#98c379>nvidia</span>
</span></span><span style=display:flex><span>              <span style=color:#e06c75>device_ids</span>: [<span style=color:#63c381>&#34;0&#34;</span>, <span style=color:#63c381>&#34;3&#34;</span>]
</span></span><span style=display:flex><span>              <span style=color:#e06c75>capabilities</span>: [<span style=color:#98c379>gpu]</span>
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html>Installing the NVIDIA Container Toolkit</a></li><li><a href=https://docs.docker.com/compose/gpu-support/>Turn on GPU access with Docker Compose</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>