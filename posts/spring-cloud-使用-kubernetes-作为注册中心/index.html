<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Cloud 使用 Kubernetes 作为注册中心</title><meta charset=utf-8><meta name=description content="Ladder@Spring Cloud 使用 Kubernetes 作为注册中心 Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现
创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用
Provider 添加依赖 build.gradle dependencies { compile project(&#34;:discovery/common&#34;) implementation 'org.springframework.boot:spring-boot-starter-actuator' implementation 'org.springframework.boot:spring-boot-starter-web' implementation 'org.springframework.cloud:spring-cloud-starter-kubernetes-all' compileOnly 'org.projectlombok:lombok' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' } 添加配置 application.properties 指定服务的名称，用于实现调用
spring.application.name=provider-service server.port=8082 ProviderApplication.java 添加 @EnableDiscoveryClient启用服务发现
@SpringBootApplication @EnableDiscoveryClient public class ProviderApplication { public static void main(String[] args) { SpringApplication.run(ProviderApplication.class, args); } } 添加接口 @GetMapping(&#34;/ping&#34;) @ResponseBody public String ping() { try { return InetAddress."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/umami.js></script><meta property="og:title" content="Spring Cloud 使用 Kubernetes 作为注册中心"><meta property="og:description" content="Spring Cloud 使用 Kubernetes 作为注册中心 Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现
创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用
Provider 添加依赖 build.gradle dependencies { compile project(&#34;:discovery/common&#34;) implementation 'org.springframework.boot:spring-boot-starter-actuator' implementation 'org.springframework.boot:spring-boot-starter-web' implementation 'org.springframework.cloud:spring-cloud-starter-kubernetes-all' compileOnly 'org.projectlombok:lombok' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' } 添加配置 application.properties 指定服务的名称，用于实现调用
spring.application.name=provider-service server.port=8082 ProviderApplication.java 添加 @EnableDiscoveryClient启用服务发现
@SpringBootApplication @EnableDiscoveryClient public class ProviderApplication { public static void main(String[] args) { SpringApplication.run(ProviderApplication.class, args); } } 添加接口 @GetMapping(&#34;/ping&#34;) @ResponseBody public String ping() { try { return InetAddress."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-08T19:12:29+00:00"><meta property="article:modified_time" content="2019-09-08T19:12:29+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Cloud 使用 Kubernetes 作为注册中心"><meta name=twitter:description content="Spring Cloud 使用 Kubernetes 作为注册中心 Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现
创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用
Provider 添加依赖 build.gradle dependencies { compile project(&#34;:discovery/common&#34;) implementation 'org.springframework.boot:spring-boot-starter-actuator' implementation 'org.springframework.boot:spring-boot-starter-web' implementation 'org.springframework.cloud:spring-cloud-starter-kubernetes-all' compileOnly 'org.projectlombok:lombok' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' } 添加配置 application.properties 指定服务的名称，用于实现调用
spring.application.name=provider-service server.port=8082 ProviderApplication.java 添加 @EnableDiscoveryClient启用服务发现
@SpringBootApplication @EnableDiscoveryClient public class ProviderApplication { public static void main(String[] args) { SpringApplication.run(ProviderApplication.class, args); } } 添加接口 @GetMapping(&#34;/ping&#34;) @ResponseBody public String ping() { try { return InetAddress."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Spring Cloud 使用 Kubernetes 作为注册中心","item":"https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Cloud 使用 Kubernetes 作为注册中心","name":"Spring Cloud 使用 Kubernetes 作为注册中心","description":"Spring Cloud 使用 Kubernetes 作为注册中心 Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现\n创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用\nProvider 添加依赖 build.gradle dependencies { compile project(\u0026#34;:discovery/common\u0026#34;) implementation \u0026#39;org.springframework.boot:spring-boot-starter-actuator\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter-web\u0026#39; implementation \u0026#39;org.springframework.cloud:spring-cloud-starter-kubernetes-all\u0026#39; compileOnly \u0026#39;org.projectlombok:lombok\u0026#39; annotationProcessor \u0026#39;org.projectlombok:lombok\u0026#39; testImplementation \u0026#39;org.springframework.boot:spring-boot-starter-test\u0026#39; } 添加配置 application.properties 指定服务的名称，用于实现调用\nspring.application.name=provider-service server.port=8082 ProviderApplication.java 添加 @EnableDiscoveryClient启用服务发现\n@SpringBootApplication @EnableDiscoveryClient public class ProviderApplication { public static void main(String[] args) { SpringApplication.run(ProviderApplication.class, args); } } 添加接口 @GetMapping(\u0026#34;/ping\u0026#34;) @ResponseBody public String ping() { try { return InetAddress.","keywords":["SpringCloud","Kubernetes"],"articleBody":"Spring Cloud 使用 Kubernetes 作为注册中心 Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现\n创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用\nProvider 添加依赖 build.gradle dependencies { compile project(\":discovery/common\") implementation 'org.springframework.boot:spring-boot-starter-actuator' implementation 'org.springframework.boot:spring-boot-starter-web' implementation 'org.springframework.cloud:spring-cloud-starter-kubernetes-all' compileOnly 'org.projectlombok:lombok' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' } 添加配置 application.properties 指定服务的名称，用于实现调用\nspring.application.name=provider-service server.port=8082 ProviderApplication.java 添加 @EnableDiscoveryClient启用服务发现\n@SpringBootApplication @EnableDiscoveryClient public class ProviderApplication { public static void main(String[] args) { SpringApplication.run(ProviderApplication.class, args); } } 添加接口 @GetMapping(\"/ping\") @ResponseBody public String ping() { try { return InetAddress.getLocalHost().getHostName(); } catch (UnknownHostException e) { return \"Pong\"; } } 部署到 Kubernetes Dockerfile FROM openjdk:8-jdk-alpine VOLUME /tmp ENV TZ=Asia/Shanghai RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026\u0026 echo $TZ \u003e /etc/timezone ARG JAR_FILE ADD discovery/provider/build/libs/provider-0.0.1-SNAPSHOT.jar app.jar ENTRYPOINT [\"java\",\"-Djava.security.egd=file:/dev/./urandom\", \"-Duser.timezone=GMT+08\", \"-jar\",\"/app.jar\"] 构建并上传镜像\nprovider-service.yaml apiVersion: v1 kind: Service metadata: name: provider-service labels: app.kubernetes.io/name: provider-service spec: type: ClusterIP ports: - port: 8082 targetPort: 8082 protocol: TCP name: http selector: app.kubernetes.io/name: provider-service --- apiVersion: apps/v1 kind: Deployment metadata: name: provider-service labels: app.kubernetes.io/name: provider-service spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: provider-service template: metadata: labels: app.kubernetes.io/name: provider-service app.kubernetes.io/instance: sad-markhor spec: containers: - name: provider-service image: \"docker.io/hellowoodes/spring-cloud-k8s-provider:1.2\" imagePullPolicy: IfNotPresent ports: - name: http containerPort: 8082 protocol: TCP Consumer 添加依赖 build.gradle dependencies { compile project(\":discovery/common\") implementation 'org.springframework.boot:spring-boot-starter-actuator' implementation 'org.springframework.boot:spring-boot-starter-web' implementation 'org.springframework.cloud:spring-cloud-starter-kubernetes-all' implementation 'org.springframework.cloud:spring-cloud-starter-openfeign' implementation 'org.springframework.cloud:spring-cloud-starter-netflix-ribbon' implementation 'io.github.openfeign:feign-java8' compileOnly 'org.projectlombok:lombok' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' } 不同的是 Consumer 还添加了 Feign 和 Ribbon 的依赖\n添加配置 application.properties spring.application.name=consumer-service server.port=8081 ConsumerApplication.java 启用服务发现和 Feign 远程调用\n@SpringBootApplication @EnableDiscoveryClient @EnableFeignClients public class ConsumerApplication { public static void main(String[] args) { SpringApplication.run(ConsumerApplication.class, args); } } 添加接口 ConsumerController.java @RestController @Slf4j public class ConsumerController { @Autowired private DiscoveryClient discoveryClient; @Autowired private ProviderClient providerClient; @GetMapping(\"/service\") public Object getClient() { return discoveryClient.getServices(); } @GetMapping(\"/instance\") public List\u003cServiceInstance\u003e getInstance(String instanceId) { return discoveryClient.getInstances(instanceId); } @GetMapping(\"/ping\") public OperationResponse ping() { return OperationResponse .builder() .success(true) .data(providerClient.ping()) .build(); } } ProviderClient.java @FeignClient(name = \"provider-service\", fallback = ProviderClientFallback.class) public interface ProviderClient { @RequestMapping(value = \"/ping\", method = RequestMethod.GET) String ping(); } @Component class ProviderClientFallback implements ProviderClient { @Override public String ping() { return \"Error\"; } } 部署到 Kubernetes Dockerfile FROM openjdk:8-jdk-alpine VOLUME /tmp ENV TZ=Asia/Shanghai RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026\u0026 echo $TZ \u003e /etc/timezone ARG JAR_FILE ADD discovery/consumer/build/libs/consumer-0.0.1-SNAPSHOT.jar app.jar ENTRYPOINT [\"java\",\"-Djava.security.egd=file:/dev/./urandom\", \"-Duser.timezone=GMT+08\", \"-jar\",\"/app.jar\"] 构建并上传镜像\nconsumer-service.yaml apiVersion: v1 kind: Service metadata: name: consumer-service labels: app.kubernetes.io/name: consumer-service spec: type: NodePort ports: - port: 8081 nodePort: 30081 protocol: TCP name: http selector: app.kubernetes.io/name: consumer-service --- apiVersion: apps/v1 kind: Deployment metadata: name: consumer-service labels: app.kubernetes.io/name: consumer-service spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: consumer-service template: metadata: labels: app.kubernetes.io/name: consumer-service spec: containers: - name: consumer-service image: \"docker.io/hellowoodes/spring-cloud-k8s-consumer:1.2\" imagePullPolicy: IfNotPresent ports: - name: http containerPort: 8081 protocol: TCP 部署测试 部署 kubectl apply -f discovery/provider/provider-service.yaml kubectl apply -f discovery/consumer/consumer-service.yaml 测试 待部署完成后，访问 ${NODE_IP}:30081/${PATH}即可得到服务信息\n测试接口 ping curl http://192.168.0.110:30081/ping {\"success\":true,\"message\":null,\"data\":\"provider-service-bb8844f9b-c74rj\"}% service curl http://192.168.0.110:30081/service [\"backend\",\"consumer-service\",\"kubernetes\",\"provider-service\",\"traefik\",\"traefik-dashboard\"]% instance curl http://192.168.0.110:30081/instance\\?instanceId\\=provider-service [{\"instanceId\":\"87f35232-cb2a-4a35-a094-f4577bce195e\",\"serviceId\":\"provider-service\",\"secure\":false,\"metadata\":{\"app.kubernetes.io/name\":\"provider-service\",\"kubectl.kubernetes.io/last-applied-configuration\":\"{\\\"apiVersion\\\":\\\"v1\\\",\\\"kind\\\":\\\"Service\\\",\\\"metadata\\\":{\\\"annotations\\\":{},\\\"labels\\\":{\\\"app.kubernetes.io/name\\\":\\\"provider-service\\\"},\\\"name\\\":\\\"provider-service\\\",\\\"namespace\\\":\\\"default\\\"},\\\"spec\\\":{\\\"ports\\\":[{\\\"name\\\":\\\"http\\\",\\\"port\\\":8082,\\\"protocol\\\":\\\"TCP\\\",\\\"targetPort\\\":8082}],\\\"selector\\\":{\\\"app.kubernetes.io/name\\\":\\\"provider-service\\\"},\\\"type\\\":\\\"ClusterIP\\\"}}\\n\",\"port.http\":\"8082\"},\"uri\":\"http://10.32.0.8:8082\",\"scheme\":\"http://\",\"host\":\"10.32.0.8\",\"port\":8082}]% 添加 Provider-Service 实例 kubectl scale deploy/provider-service --replicas=3 待扩容完成后，多次访问 ping 接口，会看到在轮询访问每个 Provider 实例，每次返回的实例 ID 都不一样\ncurl http://192.168.0.110:30081/ping {\"success\":true,\"message\":null,\"data\":\"provider-service-bb8844f9b-lm589\"}% curl http://192.168.0.110:30081/ping {\"success\":true,\"message\":null,\"data\":\"provider-service-bb8844f9b-n5szb\"}% curl http://192.168.0.110:30081/ping {\"success\":true,\"message\":null,\"data\":\"provider-service-bb8844f9b-c74rj\"}% ","wordCount":"464","inLanguage":"en","datePublished":"2019-09-08T19:12:29Z","dateModified":"2019-09-08T19:12:29Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c098d85b5396dec4707ea2cead1445b4dc2ff0fc56b8dbbd9049d0d1c50ad237.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/r2Llssnu/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Spring Cloud 使用 Kubernetes 作为注册中心</h1></header><p><small>September 8, 2019&nbsp;· 464 words&nbsp;· 3 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#provider>Provider</a><ul><li><a href=#添加依赖>添加依赖</a></li><li><a href=#添加配置>添加配置</a></li><li><a href=#添加接口>添加接口</a></li><li><a href=#部署到-kubernetes>部署到 Kubernetes</a></li></ul></li><li><a href=#consumer>Consumer</a><ul><li><a href=#添加依赖-1>添加依赖</a></li><li><a href=#添加配置-1>添加配置</a></li><li><a href=#添加接口-1>添加接口</a></li><li><a href=#部署到-kubernetes-1>部署到 Kubernetes</a></li></ul></li><li><a href=#部署测试>部署测试</a><ul><li><a href=#部署>部署</a></li><li><a href=#测试>测试</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=spring-cloud-使用-kubernetes-作为注册中心>Spring Cloud 使用 Kubernetes 作为注册中心</h1><blockquote><p>Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现</p></blockquote><p>创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用</p><h2 id=provider>Provider</h2><h3 id=添加依赖>添加依赖</h3><ul><li>build.gradle</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    compile <span style=color:#a6e22e>project</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;:discovery/common&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.cloud:spring-cloud-starter-kubernetes-all&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    compileOnly <span style=color:#e6db74>&#39;org.projectlombok:lombok&#39;</span>
</span></span><span style=display:flex><span>    annotationProcessor <span style=color:#e6db74>&#39;org.projectlombok:lombok&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=添加配置>添加配置</h3><ul><li>application.properties</li></ul><p>指定服务的名称，用于实现调用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>provider-service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>8082</span>
</span></span></code></pre></div><ul><li>ProviderApplication.java</li></ul><p>添加 <code>@EnableDiscoveryClient</code>启用服务发现</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProviderApplication</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SpringApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>ProviderApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=添加接口>添加接口</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/ping&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ResponseBody</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>ping</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> InetAddress<span style=color:#f92672>.</span><span style=color:#a6e22e>getLocalHost</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getHostName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>UnknownHostException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Pong&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=部署到-kubernetes>部署到 Kubernetes</h3><ul><li>Dockerfile</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> openjdk:8-jdk-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span><span style=color:#e6db74> /tmp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> TZ<span style=color:#f92672>=</span>Asia/Shanghai<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TZ &gt; /etc/timezone<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> JAR_FILE<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> discovery/provider/build/libs/provider-0.0.1-SNAPSHOT.jar app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;java&#34;</span>,<span style=color:#e6db74>&#34;-Djava.security.egd=file:/dev/./urandom&#34;</span>, <span style=color:#e6db74>&#34;-Duser.timezone=GMT+08&#34;</span>, <span style=color:#e6db74>&#34;-jar&#34;</span>,<span style=color:#e6db74>&#34;/app.jar&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>构建并上传镜像</p><ul><li>provider-service.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8082</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>8082</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>app.kubernetes.io/instance</span>: <span style=color:#ae81ff>sad-markhor</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>provider-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;docker.io/hellowoodes/spring-cloud-k8s-provider:1.2&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8082</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span></code></pre></div><h2 id=consumer>Consumer</h2><h3 id=添加依赖-1>添加依赖</h3><ul><li>build.gradle</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    compile <span style=color:#a6e22e>project</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;:discovery/common&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.cloud:spring-cloud-starter-kubernetes-all&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.cloud:spring-cloud-starter-openfeign&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.cloud:spring-cloud-starter-netflix-ribbon&#39;</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;io.github.openfeign:feign-java8&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    compileOnly <span style=color:#e6db74>&#39;org.projectlombok:lombok&#39;</span>
</span></span><span style=display:flex><span>    annotationProcessor <span style=color:#e6db74>&#39;org.projectlombok:lombok&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>不同的是 Consumer 还添加了 Feign 和 Ribbon 的依赖</p><h3 id=添加配置-1>添加配置</h3><ul><li>application.properties</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>consumer-service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>8081</span>
</span></span></code></pre></div><ul><li>ConsumerApplication.java</li></ul><p>启用服务发现和 Feign 远程调用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConsumerApplication</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        SpringApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>ConsumerApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=添加接口-1>添加接口</h3><ul><li>ConsumerController.java</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConsumerController</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> DiscoveryClient discoveryClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProviderClient providerClient<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/service&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getClient</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> discoveryClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getServices</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/instance&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getInstance</span><span style=color:#f92672>(</span>String instanceId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> discoveryClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstances</span><span style=color:#f92672>(</span>instanceId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/ping&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> OperationResponse <span style=color:#a6e22e>ping</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OperationResponse
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>success</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>data</span><span style=color:#f92672>(</span>providerClient<span style=color:#f92672>.</span><span style=color:#a6e22e>ping</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>ProviderClient.java</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;provider-service&#34;</span><span style=color:#f92672>,</span> fallback <span style=color:#f92672>=</span> ProviderClientFallback<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProviderClient</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/ping&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>ping</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProviderClientFallback</span> <span style=color:#66d9ef>implements</span> ProviderClient <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>ping</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=部署到-kubernetes-1>部署到 Kubernetes</h3><ul><li>Dockerfile</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> openjdk:8-jdk-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span><span style=color:#e6db74> /tmp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> TZ<span style=color:#f92672>=</span>Asia/Shanghai<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TZ &gt; /etc/timezone<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> JAR_FILE<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> discovery/consumer/build/libs/consumer-0.0.1-SNAPSHOT.jar app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;java&#34;</span>,<span style=color:#e6db74>&#34;-Djava.security.egd=file:/dev/./urandom&#34;</span>, <span style=color:#e6db74>&#34;-Duser.timezone=GMT+08&#34;</span>, <span style=color:#e6db74>&#34;-jar&#34;</span>,<span style=color:#e6db74>&#34;/app.jar&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>构建并上传镜像</p><ul><li>consumer-service.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30081</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumer-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;docker.io/hellowoodes/spring-cloud-k8s-consumer:1.2&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span></code></pre></div><h2 id=部署测试>部署测试</h2><h3 id=部署>部署</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f discovery/provider/provider-service.yaml
</span></span><span style=display:flex><span>kubectl apply -f discovery/consumer/consumer-service.yaml
</span></span></code></pre></div><h3 id=测试>测试</h3><p>待部署完成后，访问 <code>${NODE_IP}:30081/${PATH}</code>即可得到服务信息</p><h4 id=测试接口>测试接口</h4><ul><li>ping</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://192.168.0.110:30081/ping
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;success&#34;</span>:true,<span style=color:#e6db74>&#34;message&#34;</span>:null,<span style=color:#e6db74>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;provider-service-bb8844f9b-c74rj&#34;</span><span style=color:#f92672>}</span>%
</span></span></code></pre></div><ul><li>service</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://192.168.0.110:30081/service
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;backend&#34;</span>,<span style=color:#e6db74>&#34;consumer-service&#34;</span>,<span style=color:#e6db74>&#34;kubernetes&#34;</span>,<span style=color:#e6db74>&#34;provider-service&#34;</span>,<span style=color:#e6db74>&#34;traefik&#34;</span>,<span style=color:#e6db74>&#34;traefik-dashboard&#34;</span><span style=color:#f92672>]</span>%
</span></span></code></pre></div><ul><li>instance</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://192.168.0.110:30081/instance<span style=color:#ae81ff>\?</span>instanceId<span style=color:#ae81ff>\=</span>provider-service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;instanceId&#34;</span>:<span style=color:#e6db74>&#34;87f35232-cb2a-4a35-a094-f4577bce195e&#34;</span>,<span style=color:#e6db74>&#34;serviceId&#34;</span>:<span style=color:#e6db74>&#34;provider-service&#34;</span>,<span style=color:#e6db74>&#34;secure&#34;</span>:false,<span style=color:#e6db74>&#34;metadata&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;app.kubernetes.io/name&#34;</span>:<span style=color:#e6db74>&#34;provider-service&#34;</span>,<span style=color:#e6db74>&#34;kubectl.kubernetes.io/last-applied-configuration&#34;</span>:<span style=color:#e6db74>&#34;{\&#34;apiVersion\&#34;:\&#34;v1\&#34;,\&#34;kind\&#34;:\&#34;Service\&#34;,\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{},\&#34;labels\&#34;:{\&#34;app.kubernetes.io/name\&#34;:\&#34;provider-service\&#34;},\&#34;name\&#34;:\&#34;provider-service\&#34;,\&#34;namespace\&#34;:\&#34;default\&#34;},\&#34;spec\&#34;:{\&#34;ports\&#34;:[{\&#34;name\&#34;:\&#34;http\&#34;,\&#34;port\&#34;:8082,\&#34;protocol\&#34;:\&#34;TCP\&#34;,\&#34;targetPort\&#34;:8082}],\&#34;selector\&#34;:{\&#34;app.kubernetes.io/name\&#34;:\&#34;provider-service\&#34;},\&#34;type\&#34;:\&#34;ClusterIP\&#34;}}\n&#34;</span>,<span style=color:#e6db74>&#34;port.http&#34;</span>:<span style=color:#e6db74>&#34;8082&#34;</span><span style=color:#f92672>}</span>,<span style=color:#e6db74>&#34;uri&#34;</span>:<span style=color:#e6db74>&#34;http://10.32.0.8:8082&#34;</span>,<span style=color:#e6db74>&#34;scheme&#34;</span>:<span style=color:#e6db74>&#34;http://&#34;</span>,<span style=color:#e6db74>&#34;host&#34;</span>:<span style=color:#e6db74>&#34;10.32.0.8&#34;</span>,<span style=color:#e6db74>&#34;port&#34;</span>:8082<span style=color:#f92672>}]</span>%
</span></span></code></pre></div><h4 id=添加-provider-service-实例>添加 Provider-Service 实例</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl scale deploy/provider-service --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>待扩容完成后，多次访问 ping 接口，会看到在轮询访问每个 Provider 实例，每次返回的实例 ID 都不一样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://192.168.0.110:30081/ping
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;success&#34;</span>:true,<span style=color:#e6db74>&#34;message&#34;</span>:null,<span style=color:#e6db74>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;provider-service-bb8844f9b-lm589&#34;</span><span style=color:#f92672>}</span>%
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://192.168.0.110:30081/ping
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;success&#34;</span>:true,<span style=color:#e6db74>&#34;message&#34;</span>:null,<span style=color:#e6db74>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;provider-service-bb8844f9b-n5szb&#34;</span><span style=color:#f92672>}</span>%
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://192.168.0.110:30081/ping
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;success&#34;</span>:true,<span style=color:#e6db74>&#34;message&#34;</span>:null,<span style=color:#e6db74>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;provider-service-bb8844f9b-c74rj&#34;</span><span style=color:#f92672>}</span>%
</span></span></code></pre></div></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/><span>&larr;&nbsp;&nbsp;</span><span>Spring Cloud 使用 Kubernetes 作为配置中心</span></a>
<a class=next href=https://blog.hellowood.dev/posts/kubenetes-%E4%B8%AD%E4%BD%BF%E7%94%A8-traefik-%E4%BD%9C%E4%B8%BA-ingress-%E8%BD%AC%E5%8F%91%E6%B5%81%E9%87%8F/><span>Kubenetes 中使用 Traefik 作为 Ingress 转发流量</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>