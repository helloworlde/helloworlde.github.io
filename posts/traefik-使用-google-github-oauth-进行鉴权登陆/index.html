<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Traefik 使用 Google GitHub OAuth 进行鉴权登陆</title><meta charset=utf-8><meta name=description content="Ladder@Traefik 使用 Google/GitHub OAuth 进行鉴权登陆 在使用 Traefik 作为 Homelab 的网关时，考虑到部分服务涉及隐私，因此需要限制用户登陆后才能使用；
Traefik 支持使用 HTTP 中间件，可以将鉴权信息转发给其他服务进行鉴权，因此，使用 https://github.com/thomseddon/traefik-forward-auth 作为鉴权的服务，该服务默认使用 Google OAuth，因此，可以通过 Google 账号登陆访问内部服务；该服务也支持任何 OAuth 标准的认证服务，如 GitHub，微软等
申请 OAuth 应用 在 Google Cloud 创建新的应用，选择 &ldquo;APIs and Services&rdquo; -> &ldquo;Credentials&rdquo;，选择 &ldquo;CREATE CREDENTIALS&rdquo; -> &ldquo;OAuth Client ID&rdquo;，应用类型选择 &ldquo;Web Application&rdquo;，填写名称，重定向 URL 为要访问的 URL + 认证路径，traefik-forward-auth 的认证路径为 /_oauth
确认后会提示 Client ID 和 Client Secret，需要保存好，作为 traefik-forward-auth 配置
为特定的服务添加认证 认证特定的服务，需要启动 traefik-forward-auth 服务，然后为要认证的服务添加中间件即可；如这里给 whoami 服务添加了名为 traefik-forward-auth 的 HTTP 中间件
这里通过将域名指向本地的方式进行测试，如在 /etc/hosts 中添加 whoami."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/traefik-%E4%BD%BF%E7%94%A8-google-github-oauth-%E8%BF%9B%E8%A1%8C%E9%89%B4%E6%9D%83%E7%99%BB%E9%99%86/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/umami.js></script><meta property="og:title" content="Traefik 使用 Google GitHub OAuth 进行鉴权登陆"><meta property="og:description" content="Traefik 使用 Google/GitHub OAuth 进行鉴权登陆 在使用 Traefik 作为 Homelab 的网关时，考虑到部分服务涉及隐私，因此需要限制用户登陆后才能使用；
Traefik 支持使用 HTTP 中间件，可以将鉴权信息转发给其他服务进行鉴权，因此，使用 https://github.com/thomseddon/traefik-forward-auth 作为鉴权的服务，该服务默认使用 Google OAuth，因此，可以通过 Google 账号登陆访问内部服务；该服务也支持任何 OAuth 标准的认证服务，如 GitHub，微软等
申请 OAuth 应用 在 Google Cloud 创建新的应用，选择 &ldquo;APIs and Services&rdquo; -> &ldquo;Credentials&rdquo;，选择 &ldquo;CREATE CREDENTIALS&rdquo; -> &ldquo;OAuth Client ID&rdquo;，应用类型选择 &ldquo;Web Application&rdquo;，填写名称，重定向 URL 为要访问的 URL + 认证路径，traefik-forward-auth 的认证路径为 /_oauth
确认后会提示 Client ID 和 Client Secret，需要保存好，作为 traefik-forward-auth 配置
为特定的服务添加认证 认证特定的服务，需要启动 traefik-forward-auth 服务，然后为要认证的服务添加中间件即可；如这里给 whoami 服务添加了名为 traefik-forward-auth 的 HTTP 中间件
这里通过将域名指向本地的方式进行测试，如在 /etc/hosts 中添加 whoami."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/traefik-%E4%BD%BF%E7%94%A8-google-github-oauth-%E8%BF%9B%E8%A1%8C%E9%89%B4%E6%9D%83%E7%99%BB%E9%99%86/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-15T21:42:38+08:00"><meta property="article:modified_time" content="2023-02-15T21:42:38+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Traefik 使用 Google GitHub OAuth 进行鉴权登陆"><meta name=twitter:description content="Traefik 使用 Google/GitHub OAuth 进行鉴权登陆 在使用 Traefik 作为 Homelab 的网关时，考虑到部分服务涉及隐私，因此需要限制用户登陆后才能使用；
Traefik 支持使用 HTTP 中间件，可以将鉴权信息转发给其他服务进行鉴权，因此，使用 https://github.com/thomseddon/traefik-forward-auth 作为鉴权的服务，该服务默认使用 Google OAuth，因此，可以通过 Google 账号登陆访问内部服务；该服务也支持任何 OAuth 标准的认证服务，如 GitHub，微软等
申请 OAuth 应用 在 Google Cloud 创建新的应用，选择 &ldquo;APIs and Services&rdquo; -> &ldquo;Credentials&rdquo;，选择 &ldquo;CREATE CREDENTIALS&rdquo; -> &ldquo;OAuth Client ID&rdquo;，应用类型选择 &ldquo;Web Application&rdquo;，填写名称，重定向 URL 为要访问的 URL + 认证路径，traefik-forward-auth 的认证路径为 /_oauth
确认后会提示 Client ID 和 Client Secret，需要保存好，作为 traefik-forward-auth 配置
为特定的服务添加认证 认证特定的服务，需要启动 traefik-forward-auth 服务，然后为要认证的服务添加中间件即可；如这里给 whoami 服务添加了名为 traefik-forward-auth 的 HTTP 中间件
这里通过将域名指向本地的方式进行测试，如在 /etc/hosts 中添加 whoami."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Traefik 使用 Google GitHub OAuth 进行鉴权登陆","item":"https://blog.hellowood.dev/posts/traefik-%E4%BD%BF%E7%94%A8-google-github-oauth-%E8%BF%9B%E8%A1%8C%E9%89%B4%E6%9D%83%E7%99%BB%E9%99%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Traefik 使用 Google GitHub OAuth 进行鉴权登陆","name":"Traefik 使用 Google GitHub OAuth 进行鉴权登陆","description":"Traefik 使用 Google/GitHub OAuth 进行鉴权登陆 在使用 Traefik 作为 Homelab 的网关时，考虑到部分服务涉及隐私，因此需要限制用户登陆后才能使用；\nTraefik 支持使用 HTTP 中间件，可以将鉴权信息转发给其他服务进行鉴权，因此，使用 https://github.com/thomseddon/traefik-forward-auth 作为鉴权的服务，该服务默认使用 Google OAuth，因此，可以通过 Google 账号登陆访问内部服务；该服务也支持任何 OAuth 标准的认证服务，如 GitHub，微软等\n申请 OAuth 应用 在 Google Cloud 创建新的应用，选择 \u0026ldquo;APIs and Services\u0026rdquo; -\u0026gt; \u0026ldquo;Credentials\u0026rdquo;，选择 \u0026ldquo;CREATE CREDENTIALS\u0026rdquo; -\u0026gt; \u0026ldquo;OAuth Client ID\u0026rdquo;，应用类型选择 \u0026ldquo;Web Application\u0026rdquo;，填写名称，重定向 URL 为要访问的 URL + 认证路径，traefik-forward-auth 的认证路径为 /_oauth\n确认后会提示 Client ID 和 Client Secret，需要保存好，作为 traefik-forward-auth 配置\n为特定的服务添加认证 认证特定的服务，需要启动 traefik-forward-auth 服务，然后为要认证的服务添加中间件即可；如这里给 whoami 服务添加了名为 traefik-forward-auth 的 HTTP 中间件\n这里通过将域名指向本地的方式进行测试，如在 /etc/hosts 中添加 whoami.","keywords":["Traefik","HomeLab"],"articleBody":"Traefik 使用 Google/GitHub OAuth 进行鉴权登陆 在使用 Traefik 作为 Homelab 的网关时，考虑到部分服务涉及隐私，因此需要限制用户登陆后才能使用；\nTraefik 支持使用 HTTP 中间件，可以将鉴权信息转发给其他服务进行鉴权，因此，使用 https://github.com/thomseddon/traefik-forward-auth 作为鉴权的服务，该服务默认使用 Google OAuth，因此，可以通过 Google 账号登陆访问内部服务；该服务也支持任何 OAuth 标准的认证服务，如 GitHub，微软等\n申请 OAuth 应用 在 Google Cloud 创建新的应用，选择 “APIs and Services” -\u003e “Credentials”，选择 “CREATE CREDENTIALS” -\u003e “OAuth Client ID”，应用类型选择 “Web Application”，填写名称，重定向 URL 为要访问的 URL + 认证路径，traefik-forward-auth 的认证路径为 /_oauth\n确认后会提示 Client ID 和 Client Secret，需要保存好，作为 traefik-forward-auth 配置\n为特定的服务添加认证 认证特定的服务，需要启动 traefik-forward-auth 服务，然后为要认证的服务添加中间件即可；如这里给 whoami 服务添加了名为 traefik-forward-auth 的 HTTP 中间件\n这里通过将域名指向本地的方式进行测试，如在 /etc/hosts 中添加 whoami.homelab.io相关的域名作为 whoami 服务的域名：\n/etc/hosts 127.0.0.1 whoami.homelab.io docker-compose.yaml 需要将 GOOGLE_CLIENT_ID 和 GOOGLE_CLIENT_SECRET 替换为自己申请的\nversion: '3' networks: traefik: driver: bridge services: traefik: image: traefik:v3.0 container_name: traefik command: --api.insecure=true --api.dashboard=true --providers.docker ports: - \"80:80\" - \"8080:8080\" networks: - traefik volumes: - /var/run/docker.sock:/var/run/docker.sock traefik-forward-auth: image: thomseddon/traefik-forward-auth container_name: \"traefik-forward-auth\" environment: - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} - SECRET=traefik - INSECURE_COOKIE=true # 允许 HTTP 访问 labels: - \"traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181\" - \"traefik.http.routers.traefik-forward-auth.middlewares=traefik-forward-auth\" - \"traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://traefik-forward-auth:4181\" - \"traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User\" networks: - traefik whoami: image: \"traefik/whoami\" container_name: \"whoami\" labels: - \"traefik.enable=true\" - \"traefik.http.services.whoami.loadbalancer.server.port=80\" - \"traefik.http.routers.whoami.rule=Host(`whoami.homelab.io`)\" - \"traefik.http.routers.whoami.middlewares=traefik-forward-auth\" networks: - traefik 启动成功后，通过无痕浏览器访问 http://whoami.homelab.io/，会跳转到 Google 账号登陆，登陆完成后，会重定向到 http://whoami.homelab.io/_oauth 进行认证，认证通过后再次重定向到 http://whoami.homelab.io/，同时会添加名称为 _forward_auth 的 Cookie，作为后续访问的凭证\n为域名添加认证 通常我们会使用子域名指向不同的服务，当有大量服务时，域名的认证配置就会非常复杂，容易漏掉；而且每个都需要登陆一次；因此需要通过给域名添加认证的方式，为所有子域名认证\n/etc/hosts 同样，我们还是将域名指向本地进行测试；这次添加了多个域名\n127.0.0.1 homelab.io 127.0.0.1 auth.homelab.io 127.0.0.1 whoami.homelab.io docker-compose.yaml 配置有以下变动：\ntreafik 需要声明 entrypoints 并为其指定中间件为 traefik-forward-auth@docker treafik-forward-auth 需要指定 COOKIE_DOMAIN 为上级域名，这样所有的子域名都可以访问到；同时需要指定 AUTH_HOST，用于认证服务的域名 whoami 服务删除了中间件配置 Google Cloud 应用到 OAuth 配置中的重定向 URL 改为 http://auth.homelab.io/_oauth 这样就可以对 Traefik 下所有的服务进行认证；同时，只允许自己的账户访问，因此通过环境变量的方式指定白名单\nversion: 3' networks: traefik: driver: bridge services: traefik: image: traefik:v3.0 container_name: traefik command: | --api.insecure=true --api.dashboard=true --providers.docker --entrypoints.web.address=:80 --entrypoints.web.http.middlewares=traefik-forward-auth@docker ports: - \"80:80\" - \"8080:8080\" labels: - \"traefik.enable=true\" - \"traefik.http.services.traefik.loadbalancer.server.port=8080\" - \"traefik.http.routers.traefik.rule=Host(`homelab.io`)\" networks: - traefik volumes: - /var/run/docker.sock:/var/run/docker.sock traefik-forward-auth: image: thomseddon/traefik-forward-auth:0 container_name: \"traefik-forward-auth\" environment: - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} - SECRET=traefik - INSECURE_COOKIE=true # 允许 HTTP 访问 - COOKIE_DOMAIN=homelab.io # 指定 Cookie 的域名 - AUTH_HOST=auth.homelab.io # 指定认证服务的域名 - WHITELIST=a@google.com,b@google.com # 只允许白名单用户访问 labels: - \"traefik.http.routers.traefik-forward-auth.rule=Host(`auth.homelab.io`)\" - \"traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181\" - \"traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://traefik-forward-auth:4181\" - \"traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User\" networks: - traefik whoami: image: \"traefik/whoami\" container_name: \"whoami\" labels: - \"traefik.enable=true\" - \"traefik.http.routers.whoami.rule=Host(`whoami.homelab.io`)\" - \"traefik.http.services.whoami.loadbalancer.server.port=80\" networks: - traefik 使用 GitHub 认证 treafik-forward-auth 支持使用其他的 OAuth 服务进行认证，只需要修改配置即可；通过环境变量指定使用的认证服务类型，以及相关的 URL\n申请 OAuth 应用 在 GitHub -\u003e Settings -\u003e Developer settings 申请 OAuth 应用，指定 Callback URL 为 http://auth.homelab.io/_oauth\ndocker-compose.yaml # ... traefik-forward-auth: image: thomseddon/traefik-forward-auth:0 container_name: \"traefik-forward-auth\" environment: - DEFAULT_PROVIDER=generic-oauth # 使用通用的 OAuth - PROVIDERS_GENERIC_OAUTH_AUTH_URL=https://github.com/login/oauth/authorize - PROVIDERS_GENERIC_OAUTH_CLIENT_ID=${GITHUB_CLIENT_ID} - PROVIDERS_GENERIC_OAUTH_CLIENT_SECRET=${GITHUB_CLIENT_SECRET} - PROVIDERS_GENERIC_OAUTH_TOKEN_URL=https://github.com/login/oauth/access_token - PROVIDERS_GENERIC_OAUTH_USER_URL=https://api.github.com/user - SECRET=traefik - INSECURE_COOKIE=true # 允许 HTTP 访问 - COOKIE_DOMAIN=homelab.io # 指定 Cookie 的域名 - AUTH_HOST=auth.homelab.io # 指定认证服务的域名 # ... ","wordCount":"367","inLanguage":"en","datePublished":"2023-02-15T21:42:38+08:00","dateModified":"2023-02-15T21:42:38+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/traefik-%E4%BD%BF%E7%94%A8-google-github-oauth-%E8%BF%9B%E8%A1%8C%E9%89%B4%E6%9D%83%E7%99%BB%E9%99%86/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/r2Llssnu/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Traefik 使用 Google GitHub OAuth 进行鉴权登陆</h1></header><p><small>February 15, 2023&nbsp;· 367 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#申请-oauth-应用>申请 OAuth 应用</a></li><li><a href=#为特定的服务添加认证>为特定的服务添加认证</a></li><li><a href=#为域名添加认证>为域名添加认证</a></li><li><a href=#使用-github-认证>使用 GitHub 认证</a></li></ul></nav></div><section class=blog-content><h1 id=traefik-使用-googlegithub-oauth-进行鉴权登陆>Traefik 使用 Google/GitHub OAuth 进行鉴权登陆</h1><p>在使用 Traefik 作为 Homelab 的网关时，考虑到部分服务涉及隐私，因此需要限制用户登陆后才能使用；</p><p>Traefik 支持使用 HTTP 中间件，可以将鉴权信息转发给其他服务进行鉴权，因此，使用 <a href=https://github.com/thomseddon/traefik-forward-auth>https://github.com/thomseddon/traefik-forward-auth</a> 作为鉴权的服务，该服务默认使用 Google OAuth，因此，可以通过 Google 账号登陆访问内部服务；该服务也支持任何 OAuth 标准的认证服务，如 GitHub，微软等</p><h2 id=申请-oauth-应用>申请 OAuth 应用</h2><p>在 <a href=https://console.cloud.google.com/apis/credentials>Google Cloud</a> 创建新的应用，选择 &ldquo;APIs and Services&rdquo; -> &ldquo;Credentials&rdquo;，选择 &ldquo;CREATE CREDENTIALS&rdquo; -> &ldquo;OAuth Client ID&rdquo;，应用类型选择 &ldquo;Web Application&rdquo;，填写名称，重定向 URL 为要访问的 URL + 认证路径，traefik-forward-auth 的认证路径为 <code>/_oauth</code></p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-traefik-sso-google-oauth-apply-oauth-app.png alt=homelab-traefik-sso-google-oauth-apply-oauth-app.png></p><p>确认后会提示 Client ID 和 Client Secret，需要保存好，作为 traefik-forward-auth 配置</p><h2 id=为特定的服务添加认证>为特定的服务添加认证</h2><p>认证特定的服务，需要启动 traefik-forward-auth 服务，然后为要认证的服务添加中间件即可；如这里给 whoami 服务添加了名为 <code>traefik-forward-auth</code> 的 HTTP 中间件</p><p>这里通过将域名指向本地的方式进行测试，如在 <code>/etc/hosts</code> 中添加 <code>whoami.homelab.io</code>相关的域名作为 whoami 服务的域名：</p><ul><li><code>/etc/hosts</code></li></ul><pre tabindex=0><code>127.0.0.1 whoami.homelab.io
</code></pre><ul><li>docker-compose.yaml</li></ul><p>需要将 <code>GOOGLE_CLIENT_ID</code> 和 <code>GOOGLE_CLIENT_SECRET</code> 替换为自己申请的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>bridge</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:v3.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: --<span style=color:#ae81ff>api.insecure=true --api.dashboard=true --providers.docker </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;80:80&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8080:8080&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik-forward-auth</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>thomseddon/traefik-forward-auth</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#34;traefik-forward-auth&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SECRET=traefik</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>INSECURE_COOKIE=true</span> <span style=color:#75715e># 允许 HTTP 访问</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.traefik-forward-auth.middlewares=traefik-forward-auth&#34;</span>  
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://traefik-forward-auth:4181&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>whoami</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;traefik/whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#34;whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.whoami.loadbalancer.server.port=80&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.whoami.rule=Host(`whoami.homelab.io`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.whoami.middlewares=traefik-forward-auth&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik</span>
</span></span></code></pre></div><p>启动成功后，通过无痕浏览器访问 <a href=http://whoami.homelab.io/>http://whoami.homelab.io/</a>，会跳转到 Google 账号登陆，登陆完成后，会重定向到 <a href=http://whoami.homelab.io/_oauth>http://whoami.homelab.io/_oauth</a> 进行认证，认证通过后再次重定向到 <a href=http://whoami.homelab.io/>http://whoami.homelab.io/</a>，同时会添加名称为 <code>_forward_auth</code> 的 Cookie，作为后续访问的凭证</p><h2 id=为域名添加认证>为域名添加认证</h2><p>通常我们会使用子域名指向不同的服务，当有大量服务时，域名的认证配置就会非常复杂，容易漏掉；而且每个都需要登陆一次；因此需要通过给域名添加认证的方式，为所有子域名认证</p><ul><li><code>/etc/hosts</code></li></ul><p>同样，我们还是将域名指向本地进行测试；这次添加了多个域名</p><pre tabindex=0><code>127.0.0.1 homelab.io
127.0.0.1 auth.homelab.io
127.0.0.1 whoami.homelab.io
</code></pre><ul><li>docker-compose.yaml</li></ul><p>配置有以下变动：</p><ol><li>treafik 需要声明 entrypoints 并为其指定中间件为 <code>traefik-forward-auth@docker</code></li><li>treafik-forward-auth 需要指定 <code>COOKIE_DOMAIN</code> 为上级域名，这样所有的子域名都可以访问到；同时需要指定 <code>AUTH_HOST</code>，用于认证服务的域名</li><li>whoami 服务删除了中间件配置</li><li>Google Cloud 应用到 OAuth 配置中的重定向 URL 改为 <a href=http://auth.homelab.io/_oauth>http://auth.homelab.io/_oauth</a></li></ol><p>这样就可以对 Traefik 下所有的服务进行认证；同时，只允许自己的账户访问，因此通过环境变量的方式指定白名单</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>3</span><span style=color:#ae81ff>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>bridge</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:v3.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      --api.insecure=true 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      --api.dashboard=true 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      --providers.docker 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      --entrypoints.web.address=:80 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      --entrypoints.web.http.middlewares=traefik-forward-auth@docker</span>      
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;80:80&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8080:8080&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.traefik.loadbalancer.server.port=8080&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.traefik.rule=Host(`homelab.io`)&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik-forward-auth</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>thomseddon/traefik-forward-auth:0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#34;traefik-forward-auth&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SECRET=traefik</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>INSECURE_COOKIE=true</span> <span style=color:#75715e># 允许 HTTP 访问</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>COOKIE_DOMAIN=homelab.io</span> <span style=color:#75715e># 指定 Cookie 的域名</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>AUTH_HOST=auth.homelab.io</span> <span style=color:#75715e># 指定认证服务的域名</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>WHITELIST=a@google.com,b@google.com</span> <span style=color:#75715e># 只允许白名单用户访问</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>: 
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.traefik-forward-auth.rule=Host(`auth.homelab.io`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://traefik-forward-auth:4181&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>whoami</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;traefik/whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#34;whoami&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.whoami.rule=Host(`whoami.homelab.io`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.whoami.loadbalancer.server.port=80&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik</span>
</span></span></code></pre></div><h2 id=使用-github-认证>使用 GitHub 认证</h2><p>treafik-forward-auth 支持使用其他的 OAuth 服务进行认证，只需要修改配置即可；通过环境变量指定使用的认证服务类型，以及相关的 URL</p><ul><li>申请 OAuth 应用</li></ul><p>在 GitHub -> Settings -> Developer settings 申请 OAuth 应用，指定 Callback URL 为 <a href=http://auth.homelab.io/_oauth>http://auth.homelab.io/_oauth</a></p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-traefik-sso-github-oauth-apply-oauth-app.png alt=homelab-traefik-sso-github-oauth-apply-oauth-app.png></p><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik-forward-auth</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>thomseddon/traefik-forward-auth:0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#34;traefik-forward-auth&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DEFAULT_PROVIDER=generic-oauth</span> <span style=color:#75715e># 使用通用的 OAuth</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GENERIC_OAUTH_AUTH_URL=https://github.com/login/oauth/authorize</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GENERIC_OAUTH_CLIENT_ID=${GITHUB_CLIENT_ID}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GENERIC_OAUTH_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GENERIC_OAUTH_TOKEN_URL=https://github.com/login/oauth/access_token</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PROVIDERS_GENERIC_OAUTH_USER_URL=https://api.github.com/user</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SECRET=traefik</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>INSECURE_COOKIE=true</span> <span style=color:#75715e># 允许 HTTP 访问</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>COOKIE_DOMAIN=homelab.io</span> <span style=color:#75715e># 指定 Cookie 的域名</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>AUTH_HOST=auth.homelab.io</span> <span style=color:#75715e># 指定认证服务的域名</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/proxmox-ve-%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/><span>&larr;&nbsp;&nbsp;</span><span>Proxmox VE 安装初始化</span></a>
<a class=next href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%9F%B9%E6%AD%A3-pzem-004t-%E5%92%8C-homeassistant-%E7%9B%91%E6%B5%8B%E5%AE%B6%E5%BA%AD%E7%94%A8%E7%94%B5%E6%83%85%E5%86%B5/><span>使用培正 PZEM 004T 和 HomeAssistant 监测家庭用电情况</span><span>&nbsp;&nbsp;&rarr;</span></a></div><div class=related-resources></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>