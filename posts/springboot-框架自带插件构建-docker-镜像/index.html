<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>SpringBoot 框架自带插件构建 Docker 镜像</title>
<meta name=description content="Spring Boot 2.3.0 之后支持通过 buildpacks 插件构建 Docker 镜像，原理和执行过程与 Jib 类似，支持 Spring Boot 项目的分层构建，当代码改动后，只需更新代码部分，可以减少构建后 push 和 pull 镜像的时间，减少镜像存储的成本
底层是通过 Buildpacks 构 …"><meta name=keywords content='blog,hugo,SpringBoot,Docker'><meta property="og:url" content="https://blog.hellowood.dev/posts/springboot-%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E6%8F%92%E4%BB%B6%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F/"><meta property="og:type" content="website"><meta property="og:title" content="SpringBoot 框架自带插件构建 Docker 镜像"><meta property="og:description" content="Spring Boot 2.3.0 之后支持通过 buildpacks 插件构建 Docker 镜像，原理和执行过程与 Jib 类似，支持 Spring Boot 项目的分层构建，当代码改动后，只需更新代码部分，可以减少构建后 push 和 pull 镜像的时间，减少镜像存储的成本
底层是通过 Buildpacks 构 …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="SpringBoot 框架自带插件构建 Docker 镜像"><meta name=twitter:description content="Spring Boot 2.3.0 之后支持通过 buildpacks 插件构建 Docker 镜像，原理和执行过程与 Jib 类似，支持 Spring Boot 项目的分层构建，当代码改动后，只需更新代码部分，可以减少构建后 push 和 pull 镜像的时间，减少镜像存储的成本
底层是通过 Buildpacks 构 …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/springboot-%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E6%8F%92%E4%BB%B6%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/springboot-%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E6%8F%92%E4%BB%B6%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/springboot-%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E6%8F%92%E4%BB%B6%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>SpringBoot 框架自带插件构建 Docker 镜像</h1><small role=doc-subtitle></small><p class=post-date>2020-09-09
| Updated 2024-09-09</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/springboot>SpringBoot</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/docker>Docker</a></li></ul></div><div class=post-content><p>Spring Boot 2.3.0 之后支持通过 buildpacks 插件构建 Docker 镜像，原理和执行过程与 Jib 类似，支持 Spring Boot 项目的分层构建，当代码改动后，只需更新代码部分，可以减少构建后 push 和 pull 镜像的时间，减少镜像存储的成本</p><p>底层是通过 <a href=https://buildpacks.io/>Buildpacks</a> 构建，Buildpacks是 Dockerfile 的一个替代方案。Buildpacks 能够自动探测运行 Docker 容器中的应用时所需要的软件，例如，它会探测应用中所使用的 Java 版本，基于该版本，buildpack 会选择所指定的 JRE 并构建 Docker 镜像</p><h2 id=优点>优点</h2><ul><li>Spring Boot 编译插件集成，不需要额外的配置</li><li>JVM 参数计算，支持通过线程数量，类数量等，动态的计算适合的 JVM 参数</li><li>会在构建过程中加入 OOM Killer，当 OOM 时自动杀死应用</li></ul><h2 id=弊端>弊端</h2><ul><li>在镜像中指定了内存参数，CPU数量等</li><li>不能灵活添加自定义文件，只能添加应用中的文件为单独的层</li><li>构建镜像、运行镜像与 Buildpacks 强绑定，需要 Buildpacks 的参数才可以成功构建，如果要自定义信息，同样需要在基础镜像中加入 Buildpacks 的配置</li><li>不支持直接使用历史版本镜像的分层，当tag改变时会完全重新构建</li><li>builder 和 runImage 中的内容是动态下载的，访问 GitHub 可能失败，也不安全</li></ul><h2 id=使用>使用</h2><ol><li>更新 SpringBoot 版本为 2.3.2.RELEASE</li><li>启用分层</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#c1abea>bootJar</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>layered</span><span style=color:#c7bf54>()</span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>}</span>
</span></span></code></pre></div><ol start=3><li>执行构建</li></ol><p>会根据应用名称构建出一个镜像</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gradle buildImage
</span></span></code></pre></div><ol start=4><li>指定基础镜像、默认镜像以及镜像名称</li></ol><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#c1abea>bootBuildImage</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>builder</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;docker.io/hellowoodes/buildpacks-builer:base-platform-api-0.3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>runImage</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;docker.io/hellowoodes/buildpacks-run:base-cnb&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>imageName</span> <span style=color:#c7bf54>=</span> <span style=color:#63c381>&#34;docker.io/hellowoodes/${artifactId}:${version}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>environment</span> <span style=color:#c7bf54>=</span> <span style=color:#c7bf54>[</span>
</span></span><span style=display:flex><span>            <span style=color:#63c381>&#34;TZ&#34;</span>       <span style=color:#c7bf54>:</span> <span style=color:#63c381>&#34;Asia/Shanghai&#34;</span><span style=color:#c7bf54>,</span>
</span></span><span style=display:flex><span>            <span style=color:#63c381>&#34;JAVA_OPTS&#34;</span><span style=color:#c7bf54>:</span> <span style=color:#63c381>&#34;-Djava.security.egd=file:/dev/./urandom&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>}</span>
</span></span></code></pre></div><h2 id=自定义分层>自定义分层</h2><p>目前只支持两种 layer，分别是 application 和 dependencies</p><ul><li>application 只支持将项目目录下的文件打包到镜像中，格式为文件目录</li><li>dependencies 支持依赖，格式为 <code>groupId:artifactId:version</code></li></ul><p>共有4层，可以通过<code>java -Djarmode=layertools -jar image-0.0.1-SNAPSHOT.jar list</code> 查看：</p><ul><li>dependencies 正式版的依赖</li><li>spring-boot-loader SpringBoot 启动文件</li><li>snapshot-dependencies 快照版的依赖</li><li>application 应用文件，即编译后的类，resource下面的文件</li></ul><h3 id=添加新的-layer>添加新的 layer</h3><p>如需要将静态文件单独分为一个层，可以在 application 加入新的层的逻辑</p><p>需要注意的是，这个层的 layerOrder 得放到 application 层的前面，否则 application 层包含了所有的文件，这个层就找不到；因为文件的添加逻辑是先添加 include 中指定的，下一层如果没有指定则添加剩余的</p><p>暂时不支持将自定义的外部文件加入层中，需要自定义 buildpacks 才可以</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#c1abea>bootJar</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>layered</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>application</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>intoLayer</span><span style=color:#c7bf54>(</span><span style=color:#63c381>&#34;spring-boot-loader&#34;</span><span style=color:#c7bf54>)</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>include</span> <span style=color:#63c381>&#34;org/springframework/boot/loader/**&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 自定义 static 层，存放静态文件
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>            <span style=color:#c1abea>intoLayer</span><span style=color:#c7bf54>(</span><span style=color:#63c381>&#34;static&#34;</span><span style=color:#c7bf54>)</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>include</span> <span style=color:#63c381>&#34;static/**&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>intoLayer</span><span style=color:#c7bf54>(</span><span style=color:#63c381>&#34;application&#34;</span><span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>dependencies</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>intoLayer</span><span style=color:#c7bf54>(</span><span style=color:#63c381>&#34;snapshot-dependencies&#34;</span><span style=color:#c7bf54>)</span> <span style=color:#c7bf54>{</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>include</span> <span style=color:#63c381>&#34;*:*:*SNAPSHOT&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>intoLayer</span><span style=color:#c7bf54>(</span><span style=color:#63c381>&#34;dependencies&#34;</span><span style=color:#c7bf54>)</span>
</span></span><span style=display:flex><span>        <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>layerOrder</span> <span style=color:#c7bf54>=</span> <span style=color:#c7bf54>[</span><span style=color:#63c381>&#34;dependencies&#34;</span><span style=color:#c7bf54>,</span> <span style=color:#63c381>&#34;spring-boot-loader&#34;</span><span style=color:#c7bf54>,</span> <span style=color:#63c381>&#34;snapshot-dependencies&#34;</span><span style=color:#c7bf54>,</span> <span style=color:#63c381>&#34;static&#34;</span><span style=color:#c7bf54>,</span> <span style=color:#63c381>&#34;application&#34;</span><span style=color:#c7bf54>]</span>
</span></span><span style=display:flex><span>    <span style=color:#c7bf54>}</span>
</span></span><span style=display:flex><span><span style=color:#c7bf54>}</span>
</span></span></code></pre></div><h2 id=注意事项>注意事项</h2><ul><li>默认的用户是 cnb</li><li>启动方式不同，是通过启动JarLauncher 来启动应用</li><li>自定义 Builder 镜像和 Stack 可以参考 <a href=https://github.com/buildpacks/samples>buildpacks/samples</a></li><li>构建镜像和基础运行镜像默认从 gcr.io 下载</li></ul><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/gradle-plugin/reference/html/#build-image>Packaging OCI Images</a></li><li><a href=https://github.com/cloudfoundry/java-buildpack-memory-calculator>java-buildpack-memory-calculator</a></li><li><a href=https://github.com/bell-sw/Liberica>bell-sw/Liberica</a></li><li><a href=https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/considerations.html>HotSpot GC Tuning Guide</a></li><li><a href="https://docs.google.com/document/d/1vlXBiwRIjwiVcbvUGYMrxx2Aw1RVAtxq3iuZ3UK2vXA/edit#heading=h.uy41ishpv9zc">Java Buildpack Memory Calculator v3</a></li><li><a href=https://github.com/paketo-buildpacks/spring-boot>paketo-buildpacks/spring-boot</a></li><li><a href=https://spring.io/guides/topicals/spring-boot-docker>Spring Boot Docker</a></li><li><a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.3-Release-Notes>Spring-Boot-2.3-Release-Notes</a></li><li><a href=https://github.com/buildpacks/samples>buildpacks/samples</a></li><li><a href=https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/html/#packaging-layers-configuration>gradle-packaging-layers-configuration</a></li><li><a href=https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/html/#repackage-layers-configuration>maven-packaging-layers-configuration</a></li></ul></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>