<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>树莓派 4b 使用摄像头推送流到 RTMP 服务器</title>
<meta name=description content="使用树莓派 4b，基于 Ubuntu 22.04，将摄像头的监控内容推送到 RTMP 服务器，用于其他服务从 RTMP 获取视频，进行视频分析和事件告警ss
树莓派摄像头使用排线进行连接，通过 ffmpeg 将视频流推送到 SRS 服务器（SRS是一个简单高效的实时视频服务器，支 …"><meta name=keywords content='blog,hugo,RaspberryPi,HomeLab'><meta property="og:url" content="https://blog.hellowood.dev/posts/%E6%A0%91%E8%8E%93%E6%B4%BE-4b-%E4%BD%BF%E7%94%A8%E6%91%84%E5%83%8F%E5%A4%B4%E6%8E%A8%E9%80%81%E6%B5%81%E5%88%B0-rtmp-%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="og:type" content="website"><meta property="og:title" content="树莓派 4b 使用摄像头推送流到 RTMP 服务器"><meta property="og:description" content="使用树莓派 4b，基于 Ubuntu 22.04，将摄像头的监控内容推送到 RTMP 服务器，用于其他服务从 RTMP 获取视频，进行视频分析和事件告警ss
树莓派摄像头使用排线进行连接，通过 ffmpeg 将视频流推送到 SRS 服务器（SRS是一个简单高效的实时视频服务器，支 …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/%E6%A0%91%E8%8E%93%E6%B4%BE-4b-%E4%BD%BF%E7%94%A8%E6%91%84%E5%83%8F%E5%A4%B4%E6%8E%A8%E9%80%81%E6%B5%81%E5%88%B0-rtmp-%E6%9C%8D%E5%8A%A1%E5%99%A8/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>树莓派 4b 使用摄像头推送流到 RTMP 服务器</h1><small role=doc-subtitle></small><p class=post-date>2023-03-03</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/raspberrypi>RaspberryPi</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li></ul></div><div class=post-content><p>使用树莓派 4b，基于 Ubuntu 22.04，将摄像头的监控内容推送到 RTMP 服务器，用于其他服务从 RTMP 获取视频，进行视频分析和事件告警ss
树莓派摄像头使用排线进行连接，通过 ffmpeg 将视频流推送到 <a href=https://ossrs.io/lts/zh-cn/docs/v4/doc/introduction>SRS</a> 服务器（SRS是一个简单高效的实时视频服务器，支持RTMP/WebRTC/HLS/HTTP-FLV/SRT/GB28181）</p><p>树莓派连接摄像头可以参考 <a href=https://blog.hellowood.dev>树莓派 4b 使用摄像头</a></p><h2 id=安装-ffmpeg>安装 ffmpeg</h2><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt-get update <span style=color:#c7bf54>&amp;&amp;</span> apt-get install -y ffmpeg
</span></span></code></pre></div><h2 id=安装-srs>安装 SRS</h2><p>SRS 使用 Docker Compose 进行部署；用于处理 ffmpeg 推送的视频流</p><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>version</span>: <span style=color:#63c381>&#34;3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>srs</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#63c381>&#34;registry.cn-hangzhou.aliyuncs.com/ossrs/srs:4&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#63c381>&#34;srs&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>srs</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;1935:1935&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;1985:1985&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8080:8080&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;./data:/srs&#34;</span>
</span></span></code></pre></div><h2 id=使用-ffmpeg-推送流到-srs>使用 ffmpeg 推送流到 SRS</h2><p>通过 ffmpeg 将视频内容推送到 SRS</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ffmpeg -f v4l2 -input_format mjpeg -video_size 1280x720 -framerate <span style=color:#d19a66>30</span> -i /dev/video0 -c:v libx264 -preset veryfast -tune zerolatency -b:v 2M -minrate 2M -maxrate 2M -bufsize 1M -g <span style=color:#d19a66>60</span> -an -f flv rtmp://192.168.2.5/live/livestream
</span></span></code></pre></div><p>其各个参数含义如下：</p><ul><li><code>-f v4l2</code>：输入设备为 V4L2 （Video for Linux 2）摄像头。</li><li><code>-input_format mjpeg</code>：输入视频格式为 MJPEG。</li><li><code>-video_size 1280x720</code>：设置视频分辨率为 1280x720。</li><li><code>-framerate 30</code>：设置帧率为 30 帧每秒。</li><li><code>-i /dev/video0</code>：指定输入设备为 /dev/video0。</li><li><code>-c:v libx264</code>：选择 H.264 编码器用于视频编码。</li><li><code>-preset veryfast</code>：选用压缩速度优先的预设（veryfast 表示非常快）。</li><li><code>-tune zerolatency</code>：调整编码器以最小化延迟。</li><li><code>-b:v 2M</code>：设置视频编码的目标比特率为 2 Mbps。</li><li><code>-minrate 2M -maxrate 2M -bufsize 1M</code>：设置最小、最大比特率和缓存大小，以确保稳定的视频传输。</li><li><code>-g 60</code>：设置 GOP （Group of Pictures）大小为 60 帧。</li><li><code>-an</code>：不使用音频流。</li><li><code>-f flv</code>：输出格式为 Flash 视频（FLV）。</li><li><code>rtmp://192.168.2.5/live/livestream</code>：指定输出 URL，将视频流推送到 IP 地址为 192.168.2.5 的服务器上，路径为 /live/livestream。</li></ul><p>然后访问 <a href="http://rasp.local:8088/players/srs_player.html?autostart=true&amp;stream=livestream.flv&amp;port=8080&amp;schema=http">http://192.168.2.5:8080/players/srs_player.html?autostart=true&amp;stream=livestream.flv&amp;port=8080&amp;schema=http</a> 查看视频内容</p><h2 id=使用-docker-容器运行-ffmpeg>使用 Docker 容器运行 ffmpeg</h2><p>也可以通过 Docker 容器的方式运行 ffmpeg，基于 Ubuntu 的镜像安装 ffmpeg 即可</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>version: <span style=color:#98c379>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  srs:
</span></span><span style=display:flex><span>    image: <span style=color:#63c381>&#34;registry.cn-hangzhou.aliyuncs.com/ossrs/srs:4&#34;</span>
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span><span style=display:flex><span>    container_name: <span style=color:#63c381>&#34;srs&#34;</span>
</span></span><span style=display:flex><span>    hostname: srs
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;1935:1935&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;1985:1985&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8088:8080&#34;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;./data:/srs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ffmpeg:
</span></span><span style=display:flex><span>    image: <span style=color:#63c381>&#34;hellowoodes/ffmpeg-rasp&#34;</span>
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span><span style=display:flex><span>    container_name: <span style=color:#63c381>&#34;ffmpeg&#34;</span>
</span></span><span style=display:flex><span>    hostname: ffmpeg
</span></span><span style=display:flex><span>    extra_hosts:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;host.docker.internal:host-gateway&#34;</span>
</span></span><span style=display:flex><span>    command: &gt;
</span></span><span style=display:flex><span>      sh -c <span style=color:#63c381>&#34;ffmpeg -f v4l2 \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -input_format mjpeg \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -video_size 1920x1080 \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -framerate 24 \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -i /dev/video0 \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -c:v libx264 \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -preset veryfast \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -tune zerolatency \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -b:v 2M \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -minrate 2M \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -maxrate 2M \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -bufsize 1M \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -g 60 \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -an \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              -f flv \
</span></span></span><span style=display:flex><span><span style=color:#63c381>              rtmp://host.docker.internal/live/livestream&#34;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - /etc/localtime:/etc/localtime:ro
</span></span><span style=display:flex><span>    devices:
</span></span><span style=display:flex><span>      - /dev/video0:/dev/video0
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>