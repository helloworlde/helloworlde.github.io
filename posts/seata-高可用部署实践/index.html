<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Seata 高可用部署实践</title>
<meta charset=utf-8><meta name=description content="Ladder@Seata 高可用部署实践 使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将cloud-seata-nacos应用部署到 Kubernetes 集群中
该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务
准备工作 需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的
部署 Nacos 在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 192.168.199.2
docker run --name nacos -p 8848:8848 -e MODE=standalone nacos/nacos-server 部署 MySQL 部署一台MySQL 数据库，用于保存事务数据，服务器地址为 192.168.199.2
docker run --name mysql -p 30060:3306-e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.17 部署 seata-server 创建seata-server需要的表 具体的 SQL 参考 script/server/db，这里使用的是 MySQL 的脚本，数据库名称为 seata
同时，也需要创建 undo_log 表， 可以参考 script/client/at/db/"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/seata-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="Seata 高可用部署实践"><meta property="og:description" content="Seata 高可用部署实践 使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将cloud-seata-nacos应用部署到 Kubernetes 集群中
该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务
准备工作 需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的
部署 Nacos 在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 192.168.199.2
docker run --name nacos -p 8848:8848 -e MODE=standalone nacos/nacos-server 部署 MySQL 部署一台MySQL 数据库，用于保存事务数据，服务器地址为 192.168.199.2
docker run --name mysql -p 30060:3306-e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.17 部署 seata-server 创建seata-server需要的表 具体的 SQL 参考 script/server/db，这里使用的是 MySQL 的脚本，数据库名称为 seata
同时，也需要创建 undo_log 表， 可以参考 script/client/at/db/"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/seata-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-10T10:51:17+00:00"><meta property="article:modified_time" content="2020-04-10T10:51:17+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Seata 高可用部署实践"><meta name=twitter:description content="Seata 高可用部署实践 使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将cloud-seata-nacos应用部署到 Kubernetes 集群中
该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务
准备工作 需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的
部署 Nacos 在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 192.168.199.2
docker run --name nacos -p 8848:8848 -e MODE=standalone nacos/nacos-server 部署 MySQL 部署一台MySQL 数据库，用于保存事务数据，服务器地址为 192.168.199.2
docker run --name mysql -p 30060:3306-e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.17 部署 seata-server 创建seata-server需要的表 具体的 SQL 参考 script/server/db，这里使用的是 MySQL 的脚本，数据库名称为 seata
同时，也需要创建 undo_log 表， 可以参考 script/client/at/db/"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Seata 高可用部署实践","item":"https://blog.hellowood.dev/posts/seata-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Seata 高可用部署实践","name":"Seata 高可用部署实践","description":"Seata 高可用部署实践 使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将cloud-seata-nacos应用部署到 Kubernetes 集群中\n该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务\n准备工作 需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的\n部署 Nacos 在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 192.168.199.2\ndocker run --name nacos -p 8848:8848 -e MODE=standalone nacos/nacos-server 部署 MySQL 部署一台MySQL 数据库，用于保存事务数据，服务器地址为 192.168.199.2\ndocker run --name mysql -p 30060:3306-e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.17 部署 seata-server 创建seata-server需要的表 具体的 SQL 参考 script/server/db，这里使用的是 MySQL 的脚本，数据库名称为 seata\n同时，也需要创建 undo_log 表， 可以参考 script/client/at/db/","keywords":["Seata"],"articleBody":"Seata 高可用部署实践 使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将cloud-seata-nacos应用部署到 Kubernetes 集群中\n该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务\n准备工作 需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的\n部署 Nacos 在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 192.168.199.2\ndocker run --name nacos -p 8848:8848 -e MODE=standalone nacos/nacos-server 部署 MySQL 部署一台MySQL 数据库，用于保存事务数据，服务器地址为 192.168.199.2\ndocker run --name mysql -p 30060:3306-e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.17 部署 seata-server 创建seata-server需要的表 具体的 SQL 参考 script/server/db，这里使用的是 MySQL 的脚本，数据库名称为 seata\n同时，也需要创建 undo_log 表， 可以参考 script/client/at/db/\n修改seata-server配置 将以下配置添加到 Nacos 配置中心，具体添加方法可以参考 script/config-center\nservice.vgroupMapping.my_test_tx_group=default store.mode=db store.db.datasource=druid store.db.dbType=mysql store.db.driverClassName=com.mysql.jdbc.Driver store.db.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true store.db.user=root store.db.password=123456 部署 seata-server 到 Kubernetes seata-server.yaml 需要将 ConfigMap 的注册中心和配置中心地址改成相应的地址\napiVersion: v1 kind: Service metadata: name: seata-ha-server namespace: default labels: app.kubernetes.io/name: seata-ha-server spec: type: ClusterIP ports: - port: 8091 protocol: TCP name: http selector: app.kubernetes.io/name: seata-ha-server --- apiVersion: apps/v1 kind: StatefulSet metadata: name: seata-ha-server namespace: default labels: app.kubernetes.io/name: seata-ha-server spec: serviceName: seata-ha-server replicas: 3 selector: matchLabels: app.kubernetes.io/name: seata-ha-server template: metadata: labels: app.kubernetes.io/name: seata-ha-server spec: containers: - name: seata-ha-server image: docker.io/seataio/seata-server:latest imagePullPolicy: IfNotPresent env: - name: SEATA_CONFIG_NAME value: file:/root/seata-config/registry ports: - name: http containerPort: 8091 protocol: TCP volumeMounts: - name: seata-config mountPath: /root/seata-config volumes: - name: seata-config configMap: name: seata-ha-server-config --- apiVersion: v1 kind: ConfigMap metadata: name: seata-ha-server-config data: registry.conf: | registry { type = \"nacos\" nacos { application = \"seata-server\" serverAddr = \"192.168.199.2\" } } config { type = \"nacos\" nacos { serverAddr = \"192.168.199.2\" group = \"SEATA_GROUP\" } } 部署 kubectl apply -f seata-server.yaml 部署完成后，会有三个 pod\nkubectl get pod | grep seata-ha-server seata-ha-server-645844b8b6-9qh5j 1/1 Running 0 3m14s seata-ha-server-645844b8b6-pzczs 1/1 Running 0 3m14s seata-ha-server-645844b8b6-wkpw8 1/1 Running 0 3m14s 待启动完成后，可以在 Nacos 的服务列表中发现三个 seata-server 的实例，至此，已经完成 seata-server 的高可用部署\n查看服务日志 kubelet logs -f seata-ha-server-645844b8b6-9qh5j [0.012s][info ][gc] Using Serial 2020-04-15 00:55:09.880 INFO [main]io.seata.server.ParameterParser.init:90 -The server is running in container. 2020-04-15 00:55:10.013 INFO [main]io.seata.config.FileConfiguration.\u003cinit\u003e:110 -The configuration file used is file:/root/seata-config/registry.conf 2020-04-15 00:55:12.426 INFO [main]com.alibaba.druid.pool.DruidDataSource.init:947 -{dataSource-1} inited 2020-04-15 00:55:13.127 INFO [main]io.seata.core.rpc.netty.RpcServerBootstrap.start:155 -Server started 其中{dataSource-1} 说明使用了数据库，并正常初始化完成\n查看注册中心，此时seata-serve 这个服务会有三个实例 部署业务服务 创建业务表并初始化数据 具体的业务表可以参考 cloud-seata-nacos/README.md\n添加 Nacos 配置 在 public 的命名空间下，分别创建 data-id 为 order-service.properties, pay-service.properties, storage-service.properties 的配置，内容相同，需要修改数据库的地址、用户名和密码\n# MySQL spring.datasource.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false spring.datasource.username=root spring.datasource.password=123456 spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver # Seata spring.cloud.alibaba.seata.tx-service-group=my_test_tx_group 部署服务 通过 application.yaml 配置文件部署服务，需要注意的是修改 ConfigMap 的 NACOS_ADDR为自己的 Nacos 地址\napiVersion: v1 kind: Service metadata: namespace: default name: seata-ha-service labels: app.kubernetes.io/name: seata-ha-service spec: type: NodePort ports: - port: 8081 nodePort: 30081 protocol: TCP name: http selector: app.kubernetes.io/name: seata-ha-service --- apiVersion: v1 kind: ConfigMap metadata: name: seata-ha-service-config data: NACOS_ADDR: 192.168.199.2:8848 --- apiVersion: v1 kind: ServiceAccount metadata: name: seata-ha-account namespace: default --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: seata-ha-account roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: seata-ha-account namespace: default --- apiVersion: apps/v1 kind: Deployment metadata: namespace: default name: seata-ha-service labels: app.kubernetes.io/name: seata-ha-service spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: seata-ha-service template: metadata: labels: app.kubernetes.io/name: seata-ha-service spec: serviceAccountName: seata-ha-account containers: - name: seata-ha-order-service image: \"registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-order-service:1.1\" imagePullPolicy: IfNotPresent env: - name: NACOS_ADDR valueFrom: configMapKeyRef: key: NACOS_ADDR name: seata-ha-service-config ports: - name: http containerPort: 8081 protocol: TCP - name: seata-ha-pay-service image: \"registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-pay-service:1.1\" imagePullPolicy: IfNotPresent env: - name: NACOS_ADDR valueFrom: configMapKeyRef: key: NACOS_ADDR name: seata-ha-service-config ports: - name: http containerPort: 8082 protocol: TCP - name: seata-ha-storage-service image: \"registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-storage-service:1.1\" imagePullPolicy: IfNotPresent env: - name: NACOS_ADDR valueFrom: configMapKeyRef: key: NACOS_ADDR name: seata-ha-service-config ports: - name: http containerPort: 8083 protocol: TCP 通过以下命令，将应用部署到集群中\nkubectl apply -f application.yaml 然后查看创建的 pod，seata-ha-service 这个服务下有三个 pod\nkubectl get pod | grep seata-ha-service seata-ha-service-7dbdc6894b-5r8q4 3/3 Running 0 12m 待应用启动后，在 Nacos 的服务列表中，会有相应的服务\n此时查看服务的日志，会看到服务向每一个 TC 都注册了\nkubectl logs -f seata-ha-service-7dbdc6894b-5r8q4 seata-ha-order-service 查看任意的 TC 日志，会发现每一个服务都向 TC 注册了\nkubelet logs -f seata-ha-server-645844b8b6-9qh5j 测试 测试成功场景 调用下单接口，将 price 设置为 1，因为初始化的余额为 10，可以下单成功\ncurl -X POST \\ http://192.168.199.2:30081/order/placeOrder \\ -H 'Content-Type: application/json' \\ -d '{ \"userId\": 1, \"productId\": 1, \"price\": 1 }' 此时返回结果为：\n{\"success\":true,\"message\":null,\"data\":null} 查看TC 的日志，事务成功提交：\n查看 order-service 服务日志 测试失败场景 设置 price 为 100，此时余额不足，会下单失败抛出异常，事务会回滚\ncurl -X POST \\ http://192.168.199.2:30081/order/placeOrder \\ -H 'Content-Type: application/json' \\ -d '{ \"userId\": 1, \"productId\": 1, \"price\": 100 }' 查看 TC 的日志： 查看服务的日志 ： 多次调用查看服务日志，发现会随机的向其中某台TC发起事务注册，当扩容或缩容后，有相应的 TC 参与或退出，证明高可用部署生效\n","wordCount":"618","inLanguage":"en","datePublished":"2020-04-10T10:51:17Z","dateModified":"2020-04-10T10:51:17Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/seata-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Seata 高可用部署实践</h1></header><p><small>April 10, 2020&nbsp;· 618 words&nbsp;· 3 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#部署-seata-server>部署 seata-server</a><ul><li><a href=#部署-seata-server-到-kubernetes>部署 seata-server 到 Kubernetes</a></li></ul></li><li><a href=#部署业务服务>部署业务服务</a></li><li><a href=#测试>测试</a><ul><li><a href=#测试成功场景>测试成功场景</a></li><li><a href=#测试失败场景>测试失败场景</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=seata-高可用部署实践>Seata 高可用部署实践</h1><p>使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将<a href=https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/>cloud-seata-nacos</a>应用部署到 Kubernetes 集群中</p><p>该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务</p><h2 id=准备工作>准备工作</h2><p>需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的</p><ul><li>部署 Nacos</li></ul><p>在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 <code>192.168.199.2</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name nacos -p 8848:8848 -e MODE<span style=color:#f92672>=</span>standalone nacos/nacos-server
</span></span></code></pre></div><ul><li>部署 MySQL</li></ul><p>部署一台MySQL 数据库，用于保存事务数据，服务器地址为 <code>192.168.199.2</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name mysql -p 30060:3306-e MYSQL_ROOT_PASSWORD<span style=color:#f92672>=</span><span style=color:#ae81ff>123456</span> -d mysql:5.7.17
</span></span></code></pre></div><h2 id=部署-seata-server>部署 seata-server</h2><ul><li>创建seata-server需要的表</li></ul><p>具体的 SQL 参考 <a href=https://github.com/seata/seata/tree/develop/script/server/db>script/server/db</a>，这里使用的是 MySQL 的脚本，数据库名称为 <code>seata</code></p><p>同时，也需要创建 undo_log 表， 可以参考 <a href=https://github.com/seata/seata/blob/develop/script/client/at/db/>script/client/at/db/</a></p><ul><li>修改seata-server配置</li></ul><p>将以下配置添加到 Nacos 配置中心，具体添加方法可以参考 <a href=https://github.com/seata/seata/tree/develop/script/config-center>script/config-center</a></p><pre tabindex=0><code>service.vgroupMapping.my_test_tx_group=default
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver
store.db.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true
store.db.user=root
store.db.password=123456
</code></pre><h3 id=部署-seata-server-到-kubernetes>部署 seata-server 到 Kubernetes</h3><ul><li>seata-server.yaml</li></ul><p>需要将 ConfigMap 的注册中心和配置中心地址改成相应的地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8091</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-server</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/seataio/seata-server:latest</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>SEATA_CONFIG_NAME</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#ae81ff>file:/root/seata-config/registry</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8091</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-config</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/root/seata-config</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-server-config</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-server-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry.conf</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    registry {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type = &#34;nacos&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        nacos {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          application = &#34;seata-server&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          serverAddr = &#34;192.168.199.2&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    config {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      type = &#34;nacos&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      nacos {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        serverAddr = &#34;192.168.199.2&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        group = &#34;SEATA_GROUP&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }</span>    
</span></span></code></pre></div><ul><li>部署</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f seata-server.yaml
</span></span></code></pre></div><p>部署完成后，会有三个 pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pod | grep seata-ha-server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>seata-ha-server-645844b8b6-9qh5j    1/1     Running   <span style=color:#ae81ff>0</span>          3m14s
</span></span><span style=display:flex><span>seata-ha-server-645844b8b6-pzczs    1/1     Running   <span style=color:#ae81ff>0</span>          3m14s
</span></span><span style=display:flex><span>seata-ha-server-645844b8b6-wkpw8    1/1     Running   <span style=color:#ae81ff>0</span>          3m14s
</span></span></code></pre></div><p>待启动完成后，可以在 Nacos 的服务列表中发现三个 seata-server 的实例，至此，已经完成 seata-server 的高可用部署</p><ul><li>查看服务日志</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubelet logs -f seata-ha-server-645844b8b6-9qh5j
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>[</span>0.<span style=color:#a6e22e>012s</span><span style=color:#f92672>][</span>info   <span style=color:#f92672>][</span>gc<span style=color:#f92672>]</span> Using Serial
</span></span><span style=display:flex><span>2020<span style=color:#f92672>-</span>04<span style=color:#f92672>-</span>15 00:55:09.<span style=color:#a6e22e>880</span> INFO <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span>io.<span style=color:#a6e22e>seata</span>.<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>ParameterParser</span>.<span style=color:#a6e22e>init</span>:90 <span style=color:#f92672>-</span>The server is running in container.
</span></span><span style=display:flex><span>2020<span style=color:#f92672>-</span>04<span style=color:#f92672>-</span>15 00:55:10.<span style=color:#a6e22e>013</span> INFO <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span>io.<span style=color:#a6e22e>seata</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>FileConfiguration</span>.<span style=color:#f92672>&lt;</span>init<span style=color:#f92672>&gt;</span>:110 <span style=color:#f92672>-</span>The configuration file used is file:<span style=color:#f92672>/</span>root<span style=color:#f92672>/</span>seata<span style=color:#f92672>-</span>config<span style=color:#f92672>/</span>registry.<span style=color:#a6e22e>conf</span>
</span></span><span style=display:flex><span>2020<span style=color:#f92672>-</span>04<span style=color:#f92672>-</span>15 00:55:12.<span style=color:#a6e22e>426</span> INFO <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span>com.<span style=color:#a6e22e>alibaba</span>.<span style=color:#a6e22e>druid</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>DruidDataSource</span>.<span style=color:#a6e22e>init</span>:947 <span style=color:#f92672>-</span>{dataSource<span style=color:#f92672>-</span>1} inited
</span></span><span style=display:flex><span>2020<span style=color:#f92672>-</span>04<span style=color:#f92672>-</span>15 00:55:13.<span style=color:#a6e22e>127</span> INFO <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span>io.<span style=color:#a6e22e>seata</span>.<span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>rpc</span>.<span style=color:#a6e22e>netty</span>.<span style=color:#a6e22e>RpcServerBootstrap</span>.<span style=color:#a6e22e>start</span>:155 <span style=color:#f92672>-</span>Server started 
</span></span></code></pre></div><p>其中<code>{dataSource-1} </code>说明使用了数据库，并正常初始化完成</p><ul><li>查看注册中心，此时seata-serve 这个服务会有三个实例</li></ul><p><img alt=seata-ha-nacos-list.png src=https://img.hellowood.dev/picture/seata-ha-nacos-list.png></p><h2 id=部署业务服务>部署业务服务</h2><ul><li>创建业务表并初始化数据</li></ul><p>具体的业务表可以参考 <a href=https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/README.md>cloud-seata-nacos/README.md</a></p><ul><li>添加 Nacos 配置</li></ul><p>在 public 的命名空间下，分别创建 data-id 为 <code>order-service.properties</code>, <code>pay-service.properties</code>, <code>storage-service.properties</code> 的配置，内容相同，需要修改数据库的地址、用户名和密码</p><pre tabindex=0><code># MySQL
spring.datasource.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
# Seata
spring.cloud.alibaba.seata.tx-service-group=my_test_tx_group
</code></pre><ul><li>部署服务</li></ul><p>通过 application.yaml 配置文件部署服务，需要注意的是修改 ConfigMap 的 <code>NACOS_ADDR</code>为自己的 Nacos 地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30081</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-service-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>NACOS_ADDR</span>: <span style=color:#ae81ff>192.168.199.2</span>:<span style=color:#ae81ff>8848</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-account</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-account</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cluster-admin</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-account</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>seata-ha-service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>seata-ha-account</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-order-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-order-service:1.1&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NACOS_ADDR</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>key</span>: <span style=color:#ae81ff>NACOS_ADDR</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-service-config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-pay-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-pay-service:1.1&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NACOS_ADDR</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>key</span>: <span style=color:#ae81ff>NACOS_ADDR</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-service-config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8082</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-storage-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-storage-service:1.1&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NACOS_ADDR</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>key</span>: <span style=color:#ae81ff>NACOS_ADDR</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-ha-service-config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8083</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span></code></pre></div><p>通过以下命令，将应用部署到集群中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f application.yaml
</span></span></code></pre></div><p>然后查看创建的 pod，seata-ha-service 这个服务下有三个 pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pod | grep seata-ha-service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>seata-ha-service-7dbdc6894b-5r8q4      3/3     Running   <span style=color:#ae81ff>0</span>          12m
</span></span></code></pre></div><p>待应用启动后，在 Nacos 的服务列表中，会有相应的服务</p><p><img alt=seata-ha-service-list.png src=https://img.hellowood.dev/picture/seata-ha-service-list.png></p><p>此时查看服务的日志，会看到服务向每一个 TC 都注册了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs -f seata-ha-service-7dbdc6894b-5r8q4 seata-ha-order-service
</span></span></code></pre></div><p><img alt=seata-ha-service-register.png src=https://img.hellowood.dev/picture/seata-ha-service-register.png></p><p>查看任意的 TC 日志，会发现每一个服务都向 TC 注册了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubelet logs -f seata-ha-server-645844b8b6-9qh5j
</span></span></code></pre></div><p><img alt=seata-ha-tc-register.png src=https://img.hellowood.dev/picture/seata-ha-tc-register.png></p><h2 id=测试>测试</h2><h3 id=测试成功场景>测试成功场景</h3><p>调用下单接口，将 price 设置为 1，因为初始化的余额为 10，可以下单成功</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  http://192.168.199.2:30081/order/placeOrder <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;userId&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;productId&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;price&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><p>此时返回结果为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;success&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;message&#34;</span>:<span style=color:#66d9ef>null</span>,<span style=color:#f92672>&#34;data&#34;</span>:<span style=color:#66d9ef>null</span>}
</span></span></code></pre></div><p>查看TC 的日志，事务成功提交：</p><p><img alt=seata-ha-commit-tc-success.png src=https://img.hellowood.dev/picture/seata-ha-commit-tc-success.png></p><p>查看 order-service 服务日志
<img alt=seata-ha-commit-success.png src=https://img.hellowood.dev/picture/seata-ha-commit-success.png></p><h3 id=测试失败场景>测试失败场景</h3><p>设置 price 为 100，此时余额不足，会下单失败抛出异常，事务会回滚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  http://192.168.199.2:30081/order/placeOrder <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;userId&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;productId&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;price&#34;: 100
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><p>查看 TC 的日志：
<img alt=seata-ha-commit-tc-rollback.png src=https://img.hellowood.dev/picture/seata-ha-commit-tc-rollback.png></p><p>查看服务的日志 ：
<img alt=seata-ha-commit-service-rollback.png src=https://img.hellowood.dev/picture/seata-ha-commit-service-rollback.png></p><p>多次调用查看服务日志，发现会随机的向其中某台TC发起事务注册，当扩容或缩容后，有相应的 TC 参与或退出，证明高可用部署生效</p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-prometheus-%E5%92%8C-grafana-%E7%9B%91%E6%8E%A7-consul/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>使用 Prometheus 和 Grafana 监控 Consul</span></a>
<a class=next href=https://blog.hellowood.dev/posts/kubernetes-%E4%B8%AD%E4%BD%BF%E7%94%A8-helm-%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8-prometheus/><span>Kubernetes 中使用 Helm 部署使用 Prometheus</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>