<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Kubernetes 中使用 Helm 部署使用 Prometheus</title>
<meta charset=utf-8><meta name=description content="Ladder@Kubernetes 中使用 Helm 部署使用 Prometheus 使用 Helm 在 Kubernetes 中部署 Prometheus，并使用 Grafana 监控集群状态，Helm 版本为 Helm3
安装 Prometheus 和 Grafana 添加标准仓库 如果没有 stable 仓库，会提示找不到 prometheus-operator这个应用，需要先添加stable 仓库：
helm repo add stable https://kubernetes-charts.storage.googleapis.com 安装 Prometheus 使用参数指定配置 指定节点的端口用于在集群外的机器访问
helm install prometheus stable/prometheus-operator \ --set prometheus.service.type=NodePort \ --set prometheus.service.nodePort=30090 \ --set grafana.service.type=NodePort \ --set grafana.service.nodePort=30080 \ --set grafana.adminPassword=admin 指定配置文件安装 如果有需要自定义的配置，可以下载应用后修改values.yaml，然后指定该配置文件进行安装 values.yaml
prometheus: service: nodePort: 30090 type: NodePort grafana: service: nodePort: 30080 type: NodePort adminPassword: admin 安装"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/kubernetes-%E4%B8%AD%E4%BD%BF%E7%94%A8-helm-%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8-prometheus/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/kubernetes-%E4%B8%AD%E4%BD%BF%E7%94%A8-helm-%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8-prometheus/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="Kubernetes 中使用 Helm 部署使用 Prometheus"><meta property="og:description" content="Kubernetes 中使用 Helm 部署使用 Prometheus 使用 Helm 在 Kubernetes 中部署 Prometheus，并使用 Grafana 监控集群状态，Helm 版本为 Helm3
安装 Prometheus 和 Grafana 添加标准仓库 如果没有 stable 仓库，会提示找不到 prometheus-operator这个应用，需要先添加stable 仓库：
helm repo add stable https://kubernetes-charts.storage.googleapis.com 安装 Prometheus 使用参数指定配置 指定节点的端口用于在集群外的机器访问
helm install prometheus stable/prometheus-operator \ --set prometheus.service.type=NodePort \ --set prometheus.service.nodePort=30090 \ --set grafana.service.type=NodePort \ --set grafana.service.nodePort=30080 \ --set grafana.adminPassword=admin 指定配置文件安装 如果有需要自定义的配置，可以下载应用后修改values.yaml，然后指定该配置文件进行安装 values.yaml
prometheus: service: nodePort: 30090 type: NodePort grafana: service: nodePort: 30080 type: NodePort adminPassword: admin 安装"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-29T18:57:38+00:00"><meta property="article:modified_time" content="2019-12-29T18:57:38+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Helm"><meta property="article:tag" content="Prometheus"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes 中使用 Helm 部署使用 Prometheus"><meta name=twitter:description content="Kubernetes 中使用 Helm 部署使用 Prometheus 使用 Helm 在 Kubernetes 中部署 Prometheus，并使用 Grafana 监控集群状态，Helm 版本为 Helm3
安装 Prometheus 和 Grafana 添加标准仓库 如果没有 stable 仓库，会提示找不到 prometheus-operator这个应用，需要先添加stable 仓库：
helm repo add stable https://kubernetes-charts.storage.googleapis.com 安装 Prometheus 使用参数指定配置 指定节点的端口用于在集群外的机器访问
helm install prometheus stable/prometheus-operator \ --set prometheus.service.type=NodePort \ --set prometheus.service.nodePort=30090 \ --set grafana.service.type=NodePort \ --set grafana.service.nodePort=30080 \ --set grafana.adminPassword=admin 指定配置文件安装 如果有需要自定义的配置，可以下载应用后修改values.yaml，然后指定该配置文件进行安装 values.yaml
prometheus: service: nodePort: 30090 type: NodePort grafana: service: nodePort: 30080 type: NodePort adminPassword: admin 安装"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Kubernetes 中使用 Helm 部署使用 Prometheus","item":"https://blog.hellowood.dev/posts/kubernetes-%E4%B8%AD%E4%BD%BF%E7%94%A8-helm-%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8-prometheus/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes 中使用 Helm 部署使用 Prometheus","name":"Kubernetes 中使用 Helm 部署使用 Prometheus","description":"Kubernetes 中使用 Helm 部署使用 Prometheus 使用 Helm 在 Kubernetes 中部署 Prometheus，并使用 Grafana 监控集群状态，Helm 版本为 Helm3\n安装 Prometheus 和 Grafana 添加标准仓库 如果没有 stable 仓库，会提示找不到 prometheus-operator这个应用，需要先添加stable 仓库：\nhelm repo add stable https://kubernetes-charts.storage.googleapis.com 安装 Prometheus 使用参数指定配置 指定节点的端口用于在集群外的机器访问\nhelm install prometheus stable/prometheus-operator \\ --set prometheus.service.type=NodePort \\ --set prometheus.service.nodePort=30090 \\ --set grafana.service.type=NodePort \\ --set grafana.service.nodePort=30080 \\ --set grafana.adminPassword=admin 指定配置文件安装 如果有需要自定义的配置，可以下载应用后修改values.yaml，然后指定该配置文件进行安装 values.yaml\nprometheus: service: nodePort: 30090 type: NodePort grafana: service: nodePort: 30080 type: NodePort adminPassword: admin 安装","keywords":["Kubernetes","Helm","Prometheus"],"articleBody":"Kubernetes 中使用 Helm 部署使用 Prometheus 使用 Helm 在 Kubernetes 中部署 Prometheus，并使用 Grafana 监控集群状态，Helm 版本为 Helm3\n安装 Prometheus 和 Grafana 添加标准仓库 如果没有 stable 仓库，会提示找不到 prometheus-operator这个应用，需要先添加stable 仓库：\nhelm repo add stable https://kubernetes-charts.storage.googleapis.com 安装 Prometheus 使用参数指定配置 指定节点的端口用于在集群外的机器访问\nhelm install prometheus stable/prometheus-operator \\ --set prometheus.service.type=NodePort \\ --set prometheus.service.nodePort=30090 \\ --set grafana.service.type=NodePort \\ --set grafana.service.nodePort=30080 \\ --set grafana.adminPassword=admin 指定配置文件安装 如果有需要自定义的配置，可以下载应用后修改values.yaml，然后指定该配置文件进行安装 values.yaml\nprometheus: service: nodePort: 30090 type: NodePort grafana: service: nodePort: 30080 type: NodePort adminPassword: admin 安装\nhelm install prometheus stable/prometheus-operator -f values.yaml 如果有更多配置项，可以通过下载 Helm 的安装包，解压后自己修改：\nhelm fetch stable/prometheus-operator 手动修改 SVC 如果在安装时没有指定使用节点端口，也可以手动修改 SVC，配置为节点端口：\n修改 prometheus kubectl edit svc prometheus-prometheus-oper-prometheus 将 spec.type修改为 NodePort，并添加nodePort到 spec.ports中\nspec: externalTrafficPolicy: Cluster ports: - name: web nodePort: 30090 port: 9090 protocol: TCP targetPort: 9090 selector: app: prometheus prometheus: prometheus-prometheus-oper-prometheus sessionAffinity: None type: NodePort 修改 Grafana kubectl edit svc prometheus-grafana spec: externalTrafficPolicy: Cluster ports: - name: service nodePort: 30080 port: 80 protocol: TCP targetPort: 3000 selector: app: grafana release: prometheus sessionAffinity: None type: NodePort 配置监控 Prometheus 默认监控了 Kubernetes 和 Node，可以直接访问节点进行查看，如直接访问 http://192.168.199.2:30090/graph\n使用 Prometheus 查询 通过 PromQL 查询指定的指标，可以查看数据所对应的图表，以节点 15分钟的 CPU 为例：可以直接输入node_load15查询，也可以从下拉框中选择，然后点击 Execute 生成图表：\n使用 Grafana 查询 Prometheus 查询只能查看指定的指标，如果想要查看多个指标的聚合，或者更复杂的图表，就需要使用 Grafana 来配置查询\n访问 Grafana 对应的节点，如http://192.168.199.2:30080/?orgId=1，会要求输入用户名密码，默认的用户名为 admin，如果没有指定grafana.adminPassword设置密码，则密码为prom-operator\n配置自定义监控 点击左侧的加号，选择 Dashboard，添加新的查询，并输入相应的 PromQL 查询即可看到相应的指标\n之后修改名称等其他设置，保存后就可以在面板中看到该监控了\n导入监控面板 因为监控的配置项有很多，配置起来也很复杂，对于一些通用的监控，如节点的运行状态等，可以直接使用已有的面板作为监控\n在https://grafana.com/grafana/dashboards 中选择需要的监控，并复制面板的 id，在Grafana 首页点击加号后选择导入，输入 id 即可导入已有的面板，如已 11074这个面板为例：\n","wordCount":"195","inLanguage":"en","datePublished":"2019-12-29T18:57:38Z","dateModified":"2019-12-29T18:57:38Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/kubernetes-%E4%B8%AD%E4%BD%BF%E7%94%A8-helm-%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8-prometheus/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.7f82854fa0e999ec07c4835d3029de9f484030e254b80d470b3ca48eb934720e.css integrity="sha256-f4KFT6DpmewHxINdMCnen0hAMOJUuA1HCzykjrk0cg4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script defer src=https://analytics.us.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Kubernetes 中使用 Helm 部署使用 Prometheus</h1></header><p><small>December 29, 2019&nbsp;· 195 words&nbsp;· One minute</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#安装-prometheus-和-grafana>安装 Prometheus 和 Grafana</a><ul><li><a href=#添加标准仓库>添加标准仓库</a></li><li><a href=#安装-prometheus>安装 Prometheus</a></li></ul></li><li><a href=#配置监控>配置监控</a><ul><li><a href=#使用-prometheus-查询>使用 Prometheus 查询</a></li><li><a href=#使用-grafana-查询>使用 Grafana 查询</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=kubernetes-中使用-helm-部署使用-prometheus>Kubernetes 中使用 Helm 部署使用 Prometheus</h1><blockquote><p>使用 Helm 在 Kubernetes 中部署 Prometheus，并使用 Grafana 监控集群状态，Helm 版本为 Helm3</p></blockquote><h2 id=安装-prometheus-和-grafana>安装 Prometheus 和 Grafana</h2><h3 id=添加标准仓库>添加标准仓库</h3><p>如果没有 stable 仓库，会提示找不到 <code>prometheus-operator</code>这个应用，需要先添加stable 仓库：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add stable https://kubernetes-charts.storage.googleapis.com
</span></span></code></pre></div><h3 id=安装-prometheus>安装 Prometheus</h3><h4 id=使用参数指定配置>使用参数指定配置</h4><p>指定节点的端口用于在集群外的机器访问</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install prometheus stable/prometheus-operator <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--set prometheus.service.type<span style=color:#f92672>=</span>NodePort <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--set prometheus.service.nodePort<span style=color:#f92672>=</span><span style=color:#ae81ff>30090</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--set grafana.service.type<span style=color:#f92672>=</span>NodePort <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--set grafana.service.nodePort<span style=color:#f92672>=</span><span style=color:#ae81ff>30080</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--set grafana.adminPassword<span style=color:#f92672>=</span>admin
</span></span></code></pre></div><h4 id=指定配置文件安装>指定配置文件安装</h4><ul><li>如果有需要自定义的配置，可以下载应用后修改<code>values.yaml</code>，然后指定该配置文件进行安装</li></ul><p>values.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>prometheus</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30090</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>grafana</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>adminPassword</span>: <span style=color:#ae81ff>admin</span>
</span></span></code></pre></div><p>安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install prometheus stable/prometheus-operator -f values.yaml
</span></span></code></pre></div><p>如果有更多配置项，可以通过下载 Helm 的安装包，解压后自己修改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm fetch stable/prometheus-operator
</span></span></code></pre></div><h4 id=手动修改-svc>手动修改 SVC</h4><p>如果在安装时没有指定使用节点端口，也可以手动修改 SVC，配置为节点端口：</p><h5 id=修改-prometheus>修改 prometheus</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit svc prometheus-prometheus-oper-prometheus
</span></span></code></pre></div><p>将 <code>spec.type</code>修改为 <code>NodePort</code>，并添加<code>nodePort</code>到 <code>spec.ports</code>中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>externalTrafficPolicy</span>: <span style=color:#ae81ff>Cluster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30090</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9090</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>9090</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>prometheus</span>: <span style=color:#ae81ff>prometheus-prometheus-oper-prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><h5 id=修改-grafana>修改 Grafana</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit svc prometheus-grafana
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>externalTrafficPolicy</span>: <span style=color:#ae81ff>Cluster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>30080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>grafana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>release</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><h2 id=配置监控>配置监控</h2><p>Prometheus 默认监控了 Kubernetes 和 Node，可以直接访问节点进行查看，如直接访问 <a href=http://192.168.199.2:30090/graph>http://192.168.199.2:30090/graph</a></p><p><img alt=prometheus-homepage.png src=https://img.hellowood.dev/picture/prometheus-homepage.png></p><h3 id=使用-prometheus-查询>使用 Prometheus 查询</h3><p>通过 PromQL 查询指定的指标，可以查看数据所对应的图表，以节点 15分钟的 CPU 为例：可以直接输入<code>node_load15</code>查询，也可以从下拉框中选择，然后点击 Execute 生成图表：</p><p><img alt=prometheus-graph.png src=https://img.hellowood.dev/picture/prometheus-graph.png></p><h3 id=使用-grafana-查询>使用 Grafana 查询</h3><p>Prometheus 查询只能查看指定的指标，如果想要查看多个指标的聚合，或者更复杂的图表，就需要使用 Grafana 来配置查询</p><p>访问 Grafana 对应的节点，如<a href=http://192.168.199.2:30080/>http://192.168.199.2:30080/?orgId=1</a>，会要求输入用户名密码，默认的用户名为 <code>admin</code>，如果没有指定<code>grafana.adminPassword</code>设置密码，则密码为<code>prom-operator</code></p><p><img alt=grafana-homepage.png src=https://img.hellowood.dev/picture/grafana-homepage.png></p><h4 id=配置自定义监控>配置自定义监控</h4><p>点击左侧的加号，选择 Dashboard，添加新的查询，并输入相应的 PromQL 查询即可看到相应的指标</p><p><img alt=grafana-query.png src=https://img.hellowood.dev/picture/grafana-query.png></p><p>之后修改名称等其他设置，保存后就可以在面板中看到该监控了</p><h4 id=导入监控面板>导入监控面板</h4><p>因为监控的配置项有很多，配置起来也很复杂，对于一些通用的监控，如节点的运行状态等，可以直接使用已有的面板作为监控</p><p>在<a href=https://grafana.com/grafana/dashboards>https://grafana.com/grafana/dashboards</a> 中选择需要的监控，并复制面板的 id，在Grafana 首页点击加号后选择导入，输入 id 即可导入已有的面板，如已 <code>11074</code>这个面板为例：</p><p><img alt=grafana-import.png src=https://img.hellowood.dev/picture/grafana-import.png></p><p><img alt=grafana-import2.png src=https://img.hellowood.dev/picture/grafana-import2.png></p><p><img alt=grafana-import3.png src=https://img.hellowood.dev/picture/grafana-import3.png></p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/seata-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>Seata 高可用部署实践</span></a>
<a class=next href=https://blog.hellowood.dev/posts/%E6%A0%91%E8%8E%93%E6%B4%BE-4b-%E6%97%A0%E7%BD%91%E7%BA%BF%E5%AE%89%E8%A3%85-ubuntu-%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96/><span>树莓派 4b 无网线安装 Ubuntu 并初始化</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>