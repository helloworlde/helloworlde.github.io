<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Tailscale 使用 Derp Probe 检测自建的 Derper 服务器状态</title>
<meta name=description content="在使用服务器部署自建的 HomeLab Derp 服务器之后，偶尔会出现 Derp 服务器无法访问，因此想要监控 Derp 服务器的状态，进行延迟检测等；Tailscale 官方提供了 derpprobe 这个工具，可以对 Derp 服务器的 UDP/UDP6/TLS/MESH …"><meta name=keywords content='blog,hugo,HomeLab,Network'><meta property="og:url" content="https://blog.hellowood.dev/posts/tailscale-%E4%BD%BF%E7%94%A8-derp-probe-%E6%A3%80%E6%B5%8B%E8%87%AA%E5%BB%BA%E7%9A%84-derper-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81/"><meta property="og:type" content="website"><meta property="og:title" content="Tailscale 使用 Derp Probe 检测自建的 Derper 服务器状态"><meta property="og:description" content="在使用服务器部署自建的 HomeLab Derp 服务器之后，偶尔会出现 Derp 服务器无法访问，因此想要监控 Derp 服务器的状态，进行延迟检测等；Tailscale 官方提供了 derpprobe 这个工具，可以对 Derp 服务器的 UDP/UDP6/TLS/MESH …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Tailscale 使用 Derp Probe 检测自建的 Derper 服务器状态"><meta name=twitter:description content="在使用服务器部署自建的 HomeLab Derp 服务器之后，偶尔会出现 Derp 服务器无法访问，因此想要监控 Derp 服务器的状态，进行延迟检测等；Tailscale 官方提供了 derpprobe 这个工具，可以对 Derp 服务器的 UDP/UDP6/TLS/MESH …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/tailscale-%E4%BD%BF%E7%94%A8-derp-probe-%E6%A3%80%E6%B5%8B%E8%87%AA%E5%BB%BA%E7%9A%84-derper-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/tailscale-%E4%BD%BF%E7%94%A8-derp-probe-%E6%A3%80%E6%B5%8B%E8%87%AA%E5%BB%BA%E7%9A%84-derper-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/tailscale-%E4%BD%BF%E7%94%A8-derp-probe-%E6%A3%80%E6%B5%8B%E8%87%AA%E5%BB%BA%E7%9A%84-derper-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Tailscale 使用 Derp Probe 检测自建的 Derper 服务器状态</h1><small role=doc-subtitle></small><p class=post-date>2024-09-09</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/homelab>HomeLab</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/network>Network</a></li></ul></div><div class=post-content><p>在使用服务器部署自建的 HomeLab Derp 服务器之后，偶尔会出现 Derp 服务器无法访问，因此想要监控 Derp 服务器的状态，进行延迟检测等；Tailscale 官方提供了 <a href=https://github.com/tailscale/tailscale/blob/main/cmd/derpprobe/derpprobe.go>derpprobe</a> 这个工具，可以对 Derp 服务器的 UDP/UDP6/TLS/MESH 等协议以及带宽进行检测</p><p>自行部署 Derp Server 参考 <a href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%AE%B6%E5%BA%AD%E5%AE%BD%E5%B8%A6%E5%85%AC%E7%BD%91-ipv6-%E8%87%AA%E5%BB%BA-tailscale-%E7%9A%84-derp-%E8%8A%82%E7%82%B9/>使用家庭宽带公网 IPV6 自建 Tailscale 的 DERP 节点</a></p><h2 id=构建-docker-镜像>构建 Docker 镜像</h2><p>derpprobe 没有提供 docker 镜像，可以直接使用我构建的镜像 <code>ghcr.io/helloworlde/tailscale-derpprober:main</code>，跳过这一步；或者自行构建</p><ul><li>下载项目</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/tailscale/tailscale.git
</span></span></code></pre></div><ul><li>创建 Dockerfile</li></ul><p>进入项目下，并在根目录创建 Dockerfile.derpprobe 文件，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#c678dd>FROM</span><span style=color:#98c379> golang:1.23-alpine AS build-env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>WORKDIR</span><span style=color:#98c379> /go/src/tailscale</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>COPY</span> tailscale/go.mod tailscale/go.sum ./
</span></span><span style=display:flex><span><span style=color:#c678dd>RUN</span> go mod download
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>COPY</span> tailscale .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>ARG</span> TARGETARCH
</span></span><span style=display:flex><span><span style=color:#c678dd>RUN</span> <span style=color:#dcaeea>GOARCH</span><span style=color:#c7bf54>=</span><span style=color:#dcaeea>$TARGETARCH</span> go build -o  derpprobe cmd/derpprobe/derpprobe.go
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>FROM</span><span style=color:#98c379> alpine:3.18</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>RUN</span> apk add --no-cache ca-certificates
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>DERP_MAP</span><span style=color:#c7bf54>=</span>https://login.tailscale.com/derpmap/default
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>LISTEN</span><span style=color:#c7bf54>=</span>:8030
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>ONCE</span><span style=color:#c7bf54>=</span><span style=color:#ef8383>false</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>SPREAD</span><span style=color:#c7bf54>=</span><span style=color:#ef8383>false</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>INTERVAL</span><span style=color:#c7bf54>=</span>15s
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>MESH_INTERVAL</span><span style=color:#c7bf54>=</span>15s
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>STUN_INTERVAL</span><span style=color:#c7bf54>=</span>15s
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>TLS_INTERVAL</span><span style=color:#c7bf54>=</span>15s
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>BW_INTERVAL</span><span style=color:#c7bf54>=</span><span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>ENV</span> <span style=color:#dcaeea>BW_PROBE_SIZE_BYTES</span><span style=color:#c7bf54>=</span>1_000_000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>COPY</span> --from<span style=color:#c7bf54>=</span>build-env /go/src/tailscale/derpprobe /usr/local/bin/derpprobe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>ENTRYPOINT</span> <span style=color:#c7bf54>[</span><span style=color:#63c381>&#34;sh&#34;</span>, <span style=color:#63c381>&#34;-c&#34;</span>, <span style=color:#63c381>&#34;/usr/local/bin/derpprobe \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -derp-map=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>DERP_MAP</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -listen=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>LISTEN</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -once=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>ONCE</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -spread=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>SPREAD</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -interval=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>INTERVAL</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -mesh-interval=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>MESH_INTERVAL</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -stun-interval=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>STUN_INTERVAL</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -tls-interval=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>TLS_INTERVAL</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -bw-interval=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>BW_INTERVAL</span><span style=color:#98c379>}</span><span style=color:#63c381> \
</span></span></span><span style=display:flex><span><span style=color:#63c381>    -bw-probe-size-bytes=</span><span style=color:#98c379>${</span><span style=color:#dcaeea>BW_PROBE_SIZE_BYTES</span><span style=color:#98c379>}</span><span style=color:#63c381>&#34;</span><span style=color:#c7bf54>]</span>
</span></span></code></pre></div><ul><li>构建镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t derpprobe -f Dockerfile.derpprobe .
</span></span></code></pre></div><h2 id=部署>部署</h2><p>通过 docker compose 部署</p><h3 id=使用默认配置>使用默认配置</h3><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>derpprobe</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>ghcr.io/helloworlde/tailscale-derpprober:main</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8030:8030&#34;</span>
</span></span></code></pre></div><p>部署后，访问 8083 端口即可看到检查状态信息</p><p><img src=https://img.hellowood.dev/picture/homelab-tailscale-derp-probe-homepage.png alt=homelab-tailscale-derp-probe-homepage.png></p><h3 id=指定配置>指定配置</h3><p>可以通过 ENV 配置参数，如下：</p><table><thead><tr><th style=text-align:left>环境变量</th><th style=text-align:left>对应参数名称</th><th style=text-align:left>默认值</th><th style=text-align:left>解释说明</th></tr></thead><tbody><tr><td style=text-align:left>DERP_MAP</td><td style=text-align:left>derp-map</td><td style=text-align:left><a href=https://login.tailscale.com/derpmap/default>https://login.tailscale.com/derpmap/default</a></td><td style=text-align:left>derp 服务器信息，可以使用本地文件，或者指定为 local 从本地 tailscale 获取</td></tr><tr><td style=text-align:left>SPREAD</td><td style=text-align:left>spread</td><td style=text-align:left>true</td><td style=text-align:left>第一次探测前添加随机延迟间隔</td></tr><tr><td style=text-align:left>LISTEN</td><td style=text-align:left>listen</td><td style=text-align:left>:8030</td><td style=text-align:left>监听的 HTTP 端口</td></tr><tr><td style=text-align:left>INTERVAL</td><td style=text-align:left>interval</td><td style=text-align:left>15s</td><td style=text-align:left>udp/udp6 协议检测时间间隔</td></tr><tr><td style=text-align:left>MESH_INTERVAL</td><td style=text-align:left>mesh-interval</td><td style=text-align:left>15s</td><td style=text-align:left>mesh 协议检测时间间隔</td></tr><tr><td style=text-align:left>STUN_INTERVAL</td><td style=text-align:left>stun-interval</td><td style=text-align:left>15s</td><td style=text-align:left>STUN 协议检测时间间隔</td></tr><tr><td style=text-align:left>TLS_INTERVAL</td><td style=text-align:left>tls-interval</td><td style=text-align:left>15s</td><td style=text-align:left>TLS 协议检测时间间隔</td></tr><tr><td style=text-align:left>BW_INTERVAL</td><td style=text-align:left>bw-interval</td><td style=text-align:left>0</td><td style=text-align:left>带宽检测时间间隔</td></tr><tr><td style=text-align:left>BW_PROBE_SIZE_BYTES</td><td style=text-align:left>bw-probe-size-bytes</td><td style=text-align:left>1_000_000</td><td style=text-align:left>带宽检测的包大小</td></tr></tbody></table><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>derpprobe</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>ghcr.io/helloworlde/tailscale-derpprober:main</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>LISTEN=:8030</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>SPREAD=true</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>INTERVAL=60s</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>MESH_INTERVAL=60s</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>STUN_INTERVAL=60s</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>TLS_INTERVAL=60s</span>
</span></span><span style=display:flex><span>      - <span style=color:#98c379>BW_INTERVAL=600s</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8030:8030&#34;</span>
</span></span></code></pre></div><h3 id=使用自定义的-derp-map>使用自定义的 derp-map</h3><p>derp-map 包含 derp 服务器的信息，默认从 <a href=https://login.tailscale.com/derpmap/default>https://login.tailscale.com/derpmap/default</a> 获取，也可以自行指定地址；如果是本地文件，则需要添加 <code>files://</code> 前缀; 如仅测试自定义的 derp 服务器，配置可以参考: <a href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%AE%B6%E5%BA%AD%E5%AE%BD%E5%B8%A6%E5%85%AC%E7%BD%91-ipv6-%E8%87%AA%E5%BB%BA-tailscale-%E7%9A%84-derp-%E8%8A%82%E7%82%B9/>使用家庭宽带公网 IPV6 自建 Tailscale 的 DERP 节点</a> 的 &ldquo;修改 tailscale 配置&rdquo; 部分</p><p>需要注意的是，如果 IPV4/IPV6 地址不是固定的就不要添加到配置中，这样不会检测 udp 和 udp6 的延迟信息</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e06c75>&#34;Regions&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#e06c75>&#34;900&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#e06c75>&#34;RegionID&#34;</span>: <span style=color:#d19a66>900</span>,
</span></span><span style=display:flex><span>      <span style=color:#e06c75>&#34;RegionCode&#34;</span>: <span style=color:#63c381>&#34;homelab&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e06c75>&#34;RegionName&#34;</span>: <span style=color:#63c381>&#34;HomeLab&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e06c75>&#34;Nodes&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;Name&#34;</span>: <span style=color:#63c381>&#34;HomeLab Server&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;RegionID&#34;</span>: <span style=color:#d19a66>900</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;HostName&#34;</span>: <span style=color:#63c381>&#34;derp.xxx.xxx&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;CanPort80&#34;</span>: <span style=color:#b756ff;font-weight:700>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;DERPPort&#34;</span>: <span style=color:#d19a66>12345</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;IPv4&#34;</span>: <span style=color:#63c381>&#34;103.6.84.152&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;IPv6&#34;</span>: <span style=color:#63c381>&#34;2403:2500:8000:1::ef6&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e06c75>&#34;CanPort80&#34;</span>: <span style=color:#b756ff;font-weight:700>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>derpprobe</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>ghcr.io/helloworlde/tailscale-derpprober:main</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>DERP_MAP=file:///config/derpmap.json</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8030:8030&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>./config:/config</span>
</span></span></code></pre></div><p>如果想同时检测官方和自己部署的的 Derp 服务器，可以将配置写到同一个配置文件中，也可以通过本地的 Tailscale 进行获取，这样就要求 derpprobe 所在的服务器也是 Tailscale 的节点；</p><p>指定要读取的 DERP_MAP 是 local，并且将 Tailscale 的 socks 文件挂载到容器中即可</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>derpprobe</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>ghcr.io/helloworlde/tailscale-derpprober:main</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>DERP_MAP=local</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8030:8030&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>/var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock</span>
</span></span></code></pre></div><h3 id=使用-prometheus-抓取指标>使用 Prometheus 抓取指标</h3><p>derpprobe 支持 Prometheus 格式的指标，但是仅允许 debug 或者本地部署时使用，通过容器部署后不能直接访问；可以通过指定环境变量的方式实现；key 是 <code>TS_ALLOW_DEBUG_IP</code>, 值是 Prometheus 的地址</p><ul><li>docker-compose.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#e06c75>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#e06c75>derpprobe</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>image</span>: <span style=color:#98c379>ghcr.io/helloworlde/tailscale-derpprober:main</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>container_name</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>hostname</span>: <span style=color:#98c379>derpprobe</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>restart</span>: <span style=color:#98c379>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#98c379>TS_ALLOW_DEBUG_IP=192.168.65.3</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#63c381>&#34;8030:8030&#34;</span>
</span></span></code></pre></div><p>这样就可以通过 <a href=http://192.168.65.2:8030/debug/varz>http://192.168.65.2:8030/debug/varz</a> 路径获取 Prometheus 指标了，之后可以通过 Grafana 进行监控</p><p><img src=https://img.hellowood.dev/picture/homelab-tailscale-derp-probe-grafana-pannel.png alt=homelab-tailscale-derp-probe-grafana-pannel.png></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2024 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>