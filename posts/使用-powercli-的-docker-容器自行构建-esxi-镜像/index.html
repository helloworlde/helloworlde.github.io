<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像</title><meta charset=utf-8><meta name=description content="Ladder@使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像 参考 N5105 构建 ESXi 镜像，在使用 ESXi 7 时，基于 Windows 系统，使用 PowerCLI 为 ESXi 7 的镜像添加了 NVMe 和 Intel I225V 网卡的驱动；
虽然当时已经可以在 Linux 或者 MacOS 上使用 PowerShell，但是因为 PowerCLI 不支持 Core 版本的 PowerShell，会提示 Exception: The VMware.ImageBuilder module is not currently supported on the Core edition of PowerShell；导致只能使用 Windows 构建，对于没有 Windows 系统的用户非常不方便。
PowerCLI 新版本已经支持了 Core 版本的 PowerShell，因此可以通过在 Linux/MacOS/Docker 等平台直接构建 ESXi 镜像；
本次使用 PowerCLI 的 Docker 容器，为 ESXi 8 镜像添加 NVMe 和网卡驱动"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-powercli-%E7%9A%84-docker-%E5%AE%B9%E5%99%A8%E8%87%AA%E8%A1%8C%E6%9E%84%E5%BB%BA-esxi-%E9%95%9C%E5%83%8F/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script>
<script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:title" content="使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像"><meta property="og:description" content="使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像 参考 N5105 构建 ESXi 镜像，在使用 ESXi 7 时，基于 Windows 系统，使用 PowerCLI 为 ESXi 7 的镜像添加了 NVMe 和 Intel I225V 网卡的驱动；
虽然当时已经可以在 Linux 或者 MacOS 上使用 PowerShell，但是因为 PowerCLI 不支持 Core 版本的 PowerShell，会提示 Exception: The VMware.ImageBuilder module is not currently supported on the Core edition of PowerShell；导致只能使用 Windows 构建，对于没有 Windows 系统的用户非常不方便。
PowerCLI 新版本已经支持了 Core 版本的 PowerShell，因此可以通过在 Linux/MacOS/Docker 等平台直接构建 ESXi 镜像；
本次使用 PowerCLI 的 Docker 容器，为 ESXi 8 镜像添加 NVMe 和网卡驱动"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-powercli-%E7%9A%84-docker-%E5%AE%B9%E5%99%A8%E8%87%AA%E8%A1%8C%E6%9E%84%E5%BB%BA-esxi-%E9%95%9C%E5%83%8F/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-07T21:45:26+08:00"><meta property="article:modified_time" content="2023-02-07T21:45:26+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像"><meta name=twitter:description content="使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像 参考 N5105 构建 ESXi 镜像，在使用 ESXi 7 时，基于 Windows 系统，使用 PowerCLI 为 ESXi 7 的镜像添加了 NVMe 和 Intel I225V 网卡的驱动；
虽然当时已经可以在 Linux 或者 MacOS 上使用 PowerShell，但是因为 PowerCLI 不支持 Core 版本的 PowerShell，会提示 Exception: The VMware.ImageBuilder module is not currently supported on the Core edition of PowerShell；导致只能使用 Windows 构建，对于没有 Windows 系统的用户非常不方便。
PowerCLI 新版本已经支持了 Core 版本的 PowerShell，因此可以通过在 Linux/MacOS/Docker 等平台直接构建 ESXi 镜像；
本次使用 PowerCLI 的 Docker 容器，为 ESXi 8 镜像添加 NVMe 和网卡驱动"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像","item":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-powercli-%E7%9A%84-docker-%E5%AE%B9%E5%99%A8%E8%87%AA%E8%A1%8C%E6%9E%84%E5%BB%BA-esxi-%E9%95%9C%E5%83%8F/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像","name":"使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像","description":"使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像 参考 N5105 构建 ESXi 镜像，在使用 ESXi 7 时，基于 Windows 系统，使用 PowerCLI 为 ESXi 7 的镜像添加了 NVMe 和 Intel I225V 网卡的驱动；\n虽然当时已经可以在 Linux 或者 MacOS 上使用 PowerShell，但是因为 PowerCLI 不支持 Core 版本的 PowerShell，会提示 Exception: The VMware.ImageBuilder module is not currently supported on the Core edition of PowerShell；导致只能使用 Windows 构建，对于没有 Windows 系统的用户非常不方便。\nPowerCLI 新版本已经支持了 Core 版本的 PowerShell，因此可以通过在 Linux/MacOS/Docker 等平台直接构建 ESXi 镜像；\n本次使用 PowerCLI 的 Docker 容器，为 ESXi 8 镜像添加 NVMe 和网卡驱动","keywords":["Esxi","HomeLab"],"articleBody":"使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像 参考 N5105 构建 ESXi 镜像，在使用 ESXi 7 时，基于 Windows 系统，使用 PowerCLI 为 ESXi 7 的镜像添加了 NVMe 和 Intel I225V 网卡的驱动；\n虽然当时已经可以在 Linux 或者 MacOS 上使用 PowerShell，但是因为 PowerCLI 不支持 Core 版本的 PowerShell，会提示 Exception: The VMware.ImageBuilder module is not currently supported on the Core edition of PowerShell；导致只能使用 Windows 构建，对于没有 Windows 系统的用户非常不方便。\nPowerCLI 新版本已经支持了 Core 版本的 PowerShell，因此可以通过在 Linux/MacOS/Docker 等平台直接构建 ESXi 镜像；\n本次使用 PowerCLI 的 Docker 容器，为 ESXi 8 镜像添加 NVMe 和网卡驱动\n1. 下载所需的镜像和驱动 1.1 申请 ESXi 授权 ESXi 需要先注册申请，等待人工审核通过后就可以下载免费版本；如果没有任何反馈，可以点击申请页下面的 Contact us 提工单给 VMWare；\n可以在 VMware vSphere Hypervisor (ESXi) 8.0.0 页面申请 8.0 版本的下载；选择 Offline Bundle 的压缩文件\n1.2 下载 NVME 社区驱动 从 Community NVMe Driver for ESXi 下载 NVME 驱动 1.3 下载网卡社区驱动 从 Community Networking Driver for ESXi 下载网卡驱动，该驱动包含 Intel I225-V 网卡的驱动\n2. 启动 PowerCLI 容器并挂载镜像和驱动 下载完镜像和驱动后，最好放到单独的目录下，方便容器进行挂载；比如镜像和驱动都放在 ~/Downloads/ESXi路径下\n启动 PowerCLI 容器并挂载镜像和驱动 将镜像文件挂载到 /data目录下，并进入容器的 bash\ndocker run --name powercli \\ --rm -it \\ -v ~/Downloads/ESXi:/data/ \\ docker.io/vmware/powerclicore \\ bash 进入 PowerShell pwsh PowerShell 7.2.7 Copyright (c) Microsoft Corporation. https://aka.ms/powershell Type 'help' to get help. PS /data\u003e 3. 将驱动添加到镜像文件中 3.1 将压缩文件添加到当前 PowerShell Session 中 添加 Esxi Add-EsxSoftwareDepot /data/VMware-ESXi-8.0-20513097-depot.zip 返回结果：\nDepot Url --------- zip:/data/VMware-ESXi-8.0-20513097-depot.zip?index.xml 添加网卡驱动 Add-EsxSoftwareDepot /data/Net-Community-Driver_1.2.7.0-1vmw.700.1.0.15843807_19480755.zip 返回结果：\nDepot Url --------- zip:/data/Net-Community-Driver_1.2.7.0-1vmw.700.1.0.15843807_19480755.zip?index.xml 添加 NVME 驱动 Add-EsxSoftwareDepot /data/nvme-community-driver_1.0.1.0-3vmw.700.1.0.15843807-component-18902434.zip 返回结果：\nDepot Url --------- zip:/data/nvme-community-driver_1.0.1.0-3vmw.700.1.0.15843807-component-18902434.zip?index.xml 3.2 获取当前的镜像 Get-EsxImageProfile 返回结果如下，其中 Name 在后续使用中需要用到\nName Vendor Last Modified Acceptance Level ---- ------ ------------- ---------------- ESXi-8.0.0-20513097-no-tools VMware, Inc. 9/23/2022 6:59… PartnerSupported ESXi-8.0.0-20513097-standard VMware, Inc. 9/23/2022 6:59… PartnerSupported 3.3 复制新的镜像，并添加驱动 复制镜像 基于当前的 ESXi 镜像，复制新的镜像，指定名称和租户，便于后面区分\nNew-EsxImageProfile -CloneProfile 'ESXi-8.0.0-20513097-standard' -name 'ESXi-8.0.0-20513097-standard-nvme-net' -vendor 'hellowood' 返回结果如下：\nName Vendor Last Modified Acceptance Level ---- ------ ------------- ---------------- ESXi-8.0.0-20513097-standard-… hellowood 9/23/2022 6:59… PartnerSupported 添加网卡驱动 使用复制镜像时使用的名称 ESXi-8.0.0-20513097-standard-nvme-net，将网卡驱动 net-community 添加到镜像中\nAdd-EsxSoftwarePackage -ImageProfile 'ESXi-8.0.0-20513097-standard-nvme-net' -SoftwarePackage 'net-community' 返回结果：\nName Vendor Last Modified Acceptance Level ---- ------ ------------- ---------------- ESXi-8.0.0-20513097-standard-… hellowood 2/6/2023 5:50:… PartnerSupported 添加 NVMe 驱动 使用复制镜像时使用的名称 ESXi-8.0.0-20513097-standard-nvme-net，将 NVMe 驱动 nvme -community 添加到镜像中\nAdd-EsxSoftwarePackage -ImageProfile 'ESXi-8.0.0-20513097-standard-nvme-net' -SoftwarePackage 'nvme-community' 返回结果：\nName Vendor Last Modified Acceptance Level ---- ------ ------------- ---------------- ESXi-8.0.0-20513097-standard-… hellowood 2/6/2023 5:50:… PartnerSupported 3.4 将镜像导出为 iso 格式 执行导出后，会在挂载的目录下生成 iso 格式的文件，用于制作启动盘；这样就可以进行安装了\nExport-EsxImageProfile -ImageProfile 'ESXi-8.0.0-20513097-standard-nvme-net' -ExportToIso -FilePath /data/ESXi-8.0.0-20513097-standard-nvme-net.iso 参考文档 N5105 构建 Esxi 镜像 ","wordCount":"333","inLanguage":"en","datePublished":"2023-02-07T21:45:26+08:00","dateModified":"2023-02-07T21:45:26+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-powercli-%E7%9A%84-docker-%E5%AE%B9%E5%99%A8%E8%87%AA%E8%A1%8C%E6%9E%84%E5%BB%BA-esxi-%E9%95%9C%E5%83%8F/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像</h1></header><p><small>February 7, 2023&nbsp;· 333 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#1-下载所需的镜像和驱动>1. 下载所需的镜像和驱动</a><ul><li><a href=#11-申请-esxi-授权>1.1 申请 ESXi 授权</a></li><li><a href=#12-下载-nvme-社区驱动>1.2 下载 NVME 社区驱动</a></li><li><a href=#13-下载网卡社区驱动>1.3 下载网卡社区驱动</a></li></ul></li><li><a href=#2-启动-powercli-容器并挂载镜像和驱动>2. 启动 PowerCLI 容器并挂载镜像和驱动</a></li><li><a href=#3-将驱动添加到镜像文件中>3. 将驱动添加到镜像文件中</a><ul><li><a href=#31-将压缩文件添加到当前-powershell-session-中>3.1 将压缩文件添加到当前 PowerShell Session 中</a></li><li><a href=#32-获取当前的镜像>3.2 获取当前的镜像</a></li><li><a href=#33-复制新的镜像并添加驱动>3.3 复制新的镜像，并添加驱动</a></li><li><a href=#34-将镜像导出为-iso-格式>3.4 将镜像导出为 iso 格式</a></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div><section class=blog-content><h1 id=使用-powercli-的-docker-容器自行构建-esxi-镜像>使用 PowerCLI 的 Docker 容器自行构建 ESXi 镜像</h1><p>参考 <a href=https://helloworlde.github.io/2022/08/11/N5105-%E6%9E%84%E5%BB%BA-Esxi-%E9%95%9C%E5%83%8F/>N5105 构建 ESXi 镜像</a>，在使用 ESXi 7 时，基于 Windows 系统，使用 PowerCLI 为 ESXi 7 的镜像添加了 NVMe 和 Intel I225V 网卡的驱动；</p><p>虽然当时已经可以在 Linux 或者 MacOS 上使用 PowerShell，但是因为 PowerCLI 不支持 Core 版本的 PowerShell，会提示 <code>Exception: The VMware.ImageBuilder module is not currently supported on the Core edition of PowerShell</code>；导致只能使用 Windows 构建，对于没有 Windows 系统的用户非常不方便。</p><p>PowerCLI 新版本已经支持了 Core 版本的 PowerShell，因此可以通过在 Linux/MacOS/Docker 等平台直接构建 ESXi 镜像；</p><p>本次使用 PowerCLI 的 Docker 容器，为 ESXi 8 镜像添加 NVMe 和网卡驱动</p><h2 id=1-下载所需的镜像和驱动>1. 下载所需的镜像和驱动</h2><h3 id=11-申请-esxi-授权>1.1 申请 ESXi 授权</h3><p>ESXi 需要先注册申请，等待人工审核通过后就可以下载免费版本；如果没有任何反馈，可以点击申请页下面的 <a href=https://www.vmware.com/support/us_support.html>Contact us</a> 提工单给 VMWare；</p><p>可以在 <a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI800&amp;productId=1345&amp;rPId=99879">VMware vSphere Hypervisor (ESXi) 8.0.0</a> 页面申请 8.0 版本的下载；选择 Offline Bundle 的压缩文件</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-esxi-build-image-esxi8-download.png alt=homelab-esxi-build-image-esxi8-download.png></p><h3 id=12-下载-nvme-社区驱动>1.2 下载 NVME 社区驱动</h3><p>从 <a href=https://flings.vmware.com/community-nvme-driver-for-esxi>Community NVMe Driver for ESXi</a> 下载 NVME 驱动
<img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-esxi-build-image-nvme-driver.png alt=homelab-esxi-build-image-nvme-driver.png></p><h3 id=13-下载网卡社区驱动>1.3 下载网卡社区驱动</h3><p>从 <a href=https://flings.vmware.com/community-networking-driver-for-esxi>Community Networking Driver for ESXi</a> 下载网卡驱动，该驱动包含 Intel I225-V 网卡的驱动</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-esxi-build-image-network-driver.png alt=homelab-esxi-build-image-network-driver.png></p><h2 id=2-启动-powercli-容器并挂载镜像和驱动>2. 启动 PowerCLI 容器并挂载镜像和驱动</h2><p>下载完镜像和驱动后，最好放到单独的目录下，方便容器进行挂载；比如镜像和驱动都放在 <code>~/Downloads/ESXi</code>路径下</p><ul><li>启动 PowerCLI 容器并挂载镜像和驱动</li></ul><p>将镜像文件挂载到 <code>/data</code>目录下，并进入容器的 <code>bash</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name powercli <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   --rm -it <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   -v ~/Downloads/ESXi:/data/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   docker.io/vmware/powerclicore <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   bash
</span></span></code></pre></div><ul><li>进入 PowerShell</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pwsh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>PowerShell <span style=color:#ae81ff>7.2</span>.7
</span></span><span style=display:flex><span>Copyright (c) Microsoft Corporation.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>https<span style=color:#960050;background-color:#1e0010>:</span>//aka.ms/powershell
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#39;help&#39;</span> to get help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PS /data&gt;
</span></span></code></pre></div><h2 id=3-将驱动添加到镜像文件中>3. 将驱动添加到镜像文件中</h2><h3 id=31-将压缩文件添加到当前-powershell-session-中>3.1 将压缩文件添加到当前 PowerShell Session 中</h3><ul><li>添加 Esxi</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Add-EsxSoftwareDepot /data/VMware-ESXi-<span style=color:#ae81ff>8.0</span>-<span style=color:#ae81ff>20513097</span>-depot.zip
</span></span></code></pre></div><p>返回结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Depot Url
</span></span><span style=display:flex><span>---------
</span></span><span style=display:flex><span>zip<span style=color:#960050;background-color:#1e0010>:</span>/data/VMware-ESXi-<span style=color:#ae81ff>8.0</span>-<span style=color:#ae81ff>20513097</span>-depot.zip<span style=color:#66d9ef>?</span>index.xml
</span></span></code></pre></div><ul><li>添加网卡驱动</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Add-EsxSoftwareDepot /data/Net-Community-Driver_1.2.7.<span style=color:#ae81ff>0</span>-1vmw.700.1.0.15843807_19480755.zip
</span></span></code></pre></div><p>返回结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Depot Url
</span></span><span style=display:flex><span>---------
</span></span><span style=display:flex><span>zip<span style=color:#960050;background-color:#1e0010>:</span>/data/Net-Community-Driver_1.2.7.<span style=color:#ae81ff>0</span>-1vmw.700.1.0.15843807_19480755.zip<span style=color:#66d9ef>?</span>index.xml
</span></span></code></pre></div><ul><li>添加 NVME 驱动</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Add-EsxSoftwareDepot /data/nvme-community-driver_1.0.1.<span style=color:#ae81ff>0</span>-3vmw.700.1.0.<span style=color:#ae81ff>15843807</span>-component-<span style=color:#ae81ff>18902434</span>.zip
</span></span></code></pre></div><p>返回结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Depot Url
</span></span><span style=display:flex><span>---------
</span></span><span style=display:flex><span>zip<span style=color:#960050;background-color:#1e0010>:</span>/data/nvme-community-driver_1.0.1.<span style=color:#ae81ff>0</span>-3vmw.700.1.0.<span style=color:#ae81ff>15843807</span>-component-<span style=color:#ae81ff>18902434</span>.zip<span style=color:#66d9ef>?</span>index.xml
</span></span></code></pre></div><h3 id=32-获取当前的镜像>3.2 获取当前的镜像</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-EsxImageProfile
</span></span></code></pre></div><p>返回结果如下，其中 Name 在后续使用中需要用到</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Name                           Vendor          Last Modified   Acceptance Level
</span></span><span style=display:flex><span>----                           ------          -------------   ----------------
</span></span><span style=display:flex><span>ESXi-<span style=color:#ae81ff>8.0</span>.<span style=color:#ae81ff>0</span>-<span style=color:#ae81ff>20513097</span>-no-tools   VMware, Inc.    <span style=color:#ae81ff>9</span>/<span style=color:#ae81ff>23</span>/<span style=color:#ae81ff>2022</span> <span style=color:#ae81ff>6</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>59</span><span style=color:#960050;background-color:#1e0010>…</span> PartnerSupported
</span></span><span style=display:flex><span>ESXi-<span style=color:#ae81ff>8.0</span>.<span style=color:#ae81ff>0</span>-<span style=color:#ae81ff>20513097</span>-standard   VMware, Inc.    <span style=color:#ae81ff>9</span>/<span style=color:#ae81ff>23</span>/<span style=color:#ae81ff>2022</span> <span style=color:#ae81ff>6</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>59</span><span style=color:#960050;background-color:#1e0010>…</span> PartnerSupported
</span></span></code></pre></div><h3 id=33-复制新的镜像并添加驱动>3.3 复制新的镜像，并添加驱动</h3><ul><li>复制镜像</li></ul><p>基于当前的 ESXi 镜像，复制新的镜像，指定名称和租户，便于后面区分</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>New-EsxImageProfile -CloneProfile <span style=color:#e6db74>&#39;ESXi-8.0.0-20513097-standard&#39;</span>  -name <span style=color:#e6db74>&#39;ESXi-8.0.0-20513097-standard-nvme-net&#39;</span> -vendor <span style=color:#e6db74>&#39;hellowood&#39;</span>
</span></span></code></pre></div><p>返回结果如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Name                           Vendor          Last Modified   Acceptance Level
</span></span><span style=display:flex><span>----                           ------          -------------   ----------------
</span></span><span style=display:flex><span>ESXi-<span style=color:#ae81ff>8.0</span>.<span style=color:#ae81ff>0</span>-<span style=color:#ae81ff>20513097</span>-standard-<span style=color:#960050;background-color:#1e0010>…</span> hellowood       <span style=color:#ae81ff>9</span>/<span style=color:#ae81ff>23</span>/<span style=color:#ae81ff>2022</span> <span style=color:#ae81ff>6</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>59</span><span style=color:#960050;background-color:#1e0010>…</span> PartnerSupported
</span></span></code></pre></div><ul><li>添加网卡驱动</li></ul><p>使用复制镜像时使用的名称 <code>ESXi-8.0.0-20513097-standard-nvme-net</code>，将网卡驱动 <code>net-community</code> 添加到镜像中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Add-EsxSoftwarePackage -ImageProfile <span style=color:#e6db74>&#39;ESXi-8.0.0-20513097-standard-nvme-net&#39;</span> -SoftwarePackage <span style=color:#e6db74>&#39;net-community&#39;</span>
</span></span></code></pre></div><p>返回结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Name                           Vendor          Last Modified   Acceptance Level
</span></span><span style=display:flex><span>----                           ------          -------------   ----------------
</span></span><span style=display:flex><span>ESXi-<span style=color:#ae81ff>8.0</span>.<span style=color:#ae81ff>0</span>-<span style=color:#ae81ff>20513097</span>-standard-<span style=color:#960050;background-color:#1e0010>…</span> hellowood       <span style=color:#ae81ff>2</span>/<span style=color:#ae81ff>6</span>/<span style=color:#ae81ff>2023</span> <span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>50</span><span style=color:#960050;background-color:#1e0010>:…</span> PartnerSupported
</span></span></code></pre></div><ul><li>添加 NVMe 驱动</li></ul><p>使用复制镜像时使用的名称 <code>ESXi-8.0.0-20513097-standard-nvme-net</code>，将 NVMe 驱动 <code>nvme -community</code> 添加到镜像中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Add-EsxSoftwarePackage -ImageProfile <span style=color:#e6db74>&#39;ESXi-8.0.0-20513097-standard-nvme-net&#39;</span> -SoftwarePackage <span style=color:#e6db74>&#39;nvme-community&#39;</span>
</span></span></code></pre></div><p>返回结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Name                           Vendor          Last Modified   Acceptance Level
</span></span><span style=display:flex><span>----                           ------          -------------   ----------------
</span></span><span style=display:flex><span>ESXi-<span style=color:#ae81ff>8.0</span>.<span style=color:#ae81ff>0</span>-<span style=color:#ae81ff>20513097</span>-standard-<span style=color:#960050;background-color:#1e0010>…</span> hellowood       <span style=color:#ae81ff>2</span>/<span style=color:#ae81ff>6</span>/<span style=color:#ae81ff>2023</span> <span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>50</span><span style=color:#960050;background-color:#1e0010>:…</span> PartnerSupported
</span></span></code></pre></div><h3 id=34-将镜像导出为-iso-格式>3.4 将镜像导出为 iso 格式</h3><p>执行导出后，会在挂载的目录下生成 iso 格式的文件，用于制作启动盘；这样就可以进行安装了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Export-EsxImageProfile -ImageProfile <span style=color:#e6db74>&#39;ESXi-8.0.0-20513097-standard-nvme-net&#39;</span> -ExportToIso -FilePath /data/ESXi-<span style=color:#ae81ff>8.0</span>.<span style=color:#ae81ff>0</span>-<span style=color:#ae81ff>20513097</span>-standard-nvme-net.iso
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://helloworlde.github.io/2022/08/11/N5105-%E6%9E%84%E5%BB%BA-Esxi-%E9%95%9C%E5%83%8F/>N5105 构建 Esxi 镜像</a></li></ul></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%9F%B9%E6%AD%A3-pzem-004t-%E5%92%8C-homeassistant-%E7%9B%91%E6%B5%8B%E5%AE%B6%E5%BA%AD%E7%94%A8%E7%94%B5%E6%83%85%E5%86%B5/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>使用培正 PZEM 004T 和 HomeAssistant 监测家庭用电情况</span></a>
<a class=next href=https://blog.hellowood.dev/posts/%E6%8A%80%E5%98%89-b660m-aorus-pro-ax-%E5%AE%89%E8%A3%85%E9%BB%91%E8%8B%B9%E6%9E%9C/><span>技嘉 B660M AORUS PRO AX 安装黑苹果</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=related-resources></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>