<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>gRPC 健康检查</title>
<meta name=description content="在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率
使用 Server 端 健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务
健康检查定义了两个方法，一个适用于单次请求的 check 方法，另一个是适用于 Stream  …"><meta name=keywords content='blog,hugo,gRPC'><meta property="og:url" content="https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"><meta property="og:type" content="website"><meta property="og:title" content="gRPC  健康检查"><meta property="og:description" content="在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率
使用 Server 端 健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务
健康检查定义了两个方法，一个适用于单次请求的 check 方法，另一个是适用于 Stream  …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="gRPC  健康检查"><meta name=twitter:description content="在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率
使用 Server 端 健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务
健康检查定义了两个方法，一个适用于单次请求的 check 方法，另一个是适用于 Stream  …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.a036ebe92c17ea3f0c07761c2135b82bec6f37c8efb7f49ddad1f28c22fc4769.js integrity="sha256-oDbr6SwX6j8MB3YcITW4K+xvN8jvt/Sd2tHyjCL8R2k="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script><script src=https://app.rybbit.io/api/script.js data-site-id=209 defer></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>gRPC 健康检查</h1><small role=doc-subtitle></small><p class=post-date>2020-09-20</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/grpc>gRPC</a></li></ul></div><div class=post-content><p>在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率</p><h2 id=使用>使用</h2><h3 id=server-端>Server 端</h3><p>健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务</p><p>健康检查定义了两个方法，一个适用于单次请求的 <code>check</code> 方法，另一个是适用于 Stream 流的 <code>watch</code> 方法</p><p>Server 端的健康检查由 <code>io.grpc.services.HealthStatusManager</code>控制，抽象类是 <code>io.grpc.health.v1.HealthGrpc.HealthImplBase</code>，具体实现是通过 <code>io.grpc.services.HealthServiceImpl</code></p><ul><li>在 Server 端添加健康检查服务</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>HealthStatusManager</span> <span style=color:#c1abea>healthStatusManager</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HealthStatusManager</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>Server</span> <span style=color:#c1abea>server</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ServerBuilder</span>.<span style=color:#b3d23c>forPort</span>(<span style=color:#c1abea>1234</span>)
</span></span><span style=display:flex><span>                             .<span style=color:#b3d23c>addService</span>(<span style=color:#c1abea>healthStatusManager</span>.<span style=color:#b3d23c>getHealthService</span>())
</span></span><span style=display:flex><span>                             .<span style=color:#b3d23c>addService</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>HelloServiceImpl</span>())
</span></span><span style=display:flex><span>                             .<span style=color:#b3d23c>build</span>();
</span></span></code></pre></div><p>这样，当 Server 端启动之后，就可以通过访问 <code>grpc.health.v1.Health</code>服务获取当前的 Server 端的状态</p><h3 id=客户端>客户端</h3><ol><li>添加配置</li></ol><p>客户端开启健康检查有两个条件：</p><ul><li>配置了健康检查参数，配置的名称是 <code>healthCheckConfig</code>，通过指定 <code>serviceName</code> 的方式配置</li><li>使用了支持健康检查的 LB (如 round_robin)</li></ul><p>需要注意，这里的 <code>serviceName</code>可以是组件名称，或者服务名称；服务端默认为 <code>""</code>， 如果想检查某个组件，需要自己实现健康检查的逻辑；配置中的 <code>serviceName</code>只有在 NameReovler 解析到新的配置，且发生变化时才会更新，所以设置 <code>serviceName</code> 意义不大</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>Map</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>String</span>, <span style=color:#c1abea>Object</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>configMap</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HashMap</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>String</span>, <span style=color:#c1abea>Object</span><span style=color:#c7bf54>&gt;</span>() {{
</span></span><span style=display:flex><span>    <span style=color:#c1abea>put</span>(<span style=color:#98c379>&#34;healthCheckConfig&#34;</span>, <span style=color:#c678dd>new</span> <span style=color:#c1abea>HashMap</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>String</span>, <span style=color:#c1abea>Object</span><span style=color:#c7bf54>&gt;</span>() {{
</span></span><span style=display:flex><span>        <span style=color:#c1abea>put</span>(<span style=color:#98c379>&#34;serviceName&#34;</span>, <span style=color:#98c379>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    }});
</span></span><span style=display:flex><span>}};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>this</span>.<span style=color:#b3d23c>channel</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>ManagedChannelBuilder</span>
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>forTarget</span>(<span style=color:#98c379>&#34;server&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>usePlaintext</span>()
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>defaultServiceConfig</span>(<span style=color:#c1abea>configMap</span>)
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>defaultLoadBalancingPolicy</span>(<span style=color:#98c379>&#34;round_robin&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#b3d23c>build</span>()
</span></span></code></pre></div><ol start=2><li>执行健康检查</li></ol><p>在发起请求前，会先使用 Service 的名称请求服务端健康检查服务，检查服务是否处于 <code>SERVING</code> 状态，如果状态正常，则发起请求，否则将会失败</p><ul><li>调整日志级别</li></ul><p>将<code>io.grpc.ChannelLogger</code>的日志级别调整到 <code>ALL</code>，用于观察日志</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>Logger</span> <span style=color:#c1abea>logger</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>Logger</span>.<span style=color:#b3d23c>getLogger</span>(<span style=color:#98c379>&#34;io.grpc.ChannelLogger&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#c1abea>logger</span>.<span style=color:#b3d23c>setLevel</span>(<span style=color:#c1abea>Level</span>.<span style=color:#b3d23c>ALL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c1abea>ConsoleHandler</span> <span style=color:#c1abea>handler</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>ConsoleHandler</span>();
</span></span><span style=display:flex><span><span style=color:#c1abea>handler</span>.<span style=color:#b3d23c>setLevel</span>(<span style=color:#c1abea>Level</span>.<span style=color:#b3d23c>ALL</span>);
</span></span><span style=display:flex><span><span style=color:#c1abea>logger</span>.<span style=color:#b3d23c>addHandler</span>(<span style=color:#c1abea>handler</span>);
</span></span></code></pre></div><ul><li>当健康检查成功时输出成功日志</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Subchannel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>3</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>CONNECTING</span>: <span style=color:#c1abea>Starting</span> <span style=color:#c1abea>health</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>check</span> <span style=color:#c678dd>for</span> <span style=color:#98c379>&#34;io.github.helloworlde.HelloService&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Subchannel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>3</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>READY</span>: <span style=color:#c1abea>health</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>check</span> <span style=color:#c1abea>responded</span> <span style=color:#c1abea>SERVING</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Channel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>1</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>Entering</span> <span style=color:#c1abea>READY</span> <span style=color:#c1abea>state</span> <span style=color:#c1abea>with</span> <span style=color:#c1abea>picker</span>: <span style=color:#c1abea>ReadyPicker</span>{<span style=color:#c1abea>list</span><span style=color:#c7bf54>=[</span><span style=color:#c1abea>SubchannelImpl</span>{<span style=color:#c1abea>delegate</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>Subchannel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>3</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)}<span style=color:#c7bf54>]</span>}
</span></span></code></pre></div><ul><li>当健康检查失败时输出错误日志</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Subchannel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>3</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>READY</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Subchannel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>3</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>CONNECTING</span>: <span style=color:#c1abea>Starting</span> <span style=color:#c1abea>health</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>check</span> <span style=color:#c678dd>for</span> <span style=color:#98c379>&#34;io.github.helloworlde.HelloService&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Subchannel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>3</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>TRANSIENT_FAILURE</span>: <span style=color:#c1abea>health</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>check</span> <span style=color:#c1abea>responded</span> <span style=color:#c1abea>NOT_SERVING</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>非常详细</span>: <span style=color:#c7bf54>[</span><span style=color:#c1abea>Channel</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>1</span><span style=color:#c7bf54>&gt;</span>: (<span style=color:#c1abea>server</span>)<span style=color:#c7bf54>]</span> <span style=color:#c1abea>Entering</span> <span style=color:#c1abea>TRANSIENT_FAILURE</span> <span style=color:#c1abea>state</span> <span style=color:#c1abea>with</span> <span style=color:#c1abea>picker</span>: <span style=color:#c1abea>EmptyPicker</span>{<span style=color:#c1abea>status</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>Status</span>{<span style=color:#c1abea>code</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>UNAVAILABLE</span>, <span style=color:#c1abea>description</span><span style=color:#c7bf54>=</span><span style=color:#c1abea>Health</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>check</span> <span style=color:#c1abea>service</span> <span style=color:#c1abea>responded</span> <span style=color:#c1abea>NOT_SERVING</span> <span style=color:#c678dd>for</span> &#39;<span style=color:#c1abea>io</span>.<span style=color:#b3d23c>github</span>.<span style=color:#b3d23c>helloworlde</span>.<span style=color:#b3d23c>HelloService</span>&#39;, <span style=color:#c1abea>cause</span><span style=color:#c7bf54>=</span><span style=color:#b756ff;font-weight:700>null</span>}}
</span></span><span style=display:flex><span><span style=color:#c1abea>Exception</span> <span style=color:#c1abea>in</span> <span style=color:#c1abea>thread</span> <span style=color:#98c379>&#34;main&#34;</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>grpc</span>.<span style=color:#b3d23c>StatusRuntimeException</span>: <span style=color:#c1abea>UNAVAILABLE</span>: <span style=color:#c1abea>Health</span><span style=color:#c7bf54>-</span><span style=color:#c1abea>check</span> <span style=color:#c1abea>service</span> <span style=color:#c1abea>responded</span> <span style=color:#c1abea>NOT_SERVING</span> <span style=color:#c678dd>for</span> &#39;<span style=color:#c1abea>io</span>.<span style=color:#b3d23c>github</span>.<span style=color:#b3d23c>helloworlde</span>.<span style=color:#b3d23c>HelloService</span>&#39;
</span></span><span style=display:flex><span>	<span style=color:#c1abea>at</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>grpc</span>.<span style=color:#b3d23c>stub</span>.<span style=color:#b3d23c>ClientCalls</span>.<span style=color:#b3d23c>toStatusRuntimeException</span>(<span style=color:#c1abea>ClientCalls</span>.<span style=color:#b3d23c>java</span>:<span style=color:#c1abea>274</span>)
</span></span><span style=display:flex><span>	<span style=color:#c1abea>at</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>grpc</span>.<span style=color:#b3d23c>stub</span>.<span style=color:#b3d23c>ClientCalls</span>.<span style=color:#b3d23c>getUnchecked</span>(<span style=color:#c1abea>ClientCalls</span>.<span style=color:#b3d23c>java</span>:<span style=color:#c1abea>255</span>)
</span></span><span style=display:flex><span>	<span style=color:#c1abea>at</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>grpc</span>.<span style=color:#b3d23c>stub</span>.<span style=color:#b3d23c>ClientCalls</span>.<span style=color:#b3d23c>blockingUnaryCall</span>(<span style=color:#c1abea>ClientCalls</span>.<span style=color:#b3d23c>java</span>:<span style=color:#c1abea>166</span>)
</span></span><span style=display:flex><span>	<span style=color:#c1abea>at</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>github</span>.<span style=color:#b3d23c>helloworlde</span>.<span style=color:#b3d23c>HelloServiceGrpc$HelloServiceBlockingStub</span>.<span style=color:#b3d23c>howAreYou</span>(<span style=color:#c1abea>HelloServiceGrpc</span>.<span style=color:#b3d23c>java</span>:<span style=color:#c1abea>157</span>)
</span></span><span style=display:flex><span>	<span style=color:#c1abea>at</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>github</span>.<span style=color:#b3d23c>helloworlde</span>.<span style=color:#b3d23c>CustomClient</span>.<span style=color:#b3d23c>howAreYou</span>(<span style=color:#c1abea>CustomClient</span>.<span style=color:#b3d23c>java</span>:<span style=color:#c1abea>74</span>)
</span></span><span style=display:flex><span>	<span style=color:#c1abea>at</span> <span style=color:#c1abea>io</span>.<span style=color:#b3d23c>github</span>.<span style=color:#b3d23c>helloworlde</span>.<span style=color:#b3d23c>CustomClient</span>.<span style=color:#b3d23c>main</span>(<span style=color:#c1abea>CustomClient</span>.<span style=color:#b3d23c>java</span>:<span style=color:#c1abea>66</span>)
</span></span></code></pre></div><h2 id=实现>实现</h2><h3 id=定义>定义</h3><p>健康检查通过 <code>health.proto</code> 文件定义</p><ul><li>health.proto</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#c1abea>syntax</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;proto3&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#76a9f9>grpc</span><span style=color:#c7bf54>.</span><span style=color:#c1abea>health.v1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>csharp_namespace</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;Grpc.Health.V1&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>go_package</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;google.golang.org/grpc/health/grpc_health_v1&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>java_multiple_files</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>java_outer_classname</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;HealthProto&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#c678dd>option</span> <span style=color:#c1abea>java_package</span> <span style=color:#c7bf54>=</span> <span style=color:#98c379>&#34;io.grpc.health.v1&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>message</span> <span style=color:#76a9f9>HealthCheckRequest</span> {
</span></span><span style=display:flex><span>  <span style=color:#ef8383>string</span> <span style=color:#c678dd>service</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>message</span> <span style=color:#76a9f9>HealthCheckResponse</span> {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>enum</span> <span style=color:#c1abea>ServingStatus</span> {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>UNKNOWN</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>SERVING</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>NOT_SERVING</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>SERVICE_UNKNOWN</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>3</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span> <span style=color:#c7bf54>=</span> <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>service</span> <span style=color:#c1abea>Health</span> {
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 单次健康检查
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>Check</span>(<span style=color:#c1abea>HealthCheckRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>HealthCheckResponse</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 流式健康检查
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  <span style=color:#c678dd>rpc</span> <span style=color:#c1abea>Watch</span>(<span style=color:#c1abea>HealthCheckRequest</span>) <span style=color:#c678dd>returns</span> (<span style=color:#c1abea>stream</span> <span style=color:#c1abea>HealthCheckResponse</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=客户端-1>客户端</h3><h4 id=执行检查>执行检查</h4><h5 id=发起检查>发起检查</h5><ol><li>获取配置</li></ol><p>在 <code>NameResolver</code> 解析后，调用 <code>io.grpc.internal.ManagedChannelImpl.NameResolverListener#onResult</code> 时检查是否有健康检查的配置，如果有则将配置添加到 <code>Attributes</code> 中</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 获取属性</span>
</span></span><span style=display:flex><span><span style=color:#c1abea>Attributes</span> <span style=color:#c1abea>effectiveAttrs</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>resolutionResult</span>.<span style=color:#b3d23c>getAttributes</span>();
</span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>// 如果服务发现没有关闭</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> (<span style=color:#c1abea>NameResolverListener</span>.<span style=color:#b3d23c>this</span>.<span style=color:#b3d23c>helper</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>ManagedChannelImpl</span>.<span style=color:#b3d23c>this</span>.<span style=color:#b3d23c>lbHelper</span>) {
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 获取健康检查</span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>Map</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>String</span>, <span style=color:#c7bf54>?&gt;</span> <span style=color:#c1abea>healthCheckingConfig</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>effectiveServiceConfig</span>.<span style=color:#b3d23c>getHealthCheckingConfig</span>();
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 构建健康检查配置</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>healthCheckingConfig</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>effectiveAttrs</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>effectiveAttrs</span>.<span style=color:#b3d23c>toBuilder</span>()
</span></span><span style=display:flex><span>                                   .<span style=color:#b3d23c>set</span>(<span style=color:#c1abea>LoadBalancer</span>.<span style=color:#b3d23c>ATTR_HEALTH_CHECKING_CONFIG</span>, <span style=color:#c1abea>healthCheckingConfig</span>)
</span></span><span style=display:flex><span>                                   .<span style=color:#b3d23c>build</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 更新负载均衡算法，处理未处理的请求</span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>Status</span> <span style=color:#c1abea>handleResult</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>helper</span>.<span style=color:#b3d23c>lb</span>.<span style=color:#b3d23c>tryHandleResolvedAddresses</span>(
</span></span><span style=display:flex><span>          <span style=color:#c1abea>ResolvedAddresses</span>.<span style=color:#b3d23c>newBuilder</span>()
</span></span><span style=display:flex><span>                           .<span style=color:#b3d23c>setAddresses</span>(<span style=color:#c1abea>servers</span>)
</span></span><span style=display:flex><span>                           .<span style=color:#b3d23c>setAttributes</span>(<span style=color:#c1abea>effectiveAttrs</span>)
</span></span><span style=display:flex><span>                           .<span style=color:#b3d23c>setLoadBalancingPolicyConfig</span>(<span style=color:#c1abea>effectiveServiceConfig</span>.<span style=color:#b3d23c>getLoadBalancingConfig</span>())
</span></span><span style=display:flex><span>                           .<span style=color:#b3d23c>build</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>为 <code>Subchannel</code> 配置健康检查</li></ol><p>通过代理调用 <code>io.grpc.util.RoundRobinLoadBalancer#handleResolvedAddresses</code>方法，然后调用 <code>io.grpc.services.HealthCheckingLoadBalancerFactory.HelperImpl#createSubchannel</code> 方法创建 <code>Subchannel</code>；创建用于健康检查的 <code>SubchannelStateListener</code>的实例 <code>HealthCheckState</code></p><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HelperImpl#createSubchannel</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>HealthCheckState</span> <span style=color:#c1abea>hcState</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HealthCheckState</span>(<span style=color:#c678dd>this</span>, <span style=color:#c1abea>originalSubchannel</span>, <span style=color:#c1abea>syncContext</span>, <span style=color:#c1abea>delegate</span>.<span style=color:#b3d23c>getScheduledExecutorService</span>());
</span></span></code></pre></div><ol start=3><li>添加健康检查</li></ol><p>如果有设置健康检查，则将健康检查添加到 <code>Subchannel</code>健康检查集合中；然后调用 <code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#setServiceName</code> 方法执行</p><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#setServiceName</code></li></ul><p>如果此时有已经提交的请求，则取消，并发送健康检查请求；当第一次执行的时候，如果状态是 <code>IDLE</code>s，则会跳出不执行，直到状态变为<code>READY</code>时执行</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ef8383>void</span> <span style=color:#00b1f7>setServiceName</span>(<span style=color:#e5c07b>@Nullable</span> <span style=color:#c1abea>String</span> <span style=color:#c1abea>newServiceName</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>serviceName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>newServiceName</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果在 RPC 请求期间服务名称更改，请取消该服务，以便用新名称进行新的调用</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>String</span> <span style=color:#c1abea>cancelMsg</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>serviceName</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span> <span style=color:#c7bf54>?</span> <span style=color:#98c379>&#34;Health check disabled by service config&#34;</span>
</span></span><span style=display:flex><span>            : <span style=color:#98c379>&#34;Switching to new service name: &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>newServiceName</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 停止调用</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>stopRpc</span>(<span style=color:#c1abea>cancelMsg</span>);
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 调整健康检查</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>adjustHealthCheck</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.internal.InternalSubchannel.TransportListener#transportReady</code></li></ul><p>当 <code>Transport</code> 状态是<code>READY</code> 的时候，开始健康检查</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>transportReady</span>() {
</span></span><span style=display:flex><span>      <span style=color:#c1abea>syncContext</span>.<span style=color:#b3d23c>execute</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>Runnable</span>() {
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>run</span>() {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>reconnectPolicy</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>          <span style=color:#c678dd>if</span> (<span style=color:#c1abea>shutdownReason</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>Preconditions</span>.<span style=color:#b3d23c>checkState</span>(<span style=color:#c1abea>activeTransport</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>, <span style=color:#98c379>&#34;Unexpected non-null activeTransport&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#c1abea>transport</span>.<span style=color:#b3d23c>shutdown</span>(<span style=color:#c1abea>shutdownReason</span>);
</span></span><span style=display:flex><span>          } <span style=color:#c678dd>else</span> <span style=color:#c678dd>if</span> (<span style=color:#c1abea>pendingTransport</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>transport</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>activeTransport</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>transport</span>;
</span></span><span style=display:flex><span>            <span style=color:#c1abea>pendingTransport</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>            <span style=color:#c1abea>gotoNonErrorState</span>(<span style=color:#c1abea>READY</span>);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><ul><li><code>io.grpc.internal.InternalSubchannel#gotoState</code>
将状态变为 <code>READY</code> 状态，</li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>gotoState</span>(<span style=color:#c678dd>final</span> <span style=color:#c1abea>ConnectivityStateInfo</span> <span style=color:#c1abea>newState</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>state</span>.<span style=color:#b3d23c>getState</span>() <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>newState</span>.<span style=color:#b3d23c>getState</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#c1abea>Preconditions</span>.<span style=color:#b3d23c>checkState</span>(<span style=color:#c1abea>state</span>.<span style=color:#b3d23c>getState</span>() <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>SHUTDOWN</span>,
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#34;Cannot transition out of SHUTDOWN to &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>newState</span>);
</span></span><span style=display:flex><span>      <span style=color:#c1abea>state</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>newState</span>;
</span></span><span style=display:flex><span>      <span style=color:#c1abea>callback</span>.<span style=color:#b3d23c>onStateChange</span>(<span style=color:#c1abea>InternalSubchannel</span>.<span style=color:#b3d23c>this</span>, <span style=color:#c1abea>newState</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li><code>ManagedInternalSubchannelCallback#onStateChange</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ef8383>void</span> <span style=color:#00b1f7>onStateChange</span>(<span style=color:#c1abea>InternalSubchannel</span> <span style=color:#c1abea>is</span>, <span style=color:#c1abea>ConnectivityStateInfo</span> <span style=color:#c1abea>newState</span>) {
</span></span><span style=display:flex><span>  <span style=color:#8a93a5;font-style:italic>// 调用服务发现，重新解析</span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>handleInternalSubchannelState</span>(<span style=color:#c1abea>newState</span>);
</span></span><span style=display:flex><span>  <span style=color:#c1abea>checkState</span>(<span style=color:#c1abea>listener</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>, <span style=color:#98c379>&#34;listener is null&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#c1abea>listener</span>.<span style=color:#b3d23c>onSubchannelState</span>(<span style=color:#c1abea>newState</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#onSubchannelState</code></li></ul><p>当 <code>Subchannel</code> 状态发生变化时执行健康检查</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>onSubchannelState</span>(<span style=color:#c1abea>ConnectivityStateInfo</span> <span style=color:#c1abea>rawState</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果当前的状态是 READY，且新的状态不是 READY，则更新 disabled 为 false</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>Objects</span>.<span style=color:#b3d23c>equal</span>(<span style=color:#c678dd>this</span>.<span style=color:#b3d23c>rawState</span>.<span style=color:#b3d23c>getState</span>(), <span style=color:#c1abea>READY</span>)
</span></span><span style=display:flex><span>            <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c7bf54>!</span><span style=color:#c1abea>Objects</span>.<span style=color:#b3d23c>equal</span>(<span style=color:#c1abea>rawState</span>.<span style=color:#b3d23c>getState</span>(), <span style=color:#c1abea>READY</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 断开连接，将重置已禁用标志，因为健康检查在新连接上可能可用</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>disabled</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果是 SHUTDOWN，则移除</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>Objects</span>.<span style=color:#b3d23c>equal</span>(<span style=color:#c1abea>rawState</span>.<span style=color:#b3d23c>getState</span>(), <span style=color:#c1abea>SHUTDOWN</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>helperImpl</span>.<span style=color:#b3d23c>hcStates</span>.<span style=color:#b3d23c>remove</span>(<span style=color:#c678dd>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c678dd>this</span>.<span style=color:#b3d23c>rawState</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>rawState</span>;
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 调整健康检查状态</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>adjustHealthCheck</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#adjustHealthCheck</code></li></ul><p>当没有禁止，且服务名不为空，且连接状态是 READY，则发送健康检查的请求</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>adjustHealthCheck</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果没有禁止，且服务名不为空，且连接状态是 READY</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>disabled</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c1abea>serviceName</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c1abea>Objects</span>.<span style=color:#b3d23c>equal</span>(<span style=color:#c1abea>rawState</span>.<span style=color:#b3d23c>getState</span>(), <span style=color:#c1abea>READY</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>running</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果没有活跃的 RPC，且重试计时器没有等待，则开始 RPC</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>activeRpc</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c7bf54>!</span><span style=color:#c1abea>isRetryTimerPending</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 执行健康检查，并根据结果发送请求</span>
</span></span><span style=display:flex><span>            <span style=color:#c1abea>startRpc</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>running</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#c1abea>stopRpc</span>(<span style=color:#98c379>&#34;Client stops health check&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>backoffPolicy</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#c1abea>gotoState</span>(<span style=color:#c1abea>rawState</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#startRpc</code></li></ul><p>在开始健康检查之前，将连接状态由 <code>READY</code> 改为 <code>CONNECTING</code>；
创建新的 <code>ClientCall.Listener</code>实例 <code>HcStream</code>，并调用 <code>start</code> 方法，发起请求</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>startRpc</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c7bf54>!</span><span style=color:#c1abea>Objects</span>.<span style=color:#b3d23c>equal</span>(<span style=color:#c1abea>concludedState</span>.<span style=color:#b3d23c>getState</span>(), <span style=color:#c1abea>READY</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 修改连接状态</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>gotoState</span>(<span style=color:#c1abea>ConnectivityStateInfo</span>.<span style=color:#b3d23c>forNonError</span>(<span style=color:#c1abea>CONNECTING</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 创建新的 ClientCall.Listener</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>activeRpc</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>HcStream</span>();
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 开始调用，发出请求</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>activeRpc</span>.<span style=color:#b3d23c>start</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#HcStream</code></li></ul><p>在 <code>HcStream</code> 构造方法中，创建新的 Stream 请求</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c1abea>HcStream</span>() {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>stopwatch</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>stopwatchSupplier</span>.<span style=color:#b3d23c>get</span>().<span style=color:#b3d23c>start</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>callServiceName</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>serviceName</span>;
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 开始新的调用</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>call</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>subchannel</span>.<span style=color:#b3d23c>asChannel</span>().<span style=color:#b3d23c>newCall</span>(<span style=color:#c1abea>HealthGrpc</span>.<span style=color:#b3d23c>getWatchMethod</span>(), <span style=color:#c1abea>CallOptions</span>.<span style=color:#b3d23c>DEFAULT</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.internal.SubchannelChannel#newCall</code></li></ul><p>发起一个 <code>SERVER_STREAMING</code> 请求</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>RequestT</span>, <span style=color:#c1abea>ResponseT</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>ClientCall</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>RequestT</span>, <span style=color:#c1abea>ResponseT</span><span style=color:#c7bf54>&gt;</span> <span style=color:#00b1f7>newCall</span>(<span style=color:#c1abea>MethodDescriptor</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>RequestT</span>, <span style=color:#c1abea>ResponseT</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>methodDescriptor</span>, <span style=color:#c1abea>CallOptions</span> <span style=color:#c1abea>callOptions</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>final</span> <span style=color:#c1abea>Executor</span> <span style=color:#c1abea>effectiveExecutor</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>callOptions</span>.<span style=color:#b3d23c>getExecutor</span>() <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span> <span style=color:#c7bf54>?</span> <span style=color:#c1abea>executor</span> : <span style=color:#c1abea>callOptions</span>.<span style=color:#b3d23c>getExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>ClientCallImpl</span><span style=color:#c7bf54>&lt;&gt;</span>(<span style=color:#c1abea>methodDescriptor</span>,
</span></span><span style=display:flex><span>        <span style=color:#c1abea>effectiveExecutor</span>,
</span></span><span style=display:flex><span>        <span style=color:#c1abea>callOptions</span>.<span style=color:#b3d23c>withOption</span>(<span style=color:#c1abea>GrpcUtil</span>.<span style=color:#b3d23c>CALL_OPTIONS_RPC_OWNED_BY_BALANCER</span>, <span style=color:#c1abea>Boolean</span>.<span style=color:#b3d23c>TRUE</span>),
</span></span><span style=display:flex><span>        <span style=color:#c1abea>transportProvider</span>, <span style=color:#c1abea>deadlineCancellationExecutor</span>, <span style=color:#c1abea>callsTracer</span>, <span style=color:#b756ff;font-weight:700>false</span> <span style=color:#8a93a5;font-style:italic>/* retryEnabled */</span>);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#start</code></li></ul><p>开始调用，使用服务名作为健康检查的参数，向服务端发起健康检查请求
此时服务端接收到健康检查请求，根据请求的参数进行检查，然后返回结果</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ef8383>void</span> <span style=color:#00b1f7>start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 开始调用</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>call</span>.<span style=color:#b3d23c>start</span>(<span style=color:#c678dd>this</span>, <span style=color:#c678dd>new</span> <span style=color:#c1abea>Metadata</span>());
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 发送服务健康检查消息</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>call</span>.<span style=color:#b3d23c>sendMessage</span>(<span style=color:#c1abea>HealthCheckRequest</span>.<span style=color:#b3d23c>newBuilder</span>().<span style=color:#b3d23c>setService</span>(<span style=color:#c1abea>serviceName</span>).<span style=color:#b3d23c>build</span>());
</span></span><span style=display:flex><span>    <span style=color:#c1abea>call</span>.<span style=color:#b3d23c>halfClose</span>();
</span></span><span style=display:flex><span>    <span style=color:#c1abea>call</span>.<span style=color:#b3d23c>request</span>(<span style=color:#c1abea>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=处理结果>处理结果</h5><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#onMessage</code></li></ul><p>监听响应结果，如果是当前 <code>Subchannel</code>的请求响应，则进行处理</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>onMessage</span>(<span style=color:#c678dd>final</span> <span style=color:#c1abea>HealthCheckResponse</span> <span style=color:#c1abea>response</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>syncContext</span>.<span style=color:#b3d23c>execute</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>Runnable</span>() {
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>run</span>() {
</span></span><span style=display:flex><span>            <span style=color:#8a93a5;font-style:italic>// 如果是当前的请求，则进行处理</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> (<span style=color:#c1abea>activeRpc</span> <span style=color:#c7bf54>==</span> <span style=color:#c1abea>HcStream</span>.<span style=color:#b3d23c>this</span>) {
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// 根据响应更新连接状态</span>
</span></span><span style=display:flex><span>                <span style=color:#c1abea>handleResponse</span>(<span style=color:#c1abea>response</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>根据响应结果处理连接状态</li></ul><p>在 <code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#handleResponse</code> 方法中处理响应结果；如果是 <code>SERVING</code>状态，则将连接状态改为 <code>READY</code>，否则将状态改为 <code>UNAVAILABLE</code></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ef8383>void</span> <span style=color:#00b1f7>handleResponse</span>(<span style=color:#c1abea>HealthCheckResponse</span> <span style=color:#c1abea>response</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>callHasResponded</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#c1abea>backoffPolicy</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 获取返回的状态</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>response</span>.<span style=color:#b3d23c>getStatus</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果是服务中，则更新连接状态为 READY</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>Objects</span>.<span style=color:#b3d23c>equal</span>(<span style=color:#c1abea>status</span>, <span style=color:#c1abea>ServingStatus</span>.<span style=color:#b3d23c>SERVING</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>gotoState</span>(<span style=color:#c1abea>ConnectivityStateInfo</span>.<span style=color:#b3d23c>forNonError</span>(<span style=color:#c1abea>READY</span>));
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 更新连接状态为 UNAVAILABLE</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>gotoState</span>(<span style=color:#c1abea>ConnectivityStateInfo</span>.<span style=color:#b3d23c>forTransientFailure</span>(<span style=color:#c1abea>Status</span>.<span style=color:#b3d23c>UNAVAILABLE</span>.<span style=color:#b3d23c>withDescription</span>(<span style=color:#98c379>&#34;Health-check service responded &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>status</span> <span style=color:#c7bf54>+</span> <span style=color:#98c379>&#34; for &#39;&#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>callServiceName</span> <span style=color:#c7bf54>+</span> <span style=color:#98c379>&#34;&#39;&#34;</span>)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#c1abea>call</span>.<span style=color:#b3d23c>request</span>(<span style=color:#c1abea>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也会将 LB 状态也改为 <code>READY</code>，此时 Picker 变为 <code>ReadyPicker</code>，至此，完成健康检查</p><h3 id=server-端-1>Server 端</h3><h4 id=设置服务状态>设置服务状态</h4><h5 id=默认服务>默认服务</h5><p><code>io.grpc.services.HealthServiceImpl#HealthServiceImpl</code> 内有一个 Map，用于存放各个服务的状态；默认含有一个 key 为 <code>""</code>, value 为 <code>SERVING</code>的键值对，当请求参数中没有 seviceName 时直接返回 <code>SERVING</code> 状态</p><h5 id=其他服务>其他服务</h5><p>其他服务需要 Server 主动设置状态，具体的逻辑由自己实现，当服务状态发生变化时，通过调用 <code>io.grpc.services.HealthStatusManager#setStatus</code> 进行设置</p><ul><li><code>io.grpc.services.HealthStatusManager#setStatus</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>setStatus</span>(<span style=color:#c1abea>String</span> <span style=color:#c1abea>service</span>, <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c1abea>checkNotNull</span>(<span style=color:#c1abea>status</span>, <span style=color:#98c379>&#34;status&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#c1abea>healthService</span>.<span style=color:#b3d23c>setStatus</span>(<span style=color:#c1abea>service</span>, <span style=color:#c1abea>status</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthServiceImpl#setStatus</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ef8383>void</span> <span style=color:#00b1f7>setStatus</span>(<span style=color:#c1abea>String</span> <span style=color:#c1abea>service</span>, <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>synchronized</span> (<span style=color:#c1abea>watchLock</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>terminal</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c678dd>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#c1abea>setStatusInternal</span>(<span style=color:#c1abea>service</span>, <span style=color:#c1abea>status</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthServiceImpl#setStatusInternal</code></li></ul><p>为 service 设置状态，当状态发生变化时，通过 Stream 发送响应给客户端，通知状态变化</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>setStatusInternal</span>(<span style=color:#c1abea>String</span> <span style=color:#c1abea>service</span>, <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 设置新的状态</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>prevStatus</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>statusMap</span>.<span style=color:#b3d23c>put</span>(<span style=color:#c1abea>service</span>, <span style=color:#c1abea>status</span>);
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果状态不一样，则通知状态变化</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>prevStatus</span> <span style=color:#c7bf54>!=</span> <span style=color:#c1abea>status</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>notifyWatchers</span>(<span style=color:#c1abea>service</span>, <span style=color:#c1abea>status</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthServiceImpl#notifyWatchers</code></li></ul><p>如果有客户端 Stream，则将状态变化通知给所有的监听该服务的客户端</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>private</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>notifyWatchers</span>(<span style=color:#c1abea>String</span> <span style=color:#c1abea>service</span>, <span style=color:#e5c07b>@Nullable</span> <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 构建结果</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>HealthCheckResponse</span> <span style=color:#c1abea>response</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>getResponseForWatch</span>(<span style=color:#c1abea>status</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>IdentityHashMap</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HealthCheckResponse</span><span style=color:#c7bf54>&gt;</span>, <span style=color:#c1abea>Boolean</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>watchers</span>.<span style=color:#b3d23c>get</span>(<span style=color:#c1abea>service</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果有监听，则遍历所有的监听，发送结果</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> (<span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HealthCheckResponse</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>responseObserver</span> : <span style=color:#c1abea>serviceWatchers</span>.<span style=color:#b3d23c>keySet</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>responseObserver</span>.<span style=color:#b3d23c>onNext</span>(<span style=color:#c1abea>response</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=处理健康检查>处理健康检查</h4><h5 id=单次请求>单次请求</h5><p>单次健康检查请求通过 <code>io.grpc.services.HealthServiceImpl#check</code> 处理，会根据当前的状态返回</p><ul><li><code>io.grpc.services.HealthServiceImpl#check</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>check</span>(<span style=color:#c1abea>HealthCheckRequest</span> <span style=color:#c1abea>request</span>,
</span></span><span style=display:flex><span>                  <span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HealthCheckResponse</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>responseObserver</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 根据请求中的服务名获取状态</span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>statusMap</span>.<span style=color:#b3d23c>get</span>(<span style=color:#c1abea>request</span>.<span style=color:#b3d23c>getService</span>());
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 如果状态是 null，则返回 NOT_FOUND 错误</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>if</span> (<span style=color:#c1abea>status</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>responseObserver</span>.<span style=color:#b3d23c>onError</span>(<span style=color:#c678dd>new</span> <span style=color:#c1abea>StatusException</span>(<span style=color:#c1abea>Status</span>.<span style=color:#b3d23c>NOT_FOUND</span>.<span style=color:#b3d23c>withDescription</span>(<span style=color:#98c379>&#34;unknown service &#34;</span> <span style=color:#c7bf54>+</span> <span style=color:#c1abea>request</span>.<span style=color:#b3d23c>getService</span>())));
</span></span><span style=display:flex><span>    } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 根据状态构造响应</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>HealthCheckResponse</span> <span style=color:#c1abea>response</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>HealthCheckResponse</span>.<span style=color:#b3d23c>newBuilder</span>().<span style=color:#b3d23c>setStatus</span>(<span style=color:#c1abea>status</span>).<span style=color:#b3d23c>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#c1abea>responseObserver</span>.<span style=color:#b3d23c>onNext</span>(<span style=color:#c1abea>response</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>responseObserver</span>.<span style=color:#b3d23c>onCompleted</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=stream-请求>Stream 请求</h5><p>对于 Stream 请求，是通过 <code>io.grpc.services.HealthServiceImpl#watch</code> 处理
当接收到请求后，会从 Map 中获取服务状态，然后生成响应返回给客户端；
然后将该 <code>StreamObserver</code> 保存到 Service 对应的 Map 中，当 Service 状态发生变化时，通知相应的 Client
同时添加了监听器，当客户端关闭时，从 Map 中移除该 <code>StreamObserver</code></p><ul><li><code>io.grpc.services.HealthServiceImpl#watch</code></li></ul><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>watch</span>(<span style=color:#c1abea>HealthCheckRequest</span> <span style=color:#c1abea>request</span>,
</span></span><span style=display:flex><span>                  <span style=color:#c678dd>final</span> <span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HealthCheckResponse</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>responseObserver</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c678dd>final</span> <span style=color:#c1abea>String</span> <span style=color:#c1abea>service</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>request</span>.<span style=color:#b3d23c>getService</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 加锁</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>synchronized</span> (<span style=color:#c1abea>watchLock</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 根据服务获取状态，构建结果，并发送出去</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>ServingStatus</span> <span style=color:#c1abea>status</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>statusMap</span>.<span style=color:#b3d23c>get</span>(<span style=color:#c1abea>service</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>responseObserver</span>.<span style=color:#b3d23c>onNext</span>(<span style=color:#c1abea>getResponseForWatch</span>(<span style=color:#c1abea>status</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 从 watcher 中获取服务名的 map，如果不存在，则创建一个</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>IdentityHashMap</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HealthCheckResponse</span><span style=color:#c7bf54>&gt;</span>, <span style=color:#c1abea>Boolean</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>watchers</span>.<span style=color:#b3d23c>get</span>(<span style=color:#c1abea>service</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>==</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>IdentityHashMap</span><span style=color:#c7bf54>&lt;&gt;</span>();
</span></span><span style=display:flex><span>            <span style=color:#c1abea>watchers</span>.<span style=color:#b3d23c>put</span>(<span style=color:#c1abea>service</span>, <span style=color:#c1abea>serviceWatchers</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// 如果存在，则将 responseObserver 添加到 map 中</span>
</span></span><span style=display:flex><span>        <span style=color:#c1abea>serviceWatchers</span>.<span style=color:#b3d23c>put</span>(<span style=color:#c1abea>responseObserver</span>, <span style=color:#c1abea>Boolean</span>.<span style=color:#b3d23c>TRUE</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c1abea>Context</span>.<span style=color:#b3d23c>current</span>().<span style=color:#b3d23c>addListener</span>(
</span></span><span style=display:flex><span>            <span style=color:#c678dd>new</span> <span style=color:#c1abea>CancellationListener</span>() {
</span></span><span style=display:flex><span>                <span style=color:#e5c07b>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#8a93a5;font-style:italic>// Called when the client has closed the stream</span>
</span></span><span style=display:flex><span>                <span style=color:#c678dd>public</span> <span style=color:#ef8383>void</span> <span style=color:#00b1f7>cancelled</span>(<span style=color:#c1abea>Context</span> <span style=color:#c1abea>context</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>synchronized</span> (<span style=color:#c1abea>watchLock</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#8a93a5;font-style:italic>// 当客户端关闭时，从 map 中移除方法对应的数据</span>
</span></span><span style=display:flex><span>                        <span style=color:#c1abea>IdentityHashMap</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>StreamObserver</span><span style=color:#c7bf54>&lt;</span><span style=color:#c1abea>HealthCheckResponse</span><span style=color:#c7bf54>&gt;</span>, <span style=color:#c1abea>Boolean</span><span style=color:#c7bf54>&gt;</span> <span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>watchers</span>.<span style=color:#b3d23c>get</span>(<span style=color:#c1abea>service</span>);
</span></span><span style=display:flex><span>                        <span style=color:#c678dd>if</span> (<span style=color:#c1abea>serviceWatchers</span> <span style=color:#c7bf54>!=</span> <span style=color:#b756ff;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>                            <span style=color:#c1abea>serviceWatchers</span>.<span style=color:#b3d23c>remove</span>(<span style=color:#c1abea>responseObserver</span>);
</span></span><span style=display:flex><span>                            <span style=color:#c678dd>if</span> (<span style=color:#c1abea>serviceWatchers</span>.<span style=color:#b3d23c>isEmpty</span>()) {
</span></span><span style=display:flex><span>                                <span style=color:#c1abea>watchers</span>.<span style=color:#b3d23c>remove</span>(<span style=color:#c1abea>service</span>);
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#c1abea>MoreExecutors</span>.<span style=color:#b3d23c>directExecutor</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2020 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>