<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>gRPC 健康检查</title><meta name=description content="在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率
使用 Server 端 健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务
健康检查定义了两个方法，一个适用于单次请求的 check 方法，另一个是适用于 Stream  …"><meta name=keywords content='blog,hugo,gRPC'><meta property="og:url" content="https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"><meta property="og:type" content="website"><meta property="og:title" content="gRPC  健康检查"><meta property="og:description" content="在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率
使用 Server 端 健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务
健康检查定义了两个方法，一个适用于单次请求的 check 方法，另一个是适用于 Stream  …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="gRPC  健康检查"><meta name=twitter:description content="在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率
使用 Server 端 健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务
健康检查定义了两个方法，一个适用于单次请求的 check 方法，另一个是适用于 Stream  …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.70293498aa96b2dbb767ec11a622eb2266d8fc37a0fff88233a82952e3c72b15.js integrity="sha256-cCk0mKqWstu3Z+wRpiLrImbY/Deg//iCM6gpUuPHKxU="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-5709431067036925"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5709431067036925" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>gRPC 健康检查</h1><small role=doc-subtitle></small><p class=post-date>2020-09-20
| Updated 2025-09-06</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/grpc>gRPC</a></li></ul></div><div class=post-content><p>在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率</p><h2 id=使用>使用</h2><h3 id=server-端>Server 端</h3><p>健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务</p><p>健康检查定义了两个方法，一个适用于单次请求的 <code>check</code> 方法，另一个是适用于 Stream 流的 <code>watch</code> 方法</p><p>Server 端的健康检查由 <code>io.grpc.services.HealthStatusManager</code>控制，抽象类是 <code>io.grpc.health.v1.HealthGrpc.HealthImplBase</code>，具体实现是通过 <code>io.grpc.services.HealthServiceImpl</code></p><ul><li>在 Server 端添加健康检查服务</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>HealthStatusManager healthStatusManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HealthStatusManager();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Server server <span style=color:#f92672>=</span> ServerBuilder.<span style=color:#a6e22e>forPort</span>(1234)
</span></span><span style=display:flex><span>                             .<span style=color:#a6e22e>addService</span>(healthStatusManager.<span style=color:#a6e22e>getHealthService</span>())
</span></span><span style=display:flex><span>                             .<span style=color:#a6e22e>addService</span>(<span style=color:#66d9ef>new</span> HelloServiceImpl())
</span></span><span style=display:flex><span>                             .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><p>这样，当 Server 端启动之后，就可以通过访问 <code>grpc.health.v1.Health</code>服务获取当前的 Server 端的状态</p><h3 id=客户端>客户端</h3><ol><li>添加配置</li></ol><p>客户端开启健康检查有两个条件：</p><ul><li>配置了健康检查参数，配置的名称是 <code>healthCheckConfig</code>，通过指定 <code>serviceName</code> 的方式配置</li><li>使用了支持健康检查的 LB (如 round_robin)</li></ul><p>需要注意，这里的 <code>serviceName</code>可以是组件名称，或者服务名称；服务端默认为 <code>""</code>， 如果想检查某个组件，需要自己实现健康检查的逻辑；配置中的 <code>serviceName</code>只有在 NameReovler 解析到新的配置，且发生变化时才会更新，所以设置 <code>serviceName</code> 意义不大</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> configMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span>() {{
</span></span><span style=display:flex><span>    put(<span style=color:#e6db74>&#34;healthCheckConfig&#34;</span>, <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span>() {{
</span></span><span style=display:flex><span>        put(<span style=color:#e6db74>&#34;serviceName&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    }});
</span></span><span style=display:flex><span>}};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>channel</span> <span style=color:#f92672>=</span> ManagedChannelBuilder
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>forTarget</span>(<span style=color:#e6db74>&#34;server&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>usePlaintext</span>()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>defaultServiceConfig</span>(configMap)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>defaultLoadBalancingPolicy</span>(<span style=color:#e6db74>&#34;round_robin&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>build</span>()
</span></span></code></pre></div><ol start=2><li>执行健康检查</li></ol><p>在发起请求前，会先使用 Service 的名称请求服务端健康检查服务，检查服务是否处于 <code>SERVING</code> 状态，如果状态正常，则发起请求，否则将会失败</p><ul><li>调整日志级别</li></ul><p>将<code>io.grpc.ChannelLogger</code>的日志级别调整到 <code>ALL</code>，用于观察日志</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Logger logger <span style=color:#f92672>=</span> Logger.<span style=color:#a6e22e>getLogger</span>(<span style=color:#e6db74>&#34;io.grpc.ChannelLogger&#34;</span>);
</span></span><span style=display:flex><span>logger.<span style=color:#a6e22e>setLevel</span>(Level.<span style=color:#a6e22e>ALL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ConsoleHandler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConsoleHandler();
</span></span><span style=display:flex><span>handler.<span style=color:#a6e22e>setLevel</span>(Level.<span style=color:#a6e22e>ALL</span>);
</span></span><span style=display:flex><span>logger.<span style=color:#a6e22e>addHandler</span>(handler);
</span></span></code></pre></div><ul><li>当健康检查成功时输出成功日志</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Subchannel<span style=color:#f92672>&lt;</span>3<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> CONNECTING: Starting health<span style=color:#f92672>-</span>check <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#34;io.github.helloworlde.HelloService&#34;</span>
</span></span><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Subchannel<span style=color:#f92672>&lt;</span>3<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> READY: health<span style=color:#f92672>-</span>check responded SERVING
</span></span><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Channel<span style=color:#f92672>&lt;</span>1<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> Entering READY state with picker: ReadyPicker{list<span style=color:#f92672>=[</span>SubchannelImpl{delegate<span style=color:#f92672>=</span>Subchannel<span style=color:#f92672>&lt;</span>3<span style=color:#f92672>&gt;</span>: (server)}<span style=color:#f92672>]</span>}
</span></span></code></pre></div><ul><li>当健康检查失败时输出错误日志</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Subchannel<span style=color:#f92672>&lt;</span>3<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> READY
</span></span><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Subchannel<span style=color:#f92672>&lt;</span>3<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> CONNECTING: Starting health<span style=color:#f92672>-</span>check <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#34;io.github.helloworlde.HelloService&#34;</span>
</span></span><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Subchannel<span style=color:#f92672>&lt;</span>3<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> TRANSIENT_FAILURE: health<span style=color:#f92672>-</span>check responded NOT_SERVING
</span></span><span style=display:flex><span>非常详细: <span style=color:#f92672>[</span>Channel<span style=color:#f92672>&lt;</span>1<span style=color:#f92672>&gt;</span>: (server)<span style=color:#f92672>]</span> Entering TRANSIENT_FAILURE state with picker: EmptyPicker{status<span style=color:#f92672>=</span>Status{code<span style=color:#f92672>=</span>UNAVAILABLE, description<span style=color:#f92672>=</span>Health<span style=color:#f92672>-</span>check service responded NOT_SERVING <span style=color:#66d9ef>for</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>io.<span style=color:#a6e22e>github</span>.<span style=color:#a6e22e>helloworlde</span>.<span style=color:#a6e22e>HelloService</span><span style=color:#960050;background-color:#1e0010>&#39;</span>, cause<span style=color:#f92672>=</span><span style=color:#66d9ef>null</span>}}
</span></span><span style=display:flex><span>Exception in thread <span style=color:#e6db74>&#34;main&#34;</span> io.<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>StatusRuntimeException</span>: UNAVAILABLE: Health<span style=color:#f92672>-</span>check service responded NOT_SERVING <span style=color:#66d9ef>for</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>io.<span style=color:#a6e22e>github</span>.<span style=color:#a6e22e>helloworlde</span>.<span style=color:#a6e22e>HelloService</span><span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>	at io.<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>stub</span>.<span style=color:#a6e22e>ClientCalls</span>.<span style=color:#a6e22e>toStatusRuntimeException</span>(ClientCalls.<span style=color:#a6e22e>java</span>:274)
</span></span><span style=display:flex><span>	at io.<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>stub</span>.<span style=color:#a6e22e>ClientCalls</span>.<span style=color:#a6e22e>getUnchecked</span>(ClientCalls.<span style=color:#a6e22e>java</span>:255)
</span></span><span style=display:flex><span>	at io.<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>stub</span>.<span style=color:#a6e22e>ClientCalls</span>.<span style=color:#a6e22e>blockingUnaryCall</span>(ClientCalls.<span style=color:#a6e22e>java</span>:166)
</span></span><span style=display:flex><span>	at io.<span style=color:#a6e22e>github</span>.<span style=color:#a6e22e>helloworlde</span>.<span style=color:#a6e22e>HelloServiceGrpc$HelloServiceBlockingStub</span>.<span style=color:#a6e22e>howAreYou</span>(HelloServiceGrpc.<span style=color:#a6e22e>java</span>:157)
</span></span><span style=display:flex><span>	at io.<span style=color:#a6e22e>github</span>.<span style=color:#a6e22e>helloworlde</span>.<span style=color:#a6e22e>CustomClient</span>.<span style=color:#a6e22e>howAreYou</span>(CustomClient.<span style=color:#a6e22e>java</span>:74)
</span></span><span style=display:flex><span>	at io.<span style=color:#a6e22e>github</span>.<span style=color:#a6e22e>helloworlde</span>.<span style=color:#a6e22e>CustomClient</span>.<span style=color:#a6e22e>main</span>(CustomClient.<span style=color:#a6e22e>java</span>:66)
</span></span></code></pre></div><h2 id=实现>实现</h2><h3 id=定义>定义</h3><p>健康检查通过 <code>health.proto</code> 文件定义</p><ul><li>health.proto</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> grpc<span style=color:#f92672>.</span>health.v1;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> csharp_namespace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Grpc.Health.V1&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> go_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;google.golang.org/grpc/health/grpc_health_v1&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> java_multiple_files <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> java_outer_classname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HealthProto&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> java_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;io.grpc.health.v1&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>HealthCheckRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>service</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>HealthCheckResponse</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>enum</span> ServingStatus {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    UNKNOWN <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    SERVING <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    NOT_SERVING <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    SERVICE_UNKNOWN <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  }<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  ServingStatus status <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>service</span> Health {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e>// 单次健康检查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>rpc</span> Check(HealthCheckRequest) <span style=color:#66d9ef>returns</span> (HealthCheckResponse);<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e>// 流式健康检查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>rpc</span> Watch(HealthCheckRequest) <span style=color:#66d9ef>returns</span> (stream HealthCheckResponse);<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=客户端-1>客户端</h3><h4 id=执行检查>执行检查</h4><h5 id=发起检查>发起检查</h5><ol><li>获取配置</li></ol><p>在 <code>NameResolver</code> 解析后，调用 <code>io.grpc.internal.ManagedChannelImpl.NameResolverListener#onResult</code> 时检查是否有健康检查的配置，如果有则将配置添加到 <code>Attributes</code> 中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 获取属性</span>
</span></span><span style=display:flex><span>Attributes effectiveAttrs <span style=color:#f92672>=</span> resolutionResult.<span style=color:#a6e22e>getAttributes</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果服务发现没有关闭</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (NameResolverListener.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>helper</span> <span style=color:#f92672>==</span> ManagedChannelImpl.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>lbHelper</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取健康检查</span>
</span></span><span style=display:flex><span>  Map<span style=color:#f92672>&lt;</span>String, <span style=color:#f92672>?&gt;</span> healthCheckingConfig <span style=color:#f92672>=</span> effectiveServiceConfig.<span style=color:#a6e22e>getHealthCheckingConfig</span>();
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 构建健康检查配置</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (healthCheckingConfig <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    effectiveAttrs <span style=color:#f92672>=</span> effectiveAttrs.<span style=color:#a6e22e>toBuilder</span>()
</span></span><span style=display:flex><span>                                   .<span style=color:#a6e22e>set</span>(LoadBalancer.<span style=color:#a6e22e>ATTR_HEALTH_CHECKING_CONFIG</span>, healthCheckingConfig)
</span></span><span style=display:flex><span>                                   .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 更新负载均衡算法，处理未处理的请求</span>
</span></span><span style=display:flex><span>  Status handleResult <span style=color:#f92672>=</span> helper.<span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>tryHandleResolvedAddresses</span>(
</span></span><span style=display:flex><span>          ResolvedAddresses.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>                           .<span style=color:#a6e22e>setAddresses</span>(servers)
</span></span><span style=display:flex><span>                           .<span style=color:#a6e22e>setAttributes</span>(effectiveAttrs)
</span></span><span style=display:flex><span>                           .<span style=color:#a6e22e>setLoadBalancingPolicyConfig</span>(effectiveServiceConfig.<span style=color:#a6e22e>getLoadBalancingConfig</span>())
</span></span><span style=display:flex><span>                           .<span style=color:#a6e22e>build</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>为 <code>Subchannel</code> 配置健康检查</li></ol><p>通过代理调用 <code>io.grpc.util.RoundRobinLoadBalancer#handleResolvedAddresses</code>方法，然后调用 <code>io.grpc.services.HealthCheckingLoadBalancerFactory.HelperImpl#createSubchannel</code> 方法创建 <code>Subchannel</code>；创建用于健康检查的 <code>SubchannelStateListener</code>的实例 <code>HealthCheckState</code></p><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HelperImpl#createSubchannel</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>HealthCheckState hcState <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HealthCheckState(<span style=color:#66d9ef>this</span>, originalSubchannel, syncContext, delegate.<span style=color:#a6e22e>getScheduledExecutorService</span>());
</span></span></code></pre></div><ol start=3><li>添加健康检查</li></ol><p>如果有设置健康检查，则将健康检查添加到 <code>Subchannel</code>健康检查集合中；然后调用 <code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#setServiceName</code> 方法执行</p><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#setServiceName</code></li></ul><p>如果此时有已经提交的请求，则取消，并发送健康检查请求；当第一次执行的时候，如果状态是 <code>IDLE</code>s，则会跳出不执行，直到状态变为<code>READY</code>时执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setServiceName</span>(<span style=color:#a6e22e>@Nullable</span> String newServiceName) {
</span></span><span style=display:flex><span>    serviceName <span style=color:#f92672>=</span> newServiceName;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果在 RPC 请求期间服务名称更改，请取消该服务，以便用新名称进行新的调用</span>
</span></span><span style=display:flex><span>    String cancelMsg <span style=color:#f92672>=</span> serviceName <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;Health check disabled by service config&#34;</span>
</span></span><span style=display:flex><span>            : <span style=color:#e6db74>&#34;Switching to new service name: &#34;</span> <span style=color:#f92672>+</span> newServiceName;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 停止调用</span>
</span></span><span style=display:flex><span>    stopRpc(cancelMsg);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调整健康检查</span>
</span></span><span style=display:flex><span>    adjustHealthCheck();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.internal.InternalSubchannel.TransportListener#transportReady</code></li></ul><p>当 <code>Transport</code> 状态是<code>READY</code> 的时候，开始健康检查</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>transportReady</span>() {
</span></span><span style=display:flex><span>      syncContext.<span style=color:#a6e22e>execute</span>(<span style=color:#66d9ef>new</span> Runnable() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>          reconnectPolicy <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> (shutdownReason <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            Preconditions.<span style=color:#a6e22e>checkState</span>(activeTransport <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#34;Unexpected non-null activeTransport&#34;</span>);
</span></span><span style=display:flex><span>            transport.<span style=color:#a6e22e>shutdown</span>(shutdownReason);
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (pendingTransport <span style=color:#f92672>==</span> transport) {
</span></span><span style=display:flex><span>            activeTransport <span style=color:#f92672>=</span> transport;
</span></span><span style=display:flex><span>            pendingTransport <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            gotoNonErrorState(READY);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><ul><li><code>io.grpc.internal.InternalSubchannel#gotoState</code>
将状态变为 <code>READY</code> 状态，</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>gotoState</span>(<span style=color:#66d9ef>final</span> ConnectivityStateInfo newState) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (state.<span style=color:#a6e22e>getState</span>() <span style=color:#f92672>!=</span> newState.<span style=color:#a6e22e>getState</span>()) {
</span></span><span style=display:flex><span>      Preconditions.<span style=color:#a6e22e>checkState</span>(state.<span style=color:#a6e22e>getState</span>() <span style=color:#f92672>!=</span> SHUTDOWN,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Cannot transition out of SHUTDOWN to &#34;</span> <span style=color:#f92672>+</span> newState);
</span></span><span style=display:flex><span>      state <span style=color:#f92672>=</span> newState;
</span></span><span style=display:flex><span>      callback.<span style=color:#a6e22e>onStateChange</span>(InternalSubchannel.<span style=color:#a6e22e>this</span>, newState);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li><code>ManagedInternalSubchannelCallback#onStateChange</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onStateChange</span>(InternalSubchannel is, ConnectivityStateInfo newState) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 调用服务发现，重新解析</span>
</span></span><span style=display:flex><span>  handleInternalSubchannelState(newState);
</span></span><span style=display:flex><span>  checkState(listener <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#34;listener is null&#34;</span>);
</span></span><span style=display:flex><span>  listener.<span style=color:#a6e22e>onSubchannelState</span>(newState);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#onSubchannelState</code></li></ul><p>当 <code>Subchannel</code> 状态发生变化时执行健康检查</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onSubchannelState</span>(ConnectivityStateInfo rawState) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果当前的状态是 READY，且新的状态不是 READY，则更新 disabled 为 false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Objects.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rawState</span>.<span style=color:#a6e22e>getState</span>(), READY)
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>Objects.<span style=color:#a6e22e>equal</span>(rawState.<span style=color:#a6e22e>getState</span>(), READY)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 断开连接，将重置已禁用标志，因为健康检查在新连接上可能可用</span>
</span></span><span style=display:flex><span>        disabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是 SHUTDOWN，则移除</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Objects.<span style=color:#a6e22e>equal</span>(rawState.<span style=color:#a6e22e>getState</span>(), SHUTDOWN)) {
</span></span><span style=display:flex><span>        helperImpl.<span style=color:#a6e22e>hcStates</span>.<span style=color:#a6e22e>remove</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rawState</span> <span style=color:#f92672>=</span> rawState;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 调整健康检查状态</span>
</span></span><span style=display:flex><span>    adjustHealthCheck();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#adjustHealthCheck</code></li></ul><p>当没有禁止，且服务名不为空，且连接状态是 READY，则发送健康检查的请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>adjustHealthCheck</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果没有禁止，且服务名不为空，且连接状态是 READY</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>disabled <span style=color:#f92672>&amp;&amp;</span> serviceName <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> Objects.<span style=color:#a6e22e>equal</span>(rawState.<span style=color:#a6e22e>getState</span>(), READY)) {
</span></span><span style=display:flex><span>        running <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果没有活跃的 RPC，且重试计时器没有等待，则开始 RPC</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (activeRpc <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>isRetryTimerPending()) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 执行健康检查，并根据结果发送请求</span>
</span></span><span style=display:flex><span>            startRpc();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        running <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        stopRpc(<span style=color:#e6db74>&#34;Client stops health check&#34;</span>);
</span></span><span style=display:flex><span>        backoffPolicy <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        gotoState(rawState);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState#startRpc</code></li></ul><p>在开始健康检查之前，将连接状态由 <code>READY</code> 改为 <code>CONNECTING</code>；
创建新的 <code>ClientCall.Listener</code>实例 <code>HcStream</code>，并调用 <code>start</code> 方法，发起请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startRpc</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>Objects.<span style=color:#a6e22e>equal</span>(concludedState.<span style=color:#a6e22e>getState</span>(), READY)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 修改连接状态</span>
</span></span><span style=display:flex><span>        gotoState(ConnectivityStateInfo.<span style=color:#a6e22e>forNonError</span>(CONNECTING));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建新的 ClientCall.Listener</span>
</span></span><span style=display:flex><span>    activeRpc <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HcStream();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开始调用，发出请求</span>
</span></span><span style=display:flex><span>    activeRpc.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#HcStream</code></li></ul><p>在 <code>HcStream</code> 构造方法中，创建新的 Stream 请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>HcStream() {
</span></span><span style=display:flex><span>    stopwatch <span style=color:#f92672>=</span> stopwatchSupplier.<span style=color:#a6e22e>get</span>().<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>    callServiceName <span style=color:#f92672>=</span> serviceName;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开始新的调用</span>
</span></span><span style=display:flex><span>    call <span style=color:#f92672>=</span> subchannel.<span style=color:#a6e22e>asChannel</span>().<span style=color:#a6e22e>newCall</span>(HealthGrpc.<span style=color:#a6e22e>getWatchMethod</span>(), CallOptions.<span style=color:#a6e22e>DEFAULT</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.internal.SubchannelChannel#newCall</code></li></ul><p>发起一个 <code>SERVER_STREAMING</code> 请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>RequestT, ResponseT<span style=color:#f92672>&gt;</span> ClientCall<span style=color:#f92672>&lt;</span>RequestT, ResponseT<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>newCall</span>(MethodDescriptor<span style=color:#f92672>&lt;</span>RequestT, ResponseT<span style=color:#f92672>&gt;</span> methodDescriptor, CallOptions callOptions) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Executor effectiveExecutor <span style=color:#f92672>=</span> callOptions.<span style=color:#a6e22e>getExecutor</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> executor : callOptions.<span style=color:#a6e22e>getExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ClientCallImpl<span style=color:#f92672>&lt;&gt;</span>(methodDescriptor,
</span></span><span style=display:flex><span>        effectiveExecutor,
</span></span><span style=display:flex><span>        callOptions.<span style=color:#a6e22e>withOption</span>(GrpcUtil.<span style=color:#a6e22e>CALL_OPTIONS_RPC_OWNED_BY_BALANCER</span>, Boolean.<span style=color:#a6e22e>TRUE</span>),
</span></span><span style=display:flex><span>        transportProvider, deadlineCancellationExecutor, callsTracer, <span style=color:#66d9ef>false</span> <span style=color:#75715e>/* retryEnabled */</span>);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#start</code></li></ul><p>开始调用，使用服务名作为健康检查的参数，向服务端发起健康检查请求
此时服务端接收到健康检查请求，根据请求的参数进行检查，然后返回结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开始调用</span>
</span></span><span style=display:flex><span>    call.<span style=color:#a6e22e>start</span>(<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>new</span> Metadata());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送服务健康检查消息</span>
</span></span><span style=display:flex><span>    call.<span style=color:#a6e22e>sendMessage</span>(HealthCheckRequest.<span style=color:#a6e22e>newBuilder</span>().<span style=color:#a6e22e>setService</span>(serviceName).<span style=color:#a6e22e>build</span>());
</span></span><span style=display:flex><span>    call.<span style=color:#a6e22e>halfClose</span>();
</span></span><span style=display:flex><span>    call.<span style=color:#a6e22e>request</span>(1);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=处理结果>处理结果</h5><ul><li><code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#onMessage</code></li></ul><p>监听响应结果，如果是当前 <code>Subchannel</code>的请求响应，则进行处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMessage</span>(<span style=color:#66d9ef>final</span> HealthCheckResponse response) {
</span></span><span style=display:flex><span>    syncContext.<span style=color:#a6e22e>execute</span>(<span style=color:#66d9ef>new</span> Runnable() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果是当前的请求，则进行处理</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (activeRpc <span style=color:#f92672>==</span> HcStream.<span style=color:#a6e22e>this</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 根据响应更新连接状态</span>
</span></span><span style=display:flex><span>                handleResponse(response);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>根据响应结果处理连接状态</li></ul><p>在 <code>io.grpc.services.HealthCheckingLoadBalancerFactory.HealthCheckState.HcStream#handleResponse</code> 方法中处理响应结果；如果是 <code>SERVING</code>状态，则将连接状态改为 <code>READY</code>，否则将状态改为 <code>UNAVAILABLE</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleResponse</span>(HealthCheckResponse response) {
</span></span><span style=display:flex><span>    callHasResponded <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    backoffPolicy <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取返回的状态</span>
</span></span><span style=display:flex><span>    ServingStatus status <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getStatus</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果是服务中，则更新连接状态为 READY</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Objects.<span style=color:#a6e22e>equal</span>(status, ServingStatus.<span style=color:#a6e22e>SERVING</span>)) {
</span></span><span style=display:flex><span>        gotoState(ConnectivityStateInfo.<span style=color:#a6e22e>forNonError</span>(READY));
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 更新连接状态为 UNAVAILABLE</span>
</span></span><span style=display:flex><span>        gotoState(ConnectivityStateInfo.<span style=color:#a6e22e>forTransientFailure</span>(Status.<span style=color:#a6e22e>UNAVAILABLE</span>.<span style=color:#a6e22e>withDescription</span>(<span style=color:#e6db74>&#34;Health-check service responded &#34;</span> <span style=color:#f92672>+</span> status <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for &#39;&#34;</span> <span style=color:#f92672>+</span> callServiceName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    call.<span style=color:#a6e22e>request</span>(1);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也会将 LB 状态也改为 <code>READY</code>，此时 Picker 变为 <code>ReadyPicker</code>，至此，完成健康检查</p><h3 id=server-端-1>Server 端</h3><h4 id=设置服务状态>设置服务状态</h4><h5 id=默认服务>默认服务</h5><p><code>io.grpc.services.HealthServiceImpl#HealthServiceImpl</code> 内有一个 Map，用于存放各个服务的状态；默认含有一个 key 为 <code>""</code>, value 为 <code>SERVING</code>的键值对，当请求参数中没有 seviceName 时直接返回 <code>SERVING</code> 状态</p><h5 id=其他服务>其他服务</h5><p>其他服务需要 Server 主动设置状态，具体的逻辑由自己实现，当服务状态发生变化时，通过调用 <code>io.grpc.services.HealthStatusManager#setStatus</code> 进行设置</p><ul><li><code>io.grpc.services.HealthStatusManager#setStatus</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setStatus</span>(String service, ServingStatus status) {
</span></span><span style=display:flex><span>    checkNotNull(status, <span style=color:#e6db74>&#34;status&#34;</span>);
</span></span><span style=display:flex><span>    healthService.<span style=color:#a6e22e>setStatus</span>(service, status);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthServiceImpl#setStatus</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setStatus</span>(String service, ServingStatus status) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> (watchLock) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (terminal) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        setStatusInternal(service, status);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthServiceImpl#setStatusInternal</code></li></ul><p>为 service 设置状态，当状态发生变化时，通过 Stream 发送响应给客户端，通知状态变化</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setStatusInternal</span>(String service, ServingStatus status) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置新的状态</span>
</span></span><span style=display:flex><span>    ServingStatus prevStatus <span style=color:#f92672>=</span> statusMap.<span style=color:#a6e22e>put</span>(service, status);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果状态不一样，则通知状态变化</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (prevStatus <span style=color:#f92672>!=</span> status) {
</span></span><span style=display:flex><span>        notifyWatchers(service, status);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>io.grpc.services.HealthServiceImpl#notifyWatchers</code></li></ul><p>如果有客户端 Stream，则将状态变化通知给所有的监听该服务的客户端</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notifyWatchers</span>(String service, <span style=color:#a6e22e>@Nullable</span> ServingStatus status) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构建结果</span>
</span></span><span style=display:flex><span>    HealthCheckResponse response <span style=color:#f92672>=</span> getResponseForWatch(status);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IdentityHashMap<span style=color:#f92672>&lt;</span>StreamObserver<span style=color:#f92672>&lt;</span>HealthCheckResponse<span style=color:#f92672>&gt;</span>, Boolean<span style=color:#f92672>&gt;</span> serviceWatchers <span style=color:#f92672>=</span> watchers.<span style=color:#a6e22e>get</span>(service);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果有监听，则遍历所有的监听，发送结果</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (serviceWatchers <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (StreamObserver<span style=color:#f92672>&lt;</span>HealthCheckResponse<span style=color:#f92672>&gt;</span> responseObserver : serviceWatchers.<span style=color:#a6e22e>keySet</span>()) {
</span></span><span style=display:flex><span>            responseObserver.<span style=color:#a6e22e>onNext</span>(response);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=处理健康检查>处理健康检查</h4><h5 id=单次请求>单次请求</h5><p>单次健康检查请求通过 <code>io.grpc.services.HealthServiceImpl#check</code> 处理，会根据当前的状态返回</p><ul><li><code>io.grpc.services.HealthServiceImpl#check</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>check</span>(HealthCheckRequest request,
</span></span><span style=display:flex><span>                  StreamObserver<span style=color:#f92672>&lt;</span>HealthCheckResponse<span style=color:#f92672>&gt;</span> responseObserver) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据请求中的服务名获取状态</span>
</span></span><span style=display:flex><span>    ServingStatus status <span style=color:#f92672>=</span> statusMap.<span style=color:#a6e22e>get</span>(request.<span style=color:#a6e22e>getService</span>());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果状态是 null，则返回 NOT_FOUND 错误</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (status <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        responseObserver.<span style=color:#a6e22e>onError</span>(<span style=color:#66d9ef>new</span> StatusException(Status.<span style=color:#a6e22e>NOT_FOUND</span>.<span style=color:#a6e22e>withDescription</span>(<span style=color:#e6db74>&#34;unknown service &#34;</span> <span style=color:#f92672>+</span> request.<span style=color:#a6e22e>getService</span>())));
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据状态构造响应</span>
</span></span><span style=display:flex><span>        HealthCheckResponse response <span style=color:#f92672>=</span> HealthCheckResponse.<span style=color:#a6e22e>newBuilder</span>().<span style=color:#a6e22e>setStatus</span>(status).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        responseObserver.<span style=color:#a6e22e>onNext</span>(response);
</span></span><span style=display:flex><span>        responseObserver.<span style=color:#a6e22e>onCompleted</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=stream-请求>Stream 请求</h5><p>对于 Stream 请求，是通过 <code>io.grpc.services.HealthServiceImpl#watch</code> 处理
当接收到请求后，会从 Map 中获取服务状态，然后生成响应返回给客户端；
然后将该 <code>StreamObserver</code> 保存到 Service 对应的 Map 中，当 Service 状态发生变化时，通知相应的 Client
同时添加了监听器，当客户端关闭时，从 Map 中移除该 <code>StreamObserver</code></p><ul><li><code>io.grpc.services.HealthServiceImpl#watch</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>watch</span>(HealthCheckRequest request,
</span></span><span style=display:flex><span>                  <span style=color:#66d9ef>final</span> StreamObserver<span style=color:#f92672>&lt;</span>HealthCheckResponse<span style=color:#f92672>&gt;</span> responseObserver) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String service <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getService</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加锁</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> (watchLock) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据服务获取状态，构建结果，并发送出去</span>
</span></span><span style=display:flex><span>        ServingStatus status <span style=color:#f92672>=</span> statusMap.<span style=color:#a6e22e>get</span>(service);
</span></span><span style=display:flex><span>        responseObserver.<span style=color:#a6e22e>onNext</span>(getResponseForWatch(status));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从 watcher 中获取服务名的 map，如果不存在，则创建一个</span>
</span></span><span style=display:flex><span>        IdentityHashMap<span style=color:#f92672>&lt;</span>StreamObserver<span style=color:#f92672>&lt;</span>HealthCheckResponse<span style=color:#f92672>&gt;</span>, Boolean<span style=color:#f92672>&gt;</span> serviceWatchers <span style=color:#f92672>=</span> watchers.<span style=color:#a6e22e>get</span>(service);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (serviceWatchers <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            serviceWatchers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> IdentityHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>            watchers.<span style=color:#a6e22e>put</span>(service, serviceWatchers);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果存在，则将 responseObserver 添加到 map 中</span>
</span></span><span style=display:flex><span>        serviceWatchers.<span style=color:#a6e22e>put</span>(responseObserver, Boolean.<span style=color:#a6e22e>TRUE</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Context.<span style=color:#a6e22e>current</span>().<span style=color:#a6e22e>addListener</span>(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> CancellationListener() {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Called when the client has closed the stream</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cancelled</span>(Context context) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>synchronized</span> (watchLock) {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 当客户端关闭时，从 map 中移除方法对应的数据</span>
</span></span><span style=display:flex><span>                        IdentityHashMap<span style=color:#f92672>&lt;</span>StreamObserver<span style=color:#f92672>&lt;</span>HealthCheckResponse<span style=color:#f92672>&gt;</span>, Boolean<span style=color:#f92672>&gt;</span> serviceWatchers <span style=color:#f92672>=</span> watchers.<span style=color:#a6e22e>get</span>(service);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (serviceWatchers <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                            serviceWatchers.<span style=color:#a6e22e>remove</span>(responseObserver);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (serviceWatchers.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>                                watchers.<span style=color:#a6e22e>remove</span>(service);
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            MoreExecutors.<span style=color:#a6e22e>directExecutor</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2020-2025 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>