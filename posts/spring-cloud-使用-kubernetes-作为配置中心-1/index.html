<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Cloud 使用 Kubernetes 作为配置中心</title><meta charset=utf-8><meta name=description content="Ladder@Spring Cloud 使用 Kubernetes 作为配置中心 Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中
加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加载，Secret 使用 SecretsPropertySourceLocator加载
Bean 初始化 @Bean @ConditionalOnProperty(name = &#34;spring.cloud.kubernetes.config.enabled&#34;, matchIfMissing = true) public ConfigMapPropertySourceLocator configMapPropertySourceLocator(ConfigMapConfigProperties properties) { return new ConfigMapPropertySourceLocator(this.client, properties); } @Bean @ConditionalOnProperty(name = &#34;spring.cloud.kubernetes.secrets.enabled&#34;, matchIfMissing = true) public SecretsPropertySourceLocator secretsPropertySourceLocator(SecretsConfigProperties properties) { return new SecretsPropertySourceLocator(this.client, properties); } 获取配置 获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中
ConfigMap ConfigMapPropertySourceLocator#locate @Override public PropertySource locate(Environment environment) { if (environment instanceof ConfigurableEnvironment) { ConfigurableEnvironment env = (ConfigurableEnvironment) environment; List<ConfigMapConfigProperties."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/umami.js></script><meta property="og:title" content="Spring Cloud 使用 Kubernetes 作为配置中心"><meta property="og:description" content="Spring Cloud 使用 Kubernetes 作为配置中心 Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中
加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加载，Secret 使用 SecretsPropertySourceLocator加载
Bean 初始化 @Bean @ConditionalOnProperty(name = &#34;spring.cloud.kubernetes.config.enabled&#34;, matchIfMissing = true) public ConfigMapPropertySourceLocator configMapPropertySourceLocator(ConfigMapConfigProperties properties) { return new ConfigMapPropertySourceLocator(this.client, properties); } @Bean @ConditionalOnProperty(name = &#34;spring.cloud.kubernetes.secrets.enabled&#34;, matchIfMissing = true) public SecretsPropertySourceLocator secretsPropertySourceLocator(SecretsConfigProperties properties) { return new SecretsPropertySourceLocator(this.client, properties); } 获取配置 获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中
ConfigMap ConfigMapPropertySourceLocator#locate @Override public PropertySource locate(Environment environment) { if (environment instanceof ConfigurableEnvironment) { ConfigurableEnvironment env = (ConfigurableEnvironment) environment; List<ConfigMapConfigProperties."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-20T22:28:15+00:00"><meta property="article:modified_time" content="2020-09-20T22:28:15+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Cloud 使用 Kubernetes 作为配置中心"><meta name=twitter:description content="Spring Cloud 使用 Kubernetes 作为配置中心 Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中
加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加载，Secret 使用 SecretsPropertySourceLocator加载
Bean 初始化 @Bean @ConditionalOnProperty(name = &#34;spring.cloud.kubernetes.config.enabled&#34;, matchIfMissing = true) public ConfigMapPropertySourceLocator configMapPropertySourceLocator(ConfigMapConfigProperties properties) { return new ConfigMapPropertySourceLocator(this.client, properties); } @Bean @ConditionalOnProperty(name = &#34;spring.cloud.kubernetes.secrets.enabled&#34;, matchIfMissing = true) public SecretsPropertySourceLocator secretsPropertySourceLocator(SecretsConfigProperties properties) { return new SecretsPropertySourceLocator(this.client, properties); } 获取配置 获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中
ConfigMap ConfigMapPropertySourceLocator#locate @Override public PropertySource locate(Environment environment) { if (environment instanceof ConfigurableEnvironment) { ConfigurableEnvironment env = (ConfigurableEnvironment) environment; List<ConfigMapConfigProperties."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"Spring Cloud 使用 Kubernetes 作为配置中心","item":"https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Cloud 使用 Kubernetes 作为配置中心","name":"Spring Cloud 使用 Kubernetes 作为配置中心","description":"Spring Cloud 使用 Kubernetes 作为配置中心 Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中\n加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加载，Secret 使用 SecretsPropertySourceLocator加载\nBean 初始化 @Bean @ConditionalOnProperty(name = \u0026#34;spring.cloud.kubernetes.config.enabled\u0026#34;, matchIfMissing = true) public ConfigMapPropertySourceLocator configMapPropertySourceLocator(ConfigMapConfigProperties properties) { return new ConfigMapPropertySourceLocator(this.client, properties); } @Bean @ConditionalOnProperty(name = \u0026#34;spring.cloud.kubernetes.secrets.enabled\u0026#34;, matchIfMissing = true) public SecretsPropertySourceLocator secretsPropertySourceLocator(SecretsConfigProperties properties) { return new SecretsPropertySourceLocator(this.client, properties); } 获取配置 获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中\nConfigMap ConfigMapPropertySourceLocator#locate @Override public PropertySource locate(Environment environment) { if (environment instanceof ConfigurableEnvironment) { ConfigurableEnvironment env = (ConfigurableEnvironment) environment; List\u0026lt;ConfigMapConfigProperties.","keywords":["Java","SpringCloud"],"articleBody":"Spring Cloud 使用 Kubernetes 作为配置中心 Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中\n加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加载，Secret 使用 SecretsPropertySourceLocator加载\nBean 初始化 @Bean @ConditionalOnProperty(name = \"spring.cloud.kubernetes.config.enabled\", matchIfMissing = true) public ConfigMapPropertySourceLocator configMapPropertySourceLocator(ConfigMapConfigProperties properties) { return new ConfigMapPropertySourceLocator(this.client, properties); } @Bean @ConditionalOnProperty(name = \"spring.cloud.kubernetes.secrets.enabled\", matchIfMissing = true) public SecretsPropertySourceLocator secretsPropertySourceLocator(SecretsConfigProperties properties) { return new SecretsPropertySourceLocator(this.client, properties); } 获取配置 获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中\nConfigMap ConfigMapPropertySourceLocator#locate @Override public PropertySource locate(Environment environment) { if (environment instanceof ConfigurableEnvironment) { ConfigurableEnvironment env = (ConfigurableEnvironment) environment; List\u003cConfigMapConfigProperties.NormalizedSource\u003e sources = this.properties.determineSources(); CompositePropertySource composite = new CompositePropertySource(\"composite-configmap\"); if (this.properties.isEnableApi()) { sources.forEach(s -\u003e composite.addFirstPropertySource( getMapPropertySourceForSingleConfigMap(env, s))); } // 将配置添加的容器环境中 addPropertySourcesFromPaths(environment, composite); return composite; } return null; } 真正向 Kubernetes 发起请求的是通过调用 getMapPropertySourceForSingleConfigMap 方法，创建ConfigMapPropertySource实例的时候，会根据 getData 方法，从 ConfigMap 获取属性解析并添加到环境中\nConfigMapPropertySourceLocator#getMapPropertySourceForSingleConfigMap private MapPropertySource getMapPropertySourceForSingleConfigMap( ConfigurableEnvironment environment, NormalizedSource normalizedSource) { String configurationTarget = this.properties.getConfigurationTarget(); // 创建新的属性 return new ConfigMapPropertySource(this.client, getApplicationName(environment, normalizedSource.getName(), configurationTarget), getApplicationNamespace(this.client, normalizedSource.getNamespace(), configurationTarget), environment); } ConfigMapPropertySource public ConfigMapPropertySource(KubernetesClient client, String name, String namespace, Environment environment) { super(getName(client, name, namespace), asObjectMap(getData(client, name, namespace, environment))); } ConfigMapPropertySource#getData private static Map\u003cString, Object\u003e getData(KubernetesClient client, String name, String namespace, Environment environment) { try { Map\u003cString, Object\u003e result = new LinkedHashMap\u003c\u003e(); // 获取 ConfigMap ConfigMap map = StringUtils.isEmpty(namespace) ? client.configMaps().withName(name).get() : client.configMaps().inNamespace(namespace).withName(name).get(); // 添加到map 中 if (map != null) { result.putAll(processAllEntries(map.getData(), environment)); } if (environment != null) { // 根据 Profile 加载 ConfigMap for (String activeProfile : environment.getActiveProfiles()) { String mapNameWithProfile = name + \"-\" + activeProfile; ConfigMap mapWithProfile = StringUtils.isEmpty(namespace) ? client.configMaps().withName(mapNameWithProfile).get() : client.configMaps().inNamespace(namespace) .withName(mapNameWithProfile).get(); if (mapWithProfile != null) { result.putAll( processAllEntries(mapWithProfile.getData(), environment)); } } } return result; } catch (Exception e) { LOG.warn(\"Can't read configMap with name: [\" + name + \"] in namespace:[\" + namespace + \"]. Ignoring.\", e); } return new LinkedHashMap\u003c\u003e(); } Secret SecretsPropertySourceLocator#locate @Override public PropertySource locate(Environment environment) { if (environment instanceof ConfigurableEnvironment) { ConfigurableEnvironment env = (ConfigurableEnvironment) environment; List\u003cSecretsConfigProperties.NormalizedSource\u003e sources = this.properties.determineSources(); CompositePropertySource composite = new CompositePropertySource(\"composite-secrets\"); if (this.properties.isEnableApi()) { // 获取Secret sources.forEach(s -\u003e composite.addFirstPropertySource( getKubernetesPropertySourceForSingleSecret(env, s))); } // read for secrets mount // 读取并加入到容器中 putPathConfig(composite); return composite; } return null; } SecretsPropertySourceLocator#getKubernetesPropertySourceForSingleSecret private MapPropertySource getKubernetesPropertySourceForSingleSecret( ConfigurableEnvironment environment, SecretsConfigProperties.NormalizedSource normalizedSource) { String configurationTarget = this.properties.getConfigurationTarget(); // 加载 Secret 属性 source return new SecretsPropertySource(this.client, environment, getApplicationName(environment, normalizedSource.getName(), configurationTarget), getApplicationNamespace(this.client, normalizedSource.getNamespace(), configurationTarget), normalizedSource.getLabels()); } SecretsPropertySource public SecretsPropertySource(KubernetesClient client, Environment env, String name, String namespace, Map\u003cString, String\u003e labels) { super(getSourceName(client, env, name, namespace), getSourceData(client, env, name, namespace, labels)); } SecretsPropertySource#getSourceData 获取 Secret 的流程和获取 ConfigMap 一样，不同的是 Secret 在放入环境中之前，需要先通过 Base64 解码\nprivate static Map\u003cString, Object\u003e getSourceData(KubernetesClient client, Environment env, String name, String namespace, Map\u003cString, String\u003e labels) { Map\u003cString, Object\u003e result = new HashMap\u003c\u003e(); try { // Read for secrets api (named) // 根据名称和命名空间获取 secret Secret secret; if (StringUtils.isEmpty(namespace)) { secret = client.secrets() .withName(name) .get(); } else { secret = client.secrets() .inNamespace(namespace) .withName(name) .get(); } // 解码 putAll(secret, result); // Read for secrets api (label) // 根据 label 读取 Secret if (!labels.isEmpty()) { if (StringUtils.isEmpty(namespace)) { client.secrets() .withLabels(labels) .list() .getItems() .forEach(s -\u003e putAll(s, result)); } else { client.secrets() .inNamespace(namespace) .withLabels(labels) .list() .getItems() .forEach(s -\u003e putAll(s, result)); } } } catch (Exception e) { LOG.warn(\"Can't read secret with name: [\" + name + \"] or labels [\" + labels + \"] in namespace:[\" + namespace + \"] (cause: \" + e.getMessage() + \"). Ignoring\"); } return result; } 监听配置 支持两种方式的监听配置，一种是通过和 Kubernetes 建立长连接，当配置发生变化时可以立即推送，另一种是通过长轮询的方式，通过定时任务来实现\n配置的监听必须显式开启\nBean 初始化 Bean 的初始化是在 org.springframework.cloud.kubernetes.config.reload.ConfigReloadAutoConfiguration.ConfigReloadAutoConfigurationBeans 中实现的\n监听配置变化 根据配置选择是通过轮询还是监听事件方式实现，默认是监听事件\n@Bean @ConditionalOnMissingBean public ConfigurationChangeDetector propertyChangeWatcher(ConfigReloadProperties properties, ConfigurationUpdateStrategy strategy) { switch (properties.getMode()) { case POLLING: return new PollingConfigurationChangeDetector(this.environment, properties, this.kubernetesClient, strategy, this.configMapPropertySourceLocator, this.secretsPropertySourceLocator); case EVENT: return new EventBasedConfigurationChangeDetector(this.environment, properties, this.kubernetesClient, strategy, this.configMapPropertySourceLocator, this.secretsPropertySourceLocator); } throw new IllegalStateException(\"Unsupported configuration reload mode: \" + properties.getMode()); } 配置更新策略 配置更新支持三种策略，分别是重启，刷新，和关闭，关闭应用依赖于健康检查，当发现应用被关闭后需要通过 Kubernetes 主动拉起\n默认策略是刷新上下文\n@Bean @ConditionalOnMissingBean public ConfigurationUpdateStrategy configurationUpdateStrategy( ConfigReloadProperties properties, ConfigurableApplicationContext ctx, @Autowired(required = false) RestartEndpoint restarter, ContextRefresher refresher) { switch (properties.getStrategy()) { // 重启 case RESTART_CONTEXT: Assert.notNull(restarter, \"Restart endpoint is not enabled\"); return new ConfigurationUpdateStrategy(properties.getStrategy().name(), () -\u003e { wait(properties); restarter.restart(); }); //\t刷新 case REFRESH: return new ConfigurationUpdateStrategy(properties.getStrategy().name(), refresher::refresh); //\t关闭 case SHUTDOWN: return new ConfigurationUpdateStrategy(properties.getStrategy().name(), () -\u003e { wait(properties); ctx.close(); }); } throw new IllegalStateException(\"Unsupported configuration update strategy: \" + properties.getStrategy()); } 监听实现 PollingConfigurationChangeDetector 和 EventBasedConfigurationChangeDetector 都是 ConfigurationChangeDetector的子类\npolling 默认 15s 拉取一次配置\nPollingConfigurationChangeDetector#executeCycle @Scheduled(initialDelayString = \"${spring.cloud.kubernetes.reload.period:15000}\", fixedDelayString = \"${spring.cloud.kubernetes.reload.period:15000}\") public void executeCycle() { boolean changedConfigMap = false; // 监控 ConfigMap if (this.properties.isMonitoringConfigMaps()) { List\u003c? extends MapPropertySource\u003e currentConfigMapSources = findPropertySources(ConfigMapPropertySource.class); if (!currentConfigMapSources.isEmpty()) { changedConfigMap = changed( locateMapPropertySources(this.configMapPropertySourceLocator, this.environment), currentConfigMapSources); } } boolean changedSecrets = false; // 监控 Secret if (this.properties.isMonitoringSecrets()) { List\u003cMapPropertySource\u003e currentSecretSources = locateMapPropertySources(this.secretsPropertySourceLocator, this.environment); if (currentSecretSources != null \u0026\u0026 !currentSecretSources.isEmpty()) { List\u003cSecretsPropertySource\u003e propertySources = findPropertySources(SecretsPropertySource.class); changedSecrets = changed(currentSecretSources, propertySources); } } // 当发生变化时，更新属性 if (changedConfigMap || changedSecrets) { reloadProperties(); } } 拉取配置，通过调用change方法进行比较，判断是否发生变化，如果发生变化，则调用 reloadProperties 方法刷新\nConfigurationChangeDetector#reloadProperties public void reloadProperties() { this.log.info(\"Reloading using strategy: \" + this.strategy.getName()); this.strategy.reload(); } 最终调用配置策略的 reload 方法，重新加载配置，需要注意的是，要被刷新的属性类应当通过 @RefreshScope或 @ConfigurationProperties注解修饰，这样才能监听到上下文的变化\nEvent EventBasedConfigurationChangeDetector#watch @PostConstruct public void watch() { boolean activated = false; // 如果监控 ConfigMap if (this.properties.isMonitoringConfigMaps()) { try { String name = \"config-maps-watch\"; // Watch 是通过 WebSocket 实现的 this.watches.put(name, this.kubernetesClient.configMaps() .watch(new Watcher\u003cConfigMap\u003e() { @Override public void eventReceived(Action action, ConfigMap configMap) { onEvent(configMap); } @Override public void onClose(KubernetesClientException e) { } })); activated = true; this.log.info(\"Added new Kubernetes watch: \" + name); } catch (Exception e) { this.log.error( \"Error while establishing a connection to watch config maps: configuration may remain stale\", e); } } // 如果监控 Secret if (this.properties.isMonitoringSecrets()) { try { activated = false; String name = \"secrets-watch\"; this.watches.put(name, this.kubernetesClient.secrets().watch(new Watcher\u003cSecret\u003e() { @Override public void eventReceived(Action action, Secret secret) { onEvent(secret); } @Override public void onClose(KubernetesClientException e) { } })); activated = true; this.log.info(\"Added new Kubernetes watch: \" + name); } catch (Exception e) { this.log.error( \"Error while establishing a connection to watch secrets: configuration may remain stale\", e); } } if (activated) { this.log.info( \"Kubernetes event-based configuration change detector activated\"); } } 当收到消息时，将会调用 onEvent方法处理事件\nEventBasedConfigurationChangeDetector#onEvent private void onEvent(ConfigMap configMap) { // 加载配置，检测是否变化 boolean changed = changed( locateMapPropertySources(this.configMapPropertySourceLocator, this.environment), findPropertySources(ConfigMapPropertySource.class) ); // 如果变化了，则重新加载属性 if (changed) { this.log.info(\"Detected change in config maps\"); reloadProperties(); } } private void onEvent(Secret secret) { boolean changed = changed( locateMapPropertySources(this.secretsPropertySourceLocator, this.environment), findPropertySources(SecretsPropertySource.class)); if (changed) { this.log.info(\"Detected change in secrets\"); reloadProperties(); } } 重新加载配置，当发现配置发生变化时会调用 reloadProperties方法更新配置\n","wordCount":"992","inLanguage":"en","datePublished":"2020-09-20T22:28:15Z","dateModified":"2020-09-20T22:28:15Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/r2Llssnu/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Spring Cloud 使用 Kubernetes 作为配置中心</h1></header><p><small>September 20, 2020&nbsp;· 992 words&nbsp;· 5 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#加载配置>加载配置</a><ul><li><a href=#bean-初始化>Bean 初始化</a></li><li><a href=#获取配置>获取配置</a></li></ul></li><li><a href=#监听配置>监听配置</a><ul><li><a href=#bean-初始化-1>Bean 初始化</a></li><li><a href=#监听实现>监听实现</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=spring-cloud-使用-kubernetes-作为配置中心>Spring Cloud 使用 Kubernetes 作为配置中心</h1><p>Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中</p><h2 id=加载配置>加载配置</h2><p>加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 <code>ConfigMapPropertySourceLocator</code> 加载，Secret 使用 <code>SecretsPropertySourceLocator</code>加载</p><h3 id=bean-初始化>Bean 初始化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnProperty</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.cloud.kubernetes.config.enabled&#34;</span><span style=color:#f92672>,</span> matchIfMissing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> ConfigMapPropertySourceLocator <span style=color:#a6e22e>configMapPropertySourceLocator</span><span style=color:#f92672>(</span>ConfigMapConfigProperties properties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigMapPropertySourceLocator<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>,</span> properties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnProperty</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.cloud.kubernetes.secrets.enabled&#34;</span><span style=color:#f92672>,</span> matchIfMissing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> SecretsPropertySourceLocator <span style=color:#a6e22e>secretsPropertySourceLocator</span><span style=color:#f92672>(</span>SecretsConfigProperties properties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SecretsPropertySourceLocator<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>,</span> properties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=获取配置>获取配置</h3><p>获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中</p><h4 id=configmap>ConfigMap</h4><ul><li>ConfigMapPropertySourceLocator#locate</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> PropertySource <span style=color:#a6e22e>locate</span><span style=color:#f92672>(</span>Environment environment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>environment <span style=color:#66d9ef>instanceof</span> ConfigurableEnvironment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			ConfigurableEnvironment env <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ConfigurableEnvironment<span style=color:#f92672>)</span> environment<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>ConfigMapConfigProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>NormalizedSource</span><span style=color:#f92672>&gt;</span> sources <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>determineSources</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			CompositePropertySource composite <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompositePropertySource<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;composite-configmap&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isEnableApi</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				sources<span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>s <span style=color:#f92672>-&gt;</span> composite<span style=color:#f92672>.</span><span style=color:#a6e22e>addFirstPropertySource</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>					getMapPropertySourceForSingleConfigMap<span style=color:#f92672>(</span>env<span style=color:#f92672>,</span> s<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将配置添加的容器环境中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			addPropertySourcesFromPaths<span style=color:#f92672>(</span>environment<span style=color:#f92672>,</span> composite<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> composite<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>真正向 Kubernetes 发起请求的是通过调用 <code>getMapPropertySourceForSingleConfigMap</code> 方法，创建<code>ConfigMapPropertySource</code>实例的时候，会根据 <code>getData</code> 方法，从 ConfigMap 获取属性解析并添加到环境中</p><ul><li>ConfigMapPropertySourceLocator#getMapPropertySourceForSingleConfigMap</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> MapPropertySource <span style=color:#a6e22e>getMapPropertySourceForSingleConfigMap</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>		ConfigurableEnvironment environment<span style=color:#f92672>,</span> NormalizedSource normalizedSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		String configurationTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getConfigurationTarget</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建新的属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigMapPropertySource<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			getApplicationName<span style=color:#f92672>(</span>environment<span style=color:#f92672>,</span> normalizedSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span> configurationTarget<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			getApplicationNamespace<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>,</span> normalizedSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>(),</span> configurationTarget<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			environment<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>ConfigMapPropertySource</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ConfigMapPropertySource</span><span style=color:#f92672>(</span>KubernetesClient client<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>	                               String name<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>	                               String namespace<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>	                               Environment environment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>getName<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> name<span style=color:#f92672>,</span> namespace<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			asObjectMap<span style=color:#f92672>(</span>getData<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> name<span style=color:#f92672>,</span> namespace<span style=color:#f92672>,</span> environment<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>ConfigMapPropertySource#getData</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getData</span><span style=color:#f92672>(</span>KubernetesClient client<span style=color:#f92672>,</span> String name<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>	                                           String namespace<span style=color:#f92672>,</span> Environment environment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 获取 ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			ConfigMap map <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>?</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>configMaps</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withName</span><span style=color:#f92672>(</span>name<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>:</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>configMaps</span><span style=color:#f92672>().</span><span style=color:#a6e22e>inNamespace</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>).</span><span style=color:#a6e22e>withName</span><span style=color:#f92672>(</span>name<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 添加到map 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>map <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				result<span style=color:#f92672>.</span><span style=color:#a6e22e>putAll</span><span style=color:#f92672>(</span>processAllEntries<span style=color:#f92672>(</span>map<span style=color:#f92672>.</span><span style=color:#a6e22e>getData</span><span style=color:#f92672>(),</span> environment<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>environment <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 根据 Profile 加载 ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String activeProfile <span style=color:#f92672>:</span> environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getActiveProfiles</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					String mapNameWithProfile <span style=color:#f92672>=</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> activeProfile<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					ConfigMap mapWithProfile <span style=color:#f92672>=</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>?</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>configMaps</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withName</span><span style=color:#f92672>(</span>mapNameWithProfile<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>:</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>configMaps</span><span style=color:#f92672>().</span><span style=color:#a6e22e>inNamespace</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>						        <span style=color:#f92672>.</span><span style=color:#a6e22e>withName</span><span style=color:#f92672>(</span>mapNameWithProfile<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mapWithProfile <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						result<span style=color:#f92672>.</span><span style=color:#a6e22e>putAll</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>							processAllEntries<span style=color:#f92672>(</span>mapWithProfile<span style=color:#f92672>.</span><span style=color:#a6e22e>getData</span><span style=color:#f92672>(),</span> environment<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Can&#39;t read configMap with name: [&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] in namespace:[&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> namespace <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]. Ignoring.&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=secret>Secret</h4><ul><li>SecretsPropertySourceLocator#locate</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> PropertySource <span style=color:#a6e22e>locate</span><span style=color:#f92672>(</span>Environment environment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>environment <span style=color:#66d9ef>instanceof</span> ConfigurableEnvironment<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			ConfigurableEnvironment env <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ConfigurableEnvironment<span style=color:#f92672>)</span> environment<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>SecretsConfigProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>NormalizedSource</span><span style=color:#f92672>&gt;</span> sources <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>determineSources</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			CompositePropertySource composite <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompositePropertySource<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;composite-secrets&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isEnableApi</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 获取Secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				sources<span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>s <span style=color:#f92672>-&gt;</span> composite<span style=color:#f92672>.</span><span style=color:#a6e22e>addFirstPropertySource</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>					getKubernetesPropertySourceForSingleSecret<span style=color:#f92672>(</span>env<span style=color:#f92672>,</span> s<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// read for secrets mount
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// 读取并加入到容器中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			putPathConfig<span style=color:#f92672>(</span>composite<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> composite<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>SecretsPropertySourceLocator#getKubernetesPropertySourceForSingleSecret</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> MapPropertySource <span style=color:#a6e22e>getKubernetesPropertySourceForSingleSecret</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>		ConfigurableEnvironment environment<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>		SecretsConfigProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>NormalizedSource</span> normalizedSource<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		String configurationTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getConfigurationTarget</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 加载 Secret 属性 source
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SecretsPropertySource<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			environment<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			getApplicationName<span style=color:#f92672>(</span>environment<span style=color:#f92672>,</span> normalizedSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span> configurationTarget<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			getApplicationNamespace<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>,</span> normalizedSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>(),</span> configurationTarget<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			normalizedSource<span style=color:#f92672>.</span><span style=color:#a6e22e>getLabels</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>SecretsPropertySource</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SecretsPropertySource</span><span style=color:#f92672>(</span>KubernetesClient client<span style=color:#f92672>,</span> Environment env<span style=color:#f92672>,</span> String name<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>	                             String namespace<span style=color:#f92672>,</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> labels<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>getSourceName<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> env<span style=color:#f92672>,</span> name<span style=color:#f92672>,</span> namespace<span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			getSourceData<span style=color:#f92672>(</span>client<span style=color:#f92672>,</span> env<span style=color:#f92672>,</span> name<span style=color:#f92672>,</span> namespace<span style=color:#f92672>,</span> labels<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>SecretsPropertySource#getSourceData</li></ul><p>获取 Secret 的流程和获取 ConfigMap 一样，不同的是 Secret 在放入环境中之前，需要先通过 Base64 解码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSourceData</span><span style=color:#f92672>(</span>KubernetesClient client<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>	                                                 Environment env<span style=color:#f92672>,</span> String name<span style=color:#f92672>,</span> String namespace<span style=color:#f92672>,</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> labels<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Read for secrets api (named)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// 根据名称和命名空间获取 secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			Secret secret<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				secret <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>secrets</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>				               <span style=color:#f92672>.</span><span style=color:#a6e22e>withName</span><span style=color:#f92672>(</span>name<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				               <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				secret <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>secrets</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>				               <span style=color:#f92672>.</span><span style=color:#a6e22e>inNamespace</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				               <span style=color:#f92672>.</span><span style=color:#a6e22e>withName</span><span style=color:#f92672>(</span>name<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				               <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			putAll<span style=color:#f92672>(</span>secret<span style=color:#f92672>,</span> result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Read for secrets api (label)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// 根据 label 读取 Secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>labels<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					client<span style=color:#f92672>.</span><span style=color:#a6e22e>secrets</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>withLabels</span><span style=color:#f92672>(</span>labels<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>getItems</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>s <span style=color:#f92672>-&gt;</span> putAll<span style=color:#f92672>(</span>s<span style=color:#f92672>,</span> result<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					client<span style=color:#f92672>.</span><span style=color:#a6e22e>secrets</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>inNamespace</span><span style=color:#f92672>(</span>namespace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>withLabels</span><span style=color:#f92672>(</span>labels<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>list</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>getItems</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					      <span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>s <span style=color:#f92672>-&gt;</span> putAll<span style=color:#f92672>(</span>s<span style=color:#f92672>,</span> result<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Can&#39;t read secret with name: [&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] or labels [&#34;</span> <span style=color:#f92672>+</span> labels
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] in namespace:[&#34;</span> <span style=color:#f92672>+</span> namespace <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] (cause: &#34;</span> <span style=color:#f92672>+</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;). Ignoring&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=监听配置>监听配置</h2><p>支持两种方式的监听配置，一种是通过和 Kubernetes 建立长连接，当配置发生变化时可以立即推送，另一种是通过长轮询的方式，通过定时任务来实现</p><p>配置的监听必须显式开启</p><h3 id=bean-初始化-1>Bean 初始化</h3><p>Bean 的初始化是在 <code>org.springframework.cloud.kubernetes.config.reload.ConfigReloadAutoConfiguration.ConfigReloadAutoConfigurationBeans</code> 中实现的</p><ul><li>监听配置变化</li></ul><p>根据配置选择是通过轮询还是监听事件方式实现，默认是监听事件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> ConfigurationChangeDetector <span style=color:#a6e22e>propertyChangeWatcher</span><span style=color:#f92672>(</span>ConfigReloadProperties properties<span style=color:#f92672>,</span> ConfigurationUpdateStrategy strategy<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> POLLING<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PollingConfigurationChangeDetector<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						properties<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>kubernetesClient</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						strategy<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configMapPropertySourceLocator</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secretsPropertySourceLocator</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> EVENT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> EventBasedConfigurationChangeDetector<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						properties<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>kubernetesClient</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						strategy<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configMapPropertySourceLocator</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secretsPropertySourceLocator</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsupported configuration reload mode: &#34;</span> <span style=color:#f92672>+</span> properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getMode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>配置更新策略</li></ul><p>配置更新支持三种策略，分别是重启，刷新，和关闭，关闭应用依赖于健康检查，当发现应用被关闭后需要通过 Kubernetes 主动拉起</p><p>默认策略是刷新上下文</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> ConfigurationUpdateStrategy <span style=color:#a6e22e>configurationUpdateStrategy</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>			ConfigReloadProperties properties<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			ConfigurableApplicationContext ctx<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>@Autowired</span><span style=color:#f92672>(</span>required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span> RestartEndpoint restarter<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			ContextRefresher refresher<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getStrategy</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 重启
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>case</span> RESTART_CONTEXT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>					Assert<span style=color:#f92672>.</span><span style=color:#a6e22e>notNull</span><span style=color:#f92672>(</span>restarter<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Restart endpoint is not enabled&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigurationUpdateStrategy<span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getStrategy</span><span style=color:#f92672>().</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>							wait<span style=color:#f92672>(</span>properties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>							restarter<span style=color:#f92672>.</span><span style=color:#a6e22e>restart</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//	刷新
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>case</span> REFRESH<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigurationUpdateStrategy<span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getStrategy</span><span style=color:#f92672>().</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>						refresher<span style=color:#f92672>::</span>refresh<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//	关闭
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>case</span> SHUTDOWN<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigurationUpdateStrategy<span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getStrategy</span><span style=color:#f92672>().</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>							wait<span style=color:#f92672>(</span>properties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>							ctx<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsupported configuration update strategy: &#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getStrategy</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=监听实现>监听实现</h3><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/spring-cloud-kubernetes-configuration-change-detector.png alt=spring-cloud-kubernetes-configuration-change-detector.png></p><p><code>PollingConfigurationChangeDetector</code> 和 <code>EventBasedConfigurationChangeDetector</code> 都是 <code>ConfigurationChangeDetector</code>的子类</p><h4 id=polling>polling</h4><p>默认 15s 拉取一次配置</p><ul><li>PollingConfigurationChangeDetector#executeCycle</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Scheduled</span><span style=color:#f92672>(</span>initialDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${spring.cloud.kubernetes.reload.period:15000}&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>		fixedDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${spring.cloud.kubernetes.reload.period:15000}&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>executeCycle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changedConfigMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 监控 ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isMonitoringConfigMaps</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> MapPropertySource<span style=color:#f92672>&gt;</span> currentConfigMapSources <span style=color:#f92672>=</span> findPropertySources<span style=color:#f92672>(</span>ConfigMapPropertySource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>currentConfigMapSources<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				changedConfigMap <span style=color:#f92672>=</span> changed<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>					locateMapPropertySources<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configMapPropertySourceLocator</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>					currentConfigMapSources<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changedSecrets <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//  监控 Secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isMonitoringSecrets</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>MapPropertySource<span style=color:#f92672>&gt;</span> currentSecretSources <span style=color:#f92672>=</span> locateMapPropertySources<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secretsPropertySourceLocator</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>currentSecretSources <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>currentSecretSources<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				List<span style=color:#f92672>&lt;</span>SecretsPropertySource<span style=color:#f92672>&gt;</span> propertySources <span style=color:#f92672>=</span> findPropertySources<span style=color:#f92672>(</span>SecretsPropertySource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				changedSecrets <span style=color:#f92672>=</span> changed<span style=color:#f92672>(</span>currentSecretSources<span style=color:#f92672>,</span> propertySources<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 当发生变化时，更新属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>changedConfigMap <span style=color:#f92672>||</span> changedSecrets<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			reloadProperties<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>拉取配置，通过调用<code>change</code>方法进行比较，判断是否发生变化，如果发生变化，则调用 <code>reloadProperties</code> 方法刷新</p><ul><li>ConfigurationChangeDetector#reloadProperties</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>reloadProperties</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Reloading using strategy: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>strategy</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>strategy</span><span style=color:#f92672>.</span><span style=color:#a6e22e>reload</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>最终调用配置策略的 reload 方法，重新加载配置，需要注意的是，要被刷新的属性类应当通过 <code>@RefreshScope</code>或 <code>@ConfigurationProperties</code>注解修饰，这样才能监听到上下文的变化</p><h4 id=event>Event</h4><ul><li>EventBasedConfigurationChangeDetector#watch</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>watch</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果监控 ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isMonitoringConfigMaps</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;config-maps-watch&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Watch 是通过 WebSocket 实现的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>watches</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>kubernetesClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configMaps</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>				                                            <span style=color:#f92672>.</span><span style=color:#a6e22e>watch</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Watcher<span style=color:#f92672>&lt;</span>ConfigMap<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>eventReceived</span><span style=color:#f92672>(</span>Action action<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>					                                                                      ConfigMap configMap<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						                                            onEvent<span style=color:#f92672>(</span>configMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					                                            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClose</span><span style=color:#f92672>(</span>KubernetesClientException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				                                            <span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>				activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Added new Kubernetes watch: &#34;</span> <span style=color:#f92672>+</span> name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;Error while establishing a connection to watch config maps: configuration may remain stale&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>					e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果监控 Secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>properties</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isMonitoringSecrets</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secrets-watch&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>watches</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>kubernetesClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secrets</span><span style=color:#f92672>().</span><span style=color:#a6e22e>watch</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Watcher<span style=color:#f92672>&lt;</span>Secret<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>eventReceived</span><span style=color:#f92672>(</span>Action action<span style=color:#f92672>,</span> Secret secret<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>							onEvent<span style=color:#f92672>(</span>secret<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClose</span><span style=color:#f92672>(</span>KubernetesClientException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>				activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Added new Kubernetes watch: &#34;</span> <span style=color:#f92672>+</span> name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;Error while establishing a connection to watch secrets: configuration may remain stale&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>					e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>activated<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;Kubernetes event-based configuration change detector activated&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当收到消息时，将会调用 <code>onEvent</code>方法处理事件</p><ul><li>EventBasedConfigurationChangeDetector#onEvent</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEvent</span><span style=color:#f92672>(</span>ConfigMap configMap<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 加载配置，检测是否变化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>boolean</span> changed <span style=color:#f92672>=</span> changed<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>			locateMapPropertySources<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>configMapPropertySourceLocator</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			findPropertySources<span style=color:#f92672>(</span>ConfigMapPropertySource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果变化了，则重新加载属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>changed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Detected change in config maps&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			reloadProperties<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEvent</span><span style=color:#f92672>(</span>Secret secret<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changed <span style=color:#f92672>=</span> changed<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>			locateMapPropertySources<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>secretsPropertySourceLocator</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>environment</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>			findPropertySources<span style=color:#f92672>(</span>SecretsPropertySource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>changed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>log</span><span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Detected change in secrets&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			reloadProperties<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>重新加载配置，当发现配置发生变化时会调用 <code>reloadProperties</code>方法更新配置</p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-consul-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/><span>&larr;&nbsp;&nbsp;</span><span>Spring Cloud 使用 Consul 作为配置中心</span></a>
<a class=next href=https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/><span>Spring Cloud Consul 服务注册和发现</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>