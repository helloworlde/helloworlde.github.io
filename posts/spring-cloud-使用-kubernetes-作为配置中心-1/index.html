<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>Spring Cloud 使用 Kubernetes 作为配置中心</title><meta name=description content="Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中
加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加 …"><meta name=keywords content='blog,hugo,Java,SpringCloud'><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/"><meta property="og:type" content="website"><meta property="og:title" content="Spring Cloud 使用 Kubernetes 作为配置中心"><meta property="og:description" content="Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中
加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加 …"><meta property="og:image" content="https://blog.hellowood.dev/images/avatar.webp"><meta property="og:image:secure_url" content="https://blog.hellowood.dev/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Spring Cloud 使用 Kubernetes 作为配置中心"><meta name=twitter:description content="Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中
加载配置 加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 ConfigMapPropertySourceLocator 加 …"><meta property="twitter:domain" content="https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/"><meta property="twitter:url" content="https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/"><meta name=twitter:image content="https://blog.hellowood.dev/images/avatar.webp"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.70293498aa96b2dbb767ec11a622eb2266d8fc37a0fff88233a82952e3c72b15.js integrity="sha256-cCk0mKqWstu3Z+wRpiLrImbY/Deg//iCM6gpUuPHKxU="></script><link rel=stylesheet type=text/css href=/css/custom.css><script defer src=https://umami.hellowood.dev/script.js data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301></script><script defer src=https://cloud.umami.is/script.js data-website-id=73ff1c8c-9938-43cf-81af-e77e26b0cca3></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}'></script><meta name=google-adsense-account content="ca-pub-5709431067036925"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5709431067036925" crossorigin=anonymous></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://blog.hellowood.dev/><img src=/images/avatar.webp alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://blog.hellowood.dev/>HelloWood</a></div><div class=nav-links><div class=nav-link><a href=https://blog.hellowood.dev/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://blog.hellowood.dev/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://blog.hellowood.dev/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/helloworlde aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://umami.hellowood.dev/share/lab/Blog aria-label=dashboard><span data-feather=pie-chart></span></a></div><div class=nav-link><a href=https://blog.hellowood.dev/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://blog.hellowood.dev/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://blog.hellowood.dev/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://blog.hellowood.dev/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/helloworlde><span data-feather=github></span></a></li><li class=nav-item><a href=https://umami.hellowood.dev/share/lab/Blog><span data-feather=pie-chart></span></a></li><li class=nav-item><a href=https://blog.hellowood.dev/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Spring Cloud 使用 Kubernetes 作为配置中心</h1><small role=doc-subtitle></small><p class=post-date>2020-09-20
| Updated 2025-09-06</p><ul class=post-tags><li class=post-tag><a href=https://blog.hellowood.dev/tags/java>Java</a></li><li class=post-tag><a href=https://blog.hellowood.dev/tags/springcloud>SpringCloud</a></li></ul></div><div class=post-content><p>Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中</p><h2 id=加载配置>加载配置</h2><p>加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 <code>ConfigMapPropertySourceLocator</code> 加载，Secret 使用 <code>SecretsPropertySourceLocator</code>加载</p><h3 id=bean-初始化>Bean 初始化</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnProperty</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.cloud.kubernetes.config.enabled&#34;</span>, matchIfMissing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> ConfigMapPropertySourceLocator <span style=color:#a6e22e>configMapPropertySourceLocator</span>(ConfigMapConfigProperties properties) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigMapPropertySourceLocator(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>, properties);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnProperty</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.cloud.kubernetes.secrets.enabled&#34;</span>, matchIfMissing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> SecretsPropertySourceLocator <span style=color:#a6e22e>secretsPropertySourceLocator</span>(SecretsConfigProperties properties) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SecretsPropertySourceLocator(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>, properties);
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><h3 id=获取配置>获取配置</h3><p>获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中</p><h4 id=configmap>ConfigMap</h4><ul><li>ConfigMapPropertySourceLocator#locate</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> PropertySource <span style=color:#a6e22e>locate</span>(Environment environment) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (environment <span style=color:#66d9ef>instanceof</span> ConfigurableEnvironment) {
</span></span><span style=display:flex><span>			ConfigurableEnvironment env <span style=color:#f92672>=</span> (ConfigurableEnvironment) environment;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>ConfigMapConfigProperties.<span style=color:#a6e22e>NormalizedSource</span><span style=color:#f92672>&gt;</span> sources <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>determineSources</span>();
</span></span><span style=display:flex><span>			CompositePropertySource composite <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompositePropertySource(<span style=color:#e6db74>&#34;composite-configmap&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isEnableApi</span>()) {
</span></span><span style=display:flex><span>				sources.<span style=color:#a6e22e>forEach</span>(s <span style=color:#f92672>-&gt;</span> composite.<span style=color:#a6e22e>addFirstPropertySource</span>(
</span></span><span style=display:flex><span>					getMapPropertySourceForSingleConfigMap(env, s)));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将配置添加的容器环境中</span>
</span></span><span style=display:flex><span>			addPropertySourcesFromPaths(environment, composite);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> composite;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>真正向 Kubernetes 发起请求的是通过调用 <code>getMapPropertySourceForSingleConfigMap</code> 方法，创建<code>ConfigMapPropertySource</code>实例的时候，会根据 <code>getData</code> 方法，从 ConfigMap 获取属性解析并添加到环境中</p><ul><li>ConfigMapPropertySourceLocator#getMapPropertySourceForSingleConfigMap</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> MapPropertySource <span style=color:#a6e22e>getMapPropertySourceForSingleConfigMap</span>(
</span></span><span style=display:flex><span>		ConfigurableEnvironment environment, NormalizedSource normalizedSource) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		String configurationTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getConfigurationTarget</span>();
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建新的属性</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigMapPropertySource(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>			getApplicationName(environment, normalizedSource.<span style=color:#a6e22e>getName</span>(), configurationTarget),
</span></span><span style=display:flex><span>			getApplicationNamespace(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>, normalizedSource.<span style=color:#a6e22e>getNamespace</span>(), configurationTarget),
</span></span><span style=display:flex><span>			environment);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><ul><li>ConfigMapPropertySource</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ConfigMapPropertySource</span>(KubernetesClient client,
</span></span><span style=display:flex><span>	                               String name,
</span></span><span style=display:flex><span>	                               String namespace,
</span></span><span style=display:flex><span>	                               Environment environment) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>(getName(client, name, namespace),
</span></span><span style=display:flex><span>			asObjectMap(getData(client, name, namespace, environment)));
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><ul><li>ConfigMapPropertySource#getData</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getData</span>(KubernetesClient client, String name,
</span></span><span style=display:flex><span>	                                           String namespace, Environment environment) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 获取 ConfigMap</span>
</span></span><span style=display:flex><span>			ConfigMap map <span style=color:#f92672>=</span> StringUtils.<span style=color:#a6e22e>isEmpty</span>(namespace)
</span></span><span style=display:flex><span>				<span style=color:#f92672>?</span> client.<span style=color:#a6e22e>configMaps</span>().<span style=color:#a6e22e>withName</span>(name).<span style=color:#a6e22e>get</span>()
</span></span><span style=display:flex><span>				: client.<span style=color:#a6e22e>configMaps</span>().<span style=color:#a6e22e>inNamespace</span>(namespace).<span style=color:#a6e22e>withName</span>(name).<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 添加到map 中</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (map <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>				result.<span style=color:#a6e22e>putAll</span>(processAllEntries(map.<span style=color:#a6e22e>getData</span>(), environment));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (environment <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 根据 Profile 加载 ConfigMap</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> (String activeProfile : environment.<span style=color:#a6e22e>getActiveProfiles</span>()) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					String mapNameWithProfile <span style=color:#f92672>=</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> activeProfile;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					ConfigMap mapWithProfile <span style=color:#f92672>=</span> StringUtils.<span style=color:#a6e22e>isEmpty</span>(namespace)
</span></span><span style=display:flex><span>						<span style=color:#f92672>?</span> client.<span style=color:#a6e22e>configMaps</span>().<span style=color:#a6e22e>withName</span>(mapNameWithProfile).<span style=color:#a6e22e>get</span>()
</span></span><span style=display:flex><span>						: client.<span style=color:#a6e22e>configMaps</span>().<span style=color:#a6e22e>inNamespace</span>(namespace)
</span></span><span style=display:flex><span>						        .<span style=color:#a6e22e>withName</span>(mapNameWithProfile).<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (mapWithProfile <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>						result.<span style=color:#a6e22e>putAll</span>(
</span></span><span style=display:flex><span>							processAllEntries(mapWithProfile.<span style=color:#a6e22e>getData</span>(), environment));
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			LOG.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Can&#39;t read configMap with name: [&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] in namespace:[&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> namespace <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]. Ignoring.&#34;</span>, e);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h4 id=secret>Secret</h4><ul><li>SecretsPropertySourceLocator#locate</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> PropertySource <span style=color:#a6e22e>locate</span>(Environment environment) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (environment <span style=color:#66d9ef>instanceof</span> ConfigurableEnvironment) {
</span></span><span style=display:flex><span>			ConfigurableEnvironment env <span style=color:#f92672>=</span> (ConfigurableEnvironment) environment;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>SecretsConfigProperties.<span style=color:#a6e22e>NormalizedSource</span><span style=color:#f92672>&gt;</span> sources <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>determineSources</span>();
</span></span><span style=display:flex><span>			CompositePropertySource composite <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompositePropertySource(<span style=color:#e6db74>&#34;composite-secrets&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isEnableApi</span>()) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 获取Secret</span>
</span></span><span style=display:flex><span>				sources.<span style=color:#a6e22e>forEach</span>(s <span style=color:#f92672>-&gt;</span> composite.<span style=color:#a6e22e>addFirstPropertySource</span>(
</span></span><span style=display:flex><span>					getKubernetesPropertySourceForSingleSecret(env, s)));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// read for secrets mount</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 读取并加入到容器中</span>
</span></span><span style=display:flex><span>			putPathConfig(composite);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> composite;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><ul><li>SecretsPropertySourceLocator#getKubernetesPropertySourceForSingleSecret</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> MapPropertySource <span style=color:#a6e22e>getKubernetesPropertySourceForSingleSecret</span>(
</span></span><span style=display:flex><span>		ConfigurableEnvironment environment,
</span></span><span style=display:flex><span>		SecretsConfigProperties.<span style=color:#a6e22e>NormalizedSource</span> normalizedSource) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		String configurationTarget <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>getConfigurationTarget</span>();
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 加载 Secret 属性 source</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SecretsPropertySource(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>			environment,
</span></span><span style=display:flex><span>			getApplicationName(environment, normalizedSource.<span style=color:#a6e22e>getName</span>(), configurationTarget),
</span></span><span style=display:flex><span>			getApplicationNamespace(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>client</span>, normalizedSource.<span style=color:#a6e22e>getNamespace</span>(), configurationTarget),
</span></span><span style=display:flex><span>			normalizedSource.<span style=color:#a6e22e>getLabels</span>());
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><ul><li>SecretsPropertySource</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SecretsPropertySource</span>(KubernetesClient client, Environment env, String name,
</span></span><span style=display:flex><span>	                             String namespace, Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> labels) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>super</span>(getSourceName(client, env, name, namespace),
</span></span><span style=display:flex><span>			getSourceData(client, env, name, namespace, labels));
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><ul><li>SecretsPropertySource#getSourceData</li></ul><p>获取 Secret 的流程和获取 ConfigMap 一样，不同的是 Secret 在放入环境中之前，需要先通过 Base64 解码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSourceData</span>(KubernetesClient client,
</span></span><span style=display:flex><span>	                                                 Environment env, String name, String namespace, Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> labels) {
</span></span><span style=display:flex><span>		Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Read for secrets api (named)</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 根据名称和命名空间获取 secret</span>
</span></span><span style=display:flex><span>			Secret secret;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (StringUtils.<span style=color:#a6e22e>isEmpty</span>(namespace)) {
</span></span><span style=display:flex><span>				secret <span style=color:#f92672>=</span> client.<span style=color:#a6e22e>secrets</span>()
</span></span><span style=display:flex><span>				               .<span style=color:#a6e22e>withName</span>(name)
</span></span><span style=display:flex><span>				               .<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				secret <span style=color:#f92672>=</span> client.<span style=color:#a6e22e>secrets</span>()
</span></span><span style=display:flex><span>				               .<span style=color:#a6e22e>inNamespace</span>(namespace)
</span></span><span style=display:flex><span>				               .<span style=color:#a6e22e>withName</span>(name)
</span></span><span style=display:flex><span>				               .<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 解码</span>
</span></span><span style=display:flex><span>			putAll(secret, result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Read for secrets api (label)</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 根据 label 读取 Secret</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>labels.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (StringUtils.<span style=color:#a6e22e>isEmpty</span>(namespace)) {
</span></span><span style=display:flex><span>					client.<span style=color:#a6e22e>secrets</span>()
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>withLabels</span>(labels)
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>getItems</span>()
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>forEach</span>(s <span style=color:#f92672>-&gt;</span> putAll(s, result));
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>					client.<span style=color:#a6e22e>secrets</span>()
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>inNamespace</span>(namespace)
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>withLabels</span>(labels)
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>getItems</span>()
</span></span><span style=display:flex><span>					      .<span style=color:#a6e22e>forEach</span>(s <span style=color:#f92672>-&gt;</span> putAll(s, result));
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			LOG.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Can&#39;t read secret with name: [&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] or labels [&#34;</span> <span style=color:#f92672>+</span> labels
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] in namespace:[&#34;</span> <span style=color:#f92672>+</span> namespace <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] (cause: &#34;</span> <span style=color:#f92672>+</span> e.<span style=color:#a6e22e>getMessage</span>()
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;). Ignoring&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><h2 id=监听配置>监听配置</h2><p>支持两种方式的监听配置，一种是通过和 Kubernetes 建立长连接，当配置发生变化时可以立即推送，另一种是通过长轮询的方式，通过定时任务来实现</p><p>配置的监听必须显式开启</p><h3 id=bean-初始化-1>Bean 初始化</h3><p>Bean 的初始化是在 <code>org.springframework.cloud.kubernetes.config.reload.ConfigReloadAutoConfiguration.ConfigReloadAutoConfigurationBeans</code> 中实现的</p><ul><li>监听配置变化</li></ul><p>根据配置选择是通过轮询还是监听事件方式实现，默认是监听事件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> ConfigurationChangeDetector <span style=color:#a6e22e>propertyChangeWatcher</span>(ConfigReloadProperties properties, ConfigurationUpdateStrategy strategy) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> (properties.<span style=color:#a6e22e>getMode</span>()) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> POLLING:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PollingConfigurationChangeDetector(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>environment</span>,
</span></span><span style=display:flex><span>						properties,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kubernetesClient</span>,
</span></span><span style=display:flex><span>						strategy,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>configMapPropertySourceLocator</span>,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsPropertySourceLocator</span>);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> EVENT:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> EventBasedConfigurationChangeDetector(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>environment</span>,
</span></span><span style=display:flex><span>						properties,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kubernetesClient</span>,
</span></span><span style=display:flex><span>						strategy,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>configMapPropertySourceLocator</span>,
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsPropertySourceLocator</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;Unsupported configuration reload mode: &#34;</span> <span style=color:#f92672>+</span> properties.<span style=color:#a6e22e>getMode</span>());
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><ul><li>配置更新策略</li></ul><p>配置更新支持三种策略，分别是重启，刷新，和关闭，关闭应用依赖于健康检查，当发现应用被关闭后需要通过 Kubernetes 主动拉起</p><p>默认策略是刷新上下文</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> ConfigurationUpdateStrategy <span style=color:#a6e22e>configurationUpdateStrategy</span>(
</span></span><span style=display:flex><span>			ConfigReloadProperties properties,
</span></span><span style=display:flex><span>			ConfigurableApplicationContext ctx,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>@Autowired</span>(required <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) RestartEndpoint restarter,
</span></span><span style=display:flex><span>			ContextRefresher refresher) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> (properties.<span style=color:#a6e22e>getStrategy</span>()) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 重启</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> RESTART_CONTEXT:
</span></span><span style=display:flex><span>					Assert.<span style=color:#a6e22e>notNull</span>(restarter, <span style=color:#e6db74>&#34;Restart endpoint is not enabled&#34;</span>);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigurationUpdateStrategy(properties.<span style=color:#a6e22e>getStrategy</span>().<span style=color:#a6e22e>name</span>(),
</span></span><span style=display:flex><span>						() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>							wait(properties);
</span></span><span style=display:flex><span>							restarter.<span style=color:#a6e22e>restart</span>();
</span></span><span style=display:flex><span>						});
</span></span><span style=display:flex><span>				<span style=color:#75715e>//	刷新</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> REFRESH:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigurationUpdateStrategy(properties.<span style=color:#a6e22e>getStrategy</span>().<span style=color:#a6e22e>name</span>(),
</span></span><span style=display:flex><span>						refresher::refresh);
</span></span><span style=display:flex><span>				<span style=color:#75715e>//	关闭</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> SHUTDOWN:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ConfigurationUpdateStrategy(properties.<span style=color:#a6e22e>getStrategy</span>().<span style=color:#a6e22e>name</span>(),
</span></span><span style=display:flex><span>						() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>							wait(properties);
</span></span><span style=display:flex><span>							ctx.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>						});
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;Unsupported configuration update strategy: &#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>+</span> properties.<span style=color:#a6e22e>getStrategy</span>());
</span></span><span style=display:flex><span>		}
</span></span></code></pre></div><h3 id=监听实现>监听实现</h3><p><img src=https://img.hellowood.dev/picture/spring-cloud-kubernetes-configuration-change-detector.png alt=spring-cloud-kubernetes-configuration-change-detector.png loading=lazy></p><p><code>PollingConfigurationChangeDetector</code> 和 <code>EventBasedConfigurationChangeDetector</code> 都是 <code>ConfigurationChangeDetector</code>的子类</p><h4 id=polling>polling</h4><p>默认 15s 拉取一次配置</p><ul><li>PollingConfigurationChangeDetector#executeCycle</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@Scheduled</span>(initialDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${spring.cloud.kubernetes.reload.period:15000}&#34;</span>,
</span></span><span style=display:flex><span>		fixedDelayString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${spring.cloud.kubernetes.reload.period:15000}&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>executeCycle</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changedConfigMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 监控 ConfigMap</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isMonitoringConfigMaps</span>()) {
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> MapPropertySource<span style=color:#f92672>&gt;</span> currentConfigMapSources <span style=color:#f92672>=</span> findPropertySources(ConfigMapPropertySource.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>currentConfigMapSources.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>				changedConfigMap <span style=color:#f92672>=</span> changed(
</span></span><span style=display:flex><span>					locateMapPropertySources(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>configMapPropertySourceLocator</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>environment</span>),
</span></span><span style=display:flex><span>					currentConfigMapSources);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changedSecrets <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		<span style=color:#75715e>//  监控 Secret</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isMonitoringSecrets</span>()) {
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>MapPropertySource<span style=color:#f92672>&gt;</span> currentSecretSources <span style=color:#f92672>=</span> locateMapPropertySources(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsPropertySourceLocator</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>environment</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (currentSecretSources <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>currentSecretSources.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>				List<span style=color:#f92672>&lt;</span>SecretsPropertySource<span style=color:#f92672>&gt;</span> propertySources <span style=color:#f92672>=</span> findPropertySources(SecretsPropertySource.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>				changedSecrets <span style=color:#f92672>=</span> changed(currentSecretSources, propertySources);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 当发生变化时，更新属性</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (changedConfigMap <span style=color:#f92672>||</span> changedSecrets) {
</span></span><span style=display:flex><span>			reloadProperties();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>拉取配置，通过调用<code>change</code>方法进行比较，判断是否发生变化，如果发生变化，则调用 <code>reloadProperties</code> 方法刷新</p><ul><li>ConfigurationChangeDetector#reloadProperties</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>reloadProperties</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Reloading using strategy: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>reload</span>();
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>最终调用配置策略的 reload 方法，重新加载配置，需要注意的是，要被刷新的属性类应当通过 <code>@RefreshScope</code>或 <code>@ConfigurationProperties</code>注解修饰，这样才能监听到上下文的变化</p><h4 id=event>Event</h4><ul><li>EventBasedConfigurationChangeDetector#watch</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>watch</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果监控 ConfigMap</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isMonitoringConfigMaps</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;config-maps-watch&#34;</span>;
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Watch 是通过 WebSocket 实现的</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>watches</span>.<span style=color:#a6e22e>put</span>(name, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>configMaps</span>()
</span></span><span style=display:flex><span>				                                            .<span style=color:#a6e22e>watch</span>(<span style=color:#66d9ef>new</span> Watcher<span style=color:#f92672>&lt;</span>ConfigMap<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>					                                            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>eventReceived</span>(Action action,
</span></span><span style=display:flex><span>					                                                                      ConfigMap configMap) {
</span></span><span style=display:flex><span>						                                            onEvent(configMap);
</span></span><span style=display:flex><span>					                                            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					                                            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>					                                            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClose</span>(KubernetesClientException e) {
</span></span><span style=display:flex><span>					                                            }
</span></span><span style=display:flex><span>				                                            }));
</span></span><span style=display:flex><span>				activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Added new Kubernetes watch: &#34;</span> <span style=color:#f92672>+</span> name);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>error</span>(
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;Error while establishing a connection to watch config maps: configuration may remain stale&#34;</span>,
</span></span><span style=display:flex><span>					e);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果监控 Secret</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>isMonitoringSecrets</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>				String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secrets-watch&#34;</span>;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>watches</span>.<span style=color:#a6e22e>put</span>(name,
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>secrets</span>().<span style=color:#a6e22e>watch</span>(<span style=color:#66d9ef>new</span> Watcher<span style=color:#f92672>&lt;</span>Secret<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>eventReceived</span>(Action action, Secret secret) {
</span></span><span style=display:flex><span>							onEvent(secret);
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClose</span>(KubernetesClientException e) {
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					}));
</span></span><span style=display:flex><span>				activated <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Added new Kubernetes watch: &#34;</span> <span style=color:#f92672>+</span> name);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>error</span>(
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;Error while establishing a connection to watch secrets: configuration may remain stale&#34;</span>,
</span></span><span style=display:flex><span>					e);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (activated) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>info</span>(
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;Kubernetes event-based configuration change detector activated&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>当收到消息时，将会调用 <code>onEvent</code>方法处理事件</p><ul><li>EventBasedConfigurationChangeDetector#onEvent</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEvent</span>(ConfigMap configMap) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 加载配置，检测是否变化</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changed <span style=color:#f92672>=</span> changed(
</span></span><span style=display:flex><span>			locateMapPropertySources(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>configMapPropertySourceLocator</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>environment</span>),
</span></span><span style=display:flex><span>			findPropertySources(ConfigMapPropertySource.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>		);
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果变化了，则重新加载属性</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (changed) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Detected change in config maps&#34;</span>);
</span></span><span style=display:flex><span>			reloadProperties();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEvent</span>(Secret secret) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> changed <span style=color:#f92672>=</span> changed(
</span></span><span style=display:flex><span>			locateMapPropertySources(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsPropertySourceLocator</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>environment</span>),
</span></span><span style=display:flex><span>			findPropertySources(SecretsPropertySource.<span style=color:#a6e22e>class</span>));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (changed) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Detected change in secrets&#34;</span>);
</span></span><span style=display:flex><span>			reloadProperties();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>重新加载配置，当发现配置发生变化时会调用 <code>reloadProperties</code>方法更新配置</p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script><div id=comments><script src=https://utteranc.es/client.js repo=helloworlde/helloworlde.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></main><footer class=footer><span>&copy; 2020-2025 hellowood.dev</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>