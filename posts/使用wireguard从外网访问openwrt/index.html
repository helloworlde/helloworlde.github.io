<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>使用WireGuard从外网访问OpenWrt</title><meta charset=utf-8><meta name=description content="Ladder@使用 WireGuard 从外网访问 OpenWrt 在使用过程中，如果通过DDNS 的方式将 OpenWrt 暴露在公网中，很容易遭受攻击或者入侵，因此可以使用 WireGuard 作为 VPN 进行访问，更加安全；因此，使用 OpenWrt 搭建 WireGuard VPN，实现从外网访问 OpenWrt
WireGuard 是一种现代的 VPN 协议，可以快速、安全地建立虚拟私人网络连接。相比于传统的 VPN 协议，如 OpenVPN 和I PSec，WireGuard 具有更简单的设计、更快的速度、更高的安全性和更小的代码量
核心概念 WireGuard中主要涉及以下几个概念：
接口（Interface）：表示一个 WireGuard 端点（Peer）的虚拟网络接口，用于处理加密和解密流量、路由和其他传输信息。 对等端（Peer）：表示使用 WireGuard 连接的每个设备或节点。每个 Peer 在连接时需要交换公钥和预共享密钥等信息。 公钥（PublicKey）：每个 WireGuard 对等端拥有的公钥，用于加密通信流量和生成预共享密钥。 私钥（PrivateKey）：与每个公钥相配对的私钥，只应该存储在拥有者的设备上。 端点（Endpoint）：是在网络中可访问某个 Peer 的 IP 地址和端口号，用于建立连接。 IP 分配（IP Address Assignment）：指定每个接口使用的 IPv4/IPv6 前缀范围。 允许 IP（Allowed IP）：定义被 WireGuard 处理的哪些 IP 包，以及将这些包重新路由到哪个接口。 预共享密钥（Pre-shared Key）：在 Peer 之间建立安全连接时使用的共享密钥，用于加密数据包。 Listen Port（监听端口）：一个 Peer 监听的 UDP 端口号。其他 Peer 使用此端口发送数据包到该 Peer 配置 OpenWrt 安装 WireGuard opkg update && \ opkg install wireguard-tools luci-app-wireguard luci-i18n-wireguard-zh-cn 此命令会自动安装 WireGuard 的依赖，也可以在管理界面进行安装；安装完成后打开 OpenWrt 管理界面-状态，就可以看到 WireGuard 的控制界面了；此时提示未配置 WireGuard 端口，需要在网络-接口中进行配置"><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8wireguard%E4%BB%8E%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AEopenwrt/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev/index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ",{anonymize_ip:!1})}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://statistics.lab.hellowood.dev/script.js></script><meta property="og:title" content="使用WireGuard从外网访问OpenWrt"><meta property="og:description" content="使用 WireGuard 从外网访问 OpenWrt 在使用过程中，如果通过DDNS 的方式将 OpenWrt 暴露在公网中，很容易遭受攻击或者入侵，因此可以使用 WireGuard 作为 VPN 进行访问，更加安全；因此，使用 OpenWrt 搭建 WireGuard VPN，实现从外网访问 OpenWrt
WireGuard 是一种现代的 VPN 协议，可以快速、安全地建立虚拟私人网络连接。相比于传统的 VPN 协议，如 OpenVPN 和I PSec，WireGuard 具有更简单的设计、更快的速度、更高的安全性和更小的代码量
核心概念 WireGuard中主要涉及以下几个概念：
接口（Interface）：表示一个 WireGuard 端点（Peer）的虚拟网络接口，用于处理加密和解密流量、路由和其他传输信息。 对等端（Peer）：表示使用 WireGuard 连接的每个设备或节点。每个 Peer 在连接时需要交换公钥和预共享密钥等信息。 公钥（PublicKey）：每个 WireGuard 对等端拥有的公钥，用于加密通信流量和生成预共享密钥。 私钥（PrivateKey）：与每个公钥相配对的私钥，只应该存储在拥有者的设备上。 端点（Endpoint）：是在网络中可访问某个 Peer 的 IP 地址和端口号，用于建立连接。 IP 分配（IP Address Assignment）：指定每个接口使用的 IPv4/IPv6 前缀范围。 允许 IP（Allowed IP）：定义被 WireGuard 处理的哪些 IP 包，以及将这些包重新路由到哪个接口。 预共享密钥（Pre-shared Key）：在 Peer 之间建立安全连接时使用的共享密钥，用于加密数据包。 Listen Port（监听端口）：一个 Peer 监听的 UDP 端口号。其他 Peer 使用此端口发送数据包到该 Peer 配置 OpenWrt 安装 WireGuard opkg update && \ opkg install wireguard-tools luci-app-wireguard luci-i18n-wireguard-zh-cn 此命令会自动安装 WireGuard 的依赖，也可以在管理界面进行安装；安装完成后打开 OpenWrt 管理界面-状态，就可以看到 WireGuard 的控制界面了；此时提示未配置 WireGuard 端口，需要在网络-接口中进行配置"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8wireguard%E4%BB%8E%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AEopenwrt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-12T16:30:22+08:00"><meta property="article:modified_time" content="2023-06-12T16:30:22+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用WireGuard从外网访问OpenWrt"><meta name=twitter:description content="使用 WireGuard 从外网访问 OpenWrt 在使用过程中，如果通过DDNS 的方式将 OpenWrt 暴露在公网中，很容易遭受攻击或者入侵，因此可以使用 WireGuard 作为 VPN 进行访问，更加安全；因此，使用 OpenWrt 搭建 WireGuard VPN，实现从外网访问 OpenWrt
WireGuard 是一种现代的 VPN 协议，可以快速、安全地建立虚拟私人网络连接。相比于传统的 VPN 协议，如 OpenVPN 和I PSec，WireGuard 具有更简单的设计、更快的速度、更高的安全性和更小的代码量
核心概念 WireGuard中主要涉及以下几个概念：
接口（Interface）：表示一个 WireGuard 端点（Peer）的虚拟网络接口，用于处理加密和解密流量、路由和其他传输信息。 对等端（Peer）：表示使用 WireGuard 连接的每个设备或节点。每个 Peer 在连接时需要交换公钥和预共享密钥等信息。 公钥（PublicKey）：每个 WireGuard 对等端拥有的公钥，用于加密通信流量和生成预共享密钥。 私钥（PrivateKey）：与每个公钥相配对的私钥，只应该存储在拥有者的设备上。 端点（Endpoint）：是在网络中可访问某个 Peer 的 IP 地址和端口号，用于建立连接。 IP 分配（IP Address Assignment）：指定每个接口使用的 IPv4/IPv6 前缀范围。 允许 IP（Allowed IP）：定义被 WireGuard 处理的哪些 IP 包，以及将这些包重新路由到哪个接口。 预共享密钥（Pre-shared Key）：在 Peer 之间建立安全连接时使用的共享密钥，用于加密数据包。 Listen Port（监听端口）：一个 Peer 监听的 UDP 端口号。其他 Peer 使用此端口发送数据包到该 Peer 配置 OpenWrt 安装 WireGuard opkg update && \ opkg install wireguard-tools luci-app-wireguard luci-i18n-wireguard-zh-cn 此命令会自动安装 WireGuard 的依赖，也可以在管理界面进行安装；安装完成后打开 OpenWrt 管理界面-状态，就可以看到 WireGuard 的控制界面了；此时提示未配置 WireGuard 端口，需要在网络-接口中进行配置"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":3,"name":"使用WireGuard从外网访问OpenWrt","item":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8wireguard%E4%BB%8E%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AEopenwrt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用WireGuard从外网访问OpenWrt","name":"使用WireGuard从外网访问OpenWrt","description":"使用 WireGuard 从外网访问 OpenWrt 在使用过程中，如果通过DDNS 的方式将 OpenWrt 暴露在公网中，很容易遭受攻击或者入侵，因此可以使用 WireGuard 作为 VPN 进行访问，更加安全；因此，使用 OpenWrt 搭建 WireGuard VPN，实现从外网访问 OpenWrt\nWireGuard 是一种现代的 VPN 协议，可以快速、安全地建立虚拟私人网络连接。相比于传统的 VPN 协议，如 OpenVPN 和I PSec，WireGuard 具有更简单的设计、更快的速度、更高的安全性和更小的代码量\n核心概念 WireGuard中主要涉及以下几个概念：\n接口（Interface）：表示一个 WireGuard 端点（Peer）的虚拟网络接口，用于处理加密和解密流量、路由和其他传输信息。 对等端（Peer）：表示使用 WireGuard 连接的每个设备或节点。每个 Peer 在连接时需要交换公钥和预共享密钥等信息。 公钥（PublicKey）：每个 WireGuard 对等端拥有的公钥，用于加密通信流量和生成预共享密钥。 私钥（PrivateKey）：与每个公钥相配对的私钥，只应该存储在拥有者的设备上。 端点（Endpoint）：是在网络中可访问某个 Peer 的 IP 地址和端口号，用于建立连接。 IP 分配（IP Address Assignment）：指定每个接口使用的 IPv4/IPv6 前缀范围。 允许 IP（Allowed IP）：定义被 WireGuard 处理的哪些 IP 包，以及将这些包重新路由到哪个接口。 预共享密钥（Pre-shared Key）：在 Peer 之间建立安全连接时使用的共享密钥，用于加密数据包。 Listen Port（监听端口）：一个 Peer 监听的 UDP 端口号。其他 Peer 使用此端口发送数据包到该 Peer 配置 OpenWrt 安装 WireGuard opkg update \u0026amp;\u0026amp; \\ opkg install wireguard-tools luci-app-wireguard luci-i18n-wireguard-zh-cn 此命令会自动安装 WireGuard 的依赖，也可以在管理界面进行安装；安装完成后打开 OpenWrt 管理界面-状态，就可以看到 WireGuard 的控制界面了；此时提示未配置 WireGuard 端口，需要在网络-接口中进行配置","keywords":["HomeLab","WireGuard","OpenWrt"],"articleBody":"使用 WireGuard 从外网访问 OpenWrt 在使用过程中，如果通过DDNS 的方式将 OpenWrt 暴露在公网中，很容易遭受攻击或者入侵，因此可以使用 WireGuard 作为 VPN 进行访问，更加安全；因此，使用 OpenWrt 搭建 WireGuard VPN，实现从外网访问 OpenWrt\nWireGuard 是一种现代的 VPN 协议，可以快速、安全地建立虚拟私人网络连接。相比于传统的 VPN 协议，如 OpenVPN 和I PSec，WireGuard 具有更简单的设计、更快的速度、更高的安全性和更小的代码量\n核心概念 WireGuard中主要涉及以下几个概念：\n接口（Interface）：表示一个 WireGuard 端点（Peer）的虚拟网络接口，用于处理加密和解密流量、路由和其他传输信息。 对等端（Peer）：表示使用 WireGuard 连接的每个设备或节点。每个 Peer 在连接时需要交换公钥和预共享密钥等信息。 公钥（PublicKey）：每个 WireGuard 对等端拥有的公钥，用于加密通信流量和生成预共享密钥。 私钥（PrivateKey）：与每个公钥相配对的私钥，只应该存储在拥有者的设备上。 端点（Endpoint）：是在网络中可访问某个 Peer 的 IP 地址和端口号，用于建立连接。 IP 分配（IP Address Assignment）：指定每个接口使用的 IPv4/IPv6 前缀范围。 允许 IP（Allowed IP）：定义被 WireGuard 处理的哪些 IP 包，以及将这些包重新路由到哪个接口。 预共享密钥（Pre-shared Key）：在 Peer 之间建立安全连接时使用的共享密钥，用于加密数据包。 Listen Port（监听端口）：一个 Peer 监听的 UDP 端口号。其他 Peer 使用此端口发送数据包到该 Peer 配置 OpenWrt 安装 WireGuard opkg update \u0026\u0026 \\ opkg install wireguard-tools luci-app-wireguard luci-i18n-wireguard-zh-cn 此命令会自动安装 WireGuard 的依赖，也可以在管理界面进行安装；安装完成后打开 OpenWrt 管理界面-状态，就可以看到 WireGuard 的控制界面了；此时提示未配置 WireGuard 端口，需要在网络-接口中进行配置\n创建密钥 建议使用 wireguard-tools 创建公私钥，便于配置和保存\n创建文件夹并修改权限 mkdir wireguard \u0026\u0026 cd wireguard umask 077 umask 077 的作用是设置系统默认文件和文件夹的权限为只有创建用户拥有全部权限（读、写和执行）\n创建 OpenWrt 密钥对 先创建私钥，然后使用私钥创建公钥\nwg genkey \u003e openwrt_private_key wg pubkey \u003c openwrt_private_key \u003e openwrt_public_key 创建预共享密钥 wg genpsk \u003e pre_share_key 创建对端密钥对 wg genkey \u003e peer_private_key wg pubkey \u003c peer_private_key \u003e peer_public_key 添加 WireGuard 接口 添加接口 在网络-接口中，选择添加新接口；协议类型选择 WireGuard VPN，然后创建接口\n配置接口 使用前面生成的公钥和私钥进行配置，也可以选择生成新的密钥对，需要注意要将公私钥保存下来方便后续配置；配置完成后点击保存并应用\n公钥/私钥：用于对端连接的加密通信和身份认证 监听端口：用于监听和处理网络流量的 UDP 端口号，需要固定，便于对端访问 IP地址：用于标识节点，通常使用 CIDR 格式进行表示，如这里配置 10.0.0.1/24表示 OpenWrt 节点的 IP 地址是 10.0.0.1，/24 表示网络前缀长度，包含从 10.0.0.0 到 10.0.0.255 的范围 无主机路由（Host-agnostic routing）：是一种在多个 Peer 之间分享一个公共网络环境的方法，它允许用户在不需要修改主机路由表的情况下实现跨越多个子网的通信；使用无主机路由时，可以仅将交互对等端的地址（即相邻的 WireGuard 对等端）添加到本地路由表，这样就可以通过走最短路径实现高效直接通信，而不必像其他VPN一样让所有的流量都走 VPN 隧道，避免了额外的开销和不必要的延迟；使用无主机路由可以确保在 WireGuard 网络中增加更多的子网和节点时，不会破坏现有的 IP 路由设置，从而实现更高效的通信 配置对端 编辑 WireGuard 接口，选择对端-添加对端；使用之前创建的公钥、私钥和预共享密钥；也可以选择生成新的密钥对和预共享密钥\n预共享密钥：用于增强对连接双方身份验证的安全性，以及生成对称加密密钥来保护通信中的数据隐私和完整性 允许的 IP：添加对端所允许的 IP 地址列表，表示仅允许目标设置为该节点的这些 IP 数据包通过 WireGuard 接口路由，建议指定为密钥对应的客户端的IP，不能冲突；如 10.0.0.2/32，仅允许这一个对端使用这个密钥对进行访问 其他的配置不需要修改；这样就完成了 WireGuard 的配置；重启 WireGuard 接口或者重启 OpenWrt 使配置生效，就可以使用客户端软件进行连接了\n对端使用 添加配置文件 openwrt.conf [Interface] PrivateKey = 8MG0PBAlRjk3+tc9DWfOAZF+lrDKAn4GREs+7NpsMGo= Address = 10.0.0.2/32 [Peer] PublicKey = Dc+xgDkSA7vYh311ZOhCPeGS5Rnqphel1u60VeCI2lE= PresharedKey = HAntyG+i3nhaDzy7PhmzUDk4+te20JVPglzFbMllJvg= AllowedIPs = 10.0.0.0/24 Endpoint = 192.168.2.253:19999 PersistentKeepalive = 25 Interface：表示本地节点的网络接口属性配置\nPrivateKey 是本地节点的私钥，用于加解密网络数据包 Address 是该节点所在子网的 IPv4 地址，需要和在 OpenWrt 配置的对端的地址一致 Peer：表示需要连接的远程节点的属性配置\nPublicKey 是对端公钥，可以通过与远程节点交换公钥获取 PresharedKey 是本地和远程节点之间协商设定的预共享密钥，用于增强对连接双方身份验证的安全性，以及生成对称加密密钥来保护通信中的数据隐私和完整性 AllowedIPs 是指定允许通过 VPN 通道的 IP 地址范围，用于筛选所有通过该 VPN 的流量；这里只有访问 10.0.0.0/24网段的会使用该 VPN 访问 Endpoint 是指定远程节点的 IP 地址和端口号，如果在公网访问需要对端有公网的IP PersistentKeepalive 是指定保持连接的活跃性，以防止 VPN 连接因长时间不活跃而断开。 安装 WireGuard 在 WireGuard Installation 下载对应的软件进行安装，选择编辑好的配置文件 openwrt.conf进行导入，然后点击启动即可进行连接，显示有最新的握手说明连接成功\n查看 OpenWrt 的 WireGuard 连接状态，发现对端已经成功连接了\n使用浏览器访问 http://10.0.0.1/，可以正常访问到 OpenWrt 的页面\n","wordCount":"274","inLanguage":"en","datePublished":"2023-06-12T16:30:22+08:00","dateModified":"2023-06-12T16:30:22+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8wireguard%E4%BB%8E%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AEopenwrt/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.f8020eba33d585b82c30b2a1ceb0d4c4e8e41fb6d8843d07d8ad056da8712972.css integrity="sha256-+AIOujPVhbgsMLKhzrDUxOjkH7bYhD0H2K0FbahxKXI=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://statistics.lab.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>使用WireGuard从外网访问OpenWrt</h1></header><p><small>June 12, 2023&nbsp;· 274 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#核心概念>核心概念</a></li><li><a href=#配置-openwrt>配置 OpenWrt</a><ul><li><a href=#安装-wireguard>安装 WireGuard</a></li><li><a href=#创建密钥>创建密钥</a></li><li><a href=#添加-wireguard-接口>添加 WireGuard 接口</a></li><li><a href=#配置对端>配置对端</a></li></ul></li><li><a href=#对端使用>对端使用</a><ul><li><a href=#添加配置文件>添加配置文件</a></li><li><a href=#安装-wireguard-1>安装 WireGuard</a></li></ul></li></ul></nav></div><section class=blog-content><h1 id=使用-wireguard-从外网访问-openwrt>使用 WireGuard 从外网访问 OpenWrt</h1><p>在使用过程中，如果通过DDNS 的方式将 OpenWrt 暴露在公网中，很容易遭受攻击或者入侵，因此可以使用 WireGuard 作为 VPN 进行访问，更加安全；因此，使用 OpenWrt 搭建 WireGuard VPN，实现从外网访问 OpenWrt</p><p><a href=https://www.wireguard.com/>WireGuard</a> 是一种现代的 VPN 协议，可以快速、安全地建立虚拟私人网络连接。相比于传统的 VPN 协议，如 OpenVPN 和I PSec，WireGuard 具有更简单的设计、更快的速度、更高的安全性和更小的代码量</p><h2 id=核心概念>核心概念</h2><p>WireGuard中主要涉及以下几个概念：</p><ul><li>接口（Interface）：表示一个 WireGuard 端点（Peer）的虚拟网络接口，用于处理加密和解密流量、路由和其他传输信息。</li><li>对等端（Peer）：表示使用 WireGuard 连接的每个设备或节点。每个 Peer 在连接时需要交换公钥和预共享密钥等信息。</li><li>公钥（PublicKey）：每个 WireGuard 对等端拥有的公钥，用于加密通信流量和生成预共享密钥。</li><li>私钥（PrivateKey）：与每个公钥相配对的私钥，只应该存储在拥有者的设备上。</li><li>端点（Endpoint）：是在网络中可访问某个 Peer 的 IP 地址和端口号，用于建立连接。</li><li>IP 分配（IP Address Assignment）：指定每个接口使用的 IPv4/IPv6 前缀范围。</li><li>允许 IP（Allowed IP）：定义被 WireGuard 处理的哪些 IP 包，以及将这些包重新路由到哪个接口。</li><li>预共享密钥（Pre-shared Key）：在 Peer 之间建立安全连接时使用的共享密钥，用于加密数据包。</li><li>Listen Port（监听端口）：一个 Peer 监听的 UDP 端口号。其他 Peer 使用此端口发送数据包到该 Peer</li></ul><h2 id=配置-openwrt>配置 OpenWrt</h2><h3 id=安装-wireguard>安装 WireGuard</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>opkg update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  opkg install wireguard-tools luci-app-wireguard luci-i18n-wireguard-zh-cn
</span></span></code></pre></div><p>此命令会自动安装 WireGuard 的依赖，也可以在管理界面进行安装；安装完成后打开 OpenWrt 管理界面-状态，就可以看到 WireGuard 的控制界面了；此时提示未配置 WireGuard 端口，需要在网络-接口中进行配置</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-wireguard-homepage.png alt=homelab-wireguard-openwrt-wireguard-homepage.png></p><h3 id=创建密钥>创建密钥</h3><p>建议使用 wireguard-tools 创建公私钥，便于配置和保存</p><ul><li>创建文件夹并修改权限</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir wireguard <span style=color:#f92672>&amp;&amp;</span> cd wireguard
</span></span><span style=display:flex><span>umask <span style=color:#ae81ff>077</span>
</span></span></code></pre></div><p><code>umask 077</code> 的作用是设置系统默认文件和文件夹的权限为只有创建用户拥有全部权限（读、写和执行）</p><ul><li>创建 OpenWrt 密钥对</li></ul><p>先创建私钥，然后使用私钥创建公钥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wg genkey &gt; openwrt_private_key
</span></span><span style=display:flex><span>wg pubkey &lt; openwrt_private_key &gt; openwrt_public_key
</span></span></code></pre></div><ul><li>创建预共享密钥</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wg genpsk &gt; pre_share_key
</span></span></code></pre></div><ul><li>创建对端密钥对</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wg genkey &gt; peer_private_key
</span></span><span style=display:flex><span>wg pubkey &lt; peer_private_key &gt; peer_public_key
</span></span></code></pre></div><h3 id=添加-wireguard-接口>添加 WireGuard 接口</h3><h4 id=添加接口>添加接口</h4><p>在网络-接口中，选择添加新接口；协议类型选择 <code>WireGuard VPN</code>，然后创建接口</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-add-wireguard-interface.png alt=homelab-wireguard-openwrt-add-wireguard-interface.png></p><h4 id=配置接口>配置接口</h4><p>使用前面生成的公钥和私钥进行配置，也可以选择生成新的密钥对，需要注意要将公私钥保存下来方便后续配置；配置完成后点击保存并应用</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-config-wireguard-interface.png alt=homelab-wireguard-openwrt-config-wireguard-interface.png></p><ul><li>公钥/私钥：用于对端连接的加密通信和身份认证</li><li>监听端口：用于监听和处理网络流量的 UDP 端口号，需要固定，便于对端访问</li><li>IP地址：用于标识节点，通常使用 CIDR 格式进行表示，如这里配置 <code>10.0.0.1/24</code>表示 OpenWrt 节点的 IP 地址是 10.0.0.1，/24 表示网络前缀长度，包含从 10.0.0.0 到 10.0.0.255 的范围</li><li>无主机路由（Host-agnostic routing）：是一种在多个 Peer 之间分享一个公共网络环境的方法，它允许用户在不需要修改主机路由表的情况下实现跨越多个子网的通信；使用无主机路由时，可以仅将交互对等端的地址（即相邻的 WireGuard 对等端）添加到本地路由表，这样就可以通过走最短路径实现高效直接通信，而不必像其他VPN一样让所有的流量都走 VPN 隧道，避免了额外的开销和不必要的延迟；使用无主机路由可以确保在 WireGuard 网络中增加更多的子网和节点时，不会破坏现有的 IP 路由设置，从而实现更高效的通信</li></ul><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-config-wireguard-interface-completed.png alt=homelab-wireguard-openwrt-config-wireguard-interface-completed.png></p><h3 id=配置对端>配置对端</h3><p>编辑 WireGuard 接口，选择对端-添加对端；使用之前创建的公钥、私钥和预共享密钥；也可以选择生成新的密钥对和预共享密钥</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-config-wireguard-interface-peer-config2.png alt=homelab-wireguard-openwrt-config-wireguard-interface-peer-config2.png></p><ul><li>预共享密钥：用于增强对连接双方身份验证的安全性，以及生成对称加密密钥来保护通信中的数据隐私和完整性</li><li>允许的 IP：添加对端所允许的 IP 地址列表，表示仅允许目标设置为该节点的这些 IP 数据包通过 WireGuard 接口路由，建议指定为密钥对应的客户端的IP，不能冲突；如 <code>10.0.0.2/32</code>，仅允许这一个对端使用这个密钥对进行访问</li></ul><p>其他的配置不需要修改；这样就完成了 WireGuard 的配置；重启 WireGuard 接口或者重启 OpenWrt 使配置生效，就可以使用客户端软件进行连接了</p><h2 id=对端使用>对端使用</h2><h3 id=添加配置文件>添加配置文件</h3><ul><li>openwrt.conf</li></ul><pre tabindex=0><code class=language-dsconfig data-lang=dsconfig>[Interface]
PrivateKey = 8MG0PBAlRjk3+tc9DWfOAZF+lrDKAn4GREs+7NpsMGo=
Address = 10.0.0.2/32

[Peer]
PublicKey = Dc+xgDkSA7vYh311ZOhCPeGS5Rnqphel1u60VeCI2lE=
PresharedKey = HAntyG+i3nhaDzy7PhmzUDk4+te20JVPglzFbMllJvg=
AllowedIPs = 10.0.0.0/24
Endpoint = 192.168.2.253:19999
PersistentKeepalive = 25
</code></pre><ul><li><p><code>Interface</code>：表示本地节点的网络接口属性配置</p><ul><li><code>PrivateKey</code> 是本地节点的私钥，用于加解密网络数据包</li><li><code>Address</code> 是该节点所在子网的 IPv4 地址，需要和在 OpenWrt 配置的对端的地址一致</li></ul></li><li><p><code>Peer</code>：表示需要连接的远程节点的属性配置</p><ul><li><code>PublicKey</code> 是对端公钥，可以通过与远程节点交换公钥获取</li><li><code>PresharedKey</code> 是本地和远程节点之间协商设定的预共享密钥，用于增强对连接双方身份验证的安全性，以及生成对称加密密钥来保护通信中的数据隐私和完整性</li><li><code>AllowedIPs</code> 是指定允许通过 VPN 通道的 IP 地址范围，用于筛选所有通过该 VPN 的流量；这里只有访问 <code>10.0.0.0/24</code>网段的会使用该 VPN 访问</li><li><code>Endpoint</code> 是指定远程节点的 IP 地址和端口号，如果在公网访问需要对端有公网的IP</li><li><code>PersistentKeepalive</code> 是指定保持连接的活跃性，以防止 VPN 连接因长时间不活跃而断开。</li></ul></li></ul><h3 id=安装-wireguard-1>安装 WireGuard</h3><p>在 WireGuard Installation 下载对应的软件进行安装，选择编辑好的配置文件 <code>openwrt.conf</code>进行导入，然后点击启动即可进行连接，显示有最新的握手说明连接成功</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-peers-connect2.png alt=homelab-wireguard-openwrt-peers-connect2.png></p><p>查看 OpenWrt 的 WireGuard 连接状态，发现对端已经成功连接了</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-peers-connect-status.png alt=homelab-wireguard-openwrt-peers-connect-status.png></p><p>使用浏览器访问 <a href=http://10.0.0.1/>http://10.0.0.1/</a>，可以正常访问到 OpenWrt 的页面</p><p><img src=https://hellowoodes.oss-cn-beijing.aliyuncs.com/picture/homelab-wireguard-openwrt-peers-connect-login-page2.png alt=homelab-wireguard-openwrt-peers-connect-login-page2.png></p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%85%AE%E5%85%8B-2.5g-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B0%86%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A-epon-%E6%94%B9%E4%B8%BA-odi-%E7%8C%AB%E6%A3%92%E6%8E%A5%E5%85%A5/><span>&larr;&nbsp;&nbsp;</span><span>使用兮克 2.5G 交换机将北京联通 EPON 改为 ODI 猫棒接入</span></a>
<a class=next href=https://blog.hellowood.dev/posts/proxmox-ve-%E6%B7%BB%E5%8A%A0%E7%9B%91%E6%8E%A7/><span>Proxmox VE 添加监控</span><span>&nbsp;&nbsp;&rarr;</span></a></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://blog.hellowood.dev>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>