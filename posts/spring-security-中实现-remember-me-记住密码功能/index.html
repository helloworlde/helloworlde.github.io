<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Security 中实现 Remember Me 记住密码功能</title>
<meta charset=utf-8><meta name=description content='Ladder@在 Spring Boot 应用中使用 Spring Security 并实现 Remember Me 记住密码功能，实现自动登录
前置条件：在 Spring Boot 应用中已正确配置 Spring Security
##在页面添加记住密码的复选框
<input type="checkbox" name="remember-me"/> Remember me ##在 Security Config 配置文件中启用记住密码功能(验证信息存放在内存中)
SecurityConfig import cn.com.hellowood.springsecurity.security.CustomAuthenticationProvider; import cn.com.hellowood.springsecurity.security.CustomUserDetailsService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdater; @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private CustomAuthenticationProvider customAuthenticationProvider; @Autowired private CustomUserDetailsService userDetailsService; @Override protected void configure(HttpSecurity http) throws Exception { // 任何用户都可以访问以下URI http.authorizeRequests() .antMatchers("/", "/login", "/login-error", "/css/**", "/index") .'><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/spring-security-%E4%B8%AD%E5%AE%9E%E7%8E%B0-remember-me-%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81%E5%8A%9F%E8%83%BD/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/spring-security-%E4%B8%AD%E5%AE%9E%E7%8E%B0-remember-me-%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81%E5%8A%9F%E8%83%BD/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="Spring Security 中实现 Remember Me 记住密码功能"><meta property="og:description" content="在 Spring Boot 应用中使用 Spring Security 并实现 Remember Me 记住密码功能，实现自动登录
前置条件：在 Spring Boot 应用中已正确配置 Spring Security
##在页面添加记住密码的复选框
&amp;lt;input type=&amp;#34;checkbox&amp;#34; name=&amp;#34;remember-me&amp;#34;/&amp;gt; Remember me ##在 Security Config 配置文件中启用记住密码功能(验证信息存放在内存中)
SecurityConfig import cn.com.hellowood.springsecurity.security.CustomAuthenticationProvider; import cn.com.hellowood.springsecurity.security.CustomUserDetailsService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdater; @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private CustomAuthenticationProvider customAuthenticationProvider; @Autowired private CustomUserDetailsService userDetailsService; @Override protected void configure(HttpSecurity http) throws Exception { // 任何用户都可以访问以下URI http.authorizeRequests() .antMatchers(&amp;#34;/&amp;#34;, &amp;#34;/login&amp;#34;, &amp;#34;/login-error&amp;#34;, &amp;#34;/css/**&amp;#34;, &amp;#34;/index&amp;#34;) ."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-01T00:35:56+00:00"><meta property="article:modified_time" content="2018-01-01T00:35:56+00:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="Spring Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Security 中实现 Remember Me 记住密码功能"><meta name=twitter:description content='在 Spring Boot 应用中使用 Spring Security 并实现 Remember Me 记住密码功能，实现自动登录
前置条件：在 Spring Boot 应用中已正确配置 Spring Security
##在页面添加记住密码的复选框
<input type="checkbox" name="remember-me"/> Remember me ##在 Security Config 配置文件中启用记住密码功能(验证信息存放在内存中)
SecurityConfig import cn.com.hellowood.springsecurity.security.CustomAuthenticationProvider; import cn.com.hellowood.springsecurity.security.CustomUserDetailsService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdater; @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private CustomAuthenticationProvider customAuthenticationProvider; @Autowired private CustomUserDetailsService userDetailsService; @Override protected void configure(HttpSecurity http) throws Exception { // 任何用户都可以访问以下URI http.authorizeRequests() .antMatchers("/", "/login", "/login-error", "/css/**", "/index") .'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"Spring Security 中实现 Remember Me 记住密码功能","item":"https://blog.hellowood.dev/posts/spring-security-%E4%B8%AD%E5%AE%9E%E7%8E%B0-remember-me-%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81%E5%8A%9F%E8%83%BD/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Security 中实现 Remember Me 记住密码功能","name":"Spring Security 中实现 Remember Me 记住密码功能","description":"在 Spring Boot 应用中使用 Spring Security 并实现 Remember Me 记住密码功能，实现自动登录\n前置条件：在 Spring Boot 应用中已正确配置 Spring Security\n##在页面添加记住密码的复选框\n\u0026lt;input type=\u0026#34;checkbox\u0026#34; name=\u0026#34;remember-me\u0026#34;/\u0026gt; Remember me ##在 Security Config 配置文件中启用记住密码功能(验证信息存放在内存中)\nSecurityConfig import cn.com.hellowood.springsecurity.security.CustomAuthenticationProvider; import cn.com.hellowood.springsecurity.security.CustomUserDetailsService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdater; @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private CustomAuthenticationProvider customAuthenticationProvider; @Autowired private CustomUserDetailsService userDetailsService; @Override protected void configure(HttpSecurity http) throws Exception { // 任何用户都可以访问以下URI http.authorizeRequests() .antMatchers(\u0026#34;/\u0026#34;, \u0026#34;/login\u0026#34;, \u0026#34;/login-error\u0026#34;, \u0026#34;/css/**\u0026#34;, \u0026#34;/index\u0026#34;) .","keywords":["Java","SpringBoot","Spring Security"],"articleBody":" 在 Spring Boot 应用中使用 Spring Security 并实现 Remember Me 记住密码功能，实现自动登录\n前置条件：在 Spring Boot 应用中已正确配置 Spring Security\n##在页面添加记住密码的复选框\nRemember me ##在 Security Config 配置文件中启用记住密码功能(验证信息存放在内存中)\nSecurityConfig import cn.com.hellowood.springsecurity.security.CustomAuthenticationProvider; import cn.com.hellowood.springsecurity.security.CustomUserDetailsService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdater; @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private CustomAuthenticationProvider customAuthenticationProvider; @Autowired private CustomUserDetailsService userDetailsService; @Override protected void configure(HttpSecurity http) throws Exception { // 任何用户都可以访问以下URI http.authorizeRequests() .antMatchers(\"/\", \"/login\", \"/login-error\", \"/css/**\", \"/index\") .permitAll(); // 其他URI均需要权限校验 http.authorizeRequests() .anyRequest() .authenticated(); // 只需要以下配置即可启用记住密码 http.authorizeRequests() .and() .rememberMe(); http.formLogin() .loginPage(\"/login\") .usernameParameter(\"username\") .passwordParameter(\"password\") .successForwardUrl(\"/user/index\") .failureUrl(\"/login-error\"); } @Autowired public void configureGlobal(AuthenticationManagerBuilder auth) { // 为了使用用户名密码校验实现了AuthenticationProvider和UserDetailsService类 auth.authenticationProvider(customAuthenticationProvider); try { auth.userDetailsService(userDetailsService); } catch (Exception e) { e.printStackTrace(); } } } 这样就可以使用记住密码了，选择记住密码登录后会在本地保存 Cookie，下次登录的时候通过 Cookie 校验用户信息；用户登录的信息保存在内存中，当内存断电或被清除之后该 Cookie 即使在有效期内也无法登录。\n通过数据库存放校验信息实现记住密码登录 ###创建保存校验信息的表(表名和字段值必须为以下内容)\nCREATE TABLE persistent_logins ( username VARCHAR(64) NOT NULL, series VARCHAR(64) NOT NULL PRIMARY KEY, token VARCHAR(64) NOT NULL, last_used TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP ); 配置 Security Config import cn.com.hellowood.springsecurity.security.*; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.context.annotation.Bean; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter; import org.springframework.security.core.session.SessionRegistry; import org.springframework.security.core.session.SessionRegistryImpl; import org.springframework.security.web.authentication.RememberMeServices; import org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl; import org.springframework.security.web.authentication.rememberme.PersistentTokenBasedRememberMeServices; import javax.sql.DataSource; @EnableWebSecurity public class SecurityConfig extends WebSecurityConfigurerAdapter { private final Logger logger = LoggerFactory.getLogger(getClass()); @Autowired private CustomAuthenticationProvider customAuthenticationProvider; @Autowired private CustomUserDetailsService userDetailsService; // 数据源是为了JdbcRememberMeImpl实例而注入的，如果不设置数据源会在登陆的时候抛空指针异常 @Autowired @Qualifier(\"dataSource\") DataSource dataSource; @Override protected void configure(HttpSecurity http) throws Exception { // 任何用户都可以访问以下URI http.authorizeRequests() .antMatchers(\"/\", \"/login\", \"/login-error\", \"/css/**\", \"/index\") .permitAll(); // 其他URI需要权限验证 http.authorizeRequests() .anyRequest() .authenticated(); // 当通过JDBC方式记住密码时必须设置 key，key 可以为任意非空(null 或 \"\")字符串，但必须和 RememberMeService 构造参数的 // key 一致，否则会导致通过记住密码登录失败 http.authorizeRequests() .and() .rememberMe() .rememberMeServices(rememberMeServices()) .key(\"INTERNAL_SECRET_KEY\"); // 当登录成功后会被重定向到 /user/index, 所以 loginPage 和 loginProcessingUrl 相同 http.formLogin() .loginPage(\"/login\") .loginProcessingUrl(\"/login\") .usernameParameter(\"username\") .passwordParameter(\"password\") .successForwardUrl(\"/user/index\") .failureUrl(\"/login-error\"); } /** * 返回 RememberMeServices 实例 * * @return the remember me services */ @Bean public RememberMeServices rememberMeServices() { JdbcTokenRepositoryImpl rememberMeTokenRepository = new JdbcTokenRepositoryImpl(); // 此处需要设置数据源，否则无法从数据库查询验证信息 rememberMeTokenRepository.setDataSource(dataSource); // 此处的 key 可以为任意非空值(null 或 \"\")，单必须和起前面 // rememberMeServices(RememberMeServices rememberMeServices).key(key)的值相同 PersistentTokenBasedRememberMeServices rememberMeServices = new PersistentTokenBasedRememberMeServices(\"INTERNAL_SECRET_KEY\", userDetailsService, rememberMeTokenRepository); // 该参数不是必须的，默认值为 \"remember-me\", 但如果设置必须和页面复选框的 name 一致 rememberMeServices.setParameter(\"remember-me\"); return rememberMeServices; } /** * Configure global. * * @param auth the auth * @throws Exception the exception */ @Autowired public void configureGlobal(AuthenticationManagerBuilder auth) { // 为了使用用户名密码校验实现了AuthenticationProvider和UserDetailsService类 auth.authenticationProvider(customAuthenticationProvider); try { auth.userDetailsService(userDetailsService); } catch (Exception e) { logger.error(\"Set userDetailService failed, {}\", e.getMessage()); e.printStackTrace(); } } } 这样就可以实现将校验信息保存在数据库中，下次通过记住密码登录后再次访问页面会根据 Cookie 查找该用户的登录信息，如果登录信息有效则登录成功， 否则重定向到登录页面\n自定义实现 AuthenticationProvider 接口 import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.authentication.AuthenticationProvider; import org.springframework.security.authentication.UsernamePasswordAuthenticationToken; import org.springframework.security.core.Authentication; import org.springframework.security.core.AuthenticationException; import org.springframework.security.core.GrantedAuthority; import org.springframework.stereotype.Component; import java.util.ArrayList; import java.util.List; /** * The type Custom authentication provider. * * @author HelloWood */ @Component public class CustomAuthenticationProvider implements AuthenticationProvider { private final Logger logger = LoggerFactory.getLogger(getClass()); @Autowired private CustomUserDetailsService userDetailsService; /** * Validate user info is correct form database * * @param authentication * @return * @throws AuthenticationException */ @Override public Authentication authenticate(Authentication authentication) throws AuthenticationException { String username = authentication.getName(); String password = authentication.getCredentials().toString(); List grantedAuthorities = new ArrayList\u003c\u003e(); logger.info(\"start validate user {} login\", username); // 通过用户名和密码校验，如果校验不通过会抛出 AuthenticationException userDetailsService.loadUserByUsernameAndPassword(username, password); Authentication auth = new UsernamePasswordAuthenticationToken(username, password, grantedAuthorities); return auth; } @Override public boolean supports(Class\u003c?\u003e authentication) { return authentication.equals(UsernamePasswordAuthenticationToken.class); } } 自定义实现 UserDetailsService 接口 import cn.com.hellowood.springsecurity.mapper.UserMapper; import cn.com.hellowood.springsecurity.model.UserModel; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.authentication.AccountExpiredException; import org.springframework.security.authentication.BadCredentialsException; import org.springframework.security.core.AuthenticationException; import org.springframework.security.core.GrantedAuthority; import org.springframework.security.core.userdetails.User; import org.springframework.security.core.userdetails.UserDetails; import org.springframework.security.core.userdetails.UserDetailsService; import org.springframework.security.core.userdetails.UsernameNotFoundException; import org.springframework.stereotype.Service; import javax.servlet.http.HttpSession; import java.util.ArrayList; /** * The type Custom user details service. * * @author HelloWood */ @Service(\"userDetailsService\") public class CustomUserDetailsService implements UserDetailsService { private Logger logger = LoggerFactory.getLogger(getClass()); @Autowired private UserMapper userMapper; @Autowired private HttpSession session; /** * 通过用户名和密码加载用户信息并校验 * * @param username the username * @param password the password * @return the user model * @throws AuthenticationException the authentication exception */ public UserModel loadUserByUsernameAndPassword(String username, String password) throws AuthenticationException { logger.info(\"user {} is login by username and password\", username); UserModel user = userMapper.getUserByUsernameAndPassword(username, password); validateUser(username, user); return user; } /** * 通过用户名加载用户信息，重写该方法用于记住密码后通过 Cookie 登录 * * @param username * @param user */ @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { logger.info(\"user {} is login by remember me cookie\", username); UserModel user = userMapper.getUserByUsername(username); validateUser(username, user); return new User(user.getUsername(), user.getPassword(), new ArrayList()); } /** * 校验用户信息并将用户信息放在 Session 中 * * @param username * @param user */ private void validateUser(String username, UserModel user) { if (user == null) { logger.error(\"user {} login failed, username or password is wrong\", username); throw new BadCredentialsException(\"Username or password is not correct\"); } else if (!user.getEnabled()) { logger.error(\"user {} login failed, this account had expired\", username); throw new AccountExpiredException(\"Account had expired\"); } // TODO There should add more logic to determine locked, expired and others status logger.info(\"user {} login success\", username); // 当用户信息有效时放入 Session 中 session.setAttribute(\"user\", user); } } ","wordCount":"741","inLanguage":"en","datePublished":"2018-01-01T00:35:56Z","dateModified":"2018-01-01T00:35:56Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/spring-security-%E4%B8%AD%E5%AE%9E%E7%8E%B0-remember-me-%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81%E5%8A%9F%E8%83%BD/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Spring Security 中实现 Remember Me 记住密码功能</h1></header><p><small>January 1, 2018&nbsp;· 741 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#通过数据库存放校验信息实现记住密码登录>通过数据库存放校验信息实现记住密码登录</a><ul><li><a href=#配置-security-config>配置 Security Config</a></li></ul></li></ul></nav></div><section class=blog-content><blockquote><p>在 Spring Boot 应用中使用 Spring Security 并实现 Remember Me 记住密码功能，实现自动登录</p></blockquote><hr><blockquote><p>前置条件：在 Spring Boot 应用中已正确配置 Spring Security</p></blockquote><p>##在页面添加记住密码的复选框</p><pre tabindex=0><code> &lt;input type=&#34;checkbox&#34; name=&#34;remember-me&#34;/&gt; Remember me
</code></pre><p>##在 Security Config 配置文件中启用记住密码功能(验证信息存放在内存中)</p><ul><li>SecurityConfig</li></ul><pre tabindex=0><code>    import cn.com.hellowood.springsecurity.security.CustomAuthenticationProvider;
    import cn.com.hellowood.springsecurity.security.CustomUserDetailsService;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdater;
    
    @EnableWebSecurity
    public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
        @Autowired
        private CustomAuthenticationProvider customAuthenticationProvider;
    
        @Autowired
        private CustomUserDetailsService userDetailsService;
    
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            // 任何用户都可以访问以下URI
            http.authorizeRequests()
                    .antMatchers(&#34;/&#34;, &#34;/login&#34;, &#34;/login-error&#34;, &#34;/css/**&#34;, &#34;/index&#34;)
                    .permitAll();
    
            // 其他URI均需要权限校验
            http.authorizeRequests()
                    .anyRequest()
                    .authenticated();
    
            // 只需要以下配置即可启用记住密码
            http.authorizeRequests()
                    .and()
                    .rememberMe();
    
            http.formLogin()
                    .loginPage(&#34;/login&#34;)
                    .usernameParameter(&#34;username&#34;)
                    .passwordParameter(&#34;password&#34;)
                    .successForwardUrl(&#34;/user/index&#34;)
                    .failureUrl(&#34;/login-error&#34;);
        }
    
        @Autowired
        public void configureGlobal(AuthenticationManagerBuilder auth) {
            // 为了使用用户名密码校验实现了AuthenticationProvider和UserDetailsService类
            auth.authenticationProvider(customAuthenticationProvider);
            try {
                auth.userDetailsService(userDetailsService);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
</code></pre><blockquote><p>这样就可以使用记住密码了，选择记住密码登录后会在本地保存 Cookie，下次登录的时候通过 Cookie 校验用户信息；用户登录的信息保存在内存中，当内存断电或被清除之后该 Cookie 即使在有效期内也无法登录。</p></blockquote><hr><h2 id=通过数据库存放校验信息实现记住密码登录>通过数据库存放校验信息实现记住密码登录</h2><p>###创建保存校验信息的表(表名和字段值必须为以下内容)</p><pre tabindex=0><code>    CREATE TABLE persistent_logins (
      username  VARCHAR(64) NOT NULL,
      series    VARCHAR(64) NOT NULL PRIMARY KEY,
      token     VARCHAR(64) NOT NULL,
      last_used TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    );
</code></pre><h3 id=配置-security-config>配置 Security Config</h3><pre tabindex=0><code>    import cn.com.hellowood.springsecurity.security.*;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.beans.factory.annotation.Qualifier;
    import org.springframework.context.annotation.Bean;
    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
    import org.springframework.security.core.session.SessionRegistry;
    import org.springframework.security.core.session.SessionRegistryImpl;
    import org.springframework.security.web.authentication.RememberMeServices;
    import org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl;
    import org.springframework.security.web.authentication.rememberme.PersistentTokenBasedRememberMeServices;
    
    import javax.sql.DataSource;
    
    @EnableWebSecurity
    public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
        private final Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private CustomAuthenticationProvider customAuthenticationProvider;
    
        @Autowired
        private CustomUserDetailsService userDetailsService;
    
        // 数据源是为了JdbcRememberMeImpl实例而注入的，如果不设置数据源会在登陆的时候抛空指针异常
        @Autowired
        @Qualifier(&#34;dataSource&#34;)
        DataSource dataSource;
    
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            // 任何用户都可以访问以下URI
            http.authorizeRequests()
                    .antMatchers(&#34;/&#34;, &#34;/login&#34;, &#34;/login-error&#34;, &#34;/css/**&#34;, &#34;/index&#34;)
                    .permitAll();
    
            // 其他URI需要权限验证
            http.authorizeRequests()
                    .anyRequest()
                    .authenticated();
    
            // 当通过JDBC方式记住密码时必须设置 key，key 可以为任意非空(null 或 &#34;&#34;)字符串，但必须和 RememberMeService 构造参数的
            // key 一致，否则会导致通过记住密码登录失败
            http.authorizeRequests()
                    .and()
                    .rememberMe()
                    .rememberMeServices(rememberMeServices())
                    .key(&#34;INTERNAL_SECRET_KEY&#34;);
    
            // 当登录成功后会被重定向到 /user/index, 所以 loginPage 和 loginProcessingUrl 相同
            http.formLogin()
                    .loginPage(&#34;/login&#34;)
                    .loginProcessingUrl(&#34;/login&#34;)
                    .usernameParameter(&#34;username&#34;)
                    .passwordParameter(&#34;password&#34;)
                    .successForwardUrl(&#34;/user/index&#34;)
                    .failureUrl(&#34;/login-error&#34;);
        }
    
    
        /**
         * 返回 RememberMeServices 实例
         *
         * @return the remember me services
         */
        @Bean
        public RememberMeServices rememberMeServices() {
            JdbcTokenRepositoryImpl rememberMeTokenRepository = new JdbcTokenRepositoryImpl();
            // 此处需要设置数据源，否则无法从数据库查询验证信息
            rememberMeTokenRepository.setDataSource(dataSource);
    
            // 此处的 key 可以为任意非空值(null 或 &#34;&#34;)，单必须和起前面
            // rememberMeServices(RememberMeServices rememberMeServices).key(key)的值相同
            PersistentTokenBasedRememberMeServices rememberMeServices =
                    new PersistentTokenBasedRememberMeServices(&#34;INTERNAL_SECRET_KEY&#34;, userDetailsService, rememberMeTokenRepository);
    
            // 该参数不是必须的，默认值为 &#34;remember-me&#34;, 但如果设置必须和页面复选框的 name 一致
            rememberMeServices.setParameter(&#34;remember-me&#34;);
            return rememberMeServices;
        }
        
        /**
         * Configure global.
         *
         * @param auth the auth
         * @throws Exception the exception
         */
        @Autowired
        public void configureGlobal(AuthenticationManagerBuilder auth) {
            // 为了使用用户名密码校验实现了AuthenticationProvider和UserDetailsService类
            auth.authenticationProvider(customAuthenticationProvider);
            try {
                auth.userDetailsService(userDetailsService);
            } catch (Exception e) {
                logger.error(&#34;Set userDetailService failed, {}&#34;, e.getMessage());
                e.printStackTrace();
            }
        }
    }
</code></pre><blockquote><p>这样就可以实现将校验信息保存在数据库中，下次通过记住密码登录后再次访问页面会根据 Cookie 查找该用户的登录信息，如果登录信息有效则登录成功， 否则重定向到登录页面</p></blockquote><hr><ul><li>自定义实现 AuthenticationProvider 接口</li></ul><pre tabindex=0><code>    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.security.authentication.AuthenticationProvider;
    import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
    import org.springframework.security.core.Authentication;
    import org.springframework.security.core.AuthenticationException;
    import org.springframework.security.core.GrantedAuthority;
    import org.springframework.stereotype.Component;
    
    import java.util.ArrayList;
    import java.util.List;
    
    /**
     * The type Custom authentication provider.
     *
     * @author HelloWood
     */
    @Component
    public class CustomAuthenticationProvider implements AuthenticationProvider {
    
        private final Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private CustomUserDetailsService userDetailsService;
    
        /**
         * Validate user info is correct form database
         *
         * @param authentication
         * @return
         * @throws AuthenticationException
         */
        @Override
        public Authentication authenticate(Authentication authentication) throws AuthenticationException {
            String username = authentication.getName();
            String password = authentication.getCredentials().toString();
            List&lt;GrantedAuthority&gt; grantedAuthorities = new ArrayList&lt;&gt;();
    
            logger.info(&#34;start validate user {} login&#34;, username);
            // 通过用户名和密码校验，如果校验不通过会抛出 AuthenticationException
            userDetailsService.loadUserByUsernameAndPassword(username, password);
            Authentication auth = new UsernamePasswordAuthenticationToken(username, password, grantedAuthorities);
            return auth;
        }
    
    
        @Override
        public boolean supports(Class&lt;?&gt; authentication) {
            return authentication.equals(UsernamePasswordAuthenticationToken.class);
        }
    
    }
</code></pre><ul><li>自定义实现 UserDetailsService 接口</li></ul><pre tabindex=0><code>
    import cn.com.hellowood.springsecurity.mapper.UserMapper;
    import cn.com.hellowood.springsecurity.model.UserModel;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.security.authentication.AccountExpiredException;
    import org.springframework.security.authentication.BadCredentialsException;
    import org.springframework.security.core.AuthenticationException;
    import org.springframework.security.core.GrantedAuthority;
    import org.springframework.security.core.userdetails.User;
    import org.springframework.security.core.userdetails.UserDetails;
    import org.springframework.security.core.userdetails.UserDetailsService;
    import org.springframework.security.core.userdetails.UsernameNotFoundException;
    import org.springframework.stereotype.Service;
    
    import javax.servlet.http.HttpSession;
    import java.util.ArrayList;
    
    /**
     * The type Custom user details service.
     *
     * @author HelloWood
     */
    @Service(&#34;userDetailsService&#34;)
    public class CustomUserDetailsService implements UserDetailsService {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
    
        @Autowired
        private UserMapper userMapper;
    
        @Autowired
        private HttpSession session;
    
        /**
         * 通过用户名和密码加载用户信息并校验
         *
         * @param username the username
         * @param password the password
         * @return the user model
         * @throws AuthenticationException the authentication exception
         */
        public UserModel loadUserByUsernameAndPassword(String username, String password) throws AuthenticationException {
            logger.info(&#34;user {} is login by username and password&#34;, username);
            UserModel user = userMapper.getUserByUsernameAndPassword(username, password);
            validateUser(username, user);
            return user;
        }
    
    
        /**
        * 通过用户名加载用户信息，重写该方法用于记住密码后通过 Cookie 登录
        * 
        * @param username
        * @param user
        */
        @Override
        public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
            logger.info(&#34;user {} is login by remember me cookie&#34;, username);
            UserModel user = userMapper.getUserByUsername(username);
            validateUser(username, user);
            return new User(user.getUsername(), user.getPassword(), new ArrayList&lt;GrantedAuthority&gt;());
        }
    
        /**
         * 校验用户信息并将用户信息放在 Session 中
         *
         * @param username
         * @param user
         */
        private void validateUser(String username, UserModel user) {
            if (user == null) {
                logger.error(&#34;user {} login failed, username or password is wrong&#34;, username);
                throw new BadCredentialsException(&#34;Username or password is not correct&#34;);
            } else if (!user.getEnabled()) {
                logger.error(&#34;user {} login failed, this account had expired&#34;, username);
                throw new AccountExpiredException(&#34;Account had expired&#34;);
            }
            // TODO There should add more logic to determine locked, expired and others status
    
            logger.info(&#34;user {} login success&#34;, username);
            // 当用户信息有效时放入 Session 中
            session.setAttribute(&#34;user&#34;, user);
        }
    }
</code></pre></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/spring-security-%E7%9A%84-remember-me-%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81%E5%8A%9F%E8%83%BD%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>在使用 Spring Security 的 Remember Me 记住密码功能时遇到的问题和解决方法</span></a>
<a class=next href=https://blog.hellowood.dev/posts/spring-boot-%E4%B8%AD%E9%9B%86%E6%88%90-spring-security/><span>Spring Boot 中集成 Spring Security</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>