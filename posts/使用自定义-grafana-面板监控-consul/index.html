<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>使用自定义 Grafana 面板监控 Consul</title>
<meta charset=utf-8><meta name=description content='Ladder@使用自定义 Grafana 面板监控 Consul 使用 Prometheus和 Grafana监控 Consul，Dashboard 中的基本都是Consul 自身的状态，除此之外，还需要一些业务相关的监控，比如当前注册的服务数量，健康和不健康的服务数量，拉取服务请求响应时间等数据
使用已有的 Dashboard 如使用 consul server 这个面板，这个面板数据非常齐全，但是在 Prometheus 中添加了任务之后，发现很多数据都没有，如集群中 server的数量 consul_serf_lan_members 这个数据，从 Consul 的 Metrics 中 http://localhost:8500/v1/agent/metrics?format=prometheus拉取也没有相关的数据，是因为Consul并没有提供相应的数据检测
针对这种问题，可以使用 consul_exporter 这个项目，该项目会通过 Consul 的API 拉取相应的数据，在整理后通过自己的接口提供相应的统计数据
通过 Docker 启动 docker run --name exporter -d -p 9107:9107 prom/consul-exporter --consul.server=host.docker.internal:8500 检查数据 curl localhost:9107/metrics 会返回相应的监控数据，这样就可以将 Consul中未提供的数据添加到 Prometheus中了
自定义监控数据 如果数据仍然不满足，可以基于consul_exporter 这个项目进行扩展，添加自定义的统计数据；如现在需要统计集群的响应时间，可以通过统计请求consul的耗时来实现：
添加自定义的统计项 在常量中添加一个新的统计项
responseTime = prometheus.NewDesc( prometheus.BuildFQName(namespace, "", "response_time"), "Time spend for a request ", []string{"node", "server_ip"}, nil, ) 实现统计方法 func (e *Exporter) collectResponseTime(ch chan<- prometheus.'><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89-grafana-%E9%9D%A2%E6%9D%BF%E7%9B%91%E6%8E%A7-consul/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89-grafana-%E9%9D%A2%E6%9D%BF%E7%9B%91%E6%8E%A7-consul/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="使用自定义 Grafana 面板监控 Consul"><meta property="og:description" content="使用自定义 Grafana 面板监控 Consul 使用 Prometheus和 Grafana监控 Consul，Dashboard 中的基本都是Consul 自身的状态，除此之外，还需要一些业务相关的监控，比如当前注册的服务数量，健康和不健康的服务数量，拉取服务请求响应时间等数据
使用已有的 Dashboard 如使用 consul server 这个面板，这个面板数据非常齐全，但是在 Prometheus 中添加了任务之后，发现很多数据都没有，如集群中 server的数量 consul_serf_lan_members 这个数据，从 Consul 的 Metrics 中 http://localhost:8500/v1/agent/metrics?format=prometheus拉取也没有相关的数据，是因为Consul并没有提供相应的数据检测
针对这种问题，可以使用 consul_exporter 这个项目，该项目会通过 Consul 的API 拉取相应的数据，在整理后通过自己的接口提供相应的统计数据
通过 Docker 启动 docker run --name exporter -d -p 9107:9107 prom/consul-exporter --consul.server=host.docker.internal:8500 检查数据 curl localhost:9107/metrics 会返回相应的监控数据，这样就可以将 Consul中未提供的数据添加到 Prometheus中了
自定义监控数据 如果数据仍然不满足，可以基于consul_exporter 这个项目进行扩展，添加自定义的统计数据；如现在需要统计集群的响应时间，可以通过统计请求consul的耗时来实现：
添加自定义的统计项 在常量中添加一个新的统计项
responseTime = prometheus.NewDesc( prometheus.BuildFQName(namespace, &amp;#34;&amp;#34;, &amp;#34;response_time&amp;#34;), &amp;#34;Time spend for a request &amp;#34;, []string{&amp;#34;node&amp;#34;, &amp;#34;server_ip&amp;#34;}, nil, ) 实现统计方法 func (e *Exporter) collectResponseTime(ch chan&amp;lt;- prometheus."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-16T14:47:24+00:00"><meta property="article:modified_time" content="2020-05-16T14:47:24+00:00"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Grafana"><meta property="article:tag" content="Consul"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用自定义 Grafana 面板监控 Consul"><meta name=twitter:description content='使用自定义 Grafana 面板监控 Consul 使用 Prometheus和 Grafana监控 Consul，Dashboard 中的基本都是Consul 自身的状态，除此之外，还需要一些业务相关的监控，比如当前注册的服务数量，健康和不健康的服务数量，拉取服务请求响应时间等数据
使用已有的 Dashboard 如使用 consul server 这个面板，这个面板数据非常齐全，但是在 Prometheus 中添加了任务之后，发现很多数据都没有，如集群中 server的数量 consul_serf_lan_members 这个数据，从 Consul 的 Metrics 中 http://localhost:8500/v1/agent/metrics?format=prometheus拉取也没有相关的数据，是因为Consul并没有提供相应的数据检测
针对这种问题，可以使用 consul_exporter 这个项目，该项目会通过 Consul 的API 拉取相应的数据，在整理后通过自己的接口提供相应的统计数据
通过 Docker 启动 docker run --name exporter -d -p 9107:9107 prom/consul-exporter --consul.server=host.docker.internal:8500 检查数据 curl localhost:9107/metrics 会返回相应的监控数据，这样就可以将 Consul中未提供的数据添加到 Prometheus中了
自定义监控数据 如果数据仍然不满足，可以基于consul_exporter 这个项目进行扩展，添加自定义的统计数据；如现在需要统计集群的响应时间，可以通过统计请求consul的耗时来实现：
添加自定义的统计项 在常量中添加一个新的统计项
responseTime = prometheus.NewDesc( prometheus.BuildFQName(namespace, "", "response_time"), "Time spend for a request ", []string{"node", "server_ip"}, nil, ) 实现统计方法 func (e *Exporter) collectResponseTime(ch chan<- prometheus.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"使用自定义 Grafana 面板监控 Consul","item":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89-grafana-%E9%9D%A2%E6%9D%BF%E7%9B%91%E6%8E%A7-consul/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用自定义 Grafana 面板监控 Consul","name":"使用自定义 Grafana 面板监控 Consul","description":"使用自定义 Grafana 面板监控 Consul 使用 Prometheus和 Grafana监控 Consul，Dashboard 中的基本都是Consul 自身的状态，除此之外，还需要一些业务相关的监控，比如当前注册的服务数量，健康和不健康的服务数量，拉取服务请求响应时间等数据\n使用已有的 Dashboard 如使用 consul server 这个面板，这个面板数据非常齐全，但是在 Prometheus 中添加了任务之后，发现很多数据都没有，如集群中 server的数量 consul_serf_lan_members 这个数据，从 Consul 的 Metrics 中 http://localhost:8500/v1/agent/metrics?format=prometheus拉取也没有相关的数据，是因为Consul并没有提供相应的数据检测\n针对这种问题，可以使用 consul_exporter 这个项目，该项目会通过 Consul 的API 拉取相应的数据，在整理后通过自己的接口提供相应的统计数据\n通过 Docker 启动 docker run --name exporter -d -p 9107:9107 prom/consul-exporter --consul.server=host.docker.internal:8500 检查数据 curl localhost:9107/metrics 会返回相应的监控数据，这样就可以将 Consul中未提供的数据添加到 Prometheus中了\n自定义监控数据 如果数据仍然不满足，可以基于consul_exporter 这个项目进行扩展，添加自定义的统计数据；如现在需要统计集群的响应时间，可以通过统计请求consul的耗时来实现：\n添加自定义的统计项 在常量中添加一个新的统计项\nresponseTime = prometheus.NewDesc( prometheus.BuildFQName(namespace, \u0026#34;\u0026#34;, \u0026#34;response_time\u0026#34;), \u0026#34;Time spend for a request \u0026#34;, []string{\u0026#34;node\u0026#34;, \u0026#34;server_ip\u0026#34;}, nil, ) 实现统计方法 func (e *Exporter) collectResponseTime(ch chan\u0026lt;- prometheus.","keywords":["Prometheus","Grafana","Consul"],"articleBody":"使用自定义 Grafana 面板监控 Consul 使用 Prometheus和 Grafana监控 Consul，Dashboard 中的基本都是Consul 自身的状态，除此之外，还需要一些业务相关的监控，比如当前注册的服务数量，健康和不健康的服务数量，拉取服务请求响应时间等数据\n使用已有的 Dashboard 如使用 consul server 这个面板，这个面板数据非常齐全，但是在 Prometheus 中添加了任务之后，发现很多数据都没有，如集群中 server的数量 consul_serf_lan_members 这个数据，从 Consul 的 Metrics 中 http://localhost:8500/v1/agent/metrics?format=prometheus拉取也没有相关的数据，是因为Consul并没有提供相应的数据检测\n针对这种问题，可以使用 consul_exporter 这个项目，该项目会通过 Consul 的API 拉取相应的数据，在整理后通过自己的接口提供相应的统计数据\n通过 Docker 启动 docker run --name exporter -d -p 9107:9107 prom/consul-exporter --consul.server=host.docker.internal:8500 检查数据 curl localhost:9107/metrics 会返回相应的监控数据，这样就可以将 Consul中未提供的数据添加到 Prometheus中了\n自定义监控数据 如果数据仍然不满足，可以基于consul_exporter 这个项目进行扩展，添加自定义的统计数据；如现在需要统计集群的响应时间，可以通过统计请求consul的耗时来实现：\n添加自定义的统计项 在常量中添加一个新的统计项\nresponseTime = prometheus.NewDesc( prometheus.BuildFQName(namespace, \"\", \"response_time\"), \"Time spend for a request \", []string{\"node\", \"server_ip\"}, nil, ) 实现统计方法 func (e *Exporter) collectResponseTime(ch chan\u003c- prometheus.Metric) bool { start := time.Now().Nanosecond() serverIp, err := e.client.Status().Leader() if err != nil { _ = level.Error(e.logger).Log(\"msg\", \"Failed to query leader data\", \"err\", err) return false } costTime := time.Now().Nanosecond() - start ch \u003c- prometheus.MustNewConstMetric(responseTime, prometheus.GaugeValue, float64(costTime), \"leader\", serverIp) return true } 将统计项添加到 Collect 和 Describe中 func (e *Exporter) Describe(ch chan\u003c- *prometheus.Desc) { ch \u003c- responseTime } func (e *Exporter) Collect(ch chan\u003c- prometheus.Metric) { ok = e.collectResponseTime(ch) \u0026\u0026 ok } 这样，就会在启动后获取相应的数据，之后在 Prometheus 和 Grafana 中可以看到相应的数据\n自定义 Dashboard 自定义的 Dashboard 是通过展示 PromQL 查询的结果来实现的\n如在应用中有错误请求的统计，是通过累加错误的请求次数实现的，如统计值 consul_response_time\n原始数据： # HELP consul_response_time Time spend for a request # TYPE consul_response_time gauge consul_response_time{node=\"leader\",server_ip=\"172.19.0.2:8300\"} 2.238e+06 现在要统计所有的错误请求次数，可以在 Prometheus 的查询面板中查询： consul_response_time 这样，就可以得到相应的错误数据，接下来只需要在Grafana中展示就可以\n添加看板 添加一个 Dashboard，并添加一个 Panel，在 Panel 的 Metrics 中添加刚才的查询语句\n执行查询后，会看到有图表生成，变量的名称通过 Legend 字段指定，如这里是 {instance=\"host.docker.internal:9107\", job=\"consul-exporter\", node=\"leader\", server_ip=\"172.19.0.2:8300\"}，需要显示IP，即 server_ip 的值，可以设置 Legend，这样会显示正确的名称\n其他的显示单位，显示效果等以及面板的名称可以通过旁边的设置选项进行配置\n监控服务信息 可以根据 Consul 和 consul_exporter 对服务状态进行监控，只需要根据不同的数据进行聚合配置就可以实现\n节点信息 sum(consul_health_node_status) 健康节点信息 sum(consul_health_node_status{status=\"passing\"}) 不健康节点信息 sum(consul_health_node_status{status!=\"passing\"}) 服务信息 count(sum(consul_health_service_status) by (service_name)) 实例数量 sum(consul_health_service_status) 健康实例数量 sum(consul_health_service_status{status=\"passing\"}) 不健康实例数量 sum(consul_health_service_status{status!=\"passing\"}) 响应延时 consul_response_time/1000000 服务状态 sum(consul_health_service_status{status!=\"passing\"}) by (service_name) sum(consul_health_service_status) by (service_name) 服务注册信息 sum(consul_health_service_status) sum(consul_health_service_status{status=\"passing\"}) sum(consul_health_service_status{status!=\"passing\"}) 节点信息 sum(consul_health_node_status) sum(consul_health_node_status{status=\"passing\"}) sum(consul_health_node_status{status!~\"passing\"}) 最终效果\n面板的 JSON文件 根据 Dashboard 的JSON配置文件 导入即可快速使用这个 Dashboard\n","wordCount":"248","inLanguage":"en","datePublished":"2020-05-16T14:47:24Z","dateModified":"2020-05-16T14:47:24Z","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89-grafana-%E9%9D%A2%E6%9D%BF%E7%9B%91%E6%8E%A7-consul/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>使用自定义 Grafana 面板监控 Consul</h1></header><p><small>May 16, 2020&nbsp;· 248 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#使用已有的-dashboard>使用已有的 Dashboard</a></li><li><a href=#自定义监控数据>自定义监控数据</a></li><li><a href=#自定义-dashboard>自定义 Dashboard</a></li><li><a href=#监控服务信息>监控服务信息</a></li></ul></nav></div><section class=blog-content><h1 id=使用自定义-grafana-面板监控-consul>使用自定义 Grafana 面板监控 Consul</h1><p>使用 Prometheus和 Grafana监控 Consul，<a href="https://grafana.com/grafana/dashboards?orderBy=name&direction=asc">Dashboard</a> 中的基本都是Consul 自身的状态，除此之外，还需要一些业务相关的监控，比如当前注册的服务数量，健康和不健康的服务数量，拉取服务请求响应时间等数据</p><h2 id=使用已有的-dashboard>使用已有的 Dashboard</h2><p>如使用 <a href=https://grafana.com/grafana/dashboards/10890>consul server</a> 这个面板，这个面板数据非常齐全，但是在 Prometheus 中添加了任务之后，发现很多数据都没有，如集群中 server的数量 <code>consul_serf_lan_members</code> 这个数据，从 Consul 的 Metrics 中 <a href="http://localhost:8500/v1/agent/metrics?format=prometheus">http://localhost:8500/v1/agent/metrics?format=prometheus</a>拉取也没有相关的数据，是因为Consul并没有提供相应的数据检测</p><p>针对这种问题，可以使用 <a href=https://github.com/prometheus/consul_exporter>consul_exporter</a> 这个项目，该项目会通过 Consul 的API 拉取相应的数据，在整理后通过自己的接口提供相应的统计数据</p><ul><li>通过 Docker 启动</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name exporter -d -p 9107:9107 prom/consul-exporter --consul.server<span style=color:#f92672>=</span>host.docker.internal:8500
</span></span></code></pre></div><ul><li>检查数据</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl localhost:9107/metrics
</span></span></code></pre></div><p>会返回相应的监控数据，这样就可以将 Consul中未提供的数据添加到 Prometheus中了</p><h2 id=自定义监控数据>自定义监控数据</h2><p>如果数据仍然不满足，可以基于<a href=https://github.com/prometheus/consul_exporter>consul_exporter</a> 这个项目进行扩展，添加自定义的统计数据；如现在需要统计集群的响应时间，可以通过统计请求consul的耗时来实现：</p><ol><li>添加自定义的统计项</li></ol><p>在常量中添加一个新的统计项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#a6e22e>responseTime</span> = <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewDesc</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>BuildFQName</span>(<span style=color:#a6e22e>namespace</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;response_time&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Time spend for a request &#34;</span>,
</span></span><span style=display:flex><span>        []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;server_ip&#34;</span>}, <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><ol start=2><li>实现统计方法</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Exporter</span>) <span style=color:#a6e22e>collectResponseTime</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Metric</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Nanosecond</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverIp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Status</span>().<span style=color:#a6e22e>Leader</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>level</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>logger</span>).<span style=color:#a6e22e>Log</span>(<span style=color:#e6db74>&#34;msg&#34;</span>, <span style=color:#e6db74>&#34;Failed to query leader data&#34;</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>costTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Nanosecond</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>start</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>MustNewConstMetric</span>(<span style=color:#a6e22e>responseTime</span>, <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>GaugeValue</span>, float64(<span style=color:#a6e22e>costTime</span>), <span style=color:#e6db74>&#34;leader&#34;</span>, <span style=color:#a6e22e>serverIp</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>将统计项添加到 <code>Collect</code> 和 <code>Describe</code>中</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Exporter</span>) <span style=color:#a6e22e>Describe</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Desc</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>responseTime</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Exporter</span>) <span style=color:#a6e22e>Collect</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Metric</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ok</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>collectResponseTime</span>(<span style=color:#a6e22e>ch</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ok</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样，就会在启动后获取相应的数据，之后在 Prometheus 和 Grafana 中可以看到相应的数据</p><h2 id=自定义-dashboard>自定义 Dashboard</h2><p>自定义的 Dashboard 是通过展示 <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> 查询的结果来实现的</p><p>如在应用中有错误请求的统计，是通过累加错误的请求次数实现的，如统计值 <code>consul_response_time</code></p><ul><li>原始数据：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># HELP consul_response_time Time spend for a request</span>
</span></span><span style=display:flex><span><span style=color:#75715e># TYPE consul_response_time gauge</span>
</span></span><span style=display:flex><span>consul_response_time<span style=color:#f92672>{</span>node<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;leader&#34;</span>,server_ip<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;172.19.0.2:8300&#34;</span><span style=color:#f92672>}</span> 2.238e+06
</span></span></code></pre></div><ul><li>现在要统计所有的错误请求次数，可以在 Prometheus 的查询面板中查询：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>consul_response_time
</span></span></code></pre></div><p><img alt=grafana-custom-dashboard-cosnul-reponse-time-prometheus.png src=https://img.hellowood.dev/picture/grafana-custom-dashboard-cosnul-reponse-time-prometheus.png></p><p>这样，就可以得到相应的错误数据，接下来只需要在Grafana中展示就可以</p><ul><li>添加看板</li></ul><p>添加一个 Dashboard，并添加一个 Panel，在 Panel 的 Metrics 中添加刚才的查询语句</p><p><img alt=grafana-custom-dashboard-cosnul-reponse-time-grafana.png src=https://img.hellowood.dev/picture/grafana-custom-dashboard-cosnul-reponse-time-grafana.png></p><p>执行查询后，会看到有图表生成，变量的名称通过 Legend 字段指定，如这里是 <code>{instance="host.docker.internal:9107", job="consul-exporter", node="leader", server_ip="172.19.0.2:8300"}</code>，需要显示IP，即 <code>server_ip</code> 的值，可以设置 Legend，这样会显示正确的名称</p><p>其他的显示单位，显示效果等以及面板的名称可以通过旁边的设置选项进行配置</p><h2 id=监控服务信息>监控服务信息</h2><p>可以根据 Consul 和 consul_exporter 对服务状态进行监控，只需要根据不同的数据进行聚合配置就可以实现</p><ul><li>节点信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_node_status)
</span></span></code></pre></div><ul><li>健康节点信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_node_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><ul><li>不健康节点信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_node_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><ul><li>服务信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>count</span>(<span style=color:#66d9ef>sum</span>(consul_health_service_status) <span style=color:#66d9ef>by</span> (service_name))
</span></span></code></pre></div><ul><li>实例数量</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status)
</span></span></code></pre></div><ul><li>健康实例数量</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><ul><li>不健康实例数量</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><ul><li>响应延时</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>consul_response_time<span style=color:#f92672>/</span><span style=color:#ae81ff>1000000</span>
</span></span></code></pre></div><ul><li>服务状态</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>) <span style=color:#66d9ef>by</span> (service_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status) <span style=color:#66d9ef>by</span> (service_name)
</span></span></code></pre></div><ul><li>服务注册信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_service_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>!=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><ul><li>节点信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_node_status)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_node_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>sum</span>(consul_health_node_status<span style=color:#960050;background-color:#1e0010>{</span>status<span style=color:#f92672>!~</span><span style=color:#e6db74>&#34;passing&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><p>最终效果</p><p><img alt=grafana-custom-dashboard-cosnul-panel.png src=https://img.hellowood.dev/picture/grafana-custom-dashboard-cosnul-panel.png></p><ul><li>面板的 JSON文件</li></ul><p>根据 <a href=https://img.hellowood.dev/picture/custom-consul-grafana-dashboard.json>Dashboard 的JSON配置文件</a> 导入即可快速使用这个 Dashboard</p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/prometheus-%E4%BD%BF%E7%94%A8-consul-%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0-spring-boot-%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>Prometheus 使用 Consul 自动发现 Spring Boot 服务并拉取数据</span></a>
<a class=next href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-prometheus-%E5%92%8C-grafana-%E7%9B%91%E6%8E%A7-springboot-%E5%BA%94%E7%94%A8/><span>使用 Prometheus 和 Grafana 监控 SpringBoot 应用</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>