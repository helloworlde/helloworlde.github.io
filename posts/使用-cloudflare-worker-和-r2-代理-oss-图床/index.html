<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 Cloudflare Worker 和 R2 代理 OSS 图床</title>
<meta charset=utf-8><meta name=description content="Ladder@使用 Cloudflare Worker 和 R2 代理 OSS 图床 因为笔记可能会在多个平台发布，因此之前使用阿里云的 OSS 作为图片存储，直接将 OSS 的地址暴露到公网进行访问；但是随着流量逐渐增加，每月产生的流量费用也水高船涨，更重要的是 OSS 只支持 Refer 限制，并不能保证安全，在看到有人分享被刷 CDN 产生巨额费用后觉得必须要重视安全问题。
赛博菩萨 Cloudflare 提供了 R2 作为存储，提供了 5GB 免费的容量，对于个人完全够用了；同时 Worker 支持 CDN 缓存及就近访问，因此使用 Worker 代理 R2 访问完全能满足我的需求
考虑到有多个平台都是用了 OSS 作为链接，需要逐步迁移；因此，使用 Workers 优先从 R2 读取，如果 R2 没有则从 OSS 获取，并存储到 R2 中
安装 wrangler 在本地使用 wrangler 开发 Worker
安装 wrangler 参考 Install/Update Wrangler 进行安装
创建 R2 在 Cloudflare 管理平台创建 R2，或者通过 wrangler 进行创建，参考 Create buckets
wrangler r2 bucket create picture 创建 Worker 创建项目 npm create cloudflare@latest 将 R2 绑定到 Worker 修改 wrangler."><meta name=author content="HelloWood"><link rel=canonical href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-worker-%E5%92%8C-r2-%E4%BB%A3%E7%90%86-oss-%E5%9B%BE%E5%BA%8A/><meta name=google-site-verification content="G-3MSGPYTHPZ"><link rel=alternate type=application/rss+xml href=https://blog.hellowood.dev//index.xml title=HelloWood><script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGPYTHPZ"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3MSGPYTHPZ")}</script><script async defer data-website-id=7a9034de-0ce7-4756-942a-829e6cd22301 src=https://umami.hellowood.dev/script.js></script><script defer data-cf-beacon='{"token": "b2e481d136dc428c8c96c8673e2a04cf"}' src=https://static.cloudflareinsights.com/beacon.min.js></script><meta property="og:url" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-worker-%E5%92%8C-r2-%E4%BB%A3%E7%90%86-oss-%E5%9B%BE%E5%BA%8A/"><meta property="og:site_name" content="HelloWood"><meta property="og:title" content="使用 Cloudflare Worker 和 R2 代理 OSS 图床"><meta property="og:description" content="使用 Cloudflare Worker 和 R2 代理 OSS 图床 因为笔记可能会在多个平台发布，因此之前使用阿里云的 OSS 作为图片存储，直接将 OSS 的地址暴露到公网进行访问；但是随着流量逐渐增加，每月产生的流量费用也水高船涨，更重要的是 OSS 只支持 Refer 限制，并不能保证安全，在看到有人分享被刷 CDN 产生巨额费用后觉得必须要重视安全问题。
赛博菩萨 Cloudflare 提供了 R2 作为存储，提供了 5GB 免费的容量，对于个人完全够用了；同时 Worker 支持 CDN 缓存及就近访问，因此使用 Worker 代理 R2 访问完全能满足我的需求
考虑到有多个平台都是用了 OSS 作为链接，需要逐步迁移；因此，使用 Workers 优先从 R2 读取，如果 R2 没有则从 OSS 获取，并存储到 R2 中
安装 wrangler 在本地使用 wrangler 开发 Worker
安装 wrangler 参考 Install/Update Wrangler 进行安装
创建 R2 在 Cloudflare 管理平台创建 R2，或者通过 wrangler 进行创建，参考 Create buckets
wrangler r2 bucket create picture 创建 Worker 创建项目 npm create cloudflare@latest 将 R2 绑定到 Worker 修改 wrangler."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-23T19:14:05+08:00"><meta property="article:modified_time" content="2023-12-23T19:14:05+08:00"><meta property="article:tag" content="Cloudflare"><meta property="article:tag" content="HomeLab"><meta property="og:see_also" content="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Cloudflare Worker 和 R2 代理 OSS 图床"><meta name=twitter:description content="使用 Cloudflare Worker 和 R2 代理 OSS 图床 因为笔记可能会在多个平台发布，因此之前使用阿里云的 OSS 作为图片存储，直接将 OSS 的地址暴露到公网进行访问；但是随着流量逐渐增加，每月产生的流量费用也水高船涨，更重要的是 OSS 只支持 Refer 限制，并不能保证安全，在看到有人分享被刷 CDN 产生巨额费用后觉得必须要重视安全问题。
赛博菩萨 Cloudflare 提供了 R2 作为存储，提供了 5GB 免费的容量，对于个人完全够用了；同时 Worker 支持 CDN 缓存及就近访问，因此使用 Worker 代理 R2 访问完全能满足我的需求
考虑到有多个平台都是用了 OSS 作为链接，需要逐步迁移；因此，使用 Workers 优先从 R2 读取，如果 R2 没有则从 OSS 获取，并存储到 R2 中
安装 wrangler 在本地使用 wrangler 开发 Worker
安装 wrangler 参考 Install/Update Wrangler 进行安装
创建 R2 在 Cloudflare 管理平台创建 R2，或者通过 wrangler 进行创建，参考 Create buckets
wrangler r2 bucket create picture 创建 Worker 创建项目 npm create cloudflare@latest 将 R2 绑定到 Worker 修改 wrangler."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.hellowood.dev/posts/"},{"@type":"ListItem","position":2,"name":"使用 Cloudflare Worker 和 R2 代理 OSS 图床","item":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-worker-%E5%92%8C-r2-%E4%BB%A3%E7%90%86-oss-%E5%9B%BE%E5%BA%8A/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 Cloudflare Worker 和 R2 代理 OSS 图床","name":"使用 Cloudflare Worker 和 R2 代理 OSS 图床","description":"使用 Cloudflare Worker 和 R2 代理 OSS 图床 因为笔记可能会在多个平台发布，因此之前使用阿里云的 OSS 作为图片存储，直接将 OSS 的地址暴露到公网进行访问；但是随着流量逐渐增加，每月产生的流量费用也水高船涨，更重要的是 OSS 只支持 Refer 限制，并不能保证安全，在看到有人分享被刷 CDN 产生巨额费用后觉得必须要重视安全问题。\n赛博菩萨 Cloudflare 提供了 R2 作为存储，提供了 5GB 免费的容量，对于个人完全够用了；同时 Worker 支持 CDN 缓存及就近访问，因此使用 Worker 代理 R2 访问完全能满足我的需求\n考虑到有多个平台都是用了 OSS 作为链接，需要逐步迁移；因此，使用 Workers 优先从 R2 读取，如果 R2 没有则从 OSS 获取，并存储到 R2 中\n安装 wrangler 在本地使用 wrangler 开发 Worker\n安装 wrangler 参考 Install/Update Wrangler 进行安装\n创建 R2 在 Cloudflare 管理平台创建 R2，或者通过 wrangler 进行创建，参考 Create buckets\nwrangler r2 bucket create picture 创建 Worker 创建项目 npm create cloudflare@latest 将 R2 绑定到 Worker 修改 wrangler.","keywords":["Cloudflare","HomeLab"],"articleBody":"使用 Cloudflare Worker 和 R2 代理 OSS 图床 因为笔记可能会在多个平台发布，因此之前使用阿里云的 OSS 作为图片存储，直接将 OSS 的地址暴露到公网进行访问；但是随着流量逐渐增加，每月产生的流量费用也水高船涨，更重要的是 OSS 只支持 Refer 限制，并不能保证安全，在看到有人分享被刷 CDN 产生巨额费用后觉得必须要重视安全问题。\n赛博菩萨 Cloudflare 提供了 R2 作为存储，提供了 5GB 免费的容量，对于个人完全够用了；同时 Worker 支持 CDN 缓存及就近访问，因此使用 Worker 代理 R2 访问完全能满足我的需求\n考虑到有多个平台都是用了 OSS 作为链接，需要逐步迁移；因此，使用 Workers 优先从 R2 读取，如果 R2 没有则从 OSS 获取，并存储到 R2 中\n安装 wrangler 在本地使用 wrangler 开发 Worker\n安装 wrangler 参考 Install/Update Wrangler 进行安装\n创建 R2 在 Cloudflare 管理平台创建 R2，或者通过 wrangler 进行创建，参考 Create buckets\nwrangler r2 bucket create picture 创建 Worker 创建项目 npm create cloudflare@latest 将 R2 绑定到 Worker 修改 wrangler.toml 配置文件，将 R2 绑定到当前 worker\n[[r2_buckets]] binding = \"PICTURE\" bucket_name = \"picture\" 添加 OSS 地址到环境变量 为了配置方便和安全，将 OSS 的地址添加到环境变量中，修改 wrangler.toml 配置文件：\n[vars] REMOTE_DATA_ADDRESS=\"https://xxx.com\" 实现代码逻辑 修改 src/index.js 文件，实现代理逻辑： 解析访问路径，检查是否在 R2 中存在文件，如果存在则从 R2 获取，如果不存在则从 OSS 获取并同步到 R2 中\nexport default { async fetch(request, env) { const url = new URL(request.url); const resoureName = url.pathname; console.log(\"ResourceName: \", resoureName); if (resoureName == undefined || resoureName == \"\" || resoureName == \"/\") { const html = `\u003c!DOCTYPE html\u003eHello World\n`; return new Response(html, { headers: { \"content-type\": \"text/html;charset=UTF-8\", }, }); } switch (request.method) { case 'GET': let object = await env.PICTURE.get(resoureName); if (object === null) { const imageUrl = env.REMOTE_DATA_ADDRESS + \"/\" + resoureName; console.log(\"Path \", resoureName, \" 不存在，从 OSS 拉取\"); const imageResponse = await fetch(imageUrl); if (imageResponse.status === 200) { console.log(\"Path \", resoureName, \" 拉取成功，保存到 R2\"); const imageData = await imageResponse.arrayBuffer(); await env.BLOG_PICTURE.put(resoureName, imageData); object = await env.BLOG_PICTURE.get(resoureName); } } if (object === null) { return new Response(undefined, { status: 404 }) } const headers = new Headers(); object.writeHttpMetadata(headers); headers.set('etag', object.httpEtag); return new Response(object.body, { headers, }); default: return new Response('Method Not Allowed', { status: 405, headers: { Allow: 'GET', }, }); } }, }; 部署 Worker 在本地使用 wrangler 进行部署\nnpx wrangler deploy 部署完成后访问文件的地址，返回的数据正常，同时在 R2 检查发现文件已经同步到 R2了，再次访问发现是从 R2 获取的，说明代理成功\n","wordCount":"288","inLanguage":"en","datePublished":"2023-12-23T19:14:05+08:00","dateModified":"2023-12-23T19:14:05+08:00","author":{"@type":"Person","name":"HelloWood"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-cloudflare-worker-%E5%92%8C-r2-%E4%BB%A3%E7%90%86-oss-%E5%9B%BE%E5%BA%8A/"},"publisher":{"@type":"Organization","name":"HelloWood","logo":{"@type":"ImageObject","url":"https://blog.hellowood.dev/favicon.ico"}}}</script><link rel=icon href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><meta name=google-adsense-account content="ca-pub-3401351766168985"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","jtbhx98g62")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3401351766168985" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand data-umami-event=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Blog href=/posts>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Tags href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Archive href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link data-umami-event=Dashboard href=https://umami.hellowood.dev/share/lab/Blog>Dashboard</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link data-umami-event=navigation-social href=https://github.com/helloworlde><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button data-umami-event=toggle-theme aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>使用 Cloudflare Worker 和 R2 代理 OSS 图床</h1></header><p><small>December 23, 2023&nbsp;· 288 words&nbsp;· 2 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#安装-wrangler>安装 wrangler</a></li><li><a href=#创建-r2>创建 R2</a></li><li><a href=#创建-worker>创建 Worker</a></li><li><a href=#部署-worker>部署 Worker</a></li></ul></nav></div><section class=blog-content><h1 id=使用-cloudflare-worker-和-r2-代理-oss-图床>使用 Cloudflare Worker 和 R2 代理 OSS 图床</h1><p>因为笔记可能会在多个平台发布，因此之前使用阿里云的 OSS 作为图片存储，直接将 OSS 的地址暴露到公网进行访问；但是随着流量逐渐增加，每月产生的流量费用也水高船涨，更重要的是 OSS 只支持 Refer 限制，并不能保证安全，在看到有人分享被刷 CDN 产生巨额费用后觉得必须要重视安全问题。</p><p>赛博菩萨 Cloudflare 提供了 R2 作为存储，提供了 5GB 免费的容量，对于个人完全够用了；同时 Worker 支持 CDN 缓存及就近访问，因此使用 Worker 代理 R2 访问完全能满足我的需求</p><p>考虑到有多个平台都是用了 OSS 作为链接，需要逐步迁移；因此，使用 Workers 优先从 R2 读取，如果 R2 没有则从 OSS 获取，并存储到 R2 中</p><h2 id=安装-wrangler>安装 wrangler</h2><p>在本地使用 wrangler 开发 Worker</p><ul><li>安装 wrangler</li></ul><p>参考 <a href=https://developers.cloudflare.com/workers/wrangler/install-and-update/>Install/Update Wrangler</a> 进行安装</p><h2 id=创建-r2>创建 R2</h2><p>在 Cloudflare 管理平台创建 R2，或者通过 wrangler 进行创建，参考 <a href=https://developers.cloudflare.com/r2/buckets/create-buckets/>Create buckets</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wrangler r2 bucket create picture
</span></span></code></pre></div><h2 id=创建-worker>创建 Worker</h2><ul><li>创建项目</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm create cloudflare@latest
</span></span></code></pre></div><ul><li>将 R2 绑定到 Worker</li></ul><p>修改 wrangler.toml 配置文件，将 R2 绑定到当前 worker</p><pre tabindex=0><code>[[r2_buckets]]
binding = &#34;PICTURE&#34;
bucket_name = &#34;picture&#34;
</code></pre><ul><li>添加 OSS 地址到环境变量</li></ul><p>为了配置方便和安全，将 OSS 的地址添加到环境变量中，修改 wrangler.toml 配置文件：</p><pre tabindex=0><code>[vars]
REMOTE_DATA_ADDRESS=&#34;https://xxx.com&#34;
</code></pre><ul><li>实现代码逻辑</li></ul><p>修改 <code>src/index.js</code> 文件，实现代理逻辑：
解析访问路径，检查是否在 R2 中存在文件，如果存在则从 R2 获取，如果不存在则从 OSS 获取并同步到 R2 中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>env</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URL</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>url</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resoureName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;ResourceName: &#34;</span>, <span style=color:#a6e22e>resoureName</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>resoureName</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>resoureName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>resoureName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;/&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`&lt;!DOCTYPE html&gt;&lt;body&gt;&lt;p&gt;Hello World&lt;/p&gt;&lt;/body&gt;`</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#a6e22e>html</span>, {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>					<span style=color:#e6db74>&#34;content-type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text/html;charset=UTF-8&#34;</span>,
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>			});
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>method</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;GET&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>object</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PICTURE</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>resoureName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>object</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imageUrl</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>REMOTE_DATA_ADDRESS</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>resoureName</span>;
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Path &#34;</span>, <span style=color:#a6e22e>resoureName</span>, <span style=color:#e6db74>&#34; 不存在，从 OSS 拉取&#34;</span>);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imageResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>imageUrl</span>);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>imageResponse</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Path &#34;</span>, <span style=color:#a6e22e>resoureName</span>, <span style=color:#e6db74>&#34; 拉取成功，保存到 R2&#34;</span>);
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imageData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>imageResponse</span>.<span style=color:#a6e22e>arrayBuffer</span>();
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BLOG_PICTURE</span>.<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>resoureName</span>, <span style=color:#a6e22e>imageData</span>);
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>object</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BLOG_PICTURE</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>resoureName</span>);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>object</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#66d9ef>undefined</span>, { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>404</span> })
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>headers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Headers</span>();
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>writeHttpMetadata</span>(<span style=color:#a6e22e>headers</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;etag&#39;</span>, <span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>httpEtag</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#a6e22e>object</span>.<span style=color:#a6e22e>body</span>, {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>headers</span>,
</span></span><span style=display:flex><span>				});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#e6db74>&#39;Method Not Allowed&#39;</span>, {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>405</span>,
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>Allow</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>					},
</span></span><span style=display:flex><span>				});
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=部署-worker>部署 Worker</h2><p>在本地使用 wrangler 进行部署</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npx wrangler deploy
</span></span></code></pre></div><p>部署完成后访问文件的地址，返回的数据正常，同时在 R2 检查发现文件已经同步到 R2了，再次访问发现是从 R2 获取的，说明代理成功</p><p><img alt=homelab-image-proxy-from-cloudflare-analysis.png src=https://img.hellowood.dev/picture/homelab-image-proxy-from-cloudflare-analysis.png></p></section><div class=paginator><a class=prev href=https://blog.hellowood.dev/posts/%E5%9C%A8%E9%BB%91%E7%BE%A4%E6%99%96%E4%BD%BF%E7%94%A8-docker-%E9%83%A8%E7%BD%B2-proxmox-backup-server/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>在黑群晖使用 Docker 部署 Proxmox Backup Server</span></a>
<a class=next href=https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E9%98%BF%E5%B0%94%E5%8D%A1%E7%89%B9%E7%8C%AB%E6%A3%92%E6%9B%BF%E6%8D%A2%E5%8C%97%E4%BA%AC%E7%A7%BB%E5%8A%A8-gpon-%E5%85%89%E7%8C%AB/><span>使用阿尔卡特猫棒替换北京移动 GPON 光猫</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=related-resources><h3>Related Resources</h3><nav><ul><li><a href=/posts/%E4%BD%BF%E7%94%A8cloudflare-tunnels%E9%80%9A%E8%BF%87web-ssh%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/>使用 Cloudflare Tunnels 通过 Web SSH 访问服务器</a></li></ul></nav></div></article></div><footer class=footer><p>&copy; 2024 <a href=https://blog.hellowood.dev/>HelloWood</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank data-umami-event=to-hugo>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank data-umami-event=to-ladder>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g data-umami-event=top-link><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>