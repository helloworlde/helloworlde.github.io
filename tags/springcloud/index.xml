<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>SpringCloud on HelloWood</title><link>https://blog.hellowood.dev/tags/springcloud/</link><description>Recent content in SpringCloud on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Sat, 06 Sep 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/springcloud/index.xml" rel="self" type="application/rss+xml"/><item><title>Spring Cloud 使用 Consul 作为配置中心</title><link>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-consul-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</link><pubDate>Sun, 20 Sep 2020 22:28:50 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-consul-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</guid><description>&lt;h2 id="加载配置"&gt;加载配置&lt;/h2&gt;
&lt;p&gt;加载配置是通过 &lt;code&gt;ConsulPropertySourceLocator&lt;/code&gt; 来实现的，该类是 &lt;code&gt;PropertySourceLocator&lt;/code&gt;接口的实现类&lt;/p&gt;
&lt;h3 id="bean-初始化"&gt;Bean 初始化&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulPropertySourceLocator&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;consulPropertySourceLocator&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;ConsulConfigProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulConfigProperties&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulPropertySourceLocator&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;consul&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;consulConfigProperties&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="获取配置"&gt;获取配置&lt;/h3&gt;
&lt;p&gt;获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ConsulPropertySourceLocator#locate&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;获取配置时，根据应用名称，路径，环境及配置类型拼接相应的路径，然后调用 Consul 获取 KV 值的接口，获取相应的配置，根据类型解析后放入环境中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Retryable&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;interceptor&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#34;consulRetryInterceptor&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;PropertySource&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;locate&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;Environment&lt;/span&gt; &lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;environment&lt;/span&gt; &lt;span style="color:#c678dd"&gt;instanceof&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt; &lt;span style="color:#c1abea"&gt;env&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt;) &lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;appName&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getName&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;appName&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;==&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;appName&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;env&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getProperty&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;spring.application.name&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;List&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;String&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;profiles&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;Arrays&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;asList&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;env&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getActiveProfiles&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;prefix&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getPrefix&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;List&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;String&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ArrayList&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&amp;gt;&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// 不是文件类型的时候，后缀为 /，否则就是配置文件的后缀&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getFormat&lt;/span&gt;() &lt;span style="color:#c7bf54"&gt;!=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;FILES&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;add&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			} &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;add&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;.yml&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;add&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;.yaml&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;add&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;.properties&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// 路径&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;defaultContext&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;getContext&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;prefix&lt;/span&gt;, &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getDefaultContext&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;for&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt; : &lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contexts&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;add&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;defaultContext&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// 追加环境及文件类型&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;for&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt; : &lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;addProfiles&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contexts&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;defaultContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;profiles&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;baseContext&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;getContext&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;prefix&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;appName&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// 应用名称前缀&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;for&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt; : &lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contexts&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;add&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;baseContext&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;for&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt; : &lt;span style="color:#c1abea"&gt;suffixes&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;addProfiles&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contexts&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;baseContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;profiles&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;suffix&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;Collections&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;reverse&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contexts&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;CompositePropertySource&lt;/span&gt; &lt;span style="color:#c1abea"&gt;composite&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;CompositePropertySource&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;consul&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;for&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;propertySourceContext&lt;/span&gt; : &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contexts&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c678dd"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					&lt;span style="color:#c1abea"&gt;ConsulPropertySource&lt;/span&gt; &lt;span style="color:#c1abea"&gt;propertySource&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getFormat&lt;/span&gt;() &lt;span style="color:#c7bf54"&gt;==&lt;/span&gt; &lt;span style="color:#c1abea"&gt;FILES&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#8a93a5;font-style:italic"&gt;// 获取值&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;Response&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;GetValue&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;response&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;consul&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getKVValue&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;propertySourceContext&lt;/span&gt;, &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getAclToken&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#8a93a5;font-style:italic"&gt;// 添加当前索引&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;addIndex&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;propertySourceContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;response&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getConsulIndex&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#8a93a5;font-style:italic"&gt;// 如果值不为空，则更新值并初始化&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;response&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getValue&lt;/span&gt;() &lt;span style="color:#c7bf54"&gt;!=&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;							&lt;span style="color:#c1abea"&gt;ConsulFilesPropertySource&lt;/span&gt; &lt;span style="color:#c1abea"&gt;filesPropertySource&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulFilesPropertySource&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;propertySourceContext&lt;/span&gt;, &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;consul&lt;/span&gt;, &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;							&lt;span style="color:#8a93a5;font-style:italic"&gt;// 解析配置内容&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;							&lt;span style="color:#c1abea"&gt;filesPropertySource&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;init&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;response&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getValue&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;							&lt;span style="color:#c1abea"&gt;propertySource&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;filesPropertySource&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					} &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;propertySource&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;create&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;propertySourceContext&lt;/span&gt;, &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;contextIndex&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;propertySource&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;!=&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;composite&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;addPropertySource&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;propertySource&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				} &lt;span style="color:#c678dd"&gt;catch&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;Exception&lt;/span&gt; &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;isFailFast&lt;/span&gt;()) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;log&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;error&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;Fail fast is set and there was an error reading configuration from consul.&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;ReflectionUtils&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;rethrowRuntimeException&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;e&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					} &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;						&lt;span style="color:#c1abea"&gt;log&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;warn&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;Unable to load consul config from &amp;#34;&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;propertySourceContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c1abea"&gt;composite&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="监听配置"&gt;监听配置&lt;/h2&gt;
&lt;p&gt;Consul 监听配置是通过定时任务实现的，&lt;/p&gt;</description></item><item><title>Spring Cloud 使用 Kubernetes 作为配置中心</title><link>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/</link><pubDate>Sun, 20 Sep 2020 22:28:15 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-1/</guid><description>&lt;p&gt;Spring Cloud 支持使用 Kubernetes 作为配置中心，通过 ConfigMap 或 Secret，将配置添加到应用中&lt;/p&gt;
&lt;h2 id="加载配置"&gt;加载配置&lt;/h2&gt;
&lt;p&gt;加载配置是通过 PropertySourceLocator 来实现的，ConfigMap 使用 &lt;code&gt;ConfigMapPropertySourceLocator&lt;/code&gt; 加载，Secret 使用 &lt;code&gt;SecretsPropertySourceLocator&lt;/code&gt;加载&lt;/p&gt;
&lt;h3 id="bean-初始化"&gt;Bean 初始化&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#e5c07b"&gt;@ConditionalOnProperty&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;name&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#34;spring.cloud.kubernetes.config.enabled&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;matchIfMissing&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConfigMapPropertySourceLocator&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;configMapPropertySourceLocator&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;ConfigMapConfigProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConfigMapPropertySourceLocator&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;client&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#e5c07b"&gt;@ConditionalOnProperty&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;name&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#34;spring.cloud.kubernetes.secrets.enabled&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;matchIfMissing&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;SecretsPropertySourceLocator&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;secretsPropertySourceLocator&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;SecretsConfigProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;SecretsPropertySourceLocator&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;client&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="获取配置"&gt;获取配置&lt;/h3&gt;
&lt;p&gt;获取配置是通过 PropertySourceLocator#locate 方法实现的，最终将获取到属性添加到环境中&lt;/p&gt;
&lt;h4 id="configmap"&gt;ConfigMap&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;ConfigMapPropertySourceLocator#locate&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;PropertySource&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;locate&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;Environment&lt;/span&gt; &lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;environment&lt;/span&gt; &lt;span style="color:#c678dd"&gt;instanceof&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt; &lt;span style="color:#c1abea"&gt;env&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt;) &lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;List&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;ConfigMapConfigProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;NormalizedSource&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;sources&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;determineSources&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;CompositePropertySource&lt;/span&gt; &lt;span style="color:#c1abea"&gt;composite&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;CompositePropertySource&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;composite-configmap&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c678dd"&gt;this&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;properties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;isEnableApi&lt;/span&gt;()) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;sources&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;forEach&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;s&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;-&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;composite&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;addFirstPropertySource&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;					&lt;span style="color:#c1abea"&gt;getMapPropertySourceForSingleConfigMap&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;env&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;s&lt;/span&gt;)));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// 将配置添加的容器环境中&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;addPropertySourcesFromPaths&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;composite&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c1abea"&gt;composite&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;真正向 Kubernetes 发起请求的是通过调用 &lt;code&gt;getMapPropertySourceForSingleConfigMap&lt;/code&gt; 方法，创建&lt;code&gt;ConfigMapPropertySource&lt;/code&gt;实例的时候，会根据 &lt;code&gt;getData&lt;/code&gt; 方法，从 ConfigMap 获取属性解析并添加到环境中&lt;/p&gt;</description></item><item><title>Spring Cloud Consul 服务注册和发现</title><link>https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/</link><pubDate>Sun, 20 Sep 2020 22:27:16 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-consul-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/</guid><description>&lt;p&gt;Spring Cloud Kubernetes 使用，可以通过引入 &lt;code&gt;org.springframework.cloud:spring-cloud-starter-consul-discovery&lt;/code&gt;，这个 starter 依赖于 &lt;code&gt;org.springframework.cloud:spring-cloud-consul-core&lt;/code&gt; 和 &lt;code&gt;org.springframework.cloud:spring-cloud-consul-discovery&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="consul-的核心概念"&gt;Consul 的核心概念&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;server
集群的核心节点，用于和 agent 通讯，保存服务的信息&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;agent
集群节点的守护进程，用于服务注册等行为，但不保存数据&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;catalog
集群服务通信的接口&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="初始化-kubernetes-client"&gt;初始化 Kubernetes Client&lt;/h2&gt;
&lt;h3 id="初始化-consul-依赖"&gt;初始化 Consul 依赖&lt;/h3&gt;
&lt;p&gt;相关 Consul 核心依赖的初始化是通过 &lt;code&gt;org.springframework.cloud.consul.ConsulAutoConfiguration&lt;/code&gt;实现的&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;初始化 ConsulClient&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@ConditionalOnMissingBean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulClient&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;consulClient&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;ConsulProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;final&lt;/span&gt; &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;agentPort&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getPort&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;final&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;agentHost&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;!&lt;/span&gt;&lt;span style="color:#c1abea"&gt;StringUtils&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;isEmpty&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getScheme&lt;/span&gt;())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c7bf54"&gt;?&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getScheme&lt;/span&gt;() &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#34;://&amp;#34;&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getHost&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			: &lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getHost&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getTls&lt;/span&gt;() &lt;span style="color:#c7bf54"&gt;!=&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;ConsulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;TLSConfig&lt;/span&gt; &lt;span style="color:#c1abea"&gt;tls&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getTls&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;TLSConfig&lt;/span&gt; &lt;span style="color:#c1abea"&gt;tlsConfig&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TLSConfig&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;tls&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getKeyStoreInstanceType&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;tls&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getCertificatePath&lt;/span&gt;(), &lt;span style="color:#c1abea"&gt;tls&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getCertificatePassword&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;tls&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getKeyStorePath&lt;/span&gt;(), &lt;span style="color:#c1abea"&gt;tls&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getKeyStorePassword&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulClient&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;agentHost&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;agentPort&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;tlsConfig&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulClient&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;agentHost&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;agentPort&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="服务注册"&gt;服务注册&lt;/h2&gt;
&lt;h3 id="初始化-bean"&gt;初始化 Bean&lt;/h3&gt;
&lt;p&gt;相关 Bean 的初始化是在 &lt;code&gt;org.springframework.cloud.consul.serviceregistry.ConsulAutoServiceRegistrationAutoConfiguration&lt;/code&gt; 中完成的&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 自动注册&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@ConditionalOnMissingBean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulAutoServiceRegistration&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;consulAutoServiceRegistration&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ConsulServiceRegistry&lt;/span&gt; &lt;span style="color:#c1abea"&gt;registry&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;AutoServiceRegistrationProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;autoServiceRegistrationProperties&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ConsulDiscoveryProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ConsulAutoRegistration&lt;/span&gt; &lt;span style="color:#c1abea"&gt;consulRegistration&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulAutoServiceRegistration&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;registry&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;autoServiceRegistrationProperties&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;consulRegistration&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#8a93a5;font-style:italic"&gt;// 启动事件监听器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulAutoServiceRegistrationListener&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;consulAutoServiceRegistrationListener&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ConsulAutoServiceRegistration&lt;/span&gt; &lt;span style="color:#c1abea"&gt;registration&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulAutoServiceRegistrationListener&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;registration&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Bean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@ConditionalOnMissingBean&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulAutoRegistration&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;consulRegistration&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;AutoServiceRegistrationProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;autoServiceRegistrationProperties&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ConsulDiscoveryProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;ApplicationContext&lt;/span&gt; &lt;span style="color:#c1abea"&gt;applicationContext&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ObjectProvider&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;List&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;ConsulRegistrationCustomizer&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;registrationCustomizers&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;ObjectProvider&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;List&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;ConsulManagementRegistrationCustomizer&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;managementRegistrationCustomizers&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c1abea"&gt;HeartbeatProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;heartbeatProperties&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConsulAutoRegistration&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;registration&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;autoServiceRegistrationProperties&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;properties&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;applicationContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;registrationCustomizers&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getIfAvailable&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c1abea"&gt;managementRegistrationCustomizers&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getIfAvailable&lt;/span&gt;(), &lt;span style="color:#c1abea"&gt;heartbeatProperties&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="注册流程"&gt;注册流程&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;当监听到 &lt;code&gt;WebServerInitializedEvent&lt;/code&gt; 事件时触发注册&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;ConsulAutoServiceRegistrationListener&lt;/code&gt; 类实现了 &lt;code&gt;SmartApplicationListener&lt;/code&gt;接口&lt;/p&gt;</description></item><item><title>Spring Cloud Kubernetes 服务注册和发现</title><link>https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/</link><pubDate>Sun, 20 Sep 2020 22:26:03 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-kubernetes-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/</guid><description>&lt;p&gt;Spring Cloud Kubernetes 使用，可以通过引入 &lt;code&gt;org.springframework.cloud:spring-cloud-starter-kubernetes&lt;/code&gt;，这个 starter 依赖于 &lt;code&gt;org.springframework.cloud:spring-cloud-kubernetes-core&lt;/code&gt; 和 &lt;code&gt;org.springframework.cloud:spring-cloud-kubernetes-discovery&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="初始化-kubernetes-client"&gt;初始化 Kubernetes Client&lt;/h2&gt;
&lt;h3 id="初始化环境配置"&gt;初始化环境配置&lt;/h3&gt;
&lt;p&gt;环境初始化是通过 &lt;code&gt;org.springframework.cloud.kubernetes.profile.KubernetesProfileEnvironmentPostProcessor&lt;/code&gt;类实现的，当环境初始化完成时，会检查 Kubernetes 是否开启，如果开启则会判断 Profile 是否注入到容器中，没有时将会注入 Profile 到容器中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#e5c07b"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;postProcessEnvironment&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;ConfigurableEnvironment&lt;/span&gt; &lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	 &lt;span style="color:#c1abea"&gt;SpringApplication&lt;/span&gt; &lt;span style="color:#c1abea"&gt;application&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#8a93a5;font-style:italic"&gt;// 判断是否启用 kubernetes，默认为 true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;final&lt;/span&gt; &lt;span style="color:#ef8383"&gt;boolean&lt;/span&gt; &lt;span style="color:#c1abea"&gt;kubernetesEnabled&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getProperty&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;spring.cloud.kubernetes.enabled&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;Boolean&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;class&lt;/span&gt;, &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c7bf54"&gt;!&lt;/span&gt;&lt;span style="color:#c1abea"&gt;kubernetesEnabled&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;return&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#8a93a5;font-style:italic"&gt;// 如果在 Kubernetes 中&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;isInsideKubernetes&lt;/span&gt;()) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// 判断是否存在 Kubernetes 环境的配置，如果不存在，则添加到环境变量中&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;hasKubernetesProfile&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;)) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#8a93a5;font-style:italic"&gt;// ...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			} &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;				&lt;span style="color:#c1abea"&gt;environment&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;addActiveProfile&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;KUBERNETES_PROFILE&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		} &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;			&lt;span style="color:#8a93a5;font-style:italic"&gt;// ...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="初始化-kubernetes-依赖"&gt;初始化 Kubernetes 依赖&lt;/h3&gt;
&lt;p&gt;相关 Kubernetes 核心依赖的初始化是通过 &lt;code&gt;org.springframework.cloud.kubernetes.KubernetesAutoConfiguration&lt;/code&gt;实现的&lt;/p&gt;</description></item><item><title>Spring Cloud Gateway 使用 Kubernetes 作为服务发现</title><link>https://blog.hellowood.dev/posts/spring-cloud-gateway-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</link><pubDate>Sun, 20 Sep 2020 22:25:04 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-gateway-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</guid><description>&lt;p&gt;Spring Cloud Gateway 作为网关，通过用于执行一些通用逻辑后做请求转发，后端可能涉及到多个服务，每个服务又有多个实例，调用服务实例就需要动态的更新，可以通过注册中心来实现，如果部署在K8S集群中，可以直接使用K8S实现服务发现&lt;/p&gt;
&lt;h2 id="应用"&gt;应用&lt;/h2&gt;
&lt;h3 id="gateway"&gt;Gateway&lt;/h3&gt;
&lt;h4 id="添加依赖"&gt;添加依赖&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;build.gradle&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-groovy" data-lang="groovy"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;plugins&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;id&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.boot&amp;#39;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;version&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;2.2.6.RELEASE&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;id&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;io.spring.dependency-management&amp;#39;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;version&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;1.0.9.RELEASE&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;id&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;java&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;ext&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;set&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;&amp;#39;springCloudVersion&amp;#39;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;,&lt;/span&gt; &lt;span style="color:#63c381"&gt;&amp;#34;Hoxton.SR1&amp;#34;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;set&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;&amp;#39;springKubernetesVersion&amp;#39;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;,&lt;/span&gt; &lt;span style="color:#63c381"&gt;&amp;#34;1.1.2.RELEASE&amp;#34;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;dependencies&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-gateway&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-kubernetes-discovery&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.boot:spring-boot-starter-actuator&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;testImplementation&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.boot:spring-boot-starter-test&amp;#39;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;exclude&lt;/span&gt; &lt;span style="color:#f5a40d"&gt;group:&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.junit.vintage&amp;#39;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;,&lt;/span&gt; &lt;span style="color:#f5a40d"&gt;module:&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;junit-vintage-engine&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;dependencyManagement&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;imports&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;mavenBom&lt;/span&gt; &lt;span style="color:#63c381"&gt;&amp;#34;org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;mavenBom&lt;/span&gt; &lt;span style="color:#63c381"&gt;&amp;#34;org.springframework.cloud:spring-cloud-kubernetes-dependencies:${springKubernetesVersion}&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;如果是需要客户端实现负载均衡，依赖是&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-groovy" data-lang="groovy"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-gateway&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-kubernetes-all&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-netflix-ribbon&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="添加路由配置"&gt;添加路由配置&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;bootstrap.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;spring&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;cloud&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;kubernetes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;discovery&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;catalogServicesWatchDelay&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;5000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;client&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;master-url&lt;/span&gt;: &lt;span style="color:#98c379"&gt;https://kubernetes.docker.internal:6443&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;ca-cert-data&lt;/span&gt;: &lt;span style="color:#98c379"&gt;xxx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;namespace&lt;/span&gt;: &lt;span style="color:#98c379"&gt;default&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;applicaiton.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;spring&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;application.name&lt;/span&gt;: &lt;span style="color:#98c379"&gt;gateway&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;cloud&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;gateway&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;discovery&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;locator&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;enabled&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;url-expression&lt;/span&gt;: &lt;span style="color:#63c381"&gt;&amp;#34;&amp;#39;http://&amp;#39;+serviceId+&amp;#39;:&amp;#39;+port&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;lower-case-service-id&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;management&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;endpoints&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;web&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;exposure&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;include&lt;/span&gt;: &lt;span style="color:#63c381"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;配置 &lt;code&gt;url-expression&lt;/code&gt; 目的是为了在转发的时候直接转发到 Kubernetes 中相应的 Service 上去，默认的表达式为 &lt;code&gt;&amp;quot;'lb://'+serviceId&amp;quot;&lt;/code&gt;，这种适用于通过 Consul 或者 Eureka，最终是根据服务的IP和端口访问，&lt;code&gt;spring-cloud-kubernetes&lt;/code&gt;没有实现&lt;code&gt;com.netflix.loadbalancer.AbstractServerList&lt;/code&gt;，所以不会进行IP转换，最终是通过服务名称查找Service 实现调用，所以不需要负载均衡&lt;/p&gt;</description></item><item><title>Spring Cloud Gateway 使用 Kubernetes 实现负载均衡</title><link>https://blog.hellowood.dev/posts/spring-cloud-gateway-%E4%BD%BF%E7%94%A8-kubernetes-%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</link><pubDate>Sun, 20 Sep 2020 22:23:18 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-gateway-%E4%BD%BF%E7%94%A8-kubernetes-%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</guid><description>&lt;p&gt;在使用 Spring Cloud Gateway 作为服务服务发现时，可能会遇到 Gateway 并没有部署在服务所在的 Kubernetes 集群中，或者存在网络隔离，无法直接通过 Service Name 访问到相应的服务，这时候就需要通过 Service 的 IP 访问，但是，&lt;code&gt;spring-cloud-kubernetes-discovery &lt;/code&gt;没有像 &lt;code&gt;spring-cloud-consul-discovery&lt;/code&gt;一样实现服务负载均衡的接口，所以默认只会访问某个服务固定的 IP；这样就需要使用负载均衡的依赖&lt;/p&gt;
&lt;h3 id="添加依赖"&gt;添加依赖&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-groovy" data-lang="groovy"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-gateway&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-kubernetes-all&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-netflix-ribbon&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;spring-cloud-starter-kubernetes-all&lt;/code&gt;包含 Kubernetes 负载均衡的实现&lt;/p&gt;
&lt;h3 id="添加配置"&gt;添加配置&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;bootstrap.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;spring&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;cloud&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;kubernetes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;discovery&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;catalogServicesWatchDelay&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;5000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;client&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;master-url&lt;/span&gt;: &lt;span style="color:#98c379"&gt;https://localhost:60002&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;ca-cert-data&lt;/span&gt;: &lt;span style="color:#98c379"&gt;xxxx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;namespace&lt;/span&gt;: &lt;span style="color:#98c379"&gt;develop&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;applicaiton.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;spring&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;application&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;name&lt;/span&gt;: &lt;span style="color:#98c379"&gt;gateway&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;cloud&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;gateway&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;discovery&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;locator&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;enabled&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;lower-case-service-id&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;management&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;endpoints&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;web&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;exposure&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;include&lt;/span&gt;: &lt;span style="color:#63c381"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description></item><item><title>Spring Cloud 使用 Kubernetes 作为配置中心 - 使用加密配置</title><link>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BD%BF%E7%94%A8%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE/</link><pubDate>Sun, 08 Sep 2019 19:18:09 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BD%BF%E7%94%A8%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE/</guid><description>&lt;blockquote&gt;
&lt;p&gt;Spring Cloud 可以通过使用 Kubernetes 的 Secrets 作为加密配置&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="创建应用"&gt;创建应用&lt;/h2&gt;
&lt;h3 id="添加依赖"&gt;添加依赖&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;build.gradle&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-groovy" data-lang="groovy"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;dependencies&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-kubernetes-config&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="添加配置"&gt;添加配置&lt;/h3&gt;
&lt;h4 id="编码"&gt;编码&lt;/h4&gt;
&lt;p&gt;内容通过 Base64 编码后添加到 Kubernetes 中&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;secrets.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;apiVersion: v1
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kind: Secret
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;metadata:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; name: secrets-service
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; namespace: default
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;data:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; url: amRiYzpteXNxbDovL2xvY2FsaG9zdDozMzA2L3NlYXRhP3VzZVVuaWNvZGU9dHJ1ZSZjaGFyYWN0ZXJFbmNvZGluZz11dGY4JmFsbG93TXVsdGlRdWVyaWVzPXRydWUmdXNlU1NMPWZhbHNl
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; username: aGVsbG93b29k
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; password: MTIzNDU2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;将Secrets 添加到 Kubernetes 中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kubectl apply -f secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="applicationproperties"&gt;application.properties&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-properties" data-lang="properties"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.application.name&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;secrets-service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;server.port&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;8081&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;management.endpoint.restart.enabled&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# Secret Config&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.secrets.enabled&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.secrets.name&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;secrets-service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.secrets.namespace&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;default&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.reload.monitoring-secrets&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# DataSource Config&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.datasource.url&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${DB_URL}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.datasource.username&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${DB_USERNAME}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.datasource.password&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${DB_PASSWORD}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;spring.cloud.kubernetes.secrets.enabled&lt;/code&gt;默认是关闭的，所以需要主动开启&lt;/li&gt;
&lt;li&gt;&lt;code&gt;spring.cloud.kubernetes.secrets.name&lt;/code&gt;默认和&lt;code&gt;spring.application.name&lt;/code&gt;一致&lt;/li&gt;
&lt;li&gt;&lt;code&gt;spring.cloud.kubernetes.secrets.namespace&lt;/code&gt;指定 Namespace&lt;/li&gt;
&lt;li&gt;&lt;code&gt;spring.cloud.kubernetes.reload.monitoring-secrets&lt;/code&gt;监听配置更新事件&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="添加接口"&gt;添加接口&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ConfigProperties.java&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@Data&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@Component&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@ConfigurationProperties&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;prefix&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#34;spring.datasource&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;ConfigProperties&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;private&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;url&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;private&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;username&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;private&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;password&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ConfigMapController.java&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@RestController&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@Slf4j&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;SecretsController&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@Autowired&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;private&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ConfigProperties&lt;/span&gt; &lt;span style="color:#c1abea"&gt;configProperties&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@GetMapping&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;/db&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;config&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;format&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;url:%s\nusername:%s\npassword:%s&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;configProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getUrl&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;configProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getUsername&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;configProperties&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getPassword&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="部署应用"&gt;部署应用&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;构建并上传镜像&lt;/p&gt;</description></item><item><title>Spring Cloud 使用 Kubernetes 作为配置中心</title><link>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</link><pubDate>Sun, 08 Sep 2019 19:15:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/</guid><description>&lt;blockquote&gt;
&lt;p&gt;Spring Cloud 可以通过使用 Kubernetes 的 ConfigMap 作为配置中心，实现配置的拉取和刷新&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="创建应用"&gt;创建应用&lt;/h2&gt;
&lt;h3 id="添加依赖"&gt;添加依赖&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;build.gradle&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-groovy" data-lang="groovy"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;dependencies&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-kubernetes-config&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="添加配置"&gt;添加配置&lt;/h3&gt;
&lt;h4 id="configmap"&gt;ConfigMap&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;kind&lt;/span&gt;: &lt;span style="color:#98c379"&gt;ConfigMap&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;apiVersion&lt;/span&gt;: &lt;span style="color:#98c379"&gt;v1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;metadata&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;name&lt;/span&gt;: &lt;span style="color:#98c379"&gt;config-map-service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;data&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;application.yaml&lt;/span&gt;: |-&lt;span style="color:#7e97c3"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; spring:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; profiles: dev
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; config:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; applicationVersion: dev-0.0.1
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; ---
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; spring:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; profiles: prod
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; config:
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#7e97c3"&gt; applicationVersion: prod-0.0.1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ConfigMap的名称要和应用名称一致，否则需要指定相应的名称；应用的配置信息可以使用&lt;code&gt;application.yaml|properties&lt;/code&gt;作为 key，需要注意的是环境配置是&lt;code&gt;spring.profiles&lt;/code&gt;，而不是&lt;code&gt;spring.profiles.active&lt;/code&gt;，否则只会使用最后一行的配置&lt;/p&gt;
&lt;p&gt;通过以下命令将 ConfigMap 添加到 Kubernetes 中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kubectl apply -f config-map.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="applicationproperties"&gt;application.properties&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-properties" data-lang="properties"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.application.name&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;config-map-service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.profiles.active&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${PROFILE:dev}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;management.endpoint.restart.enabled&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# Reload Config&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.reload.enabled&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.reload.mode&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;polling&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.reload.period&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;5000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.cloud.kubernetes.reload.strategy&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;refresh&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;spring.profiles.active=${PROFILE:dev}&lt;/code&gt;用于获取 Deployment 传递的参数来决定使用什么配置&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;spring.cloud.kubernetes.reload.enabled&lt;/code&gt;默认是关闭的，所以需要主动开启&lt;/p&gt;</description></item><item><title>Spring Cloud 使用 Kubernetes 作为注册中心</title><link>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/</link><pubDate>Sun, 08 Sep 2019 19:12:29 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-%E4%BD%BF%E7%94%A8-kubernetes-%E4%BD%9C%E4%B8%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/</guid><description>&lt;blockquote&gt;
&lt;p&gt;Spring Cloud 可以使用 Kubernetes 作为注册中心，实现服务注册和发现&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;创建两个应用，Consumer 和 Provider，Provider 提供一个 REST 接口供 Consumer 调用&lt;/p&gt;
&lt;h2 id="provider"&gt;Provider&lt;/h2&gt;
&lt;h3 id="添加依赖"&gt;添加依赖&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;build.gradle&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-groovy" data-lang="groovy"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;dependencies&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;compile&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;project&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#63c381"&gt;&amp;#34;:discovery/common&amp;#34;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.boot:spring-boot-starter-actuator&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.boot:spring-boot-starter-web&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;implementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.cloud:spring-cloud-starter-kubernetes-all&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;compileOnly&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.projectlombok:lombok&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;annotationProcessor&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.projectlombok:lombok&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;testImplementation&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#39;org.springframework.boot:spring-boot-starter-test&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c7bf54"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="添加配置"&gt;添加配置&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;application.properties&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;指定服务的名称，用于实现调用&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-properties" data-lang="properties"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;spring.application.name&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;provider-service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b3d23c"&gt;server.port&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#98c379"&gt;8082&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ProviderApplication.java&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;添加 &lt;code&gt;@EnableDiscoveryClient&lt;/code&gt;启用服务发现&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@SpringBootApplication&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@EnableDiscoveryClient&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;ProviderApplication&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;static&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;main&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;String&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;args&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;SpringApplication&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;run&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;ProviderApplication&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;class&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;args&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="添加接口"&gt;添加接口&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@GetMapping&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;/ping&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@ResponseBody&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;ping&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c1abea"&gt;InetAddress&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getLocalHost&lt;/span&gt;().&lt;span style="color:#b3d23c"&gt;getHostName&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#c678dd"&gt;catch&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;UnknownHostException&lt;/span&gt; &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#98c379"&gt;&amp;#34;Pong&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="部署到-kubernetes"&gt;部署到 Kubernetes&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Dockerfile&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-dockerfile" data-lang="dockerfile"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;FROM&lt;/span&gt; &lt;span style="color:#98c379"&gt;openjdk:8-jdk-alpine&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;VOLUME&lt;/span&gt; &lt;span style="color:#98c379"&gt;/tmp&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;TZ&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;Asia/Shanghai
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;RUN&lt;/span&gt; ln -snf /usr/share/zoneinfo/&lt;span style="color:#dcaeea"&gt;$TZ&lt;/span&gt; /etc/localtime &lt;span style="color:#c7bf54"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#ef8383"&gt;echo&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;$TZ&lt;/span&gt; &amp;gt; /etc/timezone
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ARG&lt;/span&gt; JAR_FILE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ADD&lt;/span&gt; discovery/provider/build/libs/provider-0.0.1-SNAPSHOT.jar app.jar
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENTRYPOINT&lt;/span&gt; [&lt;span style="color:#63c381"&gt;&amp;#34;java&amp;#34;&lt;/span&gt;,&lt;span style="color:#63c381"&gt;&amp;#34;-Djava.security.egd=file:/dev/./urandom&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;-Duser.timezone=GMT+08&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;-jar&amp;#34;&lt;/span&gt;,&lt;span style="color:#63c381"&gt;&amp;#34;/app.jar&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;构建并上传镜像&lt;/p&gt;</description></item><item><title>Spring Cloud 监控服务器下 IP/URL 不正确导致无法注册的解决方法</title><link>https://blog.hellowood.dev/posts/spring-cloud-%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B-ip-url-%E4%B8%8D%E6%AD%A3%E7%A1%AE%E5%AF%BC%E8%87%B4%E6%97%A0%E6%B3%95%E6%B3%A8%E5%86%8C%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</link><pubDate>Mon, 01 Jan 2018 11:51:23 +0800</pubDate><guid>https://blog.hellowood.dev/posts/spring-cloud-%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B-ip-url-%E4%B8%8D%E6%AD%A3%E7%A1%AE%E5%AF%BC%E8%87%B4%E6%97%A0%E6%B3%95%E6%B3%A8%E5%86%8C%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</guid><description>&lt;blockquote&gt;
&lt;h2 id="本项目仅用到了-spring-cloud并没有使用-eureka"&gt;本项目仅用到了 Spring Cloud，并没有使用 Eureka&lt;/h2&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;在使用 Spring Cloud 对 Spring Boot 应用通过 Spring Admin 进行监控的时候，当 Admin Server 和被监控的应用都在本地启动的时候没有任何问题，但是当部署到 Server 上之后，Client 在注册到 Admin Server 上时 IP 地址不正确，发现是因为 Server 有内网和外网 IP，但是在应用注册的时候用了内网的 IP，Admin Server 访问该内网 IP 失败，所以应用无法注册&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;因为没有使用 Eureka，所以配置时需要用 Spring Cloud 的配置来处理&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;使用 Eureka 请参考 &lt;a href="http://www.jianshu.com/p/fa1e9c8e4f47"&gt;http://www.jianshu.com/p/fa1e9c8e4f47&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="配置"&gt;配置&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;修改配置文件，添加以下内容&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;spring.boot.admin.client.service-base-url=http://${your_ip}:${your_port}
&lt;/code&gt;&lt;/pre&gt;&lt;hr&gt;
&lt;h2 id="说明"&gt;说明&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;当没有任何配置的时候，会使用&lt;code&gt;http://bogon:9999/&lt;/code&gt;注册&lt;/li&gt;
&lt;li&gt;当 Client 加入了&lt;code&gt;spring.boot.admin.client.prefer-ip=true&lt;/code&gt;的时候会以所得到的 IP 注册，此时 IP 为内网 IP，如果部署到服务器上将会无法注册&lt;/li&gt;
&lt;li&gt;当 Client 配置为&lt;code&gt;spring.boot.admin.client.service-base-url=http://${your_ip}:${your_port}&lt;/code&gt;时将会以所配置的地址进行注册&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>