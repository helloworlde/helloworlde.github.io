<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Proxmox VE on HelloWood</title><link>https://blog.hellowood.dev/tags/proxmox-ve/</link><description>Recent content in Proxmox VE on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Mon, 01 Jan 0001 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/proxmox-ve/index.xml" rel="self" type="application/rss+xml"/><item><title>Proxmox VE 8 挂载 PCIe 接口版本的 Goolge Coral TPU 用于 LXC 容器中部署的 Frigate 进行人物识别</title><link>https://blog.hellowood.dev/posts/proxmox-ve-8-%E6%8C%82%E8%BD%BD-pcie-%E6%8E%A5%E5%8F%A3%E7%89%88%E6%9C%AC%E7%9A%84-goolge-coral-tpu-%E7%94%A8%E4%BA%8E-lxc-%E5%AE%B9%E5%99%A8%E4%B8%AD%E9%83%A8%E7%BD%B2%E7%9A%84-frigate-%E8%BF%9B%E8%A1%8C%E4%BA%BA%E7%89%A9%E8%AF%86%E5%88%AB/</link><pubDate>Sun, 01 Dec 2024 20:26:09 +0800</pubDate><guid>https://blog.hellowood.dev/posts/proxmox-ve-8-%E6%8C%82%E8%BD%BD-pcie-%E6%8E%A5%E5%8F%A3%E7%89%88%E6%9C%AC%E7%9A%84-goolge-coral-tpu-%E7%94%A8%E4%BA%8E-lxc-%E5%AE%B9%E5%99%A8%E4%B8%AD%E9%83%A8%E7%BD%B2%E7%9A%84-frigate-%E8%BF%9B%E8%A1%8C%E4%BA%BA%E7%89%A9%E8%AF%86%E5%88%AB/</guid><description>&lt;p>在 PVE 的 LXC 容器中运行的 Frigate Docker 容器中使用 PCIe 接口版本的 Google Coral TPU 进行人物识别&lt;/p>
&lt;p>之前使用的是 USB Accelerator 版本，将设备挂载到容器中就可以工作了；但是新入手的 &lt;a href="https://coral.ai/products/m2-accelerator-dual-edgetpu">M.2 Accelerator with Dual Edge TPU&lt;/a> 是通过 PCIe 挂载的，配置有所区别；&lt;/p>
&lt;p>其他的版本，如 Mini PCIe Accelerator，M.2 Accelerator A+E key，M.2 Accelerator B+M key 的配置与 M.2 Accelerator with Dual Edge TPU 类似&lt;/p>
&lt;p>&lt;img src="https://lh3.googleusercontent.com/-R0H37d9aKorHo_VYWf8hCfukvbZolBaW2SHW1uDDn1G411r3MqemjxPZa9f44q8OwlfYIkGxSoj-GQbZGd2j7lxtyzSklIQVUWvo9r88mn8CzB-rcw=w2000-rw" alt="Coral TPU">&lt;/p>
&lt;h2 id="一pve-配置">一、PVE 配置&lt;/h2>
&lt;h3 id="1-修改订阅源">1. 修改订阅源&lt;/h3>
&lt;p>如果使用的是 PVE 的默认软件源，需要修改为以下订阅源：&lt;/p>
&lt;ul>
&lt;li>&lt;code>/etc/apt/sources.list.d/ceph.list&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>将 &lt;code>/etc/apt/sources.list.d/ceph.list&lt;/code> 中的配置替换为以下内容：&lt;/p>
&lt;pre tabindex="0">&lt;code>deb http://download.proxmox.com/debian/ceph-reef bookworm no-subscription
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>&lt;code>/etc/apt/sources.list&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>将 &lt;code>/etc/apt/sources.list&lt;/code> 中的配置替换为以下内容：&lt;/p>
&lt;pre tabindex="0">&lt;code># debian 软件
deb http://ftp.debian.org/debian bookworm main contrib
deb http://ftp.debian.org/debian bookworm-updates main contrib

# PVE 官方非订阅源 pve-no-subscription
deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription

# 安全相关
deb http://security.debian.org/debian-security bookworm-security main contrib
&lt;/code>&lt;/pre>&lt;p>接着更新订阅源&lt;/p></description></item><item><title>Proxmox VE 添加监控</title><link>https://blog.hellowood.dev/posts/proxmox-ve-%E6%B7%BB%E5%8A%A0%E7%9B%91%E6%8E%A7/</link><pubDate>Sun, 09 Apr 2023 21:29:39 +0800</pubDate><guid>https://blog.hellowood.dev/posts/proxmox-ve-%E6%B7%BB%E5%8A%A0%E7%9B%91%E6%8E%A7/</guid><description>&lt;p>PVE 支持添加 &lt;a href="https://graphiteapp.org/">Graphite&lt;/a> 或者 &lt;a href="https://www.influxdata.com/">InfluxDB&lt;/a> 作为指标数据的存储；在添加配置后，PVE 会主动将配置信息发送到对应的存储中，用于记录和监控 PVE 的状态&lt;/p>
&lt;p>基于 Docker 容器，使用 InfluxDB 和 Grafana 对 PVE 进行监控，效果如图：&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-promoxve-monitor-metrics-dashboard.png" alt="homelab-promoxve-monitor-metrics-dashboard.png">&lt;/p>
&lt;h2 id="配置-influxdb">配置 InfluxDB&lt;/h2>
&lt;p>使用的是 InfluxDB 2 版本，使用 Flux 语法进行查询；因此需要启动 InfluxDB 2 的容器，使用 DockerCompose 方便配置&lt;/p>
&lt;ul>
&lt;li>docker-compose.yaml&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">version&lt;/span>: &lt;span style="color:#63c381">&amp;#34;3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">services&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">influxdb&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">container_name&lt;/span>: &lt;span style="color:#98c379">influxdb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">image&lt;/span>: &lt;span style="color:#98c379">influxdb:2.6&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">ports&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#63c381">&amp;#34;8086:8086&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">volumes&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#98c379">./data/influx/data:/var/lib/influxdb2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#98c379">./data/influx/config:/etc/influxdb2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">environment&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">DOCKER_INFLUXDB_INIT_MODE&lt;/span>: &lt;span style="color:#98c379">setup&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">DOCKER_INFLUXDB_INIT_USERNAME&lt;/span>: &lt;span style="color:#98c379">admin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">DOCKER_INFLUXDB_INIT_PASSWORD&lt;/span>: &lt;span style="color:#98c379">qwertyuiop&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">DOCKER_INFLUXDB_INIT_ORG&lt;/span>: &lt;span style="color:#98c379">influx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">DOCKER_INFLUXDB_INIT_BUCKET&lt;/span>: &lt;span style="color:#98c379">influx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">DOCKER_INFLUXDB_INIT_ADMIN_TOKEN&lt;/span>: &lt;span style="color:#d19a66">123456&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>DOCKER_INFLUXDB_INIT_MODE&lt;/code>它用于指定容器启动时运行的初始化模式。该变量有两个有效值：&lt;/p>
&lt;ul>
&lt;li>&lt;code>setup&lt;/code>: 表示在容器首次启动时，将执行InfluxDB初始化脚本并创建管理员用户。&lt;/li>
&lt;li>&lt;code>skip&lt;/code>：表示跳过初始化脚本的执行，直接启动InfluxDB服务。&lt;/li>
&lt;/ul>
&lt;p>&lt;code>DOCKER_INFLUXDB_INIT_PASSWORD&lt;/code> 不能设置的太简单，否则 InfluxDB 启动时会报错
&lt;code>DOCKER_INFLUXDB_INIT_ORG&lt;/code> 用于指定 InfluxDB 的组织
&lt;code>DOCKER_INFLUXDB_INIT_BUCKET&lt;/code> 用于指定初始化使用的 Bucket
&lt;code>DOCKER_INFLUXDB_INIT_ADMIN_TOKEN&lt;/code> 用于访问时进行鉴权&lt;/p>
&lt;h2 id="配置-pve">配置 PVE&lt;/h2>
&lt;p>在 PVE 的服务器视图下，选择数据中心 - 指标服务器，选择添加 InfluxDB，输入相关的配置；协议选择 HTTP，组织添加 &lt;code>DOCKER_INFLUXDB_INIT_ORG&lt;/code> 配置的值，插槽添加 &lt;code>DOCKER_INFLUXDB_INIT_BUCKET&lt;/code> 配置的 Bucket， 令牌填写 &lt;code>DOCKER_INFLUXDB_INIT_ADMIN_TOKEN&lt;/code> 配置的 token&lt;/p></description></item><item><title>N5105 Promox VE 虚拟机频繁死机问题处理</title><link>https://blog.hellowood.dev/posts/n5105-promox-ve-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%A2%91%E7%B9%81%E6%AD%BB%E6%9C%BA%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/</link><pubDate>Sat, 25 Mar 2023 21:31:50 +0800</pubDate><guid>https://blog.hellowood.dev/posts/n5105-promox-ve-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%A2%91%E7%B9%81%E6%AD%BB%E6%9C%BA%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/</guid><description>&lt;p>使用 N5105 作为 HomeLab 的服务器；之前安装的 ESXi，使用 Ubuntu 22 的时候经常会出现 Ubuntu CPU 占用达到100%，然后死机；但是其他的虚拟机都没有问题，因为对 Linux 并不熟，查看了 ESXi 和 Ubuntu 日志并没有异常；后面安装黑群晖一直失败，因此换到了 Proxmox VE&lt;/p>
&lt;p>换到 PVE 后依然存在同样的问题，以为是服务的问题，于是给 Docker 容器添加了资源限制，无效后迁移到了 CentOS 部署，发现还是同样的问题；并且越来越频繁，从一天一次变成了几小时一次，几乎无法使用&lt;/p>
&lt;p>猜测会不会是硬件问题，一番搜索发现在 N5105 上居然是个普遍的问题&lt;/p>
&lt;h2 id="问题">问题&lt;/h2>
&lt;p>这个问题于 2022-08-04 在 Proxmox 的问题反馈中提交：&lt;a href="https://bugzilla.proxmox.com/show_bug.cgi?id=4188">Bug 4188 - VMs freeze on Intel N5105 CPU&lt;/a>，描述中&amp;quot;到运行Intel N5105 CPU的一些用户注意到在Proxmox上运行的虚拟机会冻结，并记录了各种错误。虚拟机会冻结，控制台无法输入，CPU利用率达到最大值，直到强制重启虚拟机&amp;quot;，现象和我遇到的是一样的，说明该现象是通病；&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-vm-freeze-issue-bug-feedback.png" alt="homelab-pve-vm-freeze-issue-bug-feedback.png">&lt;/p>
&lt;p>2022-9-13 在帖子 &lt;a href="https://forum.proxmox.com/threads/opt-in-linux-5-19-kernel-for-proxmox-ve-7-x-available.115090/">Opt-in Linux 5.19 Kernel for Proxmox VE 7.x available&lt;/a> 中，PVE员工宣布将 PVE 的内核升级到 5.19版本，在 Bug 反馈到讨论中有不少人确认有效&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-vm-freeze-issue-519-kenel.png" alt="homelab-pve-vm-freeze-issue-519-kenel.png">&lt;/p>
&lt;p>这个问题在 2022-12-06 状态变更为 &amp;lsquo;FIX PACKAGED&amp;rsquo;；在 2022-12-14，PVE员工宣布支持将内核升级到 6.1&lt;/p></description></item><item><title>OpenWrt 在 PVE 中以虚拟机方式安装</title><link>https://blog.hellowood.dev/posts/openwrt-%E5%9C%A8-pve-%E4%B8%AD%E4%BB%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/</link><pubDate>Mon, 20 Mar 2023 21:35:17 +0800</pubDate><guid>https://blog.hellowood.dev/posts/openwrt-%E5%9C%A8-pve-%E4%B8%AD%E4%BB%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/</guid><description>&lt;h2 id="下载镜像">下载镜像&lt;/h2>
&lt;ul>
&lt;li>下载镜像&lt;/li>
&lt;/ul>
&lt;p>在 &lt;a href="https://openwrt.org/zh/downloads">https://openwrt.org/zh/downloads&lt;/a> 选择稳定发行版，然后选择需要下载的版本；这里使用当前最新的 22.03.3 版本，使用&lt;a href="https://mirrors.aliyun.com/openwrt/">阿里云 OpenWrt 镜像&lt;/a>进行下载&lt;/p>
&lt;p>选择下载 &lt;code>generic-ext4-combined-efi.img.gz&lt;/code> 这个压缩文件，用于 bios 引导&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-openwrt-esxi-ima-download.png" alt="homelab-openwrt-esxi-ima-download.png">&lt;/p>
&lt;ul>
&lt;li>解压&lt;/li>
&lt;/ul>
&lt;p>使用 &lt;code>gunzip&lt;/code> 命令解压 &lt;code>gz&lt;/code> 压缩文件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gunzip openwrt-22.03.3-x86-64-generic-ext4-combined-efi.img.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>将下载的镜像解压后得到 &lt;code>img&lt;/code>格式的文件&lt;/p>
&lt;h2 id="虚拟机配置">虚拟机配置&lt;/h2>
&lt;h3 id="创建虚拟机">创建虚拟机&lt;/h3>
&lt;ol>
&lt;li>创建虚拟机，输入名称&lt;/li>
&lt;li>操作系统这里选择 &amp;ldquo;不使用任何介质&amp;rdquo;&lt;/li>
&lt;li>磁盘这里，选择左侧删除按钮，将磁盘删除；因为会将 img 文件导入作为磁盘，因此这里不需要&lt;/li>
&lt;li>按需配置 CPU 和内存；通常 1核和 512M就已经足够了&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-openwrt-pve-init-configuration.png" alt="homelab-openwrt-pve-init-configuration.png">&lt;/p>
&lt;h3 id="添加硬盘">添加硬盘&lt;/h3>
&lt;ul>
&lt;li>上传 img 镜像&lt;/li>
&lt;/ul>
&lt;p>选择 local - ISO镜像，将解压后的 img 文件上传到 PVE&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-openwrt-pve-init-upload-img.png" alt="homelab-openwrt-pve-init-upload-img.png">&lt;/p>
&lt;p>等待上传完成，记录上传后的地址，即 target file 后面的路径，需要在导入时使用&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-openwrt-pve-init-upload-img-result.png" alt="homelab-openwrt-pve-init-upload-img-result.png">&lt;/p>
&lt;ul>
&lt;li>将 img 镜像导入为虚拟磁盘&lt;/li>
&lt;/ul>
&lt;p>打开 PVE 的 shell，执行导入命令，将 img 作为虚拟磁盘，导入到 106 虚拟机（即刚才创建的虚拟机的 vmid）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>qm importdisk &lt;span style="color:#d19a66">106&lt;/span> /var/lib/vz/template/iso/openwrt-22.03.3-x86-64-generic-ext4-combined-efi.img local-lvm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-openwrt-pve-init-convert-img-to-disk.png" alt="homelab-openwrt-pve-init-convert-img-to-disk.png">&lt;/p></description></item><item><title>Proxmox VE 安装初始化</title><link>https://blog.hellowood.dev/posts/proxmox-ve-%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/</link><pubDate>Mon, 27 Feb 2023 21:41:04 +0800</pubDate><guid>https://blog.hellowood.dev/posts/proxmox-ve-%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/</guid><description>&lt;blockquote>
&lt;p>Proxmox VE，是一个开源的服务器虚拟化环境Linux发行版。Proxmox VE基于Debian，使用基于Ubuntu的定制内核，包含安装程序、网页控制台和命令行工具，并且向第三方工具提供了REST API - 维基百科&lt;/p>
&lt;/blockquote>
&lt;p>PVE 和 Vmware ESXi 类似，都支持虚拟化环境；PVE 基于 Linux，扩展性更强&lt;/p>
&lt;h2 id="安装">安装&lt;/h2>
&lt;ul>
&lt;li>下载 ISO 镜像&lt;/li>
&lt;/ul>
&lt;p>PVE的镜像可在 PVE 官网的&lt;a href="https://www.proxmox.com/en/downloads/category/iso-images-pve">下载页面&lt;/a>进行下载&lt;/p>
&lt;ul>
&lt;li>制作启动盘&lt;/li>
&lt;/ul>
&lt;p>使用 &lt;a href="https://rufus.ie/zh/">Rufus&lt;/a> 或者 &lt;a href="https://www.balena.io/etcher">balenaEtcher&lt;/a> 将下载的 ISO 镜像写入到 U 盘或者移动硬盘中&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-install-write-iso.png" alt="homelab-pve-install-write-iso.png">&lt;/p>
&lt;ul>
&lt;li>插入主机并启动&lt;/li>
&lt;/ul>
&lt;p>启动后选择安装 Proxmox VE&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-install-start-install.png" alt="homelab-pve-install-start-install.png">&lt;/p>
&lt;ul>
&lt;li>设置 IP 地址&lt;/li>
&lt;/ul>
&lt;p>IP地址用于后续访问，可以通过DHCP获取，也可以设置为固定的 IP&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-install-set-ip.png" alt="homelab-pve-install-set-ip.png">&lt;/p>
&lt;ul>
&lt;li>安装完成&lt;/li>
&lt;/ul>
&lt;p>安装完成后，会提示重启&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-install-completed.png" alt="homelab-pve-install-completed.png">&lt;/p>
&lt;ul>
&lt;li>登录&lt;/li>
&lt;/ul>
&lt;p>重启完成后，在命令行会提示访问的地址，默认端口是 8006，&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-install-login-page.png" alt="homelab-pve-install-login-page.png">&lt;/p>
&lt;p>通过 HTTPS 协议访问；如 &lt;a href="https://192.168.17.129:8006">https://192.168.17.129:8006&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://img.hellowood.dev/picture/homelab-pve-install-web-login-page.png" alt="homelab-pve-install-web-login-page.png">&lt;/p></description></item></channel></rss>