<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Thrift on HelloWood</title><link>https://blog.hellowood.dev/tags/thrift/</link><description>Recent content in Thrift on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Sat, 06 Sep 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/thrift/index.xml" rel="self" type="application/rss+xml"/><item><title>Thrfit 客户端请求处理流程</title><link>https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 20 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrfit-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;使用同步的非阻塞的服务端和客户端的请求处理流程&lt;/p&gt;
&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;h3 id="idl"&gt;IDL&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;helloworld.thrift&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-thrift" data-lang="thrift"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;namespace&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;java&lt;/span&gt; &lt;span style="color:#c1abea"&gt;io.github.helloworlde.thrift&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloMessage&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloResponse&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;service&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloService&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;sayHello&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="客户端实现"&gt;客户端实现&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;TSocket&lt;/code&gt; 作为底层连接，协议使用 &lt;code&gt;TBinaryProtocol&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TTransport&lt;/span&gt; &lt;span style="color:#c1abea"&gt;transport&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TSocket&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;localhost&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;9090&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;transport&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;open&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TProtocol&lt;/span&gt; &lt;span style="color:#c1abea"&gt;protocol&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TBinaryProtocol&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;transport&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Client&lt;/span&gt; &lt;span style="color:#c1abea"&gt;client&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Client&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;protocol&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;setMessage&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;Thrift&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#c1abea"&gt;response&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;client&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;sayHello&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;request&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;log&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;info&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;返回响应: {}&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;response&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getMessage&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;} &lt;span style="color:#c678dd"&gt;catch&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;printStackTrace&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="请求处理流程"&gt;请求处理流程&lt;/h2&gt;
&lt;h3 id="1-建立连接"&gt;1. 建立连接&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;transport&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;open&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;org.apache.thrift.transport.TSocket#open&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;初始化 Socket，建立连接&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;open&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;socket_&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;==&lt;/span&gt; &lt;span style="color:#b756ff;font-weight:bold"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 初始化 Socket&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;initSocket&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 建立连接&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;socket_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;connect&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;InetSocketAddress&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;host_&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;port_&lt;/span&gt;), &lt;span style="color:#c1abea"&gt;connectTimeout_&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 初始化流&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;inputStream_&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;BufferedInputStream&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;socket_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getInputStream&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;outputStream_&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;BufferedOutputStream&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;socket_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getOutputStream&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#c678dd"&gt;catch&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;IOException&lt;/span&gt; &lt;span style="color:#c1abea"&gt;iox&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;close&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;throw&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;NOT_OPEN&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;iox&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="2-执行请求"&gt;2. 执行请求&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;TProtocol&lt;/code&gt; 构建 &lt;code&gt;TServiceClient&lt;/code&gt;，用于发送同步请求&lt;/p&gt;</description></item><item><title>Thrfit 服务端请求处理流程</title><link>https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 20 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrfit-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;使用同步的非阻塞的服务端的请求处理流程&lt;/p&gt;
&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;h3 id="idl"&gt;IDL&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;helloworld.thrift&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-thrift" data-lang="thrift"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;namespace&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;java&lt;/span&gt; &lt;span style="color:#c1abea"&gt;io.github.helloworlde.thrift&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloMessage&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloResponse&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;service&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloService&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;sayHello&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="服务端实现"&gt;服务端实现&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;TThreadedSelectorServer&lt;/code&gt; 作为服务端，支持接收连接，处理 IO 事件，执行请求由不同的线程实现；底层连接使用 &lt;code&gt;ServerSocket&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;NonblockingServer&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@SneakyThrows&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;static&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;main&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;String&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;args&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloServiceImpl&lt;/span&gt; &lt;span style="color:#c1abea"&gt;helloService&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloServiceImpl&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Processor&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Iface&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;helloServiceProcessor&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Processor&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&amp;gt;&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;helloService&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TNonblockingServerTransport&lt;/span&gt; &lt;span style="color:#c1abea"&gt;transport&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TNonblockingServerSocket&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;9090&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 配置参数以及处理器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Args&lt;/span&gt; &lt;span style="color:#c1abea"&gt;serverArgs&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Args&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;transport&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;selectorThreads&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;4&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;workerThreads&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;10&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;acceptQueueSizePerThread&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;20&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;processor&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;helloServiceProcessor&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TServer&lt;/span&gt; &lt;span style="color:#c1abea"&gt;server&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;serverArgs&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;server&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;serve&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="请求处理流程"&gt;请求处理流程&lt;/h2&gt;
&lt;h3 id="1-启动-server"&gt;1. 启动 Server&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;TServer&lt;/span&gt; &lt;span style="color:#c1abea"&gt;server&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;serverArgs&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c1abea"&gt;server&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;serve&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;org.apache.thrift.server.AbstractNonblockingServer#serve&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;启动 Server，启动用于连接的线程 &lt;code&gt;AcceptThread&lt;/code&gt; 和用于处理 IO 事件的多个线程 &lt;code&gt;SelectorThread&lt;/code&gt;；然后开始监听 IO 事件，由线程池处理请求&lt;/p&gt;</description></item><item><title>Thrift 客户端异步请求</title><link>https://blog.hellowood.dev/posts/thrift-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/</link><pubDate>Sat, 20 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrift-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/</guid><description>&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;h3 id="idl"&gt;IDL&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;helloworld.thrift&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-thrift" data-lang="thrift"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;namespace&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;java&lt;/span&gt; &lt;span style="color:#c1abea"&gt;io.github.helloworlde.thrift&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloMessage&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloResponse&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;service&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloService&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;sayHello&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="客户端"&gt;客户端&lt;/h3&gt;
&lt;p&gt;异步客户端调用使用 &lt;code&gt;AsyncClient&lt;/code&gt;，传输层使用 &lt;code&gt;TNonblockingSocket&lt;/code&gt;；需要实现 &lt;code&gt;AsyncMethodCallback&lt;/code&gt;作为回调，用于处理请求结果&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;AsyncClient&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;static&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;main&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;String&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;args&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;InterruptedException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 构建异步客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TAsyncClientManager&lt;/span&gt; &lt;span style="color:#c1abea"&gt;clientManager&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TAsyncClientManager&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TProtocolFactory&lt;/span&gt; &lt;span style="color:#c1abea"&gt;protocolFactory&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TBinaryProtocol&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Factory&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncClient&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Factory&lt;/span&gt; &lt;span style="color:#c1abea"&gt;factory&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncClient&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Factory&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;clientManager&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;protocolFactory&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TNonblockingTransport&lt;/span&gt; &lt;span style="color:#c1abea"&gt;nonblockingTransport&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TNonblockingSocket&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;localhost&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;9090&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncClient&lt;/span&gt; &lt;span style="color:#c1abea"&gt;asyncClient&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;factory&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getAsyncClient&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;nonblockingTransport&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 异步回调&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;AsyncMethodCallback&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;callback&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;AsyncMethodCallback&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;onComplete&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#c1abea"&gt;response&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;log&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;info&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;响应结果: {}&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;response&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getMessage&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;onError&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;Exception&lt;/span&gt; &lt;span style="color:#c1abea"&gt;exception&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;log&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;error&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;请求失败: {}&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;exception&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getMessage&lt;/span&gt;(), &lt;span style="color:#c1abea"&gt;exception&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; };
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 构建请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;setMessage&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;Async Thrift&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 调用&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;asyncClient&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;sayHello&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;request&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;callback&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#c678dd"&gt;catch&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;|&lt;/span&gt; &lt;span style="color:#c1abea"&gt;IOException&lt;/span&gt; &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;e&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;printStackTrace&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;Thread&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;sleep&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;3_000&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="请求处理流程"&gt;请求处理流程&lt;/h2&gt;
&lt;h3 id="构建-client-和回调"&gt;构建 Client 和回调&lt;/h3&gt;
&lt;h4 id="1-构建-client"&gt;1. 构建 Client&lt;/h4&gt;
&lt;p&gt;异步的客户端由抽象类 &lt;code&gt;TAsyncClient&lt;/code&gt; 定义，实现类继承了 &lt;code&gt;TAsyncClient&lt;/code&gt;，同时实现了 &lt;code&gt;AsyncIface&lt;/code&gt;；
在构建其 Factory 时需要三个参数，分别是 &lt;code&gt;TAsyncClientManager&lt;/code&gt;，用于管理调用请求的所有流程；和 &lt;code&gt;TProtocolFactory&lt;/code&gt;，用于获取协议；还有 &lt;code&gt;TNonblockingTransport&lt;/code&gt;，用于底层的传输，必须是非阻塞的&lt;/p&gt;</description></item><item><title>Thrift 中的 Transport</title><link>https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-transport/</link><pubDate>Mon, 01 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-transport/</guid><description>&lt;p&gt;Thrift 中有 &lt;code&gt;TTransport&lt;/code&gt; 和 &lt;code&gt;TServerTransport&lt;/code&gt;，封装了底层传输层的数据读写；分别用于客户端和服务端&lt;/p&gt;
&lt;h2 id="ttransport"&gt;TTransport&lt;/h2&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/thrift-java-source-class-transport.png" alt="thrift-java-source-class-transport.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;h3 id="方法"&gt;方法&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;open&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;用于建立与 Server 端的连接&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;open&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;close&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;关闭连接&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;close&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;read&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;用于读取数据&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;read&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;byte&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;buf&lt;/span&gt;, &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;off&lt;/span&gt;, &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;len&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;write&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;用于写入数据&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;write&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;byte&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;buf&lt;/span&gt;, &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;off&lt;/span&gt;, &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;len&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;flush&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;清空缓冲区中的数据，发送给服务端&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;flush&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TTransportException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="实现类"&gt;实现类&lt;/h3&gt;
&lt;h4 id="非封装的-transport"&gt;非封装的 Transport&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TNonblockingTransport&lt;/code&gt;: 非阻塞的 Transport 的抽象类，底层使用 NIO&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TNonblockingSocket&lt;/code&gt;: &lt;code&gt;TNonblockingTransport&lt;/code&gt; 的实现类，基于 SocketChannel 的 Transport，是非阻塞的&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TIOStreamTransport&lt;/code&gt;: 基于 IO 流的 Transport&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TSocket&lt;/code&gt;: &lt;code&gt;TIOStreamTransport&lt;/code&gt; 的子类，底层使用 &lt;code&gt;Socket&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TSimpleFileTransport&lt;/code&gt;：基于文件的 Transport，会将流写入文件或者从文件读取流&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TFileTransport&lt;/code&gt;: 基于文件的 Transport，会将流写入文件或者从文件读取流&lt;/li&gt;
&lt;li&gt;&lt;code&gt;THttpClient&lt;/code&gt;：基于 &lt;code&gt;HttpClient&lt;/code&gt; 或 &lt;code&gt;HttpURLConnection&lt;/code&gt;，会通过 HTTP 的方式发送请求，通常用于 &lt;code&gt;TServlet&lt;/code&gt; 的服务端&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ByteBuffer&lt;/code&gt;: 基于 ByteBuffer 的 Transport&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TMemoryInputTransport&lt;/code&gt;：基于内存数组的 Transport，会从底层的数组读取，用于测试场景&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TMemoryBuffer&lt;/code&gt;：使用内存数组作为缓冲区的 Transport，用于测试场景&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="封装的-transport"&gt;封装的 Transport&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TZlibTransport&lt;/code&gt;: 压缩的 Transport，会将流压缩后再发送&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AutoExpandingBufferReadTransport&lt;/code&gt;: 可扩展读缓冲区的 Transport，使用可变数组作为缓冲区&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AutoExpandingBufferWriteTransport&lt;/code&gt;: 可扩展写缓冲区的 Transport，使用可变数组作为缓冲区&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TSaslTransport&lt;/code&gt;：支持 SASL(Simple Authentication and Security Layer) 认证的 Transport，有两个实现类，用于客户端的&lt;code&gt;TSaslClientTransport&lt;/code&gt; 和用于服务端的 &lt;code&gt;TSaslServerTransport&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TFramedTransport&lt;/code&gt;：缓冲的 Transport，通过在前面带有4字节帧大小的消息来确保每次都完全读取消息&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TFastFramedTransport&lt;/code&gt;： 复用并扩展了读写缓冲区的 Transport，避免每次都创建新的 byte 数组&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="tservertransport"&gt;TServerTransport&lt;/h2&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/thrift-java-source-class-server-transport.png" alt="thrift-java-source-class-server-transport.png" loading="lazy"&gt;
&lt;/p&gt;</description></item><item><title>Thrift 服务端异步请求</title><link>https://blog.hellowood.dev/posts/thrift-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/</link><pubDate>Mon, 01 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrift-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/</guid><description>&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;h3 id="idl"&gt;IDL&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;helloworld.thrift&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-thrift" data-lang="thrift"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;namespace&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;java&lt;/span&gt; &lt;span style="color:#c1abea"&gt;io.github.helloworlde.thrift&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloMessage&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;struct&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloResponse&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c678dd"&gt;required&lt;/span&gt; &lt;span style="color:#ef8383"&gt;string&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;service&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloService&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;sayHello&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;&lt;span style="color:#d19a66"&gt;1&lt;/span&gt;: &lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="服务端"&gt;服务端&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Server&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@Slf4j&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;AsyncServer&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@SneakyThrows&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;static&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;main&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;String&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;args&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloServiceAsyncImpl&lt;/span&gt; &lt;span style="color:#c1abea"&gt;helloService&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloServiceAsyncImpl&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncProcessor&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncIface&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;helloServiceProcessor&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncProcessor&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&amp;gt;&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;helloService&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TNonblockingServerTransport&lt;/span&gt; &lt;span style="color:#c1abea"&gt;transport&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TNonblockingServerSocket&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;9090&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 配置参数以及处理器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Args&lt;/span&gt; &lt;span style="color:#c1abea"&gt;serverArgs&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;Args&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;transport&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;selectorThreads&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;4&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;workerThreads&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;10&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;acceptQueueSizePerThread&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;20&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#b3d23c"&gt;processor&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;helloServiceProcessor&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;TServer&lt;/span&gt; &lt;span style="color:#c1abea"&gt;server&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TThreadedSelectorServer&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;serverArgs&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;server&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;serve&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;实现&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;实现类需要实现 &lt;code&gt;AsyncIface&lt;/code&gt; 接口，方法定义中会有一个 &lt;code&gt;AsyncMethodCallback&lt;/code&gt;，用于处理响应回调&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e5c07b"&gt;@Slf4j&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;class&lt;/span&gt; &lt;span style="color:#76a9f9"&gt;HelloServiceAsyncImpl&lt;/span&gt; &lt;span style="color:#c678dd"&gt;implements&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloService&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;AsyncIface&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e5c07b"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;sayHello&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;HelloMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;AsyncMethodCallback&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;resultHandler&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;request&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getMessage&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;log&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;info&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;接收到请求: {}&amp;#34;&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt; &lt;span style="color:#c1abea"&gt;response&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;HelloResponse&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;response&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;setMessage&lt;/span&gt;(&lt;span style="color:#98c379"&gt;&amp;#34;Hello &amp;#34;&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;resultHandler&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;onComplete&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;response&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="请求处理流程"&gt;请求处理流程&lt;/h2&gt;
&lt;p&gt;Server 端同步与异步处理的流程区别在于使用的 &lt;code&gt;TProcessor&lt;/code&gt; 不同；同步使用 &lt;code&gt;TProcessor&lt;/code&gt;，异步使用 &lt;code&gt;TAsyncProcessor&lt;/code&gt;；除此之外，其他的流程与使用 NIO 的同步处理没有区别&lt;/p&gt;</description></item><item><title>Thrift 中的 Protocol</title><link>https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-protocol/</link><pubDate>Sun, 31 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrift-%E4%B8%AD%E7%9A%84-protocol/</guid><description>&lt;p&gt;&lt;code&gt;TProtocol&lt;/code&gt; 是 Thrift 中协议的抽象类，定义了数据序列化和反序列化的接口&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/thrift-java-source-class-protocol.png" alt="thrift-java-source-class-protocol.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;h2 id="属性"&gt;属性&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;TProtocol&lt;/code&gt; 中有 &lt;code&gt;TTransport&lt;/code&gt;类型的属性&lt;code&gt;trans_&lt;/code&gt;，用于与底层的传输层进行数据交互&lt;/p&gt;
&lt;h2 id="方法"&gt;方法&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;TProtocol&lt;/code&gt; 中的方法可以分为两类，分别用于写入和读取各种类型
其中 &lt;code&gt;Message&lt;/code&gt;，&lt;code&gt;Struct&lt;/code&gt;, &lt;code&gt;Field&lt;/code&gt;,&lt;code&gt;Map&lt;/code&gt;,&lt;code&gt;List&lt;/code&gt;,&lt;code&gt;Set&lt;/code&gt; 等类型会有开始和结束标志，一些还会写入或读取名称、序号等信息；可以参考 &lt;a href="https://github.com/helloworlde/thrift/blob/master/doc/specs/thrift-protocol-spec.md"&gt;Thrift Protocol Structure&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;/**
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt; * 写入
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt; */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeStructBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TStruct&lt;/span&gt; &lt;span style="color:#c1abea"&gt;struct&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeStructEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeFieldBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TField&lt;/span&gt; &lt;span style="color:#c1abea"&gt;field&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeFieldEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeFieldStop&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMapBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMap&lt;/span&gt; &lt;span style="color:#c1abea"&gt;map&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMapEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeListBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TList&lt;/span&gt; &lt;span style="color:#c1abea"&gt;list&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeListEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeSetBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TSet&lt;/span&gt; &lt;span style="color:#c1abea"&gt;set&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeSetEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeBool&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;boolean&lt;/span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeByte&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;byte&lt;/span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeI16&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;short&lt;/span&gt; &lt;span style="color:#c1abea"&gt;i16&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeI32&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;i32&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeI64&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;long&lt;/span&gt; &lt;span style="color:#c1abea"&gt;i64&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeDouble&lt;/span&gt;(&lt;span style="color:#ef8383"&gt;double&lt;/span&gt; &lt;span style="color:#c1abea"&gt;dub&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeString&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#c1abea"&gt;str&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeBinary&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;ByteBuffer&lt;/span&gt; &lt;span style="color:#c1abea"&gt;buf&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;/**
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt; * 读取
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt; */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readMessageBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readMessageEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TStruct&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readStructBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readStructEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TField&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readFieldBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readFieldEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TMap&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readMapBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readMapEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TList&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readListBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readListEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TSet&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readSetBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readSetEnd&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;boolean&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readBool&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;byte&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readByte&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;short&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readI16&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readI32&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;long&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readI64&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;double&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readDouble&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;String&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readString&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ByteBuffer&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readBinary&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="实现类"&gt;实现类&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TBinaryProtocol&lt;/code&gt;: 二进制协议，根据 Thrift 的类型按 &lt;a href="https://github.com/helloworlde/thrift/blob/master/doc/specs/thrift-protocol-spec.md"&gt;Thrift Protocol Structure&lt;/a&gt; 定义写入数据；参考 &lt;a href="https://github.com/helloworlde/thrift/blob/master/doc/specs/thrift-binary-protocol.md"&gt;Thrift Binary protocol encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;strictWrite_&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 写入版本&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;version&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;VERSION_1&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;|&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeI32&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;version&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 被调用方法&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeString&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;name&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 请求序号&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeI32&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;seqid&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeString&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;name&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeByte&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeI32&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;seqid&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TCompactProtocol&lt;/code&gt;：压缩协议，会将请求内容进行压缩后写入，参考 &lt;a href="https://github.com/helloworlde/thrift/blob/master/doc/specs/thrift-compact-protocol.md"&gt;Thrift Compact protocol encoding
&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeByteDirect&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;PROTOCOL_ID&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeByteDirect&lt;/span&gt;((&lt;span style="color:#c1abea"&gt;VERSION&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;&amp;amp;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;VERSION_MASK&lt;/span&gt;) &lt;span style="color:#c7bf54"&gt;|&lt;/span&gt; ((&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TYPE_SHIFT_AMOUNT&lt;/span&gt;) &lt;span style="color:#c7bf54"&gt;&amp;amp;&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TYPE_MASK&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeVarint32&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;seqid&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeString&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;name&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TTupleProtocol&lt;/code&gt;：继承了 &lt;code&gt;TCompactProtocol&lt;/code&gt; 类，Scheme 使用 &lt;code&gt;TupleScheme&lt;/code&gt;，表示使用写消息体的方式序列化和反序列化，而不是 &lt;code&gt;StandardScheme&lt;/code&gt; 使用消息头和消息体的方式序列化和反序列化&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeBitSet&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;BitSet&lt;/span&gt; &lt;span style="color:#c1abea"&gt;bs&lt;/span&gt;, &lt;span style="color:#ef8383"&gt;int&lt;/span&gt; &lt;span style="color:#c1abea"&gt;vectorWidth&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ef8383"&gt;byte&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;bytes&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;toByteArray&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;bs&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;vectorWidth&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;for&lt;/span&gt; (&lt;span style="color:#ef8383"&gt;byte&lt;/span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt; : &lt;span style="color:#c1abea"&gt;bytes&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeByte&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;b&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TJSONProtocol&lt;/code&gt;：将消息序列化为 JSON，可以用于泛化调用的场景下&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;resetContext&lt;/span&gt;(); &lt;span style="color:#8a93a5;font-style:italic"&gt;// THRIFT-3743&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeJSONArrayStart&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeJSONInteger&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;VERSION&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#ef8383"&gt;byte&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;[]&lt;/span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;name&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;getBytes&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;StandardCharsets&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;UTF_8&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeJSONString&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;b&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeJSONInteger&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeJSONInteger&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;seqid&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TSimpleJSONProtocol&lt;/code&gt;: 将消息以 JSON 格式输出，没有实现读取，用于脚本语言&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;message&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;resetWriteContext&lt;/span&gt;(); &lt;span style="color:#8a93a5;font-style:italic"&gt;// THRIFT-3743&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;trans_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;write&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;LBRACKET&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;pushWriteContext&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;ListContext&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeString&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;name&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeByte&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;writeI32&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;message&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;seqid&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TProtocolDecorator&lt;/code&gt;：抽象实现，会将所有的操作都转发给被代理的类实现&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;concreteProtocol&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TMultiplexedProtocol&lt;/code&gt;：&lt;code&gt;TProtocolDecorator&lt;/code&gt; 的实现类，在消息头部写入了服务的名称，会被 Server 端解析；用于有多个服务的 Server；其他的类型写入和读取由被代理的协议实现&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;) &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;==&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TMessageType&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;CALL&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;||&lt;/span&gt; &lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;==&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TMessageType&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;ONEWAY&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;super&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c678dd"&gt;new&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;SERVICE_NAME&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;SEPARATOR&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;+&lt;/span&gt; &lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;name&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;type&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;seqid&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;super&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;writeMessageBegin&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;tMessage&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;StoredMessageProtocol&lt;/code&gt;：&lt;code&gt;TProtocolDecorator&lt;/code&gt; 的实现类，代理其他协议，通常用于 Server 端，只获取请求头，具体的读取由被代理的协议实现&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TMessage&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;readMessageBegin&lt;/span&gt;() &lt;span style="color:#c678dd"&gt;throws&lt;/span&gt; &lt;span style="color:#c1abea"&gt;TException&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#c1abea"&gt;messageBegin&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description></item><item><title>Thrfit 中的 Server</title><link>https://blog.hellowood.dev/posts/thrfit-%E4%B8%AD%E7%9A%84-server/</link><pubDate>Mon, 18 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrfit-%E4%B8%AD%E7%9A%84-server/</guid><description>&lt;p&gt;Thrift 中有多种 Server 的实现，支持单线程、多线程、异步等多种方式&lt;/p&gt;
&lt;h2 id="server-定义"&gt;Server 定义&lt;/h2&gt;
&lt;h3 id="属性"&gt;属性&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;processorFactory_&lt;/code&gt; : 处理器工厂&lt;/li&gt;
&lt;li&gt;&lt;code&gt;serverTransport_&lt;/code&gt;: 服务端 Transport&lt;/li&gt;
&lt;li&gt;&lt;code&gt;eventHandler_&lt;/code&gt; : 事件监听器，可以监听 Server 所有启动、关闭、处理请求相关的事件&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inputTransportFactory_&lt;/code&gt; : 输入流工厂&lt;/li&gt;
&lt;li&gt;&lt;code&gt;outputTransportFactory_&lt;/code&gt; : 输出流工厂&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inputProtocolFactory_&lt;/code&gt; : 输入流协议工厂&lt;/li&gt;
&lt;li&gt;&lt;code&gt;outputProtocolFactory_&lt;/code&gt; : 输出流协议工厂&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="方法"&gt;方法&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;serve&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;启动 Server，监听端口，对外提供服务&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#c678dd"&gt;abstract&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;serve&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;stop&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;关闭 Server，断开连接，释放并清除资源&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;stop&lt;/span&gt;() {}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="实现类"&gt;实现类&lt;/h2&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/thrift-source-server-subclass.png" alt="thrift-source-server-subclass.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;h3 id="阻塞"&gt;阻塞&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;TSimpleServer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Server 的简单实现，是单线程阻塞的 Server，连接实现取决于 &lt;code&gt;TServerTransport&lt;/code&gt;具体类型；用于测试场景&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;public&lt;/span&gt; &lt;span style="color:#ef8383"&gt;void&lt;/span&gt; &lt;span style="color:#00b1f7"&gt;serve&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 监听 Socket&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;serverTransport_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;listen&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 如果有事件处理器，则调用其 preSever 方法&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;eventHandler_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;preServe&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 设置运行状态&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;setServing&lt;/span&gt;(&lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 只要没有关闭，就获取连接&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;while&lt;/span&gt; (&lt;span style="color:#c7bf54"&gt;!&lt;/span&gt;&lt;span style="color:#c1abea"&gt;stopped_&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 接受连接&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;client&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;serverTransport_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;accept&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;connectionContext&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;eventHandler_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;createContext&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;inputProtocol&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;outputProtocol&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;while&lt;/span&gt; (&lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 处理上下文事件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;eventHandler_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;processContext&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;connectionContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;inputTransport&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;outputTransport&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 处理请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;processor&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;process&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;inputProtocol&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;outputProtocol&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 上下文删除事件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;eventHandler_&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;deleteContext&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;connectionContext&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;inputProtocol&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;outputProtocol&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 关闭 Transport&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;inputTransport&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;close&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;outputTransport&lt;/span&gt;.&lt;span style="color:#b3d23c"&gt;close&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;// 修改服务状态&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;setServing&lt;/span&gt;(&lt;span style="color:#b756ff;font-weight:bold"&gt;false&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;TThreadPoolServer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在 &lt;code&gt;TSimpleServer&lt;/code&gt; 的基础上优化，使用了线程池处理请求；构建参数中可以指定创建线程池的参数，支持线程池饱和后超时；连接实现取决于 &lt;code&gt;TServerTransport&lt;/code&gt;具体类型&lt;/p&gt;</description></item><item><title>Thrfit 中的核心概念</title><link>https://blog.hellowood.dev/posts/thrfit-%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/</link><pubDate>Sun, 17 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/thrfit-%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/</guid><description>&lt;h2 id="服务端"&gt;服务端&lt;/h2&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt; +-------------------------------------------+
 | Server |
 | (single-threaded, event-driven etc) |
 +-------------------------------------------+
 | Processor |
 | (compiler generated) |
 +-------------------------------------------+
 | Protocol |
 | (JSON, compact etc) |
 +-------------------------------------------+
 | Transport |
 | (raw TCP, HTTP etc) |
 +-------------------------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Thrift Server 设计大致可以分为四层，分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Server：负责连接调度、服务的生命周期，定义接口是&lt;code&gt;TServer&lt;/code&gt; - &lt;code&gt;TSimpleServer&lt;/code&gt;：简单的阻塞服务端 - &lt;code&gt;TThreadPoolServer&lt;/code&gt;：使用线程池的处理请求的阻塞服务端 - &lt;code&gt;THsHaServer&lt;/code&gt;：使用线程池处理请求的基于 NIO 的非阻塞服务端 - &lt;code&gt;TThreadedSelectorServer&lt;/code&gt;：使用多种线程池的基于 NIO 的非阻塞服务端&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Processor：处理请求，具体的实现由生成的代码处理，定义接口是 &lt;code&gt;TProcessor&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TBaseProcessor&lt;/code&gt;：同步处理的 Processor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TBaseAsyncProcessor&lt;/code&gt;：异步处理的 Processor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TMultiplexedProcessor&lt;/code&gt;：支持多个服务的同步 Processor&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Protocol：请求协议，数据的编解码实现，定义接口是 &lt;code&gt;TProtocol&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;TBinaryProtocol&lt;/code&gt;：二进制协议&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TCompactProtocol&lt;/code&gt;：压缩协议&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TJSONProtocol&lt;/code&gt;：JSON 格式协议&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TMultiplexedProtocol&lt;/code&gt;：支持多个 Processor 的封装协议，依赖于其他协议&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Transport：底层的连接，提供了读写的抽象实现；服务端定义是 &lt;code&gt;TServerTransport&lt;/code&gt;&lt;/p&gt;</description></item></channel></rss>