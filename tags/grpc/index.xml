<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>GRPC on HelloWood</title><link>https://blog.hellowood.dev/tags/grpc/</link><description>Recent content in GRPC on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Wed, 01 Oct 2025 22:00:48 +0800</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/grpc/index.xml" rel="self" type="application/rss+xml"/><item><title>gRPC 对冲请求取消流程</title><link>https://blog.hellowood.dev/posts/grpc-%E5%AF%B9%E5%86%B2%E8%AF%B7%E6%B1%82%E5%8F%96%E6%B6%88%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 20 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E5%AF%B9%E5%86%B2%E8%AF%B7%E6%B1%82%E5%8F%96%E6%B6%88%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;当客户端接收到对冲请求集合中的一个完成时，会取消其他的请求，被取消的请求最终会提交一个 CancelClientStreamCommand，发送一个 RST_STEAM 请求；当服务端接受到这个流后，如果监听器还没有关闭，会执行取消上下文的操作，最终将这个请求取消&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-hedging-request-cancel.svg" alt="grpc-hedging-request-cancel.svg" loading="lazy"&gt;
&lt;/p&gt;
&lt;h2 id="客户端"&gt;客户端&lt;/h2&gt;
&lt;p&gt;当客户端成功接收到响应会，会在 io.grpc.internal.RetriableStream.Sublistener#close 中将成功的流进行提交&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.RetriableStream#commit$CommitTask#run&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在提交时，会通过提交 CommitTask 将其他的流取消&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CommitTask&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;implements&lt;/span&gt; Runnable {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;run&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 遍历保存的枯竭的流，如果不是最后提交的流，则都取消&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; (Substream substream : savedDrainedSubstreams) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (substream &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; winningSubstream) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; substream.&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(CANCELLED_BECAUSE_COMMITTED);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 如果有重试中的，则取消&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (retryFuture &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; retryFuture.&lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 如果有对冲中的，则取消&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (hedgingFuture &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; hedgingFuture.&lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 将当前流从未提交的流中移除&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; postCommit();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.internal.AbstractClientStream#cancel&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用指定的原因取消流&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(Status reason) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Preconditions.&lt;span style="color:#a6e22e"&gt;checkArgument&lt;/span&gt;(&lt;span style="color:#f92672"&gt;!&lt;/span&gt;reason.&lt;span style="color:#a6e22e"&gt;isOk&lt;/span&gt;(), &lt;span style="color:#e6db74"&gt;&amp;#34;Should not cancel with OK status&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; cancelled &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; abstractClientStreamSink().&lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(reason);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.netty.shaded.io.grpc.netty.NettyClientStream.Sink#cancel&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;提交取消流的指令&lt;/p&gt;</description></item><item><title>gRPC 服务间调用事件流程</title><link>https://blog.hellowood.dev/posts/grpc-%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 20 Feb 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%B5%81%E7%A8%8B/</guid><description>&lt;h2 id="调用流程图"&gt;调用流程图&lt;/h2&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/gRPC%e8%af%b7%e6%b1%82%e4%ba%8b%e4%bb%b6%e6%b5%81%e7%a8%8b.svg" alt="gRPC请求事件流程.svg" loading="lazy"&gt;
&lt;/p&gt;
&lt;h2 id="可监听的事件"&gt;可监听的事件&lt;/h2&gt;
&lt;h3 id="客户端"&gt;客户端&lt;/h3&gt;
&lt;h4 id="clientcall"&gt;ClientCall&lt;/h4&gt;
&lt;p&gt;客户端调用，用于执行客户端的调用行为&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;checkStart&lt;/code&gt;：开始调用&lt;/li&gt;
&lt;li&gt;&lt;code&gt;request&lt;/code&gt;：指定发送消息的数量&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sendMessage&lt;/code&gt;：发送消息到缓冲区&lt;/li&gt;
&lt;li&gt;&lt;code&gt;halfClose&lt;/code&gt;：半关闭，会将消息发送给 Server 端&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cancel&lt;/code&gt;：调用失败时取消&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="clientcalllistener"&gt;ClientCall.Listener&lt;/h4&gt;
&lt;p&gt;调用监听器，监听调用事件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;onReady&lt;/code&gt;：流就绪事件，用于非 &lt;code&gt;UNARY&lt;/code&gt; 和 &lt;code&gt;SERVER_STREAM&lt;/code&gt; 的请求&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onHeaders&lt;/code&gt;：当接收到 Server 端返回的 Header 时调用&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onMessage&lt;/code&gt;：当接收到 Server 端返回的 Message 时调用&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onClose&lt;/code&gt;：当流关闭时调用&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="clientstreamtracer"&gt;ClientStreamTracer&lt;/h4&gt;
&lt;p&gt;流统计追踪，监听流的事件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;outboundHeaders&lt;/code&gt;：发送 header 给 Server 端&lt;/li&gt;
&lt;li&gt;&lt;code&gt;outboundMessage&lt;/code&gt;：发送 message 给 Server 端&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inboundHeaders&lt;/code&gt;：接收 Server 端返回的 headers&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inboundMessage&lt;/code&gt;：接收 Server 端返回的 message&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inboundTrailers&lt;/code&gt;：接收 Server 端返回的 trailers&lt;/li&gt;
&lt;li&gt;&lt;code&gt;streamClosed&lt;/code&gt;：流关闭时调用&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="服务端"&gt;服务端&lt;/h3&gt;
&lt;h4 id="servertransportfilter"&gt;ServerTransportFilter&lt;/h4&gt;
&lt;p&gt;Server 端 Transport 事件过滤器，支持监听事件，修改 Transport 的属性&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;transportReady&lt;/code&gt;：Transport 就绪事件&lt;/li&gt;
&lt;li&gt;&lt;code&gt;transportTerminated&lt;/code&gt;：Transport 关闭事件&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="serverstreamtracer"&gt;ServerStreamTracer&lt;/h4&gt;
&lt;p&gt;Server 端流事件追踪，监听流的事件&lt;/p&gt;</description></item><item><title>gRPC 中泛化调用服务接口</title><link>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E6%B3%9B%E5%8C%96%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3/</link><pubDate>Fri, 29 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E6%B3%9B%E5%8C%96%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3/</guid><description>&lt;p&gt;gRPC 没有直接支持泛化调用，protobuf 可以不依赖于生成的代码实现调用，所以可以通过反射接口间接实现泛化调用&lt;/p&gt;
&lt;p&gt;要求 Server 端提供 &lt;code&gt;grpc.reflection.v1alpha.ServerReflection&lt;/code&gt; 服务，用于获取服务的描述文件&lt;/p&gt;
&lt;p&gt;大致的流程是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;根据方法名称，调用服务端反射服务的方法，获取方法所在 proto 文件的描述&lt;/li&gt;
&lt;li&gt;根据 proto 描述文件，获取文件描述、服务描述，用于重新构建要被调用方法的方法描述 &lt;code&gt;MethodDescriptor&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;根据方法描述，将请求内容序列化为对应的类型&lt;/li&gt;
&lt;li&gt;使用重新构建的&lt;code&gt;MethodDescriptor&lt;/code&gt;和其他参数对 Server 端相应的方法发起调用&lt;/li&gt;
&lt;li&gt;解析响应并返回&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;p&gt;使用 JSON 格式请求被调用的服务方法，并返回 JSON 格式的响应&lt;/p&gt;
&lt;h3 id="proto-定义"&gt;proto 定义&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;syntax &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; io&lt;span style="color:#f92672"&gt;.&lt;/span&gt;github.helloworlde.grpc;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; go_package &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;api;grpc_gateway&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_package &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;io.github.helloworlde.grpc&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_multiple_files &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_outer_classname &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;HelloWorldGrpc&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;service&lt;/span&gt; HelloService{&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; SayHello(HelloMessage) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (HelloResponse){&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; }&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HelloMessage&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HelloResponse&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="调用"&gt;调用&lt;/h3&gt;
&lt;h4 id="1-构建反射服务-stub"&gt;1. 构建反射服务 Stub&lt;/h4&gt;
&lt;p&gt;需要调用反射服务的方法，该方法是双向流&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 构建 Channel&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ManagedChannel channel&lt;span style="color:#f92672"&gt;=&lt;/span&gt;ManagedChannelBuilder.&lt;span style="color:#a6e22e"&gt;forAddress&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;127.0.0.1&amp;#34;&lt;/span&gt;,9090)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;usePlaintext&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 使用 Channel 构建 BlockingStub&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ServerReflectionGrpc.&lt;span style="color:#a6e22e"&gt;ServerReflectionStub&lt;/span&gt; reflectionStub&lt;span style="color:#f92672"&gt;=&lt;/span&gt;ServerReflectionGrpc.&lt;span style="color:#a6e22e"&gt;newStub&lt;/span&gt;(channel);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 响应观察器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;StreamObserver&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ServerReflectionResponse&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; streamObserver&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; StreamObserver&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ServerReflectionResponse&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt;(){
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;onNext&lt;/span&gt;(ServerReflectionResponse response){
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 处理响应&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;onError&lt;/span&gt;(Throwable t){
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;onCompleted&lt;/span&gt;(){
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Complete&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 请求观察器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;StreamObserver&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ServerReflectionRequest&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; requestStreamObserver&lt;span style="color:#f92672"&gt;=&lt;/span&gt;reflectionStub.&lt;span style="color:#a6e22e"&gt;serverReflectionInfo&lt;/span&gt;(streamObserver);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="2-根据方法名称获取文件描述"&gt;2. 根据方法名称获取文件描述&lt;/h4&gt;
&lt;p&gt;这里的 &lt;code&gt;methodSymbol&lt;/code&gt; 即服务或方法的限定名，可以是 &lt;code&gt;package.service&lt;/code&gt; 或者 &lt;code&gt;package.service.method&lt;/code&gt;
，如 &lt;code&gt;io.github.helloworlde.grpc.HelloService.SayHello&lt;/code&gt;，需要注意方法前是 &lt;code&gt;.&lt;/code&gt;不是&lt;code&gt;/&lt;/code&gt;&lt;/p&gt;</description></item><item><title>gRPC 反射服务</title><link>https://blog.hellowood.dev/posts/grpc-%E5%8F%8D%E5%B0%84%E6%9C%8D%E5%8A%A1/</link><pubDate>Sun, 17 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E5%8F%8D%E5%B0%84%E6%9C%8D%E5%8A%A1/</guid><description>&lt;p&gt;gRPC 提供了 &lt;code&gt;grpc.reflection.v1alpha.ServerReflection&lt;/code&gt; 服务，在 Server 端添加后可以通过该服务获取所有服务的信息，包括服务定义，方法，属性等；&lt;/p&gt;
&lt;p&gt;可以根据获取到的服务信息调用其他的方法，实现泛化调用；gRPC 调试工具 &lt;a href=""&gt;grpcurl&lt;/a&gt; 和 &lt;a href="https://github.com/grpc-swagger/grpc-swagger"&gt;gRPC Swagger&lt;/a&gt; 等工具都是通过这种方式实现的&lt;/p&gt;
&lt;h2 id="定义"&gt;定义&lt;/h2&gt;
&lt;p&gt;参考 &lt;a href="https://github.com/grpc/grpc/blob/master/doc/server-reflection.md"&gt;GRPC Server Reflection Protocol&lt;/a&gt; 和 &lt;a href="https://github.com/grpc/grpc/blob/master/src/proto/grpc/reflection/v1alpha/reflection.proto"&gt;reflection.proto&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;该服务只有一个双向流的方法 &lt;code&gt;ServerReflectionInfo&lt;/code&gt;，调用时根据请求参数不同，调用不同的方法进行处理，并返回响应；该方法的流控是非自动的，只有当一个请求完成之后才会获取下一个请求&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;service&lt;/span&gt; ServerReflection {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; ServerReflectionInfo(stream ServerReflectionRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (stream ServerReflectionResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;ServerReflectionRequest&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; host &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;oneof&lt;/span&gt; message_request {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据服务名查询 proto 文件
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; file_by_filename &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据名称获取 proto 文件，如 &amp;lt;package&amp;gt;.&amp;lt;service&amp;gt;[.&amp;lt;method&amp;gt;] 或 &amp;lt;package&amp;gt;.&amp;lt;type&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; file_containing_symbol &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据 message 类型和序号获取 proto 文件
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; ExtensionRequest file_containing_extension &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 查找给定消息类型的所有已知扩展使用的标记号，并将它们以未定义的顺序附加到ExtensionNumberResponse
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; all_extension_numbers_of_type &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 查询所有的服务
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; list_services &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;7&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; }&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="server-端"&gt;Server 端&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;服务实现&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-diff" data-lang="diff"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;@Slf4j
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;public class ReflectionServer {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; @SneakyThrows
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; public static void main(String[] args) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; // 构建 Server
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Server server = NettyServerBuilder.forAddress(new InetSocketAddress(9090))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; // 添加服务
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .addService(new HelloServiceImpl())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; // 添加反射服务
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;+ .addService(ProtoReflectionService.newInstance())
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;&lt;/span&gt; .build();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; // 启动 Server
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; server.start();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.info(&amp;#34;服务端启动成功&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Runtime.getRuntime().addShutdownHook(new Thread(() -&amp;gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; try {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; server.awaitTermination(10, TimeUnit.SECONDS);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } catch (InterruptedException e) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; e.printStackTrace();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; // 保持运行
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; server.awaitTermination();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="client-端"&gt;Client 端&lt;/h2&gt;
&lt;p&gt;发起双向流请求&lt;/p&gt;</description></item><item><title>gRPC Gateway 使用</title><link>https://blog.hellowood.dev/posts/grpc-gateway-%E4%BD%BF%E7%94%A8/</link><pubDate>Wed, 06 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-gateway-%E4%BD%BF%E7%94%A8/</guid><description>&lt;p&gt;gRPC Gateway 可以代理 gRPC 服务，接收 HTTP 请求，并转为 gRPC 请求由服务进行处理，并将返回结果转换为 HTTP 响应发送给调用者 gRPC Gateway&lt;/p&gt;
&lt;p&gt;支持代理单个服务或者多个服务，当代理多个服务时，可以通过命名解析实现转发请求&lt;/p&gt;
&lt;h2 id="快速使用"&gt;快速使用&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;启动项目&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;git clone https://github.com/helloworlde/grpc-gateway.git &amp;amp; cd grpc-gateway
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;访问&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl localhost:8090/hello&lt;span style="color:#ae81ff"&gt;\?&lt;/span&gt;message&lt;span style="color:#f92672"&gt;=&lt;/span&gt;world
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;result&amp;#34;&lt;/span&gt;:&lt;span style="color:#e6db74"&gt;&amp;#34;Hello world&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;}&lt;/span&gt;%
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;h3 id="安装依赖"&gt;安装依赖&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;安装 buf&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;buf 用于代替 protoc 进行生成代码，可以避免使用复杂的 protoc 命令，避免 protoc 各种失败问题&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;brew tap bufbuild/buf
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;brew install buf
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;安装 grpc-gateway&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go install &lt;span style="color:#ae81ff"&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;&lt;/span&gt; github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway &lt;span style="color:#ae81ff"&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;&lt;/span&gt; github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;添加 buf 配置文件 buf.gen.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-diff" data-lang="diff"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;version: v1beta1
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;plugins:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - name: go
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; out: proto
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; opt: paths=source_relative
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - name: go-grpc
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; out: proto
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; opt: paths=source_relative,require_unimplemented_servers=false
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;添加配置文件 buf.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;version&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;v1beta1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;build&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;roots&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ae81ff"&gt;proto&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="实现服务端"&gt;实现服务端&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;定义 proto&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;syntax &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; io&lt;span style="color:#f92672"&gt;.&lt;/span&gt;github.helloworlde;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; go_package &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;github.com/helloworlde/grpc-gateway;grpc_gateway&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_package &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;io.github.helloworlde&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_multiple_files &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_outer_classname &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;HelloGrpc&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;service&lt;/span&gt; HelloService {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; Hello (HelloMessage) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (HelloResponse) {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; }&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HelloMessage&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HelloResponse&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; result &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;生成代码&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;buf generate
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;实现接口&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; (
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;context&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;pb&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;github.com/helloworlde/grpc-gateway/proto/api&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;type&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HelloService&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;struct&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;func&lt;/span&gt; (&lt;span style="color:#a6e22e"&gt;h&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;HelloService&lt;/span&gt;) &lt;span style="color:#a6e22e"&gt;Hello&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;ctx&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;context&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Context&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;message&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;pb&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;HelloMessage&lt;/span&gt;) (&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;pb&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;HelloResponse&lt;/span&gt;, &lt;span style="color:#66d9ef"&gt;error&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;helloMessage&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;Hello &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;message&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;GetMessage&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;response&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;pb&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;HelloResponse&lt;/span&gt;{&lt;span style="color:#a6e22e"&gt;Result&lt;/span&gt;: &lt;span style="color:#a6e22e"&gt;helloMessage&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;response&lt;/span&gt;, &lt;span style="color:#66d9ef"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;启动 Server&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;func&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;StartGrpcServer&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;listener&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;net&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Listen&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;tcp&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;:9090&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#a6e22e"&gt;log&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Fatalln&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Listen gRPC port failed: &amp;#34;&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;err&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;server&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;grpc&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;NewServer&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;pb&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;RegisterHelloServiceServer&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;server&lt;/span&gt;, &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;helloService&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;log&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Println&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Start gRPC Server on 0.0.0.0:9090&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#a6e22e"&gt;err&lt;/span&gt; = &lt;span style="color:#a6e22e"&gt;server&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Serve&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;listener&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	&lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		&lt;span style="color:#a6e22e"&gt;log&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Fatalln&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Start gRPC Server failed: &amp;#34;&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;err&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;func&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;main&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;server&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;StartGrpcServer&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;启动 Server 后，会监听 8090 端口，对外提供服务&lt;/p&gt;</description></item><item><title>gRPC 服务使用 TLS 加密</title><link>https://blog.hellowood.dev/posts/grpc-%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8-tls-%E5%8A%A0%E5%AF%86/</link><pubDate>Wed, 06 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8-tls-%E5%8A%A0%E5%AF%86/</guid><description>&lt;p&gt;gRPC 支持使用 TLS 对请求进行加密&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;SSL(Secure Socket Layer，安全套接字)，是面向连接的网络层和应用层协议之间的一种协议层；SSL 通过互相认证、使用数字签名确保完整性、使用加密确保隐私性，以实现客户端和服务端之间的安全通讯&lt;/p&gt;
&lt;p&gt;TLS(Transport Layer Security, 传输层安全协议)，用于两个应用程序之间提供保密性和数据完整性&lt;/p&gt;
&lt;p&gt;SSL是基于 HTTP 之下 TCP 之上的一个协议层，在SSL更新到3.0时，IETF对SSL3.0进行了标准化，并添加了少数机制(但是几乎和SSL3.0无差异)，标准化后的IETF更名为TLS1.0(Transport Layer Security 安全传输层协议)，可以说TLS就是SSL的新版本3.1&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;相关项目参考 &lt;a href="https://github.com/helloworlde/grpc-java-sample"&gt;github.com/helloworlde/grpc-java-sample&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="生成证书"&gt;生成证书&lt;/h2&gt;
&lt;p&gt;可以通过 openssl 生成一个自签名的证书，用于加密&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;添加配置&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;指定证书的配置，其中 &lt;code&gt;CN&lt;/code&gt; 指定了访问的域名，如果实际域名与证书域名不一致，会导致连接失败&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;certificate.conf&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;[req]
default_bits = 4096
prompt = no
default_md = sha256
req_extensions = req_ext
distinguished_name = dn
[dn]
C = CN
ST = BJ
O = helloworlde
CN = localhost
[req_ext]
subjectAltName = @alt_names
[alt_names]
DNS.1 = localhost
IP.1 = ::1
IP.2 = 127.0.0.1
&lt;/code&gt;&lt;/pre&gt;&lt;ol start="2"&gt;
&lt;li&gt;生成证书&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;生成自签名的证书，因为 Netty 的 &lt;code&gt;SslContextBuilder&lt;/code&gt; 和 &lt;code&gt;SslContext&lt;/code&gt; 仅支持 &lt;code&gt;PKCS8&lt;/code&gt; 格式的 key，所以需要将其他格式的 key 转换为 &lt;code&gt;PKCS8&lt;/code&gt; 格式&lt;/p&gt;</description></item><item><title>gRPC 中使用 Channelz</title><link>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E4%BD%BF%E7%94%A8-channelz/</link><pubDate>Mon, 04 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E4%BD%BF%E7%94%A8-channelz/</guid><description>&lt;p&gt;gRPC 提供了 Channelz 用于对外提供服务的数据，用于调试、监控等；根据服务的角色不同，可以提供的数据有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务端: Servers, Server, ServerSockets, Socket&lt;/li&gt;
&lt;li&gt;客户端: TopChannels, Channel, Subchannel&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="channelz-服务定义"&gt;Channelz 服务定义&lt;/h2&gt;
&lt;p&gt;参考 Channelz 的设计 &lt;a href="https://github.com/grpc/proposal/blob/master/A14-channelz.md"&gt;gRPC Channelz&lt;/a&gt; 以及服务定义 &lt;a href="https://github.com/grpc/grpc/blob/master/src/proto/grpc/channelz/channelz.proto"&gt;channelz.proto&lt;/a&gt;，提供了以下方法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;service&lt;/span&gt; Channelz {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// 返回所有的根 Channel(即应用直接创建的 Channel)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetTopChannels(GetTopChannelsRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetTopChannelsResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据 Channel ID 返回单个的 Channel 详情，包括 Subchannel，如果没有则返回 NOT_FOUND
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetChannel(GetChannelRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetChannelResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据 Subchannel ID 返回 Subchannel 详情
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetSubchannel(GetSubchannelRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetSubchannelResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 返回所有存在的 Server
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetServers(GetServersRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetServersResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据 Server ID 返回 Server 详情
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetServer(GetServerRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetServerResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据 Server ID 返回 Server 所有的 Socket
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetServerSockets(GetServerSocketsRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetServerSocketsResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据 Socket ID 返回 Socket 详情
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; GetSocket(GetSocketRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (GetSocketResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;p&gt;相关项目参考 &lt;a href="https://github.com/helloworlde/grpc-java-sample"&gt;github.com/helloworlde/grpc-java-sample&lt;/a&gt;&lt;/p&gt;</description></item><item><title>gRPC 中打印请求二进制日志</title><link>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E6%89%93%E5%8D%B0%E8%AF%B7%E6%B1%82%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97/</link><pubDate>Mon, 04 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E6%89%93%E5%8D%B0%E8%AF%B7%E6%B1%82%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97/</guid><description>&lt;p&gt;gRPC 支持将请求调用的参数、Header 等信息以二进制的方式输出到文件中，方便在必要时排查问题&lt;/p&gt;
&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h4 id="1-添加依赖"&gt;1. 添加依赖&lt;/h4&gt;
&lt;p&gt;binlog 的依赖在 &lt;code&gt;grpc-services&lt;/code&gt;中，所以需要有该依赖&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-kotlin" data-lang="kotlin"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;dependencies {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; implementation(&lt;span style="color:#e6db74"&gt;&amp;#34;io.grpc:grpc-services:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;${grpcVersion}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="2-添加-binarylogsink-实现"&gt;2. 添加 BinaryLogSink 实现&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;@Slf4j&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomBinaryLogSink&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;implements&lt;/span&gt; BinaryLogSink {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; String outPath;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; OutputStream out;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;boolean&lt;/span&gt; closed;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; CustomBinaryLogSink(String path) &lt;span style="color:#66d9ef"&gt;throws&lt;/span&gt; IOException {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; File outFile &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; File(path);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; outPath &lt;span style="color:#f92672"&gt;=&lt;/span&gt; outFile.&lt;span style="color:#a6e22e"&gt;getAbsolutePath&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Writing binary logs to {}&amp;#34;&lt;/span&gt;, outFile.&lt;span style="color:#a6e22e"&gt;getAbsolutePath&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; out &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; BufferedOutputStream(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; FileOutputStream(outFile));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; String &lt;span style="color:#a6e22e"&gt;getPath&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;outPath&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;synchronized&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;write&lt;/span&gt;(MessageLite message) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (closed) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Attempt to write after TempFileSink is closed.&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; message.&lt;span style="color:#a6e22e"&gt;writeDelimitedTo&lt;/span&gt;(out);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; out.&lt;span style="color:#a6e22e"&gt;flush&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#66d9ef"&gt;catch&lt;/span&gt; (IOException e) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Caught exception while writing&amp;#34;&lt;/span&gt;, e);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; closeQuietly();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;synchronized&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;close&lt;/span&gt;() &lt;span style="color:#66d9ef"&gt;throws&lt;/span&gt; IOException {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (closed) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; closed &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; out.&lt;span style="color:#a6e22e"&gt;flush&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#66d9ef"&gt;finally&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; out.&lt;span style="color:#a6e22e"&gt;close&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;synchronized&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;closeQuietly&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; close();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#66d9ef"&gt;catch&lt;/span&gt; (IOException e) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Caught exception while closing&amp;#34;&lt;/span&gt;, e);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="3-创建-channel-时指定-binarylog"&gt;3. 创建 Channel 时指定 BinaryLog&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;BinaryLog binaryLog &lt;span style="color:#f92672"&gt;=&lt;/span&gt; BinaryLogs.&lt;span style="color:#a6e22e"&gt;createBinaryLog&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomBinaryLogSink(&lt;span style="color:#e6db74"&gt;&amp;#34;CUSTOM_PATH&amp;#34;&lt;/span&gt;), &lt;span style="color:#e6db74"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;channel&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ManagedChannelBuilder.&lt;span style="color:#a6e22e"&gt;forAddress&lt;/span&gt;(host, port)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;usePlaintext&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setBinaryLog&lt;/span&gt;(binaryLog)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="4-指定环境变量"&gt;4. 指定环境变量&lt;/h4&gt;
&lt;p&gt;需要指定环境变量，设置需要输出的方法才会生效，设置 &lt;code&gt;GRPC_BINARY_LOG_CONFIG=*&lt;/code&gt;，&lt;code&gt;*&lt;/code&gt;代表打印所有的方法，具体指定可以参考 &lt;a href="https://github.com/helloworlde/proposal/blob/master/A16-binary-logging.md#control-interface"&gt;Control Interface&lt;/a&gt;&lt;/p&gt;</description></item><item><title>gRPC 拦截器和监听器</title><link>https://blog.hellowood.dev/posts/grpc-%E6%8B%A6%E6%88%AA%E5%99%A8%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8/</link><pubDate>Sun, 03 Jan 2021 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E6%8B%A6%E6%88%AA%E5%99%A8%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8/</guid><description>&lt;p&gt;gRPC 拦截器用于在请求执行之前执行，以实现校验授权，记录调用行为，插入其他逻辑等；拦截器有 &lt;code&gt;ClientInterceptor&lt;/code&gt; 和 &lt;code&gt;ServerInterceptor&lt;/code&gt;，分别用于客户端和服务端&lt;/p&gt;
&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id="客户端"&gt;客户端&lt;/h2&gt;
&lt;h3 id="拦截器接口定义"&gt;拦截器接口定义&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ClientInterceptor&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;@ThreadSafe&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;interface&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;ClientInterceptor&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; ClientCall&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;interceptCall&lt;/span&gt;(MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; method,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; CallOptions callOptions,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Channel next);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="使用"&gt;使用&lt;/h3&gt;
&lt;h4 id="添加拦截器"&gt;添加拦截器&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;在构建 Channel 时添加拦截器&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;channel&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ManagedChannelBuilder
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;forAddress&lt;/span&gt;(host, port)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;intercept&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomClientInterceptor())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ManagedChannelImpl#ManagedChannelImpl&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然后会在 &lt;code&gt;ManagedChannelImpl&lt;/code&gt; 的构造方法中，使用拦截器将 Channel 实例封装，返回的 Channel 实例是 &lt;code&gt;InterceptorChannel&lt;/code&gt; 的实例&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;interceptorChannel&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ClientInterceptors.&lt;span style="color:#a6e22e"&gt;intercept&lt;/span&gt;(channel, interceptors);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.ClientInterceptors#intercept&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;当有多个拦截器时，会顺序的封装，最后添加的拦截器会最先执行&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;static&lt;/span&gt; Channel &lt;span style="color:#a6e22e"&gt;intercept&lt;/span&gt;(Channel channel, List&lt;span style="color:#f92672"&gt;&amp;lt;?&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;extends&lt;/span&gt; ClientInterceptor&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; interceptors) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Preconditions.&lt;span style="color:#a6e22e"&gt;checkNotNull&lt;/span&gt;(channel, &lt;span style="color:#e6db74"&gt;&amp;#34;channel&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 遍历拦截器，创建 InterceptorChannel&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; (ClientInterceptor interceptor : interceptors) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; channel &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; InterceptorChannel(channel, interceptor);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; channel;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="处理请求"&gt;处理请求&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.ClientInterceptors.InterceptorChannel#newCall&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;InterceptorChannel&lt;/code&gt; 继承了 &lt;code&gt;Channel&lt;/code&gt;，在执行请求时，会调用&lt;code&gt;channel.newCall&lt;/code&gt;，在这个方法里，会调用拦截器的方法&lt;/p&gt;</description></item><item><title>gRPC 中监听 Sream 和 Transport 的事件</title><link>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E7%9B%91%E5%90%AC-sream-%E5%92%8C-transport-%E7%9A%84%E4%BA%8B%E4%BB%B6/</link><pubDate>Wed, 23 Dec 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E7%9B%91%E5%90%AC-sream-%E5%92%8C-transport-%E7%9A%84%E4%BA%8B%E4%BB%B6/</guid><description>&lt;p&gt;gRPC 提供了拦截器可以监听请求的事件，但是对于 Stream 或者 Transport 的具体事件，无法通过拦截器实现；gRPC 提供了 StreamTracer 和 TransportFilter 支持这样的能力&lt;/p&gt;
&lt;h2 id="streamtracer"&gt;StreamTracer&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;StreamTracer&lt;/code&gt; 用于监听流的所有事件，包括流关闭、出入站消息、出入站流大小等信息&lt;/p&gt;
&lt;p&gt;&lt;code&gt;StreamTracer&lt;/code&gt; 有用于客户端的 &lt;code&gt;ClientStreamTracer&lt;/code&gt; 和用于服务端的 &lt;code&gt;ServerStreamTracer&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="客户端"&gt;客户端&lt;/h3&gt;
&lt;p&gt;客户端的 &lt;code&gt;StreamTracer&lt;/code&gt; 在拦截器中注入，当有请求被执行时，可以向 &lt;code&gt;callOptions&lt;/code&gt; 添加自定义的 &lt;code&gt;ClientStreamTracer.Factory&lt;/code&gt;，这样就会创建相应的 &lt;code&gt;StreamTracer&lt;/code&gt;，实现监听&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CustomClientInterceptor.java&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在拦截器中指定&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomClientInterceptor&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;implements&lt;/span&gt; ClientInterceptor {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; ClientCall&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;interceptCall&lt;/span&gt;(MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; method, CallOptions callOptions, Channel next) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; callOptions &lt;span style="color:#f92672"&gt;=&lt;/span&gt; callOptions.&lt;span style="color:#a6e22e"&gt;withStreamTracerFactory&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomClientStreamTracerFactory&lt;span style="color:#f92672"&gt;&amp;lt;&amp;gt;&lt;/span&gt;(method, callOptions, next));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; next.&lt;span style="color:#a6e22e"&gt;newCall&lt;/span&gt;(method, callOptions);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;CustomClientStreamTracerFactory.java&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在实现类中重写需要监听的事件方法&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomClientStreamTracerFactory&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;extends&lt;/span&gt; ClientStreamTracer.&lt;span style="color:#a6e22e"&gt;Factory&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; method;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; CallOptions callOptions;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; Channel next;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomClientStreamTracerFactory&lt;/span&gt;(MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; method, CallOptions callOptions, Channel next) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;method&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; method;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;callOptions&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; callOptions;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;next&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; next;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; ClientStreamTracer &lt;span style="color:#a6e22e"&gt;newClientStreamTracer&lt;/span&gt;(ClientStreamTracer.&lt;span style="color:#a6e22e"&gt;StreamInfo&lt;/span&gt; info, Metadata headers) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomClientStreamTracer&lt;span style="color:#f92672"&gt;&amp;lt;&amp;gt;&lt;/span&gt;(method, callOptions, next, info, headers);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;@Slf4j&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomClientStreamTracer&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;extends&lt;/span&gt; ClientStreamTracer {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomClientStreamTracer&lt;/span&gt;(MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; method, CallOptions callOptions, Channel next, StreamInfo info, Metadata headers) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Method:&amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; method.&lt;span style="color:#a6e22e"&gt;getFullMethodName&lt;/span&gt;() &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34; Next:&amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; next.&lt;span style="color:#a6e22e"&gt;authority&lt;/span&gt;() &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34; Header: &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; headers.&lt;span style="color:#a6e22e"&gt;toString&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="服务端"&gt;服务端&lt;/h3&gt;
&lt;p&gt;服务端的 &lt;code&gt;StreamTracer&lt;/code&gt; 在构建 Server 时指定，在执行请求时会监听相应的方法&lt;/p&gt;</description></item><item><title>gRPC Server 端请求处理流程</title><link>https://blog.hellowood.dev/posts/grpc-server-%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</link><pubDate>Tue, 15 Dec 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-server-%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id="初始化"&gt;初始化&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;创建并启动 ServerTransport&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在 Server 启动的时候，最终调用 &lt;code&gt;NettyServer&lt;/code&gt; 的 &lt;code&gt;start()&lt;/code&gt; 方法，为 &lt;code&gt;ServerBootstrap&lt;/code&gt; 添加了 &lt;code&gt;ChannelInitializer&lt;/code&gt;，最终，当有新的连接建立时，会由 &lt;code&gt;NettyServerHandler&lt;/code&gt; 调用该类的 &lt;code&gt;initChannel&lt;/code&gt; 方法，初始化一个 &lt;code&gt;NettyServerTransport&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.netty.NettyServer#start&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在初始化 Netty Channel 时，会先创建 &lt;code&gt;NettyServerTransport&lt;/code&gt;，然后调用监听器的 &lt;code&gt;Transport&lt;/code&gt; 创建事件，添加一个超时取消任务；
然后会调用 &lt;code&gt;Transport&lt;/code&gt; 的 &lt;code&gt;start&lt;/code&gt; 方法启动 &lt;code&gt;Transport&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;b.&lt;span style="color:#a6e22e"&gt;childHandler&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ChannelInitializer&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;Channel&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;initChannel&lt;/span&gt;(Channel ch) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 构建基于 Netty 的 ServerTransport&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; NettyServerTransport transport &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; NettyServerTransport(&lt;span style="color:#75715e"&gt;/*...*/&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ServerTransportListener transportListener;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;synchronized&lt;/span&gt; (NettyServer.&lt;span style="color:#a6e22e"&gt;this&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 调用监听器回调，Transport 创建事件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; transportListener &lt;span style="color:#f92672"&gt;=&lt;/span&gt; listener.&lt;span style="color:#a6e22e"&gt;transportCreated&lt;/span&gt;(transport);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 启动监听器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; transport.&lt;span style="color:#a6e22e"&gt;start&lt;/span&gt;(transportListener);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ChannelFutureListener loopReleaser &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; LoopReleaser();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; channelDone.&lt;span style="color:#a6e22e"&gt;addListener&lt;/span&gt;(loopReleaser);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ch.&lt;span style="color:#a6e22e"&gt;closeFuture&lt;/span&gt;().&lt;span style="color:#a6e22e"&gt;addListener&lt;/span&gt;(loopReleaser);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.netty.NettyServerTransport#start&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在启动 &lt;code&gt;Transport&lt;/code&gt; 时，会为当前的 &lt;code&gt;Transport&lt;/code&gt; 创建一个处理器，并绑定到 Netty 的 Channel 中&lt;/p&gt;</description></item><item><title>gRPC Server 端关闭流程</title><link>https://blog.hellowood.dev/posts/grpc-server-%E7%AB%AF%E5%85%B3%E9%97%AD%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 05 Dec 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-server-%E7%AB%AF%E5%85%B3%E9%97%AD%E6%B5%81%E7%A8%8B/</guid><description>&lt;h2 id="关闭-server"&gt;关闭 Server&lt;/h2&gt;
&lt;p&gt;关闭 Server 可以使用 &lt;code&gt;shutdown&lt;/code&gt; 或者 &lt;code&gt;shutdownNow&lt;/code&gt; 方法&lt;/p&gt;
&lt;h4 id="shutdown"&gt;shutdown&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;server.&lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;().&lt;span style="color:#a6e22e"&gt;awaitTermination&lt;/span&gt;(10, TimeUnit.&lt;span style="color:#a6e22e"&gt;SECONDS&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ServerImpl#shutdown&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;开始顺序的关闭 Server，已经存在的请求会继续执行，新的请求会被拒绝&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; ServerImpl &lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;boolean&lt;/span&gt; shutdownTransportServers;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;synchronized&lt;/span&gt; (lock) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (shutdown) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; shutdown &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; shutdownTransportServers &lt;span style="color:#f92672"&gt;=&lt;/span&gt; started;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (&lt;span style="color:#f92672"&gt;!&lt;/span&gt;shutdownTransportServers) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; transportServersTerminated &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 检查是否终止&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; checkForTermination();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (shutdownTransportServers) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 遍历所有的 Server 并关闭&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; (InternalServer ts : transportServers) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ts.&lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;关闭时，首先会检查 Server 是否已经关闭了，如果已经关闭了，则抛出异常；如果没有关闭，则会修改关闭状态，返huan连接池，通知其他的锁；
然后会遍历所有的 Server，调用其 &lt;code&gt;shutdown&lt;/code&gt; 方法进行关闭&lt;/p&gt;</description></item><item><title>gRPC Server 端启动流程</title><link>https://blog.hellowood.dev/posts/grpc-server-%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 05 Dec 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-server-%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;gRPC Server 启动流程，底层实现以 Netty 为例；&lt;/p&gt;
&lt;h2 id="核心类"&gt;核心类&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;io.grpc.Server&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Server 的定义接口，实现类是 &lt;code&gt;io.grpc.internal.ServerImpl&lt;/code&gt;，实现了服务、方法与方法处理器的绑定，端口监听，不同类型的 Server 实现的调用，Server 生命周期管理等&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;io.grpc.BindableService&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由编译器生成的服务抽象类的基础接口，并将实现类绑定到服务器，提供将服务的实现的实例绑定到 Server 的方式&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;io.grpc.ServerInterceptor&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Server 端的拦截器，在方法调用之前会被调用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;io.grpc.HandlerRegistry&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;方法处理器注册器，所有的方法注册器会注册在这里，通过服务名和方法名查找&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;io.grpc.ServerServiceDefinition&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;服务定义，包含服务描述信息，方法信息集合&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;io.grpc.ServerMethodDefinition&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;方法定义，包含方法描述信息，方法处理器&lt;/p&gt;
&lt;h2 id="启动流程"&gt;启动流程&lt;/h2&gt;
&lt;h3 id="启动大致流程"&gt;启动大致流程&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;创建 &lt;code&gt;ServerBuilder&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;指定端口&lt;/li&gt;
&lt;li&gt;为 &lt;code&gt;ServerBuilder&lt;/code&gt; 添加方法
&lt;ol&gt;
&lt;li&gt;构建服务定义
&lt;ol&gt;
&lt;li&gt;通过生成的代码构建方法定义，将方法与处理器绑定&lt;/li&gt;
&lt;li&gt;将方法处理器添加到方法定义中&lt;/li&gt;
&lt;li&gt;将服务定义添加到服务注册器中&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;添加拦截器等其他的配置&lt;/li&gt;
&lt;li&gt;构建 &lt;code&gt;Server&lt;/code&gt; 实例
&lt;ol&gt;
&lt;li&gt;构建 &lt;code&gt;ServerTransport&lt;/code&gt; 实例 2. 遍历所有监听的地址，创建相应的 &lt;code&gt;NettyServer&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;启动 &lt;code&gt;Server&lt;/code&gt;
&lt;ol&gt;
&lt;li&gt;遍历所有的 &lt;code&gt;NettyServer&lt;/code&gt;，调用 &lt;code&gt;start&lt;/code&gt; 方法启动
&lt;ol&gt;
&lt;li&gt;创建相应的 &lt;code&gt;ServerBootstrap&lt;/code&gt;，绑定监听的地址，可以接受连接&lt;/li&gt;
&lt;li&gt;创建 &lt;code&gt;NettyServerTransport&lt;/code&gt;，调用 &lt;code&gt;start&lt;/code&gt; 方法启动 &lt;code&gt;Transport&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;为 &lt;code&gt;NettyServerTransport&lt;/code&gt; 创建 &lt;code&gt;NettyServerHandler&lt;/code&gt;，用于处理请求&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;保持 &lt;code&gt;Server&lt;/code&gt; 启动状态，启动完成&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="server-定义"&gt;Server 定义&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Server server &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ServerBuilder.&lt;span style="color:#a6e22e"&gt;forPort&lt;/span&gt;(1234)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;addService&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; HelloServiceImpl())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;intercept&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomServerInterceptor())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;server.&lt;span style="color:#a6e22e"&gt;start&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;server.&lt;span style="color:#a6e22e"&gt;awaitTermination&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="绑定端口"&gt;绑定端口&lt;/h4&gt;
&lt;p&gt;指定了要监听的端口，会根据不同的 &lt;code&gt;Server&lt;/code&gt; 实现绑定端口&lt;/p&gt;</description></item><item><title>gRPC Channel</title><link>https://blog.hellowood.dev/posts/grpc-channel/</link><pubDate>Wed, 18 Nov 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-channel/</guid><description>&lt;p&gt;&lt;code&gt;Channel&lt;/code&gt; 是用于执行 RPC 请求的概念上的端点连接，基于负载和配置，一个 &lt;code&gt;Channel&lt;/code&gt; 可以有 0 或多个真实连接&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Subchannel&lt;/code&gt; 代表逻辑连接，最多维护一个物理连接发送 RPC，对应多个 Transport&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-channel-class-diagram.png" alt="grpc-source-code-channel-class-diagram.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;Channel 有多个子类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ManagedChannel&lt;/code&gt;： 实现了生命周期管理能力的抽象子类
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ManagedChannelImpl&lt;/code&gt;： &lt;code&gt;ManagedChannel&lt;/code&gt; 的实现类，&lt;code&gt;Channel&lt;/code&gt; 的主要实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ManagedChannelOrphanWrapper&lt;/code&gt;: &lt;code&gt;ManagedChannel&lt;/code&gt; 的包装类，用于引用 &lt;code&gt;ManagedChannel&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RealChannel&lt;/code&gt;：真正执行创建 &lt;code&gt;ClientCallImpl&lt;/code&gt; 实例&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SubchannelAsChannel&lt;/code&gt;: 将 &lt;code&gt;Subchannel&lt;/code&gt; 转为 &lt;code&gt;Channel&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Subchannel 的子类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;SubchannelImpl&lt;/code&gt;：Subchannel 的实现类&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="方法"&gt;方法&lt;/h2&gt;
&lt;h3 id="channel"&gt;Channel&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;发起调用&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;abstract&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;RequestT, ResponseT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; ClientCall&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;RequestT, ResponseT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;newCall&lt;/span&gt;(MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;RequestT, ResponseT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; methodDescriptor, CallOptions callOptions);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;目标地址&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;abstract&lt;/span&gt; String &lt;span style="color:#a6e22e"&gt;authority&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="managedchannel"&gt;ManagedChannel&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;ManagedChannel&lt;/code&gt; 是 &lt;code&gt;Channel&lt;/code&gt; 的子类，提供生命周期管理的 &lt;code&gt;Channel&lt;/code&gt;；由 &lt;code&gt;ManagedChannelImpl&lt;/code&gt; 实现功能&lt;/p&gt;
&lt;h5 id="关闭"&gt;关闭&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;shutdown&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;初始化一个顺序关闭，既有的调用会继续执行，但是新的调用会被立即取消&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;abstract&lt;/span&gt; ManagedChannel &lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;shutdownNow&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;强制关闭 Channel，会取消所有的调用；即使是强制关闭也不会瞬间停止&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;abstract&lt;/span&gt; ManagedChannel &lt;span style="color:#a6e22e"&gt;shutdownNow&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;isShutdown&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;返回 &lt;code&gt;Channel&lt;/code&gt; 是否终止，终止的 &lt;code&gt;Channel&lt;/code&gt; 没有执行中的调用，相关的资源被释放&lt;/p&gt;</description></item><item><title>gRPC Client 启动流程</title><link>https://blog.hellowood.dev/posts/grpc-client-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</link><pubDate>Tue, 17 Nov 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-client-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;gRPC 启动初始化的流程，使用 Netty 作为底层的实现&lt;/p&gt;
&lt;h2 id="初始化-channel"&gt;初始化 Channel&lt;/h2&gt;
&lt;p&gt;Channel 的初始化通过 &lt;code&gt;ChannelBuilder&lt;/code&gt; 构建
这里通过 &lt;code&gt;forTarget&lt;/code&gt; 设置了要解析的服务名称，会通过 &lt;code&gt;NameResolver&lt;/code&gt; 解析，转换为具体的地址&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ManagedChannel channel &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ManagedChannelBuilder.&lt;span style="color:#a6e22e"&gt;forTarget&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;grpc-server&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;usePlaintext&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;构建 ManagedChannel 实例&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;io.grpc.internal.AbstractManagedChannelImplBuilder#build&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;调用 build 时，会根据 builder 中的属性，创建 &lt;code&gt;ManagedChannelImpl&lt;/code&gt; 的实例&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; ManagedChannel &lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ManagedChannelOrphanWrapper(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ManagedChannelImpl(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 构建 Transport 工厂&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; buildTransportFactory(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ExponentialBackoffPolicy.&lt;span style="color:#a6e22e"&gt;Provider&lt;/span&gt;(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 线程池&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; SharedResourcePool.&lt;span style="color:#a6e22e"&gt;forResource&lt;/span&gt;(GrpcUtil.&lt;span style="color:#a6e22e"&gt;SHARED_CHANNEL_EXECUTOR&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 计时器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; GrpcUtil.&lt;span style="color:#a6e22e"&gt;STOPWATCH_SUPPLIER&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 统计和追踪拦截器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; getEffectiveInterceptors(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 时间提供器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; TimeProvider.&lt;span style="color:#a6e22e"&gt;SYSTEM_TIME_PROVIDER&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="初始化-channel-属性"&gt;初始化 Channel 属性&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ManagedChannelImpl#ManagedChannelImpl&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为 &lt;code&gt;ManagedChannel&lt;/code&gt; 设置属性，初始化服务发现，负载均衡，拦截器等并创建真正的 Channel&lt;/p&gt;</description></item><item><title>gRPC Stream</title><link>https://blog.hellowood.dev/posts/grpc-stream/</link><pubDate>Sun, 08 Nov 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-stream/</guid><description>&lt;p&gt;Stream 在 gRPC 中代表一个真正的请求，包含要发送的 消息；Stream 分为 &lt;code&gt;ClientStream&lt;/code&gt; 和 &lt;code&gt;ServerStream&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-stream-diagram.png" alt="grpc-source-code-stream-diagram.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;h2 id="clientstream"&gt;ClientStream&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;ClientStream&lt;/code&gt; 接口继承 Stream 接口，有多个实现类或抽象实现类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ForwardingClientStream&lt;/code&gt;: 用于转发的 &lt;code&gt;ClientStream&lt;/code&gt;，支持代理真正的流，可以用于触发一些动作，如统计等&lt;/li&gt;
&lt;li&gt;&lt;code&gt;NoopClientStream&lt;/code&gt;: 不做任何操作的 &lt;code&gt;ClientStream&lt;/code&gt;，用于空实现
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;FailingClientStream&lt;/code&gt;: 用于失败的 &lt;code&gt;ClientStream&lt;/code&gt;，处理请求失败的场景&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;InProcessClientStream&lt;/code&gt;: 进程内的 &lt;code&gt;ClientStream&lt;/code&gt;，用于测试，不会发出实际请求&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractClientStream&lt;/code&gt;: &lt;code&gt;ClientStream&lt;/code&gt; 的抽象实现类，实现了部分基础操作，如发送header，写入消息，半关闭等
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;NettyClientStream&lt;/code&gt;: 基于 Netty 实现的 &lt;code&gt;ClientStream&lt;/code&gt;，实现了基于 Netty 的帧操作等&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OkHttpClientStream&lt;/code&gt;: 基于 OkHttp 实现的 &lt;code&gt;ClientStream&lt;/code&gt;，实现了基于 OkHttp 的帧操作等&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="方法"&gt;方法&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;start&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;开始一个新的流，对于每一个流，只能调用一次&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;start&lt;/span&gt;(ClientStreamListener listener);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;halfClose&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;从客户端关闭流，当关闭后，不能发送更多的消息，但是可以接收消息，只能调用一次&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;halfClose&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;cancel&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;异常终止流，当调用后不会再发送和接收消息，只有在 start 之后才可以被调用&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(Status reason);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;setDeadline&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;设置请求有效截止时间，过了这个时间之后就会终止请求执行&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;setDeadline&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;@Nonnull&lt;/span&gt; Deadline deadline);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;getAttributes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;获取流的属性&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Attributes &lt;span style="color:#a6e22e"&gt;getAttributes&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="监听器"&gt;监听器&lt;/h3&gt;
&lt;p&gt;ClientStreamListener 用于监听客户端流的事件&lt;/p&gt;</description></item><item><title>gRPC Transport</title><link>https://blog.hellowood.dev/posts/grpc-transport/</link><pubDate>Thu, 22 Oct 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-transport/</guid><description>&lt;p&gt;Transport 分为 &lt;code&gt;ClientTransport&lt;/code&gt; 和 &lt;code&gt;ServerTransport&lt;/code&gt;，分别用于客户端和服务端&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-transport-classes-diagram.png" alt="grpc-source-code-transport-classes-diagram.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;h2 id="clienttransport"&gt;ClientTransport&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;ClientTransport&lt;/code&gt; 与真正的 IP 地址是一一对应的，用于建立连接，创建流&lt;/p&gt;
&lt;h3 id="实现"&gt;实现&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;ClientTransport&lt;/code&gt; 有多个继承接口和实现类:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;支持失败的实现类 &lt;code&gt;FailingClientTransport&lt;/code&gt;，客户端启动时创建的流会快速失败&lt;/li&gt;
&lt;li&gt;支持生命周期管理的接口 &lt;code&gt;ManagedClientTransport&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;支持延迟处理的实现类 &lt;code&gt;DelayedClientTransport&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;基于连接的接口 &lt;code&gt;ConnectionClientTransport&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;基于 Netty 实现的 &lt;code&gt;NettyClientTransport&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;基于 OkHttp 实现的 &lt;code&gt;OkHttpClientTransport&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;用于进程内处理请求 &lt;code&gt;InProcessTransport&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;支持代理的抽象实现类 &lt;code&gt;ForwardingConnectionClientTransport&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;支持授权检查的实现类 &lt;code&gt;CallCredentialsApplyingTransportFactory&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;用于统计的 &lt;code&gt;CallTracingTransport&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="方法"&gt;方法&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ClientTransport#newStream&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;创建新的流，用于给远程服务端发送消息&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ClientStream &lt;span style="color:#a6e22e"&gt;newStream&lt;/span&gt;(MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;?&lt;/span&gt;, &lt;span style="color:#f92672"&gt;?&amp;gt;&lt;/span&gt; method, Metadata headers, CallOptions callOptions);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ClientTransport#ping&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ping 远程的端点，当收到 ack 之后，会使用所给的 Executor 执行回调&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;ping&lt;/span&gt;(PingCallback callback, Executor executor);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ManagedClientTransport#start&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;启动 Transport，尝试建立连接，并启动监听器&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Runnable &lt;span style="color:#a6e22e"&gt;start&lt;/span&gt;(Listener listener);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="监听器"&gt;监听器&lt;/h3&gt;
&lt;p&gt;Transport 的 Listener 用于监听 Transport 事件，进行相应的处理&lt;/p&gt;</description></item><item><title>gRPC 使用自定义的 LoadBalancer</title><link>https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-loadbalancer/</link><pubDate>Tue, 29 Sep 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-loadbalancer/</guid><description>&lt;p&gt;gRPC 中提供了 &lt;code&gt;round_robin&lt;/code&gt;, &lt;code&gt;pick_first&lt;/code&gt;, &lt;code&gt;grpclb&lt;/code&gt;, &lt;code&gt;HealthCheckingRoundRobin&lt;/code&gt; 等负载均衡的实现，默认使用&lt;code&gt;HealthCheckingRoundRobin&lt;/code&gt;，该负载均衡支持检查 Subchannel 的健康状态&lt;/p&gt;
&lt;p&gt;LoadBalancer 主要类包括 &lt;code&gt;LoadBalancerProvider&lt;/code&gt;, &lt;code&gt;LoadBalancer&lt;/code&gt;, &lt;code&gt;SubchannelPicker&lt;/code&gt;, &lt;code&gt;LoadBalancer.SubchannelStateListener &lt;/code&gt;，所以实现自定义的 LoadBalancer 实现这几个类就可以&lt;/p&gt;
&lt;h2 id="实现自定义的-loadbalancer"&gt;实现自定义的 LoadBalancer&lt;/h2&gt;
&lt;p&gt;自定义实现一个轮询策略的负载均衡器&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CustomLoadBalancerProvider.java&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomLoadBalancerProvider&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;extends&lt;/span&gt; LoadBalancerProvider {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;boolean&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;isAvailable&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;int&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;getPriority&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; 10;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; String &lt;span style="color:#a6e22e"&gt;getPolicyName&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;custom_round_robin&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; LoadBalancer &lt;span style="color:#a6e22e"&gt;newLoadBalancer&lt;/span&gt;(LoadBalancer.&lt;span style="color:#a6e22e"&gt;Helper&lt;/span&gt; helper) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomLoadBalancer(helper);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;CustomLoadBalancer.java&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在 CustomLoadBalancer 中实现了地址的处理，根据地址创建 Subchannel，并启动 Subchannel 状态监听器&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;@Slf4j&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomLoadBalancer&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;extends&lt;/span&gt; LoadBalancer {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;static&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; Attributes.&lt;span style="color:#a6e22e"&gt;Key&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;Ref&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ConnectivityState&lt;span style="color:#f92672"&gt;&amp;gt;&amp;gt;&lt;/span&gt; STATE_INFO &lt;span style="color:#f92672"&gt;=&lt;/span&gt; Attributes.&lt;span style="color:#a6e22e"&gt;Key&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;create&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;state-info&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; Helper helper;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Map&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;EquivalentAddressGroup, Subchannel&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; subchannelMap &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ConcurrentHashMap&lt;span style="color:#f92672"&gt;&amp;lt;&amp;gt;&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomLoadBalancer&lt;/span&gt;(Helper helper) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;helper&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; helper;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;handleResolvedAddresses&lt;/span&gt;(ResolvedAddresses resolvedAddresses) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;处理地址:{}&amp;#34;&lt;/span&gt;, resolvedAddresses.&lt;span style="color:#a6e22e"&gt;getAddresses&lt;/span&gt;().&lt;span style="color:#a6e22e"&gt;toString&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 将解析的地址分割成单个 Address&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; List&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;EquivalentAddressGroup&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; latestAddresses &lt;span style="color:#f92672"&gt;=&lt;/span&gt; resolvedAddresses.&lt;span style="color:#a6e22e"&gt;getAddresses&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;flatMap&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;::splitAddressCollection)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;distinct&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;collect&lt;/span&gt;(Collectors.&lt;span style="color:#a6e22e"&gt;toList&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 已经存在的地址&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Set&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;EquivalentAddressGroup&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; originAddresses &lt;span style="color:#f92672"&gt;=&lt;/span&gt; subchannelMap.&lt;span style="color:#a6e22e"&gt;keySet&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 对新的 Address 创建 Subchannel&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Map&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;EquivalentAddressGroup, Subchannel&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; newSubchannelMap &lt;span style="color:#f92672"&gt;=&lt;/span&gt; latestAddresses.&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;filter&lt;/span&gt;(e &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; &lt;span style="color:#f92672"&gt;!&lt;/span&gt;originAddresses.&lt;span style="color:#a6e22e"&gt;contains&lt;/span&gt;(e))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;map&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;::buildCreateSubchannelArgs)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;map&lt;/span&gt;(helper::createSubchannel)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;map&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;::processSubchannel)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;collect&lt;/span&gt;(Collectors.&lt;span style="color:#a6e22e"&gt;toConcurrentMap&lt;/span&gt;(Subchannel::getAddresses, s &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; s));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 将已存在的 Subchannel 放到新的集合中&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; originAddresses.&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;filter&lt;/span&gt;(latestAddresses::contains)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;forEach&lt;/span&gt;(e &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; newSubchannelMap.&lt;span style="color:#a6e22e"&gt;put&lt;/span&gt;(e, subchannelMap.&lt;span style="color:#a6e22e"&gt;get&lt;/span&gt;(e)));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 关闭需要移除的 Subchannel&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; originAddresses.&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;filter&lt;/span&gt;(e &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; &lt;span style="color:#f92672"&gt;!&lt;/span&gt;latestAddresses.&lt;span style="color:#a6e22e"&gt;contains&lt;/span&gt;(e))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;map&lt;/span&gt;(e &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; subchannelMap.&lt;span style="color:#a6e22e"&gt;get&lt;/span&gt;(e))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;forEach&lt;/span&gt;(Subchannel::shutdown);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; subchannelMap &lt;span style="color:#f92672"&gt;=&lt;/span&gt; newSubchannelMap;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; CreateSubchannelArgs &lt;span style="color:#a6e22e"&gt;buildCreateSubchannelArgs&lt;/span&gt;(EquivalentAddressGroup e) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; CreateSubchannelArgs.&lt;span style="color:#a6e22e"&gt;newBuilder&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setAddresses&lt;/span&gt;(e)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setAttributes&lt;/span&gt;(Attributes.&lt;span style="color:#a6e22e"&gt;newBuilder&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;set&lt;/span&gt;(STATE_INFO, &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; Ref&lt;span style="color:#f92672"&gt;&amp;lt;&amp;gt;&lt;/span&gt;(IDLE))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; Stream&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;EquivalentAddressGroup&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;splitAddressCollection&lt;/span&gt;(EquivalentAddressGroup equivalentAddressGroup) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Attributes attributes &lt;span style="color:#f92672"&gt;=&lt;/span&gt; equivalentAddressGroup.&lt;span style="color:#a6e22e"&gt;getAttributes&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; equivalentAddressGroup.&lt;span style="color:#a6e22e"&gt;getAddresses&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;map&lt;/span&gt;(e &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; EquivalentAddressGroup(e, attributes));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; Subchannel &lt;span style="color:#a6e22e"&gt;processSubchannel&lt;/span&gt;(Subchannel subchannel) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (subchannelMap.&lt;span style="color:#a6e22e"&gt;containsValue&lt;/span&gt;(subchannel)) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;{} {} 已经存在&amp;#34;&lt;/span&gt;, subchannel, subchannel.&lt;span style="color:#a6e22e"&gt;getAddresses&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; subchannel;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; subchannel.&lt;span style="color:#a6e22e"&gt;start&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomSubchannelStateListener(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;, subchannel, helper));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; subchannel.&lt;span style="color:#a6e22e"&gt;requestConnection&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; subchannel;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;handleNameResolutionError&lt;/span&gt;(Status error) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;命名解析失败:{}&amp;#34;&lt;/span&gt;, error);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; helper.&lt;span style="color:#a6e22e"&gt;updateBalancingState&lt;/span&gt;(ConnectivityState.&lt;span style="color:#a6e22e"&gt;TRANSIENT_FAILURE&lt;/span&gt;, &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; CustomSubchannelPicker(PickResult.&lt;span style="color:#a6e22e"&gt;withNoResult&lt;/span&gt;()));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; subchannelMap.&lt;span style="color:#a6e22e"&gt;values&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;peek&lt;/span&gt;(s &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; log.&lt;span style="color:#a6e22e"&gt;info&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;关闭 {} {}&amp;#34;&lt;/span&gt;, s, s.&lt;span style="color:#a6e22e"&gt;getAddresses&lt;/span&gt;()))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;forEach&lt;/span&gt;(Subchannel::shutdown);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; Map&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;EquivalentAddressGroup, Subchannel&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;getSubchannelMap&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ConcurrentHashMap&lt;span style="color:#f92672"&gt;&amp;lt;&amp;gt;&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;subchannelMap&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;CustomSubchannelStateListener.java&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Subchannel 的状态监听器，当 Subchannel 状态发生变化时进行处理&lt;/p&gt;</description></item><item><title>gRPC 超时时间与重试时间间隔</title><link>https://blog.hellowood.dev/posts/grpc-%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4%E4%B8%8E%E9%87%8D%E8%AF%95%E6%97%B6%E9%97%B4%E9%97%B4%E9%9A%94/</link><pubDate>Sun, 20 Sep 2020 22:41:50 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4%E4%B8%8E%E9%87%8D%E8%AF%95%E6%97%B6%E9%97%B4%E9%97%B4%E9%9A%94/</guid><description>&lt;blockquote&gt;
&lt;p&gt;gRPC 的超时时间生效机制以及重试超时时间间隔&lt;/p&gt;&lt;/blockquote&gt;
&lt;h2 id="超时时间配置"&gt;超时时间配置&lt;/h2&gt;
&lt;p&gt;对指定的服务和方法单独设置超时时间，timeout 作用于所有的 RPC 请求（无论是否重试，都会在 timeout 的时间之后超时，进行中的重试请求会被取消）&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-json" data-lang="json"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;methodConfig&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;: [
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;service&amp;#34;&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;io.github.helloworlde.grpc.UserInfoService&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ],
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;retryPolicy&amp;#34;&lt;/span&gt;: {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;maxAttempts&amp;#34;&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;initialBackoff&amp;#34;&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;0.01s&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;maxBackoff&amp;#34;&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;0.1s&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;backoffMultiplier&amp;#34;&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;retryableStatusCodes&amp;#34;&lt;/span&gt;: [&lt;span style="color:#e6db74"&gt;&amp;#34;UNAVAILABLE&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; },
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;waitForReady&amp;#34;&lt;/span&gt;: &lt;span style="color:#66d9ef"&gt;false&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;#34;timeout&amp;#34;&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;3s&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="重试时间间隔"&gt;重试时间间隔&lt;/h2&gt;
&lt;p&gt;gRPC 的重试时间间隔是由 &lt;code&gt;initialBackoff&lt;/code&gt;, &lt;code&gt;maxBackoff&lt;/code&gt;, &lt;code&gt;backoffMultiplier&lt;/code&gt; 共同决定的，实现方法是 &lt;code&gt;io.grpc.internal.RetriableStream.Sublistener#makeRetryDecision&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (retryPolicy.&lt;span style="color:#a6e22e"&gt;maxAttempts&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; substream.&lt;span style="color:#a6e22e"&gt;previousAttemptCount&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; 1 &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#f92672"&gt;!&lt;/span&gt;isThrottled) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (pushbackMillis &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;null&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (isRetryableStatusCode) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; shouldRetry &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; backoffNanos &lt;span style="color:#f92672"&gt;=&lt;/span&gt; (&lt;span style="color:#66d9ef"&gt;long&lt;/span&gt;) (nextBackoffIntervalNanos &lt;span style="color:#f92672"&gt;*&lt;/span&gt; random.&lt;span style="color:#a6e22e"&gt;nextDouble&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nextBackoffIntervalNanos &lt;span style="color:#f92672"&gt;=&lt;/span&gt; Math.&lt;span style="color:#a6e22e"&gt;min&lt;/span&gt;((&lt;span style="color:#66d9ef"&gt;long&lt;/span&gt;) (nextBackoffIntervalNanos &lt;span style="color:#f92672"&gt;*&lt;/span&gt; retryPolicy.&lt;span style="color:#a6e22e"&gt;backoffMultiplier&lt;/span&gt;), retryPolicy.&lt;span style="color:#a6e22e"&gt;maxBackoffNanos&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#66d9ef"&gt;else&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (pushbackMillis &lt;span style="color:#f92672"&gt;&amp;gt;=&lt;/span&gt; 0) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; shouldRetry &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; backoffNanos &lt;span style="color:#f92672"&gt;=&lt;/span&gt; TimeUnit.&lt;span style="color:#a6e22e"&gt;MILLISECONDS&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;toNanos&lt;/span&gt;(pushbackMillis);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nextBackoffIntervalNanos &lt;span style="color:#f92672"&gt;=&lt;/span&gt; retryPolicy.&lt;span style="color:#a6e22e"&gt;initialBackoffNanos&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果开启了重试，且没有达到节流的限制，如果服务端有回推延时时间，则使用服务端回推的时间作为延时时间，初始延迟时间作为下次延时的初始时间；&lt;/p&gt;</description></item><item><title>gRPC 中的核心概念</title><link>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/</link><pubDate>Sun, 20 Sep 2020 22:40:59 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/</guid><description>&lt;h2 id="stub"&gt;Stub&lt;/h2&gt;
&lt;p&gt;Stub 层暴露给开发者，提供类型安全的绑定到正在适应的数据模型/IDL/接口&lt;/p&gt;
&lt;h2 id="channel"&gt;Channel&lt;/h2&gt;
&lt;p&gt;Channel 层是传输处理之上的抽象，适合拦截器、装饰器，并比 Stub 层暴露更多的行为给应用
一个 Channel 可能有多个 Subchannel&lt;/p&gt;
&lt;h3 id="subchannel"&gt;Subchannel&lt;/h3&gt;
&lt;p&gt;Subchannel 代表负载均衡过的 Channel&lt;/p&gt;
&lt;h3 id="channel-状态"&gt;Channel 状态&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;CONNECTING
Channel 正在尝试建立连接，并且正在等待名称解析，TCP连接建立或TLS握手所涉及的步骤之一，创建时可以将其用作通道的初始状态&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;READY
Channel 握手成功建立连接，并且所有的后续通信尝试均已成功(或未发生任何失败)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;TRANSIENT_FAILURE
发生了一些瞬时故障（例如TCP 3握手超时或套接字错误），处于此状态的通道最终将切换到 CONNECTING 状态，并尝试再次建立连接。由于重试是通过指数退避完成的，因此无法连接的通道在此状态下将开始花费很少的时间，但是由于尝试反复失败，因此通道在此状态下将花费越来越多的时间。对于许多非致命故障（例如，由于服务器尚不可用，TCP连接尝试超时），通道可能会在此状态下花费越来越多的时间&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;IDLE
由于缺少新的或待处理的RPC，Channel 甚至没有尝试创建连接的状态；可以在这种状态下创建新的RPC，任何在通道上启动RPC的尝试都将使该 Channel 退出此状态以进行连接。如果指定的 IDLE_TIMEOUT 的通道上没有 RPC 活动，即在此期间没有新的或挂起的（活动的）RPC，则 READY 或 CONNECTING 的通道将切换到 IDLE；此外，在没有活动或暂挂RPC的情况下接收 GOAWAY 的通道也应切换到 IDLE，以避免试图断开连接的服务器上的连接过载。我们将使用默认的IDLE_TIMEOUT 300秒（5分钟）。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SHUTDOWN
此频道已开始关闭，任何新的RPC应该立即失败，待处理的RPC可能会继续运行，直到应用程序将其取消为止。通道可能进入此状态，原因是应用程序明确请求关闭，或者尝试进行连接通信期间发生了不可恢复的错误。（截至2015年6月12日，（连接或通讯时没有已知的错误被归类为不可恢复。）进入此状态的通道永远不会离开此状态。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="transport"&gt;Transport&lt;/h2&gt;
&lt;p&gt;Transport 层承担在线上放置和获取字节的工作，被建模为 Stream 工厂，是真正的连接&lt;/p&gt;
&lt;p&gt;gRPC 有三个 Transport 实现：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;基于 Netty的 Transport 是主要的 Transport 实现，基于 Netty，可同时用于客户端和服务端&lt;/li&gt;
&lt;li&gt;基于 OkHttp 的 Transport 是轻量级的 Transport，基于 OkHttp，主要用于 Android 端并只作为客户端&lt;/li&gt;
&lt;li&gt;InProcess Transport 是当服务器和客户端在同一个进程内时使用，用于测试&lt;/li&gt;
&lt;/ol&gt;</description></item><item><title>gRPC 重试流程</title><link>https://blog.hellowood.dev/posts/grpc-%E9%87%8D%E8%AF%95%E6%B5%81%E7%A8%8B/</link><pubDate>Sun, 20 Sep 2020 22:40:07 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E9%87%8D%E8%AF%95%E6%B5%81%E7%A8%8B/</guid><description>&lt;p&gt;当第一次调用失败，流监听器关闭的时候，会根据请求的处理状态和方法的配置，判断是否需要重试&lt;/p&gt;
&lt;p&gt;请求的处理状态有三种，在&lt;code&gt;io.grpc.internal.ClientStreamListener.RpcProgress&lt;/code&gt;中定义：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;PROCESSED&lt;/code&gt;: 请求被正常处理，按照返回的状态码决定是否要重试&lt;/li&gt;
&lt;li&gt;&lt;code&gt;REFUSED&lt;/code&gt;: 没有被服务端的应用逻辑层处理，直接重试，不计入重试次数&lt;/li&gt;
&lt;li&gt;&lt;code&gt;DROPPED&lt;/code&gt;: 请求被负载均衡丢弃了，不重试，如果是对冲则取消其他的对冲请求，直接提交&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="发起请求"&gt;发起请求&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.stub.ClientCalls#blockingUnaryCall&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-java-blockingUnaryCall-diagram.png" alt="grpc-java-blockingUnaryCall-diagram.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ClientCallImpl#startInternal&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-java-client-call-start.png" alt="grpc-java-client-call-start.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ManagedChannelImpl.ChannelTransportProvider#newRetriableStream&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-java-transport-provider-new-retriable-stream.png" alt="grpc-java-transport-provider-new-retriable-stream.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.RetriableStream#start&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-java-retriable-stream-start.png" alt="grpc-java-retriable-stream-start.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.RetriableStream#createSubstream&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-java-retriable-stream-create-sub-stream.png" alt="grpc-java-retriable-stream-create-sub-stream.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ManagedChannelImpl.ChannelTransportProvider#newRetriableStream#RetryStream#newSubstream&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-java-retriable-stream-new-sub-stream.png" alt="grpc-java-retriable-stream-new-sub-stream.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过生成的代码中的方法，调用 &lt;code&gt;io.grpc.stub.ClientCalls#blockingUnaryCall&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;首先通过 channel 创建&lt;code&gt;ClientCall&lt;/code&gt;，然后通过 &lt;code&gt;futureUnaryCall&lt;/code&gt; 提交请求，返回 Future，根据返回的 Future 循环等待，通过&lt;code&gt;executor.waitAndDrain()&lt;/code&gt;执行请求，直到 Future 完成，返回结果&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;static&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; RespT &lt;span style="color:#a6e22e"&gt;blockingUnaryCall&lt;/span&gt;(Channel channel,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; MethodDescriptor&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; method,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; CallOptions callOptions,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ReqT req) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 创建新的调用的 ClientCall，指定了调用类型和执行器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ClientCall&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; call &lt;span style="color:#f92672"&gt;=&lt;/span&gt; channel.&lt;span style="color:#a6e22e"&gt;newCall&lt;/span&gt;(method, callOptions.&lt;span style="color:#a6e22e"&gt;withOption&lt;/span&gt;(ClientCalls.&lt;span style="color:#a6e22e"&gt;STUB_TYPE_OPTION&lt;/span&gt;, StubType.&lt;span style="color:#a6e22e"&gt;BLOCKING&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;withExecutor&lt;/span&gt;(executor));
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 执行调用，发出请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ListenableFuture&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; responseFuture &lt;span style="color:#f92672"&gt;=&lt;/span&gt; futureUnaryCall(call, req);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;while&lt;/span&gt; (&lt;span style="color:#f92672"&gt;!&lt;/span&gt;responseFuture.&lt;span style="color:#a6e22e"&gt;isDone&lt;/span&gt;()) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	 &lt;span style="color:#75715e"&gt;// 执行提交的 Runnable&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; executor.&lt;span style="color:#a6e22e"&gt;waitAndDrain&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; } &lt;span style="color:#66d9ef"&gt;catch&lt;/span&gt; (InterruptedException e) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; interrupt &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; call.&lt;span style="color:#a6e22e"&gt;cancel&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Thread interrupted&amp;#34;&lt;/span&gt;, e);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; getUnchecked(responseFuture);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start="2"&gt;
&lt;li&gt;执行 unary 调用 &lt;code&gt;futureUnaryCall&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里创建了 Future，通过 &lt;code&gt;asyncUnaryRequestCall&lt;/code&gt; 继续调用&lt;/p&gt;</description></item><item><title>gRPC 对冲原理</title><link>https://blog.hellowood.dev/posts/grpc-%E5%AF%B9%E5%86%B2%E5%8E%9F%E7%90%86/</link><pubDate>Sun, 20 Sep 2020 22:39:26 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E5%AF%B9%E5%86%B2%E5%8E%9F%E7%90%86/</guid><description>&lt;p&gt;gRPC 对冲开启后，当请求在指定的时间间隔后没有返回时，会发起对冲请求，继续等待，如果依然没有返回，则重复发送直到接收到返回结果或者超时取消&lt;/p&gt;
&lt;p&gt;对冲适用于当下游服务部分节点故障无法及时响应或者响应不及时的场景，通过对冲可以减少请求的失败率，但是可能会导致延时增加&lt;/p&gt;
&lt;p&gt;对冲和重试的流程相似，在第一次发起请求的时候根据服务名和方法名决定使用哪种策略；如果是对冲策略，则在发起请求时提交一个延时任务，这个任务会发起一个新的请求，并在执行的时候再发起一个请求，并将这些请求添加到队列中；多个请求哪个先返回就使用哪个请求的结果，将其他的请求取消并提交流&lt;/p&gt;
&lt;h2 id="执行流程"&gt;执行流程&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.RetriableStream#start&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;开始第一个 RPC 调用&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt; @Override
 public final void start(ClientStreamListener listener) {
 // 构造一个 BufferEntry
 class StartEntry implements BufferEntry {
 @Override
 public void runWith(Substream substream) {
 substream.stream.start(new Sublistener(substream));
 }
 }

 synchronized (lock) {
 // 新建 BufferEntry，添加到 buffer 中
 state.buffer.add(new StartEntry());
 }

 // 创建 Substream
 Substream substream = createSubstream(0);
 hedgingPolicy = hedgingPolicyProvider.get();
 // 如果有对冲策略
 if (!HedgingPolicy.DEFAULT.equals(hedgingPolicy)) {
 // 如果对冲策略有效，则将重试策略置为 null
 isHedging = true;
 retryPolicy = RetryPolicy.DEFAULT;

 FutureCanceller scheduledHedgingRef = null;

 synchronized (lock) {
 // 将这个流添加到对冲中
 state = state.addActiveHedge(substream);
 // 没有提交的流，且没有达到最大对冲次数，且没有终止，且没有节流或没有达到节流阈值
 // 则创建对冲 Future
 if (hasPotentialHedging(state) &amp;amp;&amp;amp; (throttle == null || throttle.isAboveThreshold())) {
 scheduledHedging = scheduledHedgingRef = new FutureCanceller(lock);
 }
 }

 // 如果对冲请求不为空，则提交延时任务
 if (scheduledHedgingRef != null) {
 scheduledHedgingRef.setFuture(
 scheduledExecutorService.schedule(
 new HedgingRunnable(scheduledHedgingRef),
 hedgingPolicy.hedgingDelayNanos,
 TimeUnit.NANOSECONDS)
 );
 }
 }
 // 消耗缓冲的请求
 drain(substream);
 }
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.internal.RetriableStream.HedgingRunnable&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;对冲任务，在执行的时候发起请求，并根据当前的提交的请求数量、状态等判断是否需要取消，如果不取消则再次提交一个延时任务&lt;/p&gt;</description></item><item><title>gRPC 自定义健康检查</title><link>https://blog.hellowood.dev/posts/grpc-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/</link><pubDate>Sun, 20 Sep 2020 22:38:15 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/</guid><description>&lt;p&gt;在 gRPC 中自定义健康检查逻辑，用于检查特定的组件(如检查 Redis、MQ 等)，或者结合其他的服务组件一起使用(如使用 Spring Boot 的健康检查)&lt;/p&gt;
&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;p&gt;gRPC 的健康检查服务是通过 &lt;code&gt;health.proto&lt;/code&gt;定义的&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;health.proto&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;syntax &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; grpc&lt;span style="color:#f92672"&gt;.&lt;/span&gt;health.v1;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; csharp_namespace &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;Grpc.Health.V1&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; go_package &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;google.golang.org/grpc/health/grpc_health_v1&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_multiple_files &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;true&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_outer_classname &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;HealthProto&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;option&lt;/span&gt; java_package &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;io.grpc.health.v1&amp;#34;&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HealthCheckRequest&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;service&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;message&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;HealthCheckResponse&lt;/span&gt; {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;enum&lt;/span&gt; ServingStatus {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; UNKNOWN &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; SERVING &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; NOT_SERVING &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; SERVICE_UNKNOWN &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; }&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; ServingStatus status &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;service&lt;/span&gt; Health {&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 单次健康检查
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; Check(HealthCheckRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (HealthCheckResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 流式健康检查
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;rpc&lt;/span&gt; Watch(HealthCheckRequest) &lt;span style="color:#66d9ef"&gt;returns&lt;/span&gt; (stream HealthCheckResponse);&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;}&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;里面定义了两个方法，一个是用于单次检查的 &lt;code&gt;Check&lt;/code&gt;方法，一个是用于流式请求的 &lt;code&gt;Watch&lt;/code&gt;方法&lt;/p&gt;</description></item><item><title>gRPC 健康检查</title><link>https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/</link><pubDate>Sun, 20 Sep 2020 22:37:34 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/</guid><description>&lt;p&gt;在 gRPC 中使用健康检查，在负载均衡前通过健康检查，只对健康的 Subchannel 发起请求，保证请求的成功率&lt;/p&gt;
&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="server-端"&gt;Server 端&lt;/h3&gt;
&lt;p&gt;健康检查是一个独立的 Service，需要在 Server 端显式添加健康检查服务&lt;/p&gt;
&lt;p&gt;健康检查定义了两个方法，一个适用于单次请求的 &lt;code&gt;check&lt;/code&gt; 方法，另一个是适用于 Stream 流的 &lt;code&gt;watch&lt;/code&gt; 方法&lt;/p&gt;
&lt;p&gt;Server 端的健康检查由 &lt;code&gt;io.grpc.services.HealthStatusManager&lt;/code&gt;控制，抽象类是 &lt;code&gt;io.grpc.health.v1.HealthGrpc.HealthImplBase&lt;/code&gt;，具体实现是通过 &lt;code&gt;io.grpc.services.HealthServiceImpl&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在 Server 端添加健康检查服务&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;HealthStatusManager healthStatusManager &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; HealthStatusManager();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Server server &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ServerBuilder.&lt;span style="color:#a6e22e"&gt;forPort&lt;/span&gt;(1234)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;addService&lt;/span&gt;(healthStatusManager.&lt;span style="color:#a6e22e"&gt;getHealthService&lt;/span&gt;())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;addService&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; HelloServiceImpl())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这样，当 Server 端启动之后，就可以通过访问 &lt;code&gt;grpc.health.v1.Health&lt;/code&gt;服务获取当前的 Server 端的状态&lt;/p&gt;
&lt;h3 id="客户端"&gt;客户端&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;添加配置&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;客户端开启健康检查有两个条件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;配置了健康检查参数，配置的名称是 &lt;code&gt;healthCheckConfig&lt;/code&gt;，通过指定 &lt;code&gt;serviceName&lt;/code&gt; 的方式配置&lt;/li&gt;
&lt;li&gt;使用了支持健康检查的 LB (如 round_robin)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;需要注意，这里的 &lt;code&gt;serviceName&lt;/code&gt;可以是组件名称，或者服务名称；服务端默认为 &lt;code&gt;&amp;quot;&amp;quot;&lt;/code&gt;， 如果想检查某个组件，需要自己实现健康检查的逻辑；配置中的 &lt;code&gt;serviceName&lt;/code&gt;只有在 NameReovler 解析到新的配置，且发生变化时才会更新，所以设置 &lt;code&gt;serviceName&lt;/code&gt; 意义不大&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Map&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;String, Object&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; configMap &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; HashMap&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;String, Object&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt;() {{
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; put(&lt;span style="color:#e6db74"&gt;&amp;#34;healthCheckConfig&amp;#34;&lt;/span&gt;, &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; HashMap&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;String, Object&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt;() {{
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; put(&lt;span style="color:#e6db74"&gt;&amp;#34;serviceName&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }});
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}};
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;channel&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ManagedChannelBuilder
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;forTarget&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;server&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;usePlaintext&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;defaultServiceConfig&lt;/span&gt;(configMap)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;defaultLoadBalancingPolicy&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;round_robin&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start="2"&gt;
&lt;li&gt;执行健康检查&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在发起请求前，会先使用 Service 的名称请求服务端健康检查服务，检查服务是否处于 &lt;code&gt;SERVING&lt;/code&gt; 状态，如果状态正常，则发起请求，否则将会失败&lt;/p&gt;</description></item><item><title>gRPC 负载均衡</title><link>https://blog.hellowood.dev/posts/grpc-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</link><pubDate>Sun, 20 Sep 2020 22:36:58 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</guid><description>&lt;p&gt;gRPC 内定义了 LoadBalancer 接口，用于负载均衡&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-loadbalancer-methods.png" alt="grpc-source-code-loadbalancer-methods.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;LoadBalancer 中的主要方法&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;handleResolvedAddress&lt;/code&gt;：处理 &lt;code&gt;NameResolver&lt;/code&gt; 解析的地址，用于创建 &lt;code&gt;Subchannel&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;handleNameResolutionError&lt;/code&gt;: 处理命名解析失败，会销毁已经存在的 &lt;code&gt;Suchannel&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;requestConnection&lt;/code&gt;: 创建连接，会为 &lt;code&gt;Subchannel&lt;/code&gt; 初始化 &lt;code&gt;Transport&lt;/code&gt;，并建立连接&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-loadbalancer-sub-class.png" alt="grpc-source-code-loadbalancer-sub-class.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;LoadBalancer 接口有多个实现类，如用于代理的 &lt;code&gt;ForwardingLoadBalancer&lt;/code&gt;；基于策略的 &lt;code&gt;RoundRobinLoadBalancer&lt;/code&gt;,&lt;code&gt;PickFirstLoadBalancer&lt;/code&gt;, &lt;code&gt;GrpclbLoadBalancer&lt;/code&gt;等；支持扩展功能的&lt;code&gt;HealthCheckingLoadBalancer&lt;/code&gt;, &lt;code&gt;GracefulSwitchLoadBalancer&lt;/code&gt; 等&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-loadbalancer-class-diagram.png" alt="grpc-source-code-loadbalancer-class-diagram.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;LoadBalancer 有多个内部类，用于实现负载均衡&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Factory&lt;/code&gt;: 用于创建 &lt;code&gt;LoadBalancer&lt;/code&gt;，通过 &lt;code&gt;LoadBalancerProvider&lt;/code&gt; 实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Subchannel&lt;/code&gt;: 逻辑连接，一个 &lt;code&gt;Subchannel&lt;/code&gt; 内可能包含多个 &lt;code&gt;IP:PORT&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Helper&lt;/code&gt;: 用于创建 &lt;code&gt;LoadBalancer&lt;/code&gt;、&lt;code&gt;Subchannel&lt;/code&gt; 等&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SubchannelPicker&lt;/code&gt;: &lt;code&gt;Subchannel&lt;/code&gt; 选择器，根据不同的策略使用不同的选择方式&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SubchannelStateListener&lt;/code&gt;: &lt;code&gt;Subchannel&lt;/code&gt; 状态监听器，当 &lt;code&gt;Subchannel&lt;/code&gt; 状态发生变化时及时更新&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;LoadBalancer 的工作流程是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用 &lt;code&gt;LoadBalancerRegistry&lt;/code&gt; 或者 SPI 的方式注册 &lt;code&gt;LoadBalancerProvider&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;调用 Channel Builder 的 &lt;code&gt;defaultLoadBalancingPolicy&lt;/code&gt; 设置负载均衡策略&lt;/li&gt;
&lt;li&gt;在 &lt;code&gt;ManagedChannelImpl&lt;/code&gt; 的构造方法中，创建 &lt;code&gt;Factory&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;在 &lt;code&gt;ManagedChannelImpl#exitIdleMode&lt;/code&gt; 中创建 &lt;code&gt;LoadBalancer&lt;/code&gt; 实例&lt;/li&gt;
&lt;li&gt;将创建的实例作为参数传递给 &lt;code&gt;NameResolverListener&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;当 &lt;code&gt;NameResolver&lt;/code&gt; 解析服务名称后，最终调用 &lt;code&gt;handleResolvedAddresses &lt;/code&gt;方法，根据不同的策略进行处理&lt;/li&gt;
&lt;li&gt;&lt;code&gt;LoadBalancer&lt;/code&gt; 根据解析的地址创建 &lt;code&gt;Subchannel&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Subchannel&lt;/code&gt;调用 &lt;code&gt;requestConnection&lt;/code&gt; 方法建立连接&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="创建-loadbalancer"&gt;创建 LoadBalancer&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;创建 Channel 前注册 Provider&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;LoadBalancerRegistry.&lt;span style="color:#a6e22e"&gt;getDefaultRegistry&lt;/span&gt;().&lt;span style="color:#a6e22e"&gt;register&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; HealthCheckingRoundRobinLoadBalancerProvider());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start="2"&gt;
&lt;li&gt;创建 Channel 时设置负载均衡策略&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ManagedChannelBuilder.&lt;span style="color:#a6e22e"&gt;forTarget&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;server&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;defaultLoadBalancingPolicy&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;round_robin&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start="3"&gt;
&lt;li&gt;在 &lt;code&gt;io.grpc.internal.ManagedChannelImpl#ManagedChannelImpl&lt;/code&gt; 构造方法中初始化 Factory&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Factory 的实现类是 &lt;code&gt;AutoConfiguredLoadBalancerFactory&lt;/code&gt;&lt;/p&gt;</description></item><item><title>gRPC 命名解析</title><link>https://blog.hellowood.dev/posts/grpc-%E5%91%BD%E5%90%8D%E8%A7%A3%E6%9E%90/</link><pubDate>Sun, 20 Sep 2020 22:35:22 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E5%91%BD%E5%90%8D%E8%A7%A3%E6%9E%90/</guid><description>&lt;p&gt;命名解析根据服务的 URI，从注册中心获取并解析服务实例 IP，默认支持 schema 为 DNS，grpclb，xds 等&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-name-resolver-diagram.png" alt="grpc-source-code-name-resolver-diagram.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;gRPC 的命名解析的父类接口是 &lt;code&gt;NameResolver&lt;/code&gt;


 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-name-resolver-class.png" alt="grpc-source-code-name-resolver-class.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;&lt;code&gt;NameResolver&lt;/code&gt; 包含有多个子类，用于实现命名解析
每个 &lt;code&gt;NameResolver&lt;/code&gt; 都有一个 &lt;code&gt;Provider&lt;/code&gt;，用于创建 &lt;code&gt;NameResolver&lt;/code&gt; 实例；所有的 &lt;code&gt;Provider&lt;/code&gt; 都注册到 &lt;code&gt;NameResolverRegistry&lt;/code&gt; 中，&lt;code&gt;NameResolverRegistry&lt;/code&gt; 创建 &lt;code&gt;Factory&lt;/code&gt; 实例，最终通过 &lt;code&gt;Provider&lt;/code&gt; 创建 &lt;code&gt;NameResolver&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/grpc-source-code-name-resolver-with-sub-class.png" alt="grpc-source-code-name-resolver-with-sub-class.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;命名解析的整个工作流程是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用 &lt;code&gt;NameResolverRegistry&lt;/code&gt; 或者 SPI 方式注册 Provider&lt;/li&gt;
&lt;li&gt;调用 Channel 的 &lt;code&gt;build&lt;/code&gt; 方法创建 &lt;code&gt;NameResovler.Factory&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;根据 Factory 最终调用 Provider 创建 &lt;code&gt;NameResolver&lt;/code&gt;，&lt;/li&gt;
&lt;li&gt;创建 &lt;code&gt;Listener&lt;/code&gt; 的实例&lt;/li&gt;
&lt;li&gt;调用 &lt;code&gt;NameResolver&lt;/code&gt; 的 &lt;code&gt;start&lt;/code&gt; 方法，传入 &lt;code&gt;Listener&lt;/code&gt; 实例&lt;/li&gt;
&lt;li&gt;创建 &lt;code&gt;Runnable&lt;/code&gt; 任务，通过调用 &lt;code&gt;Listener&lt;/code&gt; 的 &lt;code&gt;onResult&lt;/code&gt; 方法进行更新&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="创建-nameresolver"&gt;创建 NameResolver&lt;/h2&gt;
&lt;p&gt;在 Channel 调用 &lt;code&gt;build&lt;/code&gt; 方式时，会在 &lt;code&gt;io.grpc.internal.ManagedChannelImpl#ManagedChannelImpl&lt;/code&gt;的构造方法中获取 &lt;code&gt;NameResolver.Factory&lt;/code&gt;，这个属性的值是由调用 &lt;code&gt;io.grpc.internal.AbstractManagedChannelImplBuilder#getNameResolverFactory&lt;/code&gt; 方法获取的，这个方法里面的属性值来自于 &lt;code&gt;io.grpc.NameResolverRegistry#asFactory&lt;/code&gt;,&lt;code&gt;NameResolverRegistry&lt;/code&gt; 自己通过内部类 &lt;code&gt;NameResolverFactory&lt;/code&gt;创建了&lt;code&gt;NameResovler.Factory&lt;/code&gt; 的实例，在&lt;code&gt;io.grpc.internal.ManagedChannelImpl#getNameResolver&lt;/code&gt;中调用 Factory 的 &lt;code&gt;newNameResolver&lt;/code&gt;时，从 &lt;code&gt;provider&lt;/code&gt; 属性中获取根据优先级排序后的 Provider，通过 Provider 创建 &lt;code&gt;NameResolver&lt;/code&gt; 实例并返回第一个有效实例&lt;/p&gt;</description></item><item><title>gRPC 使用自定义的 NameResolver</title><link>https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-nameresolver/</link><pubDate>Sun, 20 Sep 2020 22:34:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84-nameresolver/</guid><description>&lt;p&gt;在使用注册中心时，gRPC 并未提供注册中心的服务发现，需要自己实现 &lt;code&gt;NameResolverProvider&lt;/code&gt; 和 &lt;code&gt;NameResolver&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NameResolver&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;NameResolver&lt;/code&gt; 里面重写了 &lt;code&gt;start&lt;/code&gt; 和 &lt;code&gt;refresh&lt;/code&gt; 方法，这两个方法都调用一个 &lt;code&gt;resolve&lt;/code&gt; 方法做服务发现；
&lt;code&gt;resovle&lt;/code&gt; 方法内部通过服务名从注册中心拉取服务实例列表，然后调用 &lt;code&gt;Listener&lt;/code&gt; 的 &lt;code&gt;onResult&lt;/code&gt;方法，将实例列表传递给 &lt;code&gt;LoadBalancer&lt;/code&gt;，完成服务解析
在服务运行期间，因为实例可能会发生变化，所以可以通过定时执行触发服务解析；如果注册中心支持，也可以通过回调触发&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomNameResolver&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;extends&lt;/span&gt; NameResolver {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; ScheduledExecutorService executorService &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; ScheduledThreadPoolExecutor(10);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;final&lt;/span&gt; String authority;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; Listener2 listener;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CustomNameResolver&lt;/span&gt;(String authority) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;authority&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; authority;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; String &lt;span style="color:#a6e22e"&gt;getServiceAuthority&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;authority&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;executorService&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;shutdown&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;start&lt;/span&gt;(Listener2 listener) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;listener&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; listener;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;resolve&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;@Override&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;public&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;refresh&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;resolve&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;void&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;resolve&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; executorService.&lt;span style="color:#a6e22e"&gt;scheduleAtFixedRate&lt;/span&gt;(() &lt;span style="color:#f92672"&gt;-&amp;gt;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 从注册中心获取地址&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; List&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;InetSocketAddress&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; addressList &lt;span style="color:#f92672"&gt;=&lt;/span&gt; getAddressList(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;authority&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (addressList &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;null&lt;/span&gt; &lt;span style="color:#f92672"&gt;||&lt;/span&gt; addressList.&lt;span style="color:#a6e22e"&gt;size&lt;/span&gt;() &lt;span style="color:#f92672"&gt;==&lt;/span&gt; 0) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; List&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;SocketAddress&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; socketAddressList &lt;span style="color:#f92672"&gt;=&lt;/span&gt; addressList.&lt;span style="color:#a6e22e"&gt;stream&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;map&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;::toSocketAddress)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;collect&lt;/span&gt;(Collectors.&lt;span style="color:#a6e22e"&gt;toList&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; EquivalentAddressGroup equivalentAddressGroup &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; EquivalentAddressGroup(socketAddressList);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Attributes.&lt;span style="color:#a6e22e"&gt;Key&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;String&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; key &lt;span style="color:#f92672"&gt;=&lt;/span&gt; Attributes.&lt;span style="color:#a6e22e"&gt;Key&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;create&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;CustomKey&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; String value &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;CustomValue&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Attributes attributes &lt;span style="color:#f92672"&gt;=&lt;/span&gt; Attributes.&lt;span style="color:#a6e22e"&gt;newBuilder&lt;/span&gt;().&lt;span style="color:#a6e22e"&gt;set&lt;/span&gt;(key, value).&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ConfigOrError configOrError &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ConfigOrError.&lt;span style="color:#a6e22e"&gt;fromError&lt;/span&gt;(Status.&lt;span style="color:#a6e22e"&gt;NOT_FOUND&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ResolutionResult resolutionResult &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ResolutionResult.&lt;span style="color:#a6e22e"&gt;newBuilder&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setAddresses&lt;/span&gt;(Arrays.&lt;span style="color:#a6e22e"&gt;asList&lt;/span&gt;(equivalentAddressGroup))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setAttributes&lt;/span&gt;(attributes)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setServiceConfig&lt;/span&gt;(configOrError)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;listener&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;onResult&lt;/span&gt;(resolutionResult);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }, 0, 5, TimeUnit.&lt;span style="color:#a6e22e"&gt;SECONDS&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; SocketAddress &lt;span style="color:#a6e22e"&gt;toSocketAddress&lt;/span&gt;(InetSocketAddress address) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; InetSocketAddress(address.&lt;span style="color:#a6e22e"&gt;getHostName&lt;/span&gt;(), address.&lt;span style="color:#a6e22e"&gt;getPort&lt;/span&gt;());
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; List&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;InetSocketAddress&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;getAddressList&lt;/span&gt;(String authority) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; InetSocketAddress inetSocketAddress &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; InetSocketAddress(&lt;span style="color:#e6db74"&gt;&amp;#34;localhost&amp;#34;&lt;/span&gt;, 1234);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; InetSocketAddress inetSocketAddress2 &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; InetSocketAddress(&lt;span style="color:#e6db74"&gt;&amp;#34;127.0.0.1&amp;#34;&lt;/span&gt;, 1234);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; Arrays.&lt;span style="color:#a6e22e"&gt;asList&lt;/span&gt;(inetSocketAddress, inetSocketAddress2);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;NameResolverProvider&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;NameResolverProvider&lt;/code&gt; 主要用于注册 &lt;code&gt;NameResolver&lt;/code&gt;，可以设置默认的协议，是否可用，优先级等
优先级有效值是 0-10，gRPC 默认的 &lt;code&gt;DnsNameResolver&lt;/code&gt; 优先级是5，所以自定义的优先级要大于5&lt;/p&gt;</description></item><item><title>gRPC 中 Binlog 打印原理</title><link>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD-binlog-%E6%89%93%E5%8D%B0%E5%8E%9F%E7%90%86/</link><pubDate>Sun, 20 Sep 2020 22:33:59 +0800</pubDate><guid>https://blog.hellowood.dev/posts/grpc-%E4%B8%AD-binlog-%E6%89%93%E5%8D%B0%E5%8E%9F%E7%90%86/</guid><description>&lt;p&gt;gRPC 支持将请求调用的参数、Header 等信息以二进制的方式输出到文件中&lt;/p&gt;
&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;p&gt;binlog 的依赖在 &lt;code&gt;grpc-services&lt;/code&gt;中，所以需要有该依赖&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;创建 Channel 时指定&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;BinaryLog binaryLog &lt;span style="color:#f92672"&gt;=&lt;/span&gt; BinaryLogs.&lt;span style="color:#a6e22e"&gt;createBinaryLog&lt;/span&gt;(&lt;span style="color:#66d9ef"&gt;new&lt;/span&gt; TempFileSink(), &lt;span style="color:#e6db74"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;this&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;channel&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; ManagedChannelBuilder.&lt;span style="color:#a6e22e"&gt;forAddress&lt;/span&gt;(host, port)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;usePlaintext&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;setBinaryLog&lt;/span&gt;(binaryLog)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; .&lt;span style="color:#a6e22e"&gt;build&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在创建时，需要指定打印的方法，&lt;code&gt;*&lt;/code&gt;代表打印所有的方法，具体指定可以参考 &lt;a href="https://github.com/helloworlde/proposal/blob/master/A16-binary-logging.md#control-interface"&gt;Control Interface&lt;/a&gt;
也可以在创建时不指定参数，通过设置环境变量 &lt;code&gt;GRPC_BINARY_LOG_CONFIG=*&lt;/code&gt;来指定需要打印的方法
如果需要指定文件的生成位置，可以重写&lt;code&gt;io.grpc.services.BinaryLogSink&lt;/code&gt;，指定文件位置&lt;/p&gt;
&lt;h2 id="实现"&gt;实现&lt;/h2&gt;
&lt;p&gt;在方法调用时，会判断有没有设置 binlog 对象，如果有则会封装方法，添加处理器和监听器；然后重新创建 &lt;code&gt;ServerMethodDefinition&lt;/code&gt;；通过二进制日志拦截器 &lt;code&gt;io.grpc.services.BinlogHelper#getClientInterceptor&lt;/code&gt; 拦截请求并写入日志&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;io.grpc.internal.ServerImpl.ServerTransportListenerImpl#startCall&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;private&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; ServerStreamListener &lt;span style="color:#a6e22e"&gt;startCall&lt;/span&gt;(ServerStream stream, String fullMethodName,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ServerMethodDefinition&lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt;ReqT, RespT&lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; methodDef, Metadata headers,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Context.&lt;span style="color:#a6e22e"&gt;CancellableContext&lt;/span&gt; context, StatsTraceContext statsTraceCtx, Tag tag) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 如果 binlog 不为空，即需要记录binlog，则添加请求监听器和方法处理器记录 binlog&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ServerMethodDefinition&lt;span style="color:#f92672"&gt;&amp;lt;?&lt;/span&gt;, &lt;span style="color:#f92672"&gt;?&amp;gt;&lt;/span&gt; wMethodDef &lt;span style="color:#f92672"&gt;=&lt;/span&gt; binlog &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;null&lt;/span&gt; &lt;span style="color:#f92672"&gt;?&lt;/span&gt; interceptedDef : binlog.&lt;span style="color:#a6e22e"&gt;wrapMethodDefinition&lt;/span&gt;(interceptedDef);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; startWrappedCall(fullMethodName, wMethodDef, stream, headers, context, tag);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.services.BinaryLogProvider#wrapMethodDefinition&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt; public final &amp;lt;ReqT, RespT&amp;gt; ServerMethodDefinition&amp;lt;?, ?&amp;gt; wrapMethodDefinition(ServerMethodDefinition&amp;lt;ReqT, RespT&amp;gt; oMethodDef) {
 // 根据方法获取二进制日志拦截器，如果没有该方法则不拦截
 ServerInterceptor binlogInterceptor = getServerInterceptor(oMethodDef.getMethodDescriptor().getFullMethodName());
 if (binlogInterceptor == null) {
 return oMethodDef;
 }

 MethodDescriptor&amp;lt;byte[], byte[]&amp;gt; binMethod = BinaryLogProvider.toByteBufferMethod(oMethodDef.getMethodDescriptor());
 // 包装方法，添加了处理器和监听器
 ServerMethodDefinition&amp;lt;byte[], byte[]&amp;gt; binDef = InternalServerInterceptors.wrapMethod(oMethodDef, binMethod);
 // 创建处理器
 ServerCallHandler&amp;lt;byte[], byte[]&amp;gt; binlogHandler =
 InternalServerInterceptors.interceptCallHandlerCreate(binlogInterceptor, binDef.getServerCallHandler());
 // 创建服务方法定义
 return ServerMethodDefinition.create(binMethod, binlogHandler);
 }
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;io.grpc.services.BinlogHelper#getClientInterceptor&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt; public ClientInterceptor getClientInterceptor(final long callId) {
 return new ClientInterceptor() {
 boolean trailersOnlyResponse = true;

 @Override
 public &amp;lt;ReqT, RespT&amp;gt; ClientCall&amp;lt;ReqT, RespT&amp;gt; interceptCall(
 final MethodDescriptor&amp;lt;ReqT, RespT&amp;gt; method, CallOptions callOptions, Channel next) {
 final String methodName = method.getFullMethodName();
 final String authority = next.authority();
 final Deadline deadline = min(callOptions.getDeadline(), Context.current().getDeadline());

 return new SimpleForwardingClientCall&amp;lt;ReqT, RespT&amp;gt;(next.newCall(method, callOptions)) {
 @Override
 public void start(final ClientCall.Listener&amp;lt;RespT&amp;gt; responseListener, Metadata headers) {
 final Duration timeout = deadline == null ? null
 : Durations.fromNanos(deadline.timeRemaining(TimeUnit.NANOSECONDS));
 writer.logClientHeader(
 seq.getAndIncrement(),
 methodName,
 authority,
 timeout,
 headers,
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId,
 /*peerAddress=*/ null);
 ClientCall.Listener&amp;lt;RespT&amp;gt; wListener =
 new SimpleForwardingClientCallListener&amp;lt;RespT&amp;gt;(responseListener) {
 @Override
 public void onMessage(RespT message) {
 writer.logRpcMessage(
 seq.getAndIncrement(),
 EventType.EVENT_TYPE_SERVER_MESSAGE,
 method.getResponseMarshaller(),
 message,
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId);
 super.onMessage(message);
 }

 @Override
 public void onHeaders(Metadata headers) {
 trailersOnlyResponse = false;
 writer.logServerHeader(
 seq.getAndIncrement(),
 headers,
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId,
 getPeerSocket(getAttributes()));
 super.onHeaders(headers);
 }

 @Override
 public void onClose(Status status, Metadata trailers) {
 SocketAddress peer = trailersOnlyResponse
 ? getPeerSocket(getAttributes()) : null;
 writer.logTrailer(
 seq.getAndIncrement(),
 status,
 trailers,
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId,
 peer);
 super.onClose(status, trailers);
 }
 };
 super.start(wListener, headers);
 }

 @Override
 public void sendMessage(ReqT message) {
 writer.logRpcMessage(
 seq.getAndIncrement(),
 EventType.EVENT_TYPE_CLIENT_MESSAGE,
 method.getRequestMarshaller(),
 message,
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId);
 super.sendMessage(message);
 }

 @Override
 public void halfClose() {
 writer.logHalfClose(
 seq.getAndIncrement(),
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId);
 super.halfClose();
 }

 @Override
 public void cancel(String message, Throwable cause) {
 writer.logCancel(
 seq.getAndIncrement(),
 GrpcLogEntry.Logger.LOGGER_CLIENT,
 callId);
 super.cancel(message, cause);
 }
 };
 }
 };
 }
&lt;/code&gt;&lt;/pre&gt;</description></item></channel></rss>