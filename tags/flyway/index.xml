<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Flyway on HelloWood</title><link>https://blog.hellowood.dev/tags/flyway/</link><description>Recent content in Flyway on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Mon, 01 Jan 0001 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/flyway/index.xml" rel="self" type="application/rss+xml"/><item><title>Spring Boot 使用 Flyway</title><link>https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-flyway/</link><pubDate>Sun, 07 Jan 2018 23:20:53 +0800</pubDate><guid>https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-flyway/</guid><description>&lt;ul>
&lt;li>项目地址：&lt;a href="https://github.com/helloworlde/SpringBootCollection/tree/master/SpringBoot-Flyway">https://github.com/helloworlde/SpringBootCollection/tree/master/SpringBoot-Flyway&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;a href="https://flywaydb.org">Flyway&lt;/a> 是一个数据库版本管理工具，用于管理数据库操作脚本&lt;/p>
&lt;/blockquote>
&lt;h2 id="添加依赖">添加依赖&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c1abea">compile&lt;/span>&lt;span style="color:#c7bf54">(&lt;/span>&lt;span style="color:#98c379">&amp;#39;org.flywaydb:flyway-core&amp;#39;&lt;/span>&lt;span style="color:#c7bf54">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c1abea">compile&lt;/span>&lt;span style="color:#c7bf54">(&lt;/span>&lt;span style="color:#98c379">&amp;#39;org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.1&amp;#39;&lt;/span>&lt;span style="color:#c7bf54">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c1abea">runtime&lt;/span>&lt;span style="color:#c7bf54">(&lt;/span>&lt;span style="color:#98c379">&amp;#39;mysql:mysql-connector-java&amp;#39;&lt;/span>&lt;span style="color:#c7bf54">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic">//runtime(&amp;#39;com.h2database:h2&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置">配置&lt;/h2>
&lt;ul>
&lt;li>配置数据库&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic"># H2 数据库&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic">#spring.datasource.url=jdbc:h2:mem:test&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic">#spring.datasource.username=root&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic">#spring.datasource.password=123456&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic">#spring.datasource.driver-class-name=org.h2.Driver&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8a93a5;font-style:italic"># MySQL 数据库&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b3d23c">spring.datasource.driver-class-name&lt;/span>&lt;span style="color:#c7bf54">=&lt;/span>&lt;span style="color:#98c379">com.mysql.jdbc.Driver&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b3d23c">spring.datasource.url&lt;/span>&lt;span style="color:#c7bf54">=&lt;/span>&lt;span style="color:#98c379">jdbc:mysql://localhost:3306/product?useSSL=false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b3d23c">spring.datasource.username&lt;/span>&lt;span style="color:#c7bf54">=&lt;/span>&lt;span style="color:#98c379">root&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b3d23c">spring.datasource.password&lt;/span>&lt;span style="color:#c7bf54">=&lt;/span>&lt;span style="color:#98c379">123456&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>使用 &lt;code>V_VARSION__DESCRIPTION.sql&lt;/code> 方式命名脚本&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">CREATE&lt;/span> &lt;span style="color:#c678dd">TABLE&lt;/span> &lt;span style="color:#c1abea">product&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c1abea">id&lt;/span> &lt;span style="color:#ef8383">INT&lt;/span> &lt;span style="color:#c678dd">PRIMARY&lt;/span> &lt;span style="color:#c678dd">KEY&lt;/span> &lt;span style="color:#c1abea">AUTO_INCREMENT&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c1abea">name&lt;/span> &lt;span style="color:#ef8383">VARCHAR&lt;/span>(&lt;span style="color:#d19a66">50&lt;/span>) &lt;span style="color:#c678dd">NOT&lt;/span> &lt;span style="color:#c678dd">NULL&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c1abea">price&lt;/span> &lt;span style="color:#c1abea">DOUBLE&lt;/span> &lt;span style="color:#c678dd">NOT&lt;/span> &lt;span style="color:#c678dd">NULL&lt;/span> &lt;span style="color:#c678dd">DEFAULT&lt;/span> &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>将 SQL 脚本放在 &lt;code>resources/db/migration&lt;/code> 目录下&lt;/li>
&lt;/ul>
&lt;h2 id="使用">使用&lt;/h2>
&lt;p>此时启动应用，Flyway 将会自动执行脚本进行数据库操作&lt;/p>
&lt;ul>
&lt;li>第一次启动时将会看到如下日志&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>2018-01-07 21:00:14.932 INFO 5041 --- [ main] o.f.core.internal.util.VersionPrinter : Flyway 3.2.1 by Boxfuse
2018-01-07 21:00:17.015 INFO 5041 --- [ main] o.f.c.i.dbsupport.DbSupportFactory : Database: jdbc:mysql://localhost:3306/product?useSSL=false (MySQL 5.7)
2018-01-07 21:00:17.253 INFO 5041 --- [ main] o.f.core.internal.command.DbValidate : Validated 1 migration (execution time 00:00.133s)
2018-01-07 21:00:17.750 INFO 5041 --- [ main] o.f.c.i.metadatatable.MetaDataTableImpl : Creating Metadata table: `product`.`schema_version`
2018-01-07 21:00:18.437 INFO 5041 --- [ main] o.f.core.internal.command.DbMigrate : Current version of schema `product`: &amp;lt;&amp;lt; Empty Schema &amp;gt;&amp;gt;
2018-01-07 21:00:18.437 INFO 5041 --- [ main] o.f.core.internal.command.DbMigrate : Migrating schema `product` to version 1.0 - 0001 CREATE PRODUCT
2018-01-07 21:00:19.284 INFO 5041 --- [ main] o.f.core.internal.command.DbMigrate : Successfully applied 1 migration to schema `product` (execution time 00:01.592s).
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>再次启动将会看到 Flyway 校验版本&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>2018-01-07 21:02:09.195 INFO 5061 --- [ main] o.f.core.internal.util.VersionPrinter : Flyway 3.2.1 by Boxfuse
2018-01-07 21:02:11.327 INFO 5061 --- [ main] o.f.c.i.dbsupport.DbSupportFactory : Database: jdbc:mysql://localhost:3306/product?useSSL=false (MySQL 5.7)
2018-01-07 21:02:11.618 INFO 5061 --- [ main] o.f.core.internal.command.DbValidate : Validated 1 migration (execution time 00:00.202s)
2018-01-07 21:02:12.386 INFO 5061 --- [ main] o.f.core.internal.command.DbMigrate : Current version of schema `product`: 1.0
2018-01-07 21:02:12.447 INFO 5061 --- [ main] o.f.core.internal.command.DbMigrate : Schema `product` is up to date. No migration necessary.
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>如果不想 Flyway 执行，可以配置不启用 Flyway&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-properties" data-lang="properties">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b3d23c">flyway.enabled&lt;/span>&lt;span style="color:#c7bf54">=&lt;/span>&lt;span style="color:#98c379">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="注意">注意&lt;/h2>
&lt;blockquote>
&lt;ul>
&lt;li>如果按照 Flyway &lt;a href="https://flywaydb.org/documentation/plugins/springboot">官方文档&lt;/a> 的指导，仅配置 Flyway，应用启动时并不会执行 Flyway 的任何操作，这是因为 &lt;a href="https://docs.spring.io/spring-boot/docs/1.4.x/api/org/springframework/boot/autoconfigure/flyway/FlywayAutoConfiguration.html">&lt;code>FlywayAutoConfiguration&lt;/code>&lt;/a> 类在启动时要求有 DataSource 的实例，如果没有配置，就不会执行 Flyway，所以在依赖里添加了 MyBatis(或 JPA) ，使用 MyBatis(或 JPA) 时会自动注入数据源，因此才会执行 Flyway，具体可以参考&lt;a href="https://github.com/spring-projects/spring-boot/issues/8649">https://github.com/spring-projects/spring-boot/issues/8649&lt;/a> 和 &lt;a href="https://stackoverflow.com/questions/43496506/how-to-debug-when-flyway-doesnt-work-on-spring-boot">https://stackoverflow.com/questions/43496506/how-to-debug-when-flyway-doesnt-work-on-spring-boot&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;blockquote>
&lt;ul>
&lt;li>如果是多个数据源，则需要在 Flyway 进行操作的数据源 Bean 上添加 &lt;code>@FlywayDataSource&lt;/code>注解或者在 &lt;code>application.properties&lt;/code> 里添加 &lt;code>spring.flyway.[url,user,password]&lt;/code>进行配置&lt;/li>
&lt;/ul>
&lt;/blockquote></description></item><item><title>使用Gradle整合Flyway进行数据库迁移</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8gradle%E6%95%B4%E5%90%88flyway%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/</link><pubDate>Mon, 01 Jan 2018 00:49:34 +0800</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8gradle%E6%95%B4%E5%90%88flyway%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/</guid><description>&lt;blockquote>
&lt;p>使用Flyway进行数据库迁移可以极大的减少开发过程中对数据库版本的操作，使用Gradle整合Flyway可以更好的和项目契合&lt;/p>
&lt;/blockquote>
&lt;h2 id="配置buildgradle文件">配置build.gradle文件&lt;/h2>
&lt;pre tabindex="0">&lt;code>apply plugin: &amp;#39;org.flywaydb.flyway&amp;#39;

buildscript {
 repositories {
 mavenCentral()
 }

 dependencies {
 classpath(group: &amp;#39;org.flywaydb&amp;#39;, name: &amp;#39;flyway-gradle-plugin&amp;#39;, version: &amp;#34;4.0.3&amp;#34;)
 classpath(group: &amp;#39;mysql&amp;#39;, name: &amp;#39;mysql-connector-java&amp;#39;, version: &amp;#34;5.1.41&amp;#34;)
 }
}

flyway {
 url = &amp;#39;jdbc:mysql://localhost:3306/miniprograme?useSSL=false&amp;#39;
 locations = [&amp;#39;filesystem:db/migration&amp;#39;]
 user = &amp;#39;root&amp;#39;
 password = &amp;#39;123456&amp;#39;
 schemas = [&amp;#39;flywaydb&amp;#39;]
}
&lt;/code>&lt;/pre>&lt;p>##使用Flyway进行数据库管理&lt;/p>
&lt;ul>
&lt;li>删除数据库所有表&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>gradle flywayClean
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>迁移数据库&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>gradle flywayMigrate
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>校验新版本文件是否有冲突&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>gradle flywayValidate
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>查看数据库状态&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>gradle flywayInfo
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>修复数据库（删除失败的版本，修复checksum值）&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>gradle flywayRepair
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>设置某一版本为基础版本，该版本及之前的不会再被执行&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>gradle flywayBaseline
&lt;/code>&lt;/pre></description></item></channel></rss>