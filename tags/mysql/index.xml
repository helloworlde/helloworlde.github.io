<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>MySQL on HelloWood</title><link>https://blog.hellowood.dev/tags/mysql/</link><description>Recent content in MySQL on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Sat, 06 Sep 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/mysql/index.xml" rel="self" type="application/rss+xml"/><item><title>MySQL 中关于gap lock / next-key lock 的一个问题</title><link>https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</link><pubDate>Mon, 07 Jan 2019 21:40:58 +0800</pubDate><guid>https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</guid><description>&lt;blockquote&gt;
&lt;p&gt;在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="问题描述"&gt;问题描述&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;表初始化&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;CREATE&lt;/span&gt; &lt;span style="color:#c678dd"&gt;TABLE&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; (
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;id&lt;/span&gt; &lt;span style="color:#ef8383"&gt;INT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#c678dd"&gt;KEY&lt;/span&gt; &lt;span style="color:#c1abea"&gt;AUTO_INCREMENT&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt; &lt;span style="color:#ef8383"&gt;INT&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;KEY&lt;/span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt;(&lt;span style="color:#c1abea"&gt;b&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c1abea"&gt;ENGINE&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;InnoDB&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c678dd"&gt;DEFAULT&lt;/span&gt; &lt;span style="color:#c1abea"&gt;CHARSET&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#c1abea"&gt;utf8&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; (&lt;span style="color:#c1abea"&gt;id&lt;/span&gt;, &lt;span style="color:#c1abea"&gt;b&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;1&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;2&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; (&lt;span style="color:#d19a66"&gt;3&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;4&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; (&lt;span style="color:#d19a66"&gt;5&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;6&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; (&lt;span style="color:#d19a66"&gt;7&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;8&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; (&lt;span style="color:#d19a66"&gt;9&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;10&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;session A&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;BEGIN&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;SELECT&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;*&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;FROM&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;WHERE&lt;/span&gt; &lt;span style="color:#c1abea"&gt;b&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;=&lt;/span&gt; &lt;span style="color:#d19a66"&gt;6&lt;/span&gt; &lt;span style="color:#c678dd"&gt;FOR&lt;/span&gt; &lt;span style="color:#c678dd"&gt;UPDATE&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;session B&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;2&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;4&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*success*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;2&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;8&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*blocked*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;4&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;4&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*blocked*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;4&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;8&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*blocked*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;8&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;4&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*blocked*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;8&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;8&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*success*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#d19a66"&gt;0&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;4&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*blocked*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;INSERT&lt;/span&gt; &lt;span style="color:#c678dd"&gt;INTO&lt;/span&gt; &lt;span style="color:#c1abea"&gt;z&lt;/span&gt; &lt;span style="color:#c678dd"&gt;VALUES&lt;/span&gt; (&lt;span style="color:#c7bf54"&gt;-&lt;/span&gt;&lt;span style="color:#d19a66"&gt;1&lt;/span&gt;, &lt;span style="color:#d19a66"&gt;4&lt;/span&gt;);&lt;span style="color:#8a93a5;font-style:italic"&gt;/*success*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;分别执行 session B中的insert 会出现上述情况，为什么？&lt;/p&gt;
&lt;h3 id="加锁过程"&gt;加锁过程&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;在索引 b 上的等值查询，给索引 b 加上了 next-key lock (4, 6]；索引向右遍历，且最后一个值不满足条件时退化为间隙锁；所以会再加上间隙锁 (6,8)；所以索引 b 上的 next-key lock 的范围是(b=4,id=3)到(b=6,id=5)这个左开右闭区间和(b=6,id=5)到(b=8,id=7)这个开区间&lt;/li&gt;
&lt;li&gt;for update 会给 b = 6 这一行加上行锁；因此 (b=6,id=5) 这一行上有行锁&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;这么看来上述语句都不在锁的范围内，为什么会被锁&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个问题其实是因为没有理解索引的结构，所以认为所有值都不应该被锁&lt;/p&gt;</description></item><item><title>SpringBoot 使用 MySQL保存emoji 表情</title><link>https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-mysql%E4%BF%9D%E5%AD%98emoji-%E8%A1%A8%E6%83%85/</link><pubDate>Mon, 31 Dec 2018 22:59:16 +0800</pubDate><guid>https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-mysql%E4%BF%9D%E5%AD%98emoji-%E8%A1%A8%E6%83%85/</guid><description>&lt;blockquote&gt;
&lt;p&gt;在使用 SpringBoot 开发的应用中，有表单提交的内容中含有 emoji 表情，导致保存失败；这是因为MySQL 默认的 utf8 长度为3位，emoji 表情有4位&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;更改表的字符集为&lt;code&gt;utf8mb4&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ALTER&lt;/span&gt; &lt;span style="color:#c678dd"&gt;TABLE&lt;/span&gt; &lt;span style="color:#c1abea"&gt;content&lt;/span&gt; &lt;span style="color:#c678dd"&gt;DEFAULT&lt;/span&gt; &lt;span style="color:#ef8383"&gt;CHARACTER&lt;/span&gt; &lt;span style="color:#c678dd"&gt;SET&lt;/span&gt; &lt;span style="color:#c1abea"&gt;utf8mb4&lt;/span&gt; &lt;span style="color:#c678dd"&gt;COLLATE&lt;/span&gt; &lt;span style="color:#c1abea"&gt;utf8_general_ci&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;但是这样更改后仍然没有解决保存失败的问题&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;更改数据库的字符集&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ALTER&lt;/span&gt; &lt;span style="color:#c678dd"&gt;DATABASE&lt;/span&gt; &lt;span style="color:#c1abea"&gt;db_name&lt;/span&gt; &lt;span style="color:#c678dd"&gt;DEFAULT&lt;/span&gt; &lt;span style="color:#ef8383"&gt;CHARACTER&lt;/span&gt; &lt;span style="color:#c678dd"&gt;SET&lt;/span&gt; &lt;span style="color:#c1abea"&gt;utf8mb4&lt;/span&gt; &lt;span style="color:#c678dd"&gt;COLLATE&lt;/span&gt; &lt;span style="color:#c1abea"&gt;utf8_general_ci&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;由于暂时不能重启数据库，这种修改方式只在当前连接中生效，同样未能解决问题&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;修改 SpringBoot 的配置&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex="0"&gt;&lt;code class="language-dsconfig" data-lang="dsconfig"&gt;spring.datasource.hikari.connection-init-sql=SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这样，在应用的所有连接内都使用utf8mb4 作为字符集，解决了 emoji 保存失败的问题&lt;/p&gt;</description></item></channel></rss>