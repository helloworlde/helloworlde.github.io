<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Network on HelloWood</title><link>https://blog.hellowood.dev/tags/network/</link><description>Recent content in Network on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Sat, 06 Sep 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/tags/network/index.xml" rel="self" type="application/rss+xml"/><item><title>使用公网 IP 免域名部署自建的 Tailscale DERP Server</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%85%AC%E7%BD%91-ip-%E5%85%8D%E5%9F%9F%E5%90%8D%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BA%E7%9A%84-tailscale-derp-server/</link><pubDate>Sat, 02 Aug 2025 00:00:00 +0000</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%85%AC%E7%BD%91-ip-%E5%85%8D%E5%9F%9F%E5%90%8D%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BA%E7%9A%84-tailscale-derp-server/</guid><description>&lt;p&gt;之前&lt;a href="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%AE%B6%E5%BA%AD%E5%AE%BD%E5%B8%A6%E5%85%AC%E7%BD%91-ipv6-%E8%87%AA%E5%BB%BA-tailscale-%E7%9A%84-derp-%E8%8A%82%E7%82%B9/"&gt;使用家庭宽带公网 IPV6 自建 Tailscale 的 DERP 节点&lt;/a&gt;，但是部分服务器不支持 IPv6；另外 IPv6 开启后如果 DNS 或者 MSS 钳制配置不当会导致部分流量无法正常路由，可能会影响其他设备使用，因此作为补充，使用阿里云的服务器部署 DERP 服务器，用于提供 IPv4 的流量转发&lt;/p&gt;
&lt;p&gt;Tailscale 从 &lt;a href="https://tailscale.com/changelog#2025-03-26"&gt;1.82.0&lt;/a&gt; 版本开始支持使用自签的 IP 证书部署 DERP Server，而不再强制使用域名，因此可以使用 ZeroSSL 的 IP 证书和阿里云的公网 IP 自建免域名的 DERP Server&lt;/p&gt;
&lt;h2 id="申请-zerossl-ip-证书"&gt;申请 ZeroSSL IP 证书&lt;/h2&gt;
&lt;p&gt;申请 ZeroSSL IP 证书可以参考 &lt;a href="https://blog.hellowood.dev/posts/%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8caddy-%E5%92%8C-zerossl-%E6%8F%90%E4%BE%9B%E7%9A%84-ip-%E8%AF%81%E4%B9%A6%E4%B8%BA%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%90%AF-https/"&gt;阿里云服务器使用 Caddy 和 ZeroSSL 提供的 IP 证书为服务开启 HTTPS&lt;/a&gt; 进行申请获取证书&lt;/p&gt;
&lt;h2 id="部署-derp-server"&gt;部署 DERP Server&lt;/h2&gt;
&lt;p&gt;使用 docker-compose 部署 DERP Server，docker 镜像可以使用 &lt;code&gt;ghcr.io/helloworlde/derper&lt;/code&gt;，这是基于 Tailscale 源码构建的镜像；代码参考 &lt;a href="https://github.com/helloworlde/derper"&gt;ghcr.io/helloworlde/derper&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;将 ZeroSSL 申请的证书添加到 cert 目录下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;├── cert
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;│   ├── 10.0.0.2.crt
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;│   └── 10.0.0.2.key
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;├── config
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;└── docker-compose.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;docker-compose.yml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;services&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;derper&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;image&lt;/span&gt;: &lt;span style="color:#98c379"&gt;ghcr.io/helloworlde/derper&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;container_name&lt;/span&gt;: &lt;span style="color:#98c379"&gt;derper&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;restart&lt;/span&gt;: &lt;span style="color:#98c379"&gt;always&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;network_mode&lt;/span&gt;: &lt;span style="color:#98c379"&gt;host&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 使用宿主机的网络&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;volumes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;./config:/app/config&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 用于挂载调试和私钥的 key&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;./cert:/app/certs&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 挂载证书&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;/var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 挂载 tailscaled.sock，用于验证客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;environment&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;TZ=Asia/Shanghai&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;DEV=false&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 关闭 dev 模式&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;ADDR=:20443&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# derp 的 HTTPS 地址&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;HTTP_PORT=81&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# HTTP 端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;STUN_PORT=3478&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# STUN 端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;HOSTNAME=10.0.0.2&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 公网 IP&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;CERTS_DIR=/app/certs/&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 证书路径&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;CERTMODE=manual&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 证书模式&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;STUN_ENABLE=true&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 开启 STUN&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;DERP_ENABLE=true&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 开启 DERP&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;VERIFY_CLIENTS=true&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 验证客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;TS_DEBUG_KEY_PATH=/app/config/debug.key&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# debug key 文件的路径，用于访问 debug 端口测试&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;DERP_DEBUG_LOGS=false&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 关闭 DERP debug 日志&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;CONFIG_PATH=/app/config/derper.key&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# 私钥文件，用于验证中继的身份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;启动 DERP Server&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;docekr compose up -d
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;启动后访问 &lt;code&gt; https://10.0.0.2:20443/&lt;/code&gt; 验证，可以正确访问说明部署成功：&lt;/p&gt;</description></item><item><title>解决阿里云和 Tailscale 的 100 网段冲突的问题</title><link>https://blog.hellowood.dev/posts/%E8%A7%A3%E5%86%B3%E9%98%BF%E9%87%8C%E4%BA%91%E5%92%8C-tailscale-%E7%9A%84-100-%E7%BD%91%E6%AE%B5%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98/</link><pubDate>Sun, 20 Jul 2025 00:00:00 +0000</pubDate><guid>https://blog.hellowood.dev/posts/%E8%A7%A3%E5%86%B3%E9%98%BF%E9%87%8C%E4%BA%91%E5%92%8C-tailscale-%E7%9A%84-100-%E7%BD%91%E6%AE%B5%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98/</guid><description>&lt;p&gt;Tailscale 使用的 &lt;code&gt;100.64.0.0/10&lt;/code&gt; 是一个运营商级网络地址转换(CGNAT)网段，这个网段是一个私有 IP 范围，不用于公共互联网，因此一些云服务商如阿里云等也使用这个网段作为内网网段，这样在阿里云服务器使用 Tailscale 的时候就会出现冲突，表现为启用 Tailscale 开启后阿里云的 DNS、软件源等 100 网段的服务都无法使用&lt;/p&gt;
&lt;p&gt;这个问题可以通过配置 Tailscale 的防火墙策略解决&lt;/p&gt;
&lt;h2 id="配置-tailscale-的防火墙"&gt;配置 Tailscale 的防火墙&lt;/h2&gt;
&lt;p&gt;在启动时将自动防火墙配置程度设置为 &lt;code&gt;nodivert&lt;/code&gt;，这样 Tailscale 就不会自动配置防火墙规则，而是使用阿里云的防火墙规则；同时启用接受来自控制台的 DNS 配置，用于解析 Tailscale 节点的 IP 地址；这样就可以解决阿里云和 Tailscale 的 100 网段冲突的问题；&lt;/p&gt;
&lt;p&gt;不过需要注意的是改为 &lt;code&gt;nodivert&lt;/code&gt; 可能会影响子网路由(advertise-routes) 和出口节点(exit node)功能&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;tailscale up --netfilter-mode&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;nodivert --accept-dns&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#ef8383"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;--netfilter-mode=nodivert&lt;/code&gt; 这个参数是用于控制 Tailscale 自动配置防火墙（iptables/netfilter）规则的程度：&lt;/p&gt;
&lt;table&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;参数值&lt;/th&gt;
 &lt;th&gt;含义&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;on&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Tailscale 自动管理 netfilter/iptables 规则，默认使用&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;nodivert&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Tailscale 创建并管理自有规则链，但不会挂载到系统主链，需要用户主动调用&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;off&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;完全不管理任何防火墙规则，所有流量控制需用户自行配置&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;但是修改为 &lt;code&gt;nodivert&lt;/code&gt; 会存在安全漏洞 &lt;a href="https://seclists.org/oss-sec/2019/q4/122"&gt;[CVE-2019-14899] Inferring and hijacking VPN-tunneled TCP connections.&lt;/a&gt;；这个漏洞可以让攻击者通过旁路监听（man-in-the-middle 或同网段监听）的方式，识别并劫持 VPN 隧道内的 TCP 连接，不过在内网环境下，这个漏洞的影响范围相对较小；如果是公网或者开放环境，则需要注意&lt;/p&gt;</description></item><item><title>使用 Docker 在 Linux 服务器搭建 Hysteria2 作为代理</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-docker-%E5%9C%A8-linux-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA-hysteria2-%E4%BD%9C%E4%B8%BA%E4%BB%A3%E7%90%86/</link><pubDate>Sun, 29 Dec 2024 00:00:00 +0000</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-docker-%E5%9C%A8-linux-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA-hysteria2-%E4%BD%9C%E4%B8%BA%E4%BB%A3%E7%90%86/</guid><description>&lt;p&gt;&lt;a href="https://v2.hysteria.network/zh/"&gt;Hysteria&lt;/a&gt; 是一个代理工具，支持 SOCKS5、HTTP 代理、TCP/UDP 转发、Linux TProxy、TUN 等代理方式；基于魔改的 QUIC 协议和抢占式塞控制算法，Hysteria 在不稳定和容易丢包的网络环境中也能比 &lt;a href="https://trojan-gfw.github.io/trojan/protocol"&gt;Trojan&lt;/a&gt; 有相对较好的延迟表现，这对于代理来说是非常重要的&lt;/p&gt;
&lt;p&gt;Hysteria 由服务端和客户端组成，服务端支持 Docker、二进制等方式部署，客户端可以是 ClashX、ShellCrash 等支持 Hysteria 协议的软件，或者 Hysteria 自己的客户端&lt;/p&gt;
&lt;p&gt;基于 Docker 容器搭建服务端，并使用运行在路由器中的 ShellCrash 作为客户端&lt;/p&gt;
&lt;h2 id="服务端"&gt;服务端&lt;/h2&gt;
&lt;p&gt;因为 Hysteria 需要伪装成 HTTP/3 流量，需要一个公网 IP 和域名(如果没有域名也可以在 ZeroSSL 申请 IP 的 TLS 证书)&lt;/p&gt;
&lt;h3 id="获取-ssl-证书"&gt;获取 SSL 证书&lt;/h3&gt;
&lt;p&gt;证书可以使用 Let&amp;rsquo;s Encrypt，ZeroSSL 等免费获取，参考 &lt;a href="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-lets-encrypt-%E7%94%B3%E8%AF%B7-https-%E8%AF%81%E4%B9%A6/"&gt;使用 Let’s Encrypt 申请 HTTPS 证书&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="部署服务端"&gt;部署服务端&lt;/h3&gt;
&lt;h4 id="服务端配置文件"&gt;服务端配置文件&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;config/hysteria.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;服务端配置文件位于 &lt;code&gt;config/&lt;/code&gt; 路径下，关于配置细节可以参考 &lt;a href="https://v2.hysteria.network/zh/docs/advanced/Full-Server-Config/"&gt;完整服务端配置&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;listen&lt;/span&gt;: :&lt;span style="color:#d19a66"&gt;443&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# 伪装为 bing&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;masquerade&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;listenHTTP&lt;/span&gt;: :&lt;span style="color:#d19a66"&gt;80&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;listenHTTPS&lt;/span&gt;: :&lt;span style="color:#d19a66"&gt;9443&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;forceHTTPS&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;type&lt;/span&gt;: &lt;span style="color:#98c379"&gt;proxy&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;proxy&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;url&lt;/span&gt;: &lt;span style="color:#98c379"&gt;https://bing.com&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;rewriteHost&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# 用于流量分析&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;trafficStats&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;listen&lt;/span&gt;: :&lt;span style="color:#d19a66"&gt;9999&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;secret&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;123456&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;disableUDP&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;log&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;level&lt;/span&gt;: &lt;span style="color:#98c379"&gt;debug&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;speedTest&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# 带宽&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;bandwidth&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;up&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;100&lt;/span&gt; &lt;span style="color:#98c379"&gt;mbps&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;down&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;50&lt;/span&gt; &lt;span style="color:#98c379"&gt;mbps&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# DNS&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;resolver&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;type&lt;/span&gt;: &lt;span style="color:#98c379"&gt;tcp&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;tcp&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;addr&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;8.8.8.8&lt;/span&gt;:&lt;span style="color:#d19a66"&gt;53&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;timeout&lt;/span&gt;: &lt;span style="color:#98c379"&gt;4s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;udp&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;addr&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;8.8.4.4&lt;/span&gt;:&lt;span style="color:#d19a66"&gt;53&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;timeout&lt;/span&gt;: &lt;span style="color:#98c379"&gt;4s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;tls&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;addr&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;1.1.1.1&lt;/span&gt;:&lt;span style="color:#d19a66"&gt;853&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;timeout&lt;/span&gt;: &lt;span style="color:#98c379"&gt;10s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;sni&lt;/span&gt;: &lt;span style="color:#98c379"&gt;cloudflare-dns.com&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;insecure&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;https&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;addr&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;1.1.1.1&lt;/span&gt;:&lt;span style="color:#d19a66"&gt;443&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;timeout&lt;/span&gt;: &lt;span style="color:#98c379"&gt;10s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;sni&lt;/span&gt;: &lt;span style="color:#98c379"&gt;cloudflare-dns.com&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;insecure&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;tls&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;cert&lt;/span&gt;: &lt;span style="color:#98c379"&gt;/cert/hy.example.com.crt&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;key&lt;/span&gt;: &lt;span style="color:#98c379"&gt;/cert/hy.example.com.key&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;auth&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;type&lt;/span&gt;: &lt;span style="color:#98c379"&gt;userpass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;userpass&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#e06c75"&gt;admin&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;123456&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8a93a5;font-style:italic"&gt;# 协议嗅探&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;sniff&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;enable&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;timeout&lt;/span&gt;: &lt;span style="color:#98c379"&gt;2s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;rewriteDomain&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;tcpPorts&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;80&lt;/span&gt;,&lt;span style="color:#d19a66"&gt;9443&lt;/span&gt;,&lt;span style="color:#d19a66"&gt;8000-9000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;udpPorts&lt;/span&gt;: &lt;span style="color:#98c379"&gt;all&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="部署"&gt;部署&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;docker-compose.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;申请后的证书放在 &lt;code&gt;cert/&lt;/code&gt;路径下，挂载到容器中&lt;/p&gt;</description></item><item><title>使用 Tailscale Funnel 为 Traefik 提供证书并作为网关入口</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-tailscale-funnel-%E4%B8%BA-traefik-%E6%8F%90%E4%BE%9B%E8%AF%81%E4%B9%A6%E5%B9%B6%E4%BD%9C%E4%B8%BA%E7%BD%91%E5%85%B3%E5%85%A5%E5%8F%A3/</link><pubDate>Mon, 23 Sep 2024 08:34:00 +0800</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8-tailscale-funnel-%E4%B8%BA-traefik-%E6%8F%90%E4%BE%9B%E8%AF%81%E4%B9%A6%E5%B9%B6%E4%BD%9C%E4%B8%BA%E7%BD%91%E5%85%B3%E5%85%A5%E5%8F%A3/</guid><description>&lt;p&gt;&lt;a href="https://tailscale.com/kb/1223/funnel"&gt;Tailscale Funnel&lt;/a&gt; 是 Tailscale 提供的网关工具，和 Cloudflare Tunnel 类似，支持将流量从公网路由到 Tailscale 节点设备的服务上，如 Web 服务、静态文件、SSH 等&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://tailscale.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Ffunnel-diagram.2f3f0e10.png&amp;amp;w=3840&amp;amp;q=75" alt="" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;不过 Tailscale Funnel 当前的功能并不完善，只支持路由到一个目标地址，也不支持自定义路由；如果想路由到其他服务，需要在 Funnel 后面部署一个网关服务；在 Traefik 3.1 的版本中已经支持使用 Tailscale 作为 TLS 证书的提供方，用于将 Tailscale 域名作为 Traefik 的入口&lt;/p&gt;
&lt;h2 id="配置-traefik"&gt;配置 Traefik&lt;/h2&gt;
&lt;p&gt;在 Tailscale 的节点上使用 docker-compose 部署 traefik&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;创建网络&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了方便能通过 Docker 自动发现服务路由，创建一个容器共用的网络，用于 Traefik 路由到对应服务&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;docker network create traefik
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;docker-compose.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;需要在 docker-compose 指定网络，并挂载 &lt;code&gt;/var/run/docker.sock&lt;/code&gt;，用于自动获取路由规则&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;networks&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;traefik&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;external&lt;/span&gt;: &lt;span style="color:#b756ff;font-weight:bold"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;services&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;traefik&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;image&lt;/span&gt;: &lt;span style="color:#98c379"&gt;traefik&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;container_name&lt;/span&gt;: &lt;span style="color:#98c379"&gt;traefik&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;hostname&lt;/span&gt;: &lt;span style="color:#98c379"&gt;traefik&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;restart&lt;/span&gt;: &lt;span style="color:#98c379"&gt;always&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;healthcheck&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;test&lt;/span&gt;: [&lt;span style="color:#63c381"&gt;&amp;#34;CMD&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;wget&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;-q&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;--spider&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;http://localhost:8080/ping&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;interval&lt;/span&gt;: &lt;span style="color:#98c379"&gt;15s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;timeout&lt;/span&gt;: &lt;span style="color:#98c379"&gt;10s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;retries&lt;/span&gt;: &lt;span style="color:#d19a66"&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;start_period&lt;/span&gt;: &lt;span style="color:#98c379"&gt;30s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;command&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;--configFile=/etc/traefik/traefik.yml&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;ports&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;81:80&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;8443:443&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;8080:8080&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;volumes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;/etc/localtime:/etc/localtime:ro&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;/var/run/docker.sock:/var/run/docker.sock:ro&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;./traefik.yml:/etc/traefik/traefik.yml&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;networks&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;traefik&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;environment&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;TZ=Asia/Shanghai&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;traefik.yml&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;配置中定义了一个 certificatesResolvers，名称是 &lt;code&gt;default&lt;/code&gt;，由 tailscale 提供；同时指定了 tls 的 certResolver 名称是 &lt;code&gt;default&lt;/code&gt;，这样就会由 tailscale 提供 TLS 证书；完整的配置如下：&lt;/p&gt;</description></item><item><title>Tailscale 使用 Derp Probe 检测自建的 Derper 服务器状态</title><link>https://blog.hellowood.dev/posts/tailscale-%E4%BD%BF%E7%94%A8-derp-probe-%E6%A3%80%E6%B5%8B%E8%87%AA%E5%BB%BA%E7%9A%84-derper-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81/</link><pubDate>Sun, 22 Sep 2024 21:20:35 +0800</pubDate><guid>https://blog.hellowood.dev/posts/tailscale-%E4%BD%BF%E7%94%A8-derp-probe-%E6%A3%80%E6%B5%8B%E8%87%AA%E5%BB%BA%E7%9A%84-derper-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81/</guid><description>&lt;p&gt;在使用服务器部署自建的 HomeLab Derp 服务器之后，偶尔会出现 Derp 服务器无法访问，因此想要监控 Derp 服务器的状态，进行延迟检测等；Tailscale 官方提供了 &lt;a href="https://github.com/tailscale/tailscale/blob/main/cmd/derpprobe/derpprobe.go"&gt;derpprobe&lt;/a&gt; 这个工具，可以对 Derp 服务器的 UDP/UDP6/TLS/MESH 等协议以及带宽进行检测&lt;/p&gt;
&lt;p&gt;自行部署 Derp Server 参考 &lt;a href="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%AE%B6%E5%BA%AD%E5%AE%BD%E5%B8%A6%E5%85%AC%E7%BD%91-ipv6-%E8%87%AA%E5%BB%BA-tailscale-%E7%9A%84-derp-%E8%8A%82%E7%82%B9/"&gt;使用家庭宽带公网 IPV6 自建 Tailscale 的 DERP 节点&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="构建-docker-镜像"&gt;构建 Docker 镜像&lt;/h2&gt;
&lt;p&gt;derpprobe 没有提供 docker 镜像，可以直接使用我构建的镜像 &lt;code&gt;ghcr.io/helloworlde/tailscale-derpprober:main&lt;/code&gt;，跳过这一步；或者自行构建&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;下载项目&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;git clone https://github.com/tailscale/tailscale.git
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;创建 Dockerfile&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;进入项目下，并在根目录创建 Dockerfile.derpprobe 文件，内容如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-Dockerfile" data-lang="Dockerfile"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;FROM&lt;/span&gt; &lt;span style="color:#98c379"&gt;golang:1.23-alpine&lt;/span&gt; &lt;span style="color:#c678dd"&gt;AS&lt;/span&gt; &lt;span style="color:#98c379"&gt;build-env&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;WORKDIR&lt;/span&gt; &lt;span style="color:#98c379"&gt;/go/src/tailscale&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;COPY&lt;/span&gt; tailscale/go.mod tailscale/go.sum ./
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;RUN&lt;/span&gt; go mod download
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;COPY&lt;/span&gt; tailscale .
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ARG&lt;/span&gt; TARGETARCH
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;RUN&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;GOARCH&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;$TARGETARCH&lt;/span&gt; go build -o derpprobe cmd/derpprobe/derpprobe.go
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;FROM&lt;/span&gt; &lt;span style="color:#98c379"&gt;alpine:3.18&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;RUN&lt;/span&gt; apk add --no-cache ca-certificates
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;DERP_MAP&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;https://login.tailscale.com/derpmap/default
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;LISTEN&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;:8030
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;ONCE&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#ef8383"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;SPREAD&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#ef8383"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;INTERVAL&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;15s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;MESH_INTERVAL&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;15s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;STUN_INTERVAL&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;15s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;TLS_INTERVAL&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;15s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;BW_INTERVAL&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;&lt;span style="color:#d19a66"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENV&lt;/span&gt; &lt;span style="color:#dcaeea"&gt;BW_PROBE_SIZE_BYTES&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;1_000_000
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;COPY&lt;/span&gt; --from&lt;span style="color:#c7bf54"&gt;=&lt;/span&gt;build-env /go/src/tailscale/derpprobe /usr/local/bin/derpprobe
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c678dd"&gt;ENTRYPOINT&lt;/span&gt; &lt;span style="color:#c7bf54"&gt;[&lt;/span&gt;&lt;span style="color:#63c381"&gt;&amp;#34;sh&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;-c&amp;#34;&lt;/span&gt;, &lt;span style="color:#63c381"&gt;&amp;#34;/usr/local/bin/derpprobe \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -derp-map=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;DERP_MAP&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -listen=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;LISTEN&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -once=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;ONCE&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -spread=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;SPREAD&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -interval=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;INTERVAL&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -mesh-interval=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;MESH_INTERVAL&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -stun-interval=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;STUN_INTERVAL&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -tls-interval=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;TLS_INTERVAL&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -bw-interval=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;BW_INTERVAL&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt; \
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#63c381"&gt; -bw-probe-size-bytes=&lt;/span&gt;&lt;span style="color:#98c379"&gt;${&lt;/span&gt;&lt;span style="color:#dcaeea"&gt;BW_PROBE_SIZE_BYTES&lt;/span&gt;&lt;span style="color:#98c379"&gt;}&lt;/span&gt;&lt;span style="color:#63c381"&gt;&amp;#34;&lt;/span&gt;&lt;span style="color:#c7bf54"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;构建镜像&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;docker build -t derpprobe -f Dockerfile.derpprobe .
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="部署"&gt;部署&lt;/h2&gt;
&lt;p&gt;通过 docker compose 部署&lt;/p&gt;</description></item><item><title>使用家庭宽带公网 IPV6 自建 Tailscale 的 DERP 节点</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%AE%B6%E5%BA%AD%E5%AE%BD%E5%B8%A6%E5%85%AC%E7%BD%91-ipv6-%E8%87%AA%E5%BB%BA-tailscale-%E7%9A%84-derp-%E8%8A%82%E7%82%B9/</link><pubDate>Tue, 11 Jun 2024 21:33:44 +0800</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%AE%B6%E5%BA%AD%E5%AE%BD%E5%B8%A6%E5%85%AC%E7%BD%91-ipv6-%E8%87%AA%E5%BB%BA-tailscale-%E7%9A%84-derp-%E8%8A%82%E7%82%B9/</guid><description>&lt;p&gt;日常使用 Tailscale 连接异地的设备，但是因为经常出现无法直接连接，需要通过香港或东京的 DERP 服务器进行转发，导致延迟很高，影响网络质量；因此计划使用自建的 DERP 解决无法直连的问题；如果部署在国内的服务器上绑定域名需要备案，但是活动购买的服务器限制性能限制带宽限制流量还要单独购买公网 IP，并不合适；国外的延迟高可能还不如 Tailscale 官方的 DERP；&lt;/p&gt;
&lt;p&gt;另外自建的 DERP 服务器要求节点能够直接通过公网访问，不能在 NAT 或者负载均衡后面，因此基于家庭宽带的公网 IPV6 自建 DERP 服务器最合适&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;从 tailscale 1.82.0 版本开始支持直接使用自签名的 IP 证书部署，可以通过 ZeroSSL 申请证书，免域名部署在国内的服务器上，具体参考 &lt;a href="https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%85%AC%E7%BD%91-ip-%E5%85%8D%E5%9F%9F%E5%90%8D%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BA%E7%9A%84-tailscale-derp-server/"&gt;使用公网 IP 免域名部署自建的 Tailscale DERP Server&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;h2 id="现状"&gt;现状&lt;/h2&gt;
&lt;p&gt;检测 tailscale 的网络节点，延迟最低的是东京的节点，延迟在 70 ms 左右&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;tailscale netcheck
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Report:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* UDP: &lt;span style="color:#ef8383"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* IPv4: yes, xxx.xxx.xxx.xxx:39325
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* IPv6: yes, &lt;span style="color:#c7bf54"&gt;[&lt;/span&gt;2409:xxxx:xxxx:xxxx::xxxx&lt;span style="color:#c7bf54"&gt;]&lt;/span&gt;:34341
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* MappingVariesByDestIP: &lt;span style="color:#ef8383"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* HairPinning: &lt;span style="color:#ef8383"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* PortMapping:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* CaptivePortal: &lt;span style="color:#ef8383"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* Nearest DERP: Tokyo
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;	* DERP latency:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		- tok: 71.6ms &lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;Tokyo&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		- hkg: 93.1ms &lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;Hong Kong&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;		- sin: 100.5ms &lt;span style="color:#c7bf54"&gt;(&lt;/span&gt;Singapore&lt;span style="color:#c7bf54"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="自建-derp-节点"&gt;自建 DERP 节点&lt;/h2&gt;
&lt;h3 id="1-要求"&gt;1. 要求&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;可访问的公网 IPV4 或 IPV6 地址&lt;/li&gt;
&lt;li&gt;域名，DERP 不修改源码必须要使用域名访问&lt;/li&gt;
&lt;li&gt;开放 DERP和 STUN端口&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;tailscale 的 &lt;a href="https://tailscale.com/kb/1118/custom-derp-servers#prerequisites"&gt;Prerequisites&lt;/a&gt;文档中要求开放HTTP/HTTPS/STUN 三个端口，默认是 80/443/3478 端口，实际上有 HTTPS/STUN 就够了&lt;/p&gt;</description></item><item><title>使用阿尔卡特猫棒替换北京移动 GPON 光猫</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E9%98%BF%E5%B0%94%E5%8D%A1%E7%89%B9%E7%8C%AB%E6%A3%92%E6%9B%BF%E6%8D%A2%E5%8C%97%E4%BA%AC%E7%A7%BB%E5%8A%A8-gpon-%E5%85%89%E7%8C%AB/</link><pubDate>Mon, 27 Nov 2023 18:08:46 +0800</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E9%98%BF%E5%B0%94%E5%8D%A1%E7%89%B9%E7%8C%AB%E6%A3%92%E6%9B%BF%E6%8D%A2%E5%8C%97%E4%BA%AC%E7%A7%BB%E5%8A%A8-gpon-%E5%85%89%E7%8C%AB/</guid><description>&lt;p&gt;最近移动送了条免费宽带，刚好联通宽带到期了，可以无缝衔接上；之前使用的是 ODI 猫棒+兮克的 SKS3200M-8GPY1XF 交换机，因此想继续使用 ODI 猫棒，但是一番尝试后始终无法成功拨号，于是改成了使用阿尔卡特猫棒&lt;/p&gt;
&lt;p&gt;阿尔卡特猫棒型号为 G-010S-P，版本为 6BA1896SPE2C05&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/homelab-network-gpon-pon-stick-setup-status.png" alt="homelab-network-gpon-pon-stick-setup-status.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;h2 id="宽带配置"&gt;宽带配置&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;改为桥接模式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;首先要将宽带改为桥接模式，在安装时直接让运维小哥改了；如果没有修改可以联系宽带帮忙修改&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;获取光猫的超级管理员密码&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;北京移动的超级管理员用户名是 &lt;code&gt;CMCCAdmin&lt;/code&gt;，密码是 &lt;code&gt;aDm8H%MdA&lt;/code&gt;；但是我尝试登陆时提示失败，然后联系运维小哥，使用光猫的 SN 和宽带账号授权之后可以正常登录了&lt;/p&gt;
&lt;p&gt;光猫信息如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;产品名称：吉比特无源光纤接入用户端设备（GPON ONU）&lt;/li&gt;
&lt;li&gt;产品类型：中国移动智能家庭网关 类型11&lt;/li&gt;
&lt;li&gt;产品型号：SK-D747&lt;/li&gt;
&lt;li&gt;电源：12V&amp;mdash;1.5A&lt;/li&gt;
&lt;li&gt;CMIIT ID: 2022XXXXXX&lt;/li&gt;
&lt;li&gt;设备标识：XXXXXX-光猫 SN&lt;/li&gt;
&lt;li&gt;MAC: XXXXXXXXXXX&lt;/li&gt;
&lt;li&gt;SN: 光猫 SN&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="获取认证信息"&gt;获取认证信息&lt;/h2&gt;
&lt;p&gt;北京移动的认证使用的是光猫的 SN + PLOAM 密码&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SN&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;光猫 SN 在光猫背面即可看到，也可以登录后在设备信息中查看&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PLOAM 密码&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;PLOAM 密码的路径为网络-远程管理-认证，&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/homelab-network-gpon-model-info-ploam-password.png" alt="homelab-network-gpon-model-info-ploam-password.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;VLAN ID&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;北京移动的 VLAN ID 为 10&lt;/p&gt;
&lt;h2 id="配置猫棒"&gt;配置猫棒&lt;/h2&gt;
&lt;h3 id="配置"&gt;配置&lt;/h3&gt;
&lt;p&gt;猫棒启动后，进入管理后台，这款猫棒默认的地址是 &lt;a href="http://192.168.1.10"&gt;http://192.168.1.10&lt;/a&gt;，默认用户名 &lt;code&gt;root&lt;/code&gt;，密码 &lt;code&gt;password&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;登录后，选择 GPON-互操作兼容配置，配置上面获取到的认证信息&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GPON SN: 光猫的 SN&lt;/li&gt;
&lt;li&gt;Ploam password: 光猫获取到的认证密码&lt;/li&gt;
&lt;li&gt;默认PVID: VLAN ID &lt;code&gt;10&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;配置后，点击应用配置&lt;/p&gt;</description></item><item><title>使用兮克 2.5G 交换机将北京联通 EPON 改为 ODI 猫棒接入</title><link>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%85%AE%E5%85%8B-2.5g-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B0%86%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A-epon-%E6%94%B9%E4%B8%BA-odi-%E7%8C%AB%E6%A3%92%E6%8E%A5%E5%85%A5/</link><pubDate>Mon, 19 Jun 2023 08:54:44 +0800</pubDate><guid>https://blog.hellowood.dev/posts/%E4%BD%BF%E7%94%A8%E5%85%AE%E5%85%8B-2.5g-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%B0%86%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A-epon-%E6%94%B9%E4%B8%BA-odi-%E7%8C%AB%E6%A3%92%E6%8E%A5%E5%85%A5/</guid><description>&lt;p&gt;最近入手了兮克2.5G交换机（兮克SKS1200-8GPY1XF），有 8 个 2.5G 电口和 1 个 10G SFP+ 光口；支持多种组网模式，其中一种是支持使用猫棒接入，由路由器拨号后再回接到交换机，这样就可以替换掉光猫了
(注意：兮克 SKS1200-8GPY1XF 不支持 VLAN 隔离，将网线接到路由器再回接会形成环路，导致网络频繁抖动；建议使用最新的支持 VLAN 隔离的版本)&lt;/p&gt;
&lt;p&gt;

 &lt;img src="https://img.hellowood.dev/picture/homelab-switch-sfp-network.png" alt="homelab-switch-sfp-network.png" loading="lazy"&gt;
&lt;/p&gt;
&lt;p&gt;替换光猫有以下原因：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;千兆及以上宽带突破不到千兆限制：运营商的千兆光猫一般只能跑到 950M左右，而 EPON 支持 1.25G 下行，GPON 支持 2.5G 下行&lt;/li&gt;
&lt;li&gt;减少光猫空间占用：光猫体积较大，替换成猫棒可以减少空间占用，对于将网络设备放在弱电箱的用户比较合适&lt;/li&gt;
&lt;li&gt;瞎折腾：纯粹为了体验和折腾&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="名词解释"&gt;名词解释&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;猫棒&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;猫棒(Pon Stick) 就是 SFP 封装的猫，分为 GPON、EPON 等，接口是 SFP，可插到有 SFP 口的交换机、路由器或者网卡上来代替光猫，具有光猫完整的功能；优点是体积小，网速比普通光猫高；缺点是性能羸弱，发热量大，不够稳定&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;光模块&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;光模块工作在OSI模型的物理层，是光纤通信系统中的核心器件之一。它主要由光电子器件（光发射器、光接收器）、功能电路和光接口等部分组成，主要作用就是实现光纤通信中的光电转换和电光转换功能；光模块是一个光电转换器，而猫棒是有 CPU、内存、系统的光猫，两者都使用 SFP 接口&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SFP/SFP+&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;SFP（Small Form-Factor Pluggable）和SFP+（Enhanced Small Form-Factor Pluggable）是两种不同的光模块类型，主要区别是它们支持的传输速率不同；SFP 模块支持最高传输速率为1.25 Gbps，而 SFP+ 模块支持最高传输速率为10 Gbps。此外，SFP+ 可以向下兼容 SFP 插槽，因此可以将 SFP+ 插入 SFP 插槽中，但反之则不行&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;UPC/APC/SC：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;UPC（Ultra Physical Contact）、APC（Angled Physical Contact）和SC（Subscriber Connector）都是光纤接口的类型；通常 APC 是绿色的接头，用于机房等场景；SC 是蓝色的接头，一般家用光纤都是 SC 接口&lt;/p&gt;</description></item><item><title>微服务网关 Traefik - Docker Swarm 使用</title><link>https://blog.hellowood.dev/posts/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3-traefik-docker-swarm-%E4%BD%BF%E7%94%A8/</link><pubDate>Sun, 24 Mar 2019 21:20:35 +0800</pubDate><guid>https://blog.hellowood.dev/posts/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3-traefik-docker-swarm-%E4%BD%BF%E7%94%A8/</guid><description>&lt;p&gt;&lt;a href="https://docs.traefik.io/"&gt;traefik&lt;/a&gt; 是一个用 Go 开发的适用于微服务的反向代理和负载均衡的网关；可以自动发现并代理服务，可以用 Kubernetes 或 Docker Swarm 等方式，支持使用 Eureka，Consul，Etcd，ZooKeeper 等注册中心&lt;/p&gt;
&lt;h2 id="docker-swarm-使用"&gt;Docker Swarm 使用&lt;/h2&gt;
&lt;h3 id="启动官方-demo"&gt;启动官方 Demo&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;docker-compose.yml&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;version&lt;/span&gt;: &lt;span style="color:#63c381"&gt;&amp;#34;3&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e06c75"&gt;services&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;reverse-proxy&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;image&lt;/span&gt;: &lt;span style="color:#98c379"&gt;traefik&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# The official Traefik docker image&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;command&lt;/span&gt;: --&lt;span style="color:#98c379"&gt;api --docker&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# Enables the web UI and tells Traefik to listen to docker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;ports&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;80:80&amp;#34;&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# The HTTP port&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;8080:8080&amp;#34;&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# The Web UI (enabled by --api)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;volumes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#98c379"&gt;/var/run/docker.sock:/var/run/docker.sock&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# So that Traefik can listen to the Docker events&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;whoami&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;image&lt;/span&gt;: &lt;span style="color:#98c379"&gt;containous/whoami&lt;/span&gt; &lt;span style="color:#8a93a5;font-style:italic"&gt;# A container that exposes an API to show its IP address&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e06c75"&gt;labels&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#63c381"&gt;&amp;#34;traefik.frontend.rule=Host:whoami.docker.localhost&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;启动&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;docker-compose up -d
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这样会启动一个 treafik 的 WebUI 和一个后端服务器&lt;/p&gt;</description></item></channel></rss>