<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>MySQL on HelloWood</title><link>https://blog.hellowood.dev/categories/mysql/</link><description>Recent content in MySQL on HelloWood</description><generator>Hugo</generator><language>cn</language><lastBuildDate>Tue, 17 Sep 2024 03:10:36 +0000</lastBuildDate><atom:link href="https://blog.hellowood.dev/categories/mysql/index.xml" rel="self" type="application/rss+xml"/><item><title>MySQL 中关于gap lock / next-key lock 的一个问题</title><link>https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</link><pubDate>Mon, 07 Jan 2019 21:40:58 +0000</pubDate><guid>https://blog.hellowood.dev/posts/mysql-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</guid><description>&lt;blockquote>
&lt;p>在学习 MySQL 的过程中遇到的一个关于锁的问题，包含多个 MySQL 相关的知识；相关资料在文章末尾&lt;/p>
&lt;/blockquote>
&lt;h3 id="问题描述">问题描述&lt;/h3>
&lt;ul>
&lt;li>表初始化&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">CREATE&lt;/span> &lt;span style="color:#c678dd">TABLE&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c1abea">id&lt;/span> &lt;span style="color:#ef8383">INT&lt;/span> &lt;span style="color:#c678dd">PRIMARY&lt;/span> &lt;span style="color:#c678dd">KEY&lt;/span> &lt;span style="color:#c1abea">AUTO_INCREMENT&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c1abea">b&lt;/span> &lt;span style="color:#ef8383">INT&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">KEY&lt;/span> &lt;span style="color:#c1abea">b&lt;/span>(&lt;span style="color:#c1abea">b&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c1abea">ENGINE&lt;/span> &lt;span style="color:#c7bf54">=&lt;/span> &lt;span style="color:#c1abea">InnoDB&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">DEFAULT&lt;/span> &lt;span style="color:#c1abea">CHARSET&lt;/span> &lt;span style="color:#c7bf54">=&lt;/span> &lt;span style="color:#c1abea">utf8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> (&lt;span style="color:#c1abea">id&lt;/span>, &lt;span style="color:#c1abea">b&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">1&lt;/span>, &lt;span style="color:#d19a66">2&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#d19a66">3&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#d19a66">5&lt;/span>, &lt;span style="color:#d19a66">6&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#d19a66">7&lt;/span>, &lt;span style="color:#d19a66">8&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (&lt;span style="color:#d19a66">9&lt;/span>, &lt;span style="color:#d19a66">10&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>session A&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">BEGIN&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">SELECT&lt;/span> &lt;span style="color:#c7bf54">*&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">FROM&lt;/span> &lt;span style="color:#c1abea">z&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">WHERE&lt;/span> &lt;span style="color:#c1abea">b&lt;/span> &lt;span style="color:#c7bf54">=&lt;/span> &lt;span style="color:#d19a66">6&lt;/span> &lt;span style="color:#c678dd">FOR&lt;/span> &lt;span style="color:#c678dd">UPDATE&lt;/span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>session B&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">2&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*success*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">2&lt;/span>, &lt;span style="color:#d19a66">8&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*blocked*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">4&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*blocked*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">4&lt;/span>, &lt;span style="color:#d19a66">8&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*blocked*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">8&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*blocked*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">8&lt;/span>, &lt;span style="color:#d19a66">8&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*success*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#d19a66">0&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*blocked*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">INSERT&lt;/span> &lt;span style="color:#c678dd">INTO&lt;/span> &lt;span style="color:#c1abea">z&lt;/span> &lt;span style="color:#c678dd">VALUES&lt;/span> (&lt;span style="color:#c7bf54">-&lt;/span>&lt;span style="color:#d19a66">1&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>);&lt;span style="color:#8a93a5;font-style:italic">/*success*/&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>分别执行 session B中的insert 会出现上述情况，为什么？&lt;/p>
&lt;h3 id="加锁过程">加锁过程&lt;/h3>
&lt;ol>
&lt;li>在索引 b 上的等值查询，给索引 b 加上了 next-key lock (4, 6]；索引向右遍历，且最后一个值不满足条件时退化为间隙锁；所以会再加上间隙锁 (6,8)；所以索引 b 上的 next-key lock 的范围是(b=4,id=3)到(b=6,id=5)这个左开右闭区间和(b=6,id=5)到(b=8,id=7)这个开区间&lt;/li>
&lt;li>for update 会给 b = 6 这一行加上行锁；因此 (b=6,id=5) 这一行上有行锁&lt;/li>
&lt;/ol>
&lt;hr>
&lt;ul>
&lt;li>这么看来上述语句都不在锁的范围内，为什么会被锁&lt;/li>
&lt;/ul>
&lt;p>这个问题其实是因为没有理解索引的结构，所以认为所有值都不应该被锁&lt;/p></description></item><item><title>SpringBoot 使用 MySQL保存emoji 表情</title><link>https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-mysql%E4%BF%9D%E5%AD%98emoji-%E8%A1%A8%E6%83%85/</link><pubDate>Mon, 31 Dec 2018 22:59:16 +0000</pubDate><guid>https://blog.hellowood.dev/posts/springboot-%E4%BD%BF%E7%94%A8-mysql%E4%BF%9D%E5%AD%98emoji-%E8%A1%A8%E6%83%85/</guid><description>&lt;blockquote>
&lt;p>在使用 SpringBoot 开发的应用中，有表单提交的内容中含有 emoji 表情，导致保存失败；这是因为MySQL 默认的 utf8 长度为3位，emoji 表情有4位&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>更改表的字符集为&lt;code>utf8mb4&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">ALTER&lt;/span> &lt;span style="color:#c678dd">TABLE&lt;/span> &lt;span style="color:#c1abea">content&lt;/span> &lt;span style="color:#c678dd">DEFAULT&lt;/span> &lt;span style="color:#ef8383">CHARACTER&lt;/span> &lt;span style="color:#c678dd">SET&lt;/span> &lt;span style="color:#c1abea">utf8mb4&lt;/span> &lt;span style="color:#c678dd">COLLATE&lt;/span> &lt;span style="color:#c1abea">utf8_general_ci&lt;/span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>但是这样更改后仍然没有解决保存失败的问题&lt;/p>
&lt;ul>
&lt;li>更改数据库的字符集&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">ALTER&lt;/span> &lt;span style="color:#c678dd">DATABASE&lt;/span> &lt;span style="color:#c1abea">db_name&lt;/span> &lt;span style="color:#c678dd">DEFAULT&lt;/span> &lt;span style="color:#ef8383">CHARACTER&lt;/span> &lt;span style="color:#c678dd">SET&lt;/span> &lt;span style="color:#c1abea">utf8mb4&lt;/span> &lt;span style="color:#c678dd">COLLATE&lt;/span> &lt;span style="color:#c1abea">utf8_general_ci&lt;/span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>由于暂时不能重启数据库，这种修改方式只在当前连接中生效，同样未能解决问题&lt;/p>
&lt;ul>
&lt;li>修改 SpringBoot 的配置&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code class="language-dsconfig" data-lang="dsconfig">spring.datasource.hikari.connection-init-sql=SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci
&lt;/code>&lt;/pre>&lt;p>这样，在应用的所有连接内都使用utf8mb4 作为字符集，解决了 emoji 保存失败的问题&lt;/p></description></item></channel></rss>